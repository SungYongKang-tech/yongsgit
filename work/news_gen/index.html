<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>발전5개사 뉴스 모아보기</title>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --line:#e5e7eb;
      --ink:#0f172a;
      --muted:#64748b;
      --accent:#2563eb;
      --new:#f59e0b;
      --shadow:0 10px 30px rgba(0,0,0,.07);
      --chip:#f1f5f9;
      --groupbg:#ecfdf3;
      --groupline:#bbf7d0;
    }

    html, body { overflow-x: hidden; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background:var(--bg);
      color:var(--ink);
    }

    header{
      position:sticky;
      top:0;
      background:#fff;
      border-bottom:1px solid var(--line);
      padding:12px 14px;
      z-index:10;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    h1{ font-size:16px; margin:0; }

    .topbar{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
    }

    .btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:10px;
      padding:7px 10px;
      font-weight:700;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
      color:var(--muted);
    }
    .pill.new{
      border-color:var(--new);
      color:#b45309;
      background:#fff7ed;
    }

    /* ✅ 탭(버튼) 영역 */
    .tabs{
      margin-top:10px;
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .tab{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:7px 10px;
      font-weight:800;
      cursor:pointer;
      font-size:13px;
    }
    .tab.active{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }

    /* ✅ 검색 입력 */
    .searchbar{
      margin-top:10px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .searchbar input{
      flex:1;
      min-width:220px;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }

    main{
      max-width:980px;
      margin:0 auto;
      padding:12px;
    }
    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }

    .card{
      background:var(--groupbg);
      border:1px solid var(--groupline);
      border-radius:18px;
      padding:14px;
    }
    .card.new{
      border-color:var(--new);
      box-shadow:var(--shadow);
      background:#fff7ed;
    }

    .title{
      font-size:16px;
      font-weight:900;
      margin:0 0 8px 0;
      line-height:1.35;
    }
    .meta{
      font-size:12px;
      color:var(--muted);
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:6px;
    }

    .links{
      margin-top:10px;
      display:grid;
      gap:8px;
      background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
    }

    .linkrow{
      display:grid;
      grid-template-columns: 72px 1fr;
      gap:6px 10px;
      align-items:start;
      padding:10px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
    }
    .src{
      font-weight:900;
      color:#334155;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .ttl{ min-width:0; }
    .ttl a{
      display:block;
      word-break:break-word;
      overflow-wrap:anywhere;
      text-decoration:none;
      color:var(--accent);
    }
    .ttl a:hover{ text-decoration:underline; }
    .when{
      grid-column:2 / 3;
      font-size:11px;
      color:var(--muted);
    }

    .small{ font-size:12px; color:var(--muted); }

    @media (max-width: 520px){
      header{padding:10px}
      main{padding:10px}
      .card{padding:12px}
      .title{font-size:15px}
      .linkrow{ grid-template-columns:1fr; gap:6px; }
      .src{white-space:normal}
      .when{grid-column:auto}
      .searchbar input{ min-width: 0; width: 100%; }
    }
  </style>
</head>

<body>
<header>
  <div class="row">
    <h1>발전5개사 뉴스 (Made by SY)</h1>
    <div class="topbar">
      <span id="badge" class="pill new" style="display:none;"></span>
      <span id="counts" class="pill">-</span>
      <span id="updated" class="pill">업데이트: -</span>
      <button class="btn" id="reset">읽음 초기화</button>
      <button class="btn primary" id="refresh">새로고침</button>
    </div>
  </div>

  <!-- ✅ 탭 버튼 6개 -->
  <div class="tabs" id="tabs"></div>

  <!-- ✅ 입력 검색: 버튼과 무관하게 입력어만 검색 -->
  <div class="searchbar">
    <input id="qInput" type="text" placeholder="직접 검색어 입력 (엔터로 검색)  예) 태양광, 석탄, 적자, LNG" />
    <button class="btn primary" id="qSearchBtn">검색</button>
  </div>

  <div class="small" style="margin-top:8px;">
    버튼은 지정 키워드로 즉시 검색합니다. 입력 검색은 버튼과 무관하게 입력어만 검색합니다.
  </div>
</header>

<main>
  <div id="status" class="small">불러오는 중…</div>
  <div id="list" class="grid" style="margin-top:10px;"></div>
</main>

<script>
/** ✅ 탭 정의 (요구사항 반영) */
const PRESETS = [
  { key: "five", label: "발전5개사", q: "발전5개사 OR 남동발전 OR 남부발전 OR 중부발전 OR 서부발전 OR 동서발전" },
  { key: "koen", label: "남동발전", q: "남동발전" },
  { key: "kospo", label: "남부발전", q: "남부발전" },
  { key: "komipo", label: "중부발전", q: "중부발전" },
  { key: "kowepo", label: "서부발전", q: "서부발전" },
  { key: "e-w", label: "동서발전", q: "동서발전" },
];

const $status = document.getElementById("status");
const $list = document.getElementById("list");
const $badge = document.getElementById("badge");
const $updated = document.getElementById("updated");
const $counts = document.getElementById("counts");
const $tabs = document.getElementById("tabs");
const $qInput = document.getElementById("qInput");

/** ✅ 검색어별로 읽음(새 이슈) 분리 저장 */
const SEEN_PREFIX = "news_seen_groups_v2_";
const keyForQuery = (q) => SEEN_PREFIX + hashStr((q || "").trim().toLowerCase());

function hashStr(str){
  // 간단 해시(저장키용)
  let h = 2166136261;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return (h >>> 0).toString(16);
}

const loadSeen = (q) => new Set(JSON.parse(localStorage.getItem(keyForQuery(q)) || "[]"));
const saveSeen = (q, s) => localStorage.setItem(keyForQuery(q), JSON.stringify([...s]));

/** 날짜 표시 */
const fmt = (dateStr) => {
  try {
    const d = new Date(dateStr);
    if (isNaN(d)) return dateStr;
    const y = d.getFullYear();
    const m = d.getMonth() + 1;
    const day = d.getDate();
    const h = d.getHours();
    const week = ["일", "월", "화", "수", "목", "금", "토"][d.getDay()];
    return `${y}년 ${m}월 ${day}일(${week}) ${h}시`;
  } catch {
    return dateStr;
  }
};

/** ✅ 현재 선택 탭 */
let activePreset = PRESETS[0];

/** ✅ 탭 렌더 */
function renderTabs(){
  $tabs.innerHTML = "";
  PRESETS.forEach(p => {
    const b = document.createElement("button");
    b.className = "tab" + (p.key === activePreset.key ? " active" : "");
    b.textContent = p.label;
    b.onclick = () => {
      activePreset = p;
      renderTabs();
      fetchNews(p.q);
    };
    $tabs.appendChild(b);
  });
}

/** ✅ 뉴스 불러오기 (검색어 q 기준) */
async function fetchNews(q){
  const query = (q || "").trim();
  if(!query){
    $status.textContent = "검색어가 비어 있습니다.";
    return;
  }

  $status.textContent = "불러오는 중…";
  $list.innerHTML = "";
  $badge.style.display = "none";

  const seen = loadSeen(query);

  const url = "/.netlify/functions/news?q=" + encodeURIComponent(query);
  const res = await fetch(url, { cache: "no-store" });
  const data = await res.json();

  if(!data.groups){
    $status.textContent = "불러오기 실패";
    return;
  }

  $updated.textContent = "업데이트: " + fmt(data.fetchedAt);
  $counts.textContent = `원문 ${data.rawCount}건 · 묶음 ${data.groupCount}건`;

  let newCount = 0;

  data.groups.forEach(g=>{
    const isNew = !seen.has(g.id);
    if(isNew) newCount++;

    const card = document.createElement("div");
    card.className = "card" + (isNew ? " new":"");

    const links = g.articles.map(a=>`
      <div class="linkrow">
        <div class="src">${a.source || "링크"}</div>
        <div class="ttl"><a href="${a.link}" target="_blank" rel="noopener noreferrer">${a.title}</a></div>
        <div class="when">${fmt(a.pubDate)}</div>
      </div>
    `).join("");

    card.innerHTML = `
      <div class="title">${g.title}</div>
      <div class="meta">
        ${isNew ? '<span class="pill new">새 이슈</span>' : ''}
        <span class="pill">${g.articles.length}개 기사</span>
        <span class="pill">검색: ${escapeHtml(query)}</span>
      </div>
      <div class="links">${links}</div>
    `;

    $list.appendChild(card);
  });

  if(newCount>0){
    $badge.style.display="inline-flex";
    $badge.textContent = `새 이슈 ${newCount}건`;
  }

  data.groups.forEach(g=>seen.add(g.id));
  saveSeen(query, seen);

  $status.textContent = `묶음 ${data.groupCount}건 표시 (검색: ${query})`;
}

function escapeHtml(s){
  return (s||"")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

/** ✅ 입력 검색(단독) */
function runInputSearch(){
  const q = ($qInput.value || "").trim();
  if(!q){
    alert("검색어를 입력하세요.");
    return;
  }
  fetchNews(q);
}

/** 버튼들 */
document.getElementById("refresh").onclick = () => fetchNews(activePreset.q);

document.getElementById("reset").onclick = () => {
  // 현재 검색어의 읽음만 초기화 (원하시면 전체 초기화도 가능)
  const q = ($qInput.value || "").trim() || activePreset.q;
  localStorage.removeItem(keyForQuery(q));
  alert("현재 검색 기준의 읽음이 초기화되었습니다.");
};

document.getElementById("qSearchBtn").onclick = runInputSearch;
$qInput.addEventListener("keydown", (e)=>{
  if(e.key === "Enter") runInputSearch();
});

/** 초기 실행 */
renderTabs();
fetchNews(activePreset.q);
</script>
</body>
</html>
