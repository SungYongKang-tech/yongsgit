<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>한국남동발전 뉴스 모아보기</title>
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --line:#e5e7eb; --ink:#0f172a; --muted:#64748b;
      --accent:#2563eb; --new:#f59e0b; --shadow:0 10px 30px rgba(0,0,0,.07);
    }
    body{margin:0;font-family:system-ui,-apple-system,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;background:var(--bg);color:var(--ink);}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:12px 14px;z-index:10}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{font-size:16px;margin:0}
    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px;color:var(--muted)}
    .pill.new{border-color:var(--new);color:#b45309;background:#fff7ed}
    main{max-width:980px;margin:0 auto;padding:14px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px 14px;box-shadow:0 2px 0 rgba(0,0,0,.02)}
    .card.new{border-color:var(--new);box-shadow:var(--shadow)}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .title{font-size:15px;line-height:1.35;margin:0 0 6px 0;font-weight:800}
    .meta{font-size:12px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap}
    .small{font-size:12px;color:var(--muted)}
    .topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
<header>
  <div class="row">
    <h1>한국남동발전 뉴스 모아보기</h1>
    <div class="topbar">
      <span id="badge" class="pill new" style="display:none;"></span>
      <span id="updated" class="pill">업데이트: -</span>
      <button class="btn" id="reset">새 글 표시 초기화</button>
      <button class="btn primary" id="refresh">새로고침</button>
    </div>
  </div>
  <div class="small" style="margin-top:6px;">
    ※ 이 페이지를 열면 최신 뉴스 목록을 불러와 보여주며, 이전에 없던 링크는 “새 글”로 표시됩니다.
  </div>
</header>

<main>
  <div id="status" class="small">불러오는 중…</div>
  <div id="list" class="grid" style="margin-top:10px;"></div>
</main>

<script>
  const SEEN_KEY = "koen_news_seen_links_v1";

  const $status = document.getElementById("status");
  const $list = document.getElementById("list");
  const $badge = document.getElementById("badge");
  const $updated = document.getElementById("updated");

  const loadSeen = () => {
    try { return new Set(JSON.parse(localStorage.getItem(SEEN_KEY) || "[]")); }
    catch { return new Set(); }
  };
  const saveSeen = (set) => localStorage.setItem(SEEN_KEY, JSON.stringify([...set]));

  const fmt = (iso) => {
    try {
      const d = new Date(iso);
      return d.toLocaleString("ko-KR", { hour12:false });
    } catch { return iso; }
  };

  async function fetchNews() {
    $status.textContent = "불러오는 중…";
    $list.innerHTML = "";
    $badge.style.display = "none";

    const seen = loadSeen();

    const res = await fetch("/.netlify/functions/news", { cache: "no-store" });
    const data = await res.json();

    if (!data.items) {
      $status.textContent = "불러오기 실패 (Functions가 동작하는 배포인지 확인 필요)";
      return;
    }

    $updated.textContent = "업데이트: " + fmt(data.fetchedAt);

    let newCount = 0;

    data.items.forEach((it) => {
      const isNew = !seen.has(it.link);
      if (isNew) newCount++;

      const card = document.createElement("div");
      card.className = "card" + (isNew ? " new" : "");
      card.innerHTML = `
        <p class="title">
          <a href="${it.link}" target="_blank" rel="noopener">${it.title}</a>
        </p>
        <div class="meta">
          <span>${it.source ? "출처: " + it.source : ""}</span>
          <span>${it.pubDate ? "게시: " + it.pubDate : ""}</span>
          ${isNew ? `<span class="pill new">새 글</span>` : `<span class="pill">읽음</span>`}
        </div>
      `;
      $list.appendChild(card);
    });

    $status.textContent = `총 ${data.items.length}건 표시`;

    if (newCount > 0) {
      $badge.style.display = "inline-flex";
      $badge.textContent = `새 글 ${newCount}건`;
    }

    // “페이지를 보면 읽었다”로 처리: 불러온 링크를 seen에 저장
    data.items.forEach(x => seen.add(x.link));
    saveSeen(seen);
  }

  document.getElementById("refresh").addEventListener("click", () => fetchNews().catch(() => {
    $status.textContent = "오류 발생";
  }));

  document.getElementById("reset").addEventListener("click", () => {
    localStorage.removeItem(SEEN_KEY);
    alert("새 글 표시 기준을 초기화했습니다. 다시 불러오면 모두 새 글로 보일 수 있습니다.");
  });

  fetchNews().catch(() => { $status.textContent = "오류 발생"; });
</script>
</body>
</html>
