<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>코엔서비스 업무공유 게시판 (KOEN Service Work Board)</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --bd:#e6e8ef; --txt:#1f2330; --mut:#6b7280;
      --accent:#2563eb; --shadow:0 10px 25px rgba(0,0,0,.06); --r:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--txt)}
    .top{position:sticky;top:0;z-index:10;background:rgba(246,247,251,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--bd)}
    .wrap{max-width:980px;margin:0 auto;padding:12px}
    h1{margin:0;font-size:18px}
    .sub{color:var(--mut);font-size:12px;margin-top:4px}
    .tabs{display:flex;gap:8px;margin-top:10px}
    .tab{
      flex:1;border:1px solid var(--bd);background:#fff;border-radius:999px;
      padding:10px 12px;font-weight:900;cursor:pointer;
    }
    .tab.active{border-color:var(--accent); color:var(--accent)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }

    .card{
      background:var(--card);border:1px solid var(--bd);border-radius:var(--r);
      box-shadow:var(--shadow);padding:12px;
    }
    .cardHead{display:flex;align-items:baseline;justify-content:space-between;gap:10px;margin-bottom:10px}
    .badge{
      display:inline-flex;gap:8px;align-items:center;
      font-weight:900;
    }
    .date{color:var(--mut);font-weight:800;font-size:12px}
    .status{color:var(--mut);font-size:12px}
    .section{margin-top:10px}
    .label{font-size:12px;color:var(--mut);margin:0 0 6px;font-weight:800}
 textarea{
  width:100%;
  min-height:120px;
  max-height:70vh;          /* 너무 길어지면 화면을 다 먹지 않게 */
  overflow-y:auto;          /* max-height 넘어가면 스크롤 */
  padding:12px;
  border:1px solid var(--bd);
  border-radius:12px;
  font-size:14px;
  line-height:1.55;
  resize:none;              /* 수동 리사이즈 대신 자동 높이 */
  background:#fff;
}

    .hint{color:var(--mut);font-size:12px;margin-top:8px;line-height:1.4}
    .pill{
      display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--bd);
      background:#fff;color:var(--mut);font-size:11px;font-weight:800;
    }
    .mut{color:var(--mut)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    /* ✅ 어제 접기/펼치기 */
    details.fold{
      margin-top:12px;
      border:1px solid var(--bd);
      border-radius:var(--r);
      background:var(--card);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    details.fold > summary{
      list-style:none;
      cursor:pointer;
      padding:12px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    details.fold > summary::-webkit-details-marker{ display:none; }
    details.fold > summary .mut{ font-weight:800; font-size:12px; color:var(--mut); }
    details.fold[open] > summary{ border-bottom:1px solid var(--bd); }
    details.fold .inner{ padding:12px; }
  </style>
</head>

<body>
  <div class="top">
    <div class="wrap">
      <h1>코엔서비스 업무공유 게시판</h1>
      <div class="sub">KOEN Service Work Board</div>

      <div class="tabs">
        <button class="tab active" data-tab="IBS">IBS(방재실)</button>
        <button class="tab" data-tab="MECH">기계설비</button>
        <button class="tab" data-tab="ELEC">전기설비</button>
      </div>

      <div class="sub" style="margin-top:8px">
        자동 날짜 전환: <span class="mono" id="clockLabel"></span>
        <span class="pill" id="todayLabel"></span>
        <span class="pill" id="ydayLabel"></span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- IBS VIEW -->
    <div id="viewIBS">
      <div class="grid">
        <!-- Yesterday -->
        <div class="card">
          <div class="cardHead">
            <div class="badge">어제 <span class="date mono" id="ibsYDate"></span></div>
            <div class="status" id="ibsYStatus">불러오는 중…</div>
          </div>

          <div class="section">
            <div class="label">인계인수</div>
            <textarea id="ibsY_handover" placeholder=""></textarea>
          </div>
          <div class="section">
            <div class="label">금일 운전상태</div>
            <textarea id="ibsY_status" placeholder=""></textarea>
          </div>
          <div class="section">
            <div class="label">특이사항</div>
            <textarea id="ibsY_special" placeholder=""></textarea>
          </div>

          <div class="hint">※ 어제 내용도 언제든 수정 가능합니다. (입력하면 자동 저장)</div>
        </div>

        <!-- Today -->
        <div class="card">
          <div class="cardHead">
            <div class="badge">오늘 <span class="date mono" id="ibsTDate"></span></div>
            <div class="status" id="ibsTStatus">불러오는 중…</div>
          </div>

          <div class="section">
            <div class="label">인계인수</div>
            <textarea id="ibsT_handover" placeholder=""></textarea>
          </div>
          <div class="section">
            <div class="label">금일 운전상태</div>
            <textarea id="ibsT_status" placeholder=""></textarea>
          </div>
          <div class="section">
            <div class="label">특이사항</div>
            <textarea id="ibsT_special" placeholder=""></textarea>
          </div>

          <div class="hint">※ 밤 12시(한국시간) 지나면 “오늘”이 자동으로 “어제”로 바뀝니다. (날짜 기준 자동 전환)</div>
        </div>
      </div>
    </div>

    <!-- MECH VIEW -->
    <div id="viewMECH" style="display:none">
      <!-- ✅ 기본: 오늘(오늘/내일)만 노출 -->
      <div class="card">
        <div class="cardHead">
          <div class="badge">오늘 <span class="date mono" id="mechTDate"></span></div>
          <div class="status" id="mechTStatus">불러오는 중…</div>
        </div>

        <div class="section">
          <div class="label">오늘 작업사항</div>
          <textarea id="mechT_today" placeholder=""></textarea>
        </div>
        <div class="section">
          <div class="label">내일 작업사항</div>
          <textarea id="mechT_tomorrow" placeholder=""></textarea>
        </div>

        <div class="hint">
          ※ “오늘 작업사항”은 기본적으로 <b>어제 작성한 ‘내일 작업사항’</b>이 자동으로 넘어옵니다(오늘칸이 비어있을 때만).
        </div>
      </div>

      <!-- ✅ 어제는 접힘 -->
      <details class="fold">
        <summary>
          <span>어제(기계설비) 보기</span>
          <span class="mut"><span class="mono" id="mechYDate"></span></span>
        </summary>
        <div class="inner">
          <div class="cardHead" style="margin-bottom:8px">
            <div class="badge">어제</div>
            <div class="status" id="mechYStatus">불러오는 중…</div>
          </div>

          <div class="section">
            <div class="label">오늘 작업사항(기록)</div>
            <textarea id="mechY_today" placeholder=""></textarea>
          </div>
          <div class="section">
            <div class="label">내일 작업사항(계획)</div>
            <textarea id="mechY_tomorrow" placeholder=""></textarea>
          </div>

          <div class="hint">※ 어제 내용도 언제든 수정 가능합니다. (입력하면 자동 저장)</div>
        </div>
      </details>
    </div>

    <!-- ELEC VIEW -->
    <div id="viewELEC" style="display:none">
      <!-- ✅ 기본: 오늘(오늘/내일)만 노출 -->
      <div class="card">
        <div class="cardHead">
          <div class="badge">오늘 <span class="date mono" id="elecTDate"></span></div>
          <div class="status" id="elecTStatus">불러오는 중…</div>
        </div>

        <div class="section">
          <div class="label">오늘 작업사항</div>
          <textarea id="elecT_today" placeholder=""></textarea>
        </div>
        <div class="section">
          <div class="label">내일 작업사항</div>
          <textarea id="elecT_tomorrow" placeholder=""></textarea>
        </div>

        <div class="hint">
          ※ “오늘 작업사항”은 기본적으로 <b>어제 작성한 ‘내일 작업사항’</b>이 자동으로 넘어옵니다(오늘칸이 비어있을 때만).
        </div>
      </div>

      <!-- ✅ 어제는 접힘 -->
      <details class="fold">
        <summary>
          <span>어제(전기설비) 보기</span>
          <span class="mut"><span class="mono" id="elecYDate"></span></span>
        </summary>
        <div class="inner">
          <div class="cardHead" style="margin-bottom:8px">
            <div class="badge">어제</div>
            <div class="status" id="elecYStatus">불러오는 중…</div>
          </div>

          <div class="section">
            <div class="label">오늘 작업사항(기록)</div>
            <textarea id="elecY_today" placeholder=""></textarea>
          </div>
          <div class="section">
            <div class="label">내일 작업사항(계획)</div>
            <textarea id="elecY_tomorrow" placeholder=""></textarea>
          </div>

          <div class="hint">※ 어제 내용도 언제든 수정 가능합니다. (입력하면 자동 저장)</div>
        </div>
      </details>
    </div>

    <div class="hint" style="margin-top:12px">
      저장 방식: 입력 중 자동 저장(약 0.8초 후). 클릭할 버튼이 없도록 구성했습니다.
    </div>
  </div>

  <script type="module">
    import { db } from "./firebase.js";
    import { ref, onValue, update, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const $ = (id) => document.getElementById(id);
    const tabs = document.querySelectorAll(".tab");

    // ---- Date helpers (브라우저 로컬시간 = 한국 PC/폰이면 KST로 동작)
    const pad2 = (n)=>String(n).padStart(2,"0");
    const wday = ["일","월","화","수","목","금","토"];

    function isoFromDate(d){
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    function isoToday(){
      return isoFromDate(new Date());
    }
    function isoYesterday(){
      const d = new Date(); d.setDate(d.getDate()-1);
      return isoFromDate(d);
    }
    function prettyK(iso){
      const [Y,M,D] = iso.split("-").map(Number);
      const dt = new Date(Y, M-1, D);
      const yy = String(Y).slice(2);
      return `${yy}.${pad2(M)}.${pad2(D)}(${wday[dt.getDay()]})`;
    }

    // ---- Paths
    const pathIBS  = (iso)=>`daily/IBS/${iso}`;
    const pathMECH = (iso)=>`daily/MECH/${iso}`;
    const pathELEC = (iso)=>`daily/ELEC/${iso}`;

    // ---- Auto-save (debounce)
    const timers = new Map();
    function setSaving(elStatus){ elStatus.textContent = "저장 중…"; }
    function scheduleSave(key, fn){
      if (timers.has(key)) clearTimeout(timers.get(key));
      timers.set(key, setTimeout(fn, 800));
    }

    // ---- Live date labels + midnight refresh
    let ISO_TODAY = isoToday();
    let ISO_YDAY  = isoYesterday();

    // ✅ textarea 자동 높이(내용 줄 수에 따라 늘어남)
function autoSize(el){
  if (!el) return;
  el.style.height = "auto";
  el.style.height = Math.min(el.scrollHeight, window.innerHeight * 0.70) + "px";
}
function autoSizeAll(){
  document.querySelectorAll("textarea").forEach(autoSize);
}


    function refreshDateUI(){
      $("clockLabel").textContent = new Date().toLocaleString("ko-KR");
      $("todayLabel").textContent = `오늘: ${prettyK(ISO_TODAY)}`;
      $("ydayLabel").textContent  = `어제: ${prettyK(ISO_YDAY)}`;

      // IBS labels
      $("ibsTDate").textContent = prettyK(ISO_TODAY);
      $("ibsYDate").textContent = prettyK(ISO_YDAY);

      // MECH labels (어제 날짜는 summary에 표시됨)
      $("mechTDate").textContent = prettyK(ISO_TODAY);
      $("mechYDate").textContent = prettyK(ISO_YDAY);

      // ELEC labels
      $("elecTDate").textContent = prettyK(ISO_TODAY);
      $("elecYDate").textContent = prettyK(ISO_YDAY);
    }

    // ---- Bindings / listeners
    let unsubscribers = [];

    function clearListeners(){
      unsubscribers.forEach(u=>{ try{u();}catch(e){} });
      unsubscribers = [];
    }

    function bindIBS(){
      const rY = ref(db, pathIBS(ISO_YDAY));
      const uY = onValue(rY, (snap)=>{
        const v = snap.val() || {};
        $("ibsY_handover").value = v.handover || "";
        autoSize($("ibsY_handover"));
        $("ibsY_status").value   = v.status || "";
        $("ibsY_special").value  = v.special || "";
        const ts = v.updatedAt || null;
        $("ibsYStatus").textContent = ts ? `불러옴 (${new Date(ts).toLocaleString("ko-KR")})` : "불러옴";
      });

      const rT = ref(db, pathIBS(ISO_TODAY));
      const uT = onValue(rT, (snap)=>{
        const v = snap.val() || {};
        $("ibsT_handover").value = v.handover || "";
        $("ibsT_status").value   = v.status || "";
        $("ibsT_special").value  = v.special || "";
        const ts = v.updatedAt || null;
        $("ibsTStatus").textContent = ts ? `불러옴 (${new Date(ts).toLocaleString("ko-KR")})` : "불러옴";
      });

      const wire = (areaId, which, field) => {
        const ta = $(areaId);
        const statusEl = which === "Y" ? $("ibsYStatus") : $("ibsTStatus");
        ta.addEventListener("input", ()=>{
          autoSize(ta);            // ✅ 추가
            setSaving(statusEl);
          const iso = which === "Y" ? ISO_YDAY : ISO_TODAY;
          const key = `IBS:${which}:${field}`;
          scheduleSave(key, async ()=>{
            await update(ref(db, pathIBS(iso)), {
              [field]: ta.value,
              updatedAt: serverTimestamp()
            });
          });
        });
      };

      wire("ibsY_handover","Y","handover");
      wire("ibsY_status","Y","status");
      wire("ibsY_special","Y","special");

      wire("ibsT_handover","T","handover");
      wire("ibsT_status","T","status");
      wire("ibsT_special","T","special");

      unsubscribers.push(uY, uT);
    }

    async function ensureCarryOver(areaTodayId, todayPathFn, statusTodayEl){
      // 오늘.todayWork가 비어있을 때만: 오늘.todayWork <= 어제.tomorrowWork
      const todayRef = ref(db, todayPathFn(ISO_TODAY));
      const ydayRef  = ref(db, todayPathFn(ISO_YDAY));
      const [todaySnap, ydaySnap] = await Promise.all([get(todayRef), get(ydayRef)]);
      const todayVal = todaySnap.val() || {};
      const ydayVal  = ydaySnap.val() || {};

      const todayTA = $(areaTodayId);
      const todayAlready = (todayVal.todayWork || "").trim();
      const fromPlan = (ydayVal.tomorrowWork || "").trim();

      if (!todayAlready && fromPlan){
        todayTA.value = fromPlan;
        statusTodayEl.textContent = "자동 반영(어제 내일작업 → 오늘 작업)…";
        await update(todayRef, {
          todayWork: fromPlan,
          updatedAt: serverTimestamp()
        });
      }
    }

    function bindTwoField(kind, yTodayId, yTomorrowId, tTodayId, tTomorrowId, yStatusId, tStatusId, pathFn){
      const yRef = ref(db, pathFn(ISO_YDAY));
      const tRef = ref(db, pathFn(ISO_TODAY));

      const yStatusEl = $(yStatusId);
      const tStatusEl = $(tStatusId);

      const uY = onValue(yRef, (snap)=>{
        const v = snap.val() || {};
        $(yTodayId).value    = v.todayWork || "";
        $(yTomorrowId).value = v.tomorrowWork || "";
        const ts = v.updatedAt || null;
        yStatusEl.textContent = ts ? `불러옴 (${new Date(ts).toLocaleString("ko-KR")})` : "불러옴";
      });

      const uT = onValue(tRef, (snap)=>{
        const v = snap.val() || {};
        $(tTodayId).value    = v.todayWork || "";
        $(tTomorrowId).value = v.tomorrowWork || "";
        const ts = v.updatedAt || null;
        tStatusEl.textContent = ts ? `불러옴 (${new Date(ts).toLocaleString("ko-KR")})` : "불러옴";
      });

      const wire = (areaId, which, field) => {
        const ta = $(areaId);
        const statusEl = which === "Y" ? yStatusEl : tStatusEl;
        ta.addEventListener("input", ()=>{
        autoSize(ta);            // ✅ 추가
            setSaving(statusEl);
          const iso = which === "Y" ? ISO_YDAY : ISO_TODAY;
          const key = `${kind}:${which}:${field}:${areaId}`;
          scheduleSave(key, async ()=>{
            await update(ref(db, pathFn(iso)), {
              [field]: ta.value,
              updatedAt: serverTimestamp()
            });
          });
        });
      };

      wire(yTodayId, "Y", "todayWork");
      wire(yTomorrowId,"Y","tomorrowWork");
      wire(tTodayId, "T", "todayWork");
      wire(tTomorrowId,"T","tomorrowWork");

      unsubscribers.push(uY, uT);
    }

    async function bindMECH(){
      bindTwoField(
        "MECH",
        "mechY_today","mechY_tomorrow",
        "mechT_today","mechT_tomorrow",
        "mechYStatus","mechTStatus",
        pathMECH
      );
      await ensureCarryOver("mechT_today", pathMECH, $("mechTStatus"));
    }

    async function bindELEC(){
      bindTwoField(
        "ELEC",
        "elecY_today","elecY_tomorrow",
        "elecT_today","elecT_tomorrow",
        "elecYStatus","elecTStatus",
        pathELEC
      );
      await ensureCarryOver("elecT_today", pathELEC, $("elecTStatus"));
    }

    // ---- Tab switching
    function showView(tab){
      $("viewIBS").style.display  = tab==="IBS"  ? "" : "none";
      $("viewMECH").style.display = tab==="MECH" ? "" : "none";
      $("viewELEC").style.display = tab==="ELEC" ? "" : "none";
    }

    async function rebindAll(forTab){
      clearListeners();
      refreshDateUI();
      showView(forTab);

      if (forTab==="IBS") bindIBS();
      if (forTab==="MECH") await bindMECH();
      if (forTab==="ELEC") await bindELEC();
    }

    // ---- Midnight auto switch
    function startMidnightWatcher(){
      setInterval(async ()=>{
        const nowToday = isoToday();
        if (nowToday !== ISO_TODAY){
          ISO_TODAY = nowToday;
          ISO_YDAY  = isoYesterday();
          await rebindAll(currentTab);
        } else {
          $("clockLabel").textContent = new Date().toLocaleString("ko-KR");
        }
      }, 10_000);
    }

    // ---- init
    let currentTab = "IBS";
    refreshDateUI();
    rebindAll(currentTab);

    tabs.forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        tabs.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        currentTab = btn.dataset.tab;

        // 탭 이동 시 어제 접힘 상태로 시작하고 싶으면(선택사항):
        // document.querySelectorAll("details.fold").forEach(d => d.open = false);

        await rebindAll(currentTab);
      });
    });

    startMidnightWatcher();
  </script>
</body>
</html>
