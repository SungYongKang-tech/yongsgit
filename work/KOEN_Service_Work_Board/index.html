<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì½”ì—”ì„œë¹„ìŠ¤ ì—…ë¬´ê³µìœ  ê²Œì‹œíŒ (KOEN Service Work Board)</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --bd:#e6e8ef; --txt:#1f2330; --mut:#6b7280;
      --accent:#2563eb; --shadow:0 10px 25px rgba(0,0,0,.06); --r:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--txt)}
    .wrap{max-width:900px;margin:0 auto;padding:12px}
    .top{position:sticky;top:0;background:rgba(246,247,251,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--bd);z-index:10}
    .top .wrap{padding:10px 12px}
    h1{font-size:18px;margin:0 0 4px}
    .sub{font-size:12px;color:var(--mut)}
    .tabs{display:flex;gap:8px;margin-top:10px}
    .tab{flex:1;border:1px solid var(--bd);background:#fff;border-radius:999px;padding:10px 12px;font-weight:700}
    .tab.active{border-color:var(--accent); color:var(--accent)}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--shadow);padding:12px;margin-top:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .label{font-size:12px;color:var(--mut);margin-bottom:6px}
    input[type="date"]{width:100%;padding:10px 12px;border:1px solid var(--bd);border-radius:12px;font-size:14px}
    textarea{width:100%;min-height:260px;padding:12px;border:1px solid var(--bd);border-radius:12px;font-size:14px;line-height:1.5;resize:vertical}
    .btnbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    button{border:1px solid var(--bd);background:#fff;border-radius:12px;padding:10px 12px;font-weight:700}
    button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    button.ghost{background:transparent}
    .mut{color:var(--mut);font-size:12px;margin-top:8px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111827;color:#fff;
      padding:10px 12px;border-radius:12px;font-size:13px;opacity:0;pointer-events:none;transition:.25s}
    .toast.show{opacity:1}
    .pinback{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:99}
    .pinbox{width:min(420px,100%);background:#fff;border:1px solid var(--bd);border-radius:16px;box-shadow:var(--shadow);padding:14px}
    .pinbox h3{margin:0 0 8px;font-size:16px}
    .pinbox p{margin:0 0 10px;color:var(--mut);font-size:13px;line-height:1.4}
    .pinrow{display:flex;gap:8px}
    .pinrow input{flex:1;padding:12px;border:1px solid var(--bd);border-radius:12px;font-size:16px;letter-spacing:4px;text-align:center}
  </style>
</head>
<body>
  <div class="top">
    <div class="wrap">
      <h1>ì½”ì—”ì„œë¹„ìŠ¤ ì—…ë¬´ê³µìœ  ê²Œì‹œíŒ</h1>
      <div class="sub">KOEN Service Work Board</div>
      <div class="tabs">
        <button class="tab active" data-tab="IBS">IBS(ë°©ì¬ì‹¤)</button>
        <button class="tab" data-tab="MECH">ê¸°ê³„ì„¤ë¹„</button>
        <button class="tab" data-tab="ELEC">ì „ê¸°ì„¤ë¹„</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <div class="label">ë‚ ì§œ <span id="dateLabel" class="mono"></span></div>
          <input type="date" id="dateInput" />
          <div class="mut">í‘œì‹œ í˜•ì‹: <span class="mono">26.02.10(í™”)</span></div>
        </div>
        <div>
          <div class="label">ì„ íƒ ë¶„ì•¼</div>
          <div id="tabTitle" style="font-weight:900;font-size:16px">IBS(ë°©ì¬ì‹¤)</div>
          <div class="mut">í•˜ë£¨ 1ê°œ ë¬¸ì„œ(ìˆ˜ì •/ì €ì¥)</div>
        </div>
      </div>

      <div style="margin-top:10px">
        <div class="label">ë‚´ìš©(í…ìŠ¤íŠ¸)</div>
        <textarea id="textArea" placeholder="ì—¬ê¸°ì— ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
        <div class="mut">ë§ˆì§€ë§‰ ìˆ˜ì •: <span id="updatedAt">-</span></div>
      </div>

      <div class="btnbar">
        <button class="primary" id="saveBtn">ì €ì¥(ìˆ˜ì •)</button>
        <button id="refreshBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="ghost" id="copyBtn">ğŸ“‹ ì¹´í†¡ìš© ë³µì‚¬(ê¸°ê³„+ì „ê¸°ë§Œ)</button>
        <button class="ghost" id="pinBtn">ğŸ”’ PIN ì…ë ¥</button>
      </div>

      <div class="mut">
        â€» PINì€ â€œì“°ê¸°(ì €ì¥)â€ì—ë§Œ í•„ìš”í•©ë‹ˆë‹¤. ì—´ëŒì€ ëˆ„êµ¬ë‚˜ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br/>
        â€» ì¹´í†¡ ë³µì‚¬ì—ëŠ” <b>IBS(ë°©ì¬ì‹¤)</b> ë‚´ìš©ì´ í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <!-- PIN Modal -->
  <div class="pinback" id="pinBack">
    <div class="pinbox">
      <h3>ì“°ê¸° PIN ì…ë ¥</h3>
      <p>4ìë¦¬ PINì„ ì…ë ¥í•˜ë©´ ì´ ê¸°ê¸°ì—ì„œëŠ” ì €ì¥ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤(ë¸Œë¼ìš°ì €ì—ë§Œ ê¸°ì–µ).</p>
      <div class="pinrow">
        <input id="pinInput" inputmode="numeric" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" />
        <button class="primary" id="pinOkBtn" style="flex:0 0 auto">í™•ì¸</button>
      </div>
      <div class="btnbar" style="justify-content:flex-end;margin-top:10px">
        <button id="pinCancelBtn">ë‹«ê¸°</button>
        <button id="pinClearBtn">PIN í•´ì œ</button>
      </div>
      <div class="mut">ë³´ì•ˆì´ ê¼­ í•„ìš”í•˜ë©´(ì™¸ë¶€ ìˆ˜ì • ë°©ì§€) ë‹¤ìŒ ë‹¨ê³„ì—ì„œ Firebase Authë¡œ ê°•í™” ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    /* ==========================
       0) ì„¤ì •
    ========================== */
    // âœ… ì—¬ê¸° PINë§Œ ë°”ê¾¸ì‹œë©´ ë©ë‹ˆë‹¤.
    const WRITE_PIN = "1234";

    // âœ… Firebase ì„¤ì •ì€ ì•„ë˜ firebase.jsì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
    import { db } from "./firebase.js";
    import {
      ref, get, update, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    /* ==========================
       1) DOM
    ========================== */
    const $ = (id) => document.getElementById(id);
    const tabs = document.querySelectorAll(".tab");

    const dateInput  = $("dateInput");
    const dateLabel  = $("dateLabel");
    const tabTitle   = $("tabTitle");
    const textArea   = $("textArea");
    const updatedAt  = $("updatedAt");

    const saveBtn    = $("saveBtn");
    const refreshBtn = $("refreshBtn");
    const copyBtn    = $("copyBtn");
    const pinBtn     = $("pinBtn");

    const pinBack    = $("pinBack");
    const pinInput   = $("pinInput");
    const pinOkBtn   = $("pinOkBtn");
    const pinCancelBtn = $("pinCancelBtn");
    const pinClearBtn  = $("pinClearBtn");

    const toastEl = $("toast");

    /* ==========================
       2) ìœ í‹¸
    ========================== */
    const pad2 = (n) => String(n).padStart(2,"0");
    const wday = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];

    function isoToday(){
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    function isoTomorrow(){
      const d = new Date();
      d.setDate(d.getDate()+1);
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    function fmtKorean(iso){
      // iso: YYYY-MM-DD -> "26.02.10(í™”)"
      const [Y,M,D] = iso.split("-").map(Number);
      const d = new Date(Y, M-1, D);
      const yy = String(Y).slice(2);
      return `${yy}.${pad2(M)}.${pad2(D)}(${wday[d.getDay()]})`;
    }
    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), 1400);
    }

    // PIN (ê¸°ê¸° ë¡œì»¬ ì €ì¥ â€” â€œì“°ê¸° ì œí•œìš©â€)
    const PIN_KEY = "koen_swboard_pin_ok";
    function hasWriteAccess(){
      return localStorage.getItem(PIN_KEY) === "1";
    }
    function openPin(){
      pinBack.style.display = "flex";
      pinInput.value = "";
      setTimeout(()=>pinInput.focus(), 30);
    }
    function closePin(){
      pinBack.style.display = "none";
    }
    function requirePinOr(fn){
      if (hasWriteAccess()) return fn();
      openPin();
      showToast("ì“°ê¸° PINì´ í•„ìš”í•©ë‹ˆë‹¤");
    }

    /* ==========================
       3) ìƒíƒœ / ê²½ë¡œ
    ========================== */
    const TAB_NAMES = {
      IBS:  "IBS(ë°©ì¬ì‹¤)",
      MECH: "ê¸°ê³„ì„¤ë¹„",
      ELEC: "ì „ê¸°ì„¤ë¹„"
    };

    let currentTab = "IBS"; // IBS/MECH/ELEC

    function pathFor(tab, iso){
      // /daily/{TAB}/{YYYY-MM-DD}
      return `daily/${tab}/${iso}`;
    }

    function setDefaultDateByTab(){
      if (currentTab === "IBS") dateInput.value = isoToday();
      else dateInput.value = isoTomorrow(); // ê¸°ê³„/ì „ê¸°: â€œë‚´ì¼ ì¼ì •â€ ê¸°ë³¸
      dateLabel.textContent = `(${fmtKorean(dateInput.value)})`;
    }

    function renderHeader(){
      tabTitle.textContent = TAB_NAMES[currentTab] || currentTab;
      dateLabel.textContent = `(${fmtKorean(dateInput.value)})`;
    }

    /* ==========================
       4) DB ë¡œë“œ/ì €ì¥
    ========================== */
    async function loadDoc(){
      const iso = dateInput.value;
      renderHeader();

      const r = ref(db, pathFor(currentTab, iso));
      const snap = await get(r);

      const data = snap.exists() ? snap.val() : null;
      textArea.value = (data?.text || "");
      updatedAt.textContent = data?.updatedAt
        ? new Date(data.updatedAt).toLocaleString("ko-KR")
        : "-";

      showToast("ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤");
    }

    async function saveDoc(){
      const iso = dateInput.value;
      const text = (textArea.value || "").trim();

      const r = ref(db, pathFor(currentTab, iso));
      await update(r, {
        text,
        updatedAt: serverTimestamp()
      });

      showToast("ì €ì¥í–ˆìŠµë‹ˆë‹¤");
      await loadDoc(); // ìˆ˜ì •ì‹œê°„ ê°±ì‹ 
    }

    async function buildKakaoText(){
      const iso = dateInput.value; // í˜„ì¬ ì„ íƒ ë‚ ì§œ ê¸°ì¤€(ë³´í†µ ë‚´ì¼)
      const mech = await get(ref(db, pathFor("MECH", iso)));
      const elec = await get(ref(db, pathFor("ELEC", iso)));

      const mechText = mech.exists() ? (mech.val()?.text || "").trim() : "";
      const elecText = elec.exists() ? (elec.val()?.text || "").trim() : "";

      const header = `[${fmtKorean(iso)} ì‘ì—…ë‚´ìš©]`;
      const parts = [];

      parts.push(header);
      parts.push("");
      parts.push("[ê¸°ê³„ì„¤ë¹„]");
      parts.push(mechText || "- (ë‚´ìš© ì—†ìŒ)");
      parts.push("");
      parts.push("[ì „ê¸°ì„¤ë¹„]");
      parts.push(elecText || "- (ë‚´ìš© ì—†ìŒ)");

      return parts.join("\n");
    }

    async function copyKakao(){
      const txt = await buildKakaoText();
      await navigator.clipboard.writeText(txt);
      showToast("ì¹´í†¡ìš© ë¬¸êµ¬ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤");
    }

    /* ==========================
       5) ì´ë²¤íŠ¸
    ========================== */
    tabs.forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        tabs.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        currentTab = btn.dataset.tab;

        setDefaultDateByTab();
        renderHeader();
        await loadDoc();
      });
    });

    dateInput.addEventListener("change", async ()=>{
      renderHeader();
      await loadDoc();
    });

    refreshBtn.addEventListener("click", loadDoc);

    saveBtn.addEventListener("click", ()=>{
      requirePinOr(saveDoc);
    });

    copyBtn.addEventListener("click", copyKakao);

    pinBtn.addEventListener("click", openPin);

    pinOkBtn.addEventListener("click", ()=>{
      const v = (pinInput.value || "").trim();
      if (v === WRITE_PIN){
        localStorage.setItem(PIN_KEY, "1");
        closePin();
        showToast("PIN í™•ì¸ ì™„ë£Œ(ì“°ê¸° ê°€ëŠ¥)");
      } else {
        showToast("PINì´ í‹€ë ¸ìŠµë‹ˆë‹¤");
      }
    });

    pinCancelBtn.addEventListener("click", closePin);
    pinClearBtn.addEventListener("click", ()=>{
      localStorage.removeItem(PIN_KEY);
      showToast("PINì„ í•´ì œí–ˆìŠµë‹ˆë‹¤");
    });

    pinBack.addEventListener("click", (e)=>{
      if (e.target === pinBack) closePin();
    });

    /* ==========================
       6) ì´ˆê¸°í™”
    ========================== */
    // ì´ˆê¸° íƒ­/ë‚ ì§œ: IBS=ì˜¤ëŠ˜, ê¸°ê³„/ì „ê¸°=ë‚´ì¼(íƒ­ ì´ë™ ì‹œ)
    dateInput.value = isoToday();
    renderHeader();
    loadDoc();
  </script>
</body>
</html>
