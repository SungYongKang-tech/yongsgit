<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Energy Insights</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --text:#e8eefc; --muted:#a9b6d6;
      --line:#243252; --good:#24c37a; --bad:#ff5c7a; --warn:#ffcc00;
      --btn:#1b2a4a; --btn2:#203458;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
      background:linear-gradient(180deg,#081026 0%, #070b14 100%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(7,11,20,.75); backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35}
    .grid{display:grid; gap:12px}
    .kpis{grid-template-columns: repeat(5, minmax(0, 1fr)); margin-top:14px}
    .card{
      background:rgba(17,26,46,.92);
      border:1px solid rgba(255,255,255,.07);
      border-radius:16px; padding:14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    .k{color:var(--muted);font-size:12px}
    .v{margin-top:8px;font-size:18px;font-weight:750}
    .tiny{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.35}
    .row{display:grid; grid-template-columns: 1.15fr 1.85fr; gap:12px; margin-top:12px}
    .inputs{display:grid; gap:10px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input, select, textarea{
      width:100%; padding:10px 11px; border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(10,16,30,.75);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:64px; resize:vertical}
    input::placeholder{color:rgba(169,182,214,.55)}
    .btns{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    button{
      border:1px solid rgba(255,255,255,.10);
      background:var(--btn); color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer;
      font-weight:650;
    }
    button:hover{background:var(--btn2)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(10,16,30,.6);
      color:var(--muted); font-size:12px;
    }
    .status{font-weight:800}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .warn{color:var(--warn)}
    .coach{
      margin-top:10px; padding:12px; border-radius:14px;
      border:1px dashed rgba(255,255,255,.14);
      background:rgba(10,16,30,.55);
      color:var(--muted); font-size:13px; line-height:1.6;
      white-space:pre-wrap;
    }
    table{
      width:100%; border-collapse:collapse; margin-top:10px; overflow:hidden;
      border-radius:14px; border:1px solid rgba(255,255,255,.08);
    }
    th, td{
      padding:9px 10px; text-align:right;
      border-bottom:1px solid rgba(255,255,255,.07);
      font-size:13px;
    }
    th:first-child, td:first-child{text-align:center}
    th:nth-child(2), td:nth-child(2){text-align:center}
    th:nth-child(3), td:nth-child(3){text-align:center}
    th{
      color:var(--muted); font-weight:750;
      background:rgba(10,16,30,.55);
      position:sticky; top:64px;
    }
    tr:hover td{background:rgba(255,255,255,.03)}
    .tag{
      display:inline-flex; gap:6px; align-items:center;
      padding:4px 8px; border-radius:999px;
      font-size:12px; border:1px solid rgba(255,255,255,.10);
      color:var(--muted); background:rgba(10,16,30,.45);
    }
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .tab{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(10,16,30,.55);
      color:var(--muted);
      padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:700; font-size:12px;
    }
    .tab.active{background:rgba(32,52,88,.85); color:var(--text)}
    .split{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    @media (max-width: 980px){
      .kpis{grid-template-columns: repeat(2, minmax(0, 1fr));}
      .row{grid-template-columns:1fr}
      .split{grid-template-columns:1fr}
      th{top:120px}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Energy Insights</h1>
    <div class="sub">
      ë³¸ì‚¬(ì „ê¸°+ì—´)ë§Œ í‰ê°€ Â· ëª©í‘œ ì ˆê°ë¥  1% ê³ ì • Â· ì—´ ì˜ˆì¸¡ì€ 2025 ë™ì¼ì›” ìë™ ì ìš©<br/>
      í™˜ì‚°ê³„ìˆ˜: ì „ê¸°(MWh)Ã—0.229 + ì—´(Gcal)Ã—0.1 = TOE
    </div>

    <div class="grid kpis">
      <div class="card">
        <div class="k">ê¸°ì¤€(20~22 í‰ê· )</div>
        <div class="v" id="kpiBaseline">-</div>
        <div class="tiny">toe</div>
      </div>
      <div class="card">
        <div class="k">ë§Œì  ëª©í‘œ(âˆ’1%)</div>
        <div class="v" id="kpiTarget">-</div>
        <div class="tiny">toe ì´í•˜</div>
      </div>
      <div class="card">
        <div class="k">2026 ì˜ˆìƒ ì—°ê°„</div>
        <div class="v" id="kpiEstToe">-</div>
        <div class="tiny">toe (ì‹¤ì +ì˜ˆìƒ)</div>
      </div>
      <div class="card">
        <div class="k">ìµœì¢… ì ˆê°ë¥ (ì—°ë§ ì˜ˆìƒ)</div>
        <div class="v" id="kpiSaving">-</div>
        <div class="tiny">%</div>
      </div>
      <div class="card">
        <div class="k">íŒì •(ë§Œì )</div>
        <div class="v status" id="kpiPass">-</div>
        <div class="tiny">â‰¥ 1.00%</div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tab2026">2026 ì…ë ¥/ì¡°ì ˆ</div>
      <div class="tab" id="tab2025">2025 ì‹¤ì (ê¸°ì¤€/ì°¸ê³ )</div>
      <div class="tab" id="tabReport">ë³´ê³ ì„œ/ë‚´ë³´ë‚´ê¸°</div>
      <div class="pill" style="margin-left:auto">
        <span id="nowInfo"></span>
      </div>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- 2026 -->
  <section id="sec2026">
    <div class="row">
      <div class="card">
        <div class="pill">
          <span>ì…ë ¥ ëŒ€ìƒ:</span>
          <strong>2026ë…„ ë³¸ì‚¬</strong>
          <span style="opacity:.7">Â·</span>
          <span class="tag">ì´ì „ ì…ë ¥ê°’ í™•ì¸/ìˆ˜ì • ê°€ëŠ¥</span>
        </div>

        <div class="inputs" style="margin-top:12px">
          <div class="grid" style="grid-template-columns: 1fr 1fr; gap:10px">
            <div>
              <label>ì›” ì„ íƒ</label>
              <select id="selMonth"></select>
            </div>
            <div>
              <label>ì‹¤ì /ì˜ˆìƒ</label>
              <select id="selType">
                <option value="actual">ì‹¤ì (í™•ì •)</option>
                <option value="forecast">ì˜ˆìƒ(ë¯¸í™•ì •)</option>
              </select>
            </div>
          </div>

          <div class="grid" style="grid-template-columns: 1fr 1fr; gap:10px">
            <div>
              <label>ì „ê¸° (ë³¸ì‚¬, MWh)</label>
              <input id="inpElec" type="number" step="0.001" placeholder="ì˜ˆ: 305.129" />
              <div class="tiny" id="hintElec"></div>
            </div>
            <div>
              <label>ì—´ (ë³¸ì‚¬, Gcal)</label>
              <input id="inpHeat" type="number" step="0.1" placeholder="ì˜ˆ: 85.1" />
              <div class="tiny" id="hintHeat"></div>
            </div>
          </div>

          <div>
            <label>ë©”ëª¨(ë³´ê³ ì„œ ì°¸ê³ )</label>
            <textarea id="inpMemo" placeholder="ì˜ˆ: 3ì›” ê³µì¡° ê°€ë™ ì¦ê°€, 7ì›” í­ì—¼ ì˜í–¥ ë“±"></textarea>
            <div class="tiny">â€» ë©”ëª¨ë„ í•¨ê»˜ ì €ì¥ë˜ë©° CSV/JSON ë‚´ë³´ë‚´ê¸°ì— í¬í•¨ë©ë‹ˆë‹¤.</div>
          </div>

          <div class="btns">
            <button id="btnAutoHeat">ì—´ ìë™(2025 ë™ì¼ì›”)</button>
            <button id="btnAutoBoth">ì „ê¸°Â·ì—´ ìë™(2025 ë™ì¼ì›”)</button>
            <button id="btnSave">ì €ì¥</button>
            <button id="btnClearMonth">ì´ ë‹¬ ì…ë ¥ ì‚­ì œ</button>
          </div>

          <div class="coach" id="coachBox">ë‹¤ìŒ ë‹¬ ê¶Œì¥ ì‚¬ìš©ëŸ‰ì„ ê³„ì‚°í•©ë‹ˆë‹¤â€¦</div>

          <div class="coach" id="detailBox" style="border-style:solid">
            ì„ íƒ ì›” ìƒì„¸(ë³´ê³ ì„œìš©): ê³„ì‚° ì¤‘â€¦
          </div>
        </div>
      </div>

      <div class="card">
        <div class="pill">
          <span>2026 ì›”ë³„ í˜„í™©(ì „ê¸°Â·ì—´Â·TOE)</span>
          <span style="opacity:.7">Â·</span>
          <span class="tag">ë¯¸ì…ë ¥ ë‹¬ì€ 2025 ë™ì¼ì›”ë¡œ ìë™ ì˜ˆì¸¡</span>
        </div>

        <table>
          <thead>
            <tr>
              <th>ì›”</th>
              <th>êµ¬ë¶„</th>
              <th>ì…ë ¥ì—¬ë¶€</th>
              <th>ì „ê¸°(MWh)</th>
              <th>ì—´(Gcal)</th>
              <th>ì›” TOE</th>
              <th>ëˆ„ê³„ TOE</th>
            </tr>
          </thead>
          <tbody id="tbody2026"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 2025 -->
  <section id="sec2025" style="display:none">
    <div class="card">
      <div class="pill">
        <span>2025 ì‹¤ì (ë³¸ì‚¬)</span>
        <span style="opacity:.7">Â·</span>
        <span class="tag">12ì›” ì „ê¸°=2024ë…„ 12ì›” 300.766 MWh ëŒ€ì²´</span>
        <span class="tag">12ì›” ì—´=ê³ ì§€ì„œ 59.6 Gcal</span>
      </div>

      <div class="split" style="margin-top:12px">
        <div class="coach">
          <div style="color:var(--text);font-weight:800;margin-bottom:8px">2025 ì—°ê°„ ìš”ì•½</div>
          <div id="box2025sum"></div>
        </div>
        <div class="coach">
          <div style="color:var(--text);font-weight:800;margin-bottom:8px">ìš©ë„</div>
          <div>
            - 2026ì˜ ë¯¸ì…ë ¥ ë‹¬ì— ê¸°ë³¸ ì˜ˆì¸¡ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.<br/>
            - ë³´ê³ ì„œ ì‘ì„± ì‹œ â€œì „ë…„ ë™ì›” ëŒ€ë¹„â€ ê·¼ê±°ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.<br/>
          </div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>ì›”</th>
            <th>ì—°ë„</th>
            <th>êµ¬ë¶„</th>
            <th>ì „ê¸°(MWh)</th>
            <th>ì—´(Gcal)</th>
            <th>ì›” TOE</th>
            <th>ëˆ„ê³„ TOE</th>
          </tr>
        </thead>
        <tbody id="tbody2025"></tbody>
      </table>
    </div>
  </section>

  <!-- Report / Export -->
  <section id="secReport" style="display:none">
    <div class="card">
      <div class="pill">
        <span>ë³´ê³ ì„œ/ë‚´ë³´ë‚´ê¸°</span>
        <span style="opacity:.7">Â·</span>
        <span class="tag">CSVëŠ” ì—‘ì…€ì— ë°”ë¡œ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥</span>
      </div>

      <div class="split" style="margin-top:12px">
        <div class="coach" id="reportSummary">ìš”ì•½ ê³„ì‚° ì¤‘â€¦</div>
        <div class="coach">
          <div style="color:var(--text);font-weight:800;margin-bottom:8px">ë‚´ë³´ë‚´ê¸°</div>
          <div class="btns">
            <button id="btnExportCSV">2026 CSV ë‚´ë³´ë‚´ê¸°</button>
            <button id="btnExportJSON">2026 JSON ë‚´ë³´ë‚´ê¸°</button>
            <button id="btnResetAll">2026 ë°ì´í„° ì „ì²´ ì´ˆê¸°í™”</button>
          </div>
          <pre id="exportBox" class="mono" style="display:none;margin-top:10px;white-space:pre-wrap;background:rgba(10,16,30,.6);border:1px solid rgba(255,255,255,.08);padding:10px;border-radius:12px;color:var(--muted);font-size:12px"></pre>
        </div>
      </div>
    </div>
  </section>

</main>

<script>
/* =========================
   ê³ ì •ê°’(í™•ì •)
========================= */
const BASELINE_TOE = 1065.772;               // 20~22 í‰ê· (í™•ì •)
const TARGET_TOE   = BASELINE_TOE * 0.99;    // 1% ì ˆê° ëª©í‘œ
const F_ELEC = 0.229;                        // toe/MWh
const F_HEAT = 0.1;                          // toe/Gcal

/* =========================
   2025 ê¸°ì¤€(ë³¸ì‚¬) ë‚´ì¥ ë°ì´í„°
   - ì „ê¸°: 12ì›” ë¯¸ë°œí–‰ â†’ 2024.12(300.766) ëŒ€ì²´
   - ì—´: 12ì›” 59.6 ê³ ì§€ì„œ(í™•ì •)
========================= */
const Y2025 = {
  elec: [305.129,301.270,300.671,279.930,297.870,331.899,399.850,399.668,383.314,316.183,298.696,300.766],
  heat: [ 85.1, 104.8,  49.8,  15.7,  41.0, 109.4, 188.2, 179.5, 158.0,  34.2,  25.3,  59.6]
};

function toeOfMonth(elecMWh, heatGcal){
  return (elecMWh||0)*F_ELEC + (heatGcal||0)*F_HEAT;
}
const toe25 = Array.from({length:12}, (_,i)=> toeOfMonth(Y2025.elec[i], Y2025.heat[i]));

/* =========================
   2026 ë°ì´í„° ì €ì¥(ë¡œì»¬)
========================= */
const LS_KEY = "energy_insights_2026_v2";

function default2026(){
  return Array.from({length:12}, (_,i)=>({
    m:i+1,
    type:"forecast",
    elec_mwh:null,
    heat_gcal:null,
    memo:""
  }));
}
function load2026(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw) return default2026();
  try{
    const parsed = JSON.parse(raw);
    if(!Array.isArray(parsed) || parsed.length !== 12) return default2026();
    return parsed.map((x,i)=>({
      m:i+1,
      type: (x.type==="actual"||x.type==="forecast") ? x.type : "forecast",
      elec_mwh: (x.elec_mwh==null || x.elec_mwh==="") ? null : Number(x.elec_mwh),
      heat_gcal: (x.heat_gcal==null || x.heat_gcal==="") ? null : Number(x.heat_gcal),
      memo: (x.memo==null) ? "" : String(x.memo)
    }));
  }catch(e){
    return default2026();
  }
}
function save2026(data){
  localStorage.setItem(LS_KEY, JSON.stringify(data));
}

/* =========================
   UI helpers
========================= */
const el = (id)=>document.getElementById(id);

function fmt(n, digits=3){
  if(n===null || n===undefined || Number.isNaN(n)) return "-";
  const x = Number(n);
  return x.toLocaleString("en-US",{minimumFractionDigits:digits, maximumFractionDigits:digits});
}
function fmt2(n){ return fmt(n,2); }
function fmt1(n){ return fmt(n,1); }
function fmt3(n){ return fmt(n,3); }
function fmtPct(n){
  if(n===null || n===undefined || Number.isNaN(n)) return "-";
  return (Number(n)).toFixed(2);
}

/* =========================
   ê³„ì‚°: 2026 ì˜ˆì¸¡ í¬í•¨ ì—°ê°„/ì ˆê°ë¥ 
========================= */
function compute2026(data){
  const used = data.map((row,i)=>{
    const hasInput = (row.elec_mwh!=null || row.heat_gcal!=null || (row.memo||"").trim()!=="");
    const elec = (row.elec_mwh!=null) ? row.elec_mwh : Y2025.elec[i];
    const heat = (row.heat_gcal!=null) ? row.heat_gcal : Y2025.heat[i];
    const toe  = toeOfMonth(elec, heat);
    return { ...row, hasInput, used_elec:elec, used_heat:heat, used_toe:toe };
  });

  let cum = 0;
  const withCum = used.map(r=>{
    cum += r.used_toe;
    return {...r, cum_toe:cum};
  });

  const annualToeEst = withCum.reduce((s,r)=> s + r.used_toe, 0);
  const savingPctFinal = (BASELINE_TOE - annualToeEst) / BASELINE_TOE * 100;

  return { withCum, annualToeEst, savingPctFinal };
}

/* =========================
   ì½”ì¹˜: ë‹¤ìŒë‹¬ ê¶Œì¥ ì „ê¸° ìƒí•œ
   - í™•ì • ì‹¤ì (actual + elec/heat ë‘˜ë‹¤ ì…ë ¥) ì œì™¸í•œ ë‚˜ë¨¸ì§€ ë‹¬ì€ 2025 íŒ¨í„´ ë¹„ìœ¨ë¡œ ì¬ë°°ë¶„
========================= */
function coachNextMonth(data, selectedMonth){
  const calc = compute2026(data);
  const used = calc.withCum;

  const isLockedActual = (r)=> (r.type==="actual" && r.elec_mwh!=null && r.heat_gcal!=null);

  const locked = used.filter(isLockedActual);
  const toeLocked = locked.reduce((s,r)=> s + r.used_toe, 0);

  const adjustable = used.filter(r=> !isLockedActual(r));
  const budgetRemain = TARGET_TOE - toeLocked;

  if(budgetRemain < 0){
    return `âš ï¸ ì´ë¯¸ í™•ì •ëœ ì‹¤ì (LOCK)ë§Œìœ¼ë¡œ ëª©í‘œ(ì—° 1% ì ˆê°)ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.\n` +
           `- í™•ì • ì‹¤ì  í•©ê³„: ${fmt2(toeLocked)} toe\n` +
           `- ëª©í‘œ: ${fmt2(TARGET_TOE)} toe\n` +
           `â†’ ë‚¨ì€ ë‹¬ì„ 0ìœ¼ë¡œ ì¡ì•„ë„ PASSê°€ ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
  }

  const sumW = adjustable.reduce((s,r)=> s + toe25[r.m-1], 0);
  const weightOf = (m)=>{
    const r = adjustable.find(x=>x.m===m);
    if(!r) return null;
    return (sumW>0 ? toe25[m-1]/sumW : 1/adjustable.length);
  };

  const nextM = selectedMonth < 12 ? selectedMonth+1 : null;
  if(nextM===null){
    return `12ì›”ì…ë‹ˆë‹¤. ì˜¬í•´ ë°ì´í„° í™•ì •/ì ê²€ë§Œ í•˜ì‹œë©´ ë©ë‹ˆë‹¤.\n(ì—°ë§ ì˜ˆìƒ ì ˆê°ë¥ ì€ ìƒë‹¨ KPIë¥¼ í™•ì¸í•˜ì„¸ìš”.)`;
  }

  const nextRow = used[nextM-1];
  if(isLockedActual(nextRow)){
    return `ë‹¤ìŒ ë‹¬(${nextM}ì›”)ì€ ì´ë¯¸ ì‹¤ì ìœ¼ë¡œ í™•ì •(LOCK)ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\në‹¤ë¥¸ ë‹¬ ì…ë ¥/ì¡°ì ˆë¡œ ëª©í‘œë¥¼ ë§ì¶°ì£¼ì„¸ìš”.`;
  }

  const wNext = weightOf(nextM) ?? 0;
  const toeGoalNext = budgetRemain * wNext;

  const heatNext = (nextRow.heat_gcal!=null) ? nextRow.heat_gcal : Y2025.heat[nextM-1];
  const heatToeNext = heatNext * F_HEAT;

  const elecToeGoal = Math.max(0, toeGoalNext - heatToeNext);
  const elecMWhGoal = elecToeGoal / F_ELEC;

  const elecRef = Y2025.elec[nextM-1];
  const deltaPct = (elecMWhGoal - elecRef) / elecRef * 100;

  return `ğŸ“Œ ëª©í‘œ(ì—° 1% ì ˆê°) ë‹¬ì„±ì„ ìœ„í•œ â€œë‹¤ìŒ ë‹¬(${nextM}ì›”) ê¶Œì¥ ìƒí•œâ€\n` +
         `- ì—´(ê¸°ë³¸ì˜ˆì¸¡): ${fmt1(heatNext)} Gcal â†’ ${fmt2(heatToeNext)} toe\n` +
         `- ì „ê¸°(ê¶Œì¥): ${fmt3(elecMWhGoal)} MWh ì´í•˜\n` +
         `- ì°¸ê³ : 2025ë…„ ${nextM}ì›” ì „ê¸° ${fmt3(elecRef)} MWh ëŒ€ë¹„ ` +
         `${deltaPct>=0 ? "+" : ""}${deltaPct.toFixed(1)}%`;
}

/* =========================
   ì„ íƒ ì›” ìƒì„¸(ë³´ê³ ì„œìš©)
========================= */
function detailForMonth(data, m){
  const row = data[m-1];
  const elec = (row.elec_mwh!=null) ? row.elec_mwh : Y2025.elec[m-1];
  const heat = (row.heat_gcal!=null) ? row.heat_gcal : Y2025.heat[m-1];
  const toe = toeOfMonth(elec, heat);

  const refElec = Y2025.elec[m-1];
  const refHeat = Y2025.heat[m-1];
  const refToe  = toe25[m-1];

  const dElec = (elec - refElec) / refElec * 100;
  const dHeat = (heat - refHeat) / refHeat * 100;
  const dToe  = (toe - refToe) / refToe * 100;

  const src = (row.type==="actual" ? "actual(ì‹¤ì )" : "forecast(ì˜ˆìƒ)");
  const inputState = (row.elec_mwh!=null || row.heat_gcal!=null) ? "ì…ë ¥ê°’ ì‚¬ìš©" : "ë¯¸ì…ë ¥(2025 ë™ì¼ì›” ìë™ì˜ˆì¸¡)";

  const memo = (row.memo||"").trim();

  return `ğŸ§¾ ${m}ì›” ìƒì„¸(2026)\n` +
         `- êµ¬ë¶„: ${src}\n` +
         `- ì „ê¸°: ${fmt3(elec)} MWh (${inputState})\n` +
         `- ì—´  : ${fmt1(heat)} Gcal (${inputState})\n` +
         `- ì›” TOE: ${fmt2(toe)} toe\n\n` +
         `ğŸ“Œ ì „ë…„(2025) ë™ì›” ëŒ€ë¹„\n` +
         `- ì „ê¸°: ${fmt3(refElec)} â†’ ${fmt3(elec)} (${dElec>=0?"+":""}${dElec.toFixed(1)}%)\n` +
         `- ì—´  : ${fmt1(refHeat)} â†’ ${fmt1(heat)} (${dHeat>=0?"+":""}${dHeat.toFixed(1)}%)\n` +
         `- TOE : ${fmt2(refToe)} â†’ ${fmt2(toe)} (${dToe>=0?"+":""}${dToe.toFixed(1)}%)\n` +
         (memo ? `\nğŸ“ ë©”ëª¨\n- ${memo}` : `\nğŸ“ ë©”ëª¨\n- (ì—†ìŒ)`);
}

/* =========================
   2025 í‘œ ë Œë”
========================= */
function render2025(){
  const tbody = el("tbody2025");
  tbody.innerHTML = "";
  let cum = 0;
  for(let i=0;i<12;i++){
    const toe = toe25[i];
    cum += toe;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>2025</td>
      <td><span class="tag">actual</span></td>
      <td>${fmt3(Y2025.elec[i])}</td>
      <td>${fmt1(Y2025.heat[i])}</td>
      <td>${fmt2(toe)}</td>
      <td>${fmt2(cum)}</td>
    `;
    tbody.appendChild(tr);
  }

  const sumElec = Y2025.elec.reduce((a,b)=>a+b,0);
  const sumHeat = Y2025.heat.reduce((a,b)=>a+b,0);
  const sumToe  = toe25.reduce((a,b)=>a+b,0);
  const savingPct = (BASELINE_TOE - sumToe) / BASELINE_TOE * 100;

  el("box2025sum").innerHTML =
    `- ì „ê¸° í•©ê³„: <b>${fmt3(sumElec)}</b> MWh<br/>` +
    `- ì—´ í•©ê³„: <b>${fmt1(sumHeat)}</b> Gcal<br/>` +
    `- ì—°ê°„ TOE: <b>${fmt2(sumToe)}</b> toe<br/>` +
    `- ê¸°ì¤€ ëŒ€ë¹„ ì ˆê°ë¥ : <b>${fmtPct(savingPct)}%</b>`;
}

/* =========================
   2026 í‘œ/KPI/ìƒì„¸/ë¦¬í¬íŠ¸ ë Œë”
========================= */
function render2026(){
  const data = load2026();
  const mSel = Number(el("selMonth").value || 1);

  // KPI
  el("kpiBaseline").textContent = fmt3(BASELINE_TOE);
  el("kpiTarget").textContent   = fmt3(TARGET_TOE);

  const calc = compute2026(data);
  const annualToeEst = calc.annualToeEst;
  const savingPct = calc.savingPctFinal;

  el("kpiEstToe").textContent = fmt2(annualToeEst);
  el("kpiSaving").textContent = `${fmtPct(savingPct)}%`;

  const pass = savingPct >= 1.0;
  el("kpiPass").textContent = pass ? "PASS" : "FAIL";
  el("kpiPass").className = `v status ${pass ? "good" : "bad"}`;
  el("kpiSaving").className = `v ${pass ? "good" : "warn"}`;

  // ì…ë ¥ì¹¸(ì„ íƒì›”)
  const row = data[mSel-1];
  el("selType").value = row.type;
  el("inpElec").value = (row.elec_mwh==null) ? "" : row.elec_mwh;
  el("inpHeat").value = (row.heat_gcal==null) ? "" : row.heat_gcal;
  el("inpMemo").value = row.memo || "";

  el("hintElec").textContent = `ê¸°ë³¸ì˜ˆì¸¡(2025 ${mSel}ì›”): ${fmt3(Y2025.elec[mSel-1])} MWh`;
  el("hintHeat").textContent = `ê¸°ë³¸ì˜ˆì¸¡(2025 ${mSel}ì›”): ${fmt1(Y2025.heat[mSel-1])} Gcal`;

  // ì½”ì¹˜ + ìƒì„¸
  el("coachBox").textContent = coachNextMonth(data, mSel);
  el("detailBox").textContent = detailForMonth(data, mSel);

  // í…Œì´ë¸”
  const tbody = el("tbody2026");
  tbody.innerHTML = "";
  calc.withCum.forEach((r,i)=>{
    const lockedActual = (r.type==="actual" && r.elec_mwh!=null && r.heat_gcal!=null);
    const typeLabel = lockedActual ? "actual" : "forecast";
    const inputLabel = (r.elec_mwh!=null || r.heat_gcal!=null || (r.memo||"").trim()!=="") ? "ì…ë ¥" : "ìë™";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.m}</td>
      <td><span class="tag">${typeLabel}</span></td>
      <td><span class="tag">${inputLabel}</span></td>
      <td>${fmt3(r.used_elec)}</td>
      <td>${fmt1(r.used_heat)}</td>
      <td>${fmt2(r.used_toe)}</td>
      <td>${fmt2(r.cum_toe)}</td>
    `;
    tbody.appendChild(tr);
  });

  // ë³´ê³ ì„œ ìš”ì•½
  el("reportSummary").textContent =
    `ğŸ“„ 2026 ë³´ê³ ì„œ ìš”ì•½(í˜„ì¬ ì…ë ¥ ê¸°ì¤€)\n` +
    `- ê¸°ì¤€(20~22 í‰ê· ): ${fmt3(BASELINE_TOE)} toe\n` +
    `- ë§Œì  ëª©í‘œ(âˆ’1%): ${fmt3(TARGET_TOE)} toe ì´í•˜\n` +
    `- 2026 ì˜ˆìƒ ì—°ê°„: ${fmt2(annualToeEst)} toe\n` +
    `- ìµœì¢… ì ˆê°ë¥ (ì—°ë§ ì˜ˆìƒ): ${fmtPct(savingPct)}%\n` +
    `- íŒì •: ${pass ? "PASS" : "FAIL"}\n\n` +
    `â€» ì›”ë³„ ì‚¬ìš©ëŸ‰(ì „ê¸°Â·ì—´Â·TOE)ì€ â€˜2026 ì›”ë³„ í˜„í™©â€™ í‘œì™€ â€˜ì„ íƒ ì›” ìƒì„¸â€™ì— ê·¼ê±°ë¡œ í‘œì‹œë©ë‹ˆë‹¤.`;
}

/* =========================
   Export
========================= */
function export2026CSV(){
  const data = load2026();
  const calc = compute2026(data);
  // CSV í—¤ë”: ë³´ê³ ì„œìš©(ì—°ë„/ì›”/êµ¬ë¶„/ì…ë ¥ê°’/ì ìš©ê°’/TOE/ëˆ„ê³„/ë©”ëª¨)
  const lines = [];
  lines.push([
    "year","month","type","input_elec_mwh","input_heat_gcal","used_elec_mwh","used_heat_gcal","month_toe","cum_toe","memo"
  ].join(","));

  calc.withCum.forEach(r=>{
    const esc = (s)=> `"${String(s??"").replaceAll('"','""')}"`;
    lines.push([
      "2026",
      r.m,
      r.type,
      (r.elec_mwh==null ? "" : r.elec_mwh),
      (r.heat_gcal==null ? "" : r.heat_gcal),
      r.used_elec,
      r.used_heat,
      r.used_toe,
      r.cum_toe,
      esc(r.memo||"")
    ].join(","));
  });

  return lines.join("\n");
}
function export2026JSON(){
  return JSON.stringify({year:2026, baseline_toe:BASELINE_TOE, target_toe:TARGET_TOE, factors:{elec:F_ELEC, heat:F_HEAT}, data:load2026()}, null, 2);
}

/* =========================
   Tabs
========================= */
function setTab(which){
  const t2026 = el("tab2026"), t2025 = el("tab2025"), tRep = el("tabReport");
  const s2026 = el("sec2026"), s2025 = el("sec2025"), sRep = el("secReport");

  [t2026,t2025,tRep].forEach(x=>x.classList.remove("active"));
  [s2026,s2025,sRep].forEach(x=>x.style.display="none");

  if(which==="2026"){ t2026.classList.add("active"); s2026.style.display="block"; }
  if(which==="2025"){ t2025.classList.add("active"); s2025.style.display="block"; }
  if(which==="report"){ tRep.classList.add("active"); sRep.style.display="block"; }
}

/* =========================
   init
========================= */
function init(){
  // date
  const now = new Date();
  el("nowInfo").textContent = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}`;

  // month select
  const sel = el("selMonth");
  for(let m=1;m<=12;m++){
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = `${m}ì›”`;
    sel.appendChild(opt);
  }
  sel.value = String(new Date().getMonth()+1);

  // events
  sel.addEventListener("change", ()=>render2026());
  el("selType").addEventListener("change", ()=>render2026());

  el("btnAutoHeat").addEventListener("click", ()=>{
    const data = load2026();
    const m = Number(sel.value);
    data[m-1].heat_gcal = Y2025.heat[m-1];
    save2026(data);
    render2026();
  });

  el("btnAutoBoth").addEventListener("click", ()=>{
    const data = load2026();
    const m = Number(sel.value);
    data[m-1].elec_mwh = Y2025.elec[m-1];
    data[m-1].heat_gcal = Y2025.heat[m-1];
    save2026(data);
    render2026();
  });

  el("btnSave").addEventListener("click", ()=>{
    const data = load2026();
    const m = Number(sel.value);

    const elec = el("inpElec").value.trim();
    const heat = el("inpHeat").value.trim();
    const memo = el("inpMemo").value;

    data[m-1].type = el("selType").value;
    data[m-1].elec_mwh = (elec==="") ? null : Number(elec);
    data[m-1].heat_gcal = (heat==="") ? null : Number(heat);
    data[m-1].memo = memo || "";

    save2026(data);
    render2026();
    alert(`${m}ì›” ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ì´ì „ ì…ë ¥ ì´ë ¥ì€ í‘œì—ì„œ ê³„ì† í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤)`);
  });

  el("btnClearMonth").addEventListener("click", ()=>{
    const data = load2026();
    const m = Number(sel.value);
    data[m-1].type = "forecast";
    data[m-1].elec_mwh = null;
    data[m-1].heat_gcal = null;
    data[m-1].memo = "";
    save2026(data);
    render2026();
  });

  el("btnExportCSV").addEventListener("click", ()=>{
    const csv = export2026CSV();
    const box = el("exportBox");
    box.style.display = "block";
    box.textContent = csv;
  });

  el("btnExportJSON").addEventListener("click", ()=>{
    const json = export2026JSON();
    const box = el("exportBox");
    box.style.display = "block";
    box.textContent = json;
  });

  el("btnResetAll").addEventListener("click", ()=>{
    if(!confirm("2026 ì…ë ¥ ë°ì´í„°ë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
    localStorage.removeItem(LS_KEY);
    render2026();
    const box = el("exportBox");
    box.style.display = "none";
    box.textContent = "";
  });

  // tabs
  el("tab2026").addEventListener("click", ()=>setTab("2026"));
  el("tab2025").addEventListener("click", ()=>setTab("2025"));
  el("tabReport").addEventListener("click", ()=>setTab("report"));

  // first render
  render2025();
  render2026();
  setTab("2026");
}

init();
</script>
</body>
</html>
