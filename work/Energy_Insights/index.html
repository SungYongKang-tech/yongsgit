<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Energy Insights</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#111111;
      --muted:#666666;
      --line:#e5e7eb;
      --soft:#f8fafc;

      --bill:#dc2626;      /* ê³ ì§€ì„œ(í™•ì •) ë¹¨ê°• */
      --planner:#16a34a;   /* íŒŒì›Œí”Œë˜ë„ˆ ì´ˆë¡ */
      --forecast:#2563eb;  /* ì˜ˆìƒ íŒŒë‘ */
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
  position: fixed;
  left: 0;
  right: 0;
  top: 0;
  z-index: 20;
  background:#fff;
  border-bottom:1px solid var(--line);
  transform: translateY(0);
  transition: transform .22s ease;
}

/* ìˆ¨ê¹€ ìƒíƒœ */
header.hide{
  transform: translateY(-110%);
}

/* ë³¸ë¬¸ì´ í—¤ë”ì— ê°€ë ¤ì§€ì§€ ì•Šë„ë¡ ì—¬ë°± */
body{
  padding-top: 210px; /* í—¤ë” ë†’ì´ì— ë§ì¶° ì¡°ì •(í•„ìš”ì‹œ 180~240 ì‚¬ì´) */
}

    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35}
    .grid{display:grid; gap:12px}
    .kpis{grid-template-columns: repeat(5, minmax(0, 1fr)); margin-top:14px}
    .card{
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
    }
    .k{color:var(--muted);font-size:12px}
    .v{margin-top:8px;font-size:18px;font-weight:900}
    .tiny{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.35}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .tab{
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:900; font-size:12px;
    }
    .tab.active{background:var(--soft); color:var(--text)}
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted); font-size:12px;
      flex-wrap:wrap;
    }
    .legendDot{
      display:inline-block;
      width:10px;height:10px;border-radius:999px;
      border:1px solid rgba(0,0,0,.08);
      transform: translateY(1px);
    }
    .dotBill{background:var(--bill)}
    .dotPlanner{background:var(--planner)}
    .dotForecast{background:var(--forecast)}

    /* í‘œ ë˜í¼ */
    .tableWrap{
  margin-top:10px;
  border-radius:12px;
  border:1px solid var(--line);
  overflow:auto;
  max-height:560px;
  background:#fff;
  -webkit-overflow-scrolling: touch;
}


    /* âœ… ì •ë ¬ ê¹¨ì§ ë°©ì§€ í•µì‹¬: table-layout:fixed + colgroup + ì»¬ëŸ¼ë³„ ì •ë ¬ì„ nth-childë¡œ ê³ ì • */
    table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      background:#fff;
    }

    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      line-height:1.2;
      vertical-align:middle;
      background:#fff;
      color:var(--text);

      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;

      /* ê¸°ë³¸ ì •ë ¬ì€ ì™¼ìª½ìœ¼ë¡œ ë‘ê³ , ì•„ë˜ nth-childì—ì„œ ì»¬ëŸ¼ë³„ë¡œ í™•ì • */
      text-align:left;
    }

    thead th{
      position:sticky; top:0; z-index:5;
      background:var(--soft);
      color:#111;
      font-weight:900;
    }

    /* âœ… ì»¬ëŸ¼ë³„ ì •ë ¬(í—¤ë”/ë°”ë”” ë™ì‹œì— ì ìš©) */
    .energyTable th:nth-child(1), .energyTable td:nth-child(1){ text-align:center; }
    .energyTable th:nth-child(2), .energyTable td:nth-child(2){ text-align:center; } /* ì „ê¸° */
    .energyTable th:nth-child(3), .energyTable td:nth-child(3){ text-align:center; } /* ì—´ */
    .energyTable th:nth-child(4), .energyTable td:nth-child(4){ text-align:right; }  /* ì›” TOE */
    .energyTable th:nth-child(5), .energyTable td:nth-child(5){ text-align:right; }  /* ëˆ„ê³„ TOE */

    tr:hover td{ background:#fafafa; }

    /* ê°’ ìƒ‰ */
    .src-bill{ color:var(--bill); font-weight:900; }
    .src-planner{ color:var(--planner); font-weight:900; }
    .src-forecast{ color:var(--forecast); font-weight:900; }

    /* í´ë¦­ í‘œì‹œ */
    td.editable{
      cursor:pointer;
      text-decoration: underline;
      text-decoration-color: rgba(0,0,0,.2);
      text-underline-offset: 3px;
    }

    /* ëª¨ë‹¬ */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.25);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100;
      padding:16px;
    }
    .modal{
      width:min(620px, 100%);
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.18);
    }
    .modal h2{margin:0 0 10px 0; font-size:16px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input, select{
      width:100%; padding:10px 11px; border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      outline:none;
    }
    .modalGrid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .modalActions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
    button{
      border:1px solid var(--line);
      background:#fff; color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer;
      font-weight:900;
    }
    button:hover{background:var(--soft)}
    .danger{border-color:#fecaca; color:#991b1b}
    .coach{
      margin-top:10px; padding:12px; border-radius:12px;
      border:1px dashed var(--line);
      background:var(--soft);
      color:var(--muted); font-size:13px; line-height:1.6;
      white-space:normal;
    }
    .split{display:grid; grid-template-columns: 1.2fr .8fr; gap:12px}
    @media (max-width: 980px){
      .kpis{grid-template-columns: repeat(2, minmax(0, 1fr));}
      .split{grid-template-columns:1fr;}
      .tableWrap{max-height:500px;}
    }
    @media (max-width: 900px){
  table.energyTable th,
  table.energyTable td{
    padding:8px 6px;
    font-size:12px;
  }
}

@media (max-width: 600px){
  table.energyTable th,
  table.energyTable td{
    padding:6px 4px;
    font-size:11px;
  }
}

  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Energy Insights</h1>
    <div class="sub">
      í° ë°°ê²½/ê²€ì€ ê¸€ì”¨ Â· ë³¸ì‚¬(ì „ê¸°+ì—´)ë§Œ í‰ê°€ Â· ëª©í‘œ ì ˆê°ë¥  1% ê³ ì •<br/>
      í™˜ì‚°ê³„ìˆ˜: ì „ê¸°(MWh)Ã—0.229 + ì—´(Gcal)Ã—0.1 = TOE
    </div>

    <div class="grid kpis">
      <div class="card">
        <div class="k">ê¸°ì¤€(20~22 í‰ê· )</div>
        <div class="v" id="kpiBaseline">-</div>
        <div class="tiny">toe</div>
      </div>
      <div class="card">
        <div class="k">ë§Œì  ëª©í‘œ(âˆ’1%)</div>
        <div class="v" id="kpiTarget">-</div>
        <div class="tiny">toe ì´í•˜</div>
      </div>
      <div class="card">
        <div class="k">2026 ì˜ˆìƒ ì—°ê°„</div>
        <div class="v" id="kpiEstToe">-</div>
        <div class="tiny">toe (ì‹¤ì +ì˜ˆìƒ)</div>
      </div>
      <div class="card">
        <div class="k">ìµœì¢… ì ˆê°ë¥ (ì—°ë§ ì˜ˆìƒ)</div>
        <div class="v" id="kpiSaving">-</div>
        <div class="tiny">%</div>
      </div>
      <div class="card">
        <div class="k">íŒì •(ë§Œì )</div>
        <div class="v" id="kpiPass">-</div>
        <div class="tiny">â‰¥ 1.00%</div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tab2026">2026</div>
      <div class="tab" id="tab2025">2025(ìˆ˜ì • ê°€ëŠ¥)</div>
      <div class="tab" id="tabReport">ë³´ê³ ì„œ</div>
      <div class="pill" style="margin-left:auto"><span id="nowInfo"></span></div>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- 2026 -->
  <section id="sec2026">
    <div class="card">
      <div class="pill">
        <strong>2026 ì›”ë³„(ì „ê¸°/ì—´ ê°’ í´ë¦­í•´ì„œ ìˆ˜ì •)</strong>
        <span class="legendDot dotBill"></span> ê³ ì§€ì„œ(í™•ì •)
        <span class="legendDot dotPlanner"></span> íŒŒì›Œí”Œë˜ë„ˆ
        <span class="legendDot dotForecast"></span> ì˜ˆìƒ
      </div>

      <div class="split" style="margin-top:12px">
        <div>
          <div class="coach" id="detailBox">ì„ íƒ ì›” ìƒì„¸(ë³´ê³ ì„œìš©): ê³„ì‚° ì¤‘â€¦</div>
          <div class="coach" id="coachBox">ë‹¤ìŒ ë‹¬ ê¶Œì¥ ì‚¬ìš©ëŸ‰ì„ ê³„ì‚°í•©ë‹ˆë‹¤â€¦</div>
        </div>
        <div>
          <div class="pill" style="justify-content:space-between;width:100%">
            <span><strong>ì›” ì„ íƒ</strong></span>
            <select id="selMonth" style="max-width:120px"></select>
          </div>
          <div style="margin-top:10px" class="pill">
            <span class="muted">ë¹ ë¥¸ ì…ë ¥(ì„ íƒ ì›”)</span>
            <button id="btnAutoForecast">ì˜ˆìƒ ìë™</button>
            <button id="btnAutoBill">ê³ ì§€ì„œ ìë™</button>
          </div>
          <div style="margin-top:10px" class="pill">
            <button class="danger" id="btnReset2026">2026 ì „ì²´ ì´ˆê¸°í™”</button>
          </div>
        </div>
      </div>

      <div class="tableWrap">
        <table class="energyTable">
          <colgroup>
  <col style="width:60px">        <!-- ì›” -->
  <col style="width:20%">         <!-- ì „ê¸° -->
  <col style="width:20%">         <!-- ì—´ -->
  <col style="width:20%">         <!-- ì›” TOE -->
  <col style="width:20%">         <!-- ëˆ„ê³„ TOE -->
</colgroup>
          <thead>
            <tr>
              <th>ì›”</th>
              <th>ì „ê¸°(MWh)</th>
              <th>ì—´(Gcal)</th>
              <th>ì›” TOE</th>
              <th>ëˆ„ê³„ TOE</th>
            </tr>
          </thead>
          <tbody id="tbody2026"></tbody>
        </table>
      </div>

      <div class="tiny" style="margin-top:10px">
        â€» â€œì›”/ì „ê¸°/ì—´/ì›” TOE/ëˆ„ê³„ TOEâ€ ì •ë ¬ì„ ì»¬ëŸ¼ë³„ë¡œ ê³ ì •í•´ì„œ 2025/2026 ëª¨ë‘ ì¤„ì´ ì •í™•íˆ ë§ìŠµë‹ˆë‹¤.
      </div>
    </div>
  </section>

  <!-- 2025 -->
  <section id="sec2025" style="display:none">
    <div class="card">
      <div class="pill">
        <strong>2025 ë³¸ì‚¬ ì‹¤ì (ìˆ˜ì • ê°€ëŠ¥)</strong>
        <span class="muted">Â· 12ì›” ì „ê¸° ê³ ì§€ì„œ ê°’ì´ ë‚˜ì˜¤ë©´ ì—¬ê¸°ì„œ ìˆ˜ì •(í´ë¦­)í•˜ì„¸ìš”.</span>
      </div>

      <div class="split" style="margin-top:12px">
        <div class="coach">
          <div style="color:#111;font-weight:900;margin-bottom:8px">2025 ì—°ê°„ ìš”ì•½</div>
          <div id="box2025sum"></div>
        </div>
        <div class="coach">
          <div style="color:#111;font-weight:900;margin-bottom:8px">ì‚¬ìš© ë°©ì‹</div>
           <div style="margin:0; padding:0">
            - 2026ì—ì„œ ê°’ì´ ë¹„ì–´ìˆëŠ” ë‹¬ì€ 2025 ë™ì¼ì›” ê°’ìœ¼ë¡œ ìë™ â€œì˜ˆìƒâ€ ì²˜ë¦¬ë©ë‹ˆë‹¤.<br/>
            - ë”°ë¼ì„œ <b>2025(íŠ¹íˆ 12ì›” ì „ê¸°)</b> ê°’ì´ ì •í™•í•´ì•¼ 2026 ëª©í‘œ/ì˜ˆì¸¡ì´ ì •í™•í•©ë‹ˆë‹¤.
          </div>
        </div>
      </div>

      <div class="tableWrap">
        <table class="energyTable">
          <colgroup>
  <col style="width:60px">   <!-- ì›” -->
  <col style="width:20%">    <!-- ì „ê¸° -->
  <col style="width:20%">    <!-- ì—´ -->
  <col style="width:20%">    <!-- ì›” TOE -->
  <col style="width:20%">    <!-- ëˆ„ê³„ TOE -->
</colgroup>
          <thead>
            <tr>
              <th>ì›”</th>
              <th>ì „ê¸°(MWh)</th>
              <th>ì—´(Gcal)</th>
              <th>ì›” TOE</th>
              <th>ëˆ„ê³„ TOE</th>
            </tr>
          </thead>
          <tbody id="tbody2025"></tbody>
        </table>
      </div>

      <div style="margin-top:10px" class="pill">
        <button class="danger" id="btnReset2025">2025 ë°ì´í„°ë¥¼ ì´ˆê¸°ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°</button>
      </div>
    </div>
  </section>

  <!-- Report -->
  <section id="secReport" style="display:none">
    <div class="card">
      <div class="pill"><strong>ë³´ê³ ì„œ</strong></div>
      <div class="split" style="margin-top:12px">
        <div class="coach" id="reportSummary">ìš”ì•½ ê³„ì‚° ì¤‘â€¦</div>
        <div class="coach">
          <div style="color:#111;font-weight:900;margin-bottom:8px">ë‚´ë³´ë‚´ê¸°</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <button id="btnExportCSV">2026 CSV ë³´ê¸°</button>
            <button id="btnExportJSON">2026 JSON ë³´ê¸°</button>
          </div>
          <pre id="exportBox" style="display:none;margin-top:10px;white-space:pre-wrap;background:#fff;border:1px solid var(--line);padding:10px;border-radius:12px;color:#111;font-size:12px"></pre>
        </div>
      </div>
    </div>
  </section>

</main>

<!-- modal -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <h2 id="modalTitle">ê°’ ìˆ˜ì •</h2>

    <div class="modalGrid">
      <div>
        <label>ì¶œì²˜(ìƒ‰ìƒ)</label>
        <select id="modalSource">
          <option value="bill">ê³ ì§€ì„œ(í™•ì •) - ë¹¨ê°•</option>
          <option value="planner">íŒŒì›Œí”Œë˜ë„ˆ - ì´ˆë¡</option>
          <option value="forecast">ì˜ˆìƒ - íŒŒë‘</option>
        </select>
      </div>
      <div>
        <label>ê°’</label>
        <input id="modalValue" type="number" step="0.001" />
      </div>
    </div>

    <div style="margin-top:10px">
      <label>ë©”ëª¨(ì„ íƒ)</label>
      <input id="modalMemo" type="text" placeholder="ì˜ˆ: 12ì›” ê³ ì§€ì„œ í™•ì • ë°˜ì˜" />
    </div>

    <div class="modalActions">
      <button id="modalCancel">ì·¨ì†Œ</button>
      <button id="modalDelete" class="danger">ì´ ê°’ ì§€ìš°ê¸°</button>
      <button id="modalSave">ì €ì¥</button>
    </div>

    <div class="tiny" style="margin-top:10px">
      - 2025/2026 ëª¨ë‘ í‘œì˜ ì „ê¸°/ì—´ ê°’ì„ í´ë¦­í•´ì„œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.
    </div>
  </div>
</div>

<script>
/* ===== ê³ ì •ê°’ ===== */
const BASELINE_TOE = 1065.772;
const TARGET_TOE   = BASELINE_TOE * 0.99;
const F_ELEC = 0.229;
const F_HEAT = 0.1;

const Y2025_DEFAULT = {
  elec: [305.129,301.270,300.671,279.930,297.870,331.899,399.850,399.668,383.314,316.183,298.696,300.766],
  heat: [ 85.1, 104.8,  49.8,  15.7,  41.0, 109.4, 188.2, 179.5, 158.0,  34.2,  25.3,  59.6]
};

function toeOfMonth(e, h){ return (e||0)*F_ELEC + (h||0)*F_HEAT; }

const LS_2026 = "energy_insights_2026_v6";
const LS_2025 = "energy_insights_2025_v1";

const el = (id)=>document.getElementById(id);
function fmt(n, digits=3){
  if(n===null || n===undefined || Number.isNaN(n)) return "-";
  return Number(n).toLocaleString("en-US",{minimumFractionDigits:digits, maximumFractionDigits:digits});
}
const fmt3=(n)=>fmt(n,3);
const fmt2=(n)=>fmt(n,2);
const fmt1=(n)=>fmt(n,1);
function fmtPct(n){ if(n==null||Number.isNaN(n)) return "-"; return Number(n).toFixed(2); }
function srcClass(src){
  if(src==="bill") return "src-bill";
  if(src==="planner") return "src-planner";
  if(src==="forecast") return "src-forecast";
  return "";
}
function srcLabel(src){
  if(src==="bill") return "ê³ ì§€ì„œ";
  if(src==="planner") return "íŒŒì›Œí”Œë˜ë„ˆ";
  if(src==="forecast") return "ì˜ˆìƒ";
  return "ìë™";
}

/* ===== 2025 ===== */
function default2025(){
  return Array.from({length:12}, (_,i)=>({
    m:i+1,
    elec:{ source:"bill", value:Y2025_DEFAULT.elec[i] },
    heat:{ source:"bill", value:Y2025_DEFAULT.heat[i] },
    memo:""
  }));
}
function load2025(){
  const raw = localStorage.getItem(LS_2025);
  if(!raw) return default2025();
  try{
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr) || arr.length!==12) return default2025();
    return arr.map((x,i)=>({
      m:i+1,
      elec:{
        source: (x?.elec?.source==="bill"||x?.elec?.source==="planner"||x?.elec?.source==="forecast") ? x.elec.source : "bill",
        value: (x?.elec?.value==null||x.elec.value==="") ? null : Number(x.elec.value)
      },
      heat:{
        source: (x?.heat?.source==="bill"||x?.heat?.source==="planner"||x?.heat?.source==="forecast") ? x.heat.source : "bill",
        value: (x?.heat?.value==null||x.heat.value==="") ? null : Number(x.heat.value)
      },
      memo: (x?.memo==null) ? "" : String(x.memo)
    }));
  }catch(e){
    return default2025();
  }
}
function save2025(d){ localStorage.setItem(LS_2025, JSON.stringify(d)); }
function getY2025Arrays(){
  const d = load2025();
  const elec = d.map(r=> (r.elec.value==null ? 0 : r.elec.value));
  const heat = d.map(r=> (r.heat.value==null ? 0 : r.heat.value));
  const toe  = d.map((_,i)=> toeOfMonth(elec[i], heat[i]));
  return { d, elec, heat, toe };
}

/* ===== 2026 ===== */
function default2026(){
  return Array.from({length:12}, (_,i)=>({
    m:i+1,
    elec:{ source:null, value:null },
    heat:{ source:null, value:null },
    memo:""
  }));
}
function load2026(){
  const raw = localStorage.getItem(LS_2026);
  if(!raw) return default2026();
  try{
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr) || arr.length!==12) return default2026();
    return arr.map((x,i)=>({
      m:i+1,
      elec:{
        source: (x?.elec?.source==="bill"||x?.elec?.source==="planner"||x?.elec?.source==="forecast") ? x.elec.source : null,
        value: (x?.elec?.value==null||x.elec.value==="") ? null : Number(x.elec.value)
      },
      heat:{
        source: (x?.heat?.source==="bill"||x?.heat?.source==="planner"||x?.heat?.source==="forecast") ? x.heat.source : null,
        value: (x?.heat?.value==null||x.heat.value==="") ? null : Number(x.heat.value)
      },
      memo: (x?.memo==null) ? "" : String(x.memo)
    }));
  }catch(e){
    return default2026();
  }
}
function save2026(d){ localStorage.setItem(LS_2026, JSON.stringify(d)); }

function pickElec2026(d2026, i, y25e){
  const v = d2026[i].elec.value;
  if(v!=null) return { value:v, source:(d2026[i].elec.source||"forecast"), isAuto:false };
  return { value:y25e[i], source:"forecast", isAuto:true };
}
function pickHeat2026(d2026, i, y25h){
  const v = d2026[i].heat.value;
  if(v!=null) return { value:v, source:(d2026[i].heat.source||"forecast"), isAuto:false };
  return { value:y25h[i], source:"forecast", isAuto:true };
}

function compute2026(){
  const d2026 = load2026();
  const { elec:y25e, heat:y25h, toe:y25toe } = getY2025Arrays();

  const rows = d2026.map((r,i)=>{
    const e = pickElec2026(d2026,i,y25e);
    const h = pickHeat2026(d2026,i,y25h);
    const toe = toeOfMonth(e.value, h.value);
    return { m:r.m, elec:e, heat:h, toe, memo:r.memo||"" };
  });

  let cum=0;
  const withCum = rows.map(r=>{ cum+=r.toe; return {...r, cum_toe:cum}; });
  const annualToeEst = withCum.reduce((s,r)=>s+r.toe,0);
  const savingPctFinal = (BASELINE_TOE - annualToeEst) / BASELINE_TOE * 100;
  return { withCum, annualToeEst, savingPctFinal, y25toe };
}

function detailForMonth2026(m){
  const d2026 = load2026();
  const { elec:y25e, heat:y25h, toe:y25toe } = getY2025Arrays();
  const i=m-1;
  const e = pickElec2026(d2026,i,y25e);
  const h = pickHeat2026(d2026,i,y25h);
  const toe = toeOfMonth(e.value,h.value);

  const refElec=y25e[i], refHeat=y25h[i], refToe=y25toe[i];
  const dElec=(e.value-refElec)/refElec*100;
  const dHeat=(h.value-refHeat)/refHeat*100;
  const dToe =(toe-refToe)/refToe*100;

  return `ğŸ§¾ ${m}ì›” ìƒì„¸(2026)\n`+
         `- ì „ê¸°: ${fmt3(e.value)} MWh (${srcLabel(e.source)})\n`+
         `- ì—´  : ${fmt1(h.value)} Gcal (${srcLabel(h.source)})\n`+
         `- ì›” TOE: ${fmt2(toe)} toe\n\n`+
         `ğŸ“Œ ì „ë…„(2025) ë™ì›” ëŒ€ë¹„\n`+
         `- ì „ê¸°: ${fmt3(refElec)} â†’ ${fmt3(e.value)} (${dElec>=0?"+":""}${dElec.toFixed(1)}%)\n`+
         `- ì—´  : ${fmt1(refHeat)} â†’ ${fmt1(h.value)} (${dHeat>=0?"+":""}${dHeat.toFixed(1)}%)\n`+
         `- TOE : ${fmt2(refToe)} â†’ ${fmt2(toe)} (${dToe>=0?"+":""}${dToe.toFixed(1)}%)`;
}

function coachNextMonth(selectedMonth){
  const d2026 = load2026();
  const { elec:y25e, heat:y25h, toe:y25toe } = getY2025Arrays();
  const calc = compute2026();

  const isLockedBill = (m)=>{
    const i=m-1;
    const eOk = d2026[i].elec.source==="bill" && d2026[i].elec.value!=null;
    const hOk = d2026[i].heat.source==="bill" && d2026[i].heat.value!=null;
    return eOk && hOk;
  };

  const lockedToe = calc.withCum.filter(r=>isLockedBill(r.m)).reduce((s,r)=>s+r.toe,0);
  const budgetRemain = TARGET_TOE - lockedToe;
  if(budgetRemain < 0){
    return `âš ï¸ ê³ ì§€ì„œ(í™•ì •) ê°’ë§Œìœ¼ë¡œ ëª©í‘œë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.\n- í™•ì • í•©ê³„: ${fmt2(lockedToe)} toe\n- ëª©í‘œ: ${fmt2(TARGET_TOE)} toe`;
  }

  const nextM = selectedMonth<12 ? selectedMonth+1 : null;
  if(!nextM) return `12ì›”ì…ë‹ˆë‹¤. ì˜¬í•´ ë°ì´í„° í™•ì •/ì ê²€ë§Œ í•˜ì‹œë©´ ë©ë‹ˆë‹¤.`;

  const unlockedMonths = Array.from({length:12},(_,i)=>i+1).filter(m=>!isLockedBill(m));
  const sumW = unlockedMonths.reduce((s,m)=>s+y25toe[m-1],0);
  const wNext = (sumW>0) ? (y25toe[nextM-1]/sumW) : (1/unlockedMonths.length);

  const toeGoalNext = budgetRemain * wNext;

  const h = pickHeat2026(d2026, nextM-1, y25h);
  const heatToe = h.value * F_HEAT;

  const elecToeGoal = Math.max(0, toeGoalNext - heatToe);
  const elecMWhGoal = elecToeGoal / F_ELEC;

  const refElec = y25e[nextM-1];
  const deltaPct = (elecMWhGoal - refElec) / refElec * 100;

  return `ğŸ“Œ ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•œ ë‹¤ìŒ ë‹¬(${nextM}ì›”) ê¶Œì¥ ì „ê¸° ìƒí•œ\n`+
         `- ì—´(ì‚¬ìš©): ${fmt1(h.value)} Gcal (${srcLabel(h.source)})\n`+
         `- ì „ê¸°(ê¶Œì¥): ${fmt3(elecMWhGoal)} MWh ì´í•˜\n`+
         `- ì°¸ê³ : 2025ë…„ ${nextM}ì›” ì „ê¸° ${fmt3(refElec)} MWh ëŒ€ë¹„ ${deltaPct>=0?"+":""}${deltaPct.toFixed(1)}%`;
}

/* ===== KPIs ===== */
function renderKPIs(){
  el("kpiBaseline").textContent = fmt3(BASELINE_TOE);
  el("kpiTarget").textContent   = fmt3(TARGET_TOE);
  const calc = compute2026();
  el("kpiEstToe").textContent = fmt2(calc.annualToeEst);
  el("kpiSaving").textContent = `${fmtPct(calc.savingPctFinal)}%`;
  el("kpiPass").textContent = (calc.savingPctFinal>=1.0) ? "PASS" : "FAIL";
}

/* ===== render 2026 ===== */
function render2026(){
  renderKPIs();
  const mSel = Number(el("selMonth").value || 1);
  el("detailBox").textContent = detailForMonth2026(mSel);
  el("coachBox").textContent  = coachNextMonth(mSel);

  const tbody = el("tbody2026");
  tbody.innerHTML="";
  const calc = compute2026();

  calc.withCum.forEach(r=>{
    const eCls = srcClass(r.elec.source);
    const hCls = srcClass(r.heat.source);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.m}</td>
      <td class="editable ${eCls}" data-scope="2026" data-field="elec" data-month="${r.m}" title="í´ë¦­í•´ì„œ ìˆ˜ì •">${fmt3(r.elec.value)}</td>
      <td class="editable ${hCls}" data-scope="2026" data-field="heat" data-month="${r.m}" title="í´ë¦­í•´ì„œ ìˆ˜ì •">${fmt1(r.heat.value)}</td>
      <td>${fmt2(r.toe)}</td>
      <td>${fmt2(r.cum_toe)}</td>
    `;
    tbody.appendChild(tr);
  });

  const pass = calc.savingPctFinal>=1.0;
  el("reportSummary").textContent =
    `ğŸ“„ 2026 ìš”ì•½(í˜„ì¬ ì…ë ¥ ê¸°ì¤€)\n`+
    `- ê¸°ì¤€(20~22 í‰ê· ): ${fmt3(BASELINE_TOE)} toe\n`+
    `- ë§Œì  ëª©í‘œ(âˆ’1%): ${fmt3(TARGET_TOE)} toe ì´í•˜\n`+
    `- 2026 ì˜ˆìƒ ì—°ê°„: ${fmt2(calc.annualToeEst)} toe\n`+
    `- ìµœì¢… ì ˆê°ë¥ (ì—°ë§ ì˜ˆìƒ): ${fmtPct(calc.savingPctFinal)}%\n`+
    `- íŒì •: ${pass?"PASS":"FAIL"}`;
}

/* ===== render 2025 ===== */
function render2025(){
  const { d, toe } = getY2025Arrays();
  const tbody = el("tbody2025");
  tbody.innerHTML="";

  let cum=0;
  for(let i=0;i<12;i++){
    const r=d[i];
    const eCls = srcClass(r.elec.source);
    const hCls = srcClass(r.heat.source);
    const monthToe = toe[i];
    cum += monthToe;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td class="editable ${eCls}" data-scope="2025" data-field="elec" data-month="${i+1}" title="í´ë¦­í•´ì„œ ìˆ˜ì •">${fmt3(r.elec.value)}</td>
      <td class="editable ${hCls}" data-scope="2025" data-field="heat" data-month="${i+1}" title="í´ë¦­í•´ì„œ ìˆ˜ì •">${fmt1(r.heat.value)}</td>
      <td>${fmt2(monthToe)}</td>
      <td>${fmt2(cum)}</td>
    `;
    tbody.appendChild(tr);
  }

  const sumElec = d.reduce((s,r)=>s+(r.elec.value||0),0);
  const sumHeat = d.reduce((s,r)=>s+(r.heat.value||0),0);
  const sumToe  = toe.reduce((s,x)=>s+x,0);
  const savingPct=(BASELINE_TOE - sumToe)/BASELINE_TOE*100;

  el("box2025sum").innerHTML =
    `- ì „ê¸° í•©ê³„: <b>${fmt3(sumElec)}</b> MWh<br/>`+
    `- ì—´ í•©ê³„: <b>${fmt1(sumHeat)}</b> Gcal<br/>`+
    `- ì—°ê°„ TOE: <b>${fmt2(sumToe)}</b> toe<br/>`+
    `- ê¸°ì¤€ ëŒ€ë¹„ ì ˆê°ë¥ (ì°¸ê³ ): <b>${fmtPct(savingPct)}%</b><br/>`+
    `<span style="color:#666">â€» 2026 ìë™ì˜ˆì¸¡ì— ì´ ê°’ì´ ê·¸ëŒ€ë¡œ ì“°ì…ë‹ˆë‹¤.</span>`;
}

/* ===== modal ===== */
let modalState = { scope:null, month:null, field:null };
function openModal(scope, month, field){
  modalState = { scope, month, field };
  const data = (scope==="2025") ? load2025() : load2026();
  const i = month-1;
  const slot = (field==="elec") ? data[i].elec : data[i].heat;
  const unit = (field==="elec") ? "MWh" : "Gcal";

  el("modalTitle").textContent = `${scope} ${month}ì›” ${field==="elec"?"ì „ê¸°":"ì—´"}(${unit}) ìˆ˜ì •`;
  el("modalSource").value = slot.source || (scope==="2025" ? "bill" : "forecast");
  el("modalValue").value  = (slot.value==null) ? "" : slot.value;
  el("modalMemo").value   = data[i].memo || "";

  el("modalBack").style.display = "flex";
}
function closeModal(){ el("modalBack").style.display = "none"; }
function load2025(){ return JSON.parse(localStorage.getItem(LS_2025) || "null") || default2025(); }
function load2026(){ return JSON.parse(localStorage.getItem(LS_2026) || "null") || default2026(); }

function saveModal(){
  const {scope, month, field} = modalState;
  const data = (scope==="2025") ? load2025() : load2026();
  const i = month-1;

  const src = el("modalSource").value;
  const valStr = el("modalValue").value.trim();
  const val = (valStr==="") ? null : Number(valStr);
  const memo = el("modalMemo").value;

  if(field==="elec"){ data[i].elec.source=src; data[i].elec.value=val; }
  else{ data[i].heat.source=src; data[i].heat.value=val; }
  data[i].memo = memo || "";

  if(scope==="2025") save2025(data); else save2026(data);
  closeModal();
  render2025();
  render2026();
}
function deleteModalValue(){
  const {scope, month, field} = modalState;
  const data = (scope==="2025") ? load2025() : load2026();
  const i = month-1;

  if(field==="elec"){ data[i].elec.source=null; data[i].elec.value=null; }
  else{ data[i].heat.source=null; data[i].heat.value=null; }

  if(scope==="2025") save2025(data); else save2026(data);
  closeModal();
  render2025();
  render2026();
}

/* ===== export ===== */
function export2026CSV(){
  const d2026 = load2026();
  const { elec:y25e, heat:y25h } = getY2025Arrays();
  const calc = compute2026();

  const lines=[];
  lines.push("year,month,elec_source,elec_input_mwh,elec_used_mwh,heat_source,heat_input_gcal,heat_used_gcal,month_toe,cum_toe,memo");
  calc.withCum.forEach(r=>{
    const i=r.m-1;
    const raw=d2026[i];
    const esc = (s)=> `"${String(s??"").replaceAll('"','""')}"`;
    lines.push([
      "2026", r.m,
      (raw.elec.source||""), (raw.elec.value==null?"":raw.elec.value), r.elec.value,
      (raw.heat.source||""), (raw.heat.value==null?"":raw.heat.value), r.heat.value,
      r.toe, r.cum_toe, esc(raw.memo||"")
    ].join(","));
  });
  return lines.join("\n");
}
function export2026JSON(){
  return JSON.stringify({
    year:2026,
    baseline_toe:BASELINE_TOE,
    target_toe:TARGET_TOE,
    factors:{ elec_toe_per_mwh:F_ELEC, heat_toe_per_gcal:F_HEAT },
    y2025: load2025(),
    y2026: load2026()
  }, null, 2);
}

/* ===== tabs ===== */
function setTab(which){
  const t2026=el("tab2026"), t2025=el("tab2025"), tRep=el("tabReport");
  const s2026=el("sec2026"), s2025=el("sec2025"), sRep=el("secReport");

  [t2026,t2025,tRep].forEach(x=>x.classList.remove("active"));
  [s2026,s2025,sRep].forEach(x=>x.style.display="none");

  if(which==="2026"){ t2026.classList.add("active"); s2026.style.display="block"; }
  if(which==="2025"){ t2025.classList.add("active"); s2025.style.display="block"; }
  if(which==="report"){ tRep.classList.add("active"); sRep.style.display="block"; }
}

/* ===== init ===== */
function init(){
  const now = new Date();
  el("nowInfo").textContent = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}`;

  const sel = el("selMonth");
  for(let m=1;m<=12;m++){
    const opt = document.createElement("option");
    opt.value=m; opt.textContent=`${m}ì›”`;
    sel.appendChild(opt);
  }
  sel.value = String(new Date().getMonth()+1);
  sel.addEventListener("change", render2026);

  el("btnAutoForecast").addEventListener("click", ()=>{
    const d2026 = load2026();
    const { elec:y25e, heat:y25h } = getY2025Arrays();
    const m = Number(sel.value);
    const i = m-1;
    d2026[i].elec.source="forecast"; d2026[i].elec.value=y25e[i];
    d2026[i].heat.source="forecast"; d2026[i].heat.value=y25h[i];
    save2026(d2026);
    render2026();
  });
  el("btnAutoBill").addEventListener("click", ()=>{
    const d2026 = load2026();
    const { elec:y25e, heat:y25h } = getY2025Arrays();
    const m = Number(sel.value);
    const i = m-1;
    d2026[i].elec.source="bill"; d2026[i].elec.value=y25e[i];
    d2026[i].heat.source="bill"; d2026[i].heat.value=y25h[i];
    save2026(d2026);
    render2026();
  });

  el("btnReset2026").addEventListener("click", ()=>{
    if(!confirm("2026 ë°ì´í„°ë¥¼ ì „ë¶€ ì§€ìš¸ê¹Œìš”?")) return;
    localStorage.removeItem(LS_2026);
    render2026();
  });
  el("btnReset2025").addEventListener("click", ()=>{
    if(!confirm("2025 ë°ì´í„°ë¥¼ ì´ˆê¸°ê°’ìœ¼ë¡œ ë˜ëŒë¦´ê¹Œìš”?")) return;
    localStorage.removeItem(LS_2025);
    render2025();
    render2026();
  });

  el("tab2026").addEventListener("click", ()=>setTab("2026"));
  el("tab2025").addEventListener("click", ()=>setTab("2025"));
  el("tabReport").addEventListener("click", ()=>setTab("report"));

  el("btnExportCSV").addEventListener("click", ()=>{
    const box = el("exportBox");
    box.style.display="block";
    box.textContent = export2026CSV();
  });
  el("btnExportJSON").addEventListener("click", ()=>{
    const box = el("exportBox");
    box.style.display="block";
    box.textContent = export2026JSON();
  });

  // modal
  el("modalCancel").addEventListener("click", closeModal);
  el("modalBack").addEventListener("click", (e)=>{ if(e.target.id==="modalBack") closeModal(); });
  el("modalSave").addEventListener("click", saveModal);
  el("modalDelete").addEventListener("click", ()=>{
    if(!confirm("ì´ ê°’ë§Œ ì§€ìš¸ê¹Œìš”?")) return;
    deleteModalValue();
  });

  // í´ë¦­ ìˆ˜ì • (2025/2026 ë‘˜ ë‹¤)
  el("tbody2026").addEventListener("click", (e)=>{
    const cell = e.target.closest("td.editable");
    if(!cell) return;
    openModal(cell.dataset.scope, Number(cell.dataset.month), cell.dataset.field);
  });
  el("tbody2025").addEventListener("click", (e)=>{
    const cell = e.target.closest("td.editable");
    if(!cell) return;
    openModal(cell.dataset.scope, Number(cell.dataset.month), cell.dataset.field);
  });

  render2025();
  render2026();
  setTab("2026");
}

(function autoHideHeader(){
  const header = document.querySelector("header");
  let lastY = window.scrollY;
  const threshold = 8; // ì‘ì€ í”ë“¤ë¦¼ ë°©ì§€

  window.addEventListener("scroll", () => {
    const y = window.scrollY;
    const delta = y - lastY;

    // ë§¨ ìœ„ ê·¼ì²˜ì—ì„œëŠ” í•­ìƒ ë³´ì´ê¸°
    if (y < 10){
      header.classList.remove("hide");
      lastY = y;
      return;
    }

    if (delta > threshold){
      // ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤ -> ìˆ¨ê¹€
      header.classList.add("hide");
      lastY = y;
      return;
    }

    if (delta < -threshold){
      // ìœ„ë¡œ ìŠ¤í¬ë¡¤ -> í‘œì‹œ
      header.classList.remove("hide");
      lastY = y;
      return;
    }
  }, { passive:true });
})();


init();
</script>
</body>
</html>
