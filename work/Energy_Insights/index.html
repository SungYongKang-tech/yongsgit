<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Energy Insights</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#111111;
      --muted:#666666;
      --line:#e5e7eb;

      --bill:#dc2626;      /* ê³ ì§€ì„œ(í™•ì •) ë¹¨ê°• */
      --planner:#16a34a;   /* íŒŒì›Œí”Œë˜ë„ˆ ì´ˆë¡ */
      --forecast:#2563eb;  /* ì˜ˆìƒ íŒŒë‘ */

      --card:#ffffff;
      --soft:#f8fafc;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:20;
      background:#fff;
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35}
    .grid{display:grid; gap:12px}
    .kpis{grid-template-columns: repeat(5, minmax(0, 1fr)); margin-top:14px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
    }
    .k{color:var(--muted);font-size:12px}
    .v{margin-top:8px;font-size:18px;font-weight:800}
    .tiny{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.35}
    .row{display:grid; grid-template-columns: 1.05fr 1.95fr; gap:12px; margin-top:12px}

    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input, select, textarea{
      width:100%; padding:10px 11px; border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      outline:none;
    }
    textarea{min-height:64px; resize:vertical}
    .btns{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    button{
      border:1px solid var(--line);
      background:#fff; color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer;
      font-weight:700;
    }
    button:hover{background:var(--soft)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted); font-size:12px;
    }
    .tag{
      display:inline-flex; gap:6px; align-items:center;
      padding:4px 8px; border-radius:999px;
      font-size:12px; border:1px solid var(--line);
      color:var(--muted); background:#fff;
      max-width:100%;
      white-space:nowrap;
    }

    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .tab{
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:800; font-size:12px;
    }
    .tab.active{background:var(--soft); color:var(--text)}
    .split{display:grid; grid-template-columns:1fr 1fr; gap:12px}

    .coach{
      margin-top:10px; padding:12px; border-radius:12px;
      border:1px dashed var(--line);
      background:var(--soft);
      color:var(--muted); font-size:13px; line-height:1.6;
      white-space:pre-wrap;
    }

    /* í‘œ */
    .tableWrap{
      margin-top:10px;
      border-radius:12px;
      border:1px solid var(--line);
      overflow:auto;
      max-height:520px;
      background:#fff;
    }
    .tableWrap table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
    }
    .tableWrap th, .tableWrap td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      text-align:right;
      background:#fff;
      color:var(--text);
    }
    .tableWrap thead th{
      position:sticky;
      top:0;
      z-index:5;
      background:var(--soft);
      color:#111;
      font-weight:900;
    }
    .center{ text-align:center; }
    .tableWrap tr:hover td{ background: #fafafa; }

    /* âœ… ê°’ ìƒíƒœ ì»¬ëŸ¬ */
    .src-bill{ color: var(--bill); font-weight:900; }
    .src-planner{ color: var(--planner); font-weight:900; }
    .src-forecast{ color: var(--forecast); font-weight:900; }

    /* í´ë¦­ ê°€ëŠ¥í•œ ì…€ í‘œì‹œ */
    td.editable{
      cursor:pointer;
      text-decoration: underline;
      text-decoration-color: rgba(0,0,0,.2);
      text-underline-offset: 3px;
    }

    /* ëª¨ë‹¬ */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.25);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100;
      padding:16px;
    }
    .modal{
      width:min(560px, 100%);
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.18);
    }
    .modal h2{margin:0 0 10px 0; font-size:16px}
    .modalGrid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .modalActions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
    .danger{border-color:#fecaca; color:#991b1b}
    .muted{color:var(--muted)}

    @media (max-width: 980px){
      .kpis{grid-template-columns: repeat(2, minmax(0, 1fr));}
      .row{grid-template-columns:1fr}
      .split{grid-template-columns:1fr}
      .tableWrap{max-height:460px;}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Energy Insights</h1>
    <div class="sub">
      í° ë°°ê²½/ê²€ì€ ê¸€ì”¨ Â· ë³¸ì‚¬(ì „ê¸°+ì—´)ë§Œ í‰ê°€ Â· ëª©í‘œ ì ˆê°ë¥  1% ê³ ì •<br/>
      í™˜ì‚°ê³„ìˆ˜: ì „ê¸°(MWh)Ã—0.229 + ì—´(Gcal)Ã—0.1 = TOE
    </div>

    <div class="grid kpis">
      <div class="card">
        <div class="k">ê¸°ì¤€(20~22 í‰ê· )</div>
        <div class="v" id="kpiBaseline">-</div>
        <div class="tiny">toe</div>
      </div>
      <div class="card">
        <div class="k">ë§Œì  ëª©í‘œ(âˆ’1%)</div>
        <div class="v" id="kpiTarget">-</div>
        <div class="tiny">toe ì´í•˜</div>
      </div>
      <div class="card">
        <div class="k">2026 ì˜ˆìƒ ì—°ê°„</div>
        <div class="v" id="kpiEstToe">-</div>
        <div class="tiny">toe (ì‹¤ì +ì˜ˆìƒ)</div>
      </div>
      <div class="card">
        <div class="k">ìµœì¢… ì ˆê°ë¥ (ì—°ë§ ì˜ˆìƒ)</div>
        <div class="v" id="kpiSaving">-</div>
        <div class="tiny">%</div>
      </div>
      <div class="card">
        <div class="k">íŒì •(ë§Œì )</div>
        <div class="v" id="kpiPass">-</div>
        <div class="tiny">â‰¥ 1.00%</div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tab2026">2026</div>
      <div class="tab" id="tab2025">2025(ì°¸ê³ )</div>
      <div class="tab" id="tabReport">ë³´ê³ ì„œ</div>
      <div class="pill" style="margin-left:auto"><span id="nowInfo"></span></div>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- 2026 -->
  <section id="sec2026">
    <div class="row">
      <div class="card">
        <div class="pill">
          <strong>ì…ë ¥</strong>
          <span class="muted">Â· í‘œì˜ ê°’(ì „ê¸°/ì—´/ë©”ëª¨)ì„ í´ë¦­í•´ì„œë„ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>
        </div>

        <div style="margin-top:12px" class="split">
          <div>
            <label>ì›” ì„ íƒ</label>
            <select id="selMonth"></select>
          </div>
          <div>
            <label>ë¹ ë¥¸ ìë™ ì…ë ¥(ì„ íƒ ì›”)</label>
            <div class="btns">
              <button id="btnAutoForecast">ì˜ˆìƒ(2025 ë™ì¼ì›”)</button>
              <button id="btnAutoBill">ê³ ì§€ì„œ(í™•ì •)ë¡œ ì €ì¥</button>
            </div>
          </div>
        </div>

        <div class="coach" id="detailBox">ì„ íƒ ì›” ìƒì„¸(ë³´ê³ ì„œìš©): ê³„ì‚° ì¤‘â€¦</div>
        <div class="coach" id="coachBox">ë‹¤ìŒ ë‹¬ ê¶Œì¥ ì‚¬ìš©ëŸ‰ì„ ê³„ì‚°í•©ë‹ˆë‹¤â€¦</div>

        <div class="btns">
          <button class="danger" id="btnResetAll">2026 ë°ì´í„° ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
      </div>

      <div class="card">
        <div class="pill">
          <span>2026 ì›”ë³„(í´ë¦­ ìˆ˜ì •)</span>
          <span class="tag"><span class="src-bill">â—</span> ê³ ì§€ì„œ(í™•ì •)</span>
          <span class="tag"><span class="src-planner">â—</span> íŒŒì›Œí”Œë˜ë„ˆ</span>
          <span class="tag"><span class="src-forecast">â—</span> ì˜ˆìƒ</span>
        </div>

        <div class="tableWrap">
          <table>
            <colgroup>
              <col style="width:56px">
              <col style="width:110px">
              <col style="width:150px">
              <col style="width:150px">
              <col style="width:120px">
              <col style="width:120px">
            </colgroup>
            <thead>
              <tr>
                <th class="center">ì›”</th>
                <th class="center">êµ¬ë¶„</th>
                <th>ì „ê¸°(MWh)</th>
                <th>ì—´(Gcal)</th>
                <th>ì›” TOE</th>
                <th>ëˆ„ê³„ TOE</th>
              </tr>
            </thead>
            <tbody id="tbody2026"></tbody>
          </table>
        </div>

        <div class="tiny" style="margin-top:10px">
          â€» ì „ê¸°/ì—´ ì…€ì„ í´ë¦­í•˜ë©´ â€œê³ ì§€ì„œ/íŒŒì›Œí”Œë˜ë„ˆ/ì˜ˆìƒâ€ì„ ì„ íƒí•˜ê³  ê°’ì„ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
      </div>
    </div>
  </section>

  <!-- 2025 -->
  <section id="sec2025" style="display:none">
    <div class="card">
      <div class="pill">
        <span>2025 ì‹¤ì (ë³¸ì‚¬, ì°¸ê³ )</span>
        <span class="tag">12ì›” ì „ê¸°=2024ë…„ 12ì›” 300.766 MWh ëŒ€ì²´</span>
        <span class="tag">12ì›” ì—´=ê³ ì§€ì„œ 59.6 Gcal</span>
      </div>

      <div class="split" style="margin-top:12px">
        <div class="coach">
          <div style="color:#111;font-weight:900;margin-bottom:8px">2025 ì—°ê°„ ìš”ì•½</div>
          <div id="box2025sum"></div>
        </div>
        <div class="coach">
          <div style="color:#111;font-weight:900;margin-bottom:8px">ì„¤ëª…</div>
          <div>
            - 2026 ë¯¸ì…ë ¥ ë‹¬ì€ ê¸°ë³¸ì ìœ¼ë¡œ 2025 ë™ì¼ì›” ê°’ìœ¼ë¡œ â€œì˜ˆìƒâ€ ì²˜ë¦¬ë©ë‹ˆë‹¤.<br/>
            - í‘œì—ì„œ í´ë¦­ ì…ë ¥í•˜ë©´ ê·¸ ê°’ì´ ìš°ì„  ì ìš©ë©ë‹ˆë‹¤.
          </div>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <colgroup>
            <col style="width:56px">
            <col style="width:90px">
            <col style="width:110px">
            <col style="width:150px">
            <col style="width:150px">
            <col style="width:120px">
            <col style="width:120px">
          </colgroup>
          <thead>
            <tr>
              <th class="center">ì›”</th>
              <th class="center">ì—°ë„</th>
              <th class="center">êµ¬ë¶„</th>
              <th>ì „ê¸°(MWh)</th>
              <th>ì—´(Gcal)</th>
              <th>ì›” TOE</th>
              <th>ëˆ„ê³„ TOE</th>
            </tr>
          </thead>
          <tbody id="tbody2025"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Report -->
  <section id="secReport" style="display:none">
    <div class="card">
      <div class="pill"><span>ë³´ê³ ì„œ</span></div>

      <div class="split" style="margin-top:12px">
        <div class="coach" id="reportSummary">ìš”ì•½ ê³„ì‚° ì¤‘â€¦</div>
        <div class="coach">
          <div style="color:#111;font-weight:900;margin-bottom:8px">ë‚´ë³´ë‚´ê¸°</div>
          <div class="btns">
            <button id="btnExportCSV">2026 CSV ë³´ê¸°</button>
            <button id="btnExportJSON">2026 JSON ë³´ê¸°</button>
          </div>
          <pre id="exportBox" style="display:none;margin-top:10px;white-space:pre-wrap;background:#fff;border:1px solid var(--line);padding:10px;border-radius:12px;color:#111;font-size:12px"></pre>
        </div>
      </div>
    </div>
  </section>

</main>

<!-- ëª¨ë‹¬: ì…€ í´ë¦­ ìˆ˜ì • -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <h2 id="modalTitle">ê°’ ìˆ˜ì •</h2>
    <div class="modalGrid">
      <div>
        <label>ê°’ ì¢…ë¥˜</label>
        <select id="modalSource">
          <option value="bill">ê³ ì§€ì„œ(í™•ì •)</option>
          <option value="planner">íŒŒì›Œí”Œë˜ë„ˆ</option>
          <option value="forecast">ì˜ˆìƒ</option>
        </select>
      </div>
      <div>
        <label>ê°’</label>
        <input id="modalValue" type="number" step="0.001" />
      </div>
    </div>
    <div style="margin-top:10px">
      <label>ë©”ëª¨(ì„ íƒ)</label>
      <input id="modalMemo" type="text" placeholder="ì˜ˆ: ê³ ì§€ì„œ í™•ì • ë°˜ì˜, íŒŒì›Œí”Œë˜ë„ˆ 1ì°¨ ì˜ˆì¸¡ ë“±" />
    </div>

    <div class="modalActions">
      <button id="modalCancel">ì·¨ì†Œ</button>
      <button id="modalDelete" class="danger">ì´ ê°’ ì§€ìš°ê¸°</button>
      <button id="modalSave">ì €ì¥</button>
    </div>

    <div class="tiny" style="margin-top:10px">
      - ê³ ì§€ì„œ(í™•ì •): <span class="src-bill">ë¹¨ê°•</span> / íŒŒì›Œí”Œë˜ë„ˆ: <span class="src-planner">ì´ˆë¡</span> / ì˜ˆìƒ: <span class="src-forecast">íŒŒë‘</span><br/>
      - ì „ê¸°/ì—´ ê°ê° ë”°ë¡œ ê´€ë¦¬ë©ë‹ˆë‹¤.
    </div>
  </div>
</div>

<script>
/* =========================
   ê³ ì •ê°’
========================= */
const BASELINE_TOE = 1065.772;
const TARGET_TOE   = BASELINE_TOE * 0.99;
const F_ELEC = 0.229;
const F_HEAT = 0.1;

/* =========================
   2025 ë³¸ì‚¬ ë°ì´í„°(ì°¸ê³ /ê¸°ë³¸ì˜ˆì¸¡)
========================= */
const Y2025 = {
  elec: [305.129,301.270,300.671,279.930,297.870,331.899,399.850,399.668,383.314,316.183,298.696,300.766],
  heat: [ 85.1, 104.8,  49.8,  15.7,  41.0, 109.4, 188.2, 179.5, 158.0,  34.2,  25.3,  59.6]
};
function toeOfMonth(elecMWh, heatGcal){
  return (elecMWh||0)*F_ELEC + (heatGcal||0)*F_HEAT;
}
const toe25 = Array.from({length:12}, (_,i)=> toeOfMonth(Y2025.elec[i], Y2025.heat[i]));

/* =========================
   2026 ë°ì´í„° êµ¬ì¡°(ì „ê¸°/ì—´ ê°ê° source+value)
   source: bill | planner | forecast | null
   value: number | null
========================= */
const LS_KEY = "energy_insights_2026_v5";

function default2026(){
  return Array.from({length:12}, (_,i)=>({
    m:i+1,
    elec: { source:null, value:null },
    heat: { source:null, value:null },
    memo:""
  }));
}
function load2026(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw) return default2026();
  try{
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr) || arr.length!==12) return default2026();
    return arr.map((x,i)=>({
      m:i+1,
      elec: {
        source: (x?.elec?.source==="bill"||x?.elec?.source==="planner"||x?.elec?.source==="forecast") ? x.elec.source : null,
        value: (x?.elec?.value==null || x.elec.value==="") ? null : Number(x.elec.value)
      },
      heat: {
        source: (x?.heat?.source==="bill"||x?.heat?.source==="planner"||x?.heat?.source==="forecast") ? x.heat.source : null,
        value: (x?.heat?.value==null || x.heat.value==="") ? null : Number(x.heat.value)
      },
      memo: (x?.memo==null) ? "" : String(x.memo)
    }));
  }catch(e){
    return default2026();
  }
}
function save2026(data){
  localStorage.setItem(LS_KEY, JSON.stringify(data));
}

/* =========================
   helpers
========================= */
const el = (id)=>document.getElementById(id);
function fmt(n, digits=3){
  if(n===null || n===undefined || Number.isNaN(n)) return "-";
  return Number(n).toLocaleString("en-US",{minimumFractionDigits:digits, maximumFractionDigits:digits});
}
const fmt3=(n)=>fmt(n,3);
const fmt2=(n)=>fmt(n,2);
const fmt1=(n)=>fmt(n,1);
function fmtPct(n){
  if(n===null || n===undefined || Number.isNaN(n)) return "-";
  return Number(n).toFixed(2);
}
function srcClass(src){
  if(src==="bill") return "src-bill";
  if(src==="planner") return "src-planner";
  if(src==="forecast") return "src-forecast";
  return "";
}
function srcLabel(src){
  if(src==="bill") return "ê³ ì§€ì„œ";
  if(src==="planner") return "íŒŒì›Œí”Œë˜ë„ˆ";
  if(src==="forecast") return "ì˜ˆìƒ";
  return "ìë™";
}

/* =========================
   ê°’ ê²°ì •(2026 ìš°ì„ , ì—†ìœ¼ë©´ 2025 ë™ì¼ì›” ì˜ˆì¸¡)
========================= */
function pickElec(data, i){
  const v = data[i].elec.value;
  if(v!=null) return { value:v, source:data[i].elec.source || "forecast", isAuto:false };
  return { value:Y2025.elec[i], source:"forecast", isAuto:true };
}
function pickHeat(data, i){
  const v = data[i].heat.value;
  if(v!=null) return { value:v, source:data[i].heat.source || "forecast", isAuto:false };
  return { value:Y2025.heat[i], source:"forecast", isAuto:true };
}

/* =========================
   2026 ê³„ì‚°
========================= */
function compute2026(data){
  const rows = data.map((r,i)=>{
    const e = pickElec(data,i);
    const h = pickHeat(data,i);
    const toe = toeOfMonth(e.value, h.value);
    return {
      m:r.m,
      elec:e, heat:h,
      toe,
      memo:r.memo||""
    };
  });

  let cum=0;
  const withCum = rows.map(r=>{ cum+=r.toe; return {...r, cum_toe:cum}; });
  const annualToeEst = withCum.reduce((s,r)=>s+r.toe,0);
  const savingPctFinal = (BASELINE_TOE - annualToeEst) / BASELINE_TOE * 100;
  return { withCum, annualToeEst, savingPctFinal };
}

/* =========================
   ì½”ì¹˜(ê°„ë‹¨): ë‹¤ìŒë‹¬ ê¶Œì¥ ì „ê¸° ìƒí•œ
   - í™•ì •(bill) ê°’ì€ ì ê¸ˆìœ¼ë¡œ ë³´ê³ 
   - ë‚˜ë¨¸ì§€ëŠ” ëª©í‘œ ë¹„ìœ¨ë¡œ ë¶„ë°°
========================= */
function coachNextMonth(data, selectedMonth){
  const calc = compute2026(data);
  const used = calc.withCum;

  const isLockedBill = (r)=> (data[r.m-1].elec.source==="bill" && data[r.m-1].elec.value!=null) &&
                            (data[r.m-1].heat.source==="bill" && data[r.m-1].heat.value!=null);

  const locked = used.filter(isLockedBill);
  const toeLocked = locked.reduce((s,r)=>s+r.toe,0);

  const budgetRemain = TARGET_TOE - toeLocked;
  if(budgetRemain < 0){
    return `âš ï¸ ê³ ì§€ì„œ(í™•ì •)ë¡œ ì ê¸´ ê°’ë§Œìœ¼ë¡œ ëª©í‘œ(ì—° 1% ì ˆê°)ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.\n`+
           `- í™•ì • í•©ê³„: ${fmt2(toeLocked)} toe\n- ëª©í‘œ: ${fmt2(TARGET_TOE)} toe`;
  }

  const nextM = selectedMonth<12 ? selectedMonth+1 : null;
  if(!nextM) return `12ì›”ì…ë‹ˆë‹¤. ì˜¬í•´ ë°ì´í„° í™•ì •/ì ê²€ë§Œ í•˜ì‹œë©´ ë©ë‹ˆë‹¤.`;

  // ê°„ë‹¨íˆ "2025 ë™ì›” TOE ë¹„ì¤‘"ìœ¼ë¡œ ë‚¨ì€ ì˜ˆì‚°ì„ ë¶„ë°°
  const unlockedMonths = used.filter(r=>!isLockedBill(r));
  const sumW = unlockedMonths.reduce((s,r)=>s+toe25[r.m-1],0);
  const wNext = (sumW>0) ? toe25[nextM-1]/sumW : 1/unlockedMonths.length;

  const toeGoalNext = budgetRemain * wNext;

  const hNext = pickHeat(data, nextM-1);
  const heatToe = hNext.value * F_HEAT;

  const elecToeGoal = Math.max(0, toeGoalNext - heatToe);
  const elecMWhGoal = elecToeGoal / F_ELEC;

  const refElec = Y2025.elec[nextM-1];
  const deltaPct = (elecMWhGoal - refElec) / refElec * 100;

  return `ğŸ“Œ ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•œ ë‹¤ìŒ ë‹¬(${nextM}ì›”) ê¶Œì¥ ì „ê¸° ìƒí•œ\n`+
         `- ì—´(ì‚¬ìš©): ${fmt1(hNext.value)} Gcal (${srcLabel(hNext.source)})\n`+
         `- ì „ê¸°(ê¶Œì¥): ${fmt3(elecMWhGoal)} MWh ì´í•˜\n`+
         `- ì°¸ê³ : 2025ë…„ ${nextM}ì›” ì „ê¸° ${fmt3(refElec)} MWh ëŒ€ë¹„ ${deltaPct>=0?"+":""}${deltaPct.toFixed(1)}%`;
}

/* =========================
   ì„ íƒ ì›” ìƒì„¸
========================= */
function detailForMonth(data, m){
  const i=m-1;
  const e = pickElec(data,i);
  const h = pickHeat(data,i);
  const toe = toeOfMonth(e.value, h.value);

  const refElec = Y2025.elec[i], refHeat = Y2025.heat[i], refToe = toe25[i];
  const dElec = (e.value - refElec)/refElec*100;
  const dHeat = (h.value - refHeat)/refHeat*100;
  const dToe  = (toe - refToe)/refToe*100;

  const memo = (data[i].memo||"").trim();

  return `ğŸ§¾ ${m}ì›” ìƒì„¸(2026)\n`+
         `- ì „ê¸°: ${fmt3(e.value)} MWh (${srcLabel(e.source)})\n`+
         `- ì—´  : ${fmt1(h.value)} Gcal (${srcLabel(h.source)})\n`+
         `- ì›” TOE: ${fmt2(toe)} toe\n\n`+
         `ğŸ“Œ ì „ë…„(2025) ë™ì›” ëŒ€ë¹„\n`+
         `- ì „ê¸°: ${fmt3(refElec)} â†’ ${fmt3(e.value)} (${dElec>=0?"+":""}${dElec.toFixed(1)}%)\n`+
         `- ì—´  : ${fmt1(refHeat)} â†’ ${fmt1(h.value)} (${dHeat>=0?"+":""}${dHeat.toFixed(1)}%)\n`+
         `- TOE : ${fmt2(refToe)} â†’ ${fmt2(toe)} (${dToe>=0?"+":""}${dToe.toFixed(1)}%)\n`+
         `\nğŸ“ ë©”ëª¨\n- ${memo?memo:"(ì—†ìŒ)"}`;
}

/* =========================
   ë Œë” 2025
========================= */
function render2025(){
  const tbody = el("tbody2025");
  tbody.innerHTML="";
  let cum=0;
  for(let i=0;i<12;i++){
    const toe = toe25[i];
    cum += toe;
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="center">${i+1}</td>
      <td class="center">2025</td>
      <td class="center"><span class="tag src-bill">ê³ ì§€ì„œ</span></td>
      <td class="src-bill">${fmt3(Y2025.elec[i])}</td>
      <td class="src-bill">${fmt1(Y2025.heat[i])}</td>
      <td>${fmt2(toe)}</td>
      <td>${fmt2(cum)}</td>
    `;
    tbody.appendChild(tr);
  }

  const sumElec=Y2025.elec.reduce((a,b)=>a+b,0);
  const sumHeat=Y2025.heat.reduce((a,b)=>a+b,0);
  const sumToe = toe25.reduce((a,b)=>a+b,0);
  const savingPct=(BASELINE_TOE - sumToe)/BASELINE_TOE*100;

  el("box2025sum").innerHTML =
    `- ì „ê¸° í•©ê³„: <b>${fmt3(sumElec)}</b> MWh<br/>`+
    `- ì—´ í•©ê³„: <b>${fmt1(sumHeat)}</b> Gcal<br/>`+
    `- ì—°ê°„ TOE: <b>${fmt2(sumToe)}</b> toe<br/>`+
    `- ê¸°ì¤€ ëŒ€ë¹„ ì ˆê°ë¥ : <b>${fmtPct(savingPct)}%</b>`;
}

/* =========================
   ë Œë” 2026(í‘œ í´ë¦­ ìˆ˜ì •)
========================= */
function render2026(){
  const data = load2026();
  const mSel = Number(el("selMonth").value || 1);

  el("kpiBaseline").textContent = fmt3(BASELINE_TOE);
  el("kpiTarget").textContent   = fmt3(TARGET_TOE);

  const calc = compute2026(data);
  const annualToeEst = calc.annualToeEst;
  const savingPct = calc.savingPctFinal;

  el("kpiEstToe").textContent = fmt2(annualToeEst);
  el("kpiSaving").textContent = `${fmtPct(savingPct)}%`;
  el("kpiPass").textContent = (savingPct>=1.0) ? "PASS" : "FAIL";

  el("detailBox").textContent = detailForMonth(data, mSel);
  el("coachBox").textContent  = coachNextMonth(data, mSel);

  const tbody = el("tbody2026");
  tbody.innerHTML="";
  calc.withCum.forEach((r)=>{
    const eCls = srcClass(r.elec.source);
    const hCls = srcClass(r.heat.source);

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="center">${r.m}</td>

      <td class="center">
        <span class="tag ${eCls}">ì „ê¸°:${srcLabel(r.elec.source)}</span>
        <span class="tag ${hCls}">ì—´:${srcLabel(r.heat.source)}</span>
      </td>

      <td class="editable ${eCls}" data-field="elec" data-month="${r.m}" title="í´ë¦­í•´ì„œ ìˆ˜ì •">
        ${fmt3(r.elec.value)}
      </td>

      <td class="editable ${hCls}" data-field="heat" data-month="${r.m}" title="í´ë¦­í•´ì„œ ìˆ˜ì •">
        ${fmt1(r.heat.value)}
      </td>

      <td>${fmt2(r.toe)}</td>
      <td>${fmt2(r.cum_toe)}</td>
    `;
    tbody.appendChild(tr);
  });

  // ë³´ê³ ì„œ ìš”ì•½
  el("reportSummary").textContent =
    `ğŸ“„ 2026 ìš”ì•½(í˜„ì¬ ì…ë ¥ ê¸°ì¤€)\n`+
    `- ê¸°ì¤€(20~22 í‰ê· ): ${fmt3(BASELINE_TOE)} toe\n`+
    `- ë§Œì  ëª©í‘œ(âˆ’1%): ${fmt3(TARGET_TOE)} toe ì´í•˜\n`+
    `- 2026 ì˜ˆìƒ ì—°ê°„: ${fmt2(annualToeEst)} toe\n`+
    `- ìµœì¢… ì ˆê°ë¥ (ì—°ë§ ì˜ˆìƒ): ${fmtPct(savingPct)}%\n`+
    `- íŒì •: ${(savingPct>=1.0)?"PASS":"FAIL"}`;
}

/* =========================
   í‘œ í´ë¦­ â†’ ëª¨ë‹¬ ì—´ê¸°/ì €ì¥
========================= */
let modalState = { month:null, field:null };

function openModal(month, field){
  const data = load2026();
  const i = month-1;

  const slot = (field==="elec") ? data[i].elec : data[i].heat;
  const unit = (field==="elec") ? "MWh" : "Gcal";

  modalState = { month, field };

  el("modalTitle").textContent = `${month}ì›” ${field==="elec"?"ì „ê¸°":"ì—´"}(${unit}) ìˆ˜ì •`;
  el("modalSource").value = slot.source || "forecast";
  el("modalValue").value  = (slot.value==null) ? "" : slot.value;
  el("modalMemo").value   = data[i].memo || "";

  el("modalBack").style.display = "flex";
}
function closeModal(){
  el("modalBack").style.display = "none";
}

function saveModal(){
  const {month, field} = modalState;
  if(!month || !field) return;

  const data = load2026();
  const i = month-1;

  const src = el("modalSource").value;
  const valStr = el("modalValue").value.trim();
  const val = (valStr==="") ? null : Number(valStr);
  const memo = el("modalMemo").value;

  if(field==="elec"){
    data[i].elec.source = src;
    data[i].elec.value  = val;
  }else{
    data[i].heat.source = src;
    data[i].heat.value  = val;
  }
  data[i].memo = memo || "";

  save2026(data);
  closeModal();
  render2026();
}

function deleteModalValue(){
  const {month, field} = modalState;
  if(!month || !field) return;

  const data = load2026();
  const i = month-1;

  if(field==="elec"){
    data[i].elec.source = null;
    data[i].elec.value  = null;
  }else{
    data[i].heat.source = null;
    data[i].heat.value  = null;
  }
  save2026(data);
  closeModal();
  render2026();
}

/* =========================
   Export
========================= */
function export2026CSV(){
  const data = load2026();
  const calc = compute2026(data);

  const lines=[];
  lines.push([
    "year","month",
    "elec_source","elec_value_mwh",
    "heat_source","heat_value_gcal",
    "used_elec_mwh","used_heat_gcal",
    "month_toe","cum_toe",
    "memo"
  ].join(","));

  calc.withCum.forEach(r=>{
    const i=r.m-1;
    const esc = (s)=> `"${String(s??"").replaceAll('"','""')}"`;
    const raw = data[i];
    lines.push([
      "2026",
      r.m,
      (raw.elec.source||""),
      (raw.elec.value==null ? "" : raw.elec.value),
      (raw.heat.source||""),
      (raw.heat.value==null ? "" : raw.heat.value),
      r.elec.value,
      r.heat.value,
      r.toe,
      r.cum_toe,
      esc(raw.memo||"")
    ].join(","));
  });
  return lines.join("\n");
}
function export2026JSON(){
  return JSON.stringify({
    year:2026,
    baseline_toe:BASELINE_TOE,
    target_toe:TARGET_TOE,
    factors:{ elec_toe_per_mwh:F_ELEC, heat_toe_per_gcal:F_HEAT },
    y2025_reference:Y2025,
    data:load2026()
  }, null, 2);
}

/* =========================
   Tabs
========================= */
function setTab(which){
  const t2026 = el("tab2026"), t2025 = el("tab2025"), tRep = el("tabReport");
  const s2026 = el("sec2026"), s2025 = el("sec2025"), sRep = el("secReport");
  [t2026,t2025,tRep].forEach(x=>x.classList.remove("active"));
  [s2026,s2025,sRep].forEach(x=>x.style.display="none");
  if(which==="2026"){ t2026.classList.add("active"); s2026.style.display="block"; }
  if(which==="2025"){ t2025.classList.add("active"); s2025.style.display="block"; }
  if(which==="report"){ tRep.classList.add("active"); sRep.style.display="block"; }
}

/* =========================
   init
========================= */
function init(){
  const now = new Date();
  el("nowInfo").textContent = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}`;

  // month select
  const sel = el("selMonth");
  for(let m=1;m<=12;m++){
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = `${m}ì›”`;
    sel.appendChild(opt);
  }
  sel.value = String(new Date().getMonth()+1);
  sel.addEventListener("change", ()=>render2026());

  // quick auto
  el("btnAutoForecast").addEventListener("click", ()=>{
    const data=load2026();
    const m=Number(sel.value);
    const i=m-1;
    data[i].elec.source="forecast";
    data[i].heat.source="forecast";
    data[i].elec.value=Y2025.elec[i];
    data[i].heat.value=Y2025.heat[i];
    save2026(data);
    render2026();
  });
  el("btnAutoBill").addEventListener("click", ()=>{
    const data=load2026();
    const m=Number(sel.value);
    const i=m-1;
    data[i].elec.source="bill";
    data[i].heat.source="bill";
    data[i].elec.value=Y2025.elec[i];
    data[i].heat.value=Y2025.heat[i];
    save2026(data);
    render2026();
  });

  // reset
  el("btnResetAll").addEventListener("click", ()=>{
    if(!confirm("2026 ë°ì´í„°ë¥¼ ì „ë¶€ ì§€ìš¸ê¹Œìš”?")) return;
    localStorage.removeItem(LS_KEY);
    render2026();
  });

  // tabs
  el("tab2026").addEventListener("click", ()=>setTab("2026"));
  el("tab2025").addEventListener("click", ()=>setTab("2025"));
  el("tabReport").addEventListener("click", ()=>setTab("report"));

  // export
  el("btnExportCSV").addEventListener("click", ()=>{
    const box = el("exportBox");
    box.style.display="block";
    box.textContent = export2026CSV();
  });
  el("btnExportJSON").addEventListener("click", ()=>{
    const box = el("exportBox");
    box.style.display="block";
    box.textContent = export2026JSON();
  });

  // modal
  el("modalCancel").addEventListener("click", closeModal);
  el("modalBack").addEventListener("click", (e)=>{ if(e.target.id==="modalBack") closeModal(); });
  el("modalSave").addEventListener("click", saveModal);
  el("modalDelete").addEventListener("click", ()=>{
    if(!confirm("ì´ ê°’ë§Œ ì§€ìš¸ê¹Œìš”? (ìë™ ì˜ˆì¸¡ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤)")) return;
    deleteModalValue();
  });

  // table click delegation
  el("tbody2026").addEventListener("click", (e)=>{
    const cell = e.target.closest("td.editable");
    if(!cell) return;
    const m = Number(cell.dataset.month);
    const field = cell.dataset.field; // elec | heat
    openModal(m, field);
  });

  render2025();
  render2026();
  setTab("2026");
}

init();
</script>
</body>
</html>
