<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KOEN 복식 리그전(실시간)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    .lv4to6 { background-color: #e8f5e9; }
    .lv7to9 { background-color: #e3f2fd; }
    .lv10to12 { background-color: #fff3e0; }
    .lv13to14 { background-color: #ffebee; }

    .new-player {
      background-color: #fff176 !important;
      border: 3px solid #f57f17;
      font-weight: bold;
      box-shadow: 0 0 10px #f9a825;
      animation: highlightFlash 1.5s ease-in-out infinite alternate;
    }
    @keyframes highlightFlash { from{background:#fff59d;} to{background:#ffe082;} }

    h1, #controlPanel { text-align: center; }
    .player {
      margin: 4px; padding: 6px 10px; border: 1px solid #2196f3; border-radius: 6px;
      display: inline-block; cursor: pointer; font-size: 14px;
      user-select: none;
    }
    .player.selected { background: #1976d2; color: white; }
    .player.locked { opacity: .45; cursor: not-allowed; }

    table { border-collapse: collapse; width: 100%; margin-top: 20px; background: white; font-size: 14px; }
    td, th { border: 1px solid #888; padding: 6px 10px; text-align: center; }
    tr:nth-child(odd) { background: #e3f2fd; }
    tr:nth-child(even) { background: #fff; }
    table tr:first-child th, table td:first-child { background: #ffe0b2 !important; }

    .button-group { display: flex; justify-content: center; flex-wrap: wrap; gap: 12px; margin: 20px 0; }
    .button-group button {
      padding: 10px 20px; font-size: 16px; background: #1976d2; color: white; border: none; border-radius: 6px; cursor: pointer;
    }
    .button-group button:hover { background: #1565c0; }

    .scroll-table { overflow: auto; max-height: 80vh; max-width: 100%; border: 1px solid #aaa; }
    .scroll-table table th { position: sticky; top: 0; background: #ffe0b2; z-index: 2; }
    .scroll-table table th:first-child, .scroll-table table td:first-child {
      position: sticky; left: 0; background: #ffe0b2; z-index: 1;
    }

    #popup {
      display: none; position: fixed; top: 30%; left: 50%; transform: translate(-50%,-50%);
      background: #fff; border: 2px solid #333; padding: 20px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,.3);
      width: 90%; max-width: 400px;
    }
    #popup button { margin: 5px 0; padding: 8px 12px; background: #1976d2; color: #fff; border: none; border-radius: 4px; cursor: pointer; width: 100%; }
    #popupText { margin-bottom: 10px; font-weight: bold; }

    #controlPanel input[type="text"] { padding: 10px; font-size: 16px; margin: 5px; width: 200px; max-width: 90%; }
    #controlPanel button { padding: 10px 16px; font-size: 16px; margin: 5px; }

    @media (max-width: 600px) {
      body { padding: 10px; }
      table, .scroll-table, #popup { font-size: 13px; width: 100%; overflow-x: auto; }
      .player { font-size: 13px; padding: 5px 8px; }
      #controlPanel button { font-size: 14px; padding: 8px 10px; width: 100%; margin-bottom: 10px; }
      #controlPanel input[type="text"] { width: 100%; font-size: 14px; }
      .button-group { flex-direction: column; align-items: center; }
      .button-group button { width: 100%; max-width: 300px; font-size: 14px; }
    }

    .player-list { display: flex; flex-wrap: wrap; justify-content: center; }

    /* ✅ B) 운영 편의 UI */
    #modeBar{
      margin: 10px auto 0;
      max-width: 900px;
      padding: 10px 12px;
      border: 1px dashed #999;
      border-radius: 10px;
      background: #fafafa;
      text-align: center;
      font-weight: 700;
      display:none;
    }
    .mini-btn{
      padding: 6px 10px;
      font-size: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #111;
      color:#fff;
      margin-left: 6px;
      white-space: nowrap;
    }
    .mini-btn.danger{ background:#c62828; }
    .mini-btn.gray{ background:#607d8b; }
  </style>
</head>
<body>
  <h1>실시간 탁구 복식 리그전</h1>

  <div id="controlPanel">
    <input type="text" id="playerName" placeholder="선수 이름" />
    <input type="text" id="playerLevel" placeholder="부수 (예: 5)" />
    <button id="addPlayerBtn">선수 추가</button>
    <button id="toggleDefaultBtn">기존 선수 숨김</button>
    <button id="removeAddedBtn">추가 선수 삭제</button>
  </div>

  <!-- ✅ B) 팀 수정 모드 표시줄 -->
  <div id="modeBar"></div>

  <div id="playerList" class="player-list"></div>

  <div class="button-group">
    <button id="resetBtn">점수 초기화</button>
    <button id="clearBtn">선수 선택 초기화</button>
    <button id="saveImageBtn">리그전 이미지 저장</button>
  </div>

  <div id="schedule" class="scroll-table"></div>
  <div id="summary" class="scroll-table"></div>

  <div id="popup">
    <p id="popupText"></p>
    <div id="scoreButtons"></div>
    <button onclick="closePopup()">닫기</button>
  </div>

  <script type="module">

    async function loadDefaultPlayers() {
      const url = "https://sensational-tulumba-65e97e.netlify.app/pingpong/club/data/members.json";
      const res = await fetch(url);
      const data = await res.json();

      const arr = Object.values(data).map(p => `${p.name}(${p.level})`);
      arr.sort((a, b) => {
        const lvA = Number(a.match(/\((\d+)\)/)[1]);
        const lvB = Number(b.match(/\((\d+)\)/)[1]);
        return lvA - lvB;
      });
      return arr;
    }

    // ===== Firebase SDK =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // ===== Config =====
    const firebaseConfig = {
      apiKey: "AIzaSyC5iq3VY0QtBh8FVn70gi_Gsg7GXzkxdu8",
      authDomain: "koen-pingpong.firebaseapp.com",
      databaseURL: "https://koen-pingpong-default-rtdb.firebaseio.com",
      projectId: "koen-pingpong",
      storageBucket: "koen-pingpong.firebasestorage.app",
      messagingSenderId: "597358811982",
      appId: "1:597358811982:web:01cc59a4e9726341321c1f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // ===== Refs =====
    const extraPlayersRef = ref(db, "players/koen_takgu/extra");   // 추가 선수
    const resultsRef      = ref(db, "players/koen_takgu/results"); // 경기 결과 (객체: "i-j":"3-1")
    const selectedRef     = ref(db, "players/koen_takgu/selected");// ✅ A) "선수 문자열 배열"로 저장
    const teamListRef     = ref(db, "players/koen_takgu/teamList");// 팀 리스트 [{names:[],level:n},...]

    // ===== State =====
    let hideDefault = false;
    let currentPlayers = [];
    let teamList = [];
    let results = {};          // 객체
    let extraPlayers = [];

    // ✅ A) 선택은 index가 아니라 "선수 문자열"
    let tempSelected = [];     // 예: ["강성용(5)","김범일(5)"]

    // ✅ B) 팀 수정 모드(로컬)
    let editingTeamIndex = null;

    let defaultPlayers = [];

    // ===== Auth =====
    async function ensureAnonAuth() {
      if (auth.currentUser) return auth.currentUser;
      return new Promise((resolve, reject) => {
        const unsub = onAuthStateChanged(auth, (u) => { if (u) { unsub(); resolve(u); }});
        signInAnonymously(auth).catch(reject);
      });
    }

    // ===== Boot =====
    (async function boot() {
      try {
        await ensureAnonAuth();

        defaultPlayers = await loadDefaultPlayers();
        currentPlayers = [...defaultPlayers];

        onValue(extraPlayersRef, (snapshot) => {
          extraPlayers = snapshot.val() || [];
          currentPlayers = [...defaultPlayers, ...extraPlayers];
          renderPlayerList();
        });

        onValue(resultsRef, (snapshot) => {
          results = snapshot.val() || {};
          if (teamList.length >= 2) createSchedule();
        });

        // ✅ A) 여기서도 문자열 배열로 받음
        onValue(selectedRef, (snapshot) => {
          tempSelected = snapshot.val() || [];
          renderPlayerList();
          updateModeBar();
        });

        onValue(teamListRef, (snapshot) => {
          teamList = snapshot.val() || [];
          if (!teamList || teamList.length < 2) {
            document.getElementById("schedule").innerHTML = "<p>2팀 이상 등록해주세요.</p>";
            document.getElementById("summary").innerHTML = "";
            renderPlayerList();
            return;
          }
          createSchedule();
          renderPlayerList();
        });

        // 버튼 핸들러
        document.getElementById("resetBtn").onclick = async () => {
          await set(resultsRef, {});
          results = {};
          createSchedule();
        };

        document.getElementById("clearBtn").onclick = async () => {
          tempSelected = [];
          teamList = [];
          results = {};
          editingTeamIndex = null;

          await set(teamListRef, []);
          await set(selectedRef, []);   // ✅ A) 문자열 배열
          await set(resultsRef, {});

          document.getElementById("schedule").innerHTML = "<p>2팀 이상 등록해주세요.</p>";
          document.getElementById("summary").innerHTML = "";
          renderPlayerList();
          updateModeBar();
        };

        document.getElementById("removeAddedBtn").onclick = async () => {
          if (!confirm("추가한 선수를 모두 삭제하시겠습니까?")) return;
          extraPlayers = [];
          await set(extraPlayersRef, extraPlayers);
        };

        document.getElementById("addPlayerBtn").onclick = async () => {
          const name = document.getElementById("playerName").value.trim();
          const level = document.getElementById("playerLevel").value.trim();
          if (!name || !level) return alert("이름과 부수를 입력하세요");

          const newEntry = `${name}(${level})`;
          if ([...defaultPlayers, ...extraPlayers].includes(newEntry)) {
            alert("이미 등록된 선수입니다.");
            return;
          }
          extraPlayers.push(newEntry);
          await set(extraPlayersRef, extraPlayers);

          document.getElementById("playerName").value = "";
          document.getElementById("playerLevel").value = "";
        };

        document.getElementById("saveImageBtn").onclick = () => {
          const scheduleDiv = document.getElementById("scheduleTable");
          if (!scheduleDiv) return alert("저장할 표가 없습니다.");
          const now = new Date(), pad = (n)=>n.toString().padStart(2,'0');
          const y=now.getFullYear(), m=pad(now.getMonth()+1), d=pad(now.getDate());
          const w=['일','월','화','수','목','금','토'][now.getDay()];
          const hh=pad(now.getHours()), mm=pad(now.getMinutes());
          const filename = `koen_league_result_${y}-${m}-${d}(${w})_${hh}-${mm}.jpg`;

          html2canvas(scheduleDiv).then(canvas => {
            const link = document.createElement("a");
            link.download = filename;
            link.href = canvas.toDataURL("image/jpeg");
            link.click();
          });
        };

        document.getElementById("toggleDefaultBtn").onclick = () => {
          hideDefault = !hideDefault;
          renderPlayerList();
          document.getElementById("toggleDefaultBtn").innerText = hideDefault ? "기존선수 보이기" : "기존선수 숨김";
        };
        document.getElementById("toggleDefaultBtn").innerText = "기존선수 숨김";

      } catch (e) {
        console.error("익명 로그인 실패:", e);
        alert("로그인 오류가 발생했습니다. 새로고침 후 다시 시도하세요.");
      }
    })();

    // ===== Utils =====
    function nameOnlyFromPlayerStr(playerStr){
      return playerStr.split("(")[0].trim();
    }
    function levelFromPlayerStr(playerStr){
      const m = playerStr.match(/\((\d+)\)/);
      return m ? Number(m[1]) : 0;
    }
    function isPlayerInAnyTeam(nameOnly){
      return teamList.some(t => t.names.includes(nameOnly));
    }
    function isPlayerInEditingTeam(nameOnly){
      if (editingTeamIndex === null) return false;
      const t = teamList[editingTeamIndex];
      if (!t) return false;
      return t.names.includes(nameOnly);
    }

    // ✅ B) 모드바 표시
    function updateModeBar(){
      const bar = document.getElementById("modeBar");
      if (editingTeamIndex === null){
        bar.style.display = "none";
        bar.innerHTML = "";
        return;
      }
      const t = teamList[editingTeamIndex];
      const teamText = t ? `${t.names.join("/")} (${t.level})` : `#${editingTeamIndex+1}`;
      bar.style.display = "block";
      bar.innerHTML = `
        팀 수정 모드: <b>${teamText}</b> → 수정할 <b>2명</b>을 다시 선택하세요.
        <button class="mini-btn gray" id="cancelEditBtn">수정 취소</button>
      `;
      document.getElementById("cancelEditBtn").onclick = async () => {
        editingTeamIndex = null;
        tempSelected = [];
        await set(selectedRef, []);
        renderPlayerList();
        updateModeBar();
      };
    }

    // ===== 렌더링 =====
    function renderPlayerList() {
      const playerList = document.getElementById("playerList");
      playerList.innerHTML = "";

      const sortedPlayers = [
        ...[...currentPlayers]
          .filter(p => defaultPlayers.includes(p))
          .sort((a,b)=> levelFromPlayerStr(a) - levelFromPlayerStr(b)),
        ...extraPlayers
      ];

      sortedPlayers.forEach((playerStr) => {
        if (hideDefault && defaultPlayers.includes(playerStr)) return;

        const div = document.createElement("div");
        div.className = "player";
        div.textContent = playerStr;

        const level = levelFromPlayerStr(playerStr);
        if (level <= 6) div.classList.add("lv4to6");
        else if (level <= 9) div.classList.add("lv7to9");
        else if (level <= 12) div.classList.add("lv10to12");
        else div.classList.add("lv13to14");

        if (!defaultPlayers.includes(playerStr)) div.classList.add("new-player");

        const nm = nameOnlyFromPlayerStr(playerStr);
        const inTeam = isPlayerInAnyTeam(nm);

        // ✅ A) 선택 판정: 인덱스가 아니라 문자열로
        if (tempSelected.includes(playerStr) || inTeam) div.classList.add("selected");

        // ✅ B) 이미 다른 팀에 들어간 선수는 선택 잠금(단, 수정모드에서 해당 팀 선수는 허용)
        const locked = inTeam && !isPlayerInEditingTeam(nm);
        if (locked) div.classList.add("locked");

        div.onclick = () => {
          if (locked) return;
          togglePlayer(playerStr);
        };

        playerList.appendChild(div);
      });
    }

    // ===== ✅ A) 선택/팀 구성(문자열 기반) + ✅ B) 수정모드 =====
    async function togglePlayer(playerStr) {
      if (tempSelected.includes(playerStr)) {
        tempSelected = tempSelected.filter(p => p !== playerStr);
      } else {
        tempSelected = [...tempSelected, playerStr];

        if (tempSelected.length === 2) {
          const players = tempSelected.map(txt => ({
            name: nameOnlyFromPlayerStr(txt),
            level: levelFromPlayerStr(txt)
          }));

          const newTeam = { names: players.map(p => p.name), level: players[0].level + players[1].level };

          // ✅ B) 수정모드면 팀 교체, 아니면 팀 추가
          if (editingTeamIndex !== null) {
            // 해당 팀 관련 결과만 삭제(인덱스는 그대로)
            const idx = editingTeamIndex;
            const newResults = { ...results };
            Object.keys(newResults).forEach(k => {
              const [a,b] = k.split("-").map(Number);
              if (a === idx || b === idx) delete newResults[k];
            });
            results = newResults;
            await set(resultsRef, results);

            teamList = teamList.map((t,i) => i === idx ? newTeam : t);
            await set(teamListRef, teamList);

            editingTeamIndex = null;
          } else {
            teamList = [...teamList, newTeam];
            await set(teamListRef, teamList);
          }

          tempSelected = [];
        }
      }

      await set(selectedRef, tempSelected);
      renderPlayerList();
      createSchedule();
      updateModeBar();
    }

    // ===== 리그 표/요약 + ✅ B) 팀 삭제/수정 버튼 =====
    function createSchedule() {
      const container = document.getElementById("schedule");
      if (!teamList || teamList.length < 2) {
        container.innerHTML = "<p>2팀 이상 등록해주세요.</p>";
        document.getElementById("summary").innerHTML = "";
        return;
      }

      let html = "<div id='scheduleTable'><table><tr><th>팀</th>";
      teamList.forEach((t, idx) => {
        html += `<th>
          ${t.names.join("/")} (${t.level})
          <div style="margin-top:6px">
            <button class="mini-btn" onclick="startEditTeam(${idx})">수정</button>
            <button class="mini-btn danger" onclick="deleteTeam(${idx})">삭제</button>
          </div>
        </th>`;
      });
      html += "</tr>";

      teamList.forEach((t1, i) => {
        html += `<tr><th>
          ${t1.names.join("/")} (${t1.level})
          <div style="margin-top:6px">
            <button class="mini-btn" onclick="startEditTeam(${i})">수정</button>
            <button class="mini-btn danger" onclick="deleteTeam(${i})">삭제</button>
          </div>
        </th>`;

        teamList.forEach((t2, j) => {
          if (i === j) html += "<td>X</td>";
          else {
            const key = `${i}-${j}`;
            const result = results[key] || "";
            html += `<td onclick="openPopup('${key}')">${result}</td>`;
          }
        });
        html += "</tr>";
      });
      html += "</table></div>";
      container.innerHTML = html;

      // 요약 표(승/세트)
      let wins = Array(teamList.length).fill(0);
      let sets = Array(teamList.length).fill(0);

      for (let i=0;i<teamList.length;i++){
        for (let j=0;j<teamList.length;j++){
          if (i===j || i>j) continue;
          const key = `${i}-${j}`;
          const score = results[key];
          if (!score) continue;
          const [a,b] = score.split("-").map(Number);
          if (a>b) wins[i]++; else wins[j]++;
          sets[i]+=a; sets[j]+=b;
        }
      }

      const ranking = wins
        .map((w,i)=>({i,w,s:sets[i]}))
        .sort((a,b)=> (b.w-a.w) || (b.s-a.s));

      let summaryHtml = "<h3>팀 요약</h3><table><tr><th>팀</th><th>승</th><th>세트</th><th>순위</th></tr>";
      ranking.forEach((r,rank)=>{
        const t = teamList[r.i];
        summaryHtml += `<tr><td>${t.names.join("/")} (${t.level})</td><td>${r.w}</td><td>${r.s}</td><td>${rank+1}</td></tr>`;
      });
      summaryHtml += "</table>";
      document.getElementById("summary").innerHTML = summaryHtml;
    }

    // ✅ B) 팀 삭제: 팀 제거 + 결과 키 재매핑 + 선택 초기화
    window.deleteTeam = async (idx) => {
      if (!teamList[idx]) return;
      const txt = teamList[idx].names.join("/") + ` (${teamList[idx].level})`;
      if (!confirm(`이 팀을 삭제할까요?\n\n${txt}\n\n(해당 팀 관련 결과는 삭제됩니다)`)) return;

      // 1) teamList에서 제거
      const newTeamList = teamList.filter((_,i)=> i !== idx);

      // 2) results 재매핑 (인덱스가 앞으로 당겨지므로 키 재계산)
      const newResults = {};
      Object.entries(results).forEach(([k,v]) => {
        const [a,b] = k.split("-").map(Number);
        if (a === idx || b === idx) return; // 삭제된 팀 관련 결과 제거

        const na = a > idx ? a - 1 : a;
        const nb = b > idx ? b - 1 : b;
        newResults[`${na}-${nb}`] = v;
      });

      teamList = newTeamList;
      results = newResults;

      // 선택도 초기화
      tempSelected = [];
      editingTeamIndex = null;

      await set(teamListRef, teamList);
      await set(resultsRef, results);
      await set(selectedRef, []);

      renderPlayerList();
      createSchedule();
      updateModeBar();
    };

    // ✅ B) 팀 수정 시작: 수정 모드 ON + 선택 초기화(2명 다시 고르면 교체)
    window.startEditTeam = async (idx) => {
      if (!teamList[idx]) return;
      editingTeamIndex = idx;
      tempSelected = [];
      await set(selectedRef, []);
      renderPlayerList();
      updateModeBar();
      alert("팀 수정 모드입니다.\n수정할 선수 2명을 다시 선택하세요.");
    };

    // ===== 팝업/점수 입력 =====
    window.openPopup = (matchKey) => {
      const popup = document.getElementById("popup");
      const popupText = document.getElementById("popupText");
      const scoreButtons = document.getElementById("scoreButtons");
      popupText.textContent = "해당 경기의 점수를 선택하세요";

      const scores = ["3-0","3-1","3-2","2-0","2-1"];
      scoreButtons.innerHTML = "";

      scores.forEach(score => {
        const btn = document.createElement("button");
        btn.textContent = score;
        btn.onclick = async () => {
          results[matchKey] = score;
          results[reverseKey(matchKey)] = reverseScore(score);
          await set(resultsRef, results);
          popup.style.display = "none";
          createSchedule();
        };
        scoreButtons.appendChild(btn);
      });

      popup.style.display = "block";
    };

    window.closePopup = () => document.getElementById("popup").style.display = "none";

    function reverseKey(key) {
      const [a,b] = key.split("-");
      return `${b}-${a}`;
    }
    function reverseScore(score) {
      const [a,b] = score.split("-").map(Number);
      return `${b}-${a}`;
    }

  </script>
</body>
</html>
