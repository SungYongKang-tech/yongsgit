<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‹¨ì²´ì „ ì§„í–‰</title>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body { font-family:'Segoe UI', sans-serif; padding:20px; background:#f5f7fa }
    h2 { text-align:center; color:#0d47a1; margin:10px 0 30px }
    .config { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:20px }
    select, button { padding:6px 14px; font-size:15px }
    table { border-collapse:collapse; width:100%; max-width:600px; margin:0 auto }
    th, td { border:1px solid #888; padding:8px 12px; text-align:center }
    th { background:#e3f2fd }
    .match-card { border:3px solid #0d47a1; padding:20px; margin:30px auto; max-width:720px; background:#fff; border-radius:14px; box-shadow:2px 2px 10px rgba(0,0,0,0.12) }
    .match-card h3 { text-align:center; margin-bottom:20px; font-size:20px; color:#0d47a1 }
    .match-card table { width:100%; border-collapse:collapse }
    .match-card th, .match-card td { border:1px solid #aaa; padding:10px; text-align:center }
    .match-card th { background-color:#e3f2fd }
    .draggable { cursor:move; }
    .popup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; border:1px solid #999; padding:20px; box-shadow:0 0 10px rgba(0,0,0,0.2); z-index:9999; }
    .popup button { margin:5px; }

/* ìˆœìœ„í‘œ ëª¨ë°”ì¼ ëŒ€ì‘ ìŠ¤íƒ€ì¼ */
.scroll-table {
  overflow-x: auto;
  border: 1px solid #ccc;
  border-radius: 8px;
  margin: 20px auto;
  width: 100%;
  max-width: 720px;
}

.scroll-table table {
  border-collapse: collapse;
  width: 100%;
  min-width: 500px; /* ìµœì†Œ ë„ˆë¹„ */
  background-color: white;
}

.scroll-table th, .scroll-table td {
  border: 1px solid #888;
  padding: 16px 10px;
  text-align: center;
  font-size: 16px;
  white-space: nowrap;
}

.scroll-table th:first-child,
.scroll-table td:first-child {
  background-color: #ffe082; /* ì²« ì—´ ê°•ì¡° */
  font-weight: bold;
}

@media screen and (max-width: 600px) {
  .scroll-table th, .scroll-table td {
    font-size: 13px;
    padding: 12px 8px;
  }

  .scroll-table table {
    min-width: 100%;
  }
}
.modal {
  display: none;
  position: fixed;
  z-index: 3000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.4);
}

.modal-content {
  background-color: #fff;
  margin: 10% auto;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.3);
  animation: fadeIn 0.3s ease;
}

.modal-content h3 {
  text-align: center;
  color: #1976d2;
  margin-bottom: 12px;
}

.modal-content ul {
  padding-left: 20px;
  font-size: 14px;
}

.modal-content li {
  margin-bottom: 8px;
}

#closeUsageModal {
  padding: 8px 16px;
  font-size: 15px;
  background-color: #1976d2;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

  </style>

 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, onValue, update, remove, set, get, child } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC5iq3VY0QtBh8FVn70gi_Gsg7GXzkxdu8",
    authDomain: "koen-pingpong.firebaseapp.com",
    databaseURL: "https://koen-pingpong-default-rtdb.firebaseio.com",
    projectId: "koen-pingpong",
    storageBucket: "koen-pingpong.firebasestorage.app",
    messagingSenderId: "597358811982",
    appId: "1:597358811982:web:2ee0d02e6b68cb0a321c1f"
  };

 const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  function renderTeamList() {
    let html = '<h3 style="text-align:center">ğŸ“‹ íŒ€ êµ¬ì„± í˜„í™©</h3><table><tr><th>íŒ€ëª…</th><th>íŒ€ì› ëª©ë¡</th></tr>';
    teamNames.forEach(team => {
      const players = teamData[team].players.map(p => `${p.name}(${p.level})`).join(', ');
      html += `<tr><td>${team}</td><td>${players}</td></tr>`;
    });
    html += '</table>';
    document.getElementById('teamListArea').innerHTML = html;
  }

  let teamNames = [], teamData = {};

  async function loadTeams() {
    const snapshot = await get(ref(db, "teams"));
    const raw = snapshot.val();
    if (!raw) {
      alert("âŒ íŒ€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íŒ€ì„ êµ¬ì„±í•´ ì£¼ì„¸ìš”.");
      return;
    }
    teamData = {};
    teamNames = [];
    Object.values(raw).forEach(team => {
      teamData[team.teamName] = team;
      teamNames.push(team.teamName);
    });
    renderTeamList();
  }

  window.handleGenerateMatches = () => {
    loadTeams().then(() => {
      renderAllMatchesFromFirebase(); // ë°–ì—ì„œ ì„ ì–¸ëœ í•¨ìˆ˜ëŠ” windowì— ìˆì–´ì•¼ í•¨
    });
  };

  window.db = db;
  window.ref = ref;
</script>


</head>
<body>
  <div id="teamListArea" style="margin-bottom:30px;"></div>
  <h2>ë‹¨ì²´ì „ ì§„í–‰</h2>
  <div class="config">
    ë‹¨ì‹
<select id="singlesCnt">
  <option value="0">0ê²½ê¸°</option>
  <option value="1">1ê²½ê¸°</option>
  <option value="2">2ê²½ê¸°</option>
  <option value="3" selected>3ê²½ê¸°</option>
  <option value="4">4ê²½ê¸°</option>
  <option value="5">5ê²½ê¸°</option>
</select>
ë³µì‹
<select id="doublesCnt">
  <option value="0">0ê²½ê¸°</option>
  <option value="1">1ê²½ê¸°</option>
  <option value="2" selected>2ê²½ê¸°</option>
  <option value="3">3ê²½ê¸°</option>
</select>
    <button onclick="renderAllMatchesFromFirebase()">ëŒ€ì§„í‘œ ìƒì„±</button>


    <button onclick="saveAsImage()">ëŒ€ì§„ê²°ê³¼ ì €ì¥</button>

<!--  <button onclick="renderAllMatchesFromFirebase()">ëŒ€ì§„í‘œ ìƒì„±</button>  -->
  </div>
  
  <div id="popup" class="popup" style="display:none;"></div>

  <div id="captureArea">
    <div id="summaryArea"></div>
    <div id="rankingArea" style="margin-top: 40px;"></div>
  </div>
  



<!-- ì‚¬ìš©ë²• ì•ˆë‚´ íŒì—… -->
<div id="usageModal" class="modal">
  <div class="modal-content">
    <h3>ğŸ“˜ ë‹¨ì²´ì „ ì§„í–‰ ì‚¬ìš©ë²•</h3>
    <ul>
      <li><strong>1. íŒ€ êµ¬ì„±:</strong> íŒ€ êµ¬ì„±ê¸°ë¥¼ í†µí•´ íŒ€ì„ ë§Œë“¤ê³  ì—…ë¡œë“œí•˜ì„¸ìš”.</li>
      <li><strong>2. ëŒ€ì§„í‘œ ìƒì„±:</strong> ë‹¨ì‹/ë³µì‹ ìˆ˜ ì„ íƒ í›„ 'ëŒ€ì§„í‘œ ìƒì„±' ë²„íŠ¼ í´ë¦­</li>
      <li><strong>3. ì„ ìˆ˜ ì§€ì •:</strong> ê° ê²½ê¸° ì…€ í´ë¦­ â†’ ì¶œì „ ì„ ìˆ˜ ì„ íƒ</li>
      <li><strong>4. ì ìˆ˜ ì…ë ¥:</strong> ì ìˆ˜ ì…€ í´ë¦­ â†’ 3:2, 2:1 ë“± í˜•ì‹ ì„ íƒ</li>
      <li><strong>5. ì‹¤ì‹œê°„ ë°˜ì˜:</strong> ì„œë²„ì™€ ì—°ë™ë˜ì–´ ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ì‹¤ì‹œê°„ ë™ê¸°í™”</li>
      <li><strong>6. ì´ë¯¸ì§€ ì €ì¥:</strong> 'ëŒ€ì§„ê²°ê³¼ ì €ì¥' ë²„íŠ¼ í´ë¦­ ì‹œ ì´ë¯¸ì§€ë¡œ ì €ì¥</li>
    </ul>
    <div style="text-align:center; margin-top:15px;">
      <button id="closeUsageModal">ë‹«ê¸°</button>
    </div>
  </div>
</div>


<script>

let teamNames = [], teamData = {};

// Firebaseì—ì„œ íŒ€ ë¶ˆëŸ¬ì˜¤ê¸°
function loadTeams() {
  const db = window.db;
  const ref = window.ref;
  const get = window.get;

  return get(ref(db, "teams")).then(snap => {
    const raw = snap.val();
    teamData = {};
    teamNames = [];

    if (!raw) {
      alert("âŒ íŒ€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íŒ€ì„ êµ¬ì„±í•´ ì£¼ì„¸ìš”.");
      return;
    }

   Object.entries(raw).forEach(([key, team]) => {
  const teamName = team.teamName || key; // teamNameì´ ì—†ìœ¼ë©´ í‚¤ ì‚¬ìš©
  teamData[teamName] = team;
  teamNames.push(teamName);
});

    renderTeamList();
  });
}

function renderAllMatchesFromFirebase() {
  const db = window.db;
  const ref = window.ref;
  const remove = window.remove;
  const update = window.update;

  // âœ… ê¸°ì¡´ matches ì§€ìš°ê¸°
  remove(ref(db, "matches")).then(() => {
    const singles = +document.getElementById("singlesCnt").value;
    const doubles = +document.getElementById("doublesCnt").value;
    const totalMatches = [];

    for (let i = 0; i < teamNames.length; i++) {
      for (let j = i + 1; j < teamNames.length; j++) {
        totalMatches.push({ teamA: teamNames[i], teamB: teamNames[j] });
      }
    }

    const updates = {};
    totalMatches.forEach(match => {
      const matchList = [];
      for (let i = 0; i < singles; i++)
        matchList.push({ label: `${i + 1}ë‹¨`, players: `ë¯¸ì • vs ë¯¸ì •`, result: "-" });
      for (let i = 0; i < doubles; i++)
        matchList.push({ label: `${i + 1}ë³µ`, players: `ë¯¸ì •/ë¯¸ì • vs ë¯¸ì •/ë¯¸ì •`, result: "-" });

      const key = `${match.teamA}_vs_${match.teamB}`;
      updates[`matches/${key}`] = {
        teamA: match.teamA,
        teamB: match.teamB,
        matchList
      };

      // í™”ë©´ì—ë„ ë°”ë¡œ ë°˜ì˜
      renderMatchCard(match.teamA, match.teamB, matchList);
    });

    // âœ… update ì‹¤í–‰ (root ê¸°ì¤€ìœ¼ë¡œ)
    update(ref(db), updates);
  });
  document.getElementById("matchArea").innerHTML = ""; // ì´ ì¤„ ì¶”ê°€
}


// ë²„íŠ¼ í´ë¦­ ì‹œ
function handleGenerateMatches() {
  loadTeams().then(() => {
    renderAllMatchesFromFirebase(); // íŒ€ ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰
  });
}

function renderTeamList() {
  let html = '<h3 style="text-align:center">ğŸ“‹ íŒ€ êµ¬ì„± í˜„í™©</h3><table><tr><th>íŒ€ëª…</th><th>íŒ€ì› ëª©ë¡</th></tr>';
  teamNames.forEach(team => {
    const players = teamData[team].players.map(p => `${p.name}(${p.level})`).join(', ');
    html += `<tr><td>${team}</td><td>${players}</td></tr>`;
  });
  html += '</table>';
  document.getElementById('teamListArea').innerHTML = html;
}



function renderMatchCard(teamA, teamB, matchList) {
  const container = document.getElementById("matchArea");
  if (!container) {
    console.error("âŒ matchArea ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const card = document.createElement("div");
  card.className = "match-card";
  card.style.border = "2px solid #aaa";
  card.style.padding = "10px";
  card.style.marginBottom = "15px";
  card.style.background = "#fff";

  const title = document.createElement("h3");
  title.textContent = `${teamA} vs ${teamB}`;
  card.appendChild(title);

  matchList.forEach(match => {
    const p = document.createElement("p");
    p.textContent = `${match.label}: ${match.players} (${match.result})`;
    card.appendChild(p);
  });

  container.appendChild(card);
}



function openPlayerPopup(teamA, teamB, cell) {
  const popup = document.getElementById("popup");
  const isDoubles = cell.innerText.includes("/");

  const inputType = isDoubles ? 'checkbox' : 'radio';

  const playersA = teamData[teamA].players.map(p =>
    `<label><input type='${inputType}' name='teamA' value="${p.name}(${p.level})"> ${p.name}(${p.level})</label><br>`).join('');
  const playersB = teamData[teamB].players.map(p =>
    `<label><input type='${inputType}' name='teamB' value="${p.name}(${p.level})"> ${p.name}(${p.level})</label><br>`).join('');

  popup.innerHTML = `
    <h4>${teamA} ${isDoubles ? '(2ëª… ì„ íƒ)' : '(1ëª… ì„ íƒ)'}</h4>${playersA}
    <hr>
    <h4>${teamB} ${isDoubles ? '(2ëª… ì„ íƒ)' : '(1ëª… ì„ íƒ)'}</h4>${playersB}
    <br><button onclick="${isDoubles ? `setDoubles('${teamA}', '${teamB}')` : `setSingles('${teamA}', '${teamB}')`}">ì„ íƒ ì™„ë£Œ</button>
    <button onclick="closePopup()">ë‹«ê¸°</button>`;
  popup.targetCell = cell;
  popup.style.display = 'block';
}

function setPlayer(btn, teamA, teamB, side, isDouble) {
  const popup = document.getElementById("popup");
  const cell = popup.targetCell;
  const name = btn.innerText;
  let current = cell.innerText.split(" vs ");
  if (current.length === 2) {
    current[side === 'A' ? 0 : 1] = name;
  } else {
    current = side === 'A' ? [name, 'ë¯¸ì •'] : ['ë¯¸ì •', name];
  }
  cell.innerText = current.join(" vs ");
  closePopup();
}

function setDoubles(teamA, teamB) {
  const popup = document.getElementById("popup");
  const cell = popup.targetCell;
  const selectedA = Array.from(popup.querySelectorAll("input[name='teamA']:checked"));
  const selectedB = Array.from(popup.querySelectorAll("input[name='teamB']:checked"));
  if (selectedA.length !== 2 || selectedB.length !== 2) {
    alert("ê° íŒ€ì—ì„œ 2ëª…ì”© ì„ íƒí•´ì£¼ì„¸ìš”"); return;
  }
  const teamAText = selectedA.map(el => el.value).join("/");
  const teamBText = selectedB.map(el => el.value).join("/");
  cell.innerText = `${teamAText} vs ${teamBText}`;

  const card = cell.closest(".match-card");
  const teams = card.querySelector("h3").innerText.split(" VS ");
  const teamKey = `${teams[0]}_vs_${teams[1]}`;
  const rowIndex = [...card.querySelectorAll("tbody tr")].indexOf(cell.parentElement);

  db.ref(`matches/${teamKey}/matchList/${rowIndex}/players`).set(`${teamAText} vs ${teamBText}`);
  popup.style.display = 'none'; // âœ… ì´ í•œ ì¤„ë§Œ!
  // ê²°ê³¼ ì…ë ¥ì°½ ìë™ ì—´ê¸°
  const resultCell = cell.parentElement.querySelector("td:last-child");
  openResultPopup(resultCell);  // âœ… ìë™ ê²°ê³¼ ì…ë ¥ì°½ í˜¸ì¶œ

}

function setSingles(teamA, teamB) {
  const popup = document.getElementById("popup");
  const cell = popup.targetCell;

  const selectedA = popup.querySelector("input[name='teamA']:checked");
  const selectedB = popup.querySelector("input[name='teamB']:checked");

  if (!selectedA || !selectedB) {
    alert("ì–‘ íŒ€ì—ì„œ ê°ê° 1ëª…ì”© ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }

  const playerA = selectedA.value;
  const playerB = selectedB.value;

  cell.innerText = `${playerA} vs ${playerB}`;
 // closePopup();
 popup.style.display = 'none';

  const card = cell.closest(".match-card");
  const teams = card.querySelector("h3").innerText.split(" VS ");
  const teamKey = `${teams[0]}_vs_${teams[1]}`;
  const rowIndex = [...card.querySelectorAll("tbody tr")].indexOf(cell.parentElement);

  // âœ… matchListì˜ players ê°’ë§Œ ìˆ˜ì •
  const playerValue = `${playerA} vs ${playerB}`;
  db.ref(`matches/${teamKey}/matchList/${rowIndex}/players`).set(playerValue);
// ê²°ê³¼ ì…ë ¥ì°½ ìë™ ì—´ê¸°
const resultCell = cell.parentElement.querySelector("td:last-child");
openResultPopup(resultCell);


}

function setPlayer(btn, teamA, teamB, side) {
  const popup = document.getElementById("popup");
  const cell = popup.targetCell;
  const name = btn.innerText;
  let current = cell.innerText.split(" vs ");
  if (current.length === 2) {
    current[side === 'A' ? 0 : 1] = name;
  } else {
    current = side === 'A' ? [name, 'ë¯¸ì •'] : ['ë¯¸ì •', name];
  }
  cell.innerText = current.join(" vs ");
  closePopup();
}

function closePopup() {
  document.getElementById("popup").style.display = 'none';

  // âœ… íŒì—… ë‹«íŒ í›„ ìˆ˜ë™ìœ¼ë¡œ Firebase ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
  db.ref("matches").once("value").then(snapshot => {
    const matches = snapshot.val();
    if (!matches) return;

    document.getElementById("summaryArea").innerHTML = "";

    for (const key in matches) {
      let teamA, teamB, matchList;

      if (matches[key].teamA && matches[key].teamB && matches[key].matchList) {
        ({ teamA, teamB, matchList } = matches[key]);
        matchList = Array.isArray(matchList)
          ? matchList
          : Object.values(matchList || {});  // âœ… ì—¬ê¸° ì¤‘ìš”!!
      } else {
        [teamA, teamB] = key.split("_vs_");
        matchList = [];

        for (const label in matches[key]) {
          const data = matches[key][label];
          matchList.push({
            label,
            players: data?.summaryText?.split("â†’")[0]?.trim() || "ë¯¸ì • vs ë¯¸ì •",
            result: data?.score || "-"
          });
        }
      }

      renderMatchCard(teamA, teamB, matchList);
    }

    calculateTeamResults(); // ìˆœìœ„ ë‹¤ì‹œ ê³„ì‚°
  });
}

function openResultPopup(cell) {
  const popup = document.getElementById("popup");
  const row = cell.parentElement;
  const playerCell = row.children[1];
  const playerText = playerCell.innerText;

  const scores = ["3:2", "3:1", "3:0", "1:3", "2:3", "2:1", "2:0", "1:2", "0:2"];
  const buttons = scores.map(score =>
    `<button onclick="setMatchResult('${score}')">${score}</button>`
  ).join(" ");

  popup.innerHTML = `
    <p style="font-weight:bold; text-align:center;">ê²½ê¸° ê²°ê³¼ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”</p>
    <p style="text-align:center; margin-bottom:10px;">${playerText}</p>
    <div style="text-align:center; margin-bottom:10px;">${buttons}</div>
    <div style="text-align:center;"><button onclick="closePopup()">ë‹«ê¸°</button></div>
  `;
  popup.targetCell = cell;
  popup.style.display = "block";
}

function setMatchResult(score) {
  const popup = document.getElementById("popup");
  const cell = popup.targetCell;
  const card = cell.closest(".match-card");
  const teams = card.querySelector("h3").innerText.split(" VS ");
  const teamKey = `${teams[0]}_vs_${teams[1]}`;
  const rowIndex = [...card.querySelectorAll("tbody tr")].indexOf(cell.parentElement);

  // âœ… Firebaseì— ì €ì¥
  db.ref(`matches/${teamKey}/matchList/${rowIndex}/result`).set(score)
    .then(() => {
      // âœ… ì…€ ì§ì ‘ ë°˜ì˜ (UIë§Œ ê°±ì‹ , summaryArea ì „ì²´ëŠ” ë‹¤ì‹œ ê·¸ë¦¬ì§€ ì•ŠìŒ)
//ì´ì¤„ë¶€í„° ì¶”ê°€
   // ê²½ê¸° ë¼ë²¨ê³¼ ì„ ìˆ˜ ì…€ ì¶”ì¶œ
const row = cell.parentElement;
const playerCell = row.children[1]; // ì„ ìˆ˜ ì´ë¦„ ì…€
const playerText = playerCell.innerText;

// ì ìˆ˜ ë¶„ì„
const [a, b] = score.split(":").map(Number);
if (isNaN(a) || isNaN(b)) return;

// íŒ€ ì´ë¦„ ë¶„ë¦¬ (ë‹¨ì‹: A vs B, ë³µì‹: A/A vs B/B)
let [aNames, bNames] = playerText.split(" vs ");
aNames = aNames.trim();
bNames = bNames.trim();

// ì´ê¸´ ìª½ ì´ë¦„ êµµê²Œ
if (a > b) {
  playerCell.innerHTML = `<strong>${aNames}</strong> vs ${bNames}`;
} else {
  playerCell.innerHTML = `${aNames} vs <strong>${bNames}</strong>`;
}

// ê²°ê³¼ ì…ë ¥ ì…€ì—ëŠ” ì ìˆ˜ë§Œ í‘œì‹œ
cell.innerText = score; // âœ… ì´ ì¤„ì€ ìœ ì§€í•´ë„ ê´œì°®ìŒ (ë‹¤ë¥¸ ì…€ì„)

      popup.style.display = "none";
      calculateTeamResults();
    })
    .catch(err => {
      alert("âŒ ì €ì¥ ì‹¤íŒ¨: " + err.message);
    });
}

function calculateTeamResults() {
  const summaryCards = document.querySelectorAll(".match-card");
  const teamStats = {}; // íŒ€ë³„ í†µê³„

  const allTeamsInMatches = new Set();
  summaryCards.forEach(card => {
    const [teamA, teamB] = card.querySelector("h3").innerText.split(" VS ");
    allTeamsInMatches.add(teamA);
    allTeamsInMatches.add(teamB);
  });

  allTeamsInMatches.forEach(name => {
    teamStats[name] = { win: 0, lose: 0, setDiff: 0 };
  });

  summaryCards.forEach(card => {
    const [teamA, teamB] = card.querySelector("h3").innerText.split(" VS ");
    const rows = card.querySelectorAll("tbody tr");

    let teamAWin = 0, teamBWin = 0;
    let teamASet = 0, teamBSet = 0;

    rows.forEach(row => {
      const result = row.children[2].innerText.trim();
      if (!result.includes(":")) return;
      const [a, b] = result.split(":").map(Number);
      if (isNaN(a) || isNaN(b)) return;

      if (a > b) teamAWin++;
      else teamBWin++;

      teamASet += a;
      teamBSet += b;
    });

    if (teamAWin + teamBWin > 0) {
      if (teamAWin > teamBWin) {
        teamStats[teamA].win++;
        teamStats[teamB].lose++;
      } else {
        teamStats[teamB].win++;
        teamStats[teamA].lose++;
      }

      teamStats[teamA].setDiff += (teamASet - teamBSet);
      teamStats[teamB].setDiff += (teamBSet - teamASet);
    }
  });

  const singles = +document.getElementById("singlesCnt").value;
const doubles = +document.getElementById("doublesCnt").value;
const totalGames = singles + doubles;

const sorted = Object.entries(teamStats).sort((a, b) => {
  if (totalGames % 2 === 0) {
    // ë‹¨ì‹+ë³µì‹ ê²½ê¸° ìˆ˜ê°€ ì§ìˆ˜ì¼ ê²½ìš° â†’ ì„¸íŠ¸ë“ì‹¤ ê¸°ì¤€
    return b[1].setDiff - a[1].setDiff;
  } else {
    // í™€ìˆ˜ì¼ ê²½ìš° â†’ ìŠ¹ìˆ˜ > ì„¸íŠ¸ë“ì‹¤ ê¸°ì¤€
    if (b[1].win !== a[1].win) return b[1].win - a[1].win;
    return b[1].setDiff - a[1].setDiff;
  }
});


  let html = '<h3 style="text-align:center; margin-top:40px;">ğŸ“Š íŒ€ë³„ ê²½ê¸°ê²°ê³¼ ë° ìˆœìœ„í‘œ</h3>';
  html += '<div class="scroll-table"><table><thead><tr><th>íŒ€ëª…</th><th>ìŠ¹</th><th>íŒ¨</th><th>ì„¸íŠ¸ë“ì‹¤</th><th>ìˆœìœ„</th></tr></thead><tbody>';

  sorted.forEach(([team, stat], idx) => {
    html += `<tr><td>${team}</td><td>${stat.win}</td><td>${stat.lose}</td><td>${stat.setDiff}</td><td>${idx + 1}</td></tr>`;
  });

  html += '</tbody></table></div>';
  document.getElementById("rankingArea").innerHTML = html;
}




loadTeams().then(() => {
  listenToMatchUpdates();  // âœ… ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì‹œì‘
});


function convertMatchListToArray() {
  const matchesRef = db.ref("matches");

  matchesRef.once("value").then(snapshot => {
    const matches = snapshot.val();
    if (!matches) return;

    const updates = {};

    for (const key in matches) {
      const match = matches[key];
      const originalList = match.matchList;

      // ì´ë¯¸ ë°°ì—´ì´ë©´ íŒ¨ìŠ¤
      if (Array.isArray(originalList)) continue;

      // ê°ì²´ë¼ë©´ ë°°ì—´ë¡œ ë³€í™˜
      const newList = [];
      for (const label in originalList) {
        const item = originalList[label];
        newList.push({
          label: label,
          players: item.players || "ë¯¸ì • vs ë¯¸ì •",
          result: item.result || "-"
        });
      }

      updates[`matches/${key}/matchList`] = newList;
    }

    db.ref().update(updates)
      .then(() => alert("âœ… matchListë¥¼ ë°°ì—´ë¡œ ë³€í™˜ ì™„ë£Œ"))
      .catch(err => alert("âŒ ë³€í™˜ ì¤‘ ì˜¤ë¥˜: " + err.message));
  });
}

function listenToMatchUpdates() {
  db.ref("matches").on("value", snapshot => {
    const matches = snapshot.val();
    if (!matches) return;

    document.getElementById("summaryArea").innerHTML = "";

    for (const key in matches) {
      let teamA, teamB, matchList;

      if (matches[key].teamA && matches[key].teamB && matches[key].matchList) {
        ({ teamA, teamB, matchList } = matches[key]);
        matchList = Array.isArray(matchList)
          ? matchList
          : Object.values(matchList || {});
      } else {
        [teamA, teamB] = key.split("_vs_");
        matchList = [];

        for (const label in matches[key]) {
          const data = matches[key][label];
          matchList.push({
            label,
            players: data?.summaryText?.split("â†’")[0]?.trim() || "ë¯¸ì • vs ë¯¸ì •",
            result: data?.score || "-"
          });
        }
      }

      renderMatchCard(teamA, teamB, matchList);
    }

    calculateTeamResults(); // âœ… ìˆœìœ„í‘œë„ í•¨ê»˜ ê°±ì‹ 
  });
}

function saveAsImage() {
  const target = document.getElementById("captureArea");

  html2canvas(target).then(canvas => {
    const link = document.createElement("a");
    link.download = `ë‹¨ì²´ì „_ëŒ€ì§„ê²°ê³¼_${new Date().toISOString().slice(0, 10)}.png`;
    link.href = canvas.toDataURL();
    link.click();
  });
}
// í˜ì´ì§€ ë¡œë“œì‹œ ì‚¬ìš©ë²• íŒì—… ìë™ í‘œì‹œ
window.addEventListener("DOMContentLoaded", () => {
  if (typeof window.ref !== "function") {
    alert("Firebase ì´ˆê¸°í™”ê°€ ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }

  loadTeams().then(() => {
    listenToMatchUpdates();
  });
});


// ë‹«ê¸° ë²„íŠ¼ ë™ì‘
document.getElementById("closeUsageModal").addEventListener("click", () => {
  document.getElementById("usageModal").style.display = "none";
});

</script>

  <div id="matchArea"></div>
</body>

</html>
