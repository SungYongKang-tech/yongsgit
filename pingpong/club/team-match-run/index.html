<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‹¨ì²´ì „ ì§„í–‰</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body { font-family:'Segoe UI', sans-serif; padding:20px; background:#f5f7fa }
    h2 { text-align:center; color:#0d47a1; margin:10px 0 30px }
    .config { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:20px }
    select, button { padding:6px 14px; font-size:15px; cursor:pointer }
    table { border-collapse:collapse; width:100%; max-width:720px; margin:0 auto }
    th, td { border:1px solid #888; padding:8px 12px; text-align:center }
    th { background:#e3f2fd }
    .match-card { border:3px solid #0d47a1; padding:20px; margin:30px auto; max-width:820px; background:#fff; border-radius:14px; box-shadow:2px 2px 10px rgba(0,0,0,0.12) }
    .match-card h3 { text-align:center; margin-bottom:20px; font-size:20px; color:#0d47a1 }
    .popup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; border:1px solid #999; padding:20px; box-shadow:0 0 10px rgba(0,0,0,0.2); z-index:9999; max-width:90vw }
    .popup button { margin:5px; }
    .scroll-table { overflow-x:auto; border:1px solid #ccc; border-radius:8px; margin:20px auto; width:100%; max-width:820px; }
    .scroll-table table { border-collapse:collapse; width:100%; min-width:500px; background:#fff; }
    .scroll-table th, .scroll-table td { border:1px solid #888; padding:16px 10px; text-align:center; font-size:16px; white-space:nowrap; }
    .scroll-table th:first-child, .scroll-table td:first-child { background:#ffe082; font-weight:bold; }
  </style>
</head>
<body>
  <div id="teamListArea" style="margin-bottom:30px;"></div>
  <h2>ë‹¨ì²´ì „ ì§„í–‰</h2>
  <div class="config">
    ë‹¨ì‹
    <select id="singlesCnt">
      <option value="0">0ê²½ê¸°</option>
      <option value="1">1ê²½ê¸°</option>
      <option value="2">2ê²½ê¸°</option>
      <option value="3" selected>3ê²½ê¸°</option>
      <option value="4">4ê²½ê¸°</option>
      <option value="5">5ê²½ê¸°</option>
    </select>
    ë³µì‹
    <select id="doublesCnt">
      <option value="0">0ê²½ê¸°</option>
      <option value="1">1ê²½ê¸°</option>
      <option value="2" selected>2ê²½ê¸°</option>
      <option value="3">3ê²½ê¸°</option>
    </select>

    <button onclick="manualMatch()">ëŒ€ì§„í‘œ ìˆ˜ë™ ìƒì„±</button>
    <button onclick="autoMatch()">ëŒ€ì§„í‘œ ìë™ ìƒì„±</button>
    <button onclick="saveAsImage()">ëŒ€ì§„ê²°ê³¼ ì €ì¥</button>
  </div>

  <div id="popup" class="popup" style="display:none;"></div>
  <div id="captureArea">
    <div id="summaryArea"></div>
    <div id="rankingArea" style="margin-top:40px;"></div>
  </div>

<script>
/* ---------------- Firebase ì´ˆê¸°í™” ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyA-tp3iJ8-n0yrrd8lwE1IgOdsmDqyh69k",
  authDomain: "koen-teamleague.firebaseapp.com",
  projectId: "koen-teamleague",
  storageBucket: "koen-teamleague.appspot.com",
  messagingSenderId: "487164547059",
  appId: "1:487164547059:web:658a10c8bfe7272ca78c86",
  databaseURL: "https://koen-teamleague-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------------- ì „ì—­ ìƒíƒœ ---------------- */
let teamNames = [], teamData = {};
let autoMode = -1; // ì²« í´ë¦­=ê°•ìë¼ë¦¬ (0: ê°•ìë¼ë¦¬, 1: ì•½ìë¼ë¦¬, 2: ê°•ì•½ í˜¼í•©)

/* ---------------- ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ---------------- */
function checkPassword() {
  const pw = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
  if (pw === "7910") return true;
  alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
  return false;
}

/* ---------------- ë¡œê·¸ì¸ ì²˜ë¦¬ ---------------- */
async function requireAuth() {
  const u = firebase.auth().currentUser;
  if (u) return u;
  await firebase.auth().signInAnonymously();
  return new Promise(resolve => {
    const unsub = firebase.auth().onAuthStateChanged(user => {
      if (user) { unsub(); resolve(user); }
    });
  });
}

firebase.auth().onAuthStateChanged(async (user) => {
  if (!user) {
    try { await firebase.auth().signInAnonymously(); }
    catch (e) { console.error("ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨:", e); }
    return;
  }
  await loadTeams();
  listenToMatchUpdates();
});

/* ---------------- íŒ€ ë¡œë“œ ---------------- */
function loadTeams() {
  return db.ref("teams").once("value").then(snap => {
    const raw = snap.val();
    teamData = {};
    teamNames = [];
    if (!raw) { alert("íŒ€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íŒ€ì„ êµ¬ì„±í•´ì£¼ì„¸ìš”."); return false; }
    Object.values(raw).forEach(team => {
      teamData[team.teamName] = team; // team.players: [{name, level}] (level: ë¶€ìˆ˜)
      teamNames.push(team.teamName);
    });
    renderTeamList();
    return true;
  });
}

function renderTeamList() {
  let html = '<h3 style="text-align:center">ğŸ“‹ íŒ€ êµ¬ì„± í˜„í™©</h3><table><tr><th>íŒ€ëª…</th><th>íŒ€ì›</th></tr>';
  teamNames.forEach(team => {
    const players = teamData[team].players.map(p => `${p.name}(${p.level})`).join(', ');
    html += `<tr><td>${team}</td><td>${players}</td></tr>`;
  });
  html += '</table>';
  document.getElementById('teamListArea').innerHTML = html;
}

/* ---------------- ìˆ˜ë™ ëŒ€ì§„ ìƒì„± ---------------- */
async function manualMatch() {
  if (!checkPassword()) return;
  const ok = await loadTeams();
  if (!ok || teamNames.length === 0) return;
  await generateManualMatches();
}

async function generateManualMatches() {
  await requireAuth();
  await db.ref("matches").remove();

  const singles = +document.getElementById("singlesCnt").value;
  const doubles = +document.getElementById("doublesCnt").value;
  const updates = {};
  document.getElementById("summaryArea").innerHTML = "";

  for (let i = 0; i < teamNames.length; i++) {
    for (let j = i + 1; j < teamNames.length; j++) {
      const matchList = [];
      for (let s = 0; s < singles; s++)
        matchList.push({ label: `${s + 1}ë‹¨`, players: "ë¯¸ì • vs ë¯¸ì •", result: "-" });
      for (let d = 0; d < doubles; d++)
        matchList.push({ label: `${d + 1}ë³µ`, players: "ë¯¸ì •/ë¯¸ì • vs ë¯¸ì •/ë¯¸ì •", result: "-" });

      const key = `${teamNames[i]}_vs_${teamNames[j]}`;
      updates[`matches/${key}`] = { teamA: teamNames[i], teamB: teamNames[j], matchList };
      renderMatchCard(teamNames[i], teamNames[j], matchList);
    }
  }
  await db.ref().update(updates);
}

/* ---------------- ìë™ ëŒ€ì§„ ìƒì„± ---------------- */
async function autoMatch() {
  if (!checkPassword()) return;
  const ok = await loadTeams();
  if (!ok || teamNames.length === 0) return;

  autoMode = (autoMode + 1) % 3;
  const modeNames = ["ê°•ìë¼ë¦¬", "ì•½ìë¼ë¦¬", "ê°•ì•½ í˜¼í•©(ë‹¨ì‹ì€ ê°•ì)"];
  alert(`ìë™ ìƒì„± ëª¨ë“œ: ${modeNames[autoMode]}`);

  await requireAuth();
  await db.ref("matches").remove();
  const singles = +document.getElementById("singlesCnt").value;
  const doubles = +document.getElementById("doublesCnt").value;
  const updates = {};
  document.getElementById("summaryArea").innerHTML = "";

  teamNames.forEach((teamA, i) => {
    for (let j = i + 1; j < teamNames.length; j++) {
      const teamB = teamNames[j];

      let playersA = [...teamData[teamA].players];
      let playersB = [...teamData[teamB].players];

      // ê°•ì ê¸°ì¤€: ë¶€ìˆ˜ê°€ ë‚®ì„ìˆ˜ë¡ ê°•ì â†’ ì˜¤ë¦„ì°¨ìˆœì´ ê°•ììˆœ
      if (autoMode === 0) { // ê°•ìë¼ë¦¬
        playersA.sort((a,b) => a.level - b.level);
        playersB.sort((a,b) => a.level - b.level);
      } else if (autoMode === 1) { // ì•½ìë¼ë¦¬
        playersA.sort((a,b) => b.level - a.level);
        playersB.sort((a,b) => b.level - a.level);
      } else {                 // ê°•ì•½ í˜¼í•©: ë‹¨ì‹ì€ ê°•ìë¼ë¦¬, ë³µì‹ë§Œ ê°•ì•½ í˜¼í•©
        var singlesA = [...playersA].sort((a,b) => a.level - b.level);
        var singlesB = [...playersB].sort((a,b) => a.level - b.level);
        playersA.sort((a,b) => a.level - b.level); // ë³µì‹ì—ì„œ AëŠ” ê°•ììˆœ
        playersB.sort((a,b) => b.level - a.level); // ë³µì‹ì—ì„œ BëŠ” ì•½ììˆœ
      }

      const matchList = [];

      // ë‹¨ì‹: í•­ìƒ ê°•ììˆœ vs ê°•ììˆœ (í˜¼í•© ëª¨ë“œë„ ë™ì¼)
      for (let s = 0; s < singles; s++) {
        const aP = (autoMode === 2 ? singlesA : playersA)[s % playersA.length];
        const bP = (autoMode === 2 ? singlesB : playersB)[s % playersB.length];
        matchList.push({
          label: `${s + 1}ë‹¨`,
          players: `${aP.name}(${aP.level}) vs ${bP.name}(${bP.level})`,
          result: "-"
        });
      }

      // ë³µì‹: ë‘ ì„ ìˆ˜ í•©ì´ ìƒëŒ€íŒ€ê³¼ ê°€ì¥ ë¹„ìŠ·í•˜ë„ë¡ ë§¤ì¹­
      const doublesPairs = pickDoublesPairs(playersA, playersB, doubles, autoMode);
      doublesPairs.forEach((pair, idx) => {
        const {a1,a2,b1,b2} = pair;
        matchList.push({
          label: `${idx + 1}ë³µ`,
          players: `${a1.name}(${a1.level})/${a2.name}(${a2.level}) vs ${b1.name}(${b1.level})/${b2.name}(${b2.level})`,
          result: "-"
        });
      });

      const key = `${teamA}_vs_${teamB}`;
      updates[`matches/${key}`] = { teamA, teamB, matchList };
      renderMatchCard(teamA, teamB, matchList);
    }
  });
  await db.ref().update(updates);
}

/* ---- ë³µì‹ ì¡°í•© ìœ í‹¸: í•©ì´ ë¹„ìŠ·(ê°•ì/ì•½ì/í˜¼í•© ëª¨ë“œ ë°˜ì˜), ì¤‘ë³µ ìµœì†Œí™” ---- */
function pickDoublesPairs(playersA, playersB, need, mode) {
  const usedA = new Set(), usedB = new Set();
  const res = [];
  const isMixed = (p) => Math.abs(p[0].level - p[1].level) >= 2; // ì°¨ì´ 2 ì´ìƒì´ë©´ ê°•ì•½ í˜¼í•©ìœ¼ë¡œ ê°„ì£¼

  for (let k = 0; k < need; k++) {
    // ì‚¬ìš©ë˜ì§€ ì•Šì€ ì„ ìˆ˜ë§Œìœ¼ë¡œ ê°€ëŠ¥í•œ í˜ì–´ ìƒì„±
    let pairsA = allPairs(playersA, usedA);
    let pairsB = allPairs(playersB, usedB);

    // ëª¨ë“œë³„ í˜ì–´ ì„ í˜¸ë„ ì •ë ¬
    const sortStrong = (x,y)=> (x.sum - y.sum);         // í•© ì‘ì„ìˆ˜ë¡ ê°•í•¨
    const sortWeak   = (x,y)=> (y.sum - x.sum);         // í•© í´ìˆ˜ë¡ ì•½í•¨
    const sortMixed  = (x,y)=> (y.diff - x.diff || x.sum - y.sum); // ì°¨ì´ í° í˜ì–´ ìš°ì„ , ë‹¤ìŒ í•©ì´ ë¹„ìŠ·í•œ ìª½

    if (mode === 0) { pairsA.sort(sortStrong); pairsB.sort(sortStrong); }
    else if (mode === 1) { pairsA.sort(sortWeak); pairsB.sort(sortWeak); }
    else { // í˜¼í•©: í˜¼í•© í˜ì–´ë¥¼ ìš°ì„  í•„í„°
      const mixA = pairsA.filter(p=>isMixed(p.pair));
      const mixB = pairsB.filter(p=>isMixed(p.pair));
      if (mixA.length) pairsA = mixA;
      if (mixB.length) pairsB = mixB;
      pairsA.sort(sortMixed); pairsB.sort(sortMixed);
    }

    if (!pairsA.length || !pairsB.length) break;

    // Aì—ì„œ í•˜ë‚˜ ë½‘ê³  Bì—ì„œ í•© ì°¨ì´ê°€ ê°€ì¥ ê°€ê¹Œìš´ í˜ì–´ ì„ íƒ
    let chosenA = null, chosenB = null, bestDiff = Infinity;
    for (const a of pairsA) {
      for (const b of pairsB) {
        // ëª¨ë“œ 0/1ì—ì„œëŠ” êµ³ì´ ì¶”ê°€ ì œì•½ X, ëª¨ë“œ 2ì—ì„œëŠ” ì„œë¡œ í˜¼í•© ì„±í–¥ ë¹„ìŠ·í•˜ë„ë¡(ë‘˜ ë‹¤ í˜¼í•©ì´ë©´ ê°€ì‚°ì )
        const base = Math.abs(a.sum - b.sum);
        const bonus = (mode===2 && isMixed(a.pair) && isMixed(b.pair)) ? -0.5 : 0; // í˜¼í•©-í˜¼í•©ì´ë©´ ì•½ê°„ ê°€ì‚°
        const score = base + bonus;
        if (score < bestDiff) { bestDiff = score; chosenA = a; chosenB = b; }
      }
    }

    if (!chosenA || !chosenB) break;

    // ê²°ê³¼ì— ì±„íƒí•˜ê³  ì‚¬ìš© ì²˜ë¦¬
    const [a1,a2] = chosenA.pair, [b1,b2] = chosenB.pair;
    res.push({ a1, a2, b1, b2 });
    usedA.add(a1.name); usedA.add(a2.name);
    usedB.add(b1.name); usedB.add(b2.name);
  }

  // í•„ìš”í•œ ìˆ˜ë¥¼ ëª» ì±„ì› ìœ¼ë©´ ì”ì—¬ ì¸ì›ìœ¼ë¡œ ë¼ìš´ë“œë¡œë¹ˆ ë³´ì¶©
  while (res.length < need) {
    const a1 = firstUnused(playersA, usedA) ?? playersA[res.length % playersA.length];
    usedA.add(a1.name);
    const a2 = firstUnused(playersA, usedA) ?? playersA[(res.length+1) % playersA.length];
    usedA.add(a2.name);

    const b1 = firstUnused(playersB, usedB) ?? playersB[res.length % playersB.length];
    usedB.add(b1.name);
    const b2 = firstUnused(playersB, usedB) ?? playersB[(res.length+1) % playersB.length];
    usedB.add(b2.name);

    res.push({ a1, a2, b1, b2 });
  }
  return res;
}

function allPairs(players, used) {
  const out = [];
  for (let i=0;i<players.length;i++) {
    if (used.has(players[i].name)) continue;
    for (let j=i+1;j<players.length;j++) {
      if (used.has(players[j].name)) continue;
      const p1 = players[i], p2 = players[j];
      out.push({ pair:[p1,p2], sum: p1.level + p2.level, diff: Math.abs(p1.level - p2.level) });
    }
  }
  // ë§Œì•½ ì‚¬ìš© ì•ˆëœ ì¸ì›ì´ 1ëª… ì´í•˜ë¼ë©´, ì¬ì‚¬ìš© í—ˆìš© í˜ì–´ë„ ìƒì„±(ìµœì†Œ ê¸°ëŠ¥ ë³´ì¥)
  if (!out.length && players.length >= 2) {
    for (let i=0;i<players.length;i++) {
      for (let j=i+1;j<players.length;j++) {
        const p1 = players[i], p2 = players[j];
        out.push({ pair:[p1,p2], sum: p1.level + p2.level, diff: Math.abs(p1.level - p2.level) });
      }
    }
  }
  return out;
}

function firstUnused(players, used) {
  for (const p of players) if (!used.has(p.name)) return p;
  return null;
}

/* ---------------- ê²½ê¸° ì¹´ë“œ ë Œë” + ìŠ¹ì êµµê²Œ ---------------- */
function renderMatchCard(teamA, teamB, matchList) {
  let html = `<div class='match-card'><h3>${teamA} VS ${teamB}</h3><table>`;
  html += `<thead><tr><th>ê²½ê¸°</th><th>ì¶œì „ ì„ ìˆ˜</th><th>ê²°ê³¼</th></tr></thead><tbody>`;

  matchList.forEach((match) => {
    let playerHTML = match.players;
    const [a, b] = (match.result || "").split(":").map(Number);
    if (!isNaN(a) && !isNaN(b) && match.players.includes(" vs ")) {
      let [left, right] = match.players.split(" vs ");
      left = left.trim(); right = right.trim();
      if (a > b) playerHTML = `<strong>${left}</strong> vs ${right}`;
      else if (b > a) playerHTML = `${left} vs <strong>${right}</strong>`;
    }

    html += `<tr>
      <td>${match.label}</td>
      <td onclick="openPlayerPopup('${teamA}', '${teamB}', this)">${playerHTML}</td>
      <td onclick="openResultPopup(this)" style="cursor:pointer;">${match.result || "-"}</td>
    </tr>`;
  });

  html += "</tbody></table></div>";
  document.getElementById("summaryArea").innerHTML += html;
}

/* ---------------- ì„ ìˆ˜ ì„ íƒ íŒì—… ---------------- */
function openPlayerPopup(teamA, teamB, cell) {
  const popup = document.getElementById("popup");
  const isDoubles = cell.innerText.includes("/");
  const inputType = isDoubles ? 'checkbox' : 'radio';

  const playersA = teamData[teamA].players.map(p =>
    `<label><input type='${inputType}' name='teamA' value="${p.name}(${p.level})"> ${p.name}(${p.level})</label><br>`).join('');
  const playersB = teamData[teamB].players.map(p =>
    `<label><input type='${inputType}' name='teamB' value="${p.name}(${p.level})"> ${p.name}(${p.level})</label><br>`).join('');

  popup.innerHTML = `
    <h4>${teamA} ${isDoubles ? '(2ëª… ì„ íƒ)' : '(1ëª… ì„ íƒ)'}</h4>${playersA}
    <hr>
    <h4>${teamB} ${isDoubles ? '(2ëª… ì„ íƒ)' : '(1ëª… ì„ íƒ)'}</h4>${playersB}
    <div style="margin-top:10px; text-align:center;">
      <button onclick="${isDoubles ? `setDoubles('${teamA}', '${teamB}')` : `setSingles('${teamA}', '${teamB}')`}">ì„ íƒ ì™„ë£Œ</button>
      <button onclick="closePopup()">ë‹«ê¸°</button>
    </div>`;
  popup.targetCell = cell;
  popup.style.display = 'block';
}

async function setDoubles(teamA, teamB) {
  await requireAuth();
  const popup = document.getElementById("popup");
  const cell = popup.targetCell;

  const selectedA = Array.from(popup.querySelectorAll("input[name='teamA']:checked"));
  const selectedB = Array.from(popup.querySelectorAll("input[name='teamB']:checked"));
  if (selectedA.length !== 2 || selectedB.length !== 2) { alert("ê° íŒ€ì—ì„œ 2ëª…ì”© ì„ íƒí•´ì£¼ì„¸ìš”"); return; }

  const teamAText = selectedA.map(el => el.value).join("/");
  const teamBText = selectedB.map(el => el.value).join("/");
  cell.innerText = `${teamAText} vs ${teamBText}`;

  // DB ë°˜ì˜
  const card = cell.closest(".match-card");
  const [aTeam, bTeam] = card.querySelector("h3").innerText.split(" VS ");
  const teamKey = `${aTeam}_vs_${bTeam}`;
  const rowIndex = [...card.querySelectorAll("tbody tr")].indexOf(cell.parentElement);
  await db.ref(`matches/${teamKey}/matchList/${rowIndex}/players`).set(`${teamAText} vs ${teamBText}`);

  popup.style.display = 'none';
}

async function setSingles(teamA, teamB) {
  await requireAuth();
  const popup = document.getElementById("popup");
  const cell = popup.targetCell;

  const selectedA = popup.querySelector("input[name='teamA']:checked");
  const selectedB = popup.querySelector("input[name='teamB']:checked");
  if (!selectedA || !selectedB) { alert("ì–‘ íŒ€ì—ì„œ ê°ê° 1ëª…ì”© ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

  cell.innerText = `${selectedA.value} vs ${selectedB.value}`;

  // DB ë°˜ì˜
  const card = cell.closest(".match-card");
  const [aTeam, bTeam] = card.querySelector("h3").innerText.split(" VS ");
  const teamKey = `${aTeam}_vs_${bTeam}`;
  const rowIndex = [...card.querySelectorAll("tbody tr")].indexOf(cell.parentElement);
  await db.ref(`matches/${teamKey}/matchList/${rowIndex}/players`).set(`${selectedA.value} vs ${selectedB.value}`);

  popup.style.display = 'none';
}

function closePopup() {
  document.getElementById("popup").style.display = 'none';
}

/* ---------------- ê²°ê³¼ ì…ë ¥ íŒì—… ---------------- */
function openResultPopup(cell) {
  const popup = document.getElementById("popup");
  const playerText = cell.parentElement.children[1].innerText;
  const scores = ["3:2","3:1","3:0","0:3","1:3","2:3","2:1","2:0","1:2","0:2","0:0"];
  const buttons = scores.map(score =>
    `<button onclick="setMatchResult('${score}')">${score}</button>`).join(" ");
  popup.innerHTML = `
    <p style="font-weight:bold; text-align:center;">ê²½ê¸° ê²°ê³¼ ì…ë ¥</p>
    <p style="text-align:center;">${playerText}</p>
    <div style="text-align:center; margin:10px 0;">${buttons}</div>
    <div style="text-align:center;"><button onclick="closePopup()">ë‹«ê¸°</button></div>`;
  popup.targetCell = cell;
  popup.style.display = "block";
}

async function setMatchResult(score) {
  await requireAuth();
  const popup = document.getElementById("popup");
  const cell = popup.targetCell;

  // UI ë°˜ì˜ + ìŠ¹ì êµµê²Œ
  const row = cell.parentElement;
  const playerCell = row.children[1];
  const playerText = playerCell.innerText;
  const [a, b] = score.split(":").map(Number);

  if (!isNaN(a) && !isNaN(b) && playerText.includes(" vs ")) {
    let [left, right] = playerText.split(" vs ");
    left = left.trim(); right = right.trim();
    if (a > b) playerCell.innerHTML = `<strong>${left}</strong> vs ${right}`;
    else if (b > a) playerCell.innerHTML = `${left} vs <strong>${right}</strong>`;
    else playerCell.innerHTML = `${left} vs ${right}`;
  }
  cell.innerText = score;

  // DB ë°˜ì˜
  const card = cell.closest(".match-card");
  const [teamA, teamB] = card.querySelector("h3").innerText.split(" VS ");
  const teamKey = `${teamA}_vs_${teamB}`;
  const rowIndex = [...card.querySelectorAll("tbody tr")].indexOf(cell.parentElement);
  await db.ref(`matches/${teamKey}/matchList/${rowIndex}/result`).set(score);

  popup.style.display = "none";
  calculateTeamResults();
}

/* ---------------- ìˆœìœ„ ê³„ì‚° ---------------- */
function calculateTeamResults() {
  const cards = document.querySelectorAll(".match-card");
  const stats = {};
  const allTeams = new Set();

  cards.forEach(card => {
    const [teamA, teamB] = card.querySelector("h3").innerText.split(" VS ");
    allTeams.add(teamA); allTeams.add(teamB);
  });

  allTeams.forEach(name => stats[name] = { win:0, lose:0, setDiff:0 });

  cards.forEach(card => {
    const [teamA, teamB] = card.querySelector("h3").innerText.split(" VS ");
    const rows = card.querySelectorAll("tbody tr");
    let teamAWin=0, teamBWin=0, teamASet=0, teamBSet=0;

    rows.forEach(row => {
      const result = row.children[2].innerText.trim();
      if (!result.includes(":")) return;
      const [a,b] = result.split(":").map(Number);
      if (a>b) teamAWin++; else if (b>a) teamBWin++;
      teamASet += a; teamBSet += b;
    });

    stats[teamA].win += teamAWin;
    stats[teamA].lose += teamBWin;
    stats[teamA].setDiff += teamASet - teamBSet;

    stats[teamB].win += teamBWin;
    stats[teamB].lose += teamAWin;
    stats[teamB].setDiff += teamBSet - teamASet;
  });

  const singles = +document.getElementById("singlesCnt").value;
  const doubles = +document.getElementById("doublesCnt").value;
  const totalGames = singles + doubles;

  const sorted = Object.entries(stats).sort((a,b)=>{
    if (totalGames % 2 === 0) { // ì§ìˆ˜ ê²½ê¸°: ì„¸íŠ¸ë“ì‹¤ ìš°ì„ 
      return b[1].setDiff - a[1].setDiff;
    } else {                    // í™€ìˆ˜ ê²½ê¸°: ìŠ¹ìˆ˜ â†’ ì„¸íŠ¸ë“ì‹¤
      if (b[1].win !== a[1].win) return b[1].win - a[1].win;
      return b[1].setDiff - a[1].setDiff;
    }
  });

  let html = '<h3 style="text-align:center">ğŸ“Š íŒ€ë³„ ê²½ê¸°ê²°ê³¼ ë° ìˆœìœ„í‘œ</h3>';
  html += '<div class="scroll-table"><table><thead><tr><th>íŒ€ëª…</th><th>ìŠ¹</th><th>íŒ¨</th><th>ì„¸íŠ¸ë“ì‹¤</th><th>ìˆœìœ„</th></tr></thead><tbody>';
  sorted.forEach(([team, stat], idx)=>{
    html += `<tr><td>${team}</td><td>${stat.win}</td><td>${stat.lose}</td><td>${stat.setDiff}</td><td>${idx+1}</td></tr>`;
  });
  html += '</tbody></table></div>';
  document.getElementById("rankingArea").innerHTML = html;
}

/* ---------------- ì´ë¯¸ì§€ ì €ì¥ ---------------- */
function saveAsImage() {
  html2canvas(document.getElementById("captureArea")).then(canvas => {
    const link = document.createElement("a");
    link.download = `ë‹¨ì²´ì „_ëŒ€ì§„ê²°ê³¼_${new Date().toISOString().slice(0,10)}.png`;
    link.href = canvas.toDataURL();
    link.click();
  });
}

/* ---------------- ì‹¤ì‹œê°„ Firebase ë¦¬ìŠ¤ë„ˆ ---------------- */
function listenToMatchUpdates() {
  db.ref("matches").on("value", snapshot => {
    const matches = snapshot.val();
    if (!matches) return;
    document.getElementById("summaryArea").innerHTML = "";
    for (const key in matches) {
      const m = matches[key];
      const safeList = Array.isArray(m.matchList) ? m.matchList : Object.values(m.matchList || {});
      renderMatchCard(m.teamA, m.teamB, safeList);
    }
    calculateTeamResults();
  });
}
</script>
</body>
</html>
