<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>단체전 진행</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family:'Segoe UI', sans-serif; padding:20px; background:#f5f7fa }
    h2 { text-align:center; color:#0d47a1; margin:10px 0 30px }
    .config { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:20px }
    select, button { padding:6px 14px; font-size:15px }
    table { border-collapse:collapse; width:100%; max-width:600px; margin:0 auto }
    th, td { border:1px solid #888; padding:8px 12px; text-align:center }
    th { background:#e3f2fd }
    .match-card { border:3px solid #0d47a1; padding:20px; margin:30px auto; max-width:720px; background:#fff; border-radius:14px; box-shadow:2px 2px 10px rgba(0,0,0,0.12) }
    .match-card h3 { text-align:center; margin-bottom:20px; font-size:20px; color:#0d47a1 }
    .match-card table { width:100%; border-collapse:collapse }
    .match-card th, .match-card td { border:1px solid #aaa; padding:10px; text-align:center }
    .match-card th { background-color:#e3f2fd }
    .draggable { cursor:move; }
  </style>
</head>
<body>
  <div id="teamListArea" style="margin-bottom:30px;"></div>
  <h2>단체전 진행</h2>
  <div class="config">
    단식 <select id="singlesCnt">
      <option value="1">1경기</option><option value="2">2경기</option>
      <option value="3" selected>3경기</option><option value="4">4경기</option>
    </select>
    복식 <select id="doublesCnt">
      <option value="0">0경기</option><option value="1">1경기</option>
      <option value="2" selected>2경기</option><option value="3">3경기</option>
    </select>
    <button onclick="renderAllMatchesFromFirebase()">대진표 생성</button>
  </div>

  <script>
   


    const firebaseConfig = {
      apiKey: "AIzaSyA-tp3iJ8-n0yrrd8lwE1IgOdsmDqyh69k",
      authDomain: "koen-teamleague.firebaseapp.com",
      projectId: "koen-teamleague",
      storageBucket: "koen-teamleague.firebasestorage.app",
      messagingSenderId: "487164547059",
      appId: "1:487164547059:web:658a10c8bfe7272ca78c86",
      databaseURL: "https://koen-teamleague-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let teamNames = [], teamData = {};
    db.ref("teams").once("value").then(snap => {
      if (!snap.exists()) { alert("⚠️ 저장된 팀이 없습니다!"); return; }
      const raw = snap.val();
      teamData = {}; teamNames = [];
      Object.values(raw).forEach(team => {
        teamData[team.teamName] = team;
        teamNames.push(team.teamName);
      });
      renderTeamList(); 
      alert(`✅ ${teamNames.length}개 팀을 불러왔습니다.`);
    });

    function renderTeamList() {
      let html = '<h3 style="text-align:center; color:#333;">📋 팀 구성 현황</h3>';
      html += '<table><tr><th>팀명</th><th>팀원 목록</th></tr>';
      Object.values(teamData).forEach(team => {
        const playerNames = team.players.map(p => `${getShortName(p.name)}(${p.level})`).join(', ');

        html += `<tr><td><strong>${team.teamName}</strong></td><td>${playerNames}</td></tr>`;
      });
      html += '</table>';
      document.getElementById('teamListArea').innerHTML = html;
    }

    function renderAllMatchesFromFirebase() {
      if (!teamNames || teamNames.length < 2) { alert("⚠️ 팀 데이터가 부족합니다."); return; }
      const singles = parseInt(document.getElementById("singlesCnt").value);
      const doubles = parseInt(document.getElementById("doublesCnt").value);
      const totalMatches = [];
      for (let i = 0; i < teamNames.length; i++) {
        for (let j = i + 1; j < teamNames.length; j++) {
          const teamA = teamNames[i], teamB = teamNames[j];
          if (!teamData[teamA] || !teamData[teamB]) continue;
          totalMatches.push({ teamA, teamB });
        }
      }
      const container = document.getElementById("summaryArea");
      container.innerHTML = "";
      totalMatches.forEach(match => {
        const matchList = [];
        for (let i = 1; i <= singles; i++) {
          const playerA = getPlayerTag(teamData[match.teamA], i - 1);
          const playerB = getPlayerTag(teamData[match.teamB], i - 1);
          matchList.push({ label: `${i}단`, players: `${playerA} vs ${playerB}`, result: "미입력" });
        }
        for (let i = 1; i <= doubles; i++) {
          const idx = singles + (i - 1) * 2;
          const pairA = `${getPlayerTag(teamData[match.teamA], idx)}/${getPlayerTag(teamData[match.teamA], idx + 1)}`;
          const pairB = `${getPlayerTag(teamData[match.teamB], idx)}/${getPlayerTag(teamData[match.teamB], idx + 1)}`;
          matchList.push({ label: `${i}복`, players: `${pairA} vs ${pairB}`, result: "미입력" });
        }
        renderMatchCard(match.teamA, match.teamB, matchList);
      });
    }

    function getPlayerTag(team, index) {
      if (!team || !team.players || !team.players[index]) return "미정";
      const p = team.players[index];
      return `<span class='draggable' draggable='true'>${p.name}(${p.level})</span>`;
    }

    function renderMatchCard(teamA, teamB, matchList) {
      const container = document.getElementById("summaryArea");
      let html = `<div class='match-card'><h3>${teamA} VS ${teamB}</h3><table>`;
      html += `<thead><tr><th>경기</th><th>출전 선수</th><th>결과</th></tr></thead><tbody>`;
      matchList.forEach(match => {
        html += `<tr><td>${match.label}</td><td contenteditable='true'>${match.players}</td><td>${match.result}</td></tr>`;
      });
      html += `</tbody></table></div>`;
      container.innerHTML += html;
    }
  </script>

  <div id="summaryArea"></div>
</body>
</html>
