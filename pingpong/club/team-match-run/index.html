<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‹¨ì²´ì „ ì§„í–‰</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    body{font-family:'Segoe UI',sans-serif;padding:20px;background:#f5f7fa}
    h2{text-align:center;color:#0d47a1;margin:10px 0 30px}
    .config{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:20px}
    select,button{padding:6px 14px;font-size:15px}
    table{border-collapse:collapse;width:100%;max-width:600px;margin:0 auto}
    th,td{border:1px solid #888;padding:8px 12px;text-align:center}
    th{background:#e3f2fd}
    td.self{background:#eeeeee}
    td.vs{cursor:pointer;color:#1565c0}
    td.vs:hover{background:#e1f5fe}
  </style>
</head>
<body>

  <div id="teamListArea" style="margin-bottom:30px;"></div>


  <h2>ë‹¨ì²´ì „ ì§„í–‰</h2>

  <!-- 2ë‹¨ê³„: ê²½ê¸° ë°©ì‹ ì„¤ì • UI -->
<div class="config">
  ë‹¨ì‹&nbsp;
  <select id="singlesCnt">
    <option value="1">1ê²½ê¸°</option><option value="2">2ê²½ê¸°</option>
    <option value="3" selected>3ê²½ê¸°</option><option value="4">4ê²½ê¸°</option>
  </select>
  &nbsp;ë³µì‹&nbsp;
  <select id="doublesCnt">
    <option value="0">0ê²½ê¸°</option><option value="1">1ê²½ê¸°</option>
    <option value="2" selected>2ê²½ê¸°</option><option value="3">3ê²½ê¸°</option>
  </select>
  &nbsp;
  <button onclick="saveGameSettings()">ì„¤ì • ì €ì¥</button>
  <button onclick="loadGameSettings()">ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°</button>
  <button onclick="drawSummary()">ëŒ€ì§„í‘œ ìš”ì•½í‘œ ìƒì„±</button>
</div>


  <!-- 3ë‹¨ê³„: ëŒ€ì§„í‘œ ìš”ì•½í‘œ í‘œì‹œ ì˜ì—­ -->
  <div id="summaryArea"></div>

<script>
/* ---------- Firebase ì´ˆê¸°í™” ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyA-tp3iJ8-n0yrrd8lwE1IgOdsmDqyh69k",
  authDomain: "koen-teamleague.firebaseapp.com",
  projectId: "koen-teamleague",
  storageBucket: "koen-teamleague.firebasestorage.app",
  messagingSenderId: "487164547059",
  appId: "1:487164547059:web:658a10c8bfe7272ca78c86",
  databaseURL: "https://koen-teamleague-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------- 1ë‹¨ê³„: íŒ€ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ---------- */
let teamNames = [];                 // ["íŒ€A", "íŒ€B", ...]
let teamData  = {};                 // ì›ë³¸ ê°ì²´ ê·¸ëŒ€ë¡œ ë³´ê´€

db.ref("teams").once("value").then(snap=>{
  if(!snap.exists()){ alert("âš ï¸ ì €ì¥ëœ íŒ€ì´ ì—†ìŠµë‹ˆë‹¤!"); return;}
  teamData = snap.val();
  teamNames = Object.entries(teamData)
  .map(([id, t]) => ({ id, name: t.teamName }))
  .sort((a, b) => a.name.localeCompare(b.name));

  renderTeamList(); 
  alert(`âœ… ${teamNames.length}ê°œ íŒ€ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
}).catch(err=>console.error(err));

/* ---------- 2.5ë‹¨ê³„: ë¶ˆëŸ¬ì˜¨ íŒ€ê³¼ ì„ ìˆ˜ ë³´ì—¬ì£¼ê¸° ---------- */


function renderTeamList() {
  let html = '<h3 style="text-align:center; color:#333;">ğŸ“‹ íŒ€ êµ¬ì„± í˜„í™©</h3>';
  html += '<table><tr><th>íŒ€ëª…</th><th>íŒ€ì› ëª©ë¡</th></tr>';

  Object.values(teamData).forEach(team => {
    const playerNames = team.players.map(p => `${p.name}(${p.level})`).join(', ');
    html += `<tr><td><strong>${team.teamName}</strong></td><td>${playerNames}</td></tr>`;
  });

  html += '</table>';
  document.getElementById('teamListArea').innerHTML = html;
}

function saveGameSettings() {
  const singles = parseInt(document.getElementById("singlesCnt").value, 10);
  const doubles = parseInt(document.getElementById("doublesCnt").value, 10);

  db.ref("settings").set({ singles, doubles }).then(() => {
    alert("âœ… ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }).catch(err => {
    console.error("âŒ ì„¤ì • ì €ì¥ ì‹¤íŒ¨:", err);
  });
}

function loadGameSettings() {
  db.ref("settings").once("value").then(snap => {
    if (!snap.exists()) {
      alert("âš ï¸ ì €ì¥ëœ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    const { singles, doubles } = snap.val();
    document.getElementById("singlesCnt").value = singles;
    document.getElementById("doublesCnt").value = doubles;
    alert("âœ… ì„¤ì •ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
  }).catch(err => {
    console.error("âŒ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
  });
}

// íŒ€ ë¶ˆëŸ¬ì˜¤ê¸° í›„ ì„¤ì •ë„ ë¶ˆëŸ¬ì˜¤ì
db.ref("teams").once("value").then(snap => {
  if(!snap.exists()){ alert("âš ï¸ ì €ì¥ëœ íŒ€ì´ ì—†ìŠµë‹ˆë‹¤!"); return;}
  teamData = snap.val();
  teamNames = Object.entries(teamData)
    .map(([id, t]) => ({ id, name: t.teamName }))
    .sort((a, b) => a.name.localeCompare(b.name));

  renderTeamList(); 
  alert(`âœ… ${teamNames.length}ê°œ íŒ€ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);

  loadGameSettings();  // âœ… ì—¬ê¸° ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤!
}).catch(err=>console.error(err));



/* ---------- 3ë‹¨ê³„: ëŒ€ì§„í‘œ ìš”ì•½í‘œ ê·¸ë¦¬ê¸° ---------- */

function drawSummary() {
  const teamCount = teamNames.length;

  if (teamCount < 2) {
    alert("âš ï¸ íŒ€ì´ 2ê°œ ì´ìƒ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.");
    return;
  } else if (teamCount === 2) {
    renderSingleMatchCard();
  } else if (teamCount === 3) {
    renderThreeTeamList();
  } else if (teamCount >= 4 && teamCount <= 6) {
    renderMatchTable();
  } else {
    alert("âš ï¸ 6íŒ€ê¹Œì§€ë§Œ ì§€ì›í•©ë‹ˆë‹¤.");
  }
}
let currentMatch = {};

function renderScoreButtons() {
  const container = document.getElementById("scoreButtons");
  container.innerHTML = ""; // ì´ˆê¸°í™”

  scoreOptions.forEach(score => {
    const btn = document.createElement("button");
    btn.innerText = score;
    btn.style.padding = "6px 10px";
    btn.style.border = "1px solid #ccc";
    btn.style.borderRadius = "6px";
    btn.style.cursor = "pointer";
    btn.style.background = "#f1f1f1";

    btn.onclick = () => {
      selectedScore = score;
      // ì„ íƒëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê°•ì¡°
      [...container.children].forEach(b => b.style.background = "#f1f1f1");
      btn.style.background = "#90caf9";
    };

    container.appendChild(btn);
  });
}



function openMatch(i, j) {
  const teamA = teamNames[i];
  const teamB = teamNames[j];
  currentMatch = { i, j, teamA: teamA.name, teamB: teamB.name };

  document.getElementById('modalTitle').innerText = `${teamA.name} vs ${teamB.name} ê²½ê¸° ì„¸íŒ…`;

  // âœ… ê²½ê¸° ìˆ˜ ê¸°ë°˜ ì˜µì…˜ í•„í„°ë§
  const singlesCnt = parseInt(document.getElementById("singlesCnt").value, 10);
  const doublesCnt = parseInt(document.getElementById("doublesCnt").value, 10);

  const matchTypeSelect = document.getElementById("matchType");
  matchTypeSelect.innerHTML = ""; // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™”

  for (let i = 1; i <= singlesCnt; i++) {
    matchTypeSelect.innerHTML += `<option value="${i}ë‹¨">${i}ë‹¨</option>`;
  }
  for (let i = 1; i <= doublesCnt; i++) {
    matchTypeSelect.innerHTML += `<option value="${i}ë³µ">${i}ë³µ</option>`;
  }

  // âœ… ì„ ìˆ˜ ëª©ë¡ í‘œì‹œ
  renderPlayerSelect("teamASelect", teamData[teamA.id].players, "A");
  renderPlayerSelect("teamBSelect", teamData[teamB.id].players, "B");

 // document.getElementById('scoreInput').value = '';

  selectedScore = "";         // âœ… ì„ íƒ ì ìˆ˜ ì´ˆê¸°í™”
  renderScoreButtons();       // âœ… ì ìˆ˜ ë²„íŠ¼ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
  document.getElementById('matchModal').style.display = "flex";
}

const scoreOptions = ["3:2", "3:1", "3:0", "2:0", "2:1"];
let selectedScore = "";



function renderPlayerSelect(containerId, players, teamKey, preSelected=[]) {
  let html = `<div><strong>${teamKey === "A" ? "íŒ€A" : "íŒ€B"} ì„ ìˆ˜ ì„ íƒ:</strong><br>`;
  players.forEach(p => {
    const checked = preSelected.includes(p.name) ? 'checked' : '';
    html += `<label><input type="checkbox" name="player_${teamKey}" value="${p.name}" ${checked}> ${p.name}</label><br>`;
  });
  html += `</div>`;
  document.getElementById(containerId).innerHTML = html;
}


function closeMatchModal() {
  document.getElementById('matchModal').style.display = "none";
}

function renderSingleMatchCard() {
  const [teamA, teamB] = teamNames;
  const html = `
    <div style="text-align:center;">
      <h3>ğŸ€ ${teamA.name} vs ${teamB.name}</h3> <!-- ì´ ë¶€ë¶„ ìˆ˜ì • -->
      <button onclick="openMatch(0,1)" style="padding:10px 20px;font-size:16px;">ê²½ê¸° ì„¸íŒ…í•˜ê¸°</button>
    </div>
  `;
  document.getElementById("summaryArea").innerHTML = html;
}

function saveMatchResult() {
  console.log("âœ… saveMatchResult í˜¸ì¶œë¨");

  const matchType = document.getElementById("matchType").value;
  const teamAPlayers = Array.from(document.querySelectorAll("input[name='player_A']:checked")).map(i => i.value);
  const teamBPlayers = Array.from(document.querySelectorAll("input[name='player_B']:checked")).map(i => i.value);
  const score = selectedScore;

  const path = `matches/${currentMatch.teamA}_vs_${currentMatch.teamB}/${matchType}`;

  db.ref(path).once("value").then(snap => {
    const oldData = snap.val() || {};
    const newData = {
      teamAPlayers: teamAPlayers.length > 0 ? teamAPlayers : oldData.teamAPlayers || [],
      teamBPlayers: teamBPlayers.length > 0 ? teamBPlayers : oldData.teamBPlayers || [],
      score: score || oldData.score || "",
      timestamp: new Date().toISOString()
    };

    db.ref(path).set(newData).then(() => {
      console.log("ğŸŸ¢ ì €ì¥ ì™„ë£Œ, ë Œë”ë§ ì‹œì‘");
      closeMatchModal();
      renderMatchSummaryText(currentMatch.i, currentMatch.j, matchType, newData);  // âœ… ì •ìƒ ì‘ë™
    });
  });
}





function renderThreeTeamList() {
  let html = '<h3 style="text-align:center;">ğŸ” 3íŒ€ ë¦¬ê·¸ì „ (ì´ 3ê²½ê¸°)</h3><ul style="list-style:none;padding:0;text-align:center;">';
  for (let i = 0; i < 2; i++) {
    for (let j = i + 1; j < 3; j++) {
      html += `<li style="margin:10px 0;"><button onclick="openMatch(${i},${j})">ğŸ€ ${teamNames[i].name} vs ${teamNames[j].name}</button></li>`;
      // ì—¬ê¸°ì„œ .name ëˆ„ë½ë˜ì–´ ìˆì—ˆìŒ
    }
  }
  html += '</ul>';
  document.getElementById("summaryArea").innerHTML = html;
}

function renderMatchTable() {
  const singles = parseInt(document.getElementById("singlesCnt").value, 10);
  const doubles = parseInt(document.getElementById("doublesCnt").value, 10);
  const totalGames = singles + doubles;

  let html = '<table><tr><th></th>';  // ë§¨ ì™¼ìª½ ìƒë‹¨ì€ ë¹ˆì¹¸
  teamNames.forEach(n => html += `<th>${n.name}</th>`);
  html += '</tr>';

  for (let i = 0; i < teamNames.length; i++) {
    html += `<tr><th>${teamNames[i].name}</th>`;
    for (let j = 0; j < teamNames.length; j++) {
      if (i === j) {
        html += '<td class="self">-</td>';
      } else if (i < j) {
        html += `<td class="vs" onclick="openMatch(${i},${j})">vs</td>`;
      } else {
        html += '<td></td>';  // í•˜ì‚¼ê°ì€ ë¹„ì›€
      }
    }
    html += '</tr>';  // âœ… for(i) ì•ˆìª½ì— ìœ„ì¹˜í•´ì•¼ í•¨!
  }

  html += '</table>';
  html += `<p style="text-align:center;margin-top:10px;">
              âš™ï¸ ë‹¨ì‹ ${singles}ê²½ê¸° + ë³µì‹ ${doubles}ê²½ê¸° â†’ <strong>${totalGames}ê²½ê¸°</strong>
              (${totalGames % 2 === 0 ? "ì§ìˆ˜: ì„¸íŠ¸í•© ìš°ì„ " : "í™ìˆ˜: ìŠ¹ìˆ˜ ìš°ì„ "})
           </p>`;

  document.getElementById("summaryArea").innerHTML = html;
}


function renderMatchSummaryText(i, j, matchType, matchInfo) {
  const table = document.querySelector("#summaryArea table");
  if (!table) return;

  const rows = table.querySelectorAll("tr");
  if (!rows[i + 1] || !rows[i + 1].children[j + 1]) return;

  const cell = rows[i + 1].children[j + 1];
  let currentText = cell.innerHTML || "";

  // ëª¨ë“  <br> ê¸°ì¤€ìœ¼ë¡œ ì¤„ ë‹¨ìœ„ ë¶„ë¦¬
  let lines = currentText.split("<br>").filter(line => line && !/vs/i.test(line));

  // ì¤„ë“¤ì„ matchType: ë‚´ìš© í˜•íƒœë¡œ ê°ì²´í™”
  const lineMap = {};
  lines.forEach(line => {
    const key = line.split(" ")[0];
    lineMap[key] = line;
  });

  // ì´ë¦„ë§Œ ì¶”ì¶œ
  const getShortName = name => {
    const parts = name.trim().split(" ");
    return parts.length > 1 ? parts.slice(1).join(" ") : name.slice(-2);
  };

  // ìƒˆ ì¤„ ìƒì„±
  let newLine = `${matchType} `;
  if (matchInfo.teamAPlayers && matchInfo.teamBPlayers) {
    const aNames = matchInfo.teamAPlayers.map(getShortName).join(matchType.includes("ë³µ") ? '/' : '');
    const bNames = matchInfo.teamBPlayers.map(getShortName).join(matchType.includes("ë³µ") ? '/' : '');
    newLine += `${aNames}:${bNames}`;
  }
  if (matchInfo.score) {
    newLine += ` â†’ ${matchInfo.score}`;
  }

  // ìƒˆ ê²½ê¸° ë‚´ìš© ì¶”ê°€ ë˜ëŠ” ê°±ì‹ 
  lineMap[matchType] = newLine;

  // âœ… ë‹¨ì‹ ë¨¼ì €, ë³µì‹ ë‚˜ì¤‘ ì •ë ¬
  const matchOrder = ["1ë‹¨", "2ë‹¨", "3ë‹¨", "4ë‹¨", "1ë³µ", "2ë³µ", "3ë³µ"];
  const sortedLines = matchOrder
    .filter(k => lineMap[k])
    .map(k => lineMap[k]);

  // ì…€ì— ë°˜ì˜
  cell.innerHTML = sortedLines.join("<br>");
}




</script>

<!-- ëª¨ë‹¬ íŒì—…: ê²½ê¸° ì„¸ë¶€ì •ë³´ ì…ë ¥ -->
<div id="matchModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
    background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
  <div style="background:white; padding:20px; border-radius:10px; max-width:400px; width:90%;">
    <h3 id="modalTitle">ê²½ê¸° ì •ë³´ ì…ë ¥</h3>
    <div>
      <label>ê²½ê¸° ì¢…ë¥˜:</label>
      <select id="matchType">
        <option value="1ë‹¨">1ë‹¨</option>
        <option value="2ë‹¨">2ë‹¨</option>
        <option value="3ë‹¨">3ë‹¨</option>
        <option value="4ë‹¨">4ë‹¨</option>
        <option value="1ë³µ">1ë³µ</option>
        <option value="2ë³µ">2ë³µ</option>
        <option value="3ë³µ">3ë³µ</option>
      </select>
    </div>
    <div id="teamASelect" style="margin-top:10px;"></div>
    <div id="teamBSelect" style="margin-top:10px;"></div>

    <div style="margin-top:10px;">
      <label>ì ìˆ˜ ì„ íƒ:</label><br>
      <div id="scoreButtons" style="display:flex; flex-wrap:wrap; gap:6px; margin-top:6px;">
      <!-- ë²„íŠ¼ì€ ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ìƒì„± -->
       </div>
    </div>

  <div style="margin-top:15px; text-align:right;">
      <button onclick="saveMatchResult()">ì €ì¥</button>
      <button onclick="closeMatchModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>




</body>
</html>
