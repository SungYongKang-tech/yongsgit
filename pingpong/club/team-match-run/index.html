<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>단체전 진행</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family:'Segoe UI', sans-serif; padding:20px; background:#f5f7fa }
    h2 { text-align:center; color:#0d47a1; margin:10px 0 30px }
    .config { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:20px }
    select, button { padding:6px 14px; font-size:15px }
    table { border-collapse:collapse; width:100%; max-width:600px; margin:0 auto }
    th, td { border:1px solid #888; padding:8px 12px; text-align:center }
    th { background:#e3f2fd }
    .match-card { border:3px solid #0d47a1; padding:20px; margin:30px auto; max-width:720px; background:#fff; border-radius:14px; box-shadow:2px 2px 10px rgba(0,0,0,0.12) }
    .match-card h3 { text-align:center; margin-bottom:20px; font-size:20px; color:#0d47a1 }
    .match-card table { width:100%; border-collapse:collapse }
    .match-card th, .match-card td { border:1px solid #aaa; padding:10px; text-align:center }
    .match-card th { background-color:#e3f2fd }
    .draggable { cursor:move; }
    .popup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; border:1px solid #999; padding:20px; box-shadow:0 0 10px rgba(0,0,0,0.2); z-index:9999; }
    .popup button { margin:5px; }
  </style>
</head>
<body>
  <div id="teamListArea" style="margin-bottom:30px;"></div>
  <h2>단체전 진행</h2>
  <div class="config">
    단식 <select id="singlesCnt"><option value="3">3경기</option></select>
    복식 <select id="doublesCnt"><option value="2">2경기</option></select>
    <button onclick="renderAllMatchesFromFirebase()">대진표 생성</button>
  </div>
  <div id="summaryArea"></div>
  <div id="popup" class="popup" style="display:none;"></div>

<script>
const firebaseConfig = {
      apiKey: "AIzaSyA-tp3iJ8-n0yrrd8lwE1IgOdsmDqyh69k",
      authDomain: "koen-teamleague.firebaseapp.com",
      projectId: "koen-teamleague",
      storageBucket: "koen-teamleague.firebasestorage.app",
      messagingSenderId: "487164547059",
      appId: "1:487164547059:web:658a10c8bfe7272ca78c86",
      databaseURL: "https://koen-teamleague-default-rtdb.firebaseio.com"
    };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let teamNames = [], teamData = {};

// Firebase에서 팀 불러오기
function loadTeams() {
  return db.ref("teams").once("value").then(snap => {
    const raw = snap.val();
    teamData = {}; teamNames = [];
    Object.values(raw).forEach(team => {
      teamData[team.teamName] = team;
      teamNames.push(team.teamName);
    });
    renderTeamList();
    renderAllMatchesFromFirebase();
  });
}

function renderTeamList() {
  let html = '<h3 style="text-align:center">📋 팀 구성 현황</h3><table><tr><th>팀명</th><th>팀원 목록</th></tr>';
  teamNames.forEach(team => {
    const players = teamData[team].players.map(p => `${p.name}(${p.level})`).join(', ');
    html += `<tr><td>${team}</td><td>${players}</td></tr>`;
  });
  html += '</table>';
  document.getElementById('teamListArea').innerHTML = html;
}

function renderAllMatchesFromFirebase() {
  const singles = +document.getElementById("singlesCnt").value;
  const doubles = +document.getElementById("doublesCnt").value;
  const totalMatches = [];
  for (let i = 0; i < teamNames.length; i++) {
    for (let j = i + 1; j < teamNames.length; j++) {
      totalMatches.push({ teamA: teamNames[i], teamB: teamNames[j] });
    }
  }
  const container = document.getElementById("summaryArea");
  container.innerHTML = "";
  totalMatches.forEach(match => {
    const matchList = [];
    for (let i = 0; i < singles; i++) matchList.push({ label: `${i+1}단`, players: `미정 vs 미정`, result: "-" });
    for (let i = 0; i < doubles; i++) matchList.push({ label: `${i+1}복`, players: `미정/미정 vs 미정/미정`, result: "-" });
    renderMatchCard(match.teamA, match.teamB, matchList);
  });
}

function renderMatchCard(teamA, teamB, matchList) {
  const container = document.getElementById("summaryArea");
  let html = `<div class='match-card'><h3>${teamA} VS ${teamB}</h3><table>`;
  html += `<thead><tr><th>경기</th><th>출전 선수</th><th>결과</th></tr></thead><tbody>`;
  matchList.forEach((match, idx) => {
    html += `<tr><td>${match.label}</td><td contenteditable='false' onclick="openPlayerPopup('${teamA}', '${teamB}', this)">${match.players}</td><td>${match.result}</td></tr>`;
  });
  html += `</tbody></table></div>`;
  container.innerHTML += html;
}

function openPlayerPopup(teamA, teamB, cell) {
  const popup = document.getElementById("popup");
  const isDoubles = cell.innerText.includes("/");

  // 🔒 teamA 또는 teamB가 teamData에 존재하지 않을 경우 방어 처리
  if (!teamData[teamA] || !teamData[teamB]) {
    alert("팀 데이터를 불러올 수 없습니다. 페이지를 새로고침해주세요.");
    return;
  }

  if (!isDoubles) {
    // 단식일 경우 버튼 UI
    const playersA = teamData[teamA].players.map(p => `<button onclick="setPlayer(this, '${teamA}', '${teamB}', 'A', false)">${p.name}(${p.level})</button>`).join('');
    const playersB = teamData[teamB].players.map(p => `<button onclick="setPlayer(this, '${teamA}', '${teamB}', 'B', false)">${p.name}(${p.level})</button>`).join('');
    popup.innerHTML = `<h4>${teamA}</h4>${playersA}<hr><h4>${teamB}</h4>${playersB}<br><button onclick="closePopup()">닫기</button>`;
  } else {
    // 복식일 경우 두 명 선택 UI
    const playersA = teamData[teamA].players.map(p => `<label><input type='checkbox' name='teamA' value="${p.name}(${p.level})"> ${p.name}(${p.level})</label><br>`).join('');
    const playersB = teamData[teamB].players.map(p => `<label><input type='checkbox' name='teamB' value="${p.name}(${p.level})"> ${p.name}(${p.level})</label><br>`).join('');
    popup.innerHTML = `
      <h4>${teamA} (2명 선택)</h4>${playersA}
      <hr>
      <h4>${teamB} (2명 선택)</h4>${playersB}
      <br><button onclick="setDoubles('${teamA}', '${teamB}')">선택 완료</button>
      <button onclick="closePopup()">닫기</button>`;
  }
  popup.targetCell = cell;
  popup.style.display = 'block';
}

function setPlayer(btn, teamA, teamB, side, isDouble) {
  const popup = document.getElementById("popup");
  const cell = popup.targetCell;
  const name = btn.innerText;
  let current = cell.innerText.split(" vs ");
  if (current.length === 2) {
    current[side === 'A' ? 0 : 1] = name;
  } else {
    current = side === 'A' ? [name, '미정'] : ['미정', name];
  }
  cell.innerText = current.join(" vs ");
  closePopup();
}

function setDoubles(teamA, teamB) {
  const popup = document.getElementById("popup");
  const cell = popup.targetCell;
  const selectedA = Array.from(popup.querySelectorAll("input[name='teamA']:checked"));
  const selectedB = Array.from(popup.querySelectorAll("input[name='teamB']:checked"));
  if (selectedA.length !== 2 || selectedB.length !== 2) {
    alert("각 팀에서 2명씩 선택해주세요"); return;
  }
  const teamAText = selectedA.map(el => el.value).join("/");
  const teamBText = selectedB.map(el => el.value).join("/");
  cell.innerText = `${teamAText} vs ${teamBText}`;
  closePopup();
}

function setSingles(teamA, teamB) {
  const popup = document.getElementById("popup");
  const cell = popup.targetCell;

  const selectedA = popup.querySelector("input[name='teamA']:checked");
  const selectedB = popup.querySelector("input[name='teamB']:checked");

  if (!selectedA || !selectedB) {
    alert("양 팀에서 각각 1명씩 선택해주세요.");
    return;
  }

  const playerA = selectedA.value;
  const playerB = selectedB.value;

  cell.innerText = `${playerA} vs ${playerB}`;
  closePopup();
}


function setPlayer(btn, teamA, teamB, side) {
  const popup = document.getElementById("popup");
  const cell = popup.targetCell;
  const name = btn.innerText;
  let current = cell.innerText.split(" vs ");
  if (current.length === 2) {
    current[side === 'A' ? 0 : 1] = name;
  } else {
    current = side === 'A' ? [name, '미정'] : ['미정', name];
  }
  cell.innerText = current.join(" vs ");
  closePopup();
}

function closePopup() {
  document.getElementById("popup").style.display = 'none';
}

loadTeams() ;

document.getElementById("singlesCnt").addEventListener("change", () => {
  renderAllMatchesFromFirebase();
  saveMatchesToFirebase(); // ✅ 변경사항 Firebase에 저장
});

document.getElementById("doublesCnt").addEventListener("change", () => {
  renderAllMatchesFromFirebase();
  saveMatchesToFirebase(); // ✅ 변경사항 Firebase에 저장
});

function saveMatchesToFirebase() {
  const matches = [];
  document.querySelectorAll('.match-card').forEach(card => {
    const teamNames = card.querySelector('h3').innerText.split(' VS ');
    const rows = card.querySelectorAll('tbody tr');
    rows.forEach(row => {
      matches.push({
        teamA: teamNames[0],
        teamB: teamNames[1],
        label: row.children[0].innerText,
        players: row.children[1].innerText,
        result: row.children[2].innerText
      });
    });
  });
  db.ref("matches").set(matches);
}

function renderMatchesFromData(matchList) {
  const listArray = Array.isArray(matchList) ? matchList : Object.values(matchList);  // ✅ 이 라인 추가
  const grouped = {};
  listArray.forEach(m => {
    const key = `${m.teamA}_${m.teamB}`;
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(m);
  });

  const container = document.getElementById("summaryArea");
  container.innerHTML = "";
  Object.entries(grouped).forEach(([key, list]) => {
    const [teamA, teamB] = key.split('_');
    let html = `<div class='match-card'><h3>${teamA} VS ${teamB}</h3><table>`;
    html += `<thead><tr><th>경기</th><th>출전 선수</th><th>결과</th></tr></thead><tbody>`;
    list.forEach(match => {
      html += `<tr><td>${match.label}</td><td contenteditable='false' onclick="openPlayerPopup('${teamA}', '${teamB}', this)">${match.players}</td><td>${match.result}</td></tr>`;
    });
    html += `</tbody></table></div>`;
    container.innerHTML += html;
  });
}


function listenForMatches() {
  db.ref("matches").on("value", snap => {
    const matchList = snap.val();
    if (matchList) renderMatchesFromData(matchList);
  });
}

loadTeams().then(() => {
  listenForMatches(); // ✅ 실시간 경기 대진표 반영
});

</script>
</body>
</html>
