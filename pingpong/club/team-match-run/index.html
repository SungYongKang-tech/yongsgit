<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‹¨ì²´ì „ ì§„í–‰</title>

  <!-- Firebase SDK (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body { font-family:'Segoe UI', sans-serif; padding:20px; background:#f5f7fa }
    h2 { text-align:center; color:#0d47a1; margin:10px 0 30px }
    .config { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:20px }
    select, button { padding:6px 14px; font-size:15px }
    table { border-collapse:collapse; width:100%; max-width:600px; margin:0 auto }
    th, td { border:1px solid #888; padding:8px 12px; text-align:center }
    th { background:#e3f2fd }
    .match-card { border:3px solid #0d47a1; padding:20px; margin:30px auto; max-width:720px; background:#fff; border-radius:14px; box-shadow:2px 2px 10px rgba(0,0,0,0.12) }
    .match-card h3 { text-align:center; margin-bottom:20px; font-size:20px; color:#0d47a1 }
    .match-card table { width:100%; border-collapse:collapse }
    .match-card th, .match-card td { border:1px solid #aaa; padding:10px; text-align:center }
    .match-card th { background-color:#e3f2fd }
    .draggable { cursor:move; }
    .popup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; border:1px solid #999; padding:20px; box-shadow:0 0 10px rgba(0,0,0,0.2); z-index:9999; }
    .popup button { margin:5px; }

    /* ìˆœìœ„í‘œ ëª¨ë°”ì¼ ëŒ€ì‘ ìŠ¤íƒ€ì¼ */
    .scroll-table { overflow-x: auto; border: 1px solid #ccc; border-radius: 8px; margin: 20px auto; width: 100%; max-width: 720px; }
    .scroll-table table { border-collapse: collapse; width: 100%; min-width: 500px; background-color: white; }
    .scroll-table th, .scroll-table td { border: 1px solid #888; padding: 16px 10px; text-align: center; font-size: 16px; white-space: nowrap; }
    .scroll-table th:first-child, .scroll-table td:first-child { background-color: #ffe082; font-weight: bold; }

    @media screen and (max-width: 600px) {
      .scroll-table th, .scroll-table td { font-size: 13px; padding: 12px 8px; }
      .scroll-table table { min-width: 100%; }
    }
  </style>
</head>
<body>
  <div id="teamListArea" style="margin-bottom:30px;"></div>
  <h2>ë‹¨ì²´ì „ ì§„í–‰</h2>
  <div class="config">
    ë‹¨ì‹
    <select id="singlesCnt">
      <option value="0">0ê²½ê¸°</option>
      <option value="1">1ê²½ê¸°</option>
      <option value="2">2ê²½ê¸°</option>
      <option value="3" selected>3ê²½ê¸°</option>
      <option value="4">4ê²½ê¸°</option>
      <option value="5">5ê²½ê¸°</option>
    </select>
    ë³µì‹
    <select id="doublesCnt">
      <option value="0">0ê²½ê¸°</option>
      <option value="1">1ê²½ê¸°</option>
      <option value="2" selected>2ê²½ê¸°</option>
      <option value="3">3ê²½ê¸°</option>
    </select>
    <button onclick="handleGenerateMatches()">ëŒ€ì§„í‘œ ìƒì„±</button>
    <button onclick="saveAsImage()">ëŒ€ì§„ê²°ê³¼ ì €ì¥</button>
  </div>

  <div id="popup" class="popup" style="display:none;"></div>

  <div id="captureArea">
    <div id="summaryArea"></div>
    <div id="rankingArea" style="margin-top: 40px;"></div>
  </div>

<script>
/* ---------------- Firebase ì„¤ì • & ìµëª… ë¡œê·¸ì¸ ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyA-tp3iJ8-n0yrrd8lwE1IgOdsmDqyh69k",
  authDomain: "koen-teamleague.firebaseapp.com",
  projectId: "koen-teamleague",
  storageBucket: "koen-teamleague.appspot.com", // ì°¸ê³ : í‘œì¤€ ë²„í‚· ë„ë©”ì¸
  messagingSenderId: "487164547059",
  appId: "1:487164547059:web:658a10c8bfe7272ca78c86",
  databaseURL: "https://koen-teamleague-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/** ë¡œê·¸ì¸ ë³´ì¥ ìœ í‹¸ */
async function requireAuth() {
  const u = firebase.auth().currentUser;
  if (u) return u;
  await firebase.auth().signInAnonymously();
  return new Promise(resolve => {
    const unsub = firebase.auth().onAuthStateChanged(user => {
      if (user) { unsub(); resolve(user); }
    });
  });
}

/** ë¡œê·¸ì¸ ìƒíƒœ ë³€í™”: ë¡œê·¸ì¸ ì™„ë£Œ í›„ì—ë§Œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ */
firebase.auth().onAuthStateChanged(async (user) => {
  if (!user) {
    try {
      await firebase.auth().signInAnonymously();
      console.log("âœ… ìµëª… ë¡œê·¸ì¸ ì‹œë„");
    } catch (e) {
      console.error("âŒ ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨:", e);
    }
    return;
  }
  console.log("âœ… ë¡œê·¸ì¸ë¨:", user.uid);
  await loadTeams();
  listenToMatchUpdates();
});

/* ---------------- ì „ì—­ ìƒíƒœ ---------------- */
let teamNames = [], teamData = {};

/* ---------------- íŒ€ ë¡œë“œ/í‘œì‹œ ---------------- */
function loadTeams() {
  return db.ref("teams").once("value").then(snap => {
    const raw = snap.val();
    teamData = {};
    teamNames = [];

    if (!raw) {
      alert("âŒ íŒ€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íŒ€ì„ êµ¬ì„±í•´ ì£¼ì„¸ìš”.");
      return;
    }

    Object.values(raw).forEach(team => {
      teamData[team.teamName] = team;
      teamNames.push(team.teamName);
    });
    renderTeamList();
  });
}

function renderTeamList() {
  let html = '<h3 style="text-align:center">ğŸ“‹ íŒ€ êµ¬ì„± í˜„í™©</h3><table><tr><th>íŒ€ëª…</th><th>íŒ€ì› ëª©ë¡</th></tr>';
  teamNames.forEach(team => {
    const players = teamData[team].players.map(p => `${p.name}(${p.level})`).join(', ');
    html += `<tr><td>${team}</td><td>${players}</td></tr>`;
  });
  html += '</table>';
  document.getElementById('teamListArea').innerHTML = html;
}

/* ---------------- ëŒ€ì§„ ìƒì„± ---------------- */
function handleGenerateMatches() {
  loadTeams().then(() => {
    renderAllMatchesFromFirebase(); // íŒ€ ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰
  });
}

async function renderAllMatchesFromFirebase() {
  await requireAuth(); // ì“°ê¸° ì „ ì¸ì¦ ë³´ì¥

  await db.ref("matches").remove();

  const singles = +document.getElementById("singlesCnt").value;
  const doubles = +document.getElementById("doublesCnt").value;
  const totalMatches = [];

  for (let i = 0; i < teamNames.length; i++) {
    for (let j = i + 1; j < teamNames.length; j++) {
      totalMatches.push({ teamA: teamNames[i], teamB: teamNames[j] });
    }
  }

  const updates = {};
  document.getElementById("summaryArea").innerHTML = ""; // í™”ë©´ ì´ˆê¸°í™”

  totalMatches.forEach(match => {
    const matchList = [];
    for (let i = 0; i < singles; i++)
      matchList.push({ label: `${i + 1}ë‹¨`, players: `ë¯¸ì • vs ë¯¸ì •`, result: "-" });
    for (let i = 0; i < doubles; i++)
      matchList.push({ label: `${i + 1}ë³µ`, players: `ë¯¸ì •/ë¯¸ì • vs ë¯¸ì •/ë¯¸ì •`, result: "-" });

    const key = `${match.teamA}_vs_${match.teamB}`;
    updates[`matches/${key}`] = { teamA: match.teamA, teamB: match.teamB, matchList };

    // í™”ë©´ì—ë„ ì¦‰ì‹œ ë°˜ì˜
    renderMatchCard(match.teamA, match.teamB, matchList);
  });

  await db.ref().update(updates);
}

/* ---------------- ëŒ€ì§„ ì¹´ë“œ ë Œë” ---------------- */
function renderMatchCard(teamA, teamB, matchList) {
  const container = document.getElementById("summaryArea");
  let html = `<div class='match-card'><h3>${teamA} VS ${teamB}</h3><table>`;
  html += `<thead><tr><th>ê²½ê¸°</th><th>ì¶œì „ ì„ ìˆ˜</th><th>ê²°ê³¼</th></tr></thead><tbody>`;

  matchList.forEach((match) => {
    let playerHTML = match.players;
    const [a, b] = (match.result || "").split(":").map(Number);

    if (!isNaN(a) && !isNaN(b) && match.players.includes(" vs ")) {
      let [aNames, bNames] = match.players.split(" vs ");
      aNames = aNames.trim();
      bNames = bNames.trim();
      if (a > b) playerHTML = `<strong>${aNames}</strong> vs ${bNames}`;
      else if (b > a) playerHTML = `${aNames} vs <strong>${bNames}</strong>`;
    }

    html += `<tr>
      <td>${match.label}</td>
      <td contenteditable='false' onclick="openPlayerPopup('${teamA}', '${teamB}', this)">${playerHTML}</td>
      <td onclick="openResultPopup(this)" style="cursor:pointer;">${match.result}</td>
    </tr>`;
  });

  html += `</tbody></table></div>`;
  container.innerHTML += html;
}

/* ---------------- ì„ ìˆ˜ ì„ íƒ íŒì—… ---------------- */
function openPlayerPopup(teamA, teamB, cell) {
  const popup = document.getElementById("popup");
  const isDoubles = cell.innerText.includes("/"); // ë³µì‹ ì—¬ë¶€
  const inputType = isDoubles ? 'checkbox' : 'radio';

  const playersA = teamData[teamA].players.map(p =>
    `<label><input type='${inputType}' name='teamA' value="${p.name}(${p.level})"> ${p.name}(${p.level})</label><br>`).join('');
  const playersB = teamData[teamB].players.map(p =>
    `<label><input type='${inputType}' name='teamB' value="${p.name}(${p.level})"> ${p.name}(${p.level})</label><br>`).join('');

  popup.innerHTML = `
    <h4>${teamA} ${isDoubles ? '(2ëª… ì„ íƒ)' : '(1ëª… ì„ íƒ)'}</h4>${playersA}
    <hr>
    <h4>${teamB} ${isDoubles ? '(2ëª… ì„ íƒ)' : '(1ëª… ì„ íƒ)'}</h4>${playersB}
    <br><button onclick="${isDoubles ? `setDoubles('${teamA}', '${teamB}')` : `setSingles('${teamA}', '${teamB}')`}">ì„ íƒ ì™„ë£Œ</button>
    <button onclick="closePopup()">ë‹«ê¸°</button>`;
  popup.targetCell = cell;
  popup.style.display = 'block';
}

async function setDoubles(teamA, teamB) {
  await requireAuth();

  const popup = document.getElementById("popup");
  const cell = popup.targetCell;

  const selectedA = Array.from(popup.querySelectorAll("input[name='teamA']:checked"));
  const selectedB = Array.from(popup.querySelectorAll("input[name='teamB']:checked"));
  if (selectedA.length !== 2 || selectedB.length !== 2) { alert("ê° íŒ€ì—ì„œ 2ëª…ì”© ì„ íƒí•´ì£¼ì„¸ìš”"); return; }

  const teamAText = selectedA.map(el => el.value).join("/");
  const teamBText = selectedB.map(el => el.value).join("/");
  cell.innerText = `${teamAText} vs ${teamBText}`;

  const card = cell.closest(".match-card");
  const teams = card.querySelector("h3").innerText.split(" VS ");
  const teamKey = `${teams[0]}_vs_${teams[1]}`;
  const rowIndex = [...card.querySelectorAll("tbody tr")].indexOf(cell.parentElement);

  await db.ref(`matches/${teamKey}/matchList/${rowIndex}/players`).set(`${teamAText} vs ${teamBText}`);

  popup.style.display = 'none';
  // ê²°ê³¼ ì…ë ¥ì°½ ìë™ ì—´ê¸°
  const resultCell = cell.parentElement.querySelector("td:last-child");
  openResultPopup(resultCell);
}

async function setSingles(teamA, teamB) {
  await requireAuth();

  const popup = document.getElementById("popup");
  const cell = popup.targetCell;

  const selectedA = popup.querySelector("input[name='teamA']:checked");
  const selectedB = popup.querySelector("input[name='teamB']:checked");
  if (!selectedA || !selectedB) { alert("ì–‘ íŒ€ì—ì„œ ê°ê° 1ëª…ì”© ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

  const playerA = selectedA.value;
  const playerB = selectedB.value;

  cell.innerText = `${playerA} vs ${playerB}`;
  popup.style.display = 'none';

  const card = cell.closest(".match-card");
  const teams = card.querySelector("h3").innerText.split(" VS ");
  const teamKey = `${teams[0]}_vs_${teams[1]}`;
  const rowIndex = [...card.querySelectorAll("tbody tr")].indexOf(cell.parentElement);

  await db.ref(`matches/${teamKey}/matchList/${rowIndex}/players`).set(`${playerA} vs ${playerB}`);

  // ê²°ê³¼ ì…ë ¥ì°½ ìë™ ì—´ê¸°
  const resultCell = cell.parentElement.querySelector("td:last-child");
  openResultPopup(resultCell);
}

function closePopup() {
  document.getElementById("popup").style.display = 'none';

  // íŒì—… ë‹«íŒ í›„ í™”ë©´/ìˆœìœ„ ì¬ê³„ì‚° (ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆê°€ ìˆì–´ë„ UXìš©)
  db.ref("matches").once("value").then(snapshot => {
    const matches = snapshot.val();
    if (!matches) return;

    document.getElementById("summaryArea").innerHTML = "";

    for (const key in matches) {
      let teamA, teamB, matchList;

      if (matches[key].teamA && matches[key].teamB && matches[key].matchList) {
        ({ teamA, teamB, matchList } = matches[key]);
        matchList = Array.isArray(matchList) ? matchList : Object.values(matchList || {});
      } else {
        [teamA, teamB] = key.split("_vs_");
        matchList = [];
        for (const label in matches[key]) {
          const data = matches[key][label];
          matchList.push({
            label,
            players: data?.summaryText?.split("â†’")[0]?.trim() || "ë¯¸ì • vs ë¯¸ì •",
            result: data?.score || "-"
          });
        }
      }
      renderMatchCard(teamA, teamB, matchList);
    }
    calculateTeamResults();
  });
}

/* ---------------- ê²°ê³¼ ì…ë ¥ íŒì—… ---------------- */
function openResultPopup(cell) {
  const popup = document.getElementById("popup");
  const row = cell.parentElement;
  const playerCell = row.children[1];
  const playerText = playerCell.innerText;

  const scores = ["3:2", "3:1", "3:0", "1:3", "2:3", "2:1", "2:0", "1:2", "0:2"];
  const buttons = scores.map(score =>
    `<button onclick="setMatchResult('${score}')">${score}</button>`
  ).join(" ");

  popup.innerHTML = `
    <p style="font-weight:bold; text-align:center;">ê²½ê¸° ê²°ê³¼ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”</p>
    <p style="text-align:center; margin-bottom:10px;">${playerText}</p>
    <div style="text-align:center; margin-bottom:10px;">${buttons}</div>
    <div style="text-align:center;"><button onclick="closePopup()">ë‹«ê¸°</button></div>
  `;
  popup.targetCell = cell;
  popup.style.display = "block";
}

async function setMatchResult(score) {
  await requireAuth();

  const popup = document.getElementById("popup");
  const cell = popup.targetCell;
  const card = cell.closest(".match-card");
  const teams = card.querySelector("h3").innerText.split(" VS ");
  const teamKey = `${teams[0]}_vs_${teams[1]}`;
  const rowIndex = [...card.querySelectorAll("tbody tr")].indexOf(cell.parentElement);

  await db.ref(`matches/${teamKey}/matchList/${rowIndex}/result`).set(score);

  // UI ì¦‰ì‹œ ë°˜ì˜ (ìŠ¹ì êµµê²Œ)
  const row = cell.parentElement;
  const playerCell = row.children[1];
  const playerText = playerCell.innerText;

  const [a, b] = score.split(":").map(Number);
  if (!isNaN(a) && !isNaN(b) && playerText.includes(" vs ")) {
    let [aNames, bNames] = playerText.split(" vs ");
    aNames = aNames.trim(); bNames = bNames.trim();
    if (a > b) playerCell.innerHTML = `<strong>${aNames}</strong> vs ${bNames}`;
    else playerCell.innerHTML = `${aNames} vs <strong>${bNames}</strong>`;
  }
  cell.innerText = score;

  document.getElementById("popup").style.display = "none";
  calculateTeamResults();
}

/* ---------------- ìˆœìœ„ ê³„ì‚° ---------------- */
function calculateTeamResults() {
  const summaryCards = document.querySelectorAll(".match-card");
  const teamStats = {}; // íŒ€ë³„ í†µê³„

  const allTeamsInMatches = new Set();
  summaryCards.forEach(card => {
    const [teamA, teamB] = card.querySelector("h3").innerText.split(" VS ");
    allTeamsInMatches.add(teamA);
    allTeamsInMatches.add(teamB);
  });

  allTeamsInMatches.forEach(name => {
    teamStats[name] = { win: 0, lose: 0, setDiff: 0 };
  });

  summaryCards.forEach(card => {
    const [teamA, teamB] = card.querySelector("h3").innerText.split(" VS ");
    const rows = card.querySelectorAll("tbody tr");

    let teamAWin = 0, teamBWin = 0;
    let teamASet = 0, teamBSet = 0;

    rows.forEach(row => {
      const result = row.children[2].innerText.trim();
      if (!result.includes(":")) return;
      const [a, b] = result.split(":").map(Number);
      if (isNaN(a) || isNaN(b)) return;

      if (a > b) teamAWin++; else teamBWin++;
      teamASet += a; teamBSet += b;
    });

    if (teamAWin + teamBWin > 0) {
      if (teamAWin > teamBWin) { teamStats[teamA].win++; teamStats[teamB].lose++; }
      else { teamStats[teamB].win++; teamStats[teamA].lose++; }

      teamStats[teamA].setDiff += (teamASet - teamBSet);
      teamStats[teamB].setDiff += (teamBSet - teamASet);
    }
  });

  const singles = +document.getElementById("singlesCnt").value;
  const doubles = +document.getElementById("doublesCnt").value;
  const totalGames = singles + doubles;

  const sorted = Object.entries(teamStats).sort((a, b) => {
    if (totalGames % 2 === 0) {
      // ì§ìˆ˜ ê²½ê¸°: ì„¸íŠ¸ë“ì‹¤ ìš°ì„ 
      return b[1].setDiff - a[1].setDiff;
    } else {
      // í™€ìˆ˜ ê²½ê¸°: ìŠ¹ìˆ˜ > ì„¸íŠ¸ë“ì‹¤
      if (b[1].win !== a[1].win) return b[1].win - a[1].win;
      return b[1].setDiff - a[1].setDiff;
    }
  });

  let html = '<h3 style="text-align:center; margin-top:40px;">ğŸ“Š íŒ€ë³„ ê²½ê¸°ê²°ê³¼ ë° ìˆœìœ„í‘œ</h3>';
  html += '<div class="scroll-table"><table><thead><tr><th>íŒ€ëª…</th><th>ìŠ¹</th><th>íŒ¨</th><th>ì„¸íŠ¸ë“ì‹¤</th><th>ìˆœìœ„</th></tr></thead><tbody>';
  sorted.forEach(([team, stat], idx) => {
    html += `<tr><td>${team}</td><td>${stat.win}</td><td>${stat.lose}</td><td>${stat.setDiff}</td><td>${idx + 1}</td></tr>`;
  });
  html += '</tbody></table></div>';
  document.getElementById("rankingArea").innerHTML = html;
}

/* ---------------- ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ---------------- */
function listenToMatchUpdates() {
  db.ref("matches").on("value", snapshot => {
    const matches = snapshot.val();
    if (!matches) return;

    document.getElementById("summaryArea").innerHTML = "";

    for (const key in matches) {
      let teamA, teamB, matchList;

      if (matches[key].teamA && matches[key].teamB && matches[key].matchList) {
        ({ teamA, teamB, matchList } = matches[key]);
        matchList = Array.isArray(matchList) ? matchList : Object.values(matchList || {});
      } else {
        [teamA, teamB] = key.split("_vs_");
        matchList = [];
        for (const label in matches[key]) {
          const data = matches[key][label];
          matchList.push({
            label,
            players: data?.summaryText?.split("â†’")[0]?.trim() || "ë¯¸ì • vs ë¯¸ì •",
            result: data?.score || "-"
          });
        }
      }

      renderMatchCard(teamA, teamB, matchList);
    }

    calculateTeamResults();
  });
}

/* ---------------- ìœ í‹¸ ---------------- */
function saveAsImage() {
  const target = document.getElementById("captureArea");
  html2canvas(target).then(canvas => {
    const link = document.createElement("a");
    link.download = `ë‹¨ì²´ì „_ëŒ€ì§„ê²°ê³¼_${new Date().toISOString().slice(0, 10)}.png`;
    link.href = canvas.toDataURL();
    link.click();
  });
}

/* ì„ íƒì : ê³¼ê±° ê°ì²´í˜• matchList â†’ ë°°ì—´ë¡œ ë³€í™˜ */
async function convertMatchListToArray() {
  await requireAuth();

  const matchesRef = db.ref("matches");
  const snapshot = await matchesRef.once("value");
  const matches = snapshot.val();
  if (!matches) return;

  const updates = {};
  for (const key in matches) {
    const match = matches[key];
    const originalList = match.matchList;
    if (Array.isArray(originalList)) continue;

    const newList = [];
    for (const label in originalList) {
      const item = originalList[label];
      newList.push({
        label,
        players: item.players || "ë¯¸ì • vs ë¯¸ì •",
        result: item.result || "-"
      });
    }
    updates[`matches/${key}/matchList`] = newList;
  }

  await db.ref().update(updates);
  alert("âœ… matchListë¥¼ ë°°ì—´ë¡œ ë³€í™˜ ì™„ë£Œ");
}
</script>
</body>
</html>
