<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>â­íƒêµ¬ ê²°ê³¼ ì…ë ¥</title>
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --card:#ffffff; --bg:#f5f7fb;
      --primary:#0d47a1; --accent:#2563eb; --danger:#ef4444; --ok:#16a34a;
      --shadow:0 8px 28px rgba(0,0,0,.08)
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; color:var(--ink); background:var(--bg)}
    header{position:sticky; top:0; z-index:20; background:#fff; border-bottom:1px solid #e5e7eb}
    .wrap{max-width:980px; margin:0 auto; padding:14px 16px}
    h1{margin:4px 0 6px; font-size:clamp(18px,4vw,24px); color:var(--primary)}
    main{max-width:980px; margin:12px auto; padding:0 16px 30px}
    .card{background:var(--card); border:1px solid #e5e7eb; border-radius:16px; padding:14px; box-shadow:var(--shadow); margin:12px 0}

    /* ì„ ìˆ˜ ì¹©(íœ´ëŒ€í°ì—ì„œ ì–‡ê²Œ) + ë¶€ìˆ˜ë³„ ìƒ‰ìƒ ë³€ìˆ˜ ì‚¬ìš© */
    .chips{display:flex; flex-wrap:wrap; gap:6px}
    .chip{
      display:inline-flex; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--chip-bd, #d1d5db);
      cursor:pointer;
      background:var(--chip-bg, #eef2ff);
      color:#111;
      font-size:13px; line-height:1.1; white-space:nowrap;
      -webkit-tap-highlight-color:transparent;
    }
    .chip.selected{outline:2px solid var(--chip-ol, var(--accent));background:#fff}

    @media (max-width:520px){
      .chip{padding:5px 8px; font-size:12.5px; line-height:1.05}
      .chips{gap:5px}
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row.center{justify-content:center}
    .btn{border:1px solid #d1d5db; border-radius:10px; padding:10px 14px; font-size:15px; cursor:pointer; background:#fff}
    .btn.ok{background:var(--ok); color:#fff; border-color:var(--ok)}
    .btn.warn{background:var(--danger); color:#fff; border-color:var(--danger)}
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
    .btn.sm{padding:6px 10px; font-size:13px; border-radius:8px}

    .seg{display:inline-flex; background:#eef2ff; border:1px solid #d1d5db; border-radius:999px; padding:2px}
    .seg button{border:0; background:transparent; padding:8px 12px; border-radius:999px; cursor:pointer; font-size:14px}
    .seg button.active{background:#fff; outline:2px solid var(--accent)}

    .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#111827; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; pointer-events:none; transition:.25s}
    .toast.show{opacity:1}
    .win{color:var(--accent); font-weight:700}

    /* ìµœê·¼ ì €ì¥ ë ˆì´ì•„ì›ƒ */
    ul.log{margin:8px 0 0 0; padding-left:0; list-style:none}
    ul.log li{display:flex; align-items:center; gap:6px; padding:8px 0; border-bottom:1px solid #f1f5f9}
    ul.log .item{flex:1 1 auto}
    .log .item .combined{display:block; font-size:14px;}
    .log .item .line1, .log .item .line2{display:none}
    @media (max-width:520px){
      ul.log li{align-items:flex-start}
      .log .item{display:flex; flex-direction:column; gap:2px}
      .log .item .combined{display:none}
      .log .item .line1, .log .item .line2{display:block}
      .log .item .line1{font-size:14px; color:var(--muted)}
      .log .item .line2{font-size:14px}
      .log li .btn{align-self:center; margin-left:8px}
    }

    header a.btn.primary{
      display:inline-block; white-space:nowrap;
      background:var(--accent) !important; color:#fff !important; border-color:var(--accent) !important;
    }
    @media (max-width:520px){
      header .row{justify-content:space-between}
      header a.btn.primary{flex:0 0 auto}
    }
    /* --- Help Modal --- */
.modal-backdrop{
  position:fixed; inset:0;
  background:rgba(0,0,0,.35);
  backdrop-filter:saturate(180%) blur(2px);
  z-index:60;
}
.modal{
  position:fixed; inset:auto 0 0 0;
  max-width:640px; margin:10vh auto 0;        /* í™”ë©´ ìœ„ìª½ì—ì„œ ë‚´ë ¤ì˜¤ë„ë¡ */
  background:#fff; border:1px solid #e5e7eb;
  border-radius:16px; box-shadow:var(--shadow);
  z-index:61; padding:14px;
}
.modal-header{
  display:flex; align-items:center; gap:8px;
  justify-content:space-between; border-bottom:1px solid #f1f5f9; padding-bottom:8px;
}
.modal-body{
  padding-top:10px; color:var(--ink); font-size:14px; line-height:1.5;
}
.modal-body h3{ margin:12px 0 6px; font-size:15px; color:var(--primary) }
.modal-body ul, .modal-body ol{ margin:6px 0 0 18px }

/* ë‚ ì§œ êµ¬ë¶„ì„  */
ul.log li.day-sep{
  border:0; padding:0; margin:10px 0;
}
ul.log li.day-sep hr{
  border:0; border-top:2px solid #cbd5e1;  /* í‰ì†Œ êµ¬ë¶„ì„ ë³´ë‹¤ ë‘ê»ê²Œ */
  margin:8px 0;
}


  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="gap:8px; align-items:center; justify-content:space-between">
        <h1 style="margin:4px 0 6px; font-size:clamp(18px,4vw,24px); color:var(--primary)">
          â­íƒêµ¬ ê²°ê³¼ ì…ë ¥
        </h1>
        <a id="reportBtn" href="monthly-report.html" class="btn primary">ì„ ìˆ˜ ë­í‚¹</a>
        <button id="helpBtn" class="btn" type="button">â” ë„ì›€ë§</button>
        

      </div>
    </div>
  </header>

  <main>
    <section class="active">
      <div class="card">
        <div class="row" style="gap:12px">
          <!-- ë‹¨/ë³µì‹ í† ê¸€ -->
          <div class="seg" id="modeSeg">
            <button data-mode="single" class="active">ë‹¨ì‹</button>
            <button data-mode="double">ë³µì‹</button>
          </div>
          <!-- ì„ íƒ ì´ˆê¸°í™”: í† ê¸€ ì˜† -->
          <button id="clearSel" class="btn sm">ì„ íƒ ì´ˆê¸°í™”</button>
          <a href="#" id="adminBtn" class="btn" role="button">âš™ï¸ ê´€ë¦¬ì</a>


          <!-- ì•ˆë‚´ ë¬¸êµ¬ -->
          <div class="meta" style="color:var(--muted); font-size:13px">
            <span id="hint">ë‹¨ì‹: <b>ë‘ ì„ ìˆ˜</b>ë¥¼ ì„ íƒí•œ ë’¤ ì•„ë˜ <b>ìŠ¹ì ë²„íŠ¼</b>ì„ ëˆ„ë¥´ë©´ ì €ì¥ë©ë‹ˆë‹¤.</span>
          </div>
        </div>

        <div id="chips" class="chips" style="margin-top:8px"></div>

        <div class="card" id="winnerBox" style="display:none; margin-top:12px">
          <div class="row center" style="gap:8px; margin-bottom:6px">
            <span class="btn sm" style="pointer-events:none">AíŒ€: <b id="teamA"></b></span>
            <span class="btn sm" style="pointer-events:none">BíŒ€: <b id="teamB"></b></span>
          </div>
          <div class="row center" style="gap:12px">
            <button id="winA" class="btn ok">ìŠ¹ì: AíŒ€</button>
            <button id="winB" class="btn warn">ìŠ¹ì: BíŒ€</button>
          </div>
          <div style="text-align:center; margin-top:6px; color:var(--muted); font-size:13px">
            ì €ì¥ í›„ ìë™ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.
          </div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:700; margin-bottom:6px">ìµœê·¼ ì €ì¥</div>
        <ul id="recent" class="log"></ul>
        <div id="recentEmpty" style="color:var(--muted); font-size:13px">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>
    </section>
  </main>
  <!-- ë„ì›€ë§ ëª¨ë‹¬ -->
<div id="helpBackdrop" class="modal-backdrop" style="display:none"></div>
<div id="helpModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="helpTitle" style="display:none">
  <div class="modal-header">
    <h2 id="helpTitle">ì´ìš© ì•ˆë‚´</h2>
    <button id="helpClose" class="btn sm" type="button">ë‹«ê¸°</button>
  </div>
  <div class="modal-body">
    <h3>âœ” ì„±ì  ì…ë ¥</h3>
    <ol>
      <li><b>ë‹¨ì‹/ë³µì‹</b>ì„ ì„ íƒí•©ë‹ˆë‹¤.</li>
      <li>ë‹¨ì‹ì€ <b>ë‘ ëª…</b>, ë³µì‹ì€ <b>ë„¤ ëª…</b>ì„ ì°¨ë¡€ëŒ€ë¡œ ì„ íƒí•©ë‹ˆë‹¤.<br/>
          (ë³µì‹: ì• ë‘ ëª… = AíŒ€, ë’¤ ë‘ ëª… = BíŒ€)</li>
      <li>ì•„ë˜ì— ë‚˜íƒ€ë‚˜ëŠ” <b>ìŠ¹ì ë²„íŠ¼</b>(AíŒ€ or BíŒ€)ì„ ëˆŒëŸ¬ ì €ì¥í•©ë‹ˆë‹¤.</li>
    </ol>

    <h3>âœ” ìµœê·¼ ì €ì¥ í™•ì¸</h3>
    <ul>
      <li>ì•„ë˜ <b>ìµœê·¼ ì €ì¥</b> ëª©ë¡ì—ì„œ ë°©ê¸ˆ ì…ë ¥í•œ ê²½ê¸°ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>ì˜¤ì…ë ¥ ì‹œ ì‚­ì œê°€ í•„ìš”í•˜ë©´ <b>ê´€ë¦¬ìì—ê²Œ ìš”ì²­</b>í•´ì£¼ì„¸ìš”.</li>
    </ul>

    <h3>âœ” ì´ë²ˆë‹¬ ì„±ì  í™•ì¸</h3>
    <ul>
      <li>ìƒë‹¨ì˜ <b>â€œğŸ“Š ì´ë²ˆë‹¬ ì„±ì  í™•ì¸â€</b> ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì›”ê°„ ì„±ì í‘œë¡œ ì´ë™í•©ë‹ˆë‹¤.</li>
      <li>ë‹¨ì‹/ë³µì‹, ìŠ¹/íŒ¨, ìŠ¹ë¥  ë° ë³€ë™ì´ ì§‘ê³„ë˜ì–´ í‘œì‹œë©ë‹ˆë‹¤.</li>
    </ul>

    <h3>â„¹ï¸ ì°¸ê³ </h3>
    <ul>
      <li>  <b>10ê²½ê¸° ì´ìƒ, ìŠ¹ë¥  70% ì´ìƒì‹œ</b>ë¶€ìˆ˜ ìƒí–¥ ê¶Œê³ í•©ë‹ˆë‹¤.</li>
    </ul>
  </div>
</div>


  <div id="toast" class="toast">Saved</div>

  <!-- Firebase SDK (ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getDatabase, ref, push, onValue, query, orderByChild, limitToLast, remove
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    /* í—¤ë” ë²„íŠ¼ ìë™ ìƒì„± (ìºì‹œ ëŒ€ë¹„) */
    (() => {
      const wrap = document.querySelector('header .wrap');
      const exists = document.getElementById('reportBtn');
      if (wrap && !exists) {
        const row = document.createElement('div');
        row.className = 'row';
        row.style.gap = '8px';
        row.style.alignItems = 'center';
        row.style.justifyContent = 'space-between';
        const h1 = document.createElement('h1');
        h1.textContent = 'KOEN íƒêµ¬ ì„±ì ì…ë ¥';
        h1.style.margin = '4px 0 6px';
        h1.style.fontSize = 'clamp(18px,4vw,24px)';
        h1.style.color = 'var(--primary)';
        const a = document.createElement('a');
        a.id = 'reportBtn';
        a.href = 'monthly-report.html';
        a.className = 'btn primary';
        a.textContent = 'ğŸ“Š ì´ë²ˆë‹¬ ì„±ì  í™•ì¸';
        row.append(h1, a);
        wrap.appendChild(row);
      }
    })();

    // 0) Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyC5iq3VY0QtBh8FVn70gi_Gsg7GXzkxdu8",
      authDomain: "koen-pingpong.firebaseapp.com",
      databaseURL: "https://koen-pingpong-default-rtdb.firebaseio.com",
      projectId: "koen-pingpong",
      storageBucket: "koen-pingpong.appspot.com",
      messagingSenderId: "597358811982",
      appId: "1:597358811982:web:b66dcb6a7159fb5f321c1f"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

// ===== ìˆ¨ê¹€ ì„ ìˆ˜ ëª©ë¡ ë™ê¸°í™” =====
let hiddenPlayers = [];
onValue(ref(db, 'hiddenPlayers'), (snapshot) => {
  hiddenPlayers = snapshot.val() || [];
  renderChips();  // ìˆ¨ê¹€ ëª©ë¡ì´ ë°”ë€Œë©´ ìë™ìœ¼ë¡œ UI ê°±ì‹ 
});

    // ===== ìœ í‹¸ =====
    const $ = (sel, ctx=document)=>ctx.querySelector(sel);
    const toast = (msg='ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤')=>{
      const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600)
    };
    const slugify = (s)=> s.replace(/[()]/g,'').replace(/\s+/g,'-').replace(/[^\p{L}\p{N}-]/gu,'').toLowerCase();

    // ë³µì‹ì´ë©´ '/', ë‹¨ì‹ì´ë©´ ' + '
    const fmtTeam = (arr, isDouble=false)=>{
      const joiner = isDouble ? '/' : ' + ';
      return arr.map(p=>p.name).join(joiner) || '-';
    };

    // ë‚ ì§œ í¬ë§·: 25ë…„ 08ì›” 30ì¼(í† ) 20:30 â€” KST
    const toKST = (t) => new Date(new Date(t ?? Date.now()).toLocaleString('en-US', { timeZone:'Asia/Seoul' }));
    const WEEK = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    const fmtYYMMDD_HHMM_WD = (t) => {
      const d = toKST(t);
      const yy = String(d.getFullYear()).slice(-2);
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      const wd = WEEK[d.getDay()];
      return `${yy}ë…„ ${mm}ì›” ${dd}ì¼(${wd}) ${hh}:${mi}`;
    };

    // ===== [ì¶”ê°€] ê´€ë¦¬ì ì„¤ì •(ë³´ì • íŒŒë¼ë¯¸í„° / ë³µì‹ ê°€ì¤‘ì¹˜) ë¶ˆëŸ¬ì˜¤ê¸° =====
    // ê¸°ë³¸ê°’
    let skillAdjust = { perLevel:0.05, minFav:0.6, maxDog:1.8 };
    let doubleWeight = 0.5;

    onValue(ref(db,'config/skillAdjust'), (s)=>{
      const v = s.val();
      if(v && typeof v==='object'){
        skillAdjust = {
          perLevel: Number(v.perLevel ?? 0.05),
          minFav:   Number(v.minFav   ?? 0.6 ),
          maxDog:   Number(v.maxDog   ?? 1.8 )
        };
      }
    });
    onValue(ref(db,'config/doubleWeight'), (s)=>{
      const v = s.val();
      if(v != null) doubleWeight = Number(v) || 0.5;
    });

    // [ì¶”ê°€] ê°€ì¤‘ì¹˜ ê³„ì‚° ìœ í‹¸
    const clamp = (min,x,max)=> Math.max(min, Math.min(max, x));
    // levelA/B: ìˆ«ì ì‘ì„ìˆ˜ë¡ ìƒìœ„(ê³ ìˆ˜), winner: 'A'|'B'
    function getAdjustedWeight(levelA, levelB, winner){
      const sa = skillAdjust;
      const la = (levelA ?? 99), lb = (levelB ?? 99);
      const d = Math.abs(la - lb);
      const aIsFav = la < lb; // ìˆ«ì ì‘ì„ìˆ˜ë¡ ìƒìœ„
      const favWin = clamp(sa.minFav, 1 - sa.perLevel*d, 1);
      const dogWin = clamp(1,        1 + sa.perLevel*d, sa.maxDog);
      if(winner === 'A'){
        return aIsFav ? favWin : dogWin;
      }else{
        const bIsFav = lb < la;
        return bIsFav ? favWin : dogWin;
      }
    }

    // ì‚­ì œ ë¹„ë°€ë²ˆí˜¸
    const DELETE_PASSWORD = '7910';

    // 1) ê¸°ë³¸ ì„ ìˆ˜
    const defaultPlayersRaw = [
      "ê¹€í¬ì˜(4)","ê°•ì„±ìš©(5)","ê¹€ë²”ì¼(5)","ì´ì˜ì§„(6)","ë°•ì£¼ë¯¼(6)","ê°•ë‹¤í›ˆ(6)",
      "ë°•ì§„ìš°(7)","ë°°ì„±êµ­(7)","ì´ìƒì¤€(7)","í™©ê²½ì§„(8)","ì–‘ì¶©í˜„(8)","ì„ì¶˜ê·¼(9)",
      "ë°•ì¸ì°¬(8)","ì „ì„±ë¬´(9)","ì†¡ì°½ê·¼(9)","ê¹€ìŠ¹ì¼(9)","ë¬¸ìš°ìš©(9)","ê¹€í˜„ê³¤(9)","ì˜¤êµ­í™˜(9)","ì¡°ë³´ë¯¸(11)",
      "ì†¡ì€ì•„(13)","ì´ë‚­ì£¼(13)","ë°•ë‚˜ë ¹(14)","ê³ ì€ì„ (14)","ì •ìŠ¹ëª©(14)","ì´ì„¸ë€(14)"
    ];
     // ğŸ”„ @@ ì¤‘ìš” @@   ì„ ìˆ˜ ì‚­ì œëŠ” ê´€ë¦¬ì ëª¨ë“œì—ì„œ í• ê²ƒ, ë‹¤ ê¼¬ì„
     // ğŸ”„ @@ ì¤‘ìš” @@   ì„ ìˆ˜ ì¶”ê°€ëŠ” ë§¨ ë’¤ì— ìˆœì„œëŒ€ë¡œ í• ê²ƒ 



    // ğŸ”„ ê¸°ì¡´ levelStyle(level) êµì²´
function levelStyle(level){
  // 4~14 ë¶€ìˆ˜ â†’ ì„œë¡œ í™•ì—°íˆ ë‹¤ë¥¸ 11ìƒ‰ (ë¹¨-ì£¼-ë…¸-ì—°ë‘-ì´ˆ-ì²­ë¡-í•˜ëŠ˜-ë‚¨-ë³´-ìí™-ë¡œì¦ˆ)
  const hues = [0, 25, 50, 95, 140, 185, 215, 245, 275, 310, 340];
  const L = Math.max(4, Math.min(14, Number(level) || 14));
  const idx = L - 4;                       // 0..10
  const hue = hues[idx] ?? 200;

  // ë°°ê²½ì€ ë°ê³  ì¨í•˜ê²Œ, í…Œë‘ë¦¬ëŠ” ë” ì§„í•˜ê²Œ, ì„ íƒ ì•„ì›ƒë¼ì¸ì€ í•œ í†¤ ë” ì§„í•˜ê²Œ
  const bg = `hsl(${hue} 85% 92%)`;
  const bd = `hsl(${hue} 60% 46%)`;
  const ol = `hsl(${hue} 65% 38%)`;
  return { bg, bd, ol };
}


    const players = defaultPlayersRaw.map((s,i)=>{
      const m = s.match(/^(.*)\((\d+)\)$/); if(!m) return null;
      const name = m[1]; const level = Number(m[2]);
      let id = slugify(name);
      return { id: id + '-' + i, name, level };
    }).filter(Boolean).sort((a,b)=> (a.level - b.level) || a.name.localeCompare(b.name,'ko'));

    // 2) ìƒíƒœ + UI
    const state = { mode:'single', sel:[] }; // mode: single|double
    const modeSeg = $('#modeSeg');
    const hintEl = $('#hint');

    modeSeg.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-mode]'); if(!btn) return;
      modeSeg.querySelectorAll('button').forEach(b=>b.classList.toggle('active', b===btn));
      state.mode = btn.dataset.mode;
      state.sel = [];
      renderChips(); renderWinnerBox();
      hintEl.innerHTML = state.mode==='single'
        ? 'ë‹¨ì‹: <b>ë‘ ì„ ìˆ˜</b>ë¥¼ ì„ íƒí•œ ë’¤ ì•„ë˜ <b>ìŠ¹ì ë²„íŠ¼</b>ì„ ëˆ„ë¥´ë©´ ì €ì¥ë©ë‹ˆë‹¤.'
        : 'ë³µì‹: <b>ë„¤ ì„ ìˆ˜</b>ë¥¼ ì„ íƒí•˜ì„¸ìš”. <b>ì• ë‘ ëª…=AíŒ€</b>, <b>ë’¤ ë‘ ëª…=BíŒ€</b>. (íŒ€ ë°”ê¾¸ë ¤ë©´ ì„ íƒì„ í•´ì œí•˜ê³  ë‹¤ì‹œ ì„ íƒí•˜ì„¸ìš”)';
    });

    function renderChips(){
      const box = $('#chips'); box.innerHTML='';
      const need = (state.mode==='single') ? 2 : 4;
      players.forEach(p => {
  // ğŸ”¹ ìˆ¨ê¹€ ì„ ìˆ˜ ëª©ë¡ì— ì´ë¦„ì´ í¬í•¨ë˜ì–´ ìˆë‹¤ë©´ í‘œì‹œí•˜ì§€ ì•ŠìŒ
  if (hiddenPlayers.includes(p.name)) return;

  const btn = document.createElement('button');
  btn.className = 'chip';
  btn.textContent = `${p.name}(${p.level})`;

  const { bg, bd, ol } = levelStyle(p.level);
  btn.style.setProperty('--chip-bg', bg);
  btn.style.setProperty('--chip-bd', bd);
  btn.style.setProperty('--chip-ol', ol);

  if (state.sel.some(x => x.id === p.id)) btn.classList.add('selected');

  btn.onclick = () => {
    const idx = state.sel.findIndex(x => x.id === p.id);
    if (idx >= 0) state.sel.splice(idx, 1);
    else {
      if (state.sel.length >= need) {
        toast(state.mode === 'single' ? 'ë‹¨ì‹ì€ ë‘ ëª…ë§Œ ì„ íƒ' : 'ë³µì‹ì€ ë„¤ ëª…ë§Œ ì„ íƒ');
        return;
      }
      state.sel.push(p);
    }
    renderChips();
    renderWinnerBox();
  };
  box.appendChild(btn);
});

    }

    function computeTeams(){
      const need = (state.mode==='single') ? 2 : 4;
      if(state.sel.length!==need) return null;
      let A = [], B = [];
      if(state.mode==='single'){
        A = [state.sel[0]]; B = [state.sel[1]];
      }else{
        A = [state.sel[0], state.sel[1]];
        B = [state.sel[2], state.sel[3]];
      }
      return {A,B};
    }

    function renderWinnerBox(){
      const wb = $('#winnerBox');
      const teams = computeTeams();
      if(teams){
        const isDouble = (state.mode === 'double');
        document.getElementById('teamA').textContent = fmtTeam(teams.A, isDouble);
        document.getElementById('teamB').textContent = fmtTeam(teams.B, isDouble);
        wb.style.display='';
      }else{
        wb.style.display='none';
      }
    }

    document.getElementById('clearSel').onclick  = ()=>{
      state.sel=[]; renderChips(); renderWinnerBox();
    };

    // 3) ì €ì¥  [ë³€ê²½: ê´€ë¦¬ì ê°€ì¤‘ì¹˜/ë³´ì • íŒŒë¼ë¯¸í„°ë¥¼ ì ìš©í•´ matchì— í•¨ê»˜ ì €ì¥]
    async function saveWinner(side){
      const teams = computeTeams();
      if(!teams){ toast(state.mode==='single'?'ë‘ ì„ ìˆ˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”':'ë„¤ ì„ ìˆ˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”'); return; }

      // Asia/Seoul ê¸°ì¤€ monthKey
      const nowKST = toKST();
      const monthKey = `${nowKST.getFullYear()}-${String(nowKST.getMonth()+1).padStart(2,'0')}`;

      const membersA = teams.A.map(p=>p.id), membersB = teams.B.map(p=>p.id);
      const namesA   = teams.A.map(p=>p.name), namesB   = teams.B.map(p=>p.name);
      const levelsA  = teams.A.map(p=>p.level), levelsB = teams.B.map(p=>p.level);

      // ===== [ì¶”ê°€] ë³´ì •/ê°€ì¤‘ì¹˜ ê³„ì‚° =====
      // ëŒ€í‘œ ë ˆë²¨: ë‹¨ì‹ì€ ê° 1ëª…, ë³µì‹ì€ íŒ€ ë‚´ ìµœìƒìœ„ì(ìˆ«ì ê°€ì¥ ì‘ì€ ë ˆë²¨)
      const repLevelA = (state.mode==='single') ? levelsA[0] : Math.min(...levelsA.map(v=> v ?? 99));
      const repLevelB = (state.mode==='single') ? levelsB[0] : Math.min(...levelsB.map(v=> v ?? 99));
      // ì‹¤ë ¥ì°¨ ë³´ì • ê°€ì¤‘
      const skillWeight = getAdjustedWeight(repLevelA, repLevelB, side); // side = 'A'|'B'
      // ë³µì‹ ê°€ì¤‘(ë‹¨ì‹ì€ 1)
      const dblWeight   = (state.mode==='double') ? (Number(doubleWeight)||0.5) : 1;
      // ìµœì¢… ê°€ì¤‘
      const finalWeight = skillWeight * dblWeight;

      const match = {
        ts: Date.now(),
        monthKey,
        type: state.mode,                 // 'single' | 'double'
        membersA, membersB,
        namesA, namesB,
        levelsA, levelsB,
        winnerSide: side,                 // 'A' | 'B'
        score: null,
        createdBy: (auth.currentUser && auth.currentUser.uid) || 'anon',
        createdAt: Date.now(),
        // [ì¶”ê°€ ì €ì¥] ê´€ë¦¬ì ì„¤ì • ë° ê³„ì‚° ê²°ê³¼
        weights: {
          params: {
            perLevel: skillAdjust.perLevel,
            minFav:   skillAdjust.minFav,
            maxDog:   skillAdjust.maxDog,
            doubleWeight
          },
          repLevelA, repLevelB,
          skillWeight,
          dblWeight,
          finalWeight
        }
      };

      try{
        await push(ref(db,'matches'), match);
        toast('ì„±ì ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        state.sel=[];
        renderChips(); renderWinnerBox();
      }catch(e){
        console.error(e);
        toast(e?.message || 'ì €ì¥ ì‹¤íŒ¨');
      }
    }
    document.getElementById('winA').onclick=()=>saveWinner('A');
    document.getElementById('winB').onclick=()=>saveWinner('B');

    // 4) ìµœê·¼ ì €ì¥ + ì‚­ì œ(ë¹„ë²ˆ 7910)
    async function deleteMatch(key){
      const pw = prompt('ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      if (pw === null) return;
      if (pw !== DELETE_PASSWORD){
        toast('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
        return;
      }
      if(!confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) return;

      try{
        await remove(ref(db, 'matches/'+key));
        toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }catch(e){
        console.error(e);
        toast(e?.message || 'ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    function watchRecent(){
  const q = query(ref(db,'matches'), orderByChild('ts'), limitToLast(50)); // ì—¬ìœ ìˆê²Œ 50ê±´
  onValue(q, snap=>{
    const ul = $('#recent'), empty = $('#recentEmpty');
    ul.innerHTML='';
    let arr = [];
    snap.forEach(child=>{
      arr.push({ key: child.key, m: child.val() });
    });

    if(!arr.length){ 
      empty.style.display=''; 
      return; 
    }
    empty.style.display='none';

    // ìµœì‹ ìˆœ ì •ë ¬
    arr.sort((a,b)=>(a.m.ts||0)-(b.m.ts||0));
    const recent = arr.slice(-50).reverse();

    // ğŸ”‘ ë‚ ì§œ í‚¤(KST ê¸°ì¤€) ìƒì„±
    const dateKeyKST = (t)=>{
      const d = toKST(t ?? Date.now());
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd= String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    };

    let prevDateKey = null;

    recent.forEach(({key, m}, idx)=>{
      const t = m.ts ?? m.createdAt ?? Date.now();
      const curKey = dateKeyKST(t);

      // âœ… ë‚ ì§œê°€ ë°”ë€Œë©´ êµµì€ ê°€ë¡œì¤„ ì‚½ì…
      if (prevDateKey && prevDateKey !== curKey){
        const sep = document.createElement('li');
        sep.className = 'day-sep';
        sep.innerHTML = '<hr />';
        ul.appendChild(sep);
      }
      prevDateKey = curKey;

      // í•­ëª© ë Œë”
      const li = document.createElement('li');

      const typeLabel = (m.type==='double') ? 'ë³µì‹' : 'ë‹¨ì‹';
      const joiner = (m.type === 'double') ? '/' : ' + ';

      const A = (m.namesA && m.namesA.length) ? m.namesA.join(joiner)
               : (m.membersA && m.membersA.length ? m.membersA.join(joiner) : 'A');
      const B = (m.namesB && m.namesB.length) ? m.namesB.join(joiner)
               : (m.membersB && m.membersB.length ? m.membersB.join(joiner) : 'B');

      const winIsA = (m.winnerSide === 'A');
      const ALabel = winIsA ? `<span class="win">${A} (ìŠ¹)</span>` : A;
      const BLabel = !winIsA ? `<span class="win">${B} (ìŠ¹)</span>` : B;

      const item = document.createElement('div');
      item.className = 'item';

      const dateText = fmtYYMMDD_HHMM_WD(t);
      item.innerHTML = `
        <div class="combined">${dateText} Â· [${typeLabel}] ${ALabel} vs ${BLabel}</div>
        <div class="line1">${dateText}</div>
        <div class="line2">[${typeLabel}] ${ALabel} vs ${BLabel}</div>
      `;

      const del = document.createElement('button');
      del.className='btn sm warn';
      del.textContent='ì‚­ì œ';
      del.onclick = ()=> deleteMatch(key);

      li.appendChild(item);
      li.appendChild(del);
      ul.appendChild(li);
    });
  });
}


    // 5) ì‹œì‘
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, ()=>{
      renderChips(); renderWinnerBox();
      watchRecent();
    });

    // ===== ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ê°€ë“œ =====
const ADMIN_PW  = '771225';
const ADMIN_KEY = 'koen.admin.ok';

function goAdminWithGuard(){
  if (sessionStorage.getItem(ADMIN_KEY) === '1') {
    location.href = 'admin.html';
    return;
  }
  const input = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
  if (input === null) return;
  if (input === ADMIN_PW) {
    sessionStorage.setItem(ADMIN_KEY, '1');
    location.href = 'admin.html';
  } else {
    alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
  }
}

const adminBtn = document.getElementById('adminBtn');
if (adminBtn) adminBtn.addEventListener('click', (e)=>{ e.preventDefault(); goAdminWithGuard(); });

// ===== ë„ì›€ë§ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° =====
const helpBtn      = document.getElementById('helpBtn');
const helpBackdrop = document.getElementById('helpBackdrop');
const helpModal    = document.getElementById('helpModal');
const helpClose    = document.getElementById('helpClose');

function openHelp(){
  if(!helpModal || !helpBackdrop) return;
  helpBackdrop.style.display = '';
  helpModal.style.display    = '';
  helpClose?.focus();
}

function closeHelp(){
  if(!helpModal || !helpBackdrop) return;
  helpBackdrop.style.display = 'none';
  helpModal.style.display    = 'none';
}

helpBtn?.addEventListener('click', (e)=>{ e.preventDefault(); openHelp(); });
helpClose?.addEventListener('click', closeHelp);
helpBackdrop?.addEventListener('click', closeHelp);
window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeHelp(); });


  </script>
</body>
</html>
