<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>íƒêµ¬ ë‹¨ì²´ì „ ìƒì„±ê¸°</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 20px; background-color: #f0f2f5; }
    h2 { text-align: center; color: #1a237e; }
    .section { margin-bottom: 20px; }
    .section h3 { text-align: center; color: #333; }
    .player-list { text-align: center; display: flex; flex-wrap: wrap; justify-content: center; gap: 0px; }
    .player { margin: 3px; padding: 4px 8px; font-size: 16px; border-radius: 6px; border: 1px solid #ccc; cursor: pointer; background: #ffffff; }
    .player.selected { background-color: #bbdefb; border: 2px solid #1e88e5; }

    /* ë¶€ìˆ˜ë³„ ìƒ‰ìƒ */
    .lv1to6 { background-color: #e8f5e9; }
    .lv7to9 { background-color: #e3f2fd; }
    .lv10to12 { background-color: #fff8e1; }
    .lv13to15 { background-color: #fce4ec; }
    .lv16to20 { background-color: #eeeeee; }

    /* ìƒˆë¡œ ì¶”ê°€ëœ ì„ ìˆ˜ ê°•ì¡° */
    .player.new-player {
      background-color: #fff176 !important;
      border: 2px solid #ccc;
      font-weight: bold;
      box-shadow: none;
      animation: highlightFlash 1.5s ease-in-out infinite alternate;
      color: black;
    }
    .player.new-player.selected {
      background-color: #fbc02d !important;
      border-color: #1e88e5;
      box-shadow: none;
      color: black !important;
    }
    @keyframes highlightFlash { from { background-color: #fff59d; } to { background-color: #ffe082; } }

    .player.leader { font-weight: bold; background-color: #ffe082; }
    .player.candidate { background-color: #e3f2fd; }
    .player.non-candidate { background-color: #fce4ec; }

    button { padding: 10px 16px; font-size: 16px; background-color: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; }

    .teams { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 20px; }
    .team-card { background: white; border: 1px solid #ccc; border-radius: 8px; padding: 10px 16px; box-shadow: 2px 2px 8px rgba(0,0,0,0.1); min-width: 180px; }
    .team-card h3 { margin-top: 0; color: #d32f2f; font-size: 18px; }
    .team-card ul { list-style: none; padding: 0; margin: 0; }
    .team-card li { margin: 4px 0; }

    .input-wrap { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .input-wrap input { padding: 6px; font-size: 14px; }
    .action-buttons { display: flex; justify-content: center; gap: 10px; margin: 20px 0; flex-wrap: wrap; }

    @media screen and (max-width: 600px) {
      .player { font-size: 14px; padding: 4px 8px; }
      .team-card { min-width: 90%; }
      .input-wrap { flex-direction: column; }
    }

    .scroll-table { overflow-x: auto; border: 1px solid #ccc; border-radius: 8px; margin-top: 20px; }
    .scroll-table table { border-collapse: collapse; width: 100%; min-width: 600px; background-color: white; }
    .scroll-table th, .scroll-table td { border: 1px solid #888; padding: 8px 12px; text-align: center; font-size: 16px; white-space: nowrap; }
    .scroll-table tr:nth-child(odd) td, .scroll-table tr:nth-child(odd) th { background-color: #f1f8ff; }
    .scroll-table tr:nth-child(even) td, .scroll-table tr:nth-child(even) th { background-color: #ffffff; }
    .scroll-table th:first-child, .scroll-table td:first-child { font-weight: bold; background-color: #ffe082 !important; }
    @media screen and (max-width: 600px) {
      .scroll-table th, .scroll-table td { font-size: 14px; padding: 6px 8px; }
    }
    #saveTeamImageButton { padding: 10px 16px; font-size: 16px; background-color: #43a047; color: white; border: none; border-radius: 4px; cursor: pointer; }

    .player-input-pair { display: flex; gap: 8px; align-items: center; }
    .player-input-pair input { padding: 6px; font-size: 14px; }
    #newName { width: 100px; }
    #newLevel { width: 60px; }
    .button-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .button-group button { padding: 6px 12px; font-size: 14px; }
    .hidden { display: none !important; }
/* ìˆ˜ë™ë°°ì •: êµì²´ ì„ íƒ í•˜ì´ë¼ì´íŠ¸ */
.swap-pending { outline: 2px dashed #ff6f00; border-radius: 6px; }

 /* ===== ë„ì›€ë§ ë²„íŠ¼ ===== */
    .help-button {
      position: fixed;
      top: 15px;
      right: 15px;
      background: #ffca28;
      color: #000;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: background 0.3s;
      z-index: 1001;
    }
    .help-button:hover {
      background: #ffc107;
    }

    /* ===== ëª¨ë‹¬ ë°°ê²½ ===== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000; /* ê¸°ì¡´ë³´ë‹¤ ë†’ê²Œ (ë„ì›€ë§ ë²„íŠ¼ë³´ë‹¤ ìš°ì„ ) */
    }

    /* ===== ëª¨ë‹¬ ì°½ ===== */
    .modal {
      background: #ffffff;
      border-radius: 12px;
      max-width: 420px;
      width: 90%;
      padding: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      animation: fadeIn 0.3s ease;
      position: relative;

      /* ì¶”ê°€ëœ ë¶€ë¶„ */
  max-height: 90vh;          /* í™”ë©´ ë†’ì´ì˜ 90%ê¹Œì§€ë§Œ í‘œì‹œ */
  overflow-y: auto;          /* ë‚´ìš©ì´ ë§ìœ¼ë©´ ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
  box-sizing: border-box;    /* íŒ¨ë”© í¬í•¨ */
    }
    @keyframes fadeIn {
      from {opacity: 0; transform: scale(0.9);}
      to {opacity: 1; transform: scale(1);}
    }

    /* ===== ë‹«ê¸° ë²„íŠ¼ ===== */
    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #e53935;
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .close-btn:hover {
      background: #d32f2f;
    }

    /* ===== ë„ì›€ë§ ë‚´ìš© ===== */
    .modal h2 {
      text-align: center;
      color: #1976d2;
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 20px;
    }

    .modal-section {
      margin-bottom: 14px;
    }

    .modal-section h3 {
      font-size: 16px;
      margin-bottom: 6px;
      color: #333;
    }

    .modal-section ul {
      margin: 0;
      padding-left: 18px;
    }

    .modal-section ul li {
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 4px;
    }

    /* ì´ëª¨ì§€ ê°•ì¡° */
    .emoji {
      font-weight: bold;
      margin-right: 4px;
    }
 

  </style>
</head>
<body>

  <h2>íƒêµ¬ ë‹¨ì²´ì „ ìƒì„±ê¸°</h2>

  <div class="input-wrap">
    <div class="player-input-pair">
      <input type="text" id="newName" placeholder="ì´ë¦„" />
      <input type="number" id="newLevel" placeholder="ë¶€ìˆ˜" min="1" max="20" />
    </div>
    <div class="button-group">
      <button onclick="addPlayer()">ì„ ìˆ˜ ì¶”ê°€</button>
      <button onclick="removeAddedPlayers()">ì¶”ê°€ ì„ ìˆ˜ ì‚­ì œ</button>
    </div>
  </div>


  <div class="section">
    <h3>ì°¸ì„ì ëª©ë¡</h3>
    <div class="player-list" id="playerList"></div>
  </div>

  <div class="action-buttons">
    <button onclick="assignTeams()">íŒ€ ìë™ ë°°ì •</button>
    <button onclick="startManualTeamAssign()">íŒ€ ìˆ˜ë™ ë°°ì •</button> <!-- â¬…ï¸ ì´ ì¤„ ì¶”ê°€ -->
    <button onclick="createExchangeMatch()">êµë¥˜ì „ ìƒì„±</button>
    <button onclick="resetAll()">ì „ì²´ ì´ˆê¸°í™”</button>
    <button id="saveTeamImageButton" onclick="saveTeamsAsImage()">íŒ€ ì´ë¯¸ì§€ ì €ì¥</button>
    <button onclick="uploadTeamsToFirebase()" style="background-color:#f57f17;">ê²½ê¸° ì‹œì‘</button>
  </div>

  <div class="teams" id="teams"></div>

  <div class="action-buttons">
    <div id="matchSchedule"></div>
  </div>

  
  <!-- ë„ì›€ë§ ë²„íŠ¼ -->
  <button class="help-button" onclick="openModal()">â”</button>

  <!-- ë„ì›€ë§ ëª¨ë‹¬ -->
<div class="modal-overlay" id="helpModal">
  <div class="modal">
  <button class="close-btn" onclick="closeModal()">âœ–</button>
  <h2>ğŸ“ KOEN ë‹¨ì²´ì „ ìƒì„±ê¸° ì‚¬ìš©ë²•</h2>

  <!-- 1ï¸âƒ£ ì„ ìˆ˜ ë“±ë¡ -->
  <div class="modal-section">
    <h3>1ï¸âƒ£ ì„ ìˆ˜ ë“±ë¡</h3>
    <ul>
      <li><span class="emoji">â•</span> ì´ë¦„ê³¼ ë¶€ìˆ˜ë¥¼ ì…ë ¥í•˜ê³  <b>ì„ ìˆ˜ ì¶”ê°€</b>ë¥¼ ëˆ„ë¥´ë©´ ìƒˆ ì„ ìˆ˜ ë“±ë¡</li>
      <li><span class="emoji">ğŸŸ¡</span> ìƒˆë¡œ ì¶”ê°€ëœ ì„ ìˆ˜ëŠ” <b>ë…¸ë€ìƒ‰</b>ìœ¼ë¡œ í‘œì‹œë˜ë©° <b>ìƒëŒ€íŒ€</b>ìœ¼ë¡œ ìë™ ë¶„ë¥˜ë¨</li>
      <li><span class="emoji">âœ–</span> ì˜ëª» ì¶”ê°€ëœ ì„ ìˆ˜ëŠ” ì´ë¦„ ì˜† <b>âœ– ë²„íŠ¼</b>ìœ¼ë¡œ ê°œë³„ ì‚­ì œ ê°€ëŠ¥</li>
      <li><span class="emoji">ğŸ—‘ï¸</span> <b>ì¶”ê°€ ì„ ìˆ˜ ì‚­ì œ</b> ë²„íŠ¼ìœ¼ë¡œ ì „ì²´ ì‚­ì œ ê°€ëŠ¥</li>
    </ul>
  </div>

  <!-- 2ï¸âƒ£ íŒ€ ë°°ì • -->
  <div class="modal-section">
    <h3>2ï¸âƒ£ íŒ€ ë°°ì •</h3>
    <ul>
      <li><b>íŒ€ ìë™ ë°°ì •</b>
        <ul>
          <li>ì°¸ì„ì ì„ íƒ ì‹œ ì„ íƒëœ ì¸ì›ë§Œ ë°°ì • (ì„ íƒì´ ì—†ìœ¼ë©´ ì „ì²´ ì¸ì›)</li>
          <li>íŒ€ ìˆ˜ë¥¼ ì„ íƒí•˜ë©´ <b>ì¸ì›ìˆ˜ì™€ ë¶€ìˆ˜í•©ì„ ê· ë“±í•˜ê²Œ</b> ìë™ ë¶„ë°°</li>
          <li>ë°°ì •ëœ íŒ€ì›ì€ ì¹´ë“œ í˜•íƒœë¡œ í‘œì‹œë˜ë©°, <b>êµì²´ / ì´ë™ / í•´ì œ</b> ê°€ëŠ¥</li>
        </ul>
      </li>
      <li><b>íŒ€ ìˆ˜ë™ ë°°ì •</b>
        <ul>
          <li>íŒ€ ìˆ˜ë¥¼ ì…ë ¥í•˜ë©´ ë¹ˆ íŒ€ì´ ìƒì„±ë¨</li>
          <li>ì°¸ì„ì ëª©ë¡ì˜ ì´ë¦„ ì˜† <b>â†’ íŒ€ ë²„íŠ¼</b>ì„ ëˆŒëŸ¬ ì§ì ‘ ë°°ì •</li>
          <li>íŒ€ ì¹´ë“œì—ì„œ <b>â†” êµì²´ / â†’ ì´ë™ / âœ– í•´ì œ</b> ê°€ëŠ¥</li>
          <li><b>+ íŒ€ì— ì„ ìˆ˜ ì¶”ê°€</b>ë¡œ ì¦‰ì„ ì¶”ê°€ ê°€ëŠ¥</li>
          <li><b>ìˆ˜ë™ íŒ€ ì €ì¥</b> í›„ â€œê²½ê¸° ì‹œì‘â€ì„ ëˆ„ë¥´ë©´ Firebaseì— ì—…ë¡œë“œë¨</li>
        </ul>
      </li>
    </ul>
  </div>

  <!-- 3ï¸âƒ£ êµë¥˜ì „ ìƒì„± -->
  <div class="modal-section">
    <h3>3ï¸âƒ£ êµë¥˜ì „ ìƒì„±</h3>
    <ul>
      <li><span class="emoji">âš”ï¸</span> <b>ìš°ë¦¬íŒ€ / ìƒëŒ€íŒ€ / í˜¼í•©íŒ€</b> íŒ€ ìˆ˜ë¥¼ ì„¤ì •</li>
      <li>í˜¼í•©íŒ€ì€ ìë™ìœ¼ë¡œ <b>ìš°ë¦¬íŒ€ + ìƒëŒ€íŒ€</b> ì¼ë¶€ê°€ ì„ì—¬ êµ¬ì„±ë¨</li>
      <li><b>ìš°ë¦¬íŒ€ â†” ìƒëŒ€íŒ€</b>ì€ ì ˆëŒ€ ì„ì´ì§€ ì•ŠìŒ</li>
      <li>í˜¼í•©íŒ€ì€ <b>ê°€ëŠ¥í•œ í•œ 1:1</b> ë¹„ìœ¨ ìœ ì§€, í•„ìš” ì‹œ ìë™ ì¡°ì •</li>
      <li>íŒ€ë³„ ì¸ì› ë° ë¶€ìˆ˜í•©ì„ ìë™ìœ¼ë¡œ ê· í˜• ì¡°ì •</li>
    </ul>
  </div>

  <!-- 4ï¸âƒ£ ê²½ê¸° ì‹œì‘ -->
  <div class="modal-section">
    <h3>4ï¸âƒ£ ê²½ê¸° ì‹œì‘</h3>
    <ul>
      <li><span class="emoji">ğŸš€</span> <b>ê²½ê¸° ì‹œì‘</b> ë²„íŠ¼ í´ë¦­ ì‹œ Firebaseì— íŒ€ ì •ë³´ ì €ì¥</li>
      <li>ì €ì¥ í›„ <b>ë‹¨ì²´ì „ ì§„í–‰ í˜ì´ì§€</b>ë¡œ ìë™ ì´ë™</li>
      <li><b>íŒ€ ì´ë¯¸ì§€ ì €ì¥</b> ë²„íŠ¼ìœ¼ë¡œ í˜„ì¬ í™”ë©´ì„ PNGë¡œ ì €ì¥ ê°€ëŠ¥</li>
    </ul>
  </div>

  <!-- 5ï¸âƒ£ ê¸°íƒ€ ê¸°ëŠ¥ -->
  <div class="modal-section">
    <h3>5ï¸âƒ£ ê¸°íƒ€ ê¸°ëŠ¥</h3>
    <ul>
      <li><span class="emoji">ğŸ”„</span> <b>ì „ì²´ ì´ˆê¸°í™”</b> â†’ íŒ€ ë° ì„ íƒ ì´ˆê¸°í™”</li>
      <li><span class="emoji">ğŸ“±</span> ëª¨ë°”ì¼ í™”ë©´ ìµœì í™” ì§€ì›</li>
      <li><span class="emoji">ğŸ’¾</span> Firebase ë¡œê·¸ì¸ì€ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë¨ (ìµëª… ë¡œê·¸ì¸)</li>
    </ul>
  </div>
</div>

</div>


  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ ìŠ¤í¬ë¦½íŠ¸ë“¤: body ë‹«ê¸° ì „ ë¡œë“œ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Firebase SDK (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>

    let exchangeSwapBuffer = null; // êµì²´ ê¸°ëŠ¥ ì„ì‹œ ì €ì¥ ë²„í¼

    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyA-tp3iJ8-n0yrrd8lwE1IgOdsmDqyh69k",
      authDomain: "koen-teamleague.firebaseapp.com",
      projectId: "koen-teamleague",
      storageBucket: "koen-teamleague.appspot.com", // ì‚¬ìš© ì•ˆ í•´ë„ ë¬´ë°©
      messagingSenderId: "487164547059",
      appId: "1:487164547059:web:658a10c8bfe7272ca78c86",
      databaseURL: "https://koen-teamleague-default-rtdb.firebaseio.com"
    };

    // Firebase ì´ˆê¸°í™”
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- ìµëª… ë¡œê·¸ì¸ ìœ í‹¸ ---
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ìµëª… ë¡œê·¸ì¸ ì‹œë„
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        console.log("âœ… ìµëª… ë¡œê·¸ì¸ë¨:", user.uid);
      } else {
        firebase.auth().signInAnonymously()
          .then(() => console.log("âœ… ìµëª… ë¡œê·¸ì¸ ì„±ê³µ"))
          .catch(err => console.error("âŒ ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨:", err));
      }
    });

    // í•„ìš”í•œ ì‹œì ì— ì¸ì¦ì„ ë³´ì¥í•˜ëŠ” í—¬í¼
    async function requireAuth() {
      const current = firebase.auth().currentUser;
      if (current) return current;
      await firebase.auth().signInAnonymously();
      return new Promise((resolve) => {
        const unsub = firebase.auth().onAuthStateChanged(u => {
          if (u) { unsub(); resolve(u); }
        });
      });
    }

    // ------ ì•± ìƒíƒœ ------
    let allPlayers = [
      { name: "ë…¸ì •ë¦¼", level: 3 }, { name: "ê¹€í¬ì˜", level: 4 }, { name: "ê°•ì„±ìš©", level: 5 }, { name: "ê¹€ë²”ì¼", level: 5 },
      { name: "ì´ì˜ì§„", level: 6 }, { name: "ë°•ì£¼ë¯¼", level: 6 }, { name: "ê°•ë‹¤í›ˆ", level: 6 },
      { name: "ë°•ì§„ìš°", level: 7 }, { name: "ë°°ì„±êµ­", level: 7 }, { name: "ì´ìƒì¤€", level: 7 },
      { name: "í™©ê²½ì§„", level: 8 }, { name: "ì–‘ì¶©í˜„", level: 8 }, { name: "ë°•ì¸ì°¬", level: 8 },
      { name: "ì„ì¶˜ê·¼", level: 9 }, { name: "ì „ì„±ë¬´", level: 9 }, { name: "ì†¡ì°½ê·¼", level: 9 },
      { name: "ê¹€ìŠ¹ì¼", level: 9 }, { name: "ê¹€í˜„ê³¤", level: 9 }, { name: "ë¬¸ìš°ìš©", level: 9 },
      { name: "ì˜¤êµ­í™˜", level: 9 }, { name: "ì¡°ë³´ë¯¸", level: 11 }, { name: "ì†¡ì€ì•„", level: 13 },
      { name: "ì´ë‚­ì£¼", level: 13 }, { name: "ë°•ìŠ¹ëª©", level: 14 }, { name: "ë°•ë‚˜ë ¹", level: 14 },
      { name: "ê³ ì€ì„ ", level: 14 }, { name: "ì´ì„¸ë€", level: 14 }
    ];

    // ì €ì¥ëœ ì¶”ê°€ ì„ ìˆ˜ ë³µì›
    const savedAddedPlayers = JSON.parse(localStorage.getItem("addedPlayers") || "[]");
    savedAddedPlayers.forEach(p => allPlayers.push({ ...p, new: true }));

    let selected = [];
    let exchangeTeams = {
  ourTeams: [],
  opponentTeams: [],
  mixedTeams: []
};

// === íŒ€ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ & ê°€ë…ì„± ë³´ì • ===
const TEAM_COLORS = [
  "#1976d2", // íŒŒë‘
  "#2e7d32", // ì´ˆë¡
  "#ef6c00", // ì£¼í™©
  "#6a1b9a", // ë³´ë¼
  "#c62828", // ë¹¨ê°•
  "#00897b", // ì²­ë¡
  "#283593", // ì¸ë””ê³ 
  "#f9a825"  // ë…¸ë‘
];
    let latestTeams = []; // ì—…ë¡œë“œìš© ì „ì—­ ì €ì¥ì†Œ

 function getExchangeGroup(groupType) {
  if (groupType === "ìš°ë¦¬íŒ€") return exchangeTeams.ourTeams;
  if (groupType === "ìƒëŒ€íŒ€") return exchangeTeams.opponentTeams;
  return exchangeTeams.mixedTeams;
}


   function renderPlayers() {
  const playerList = document.getElementById("playerList");
  playerList.innerHTML = "";

  allPlayers.forEach((p, i) => {
    const el = document.createElement("span");
    el.className = "player";

    // HTMLë¡œ ì´ë¦„ê³¼ ì‚­ì œ ë²„íŠ¼ êµ¬ì„±
    el.innerHTML = `
      ${p.name}(${p.level}ë¶€)
      ${p.new ? `<button onclick="removeSingleAddedPlayer(${i})" 
         style="margin-left:6px; font-size:12px; padding:2px 5px; background:#f44336; color:white; border:none; border-radius:4px; cursor:pointer;">âœ–</button>` : ''}
    `;

    // ì„ íƒ ê¸°ëŠ¥
    el.onclick = (e) => {
      if (e.target.tagName === 'BUTTON') return; // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ì„ íƒ í† ê¸€ ë°©ì§€
      toggleSelect(i, el);
    };

    // ë¶€ìˆ˜ ìƒ‰ìƒ
    if (p.level <= 6) el.classList.add("lv1to6");
    else if (p.level <= 9) el.classList.add("lv7to9");
    else if (p.level <= 12) el.classList.add("lv10to12");
    else if (p.level <= 15) el.classList.add("lv13to15");
    else el.classList.add("lv16to20");

    // ì‹ ê·œ ì„ ìˆ˜ ê°•ì¡°
    if (p.new) el.classList.add("new-player");
    if (selected.includes(i)) el.classList.add("selected");

    playerList.appendChild(el);
  });
}

// ê°œë³„ ì¶”ê°€ ì„ ìˆ˜ ì‚­ì œ
function removeSingleAddedPlayer(index) {
  const player = allPlayers[index];
  if (!player.new) return; // ê¸°ì¡´ ì„ ìˆ˜ëŠ” ê°œë³„ ì‚­ì œ ë¶ˆê°€

  if (!confirm(`${player.name} ì„ ìˆ˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

  // 1. allPlayers ë°°ì—´ì—ì„œ ì œê±°
  allPlayers.splice(index, 1);

  // 2. LocalStorageì—ì„œë„ ì œê±°
  const stored = JSON.parse(localStorage.getItem("addedPlayers") || "[]");
  const updated = stored.filter(p => !(p.name === player.name && p.level === player.level));
  localStorage.setItem("addedPlayers", JSON.stringify(updated));

  // 3. í™”ë©´ ìƒˆë¡œ ë Œë”ë§
  renderPlayers();
}

function renderExchangeTeams(teams = latestTeams) {
  const teamBox = document.getElementById("teams");
  teamBox.innerHTML = "";

  teams.forEach((team, teamIdx) => {

    const div = document.createElement("div");
    div.className = "team-card";
    div.id = `auto-team-${teamIdx}`;

    // í‰ê·  ê³„ì‚°
    const avg = team.members.length
      ? (team.sum / team.members.length).toFixed(2)
      : "-";

    div.innerHTML = `
      <h3>${team.name}</h3>
      <ul>
        ${team.members
          .map(
            (m, playerIdx) => `
            <li id="auto-${teamIdx}-p${playerIdx}" 
                style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
              <span>${m.name} (${m.level}ë¶€)</span>
              <span style="display:flex;gap:6px;">
                <button onclick="beginAutoSwap(${teamIdx}, ${playerIdx})"
                        style="font-size:12px;padding:4px 8px;">â†” êµì²´</button>
                <button onclick="moveAutoPlayer(${teamIdx}, ${playerIdx})"
                        style="font-size:12px;padding:4px 8px;">â†’ ì´ë™</button>
                <button onclick="removeAutoPlayer(${teamIdx}, ${playerIdx})"
                        style="font-size:12px;padding:4px 8px;">âœ– í•´ì œ</button>
              </span>
            </li>`
          )
          .join("")}
      </ul>
      <p><small>ë¶€ìˆ˜í•©: ${team.sum} / í‰ê· : ${avg}</small></p>
    `;

    teamBox.appendChild(div);
  });
}


function removeExchangePlayer(groupType, teamIdx, playerIdx) {
  let group;
  if (groupType === "ìš°ë¦¬íŒ€") group = exchangeTeams.ourTeams;
  else if (groupType === "ìƒëŒ€íŒ€") group = exchangeTeams.opponentTeams;
  else group = exchangeTeams.mixedTeams;

  const player = group[teamIdx].members[playerIdx];
  group[teamIdx].members.splice(playerIdx, 1);
  group[teamIdx].sum -= player.level;

  renderExchangeTeams();
}

// (B) ì´ë™: í•œ ì„ ìˆ˜ë¥¼ ë‹¤ë¥¸ íŒ€ìœ¼ë¡œ ì´ë™
function moveExchangePlayer(groupType, teamIdx, playerIdx) {
  // í˜„ì¬ ì„ íƒëœ íŒ€ ê·¸ë£¹ ê°€ì ¸ì˜¤ê¸°
  const sourceGroup = getExchangeGroup(groupType);
  const player = sourceGroup[teamIdx].members[playerIdx];

  // ëª¨ë“  íŒ€ ëª©ë¡ì„ í•˜ë‚˜ë¡œ í•©ì¹˜ê¸° (ìš°ë¦¬íŒ€ + ìƒëŒ€íŒ€ + í˜¼í•©íŒ€)
  const allGroups = [
    ...exchangeTeams.ourTeams.map((t, i) => ({ group: "ìš°ë¦¬íŒ€", teamIdx: i, name: t.name })),
    ...exchangeTeams.opponentTeams.map((t, i) => ({ group: "ìƒëŒ€íŒ€", teamIdx: i, name: t.name })),
    ...exchangeTeams.mixedTeams.map((t, i) => ({ group: "í˜¼í•©íŒ€", teamIdx: i, name: t.name }))
  ];

  // íŒ€ ëª©ë¡ì„ promptì— í‘œì‹œ
  const options = allGroups.map((g, i) => `${i}: [${g.group}] ${g.name}`).join("\n");
  const choice = prompt(`'${player.name}' ì´ë™í•  íŒ€ ì„ íƒ:\n${options}`);
  if (choice === null) return; // ì·¨ì†Œ ì‹œ ì¢…ë£Œ

  const selected = allGroups[parseInt(choice, 10)];
  if (!selected) {
    alert("ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤.");
    return;
  }

  // ë™ì¼ íŒ€ìœ¼ë¡œ ì´ë™í•˜ë ¤ëŠ” ê²½ìš° ë°©ì§€
  if (selected.group === groupType && selected.teamIdx === teamIdx) {
    alert("ê°™ì€ íŒ€ìœ¼ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // ---- ì´ë™ ì²˜ë¦¬ ----
  // ê¸°ì¡´ íŒ€ì—ì„œ ì œê±°
  sourceGroup[teamIdx].members.splice(playerIdx, 1);
  sourceGroup[teamIdx].sum -= player.level;

  // ìƒˆë¡œìš´ íŒ€ìœ¼ë¡œ ì¶”ê°€
  const targetGroup = getExchangeGroup(selected.group);
  targetGroup[selected.teamIdx].members.push(player);
  targetGroup[selected.teamIdx].sum += player.level;

  // í™”ë©´ ê°±ì‹ 
  renderExchangeTeams();
}


function beginExchangeSwap(groupType, teamIdx, playerIdx) {
  const liId = `ex-${groupType}-${teamIdx}-p${playerIdx}`;
  const li = document.getElementById(liId);

  // ì²« ë²ˆì§¸ ì„ íƒ
  if (!exchangeSwapBuffer) {
    exchangeSwapBuffer = { groupType, teamIdx, playerIdx, liId };
    if (li) li.classList.add('swap-pending');
    return;
  }

  // ë™ì¼í•œ ì„ ìˆ˜ í´ë¦­ â†’ ì·¨ì†Œ
  if (exchangeSwapBuffer.groupType === groupType &&
      exchangeSwapBuffer.teamIdx === teamIdx &&
      exchangeSwapBuffer.playerIdx === playerIdx) {
    const prevLi = document.getElementById(exchangeSwapBuffer.liId);
    if (prevLi) prevLi.classList.remove('swap-pending');
    exchangeSwapBuffer = null;
    return;
  }

  // ë‘ ë²ˆì§¸ ì„ íƒ â†’ ìŠ¤ì™‘
  const aTeam = getExchangeGroup(exchangeSwapBuffer.groupType)[exchangeSwapBuffer.teamIdx];
  const bTeam = getExchangeGroup(groupType)[teamIdx];
  const a = aTeam.members[exchangeSwapBuffer.playerIdx];
  const b = bTeam.members[playerIdx];

  // í•©ê³„ ê°±ì‹ 
  aTeam.sum = aTeam.sum - a.level + b.level;
  bTeam.sum = bTeam.sum - b.level + a.level;

  // ìŠ¤ì™‘
  aTeam.members[exchangeSwapBuffer.playerIdx] = b;
  bTeam.members[playerIdx] = a;

  renderExchangeTeams();
  exchangeSwapBuffer = null;
}


   function toggleSelect(i, el) {
  if (selected.includes(i)) {
    // ì´ë¯¸ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ ì„ íƒ í•´ì œ
    selected = selected.filter(v => v !== i);
    el.classList.remove("selected");
  } else {
    // ì„ íƒë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì„ íƒ
    selected.push(i);
    el.classList.add("selected");
  }
}

    function shuffle(arr) {
      return arr.map(a => [Math.random(), a]).sort((a, b) => a[0] - b[0]).map(a => a[1]);
    }

function assignTeams() {
  
  // ì°¸ê°€ì ì„ íƒ
  let pool = selected.length ? [...selected] : allPlayers.map((_, i) => i);
  if (pool.length < 2) {
    alert("ì„ ìˆ˜ê°€ 2ëª… ì´ìƒ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.");
    return;
  }

  // âœ… íŒ€ ìˆ˜ ì„ íƒ ëª¨ë‹¬ì°½ ë§Œë“¤ê¸°
  const existingPopup = document.getElementById("teamSelectPopup");
  if (existingPopup) existingPopup.remove();

  const popup = document.createElement("div");
  popup.id = "teamSelectPopup";
  popup.style.position = "fixed";
  popup.style.top = "0";
  popup.style.left = "0";
  popup.style.width = "100%";
  popup.style.height = "100%";
  popup.style.background = "rgba(0,0,0,0.6)";
  popup.style.display = "flex";
  popup.style.alignItems = "center";
  popup.style.justifyContent = "center";
  popup.style.zIndex = "3000";

  popup.innerHTML = `
    <div style="background:#fff; border-radius:12px; padding:20px; width:320px; text-align:center;">
      <h3 style="margin-top:0; color:#1976d2;">ğŸ“ íŒ€ ìë™ ë°°ì •</h3>
      <p>íŒ€ ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš” (2~8íŒ€)</p>
      <div style="display:flex; flex-wrap:wrap; justify-content:center; gap:8px; margin-top:10px;">
        ${[2,3,4,5,6,7,8].map(n => 
          `<button class="btn-option" 
  style="padding:8px 12px; border-radius:6px; border:1px solid #1976d2; background:#e3f2fd; color:#0d47a1; font-weight:bold; cursor:pointer;"
  onclick="confirmTeamCount(${n})">${n}íŒ€</button>
`
        ).join("")}
      </div>
      <div style="margin-top:16px;">
        <button onclick="document.body.removeChild(document.getElementById('teamSelectPopup'))"
                style="padding:8px 16px; background:#999; color:white; border:none; border-radius:6px; cursor:pointer;">
          ì·¨ì†Œ
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(popup);

  // âœ… ì„ íƒí•œ íŒ€ ìˆ˜ë¥¼ ì‹¤ì œ ë°°ì •ì— ë°˜ì˜
 window._assignPool = pool; // ì´ í•œ ì¤„ë§Œ ë‚¨ê¸°ê³  ìœ„ ì½”ë“œëŠ” ì‚­ì œ
  };


function confirmTeamCount(teamCount) {
  const popup = document.getElementById("teamSelectPopup"); // ì„ íƒì°½ ë‹«ê¸°
  if (popup) document.body.removeChild(popup);

  if (window._assignPool) { // ì´ì „ì— ì €ì¥í•´ë‘” ì„ ìˆ˜ ëª©ë¡ ì‚¬ìš©
    runTeamAssignment(teamCount, window._assignPool);
  }
}

// âœ… ì‹¤ì œ íŒ€ ë°°ì • ë¡œì§ (ê¸°ì¡´ ë‚´ìš© ê·¸ëŒ€ë¡œ)
function runTeamAssignment(teamCount, pool) {
  if (isNaN(teamCount) || teamCount < 2 || teamCount > 8) {
    alert("2~8 ì‚¬ì´ì˜ íŒ€ ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }

  const players = pool.map(i => allPlayers[i]);
  shuffle(players);
  players.sort((a, b) => b.level - a.level); // ê°•ì ë¨¼ì € ë°°ì •

  // íŒ€ ì´ˆê¸°í™”
  const teams = Array.from({ length: teamCount }, (_, i) => ({
    name: `${i + 1}íŒ€`,
    members: [],
    sum: 0
  }));

  // ì¸ì› ê· ë“± ë¶„ë°°
  const total = players.length;
  const base = Math.floor(total / teamCount);
  const extra = total % teamCount;
  const maxPerTeam = teams.map((_, i) => (i < extra ? base + 1 : base));

  players.forEach(p => {
    const candidates = teams.filter((t, i) => t.members.length < maxPerTeam[i]);
    const target = candidates.reduce((a, b) => {
      const avgA = a.members.length ? a.sum / a.members.length : 0;
      const avgB = b.members.length ? b.sum / b.members.length : 0;
      return avgA < avgB ? a : b;
    });
    target.members.push(p);
    target.sum += p.level;
  });

  // ê· í˜• ì¡°ì • ë°˜ë³µ (ê¸°ì¡´ ê·¸ëŒ€ë¡œ)
  const calcAvg = t => (t.members.length ? t.sum / t.members.length : 0);
  let improved = true;
  let attempt = 0;
  while (improved && attempt < 30) {
    improved = false;
    attempt++;
    const avgs = teams.map(calcAvg);
    const maxIdx = avgs.indexOf(Math.max(...avgs));
    const minIdx = avgs.indexOf(Math.min(...avgs));
    const high = teams[maxIdx];
    const low = teams[minIdx];
    const diffBefore = Math.abs(calcAvg(high) - calcAvg(low));
    if (diffBefore < 0.3) break;

    let bestPair = null;
    let bestImprovement = 0;
    high.members.forEach(h => {
      low.members.forEach(l => {
        const newHighAvg = (high.sum - h.level + l.level) / high.members.length;
        const newLowAvg = (low.sum - l.level + h.level) / low.members.length;
        const diffAfter = Math.abs(newHighAvg - newLowAvg);
        const improvement = diffBefore - diffAfter;
        if (improvement > bestImprovement) {
          bestImprovement = improvement;
          bestPair = { h, l };
        }
      });
    });

    if (bestPair && bestImprovement > 0) {
      const hiIdx = high.members.indexOf(bestPair.h);
      const loIdx = low.members.indexOf(bestPair.l);
      high.members[hiIdx] = bestPair.l;
      low.members[loIdx] = bestPair.h;
      high.sum = high.members.reduce((s, p) => s + p.level, 0);
      low.sum = low.members.reduce((s, p) => s + p.level, 0);
      improved = true;
    }
  }

  // ê²°ê³¼ ì¶œë ¥
  latestTeams = teams;
  assignTeamsRender(latestTeams);
  console.log("=== ìë™ë°°ì • ê²°ê³¼ ===");
  teams.forEach(t => {
    const avg = (t.sum / t.members.length).toFixed(2);
    console.log(`${t.name}: ${t.members.length}ëª…, í‰ê·  ${avg}`);
  });
}


function pickMixedPlayers(ourPlayers, opponentPlayers, mixedCount) {
  if (mixedCount === 0) return [];

  const ourCopy = [...ourPlayers];
  const oppCopy = [...opponentPlayers];
  const mixedPlayers = [];

  // ì „ì²´ ì¸ì› ëŒ€ë¹„ í˜¼í•©íŒ€ ë¹„ìœ¨ (ìµœëŒ€ 15%)
  const total = ourCopy.length + oppCopy.length;
  const targetMixed = Math.min(Math.floor(total * 0.15), mixedCount * 4); // í˜¼í•©íŒ€ë‹¹ 4ëª… ê¸°ì¤€

  // ê° í˜¼í•©íŒ€ë‹¹ ì¸ì›
  const perTeam = Math.max(2, Math.floor(targetMixed / mixedCount));

  // ê°€ëŠ¥í•œ í•œ 1:1ë¡œ, ë‚¨ìœ¼ë©´ ìƒëŒ€íŒ€ì—ì„œ ì±„ì›€
  for (let i = 0; i < mixedCount; i++) {
    const half = Math.floor(perTeam / 2);
    const ourPart = shuffle(ourCopy).splice(0, half);
    const oppPart = shuffle(oppCopy).splice(0, perTeam - half);
    mixedPlayers.push(...ourPart, ...oppPart);
  }

  // ë‚¨ì€ ì¸ì›ì€ ê°ì íŒ€ì—ì„œë§Œ ì‚¬ìš©
  return mixedPlayers;
}




function distributePlayersBalanced(players, teams, targets = null) {
  if (!players?.length || !teams?.length) return;

  const sorted = [...players].sort((a, b) => a.level - b.level);
  const n = teams.length;

  // íŒ€ë³„ ëª©í‘œ ì¸ì› ì„¤ì •
  if (targets && targets.length === n) {
    teams.forEach((t, i) => { t.members = []; t.sum = 0; t.target = Math.max(0, targets[i] | 0); });
  } else {
    const base = Math.floor(sorted.length / n);
    const extra = sorted.length % n;
    teams.forEach((t, i) => { t.members = []; t.sum = 0; t.target = base + (i < extra ? 1 : 0); });
  }

  // 1) ì´ˆê¸° ë¶„ë°°: í˜„ì¬ í‰ê· ì´ ë‚®ì€ íŒ€ë¶€í„° ì±„ìš°ê¸°
  sorted.forEach(p => {
    const cand = teams
      .filter(t => t.members.length < t.target)
      .sort((a, b) => (a.sum / (a.members.length || 1)) - (b.sum / (b.members.length || 1)))[0];
    if (!cand) return; // ëª©í‘œì¹˜ ë‹¤ ì°¼ìœ¼ë©´ ë¬´ì‹œ
    cand.members.push(p);
    cand.sum += p.level;
  });

  // 2) ë¶€ìˆ˜ ê· í˜• ë¯¸ì„¸ì¡°ì •
  for (let loop = 0; loop < 50; loop++) {
    const filled = teams.filter(t => t.members.length > 0);
    if (filled.length < 2) break;
    const avgs = teams.map(t => t.members.length ? t.sum / t.members.length : Infinity);
    const hi = avgs.indexOf(Math.max(...avgs.filter(v => isFinite(v))));
    const lo = avgs.indexOf(Math.min(...avgs.filter(v => isFinite(v))));
    const diff = avgs[hi] - avgs[lo];
    if (diff < 0.5) break;

    const high = teams[hi], low = teams[lo];
    let bestPair = null, bestGain = 0;
    for (const h of high.members) {
      for (const l of low.members) {
        const newDiff = Math.abs((high.sum - h.level + l.level) / high.members.length -
                                 (low.sum - l.level + h.level) / low.members.length);
        const gain = diff - newDiff;
        if (gain > bestGain) { bestGain = gain; bestPair = { h, l }; }
      }
    }
    if (bestPair) {
      const hiIdx = high.members.indexOf(bestPair.h);
      const loIdx = low.members.indexOf(bestPair.l);
      high.members[hiIdx] = bestPair.l;
      low.members[loIdx] = bestPair.h;
      high.sum = high.members.reduce((s, p) => s + p.level, 0);
      low.sum = low.members.reduce((s, p) => s + p.level, 0);
    } else break;
  }
}

// ì „ì²´ íŒ€ì— ëŒ€í•´ "ìµœëŒ€í•œ ê°™ì€ ì¸ì›"ì´ ë˜ë„ë¡ ëª©í‘œ ì¸ì› ë¶„ë°°
function computeTargets(totalPlayers, ourCount, opponentCount, mixedCount) {
  const totalTeams = ourCount + opponentCount + mixedCount;
  const base = Math.floor(totalPlayers / totalTeams);
  let extra = totalPlayers % totalTeams;

  // ë¶„ë°° ìˆœì„œëŠ” í¬ê²Œ ì¤‘ìš”ì¹˜ ì•Šì§€ë§Œ, ì¼ê´€ì„± ìˆê²Œ ìš°ë¦¬â†’ìƒëŒ€â†’í˜¼í•© ìˆœìœ¼ë¡œ +1ì”© ë°°ë¶„
  const mk = (cnt) => Array.from({length: cnt}, () => base);
  const ourTargets = mk(ourCount);
  const opponentTargets = mk(opponentCount);
  const mixedTargets = mk(mixedCount);

  const buckets = [ourTargets, opponentTargets, mixedTargets];
  while (extra > 0) {
    for (const arr of buckets) {
      for (let i = 0; i < arr.length && extra > 0; i++) { arr[i] += 1; extra--; }
      if (extra === 0) break;
    }
  }
  return { ourTargets, opponentTargets, mixedTargets };
}

// í˜¼í•©íŒ€ì— í•„ìš”í•œ "ì´ ì¸ì›ìˆ˜"ë¥¼ ë¨¼ì € ë§ì¶°ì„œ ë½‘ê¸°
// ê°€ëŠ¥í•˜ë©´ 1:1, ë¶€ì¡±í•˜ë©´ í•œìª½ìœ¼ë¡œ ì±„ì›€(= 1:1 ê·œì¹™ ê¹¨ë„ OK)
function pickMixedPlayersByTarget(ourPlayers, opponentPlayers, mixedTargets) {
  const need = mixedTargets.reduce((a,b)=>a+b, 0);
  if (need <= 0) return { mixedPlayers: [], remainingOur: ourPlayers, remainingOpp: opponentPlayers };

  const ourPool = [...ourPlayers];
  const oppPool = [...opponentPlayers];

  // ê¸°ë³¸ 1:1 ì‹œë„
  let ourNeed = Math.floor(need / 2);
  let oppNeed = need - ourNeed;

  // í•œìª½ ë¶€ì¡±í•˜ë©´ ë‹¤ë¥¸ ìª½ìœ¼ë¡œ ì±„ìš°ê¸°
  if (ourPool.length < ourNeed) {
    oppNeed += (ourNeed - ourPool.length);
    ourNeed = ourPool.length;
  }
  if (oppPool.length < oppNeed) {
    ourNeed += (oppNeed - oppPool.length);
    oppNeed = oppPool.length;
    if (ourNeed > ourPool.length) ourNeed = ourPool.length;
  }

  const take = (pool, k) => shuffle(pool).slice(0, k);
  const ourTake = take(ourPool, ourNeed);
  const oppTake = take(oppPool, oppNeed);

  const mixedPlayers = [...ourTake, ...oppTake];

  // ë‚¨ì€ í’€
  const ourRemainSet = new Set(ourTake.map(p=>p.name));
  const oppRemainSet = new Set(oppTake.map(p=>p.name));
  const remainingOur = ourPlayers.filter(p => !ourRemainSet.has(p.name));
  const remainingOpp = opponentPlayers.filter(p => !oppRemainSet.has(p.name));

  return { mixedPlayers, remainingOur, remainingOpp };
}


function generateExchangeTeams(ourName, opponentName, ourCount, opponentCount, mixedCount) {
  exchangeTeams = { ourTeams: [], opponentTeams: [], mixedTeams: [] };
  latestTeams = [];
  const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

  // ì„ íƒ ì§‘í•©
  const selectedPlayers = selected.length ? selected.map(i => allPlayers[i]) : allPlayers;
  const ourPlayers = selectedPlayers.filter(p => !p.new);
  const opponentPlayers = selectedPlayers.filter(p => p.new);

  if (ourPlayers.length === 0 || opponentPlayers.length === 0) {
    alert("âš ï¸ ìš°ë¦¬íŒ€ ë˜ëŠ” ìƒëŒ€íŒ€ ì¸ì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
    return;
  }

  const totalPlayers = ourPlayers.length + opponentPlayers.length;

  // 1) íŒ€ë³„ ëª©í‘œ ì¸ì› ê³„ì‚° (ì „ì²´ íŒ€ì´ ìµœëŒ€í•œ ê°™ì€ ì¸ì›)
  const { ourTargets, opponentTargets, mixedTargets } =
    computeTargets(totalPlayers, ourCount, opponentCount, mixedCount);

  // 2) í˜¼í•©íŒ€ ì¸ì› ë¨¼ì € í™•ë³´ (ê°€ëŠ¥í•˜ë©´ 1:1, ë¶€ì¡±í•˜ë©´ ê¹¨ë„ ë¨)
  const { mixedPlayers, remainingOur, remainingOpp } =
    pickMixedPlayersByTarget(ourPlayers, opponentPlayers, mixedTargets);

  // 3) íŒ€ ê°ì²´ ìƒì„±
  exchangeTeams.ourTeams = Array.from({ length: ourCount }, (_, i) => ({
    name: `${ourName} ${alphabet[i] || i + 1}íŒ€`, members: [], sum: 0
  }));
  exchangeTeams.opponentTeams = Array.from({ length: opponentCount }, (_, i) => ({
    name: `${opponentName} ${alphabet[i] || i + 1}íŒ€`, members: [], sum: 0
  }));
  exchangeTeams.mixedTeams = Array.from({ length: mixedCount }, (_, i) => ({
    name: `í˜¼í•© ${alphabet[i] || i + 1}íŒ€`, members: [], sum: 0
  }));

  // 4) ë¶„ë°° (êµì°¨ ê¸ˆì§€ ì¤€ìˆ˜)
  distributePlayersBalanced(remainingOur, exchangeTeams.ourTeams, ourTargets);
  distributePlayersBalanced(remainingOpp, exchangeTeams.opponentTeams, opponentTargets);
  distributePlayersBalanced(mixedPlayers, exchangeTeams.mixedTeams, mixedTargets);

  // 5) ê²°ê³¼ ë¬¶ì–´ì„œ ë Œë”
  latestTeams = [
    ...exchangeTeams.ourTeams,
    ...exchangeTeams.opponentTeams,
    ...exchangeTeams.mixedTeams
  ];
  renderExchangeTeams(latestTeams);

  console.log("âœ… êµë¥˜ì „ ìƒì„± ì™„ë£Œ (íŒ€ë³„ ëª©í‘œ ì¸ì› ì¶©ì¡± + ë¶€ìˆ˜ ê· í˜•, 1:1ì€ ê°€ëŠ¥í•  ë•Œë§Œ)");
}


function balanceTeamMemberCounts(allTeams) {
  if (!allTeams?.length) return;
  const avgCount = allTeams.reduce((s,t)=>s+t.members.length,0) / allTeams.length;

  // ì¸ì›ì´ ë„ˆë¬´ ë§ì€ íŒ€ â†’ ì´ˆê³¼ ì¸ì› ë¹¼ì„œ ë¶€ì¡±í•œ íŒ€ìœ¼ë¡œ ì´ë™
  for (let loop=0; loop<20; loop++) {
    const maxTeam = allTeams.reduce((a,b)=>a.members.length>b.members.length?a:b);
    const minTeam = allTeams.reduce((a,b)=>a.members.length<b.members.length?a:b);
    const diff = maxTeam.members.length - minTeam.members.length;
    if (diff <= 1) break; // Â±1 ì´ë‚´ë©´ ì¢…ë£Œ

    // ë¶€ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ê°„ê°’ ê°€ê¹Œìš´ ì„ ìˆ˜ í•˜ë‚˜ ì´ë™
    const sorted = [...maxTeam.members].sort((a,b)=>Math.abs(a.level-8)-Math.abs(b.level-8));
    const move = sorted[0];
    if (!move) break;

    maxTeam.members.splice(maxTeam.members.indexOf(move),1);
    minTeam.members.push(move);

    maxTeam.sum = maxTeam.members.reduce((s,p)=>s+p.level,0);
    minTeam.sum = minTeam.members.reduce((s,p)=>s+p.level,0);
  }

  console.log("âš–ï¸ ì „ì²´ íŒ€ ì¸ì› ê· í˜• ì¡°ì • ì™„ë£Œ");
}





// === êµë¥˜ì „ ìƒì„± (UI ëª¨ë‹¬ë¡œ ë³€ê²½) ===
function createExchangeMatch() {
  document.getElementById('exchangeModal').style.display = 'flex';
}

// ëª¨ë‹¬ ë‹«ê¸°
function closeExchangeModal() {
  document.getElementById('exchangeModal').style.display = 'none';
}

// êµë¥˜ì „ ìƒì„± í™•ì¸
function confirmExchangeMatch() {
  const ourName = document.getElementById('ourTeamInput').value.trim() || "ìš°ë¦¬íŒ€";
  const opponentName = document.getElementById('opponentTeamInput').value.trim() || "ìƒëŒ€íŒ€";
  const ourCount = parseInt(document.getElementById('ourCountInput').value, 10);
  const opponentCount = parseInt(document.getElementById('opponentCountInput').value, 10);
  const mixedCount = parseInt(document.getElementById('mixedCountInput').value, 10);

  closeExchangeModal();

  if (isNaN(ourCount) || isNaN(opponentCount) || ourCount < 0 || opponentCount < 0) {
    alert("âš ï¸ íŒ€ ìˆ˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  // ê¸°ì¡´ ë¡œì§ ì¬ì‚¬ìš©
  window.currentExchange = {
    exchangeName: `${ourName}-${opponentName} êµë¥˜ì „`,
    teamA: ourName,
    teamB: opponentName
  };

  // ê¸°ì¡´ êµë¥˜ì „ ìƒì„± ì½”ë“œ ì‹¤í–‰
  generateExchangeTeams(ourName, opponentName, ourCount, opponentCount, mixedCount);
}




    function saveTeamsAsImage() {
      const teamsArea = document.getElementById("teams");
      if (!teamsArea || teamsArea.innerHTML.trim() === "") {
        alert("íŒ€ì´ ë¨¼ì € ìƒì„±ë˜ì–´ì•¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        return;
      }
      html2canvas(teamsArea).then(canvas => {
        const link = document.createElement("a");
        link.download = "íƒêµ¬_íŒ€_êµ¬ì„±.png";
        link.href = canvas.toDataURL();
        link.click();
      });
    }

    function addPlayer() {
      const nameInput = document.getElementById("newName");
      const levelInput = document.getElementById("newLevel");

      const name = nameInput.value.trim();
      const level = parseInt(levelInput.value, 10);

      if (!name || isNaN(level) || level < 1 || level > 20) {
        alert("ì´ë¦„ê³¼ ë¶€ìˆ˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ë¶€ìˆ˜ëŠ” 1~20)");
        return;
      }

      const newPlayer = { name, level, new: true };
      allPlayers.push(newPlayer);

      const stored = JSON.parse(localStorage.getItem("addedPlayers") || "[]");
      stored.push(newPlayer);
      localStorage.setItem("addedPlayers", JSON.stringify(stored));

      nameInput.value = "";
      levelInput.value = "";
      renderPlayers();
    }

  async function uploadTeamsToFirebase() {
  try {
    if (!latestTeams || latestTeams.length === 0) {
      alert("âš ï¸ íŒ€ì´ ë¨¼ì € ìƒì„±ë˜ì–´ì•¼ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      return;
    }

    await requireAuth();

    // 1ï¸âƒ£ íŒ€ ë°ì´í„° ì €ì¥
    const firebaseData = {};
    latestTeams.forEach((team, idx) => {
      const teamName = team.teamName || team.name || `íŒ€${idx + 1}`;
      const players = [...team.members].sort((a, b) => a.level - b.level);
      firebaseData[`team${idx + 1}`] = { teamName, players };
    });
    await db.ref("teams").set(firebaseData);

    // 2ï¸âƒ£ êµë¥˜ì „ ì •ë³´ ì €ì¥ (ëˆ„ì  ì €ì¥)
    if (window.currentExchange) {
      const { exchangeName, teamA, teamB } = window.currentExchange;
      const newMatchKey = db.ref("matches").push().key;

      await db.ref(`matches/${newMatchKey}`).set({
        exchangeName,
        teamA,
        teamB,
        matchList: []
      });
    }

    // 3ï¸âƒ£ í˜ì´ì§€ ì´ë™
    setTimeout(() => {
      window.location.href = "https://sensational-tulumba-65e97e.netlify.app/pingpong/club/team-match-run/";
    }, 500);

  } catch (err) {
    console.error("âŒ ì—…ë¡œë“œ ì‹¤íŒ¨:", err);
    alert("âŒ Firebase ì—…ë¡œë“œ ì‹¤íŒ¨\nìì„¸í•œ ë‚´ìš©ì€ ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
  }
}



    function removeAddedPlayers() {
      if (!confirm("ì¶”ê°€í•œ ì„ ìˆ˜ë“¤ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      allPlayers = allPlayers.filter(p => !p.new);
      localStorage.removeItem("addedPlayers");
      renderPlayers();
    }

    // ìµœì´ˆ ë Œë”
    renderPlayers();

    // âœ… ìˆ˜ë™ íŒ€ êµ¬ì„± ìƒíƒœ
let manualTeams = [];
let manualAssigned = new Set(); // ì¤‘ë³µ ë°°ì • ë°©ì§€
let manualPool = [];      // ìˆ˜ë™ë°°ì • í’€(ë¯¸ë°°ì •/ì°¸ê°€ì ëª©ë¡) ì¸ë±ìŠ¤ ë³´ê´€
let swapBuffer = null;    // { teamIdx, playerIdx } í˜•íƒœë¡œ 1ì°¨ ì„ íƒ ì €ì¥



// ë°°ê²½ìƒ‰ì— ë§ì¶° ê¸€ììƒ‰(ê²€/í°) ê²°ì •
function contrastText(hex) {
  const c = hex.replace("#",""); 
  const r = parseInt(c.substr(0,2),16);
  const g = parseInt(c.substr(2,2),16);
  const b = parseInt(c.substr(4,2),16);
  // YIQ ëŒ€ë¹„
  const yiq = (r*299 + g*587 + b*114)/1000;
  return yiq >= 128 ? "#000000" : "#ffffff";
}

// âœ… ìˆ˜ë™ ë°°ì • ì‹œì‘ (íŒ€ì¥ ì„ ì • ë¶ˆí•„ìš”)
function startManualTeamAssign() {
  // ì°¸ì„ì ì„ íƒì´ ìˆìœ¼ë©´ ê·¸ ì§‘í•©ìœ¼ë¡œ, ì—†ìœ¼ë©´ ì „ì²´ ì¸ì›ìœ¼ë¡œ
  manualPool = selected.length ? [...selected] : allPlayers.map((_, i) => i);

  if (manualPool.length < 2) {
    alert("ì„ ìˆ˜ê°€ 2ëª… ì´ìƒ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. (ì°¸ì„ì ì„ íƒì´ ì—†ìœ¼ë©´ ì „ì²´ ëª…ë‹¨ì„ ì‚¬ìš©í•©ë‹ˆë‹¤)");
    return;
  }

  const count = parseInt(prompt("ëª‡ íŒ€ìœ¼ë¡œ êµ¬ì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì˜ˆ: 4)"));
  if (isNaN(count) || count < 2 || count > 8) {
    alert("2~8 ì‚¬ì´ì˜ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  // íŒ€ëª… AíŒ€, BíŒ€...
  const names = [];
  const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  for (let i = 0; i < count; i++) names.push(`${alphabet[i]}íŒ€`);

  // ìƒíƒœ ì´ˆê¸°í™”
  manualTeams = names.map((n, i) => ({
    name: n,
    members: [],
    sum: 0,
    color: TEAM_COLORS[i % TEAM_COLORS.length]
  }));
  manualAssigned.clear();
  swapBuffer = null;

  enterManualAssignMode();
  renderManualTeamUI(); // â† manualPoolì„ ë‚´ë¶€ì—ì„œ ì°¸ì¡°
}



function resetAll() {
  exitManualAssignMode(); // â¬…ï¸ ì¶”ê°€

  selected = [];
  document.getElementById("teams").innerHTML = "";
  document.getElementById("matchSchedule").innerHTML = "";
  renderPlayers();
}

// âœ… ìˆ˜ë™ ë°°ì • UI ë Œë”ë§
function renderManualTeamUI() {
  const teamBox = document.getElementById("teams");
  teamBox.innerHTML = "";

  // íŒ€ ì¹´ë“œ
  manualTeams.forEach((team, teamIdx) => {
    const div = document.createElement("div");
    div.className = "team-card";
    div.id = `team-${teamIdx}`;
    div.style.borderTop = `4px solid ${team.color || '#1976d2'}`;
    const fg = contrastText(team.color || '#1976d2');
    div.innerHTML = `
      <h3 style="display:flex;align-items:center;gap:8px;justify-content:space-between;">
        <span style="display:flex;align-items:center;gap:8px;">
          <span style="display:inline-block;width:12px;height:12px;border-radius:3px;background:${team.color || '#1976d2'}"></span>
          ${team.name}
        </span>
        <button onclick="promptAddPlayerToTeam(${teamIdx})"
                style="font-size:12px;padding:6px 10px;background:${team.color || '#1976d2'};color:${fg};border:1px solid rgba(0,0,0,.15);border-radius:6px;cursor:pointer">
          + íŒ€ì— ì„ ìˆ˜ ì¶”ê°€
        </button>
      </h3>
      <ul id="team-list-${teamIdx}"></ul>
      <p><small>ë¶€ìˆ˜í•©: <span id="team-sum-${teamIdx}">0</span></small></p>
    `;
    teamBox.appendChild(div);

    // íŒ€ì› ëª©ë¡ ì´ˆê¸° ë Œë”
    renderTeamMembers(teamIdx);
  });

  // ì°¸ê°€ì ëª©ë¡ ì˜ì—­ì„ "ìˆ˜ë™ë°°ì • ëª¨ë“œ"ë¡œ ì „í™˜
  const list = document.getElementById("playerList");
  list.innerHTML = "";

  manualPool.forEach((idx) => {
    const p = allPlayers[idx];
    if (manualAssigned.has(idx)) return; // ì´ë¯¸ ë°°ì •ëœ ì‚¬ëŒì€ ìˆ¨ê¹€

    const wrapper = document.createElement("div");
    wrapper.style.display = "flex";
    wrapper.style.alignItems = "center";
    wrapper.style.gap = "8px";
    wrapper.style.margin = "4px 6px";

    const tag = document.createElement("div");
    tag.className = "player";
    tag.textContent = `${p.name}(${p.level}ë¶€)`;

    const btns = document.createElement("div");
    manualTeams.forEach((team, i) => {
      const btn = document.createElement("button");
      const bg = team.color || TEAM_COLORS[i % TEAM_COLORS.length];
      btn.textContent = `â†’ ${team.name}`;
      btn.style.fontSize = "12px";
      btn.style.backgroundColor = bg;
      btn.style.color = contrastText(bg);
      btn.style.border = "1px solid rgba(0,0,0,0.15)";
      btn.style.padding = "6px 10px";
      btn.style.borderRadius = "6px";
      btn.style.cursor = "pointer";
      btn.onclick = () => {
        if (manualAssigned.has(idx)) return;
        manualTeams[i].members.push({ name: p.name, level: p.level, _srcIdx: idx });
        manualTeams[i].sum += p.level;
        manualAssigned.add(idx);
        renderTeamMembers(i);
        wrapper.style.opacity = "0.4";
        wrapper.style.pointerEvents = "none";
      };
      btns.appendChild(btn);
    });

    wrapper.appendChild(tag);
    wrapper.appendChild(btns);
    list.appendChild(wrapper);
  });

  // ì €ì¥/ì—…ë¡œë“œ ë²„íŠ¼
  const controls = document.createElement("div");
  controls.style.display = "flex";
  controls.style.gap = "10px";
  controls.style.justifyContent = "center";
  controls.style.marginTop = "10px";

  const saveBtn = document.createElement("button");
  saveBtn.textContent = "âœ… ìˆ˜ë™ íŒ€ ì €ì¥";
  saveBtn.onclick = () => {
    latestTeams = manualTeams.map(t => ({
      teamName: t.name,
      members: t.members.map(m => ({ name: m.name, level: m.level })),
      sum: t.sum,
      color: t.color
    }));
    alert("ì €ì¥ ì™„ë£Œ! ì´ì œ 'ê²½ê¸° ì‹œì‘'ì„ ëˆ„ë¥´ë©´ ì €ì¥ëœ íŒ€ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.");
  };

  const uploadBtn = document.createElement("button");
  uploadBtn.textContent = "âš¡ ì €ì¥ í›„ ì¦‰ì‹œ ê²½ê¸° ì‹œì‘";
  uploadBtn.onclick = () => {
    latestTeams = manualTeams.map(t => ({
      teamName: t.name,
      members: t.members.map(m => ({ name: m.name, level: m.level })),
      sum: t.sum,
      color: t.color
    }));
    uploadTeamsToFirebase();
  };

  const addAnyBtn = document.createElement("button");
  addAnyBtn.textContent = "â• (ì‹ ê·œ) ì„ ìˆ˜ ì§ì ‘ ì¶”ê°€";
  addAnyBtn.onclick = () => promptAddPlayer();

  controls.appendChild(saveBtn);
  controls.appendChild(uploadBtn);
  controls.appendChild(addAnyBtn);
  teamBox.appendChild(controls);
}


// âœ… íŒ€ ì¹´ë“œ ë‚´ìš© ê°±ì‹ 
function renderTeamMembers(teamIdx) {
  const ul = document.getElementById(`team-list-${teamIdx}`);
  ul.innerHTML = manualTeams[teamIdx].members
    .map((p, idx) => {
      return `
        <li id="t${teamIdx}-p${idx}" style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <span>${p.name}(${p.level}ë¶€)</span>
          <span style="display:flex;gap:6px;">
            <button onclick="beginSwap(${teamIdx}, ${idx})" style="font-size:12px;padding:4px 8px;">â†” êµì²´</button>
            <button onclick="movePlayer(${teamIdx}, ${idx})" style="font-size:12px;padding:4px 8px;">â†’ ì´ë™</button>
            <button onclick="removePlayerFromTeam(${teamIdx}, ${idx})" style="font-size:12px;padding:4px 8px;">âœ– í•´ì œ</button>
          </span>
        </li>
      `;
    }).join('');
  document.getElementById(`team-sum-${teamIdx}`).textContent = manualTeams[teamIdx].sum;
}


function enterManualAssignMode() {
  const inputWrap = document.querySelector('.input-wrap');
  if (inputWrap) inputWrap.classList.add('hidden');
}

function exitManualAssignMode() {
  const inputWrap = document.querySelector('.input-wrap');
  if (inputWrap) inputWrap.classList.remove('hidden');
}


// (A) êµì²´: ì²« ì„ ìˆ˜ ì„ íƒ â†’ ë‘ ë²ˆì§¸ ì„ ìˆ˜ ì„ íƒ ì‹œ ì„œë¡œ ìŠ¤ì™‘
function beginSwap(teamIdx, playerIdx) {
  // ê°™ì€ li DOM ì–»ê¸°
  const liId = `t${teamIdx}-p${playerIdx}`;
  const li = document.getElementById(liId);

  if (!swapBuffer) {
    swapBuffer = { teamIdx, playerIdx, liId };
    if (li) li.classList.add('swap-pending');
    return;
  }

  // ë™ì¼ í•­ëª©ì´ë©´ ì·¨ì†Œ
  if (swapBuffer.teamIdx === teamIdx && swapBuffer.playerIdx === playerIdx) {
    const prevLi = document.getElementById(swapBuffer.liId);
    if (prevLi) prevLi.classList.remove('swap-pending');
    swapBuffer = null;
    return;
  }

  // ë‘ ë²ˆì§¸ ì„ íƒ â†’ ìŠ¤ì™‘
  const aTeam = manualTeams[swapBuffer.teamIdx];
  const bTeam = manualTeams[teamIdx];
  const a = aTeam.members[swapBuffer.playerIdx];
  const b = bTeam.members[playerIdx];

  // í•©ê³„ ìˆ˜ì •
  aTeam.sum = aTeam.sum - a.level + b.level;
  bTeam.sum = bTeam.sum - b.level + a.level;

  // ì‹¤ì œ ìŠ¤ì™‘
  aTeam.members[swapBuffer.playerIdx] = b;
  bTeam.members[playerIdx] = a;

  // UI ê°±ì‹ 
  renderTeamMembers(swapBuffer.teamIdx);
  renderTeamMembers(teamIdx);

  // ì„ íƒ ì´ˆê¸°í™”
  const prevLi = document.getElementById(swapBuffer.liId);
  if (prevLi) prevLi.classList.remove('swap-pending');
  swapBuffer = null;
}

// (B) ì´ë™: í•œ ì„ ìˆ˜ë¥¼ ë‹¤ë¥¸ íŒ€ìœ¼ë¡œ ì´ë™
function movePlayer(fromTeamIdx, playerIdx, toTeamIdx = null) {
  const player = manualTeams[fromTeamIdx].members[playerIdx];

  if (toTeamIdx === null) {
    const teamNames = manualTeams.map((t, i) => `${i}: ${t.name}`).join("\n");
    const input = prompt(`'${player.name}' ì´ë™í•  íŒ€ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:\n${teamNames}`);
    if (input === null) return;
    toTeamIdx = parseInt(input, 10);
  }

  if (isNaN(toTeamIdx) || toTeamIdx < 0 || toTeamIdx >= manualTeams.length) {
    alert("ì˜ëª»ëœ íŒ€ ë²ˆí˜¸ì…ë‹ˆë‹¤.");
    return;
  }
  if (toTeamIdx === fromTeamIdx) {
    alert("ê°™ì€ íŒ€ìœ¼ë¡œëŠ” ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // í•©ê³„/ë°°ì—´ ê°±ì‹ 
  manualTeams[fromTeamIdx].members.splice(playerIdx, 1);
  manualTeams[fromTeamIdx].sum -= player.level;

  manualTeams[toTeamIdx].members.push(player);
  manualTeams[toTeamIdx].sum += player.level;

  renderTeamMembers(fromTeamIdx);
  renderTeamMembers(toTeamIdx);

  // ìŠ¤ì™‘ì¤‘ í‘œì‹œ ì´ˆê¸°í™”
  if (swapBuffer) {
    const prevLi = document.getElementById(swapBuffer.liId);
    if (prevLi) prevLi.classList.remove('swap-pending');
    swapBuffer = null;
  }
}

// (C) í•´ì œ: íŒ€ì—ì„œ ë¹¼ì„œ â€˜ë¯¸ë°°ì •â€™ ìƒíƒœë¡œ ë³µê·€
function removePlayerFromTeam(teamIdx, playerIdx) {
  const player = manualTeams[teamIdx].members[playerIdx];

  // í•©ê³„/ë°°ì—´ ê°±ì‹ 
  manualTeams[teamIdx].members.splice(playerIdx, 1);
  manualTeams[teamIdx].sum -= player.level;
  renderTeamMembers(teamIdx);

  // ì°¸ê°€ì í’€ì—ì„œì˜ ì¸ë±ìŠ¤ ì¶”ì •: ìµœì´ˆ ë°°ì • ë•Œ ì €ì¥í•œ _srcIdxê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ë³µê·€
  // (ì‹ ê·œ ì¶”ê°€í•œ ì„ ìˆ˜ë¼ë©´ _srcIdxê°€ ì—†ìœ¼ë¯€ë¡œ í’€ì—ëŠ” ì•ˆ ëŒì•„ê°€ê³ , í™”ë©´ ìœ ì§€)
  if (typeof player._srcIdx === 'number') {
    manualAssigned.delete(player._srcIdx);
  }

  // ì°¸ê°€ì ëª©ë¡ ì¬ë Œë”
  renderManualTeamUI();
}

// (D) íŒ€ì— ì‹ ê·œ ì„ ìˆ˜ ì¶”ê°€ (ì¦‰ì„ ì…ë ¥)
function promptAddPlayerToTeam(teamIdx) {
  const name = prompt("ìƒˆ ì„ ìˆ˜ ì´ë¦„:");
  if (!name) return;

  const level = parseInt(prompt("ìƒˆ ì„ ìˆ˜ ë¶€ìˆ˜ (1~20):"), 10);
  if (isNaN(level) || level < 1 || level > 20) {
    alert("ë¶€ìˆ˜ëŠ” 1~20 ì‚¬ì´ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  addPlayerToTeam(teamIdx, name.trim(), level);
}

// (E) ì „ì—­ â€˜ì‹ ê·œ ì„ ìˆ˜ ì¶”ê°€â€™ ë²„íŠ¼ (íŒ€ ë¨¼ì € ê³ ë¥´ê³  ì…ë ¥)
function promptAddPlayer() {
  const teamNames = manualTeams.map((t, i) => `${i}: ${t.name}`).join("\n");
  const input = prompt(`ì„ ìˆ˜ë¥¼ ì¶”ê°€í•  íŒ€ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”:\n${teamNames}`);
  if (input === null) return;
  const teamIdx = parseInt(input, 10);
  if (isNaN(teamIdx) || teamIdx < 0 || teamIdx >= manualTeams.length) {
    alert("ì˜ëª»ëœ íŒ€ ë²ˆí˜¸ì…ë‹ˆë‹¤.");
    return;
  }
  promptAddPlayerToTeam(teamIdx);
}

// (F) ì‹¤ì œ ì¶”ê°€ ë¡œì§
function addPlayerToTeam(teamIdx, name, level) {
  manualTeams[teamIdx].members.push({ name, level });
  manualTeams[teamIdx].sum += level;
  renderTeamMembers(teamIdx);
}

  // ëª¨ë‹¬ ì—´ê¸°
    function openModal() {
      document.getElementById('helpModal').style.display = 'flex';
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal() {
      document.getElementById('helpModal').style.display = 'none';
    }

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') closeModal();
    });

    // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('helpModal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });



function balanceFinalMixedTeams(exchangeTeams) {
  if (!exchangeTeams.mixedTeams || exchangeTeams.mixedTeams.length === 0) {
    console.log("âš  í˜¼í•©íŒ€ì´ ì—†ìœ¼ë¯€ë¡œ í‰ê·  ì¡°ì • ìƒëµ");
    return;
  }
  const totalMixedMembers = exchangeTeams.mixedTeams.reduce((cnt, t) => cnt + t.members.length, 0);
  if (totalMixedMembers === 0) {
    console.log("âš  í˜¼í•©íŒ€ ë©¤ë²„ ì—†ìŒ â†’ í‰ê·  ì¡°ì • ìƒëµ");
    return;
  }

  const calcSum = (teams) => teams.reduce((sum, t) => sum + t.sum, 0);
  const calcCount = (teams) => teams.reduce((cnt, t) => cnt + t.members.length, 0);
  const calcAvg = (teams) => (calcCount(teams) > 0 ? calcSum(teams) / calcCount(teams) : 0);

  const avgOur = calcAvg(exchangeTeams.ourTeams);
  const avgOpponent = calcAvg(exchangeTeams.opponentTeams);
  let avgMixed = calcAvg(exchangeTeams.mixedTeams);

  console.log("ì´ˆê¸° í‰ê·  ë¶€ìˆ˜", { avgOur, avgOpponent, avgMixed });

  const TOLERANCE = 1.5;
  let attempts = 0;

  while ((Math.abs(avgMixed - avgOur) > TOLERANCE || Math.abs(avgMixed - avgOpponent) > TOLERANCE) && attempts < 15) {
    attempts++;

    const mixedTeam = exchangeTeams.mixedTeams.flatMap(t => t.members);
    const ourTeam = exchangeTeams.ourTeams.flatMap(t => t.members);
    const opponentTeam = exchangeTeams.opponentTeams.flatMap(t => t.members);

    if (!mixedTeam.length || (!ourTeam.length && !opponentTeam.length)) break;

    const highestMixed = mixedTeam.reduce((max, p) => (p.level > max.level ? p : max), mixedTeam[0]);
    const lowestOur = ourTeam.reduce((min, p) => (p.level < min.level ? p : min), ourTeam[0]);
    const lowestOpponent = opponentTeam.reduce((min, p) => (p.level < min.level ? p : min), opponentTeam[0]);

    if (avgMixed > Math.max(avgOur, avgOpponent) + TOLERANCE) {
      if (lowestOur && lowestOur.level < highestMixed.level)
        swapPlayers(highestMixed, lowestOur, exchangeTeams);
      else if (lowestOpponent && lowestOpponent.level < highestMixed.level)
        swapPlayers(highestMixed, lowestOpponent, exchangeTeams);
    } else if (avgMixed < Math.min(avgOur, avgOpponent) - TOLERANCE) {
      const weakestMixed = mixedTeam.reduce((min, p) => (p.level < min.level ? p : min), mixedTeam[0]);
      const highestOur = ourTeam.reduce((max, p) => (p.level > max.level ? p : max), ourTeam[0]);
      const highestOpponent = opponentTeam.reduce((max, p) => (p.level > max.level ? p : max), opponentTeam[0]);

      if (highestOur && highestOur.level > weakestMixed.level)
        swapPlayers(weakestMixed, highestOur, exchangeTeams);
      else if (highestOpponent && highestOpponent.level > weakestMixed.level)
        swapPlayers(weakestMixed, highestOpponent, exchangeTeams);
    }

    avgMixed = calcAvg(exchangeTeams.mixedTeams);
  }

  console.log("ì¡°ì • í›„ í‰ê·  ë¶€ìˆ˜", {
    avgOur: calcAvg(exchangeTeams.ourTeams),
    avgOpponent: calcAvg(exchangeTeams.opponentTeams),
    avgMixed: calcAvg(exchangeTeams.mixedTeams)
  });
}

function balanceAllTeams(exchangeTeams) {
  const allTeams = [
    ...exchangeTeams.ourTeams,
    ...exchangeTeams.opponentTeams,
    ...exchangeTeams.mixedTeams
  ];

  if (allTeams.length === 0) return;

  const calcAvg = (team) => team.members.length ? team.sum / team.members.length : 0;

  let attempts = 0;
  let improved = true;

  while (improved && attempts < 30) {
    improved = false;
    attempts++;

    const avgs = allTeams.map(calcAvg);
    const globalAvg = avgs.reduce((a,b)=>a+b,0)/avgs.length;

    // í‰ê· ê³¼ì˜ ì°¨ì´ ê³„ì‚°
    const maxIdx = avgs.indexOf(Math.max(...avgs)); // í‰ê·  ë†’ì€ íŒ€ (ì•½íŒ€)
    const minIdx = avgs.indexOf(Math.min(...avgs)); // í‰ê·  ë‚®ì€ íŒ€ (ê°•íŒ€)
    const high = allTeams[maxIdx];
    const low = allTeams[minIdx];

    const diff = Math.abs(avgs[maxIdx] - avgs[minIdx]);
    if (diff < 1.2) break; // ì¶©ë¶„íˆ ê· í˜• ë§ìœ¼ë©´ ì¢…ë£Œ

    // êµí™˜ ëŒ€ìƒ ì°¾ê¸°
    const bestHigh = high.members.reduce((a,b)=>a.level>b.level?a:b); // í•˜ìˆ˜
    const bestLow = low.members.reduce((a,b)=>a.level<b.level?a:b);   // ê³ ìˆ˜

    // êµí™˜
    const hiIdx = high.members.indexOf(bestHigh);
    const loIdx = low.members.indexOf(bestLow);
    if (hiIdx === -1 || loIdx === -1) break;

    high.members[hiIdx] = bestLow;
    low.members[loIdx] = bestHigh;

    high.sum = high.members.reduce((s,p)=>s+p.level,0);
    low.sum = low.members.reduce((s,p)=>s+p.level,0);

    improved = true;
  }

  console.log("âœ… ì „ì²´ íŒ€ ë¶€ìˆ˜ ê· í˜• ì¡°ì • ì™„ë£Œ");
  allTeams.forEach(t=>{
    const avg = calcAvg(t).toFixed(2);
    console.log(`${t.name} í‰ê·  ë¶€ìˆ˜: ${avg}`);
  });
}

function balanceInternalTeamLevels(exchangeTeams) {
  const groups = [
    { name: "ìš°ë¦¬íŒ€", teams: exchangeTeams.ourTeams },
    { name: "ìƒëŒ€íŒ€", teams: exchangeTeams.opponentTeams },
  ];

  groups.forEach(group => {
    const { name, teams } = group;
    if (!teams || teams.length < 2) return;

    const calcAvg = (t) => (t.members.length > 0 ? t.sum / t.members.length : 0);

    let improved = true;
    let attempts = 0;

    while (improved && attempts < 10) {
      improved = false;
      attempts++;

      const avgs = teams.map(t => calcAvg(t));
      const maxIdx = avgs.indexOf(Math.max(...avgs));
      const minIdx = avgs.indexOf(Math.min(...avgs));

      const highTeam = teams[maxIdx];
      const lowTeam = teams[minIdx];

      if (!highTeam.members.length || !lowTeam.members.length) break;

      const highPlayer = highTeam.members.reduce((max, p) => (p.level > max.level ? p : max), highTeam.members[0]);
      const lowPlayer = lowTeam.members.reduce((min, p) => (p.level < min.level ? p : min), lowTeam.members[0]);

      const diffBefore = Math.abs(calcAvg(highTeam) - calcAvg(lowTeam));

      // êµí™˜
      const hiIdx = highTeam.members.indexOf(highPlayer);
      const loIdx = lowTeam.members.indexOf(lowPlayer);
      highTeam.members[hiIdx] = lowPlayer;
      lowTeam.members[loIdx] = highPlayer;

      highTeam.sum = highTeam.members.reduce((s, p) => s + p.level, 0);
      lowTeam.sum = lowTeam.members.reduce((s, p) => s + p.level, 0);

      const diffAfter = Math.abs(calcAvg(highTeam) - calcAvg(lowTeam));

      if (diffAfter < diffBefore) {
        improved = true;
        console.log(`âš–ï¸ ${name}: ${highTeam.name} â†” ${lowTeam.name} (${highPlayer.name} â†” ${lowPlayer.name})`);
      } else {
        // íš¨ê³¼ ì—†ìœ¼ë©´ ë˜ëŒë¦¬ê¸°
        highTeam.members[hiIdx] = highPlayer;
        lowTeam.members[loIdx] = lowPlayer;
        highTeam.sum = highTeam.members.reduce((s, p) => s + p.level, 0);
        lowTeam.sum = lowTeam.members.reduce((s, p) => s + p.level, 0);
      }
    }

    const finalAvgs = teams.map(t => calcAvg(t).toFixed(2));
    console.log(`âœ… ${name} ë‚´ë¶€ ë¶€ìˆ˜ ì¡°ì • ì™„ë£Œ: í‰ê·  = [${finalAvgs.join(", ")}]`);
  });
}


function swapPlayers(mixedPlayer, otherPlayer, exchangeTeams) {
  // ì–´ë–¤ íŒ€ì— ì†í•´ìˆëŠ”ì§€ ì°¾ê¸°
  function findPlayerTeam(player) {
    for (const groupName of ['ourTeams', 'opponentTeams', 'mixedTeams']) {
      for (const team of exchangeTeams[groupName]) {
        const idx = team.members.indexOf(player);
        if (idx !== -1) return { groupName, team, idx };
      }
    }
    return null;
  }

  const mixedInfo = findPlayerTeam(mixedPlayer);
  const otherInfo = findPlayerTeam(otherPlayer);

  if (!mixedInfo || !otherInfo) return;

  // êµí™˜
  mixedInfo.team.members[mixedInfo.idx] = otherPlayer;
  otherInfo.team.members[otherInfo.idx] = mixedPlayer;

  // ë¶€ìˆ˜í•© ê°±ì‹ 
  mixedInfo.team.sum = mixedInfo.team.members.reduce((sum, p) => sum + p.level, 0);
  otherInfo.team.sum = otherInfo.team.members.reduce((sum, p) => sum + p.level, 0);

  console.log(`êµí™˜ë¨: ${mixedPlayer.name} â†” ${otherPlayer.name}`);
}

let autoSwapBuffer = null;

function beginAutoSwap(teamIdx, playerIdx) {
  const liId = `auto-${teamIdx}-p${playerIdx}`;
  const li = document.getElementById(liId);

  // ì²« ë²ˆì§¸ ì„ ìˆ˜ ì„ íƒ
  if (!autoSwapBuffer) {
    autoSwapBuffer = { teamIdx, playerIdx, liId };
    if (li) li.classList.add('swap-pending');
    return;
  }

  // ê°™ì€ ì„ ìˆ˜ ë‹¤ì‹œ í´ë¦­ â†’ ì·¨ì†Œ
  if (autoSwapBuffer.teamIdx === teamIdx && autoSwapBuffer.playerIdx === playerIdx) {
    const prevLi = document.getElementById(autoSwapBuffer.liId);
    if (prevLi) prevLi.classList.remove('swap-pending');
    autoSwapBuffer = null;
    return;
  }

  // ë‘ ë²ˆì§¸ ì„ ìˆ˜ â†’ ìŠ¤ì™‘ ì‹¤í–‰
  const teamA = latestTeams[autoSwapBuffer.teamIdx];
  const teamB = latestTeams[teamIdx];
  const a = teamA.members[autoSwapBuffer.playerIdx];
  const b = teamB.members[playerIdx];

  teamA.members[autoSwapBuffer.playerIdx] = b;
  teamB.members[playerIdx] = a;

  // í•©ê³„ ê°±ì‹ 
  teamA.sum = teamA.members.reduce((sum, p) => sum + p.level, 0);
  teamB.sum = teamB.members.reduce((sum, p) => sum + p.level, 0);

  // UI ìƒˆë¡œ ë Œë”ë§
  assignTeamsRender(latestTeams);

  autoSwapBuffer = null;
}

function moveAutoPlayer(fromTeamIdx, playerIdx) {
  const player = latestTeams[fromTeamIdx].members[playerIdx];

  const teamNames = latestTeams.map((t, i) => `${i}: ${t.name}`).join("\n");
  const choice = prompt(`'${player.name}' ì´ë™í•  íŒ€ ë²ˆí˜¸ ì…ë ¥:\n${teamNames}`);
  if (choice === null) return;

  const toTeamIdx = parseInt(choice, 10);
  if (isNaN(toTeamIdx) || toTeamIdx < 0 || toTeamIdx >= latestTeams.length) {
    alert("ì˜ëª»ëœ íŒ€ ë²ˆí˜¸ì…ë‹ˆë‹¤.");
    return;
  }
  if (toTeamIdx === fromTeamIdx) {
    alert("ê°™ì€ íŒ€ìœ¼ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // ì´ë™ ì²˜ë¦¬
  latestTeams[fromTeamIdx].members.splice(playerIdx, 1);
  latestTeams[fromTeamIdx].sum = latestTeams[fromTeamIdx].members.reduce((sum, p) => sum + p.level, 0);

  latestTeams[toTeamIdx].members.push(player);
  latestTeams[toTeamIdx].sum = latestTeams[toTeamIdx].members.reduce((sum, p) => sum + p.level, 0);

  assignTeamsRender(latestTeams);
}

function removeAutoPlayer(teamIdx, playerIdx) {
  if (!confirm("ì´ ì„ ìˆ˜ë¥¼ íŒ€ì—ì„œ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  latestTeams[teamIdx].members.splice(playerIdx, 1);
  latestTeams[teamIdx].sum = latestTeams[teamIdx].members.reduce((sum, p) => sum + p.level, 0);

  assignTeamsRender(latestTeams);
}

function assignTeamsRender(teams) {
  const teamBox = document.getElementById("teams");
  teamBox.innerHTML = "";

  teams.forEach((team, teamIdx) => {
    const div = document.createElement("div");
    div.className = "team-card";
    div.id = `auto-team-${teamIdx}`;

    // í‰ê·  ë¶€ìˆ˜ í‘œì‹œ ì¶”ê°€ (ì„ íƒ ì‚¬í•­)
    const avg = team.members.length ? (team.sum / team.members.length).toFixed(2) : "-";

    // ğŸ”¹ ì›ë³¸ ì¸ë±ìŠ¤ ë§¤ì¹­ ë³´ì¥
    const sortedMembers = [...team.members].sort((a, b) => a.level - b.level);

    div.innerHTML = `
      <h3>${team.name}</h3>
      <ul>
        ${sortedMembers.map(m => {
          const origIdx = team.members.indexOf(m); // ì›ë³¸ ë°°ì—´ ì¸ë±ìŠ¤ ì°¾ê¸°
          return `
            <li id="auto-${teamIdx}-p${origIdx}" 
                style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
              <span>${m.name}(${m.level}ë¶€)</span>
              <span style="display:flex;gap:6px;">
                <button onclick="beginAutoSwap(${teamIdx}, ${origIdx})" style="font-size:12px;padding:4px 8px;">â†” êµì²´</button>
                <button onclick="moveAutoPlayer(${teamIdx}, ${origIdx})" style="font-size:12px;padding:4px 8px;">â†’ ì´ë™</button>
                <button onclick="removeAutoPlayer(${teamIdx}, ${origIdx})" style="font-size:12px;padding:4px 8px;">âœ– í•´ì œ</button>
              </span>
            </li>
          `;
        }).join('')}
      </ul>
      <p><small>ë¶€ìˆ˜í•©: ${team.sum} / í‰ê· : ${avg}</small></p>
    `;

    teamBox.appendChild(div);
  });
}

  </script>
<!-- êµë¥˜ì „ ì„¤ì • ëª¨ë‹¬ -->
<div class="modal-overlay" id="exchangeModal">
  <div class="modal">
    <button class="close-btn" onclick="closeExchangeModal()">âœ–</button>
    <h2>âš”ï¸ êµë¥˜ì „ ì„¤ì •</h2>

    <div class="modal-section">
      <h3>1ï¸âƒ£ ìš°ë¦¬íŒ€ ì„ íƒ</h3>
      <input type="text" id="ourTeamInput" placeholder="ìš°ë¦¬íŒ€ ì´ë¦„ì„ ì…ë ¥ (ì˜ˆ: ë‚¨ë™ë°œì „)" style="width:100%;padding:6px;font-size:14px;">
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
        <button onclick="document.getElementById('ourTeamInput').value='ë‚¨ë™ë°œì „'">ë‚¨ë™ë°œì „</button>
      </div>
    </div>

    <div class="modal-section">
      <h3>2ï¸âƒ£ ìƒëŒ€íŒ€ ì„ íƒ</h3>
      <input type="text" id="opponentTeamInput" placeholder="ìƒëŒ€íŒ€ ì´ë¦„ì„ ì…ë ¥" style="width:100%;padding:6px;font-size:14px;">
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
        <button onclick="document.getElementById('opponentTeamInput').value='í•œêµ­í† ì§€ì£¼íƒê³µì‚¬'">í•œêµ­í† ì§€ì£¼íƒê³µì‚¬</button>
        <button onclick="document.getElementById('opponentTeamInput').value='ì €ì‘ê¶Œìœ„ì›íšŒ'">ì €ì‘ê¶Œìœ„ì›íšŒ</button>
      </div>
    </div>

    <div class="modal-section">
      <h3>3ï¸âƒ£ íŒ€ ìˆ˜ ì„¤ì •</h3>
      <p style="margin:4px 0;">ê° í•­ëª©ì€ í´ë¦­ ë˜ëŠ” ì§ì ‘ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
      <div>
        <label>ìš°ë¦¬íŒ€: <input type="number" id="ourCountInput" value="2" min="0" max="8" style="width:60px;"> íŒ€</label>
        <div style="margin-top:6px;">
          <button onclick="document.getElementById('ourCountInput').value=0">0</button>
          <button onclick="document.getElementById('ourCountInput').value=1">1</button>
          <button onclick="document.getElementById('ourCountInput').value=2">2</button>
          <button onclick="document.getElementById('ourCountInput').value=3">3</button>
          <button onclick="document.getElementById('ourCountInput').value=4">4</button>
          <button onclick="document.getElementById('ourCountInput').value=5">5</button>

        </div>
      </div>
      <div style="margin-top:10px;">
        <label>ìƒëŒ€íŒ€: <input type="number" id="opponentCountInput" value="2" min="0" max="8" style="width:60px;"> íŒ€</label>
        <div style="margin-top:6px;">
          <button onclick="document.getElementById('opponentCountInput').value=0">0</button>
          <button onclick="document.getElementById('opponentCountInput').value=1">1</button>
          <button onclick="document.getElementById('opponentCountInput').value=2">2</button>
          <button onclick="document.getElementById('opponentCountInput').value=3">3</button>
          <button onclick="document.getElementById('opponentCountInput').value=4">4</button>
          <button onclick="document.getElementById('opponentCountInput').value=5">5</button>
        
        
        </div>
      </div>
      <div style="margin-top:10px;">
        <label>í˜¼í•©íŒ€: <input type="number" id="mixedCountInput" value="1" min="0" max="8" style="width:60px;"> íŒ€</label>
        <div style="margin-top:6px;">
          <button onclick="document.getElementById('mixedCountInput').value=0">0</button>
          <button onclick="document.getElementById('mixedCountInput').value=1">1</button>
          <button onclick="document.getElementById('mixedCountInput').value=2">2</button>
          <button onclick="document.getElementById('mixedCountInput').value=3">3</button>
          <button onclick="document.getElementById('mixedCountInput').value=4">4</button>
          <button onclick="document.getElementById('mixedCountInput').value=5">5</button>
        </div>
      </div>
    </div>

    <div style="text-align:center;margin-top:20px;">
      <button style="padding:10px 18px;background:#1976d2;color:white;border:none;border-radius:6px;"
        onclick="confirmExchangeMatch()">âœ… êµë¥˜ì „ ìƒì„±</button>
    </div>
  </div>
</div>


</body>
</html>
