<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KOEN ë‹¨ì‹ ë¦¬ê·¸ì „(ì‹¤ì‹œê°„)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    .lv4to6 { background-color: #e8f5e9; }
    .lv7to9 { background-color: #e3f2fd; }
    .lv10to12 { background-color: #fff3e0; }
    .lv13to14 { background-color: #ffebee; }

    .new-player {
      background-color:#fff176!important;
      border:3px solid #f57f17;
      font-weight:bold;
      box-shadow:0 0 10px #f9a825;
      animation:highlightFlash 1.5s ease-in-out infinite alternate;
    }

    body { font-family:'Segoe UI',sans-serif; padding:20px; margin:0; }
    h1,#controlPanel { text-align:center; }

    .player {
      margin:4px; padding:6px 10px;
      border:1px solid #2196f3;
      border-radius:6px;
      display:inline-block;
      cursor:pointer;
      font-size:14px;
    }

    .player.selected { background:#1976d2; color:#fff; }
    .player.new-player.selected {
      background:#1976d2!important;
      color:#fff!important;
      box-shadow:none;
      animation:none;
    }

    table { border-collapse:collapse; width:100%; margin-top:20px; background:#fff; font-size:14px; }
    td,th { border:1px solid #888; padding:6px 10px; text-align:center; }
    tr:nth-child(odd){ background:#e3f2fd; }
    tr:nth-child(even){ background:#fff; }
    table tr:first-child th, table td:first-child { background:#ffe0b2!important; }

    .button-group{ display:flex; justify-content:center; flex-wrap:wrap; gap:12px; margin:20px 0; }
    .button-group button{
      padding:10px 20px; font-size:16px;
      background:#1976d2; color:#fff;
      border:none; border-radius:6px;
      cursor:pointer;
    }

    #controlPanel input[type="text"]{
      padding:10px; font-size:16px;
      margin:5px; width:200px; max-width:90%;
    }

    .scroll-table{ overflow:auto; max-height:80vh; max-width:100%; border:1px solid #aaa; }

    #popup{ display:none; position:fixed; top:30%; left:50%; transform:translate(-50%,-50%); background:#fff; border:2px solid #333; padding:20px; z-index:1000; width:90%; max-width:400px; }
    #popup button{ margin:5px; padding:8px 12px; background:#1976d2; color:#fff; border:none; border-radius:4px; cursor:pointer; width:100%; }

    .modal{ display:block; position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,.4); z-index:2000; }
    .modal-content{ background:#fff; margin:10% auto; padding:20px; border-radius:10px; width:90%; max-width:480px; }

  </style>
</head>


<body>

  <h1>ì‹¤ì‹œê°„ íƒêµ¬ ë‹¨ì‹ ë¦¬ê·¸ì „</h1>

  <div id="controlPanel">
    <input type="text" id="playerName" placeholder="ì„ ìˆ˜ ì´ë¦„" />
    <input type="text" id="playerLevel" placeholder="ë¶€ìˆ˜ (ì˜ˆ: 5)" />
    <button id="addPlayerBtn">ì„ ìˆ˜ ì¶”ê°€</button>
    <button id="toggleDefaultBtn">ê¸°ì¡´ ì„ ìˆ˜ ìˆ¨ê¹€</button>
  </div>

  <div id="playerList" class="player-list"></div>

  <div class="button-group">
    <button id="resetBtn">ì ìˆ˜ ì´ˆê¸°í™”</button>
    <button id="clearBtn">ì„ ìˆ˜ ëª©ë¡ ì‚­ì œ</button>
    <button id="saveImageBtn">ë¦¬ê·¸ì „ ì´ë¯¸ì§€ ì €ì¥</button>
  </div>

  <div id="schedule" class="scroll-table"></div>

  <div id="popup">
    <p id="popupText"></p>
    <div id="scoreButtons"></div>
    <button onclick="closePopup()">ë‹«ê¸°</button>
  </div>


  <!-- ====================================================== -->
  <!-- ================   SCRIPT ì˜ì—­ ì‹œì‘   ================= -->
  <!-- ====================================================== -->
  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // ğŸ”¥ 1) JSON ìœ„ì¹˜
    const MEMBERS_URL = "https://sensational-tulumba-65e97e.netlify.app/pingpong/club/data/members.json";


    // ğŸ”¥ 2) JSON ë¶ˆëŸ¬ì˜¤ê¸° â†’ "ì´ë¦„(ë¶€ìˆ˜)" ë°°ì—´ë¡œ ë°˜í™˜
    async function loadDefaultPlayersFromJSON() {
      const res = await fetch(MEMBERS_URL);
      const data = await res.json();

      return Object.values(data)
        .map(p => `${p.name}(${p.level})`)
        .sort((a, b) => {
          const lvA = Number(a.match(/\((\d+)\)/)[1]);
          const lvB = Number(b.match(/\((\d+)\)/)[1]);
          return lvA - lvB;
        });
    }


    // ============================
    //  Firebase ì„¤ì •
    // ============================
    const firebaseConfig = {
      apiKey: "AIzaSyC5iq3VY0QtBh8FVn70gi_Gsg7GXzkxdu8",
      authDomain: "koen-pingpong.firebaseapp.com",
      projectId: "koen-pingpong",
      storageBucket: "koen-pingpong.firebasestorage.app",
      messagingSenderId: "597358811982",
      appId: "1:597358811982:web:a221e312342c19fc321c1f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const playersRef = ref(db, "players/koen_takgu/list");
    const resultsRef = ref(db, "players/koen_takgu/results");
    const selectedRef = ref(db, "players/koen_takgu/selected");


    // ============================
    //   ìƒíƒœ ë³€ìˆ˜
    // ============================
    let defaultPlayers = [];   // JSONì—ì„œ ë¡œë“œë¨
    let currentPlayers = [];
    let selected = [];
    let results = {};
    let hideDefault = false;


    // ============================
    //   Firebase ìµëª… ë¡œê·¸ì¸
    // ============================
    async function ensureAuth() {
      if (auth.currentUser) return;
      return new Promise((resolve) => {
        const unsub = onAuthStateChanged(auth, (u) => {
          if (u) { unsub(); resolve(); }
        });
        signInAnonymously(auth);
      });
    }


    // =====================================================
    //   ì´ˆê¸° ë¶€íŠ¸
    // =====================================================
    (async function boot() {
      await ensureAuth();

      // JSONì—ì„œ ê¸°ë³¸ ì„ ìˆ˜ ë¡œë”©
      defaultPlayers = await loadDefaultPlayersFromJSON();

      // playersRefê°€ ë¹„ì–´ìˆìœ¼ë©´ JSON ë°ì´í„°ë¡œ ìë™ ì„¸íŒ…
      onValue(playersRef, (snap) => {
        if (!snap.exists()) {
          set(playersRef, defaultPlayers);
        }
      }, { onlyOnce: true });

      // ì‹¤ì‹œê°„ ì„ ìˆ˜
      onValue(playersRef, (snap) => {
        currentPlayers = snap.val() || [];
        renderPlayers();
        renderSchedule();
      });

      // ì‹¤ì‹œê°„ ê²°ê³¼
      onValue(resultsRef, (snap) => {
        results = snap.val() || {};
        renderSchedule();
      });

      // ì‹¤ì‹œê°„ ì„ íƒ
      onValue(selectedRef, (snap) => {
        selected = snap.val() || [];
        renderPlayers();
        renderSchedule();
      });


      // ë²„íŠ¼ ì•¡ì…˜ë“¤
      document.getElementById("resetBtn").onclick = () => {
        set(resultsRef, {});
      };

      document.getElementById("clearBtn").onclick = () => {
        remove(playersRef);
        remove(resultsRef);
        remove(selectedRef);
        location.reload();
      };

      document.getElementById("addPlayerBtn").onclick = () => {
        const name = playerName.value.trim();
        const level = playerLevel.value.trim();
        if (!name || !level) return alert("ì´ë¦„/ë¶€ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”");

        const id = `${name}(${level})`;

        if (!currentPlayers.includes(id)) {
          set(playersRef, [...currentPlayers, id]);
        }

        playerName.value = "";
        playerLevel.value = "";
      };

      document.getElementById("toggleDefaultBtn").onclick = () => {
        hideDefault = !hideDefault;
        renderPlayers();
      };

    })();


    // =====================================================
    //   ë Œë”ë§: ì„ ìˆ˜ ëª©ë¡
    // =====================================================
    function renderPlayers() {
      const wrap = document.getElementById("playerList");
      wrap.innerHTML = "";

      const selectedIds = Array.isArray(selected) ? selected : [];

      currentPlayers.forEach((p) => {

        if (hideDefault && defaultPlayers.includes(p)) return;

        const div = document.createElement("div");
        div.className = "player";
        div.textContent = p;

        // ìƒ‰ êµ¬ë¶„
        const lv = Number(p.match(/\((\d+)\)/)[1]);
        if (lv <= 6) div.classList.add("lv4to6");
        else if (lv <= 9) div.classList.add("lv7to9");
        else if (lv <= 12) div.classList.add("lv10to12");
        else div.classList.add("lv13to14");

        if (!defaultPlayers.includes(p)) div.classList.add("new-player");
        if (selectedIds.includes(p)) div.classList.add("selected");

        div.onclick = () => togglePlayer(p);
        wrap.appendChild(div);
      });
    }


    // =====================================================
    //   ì„ íƒ í† ê¸€
    // =====================================================
    function togglePlayer(id) {
      let arr = Array.isArray(selected) ? selected.slice() : [];

      if (arr.includes(id)) arr = arr.filter(x => x !== id);
      else arr.push(id);

      selected = arr;
      set(selectedRef, arr);

      renderPlayers();
      renderSchedule();
    }


    // =====================================================
    //   ìŠ¤ì¼€ì¤„ í…Œì´ë¸” ìƒì„±
    // =====================================================
    function renderSchedule() {
      const list = selected.filter(x => currentPlayers.includes(x));

      if (list.length < 2) {
        schedule.innerHTML = "<p>2ëª… ì´ìƒ ì„ íƒí•˜ì„¸ìš”</p>";
        return;
      }

      let html = "<div id='scheduleTable'><table><tr><th>êµ¬ë¶„</th>";

      list.forEach(p => { html += `<th>${p}</th>`; });
      html += "</tr>";

      list.forEach((a, i) => {
        html += `<tr><th>${a}</th>`;
        list.forEach((b, j) => {
          const val = (i === j) ? "X" : (results?.[`${a}__${b}`] || "");
          html += `<td onclick="openPopup('${a}','${b}')">${val}</td>`;
        });
        html += "</tr>";
      });

      html += "</table></div>";
      schedule.innerHTML = html;
    }


    // =====================================================
    //   íŒì—… ì ìˆ˜ ì…ë ¥
    // =====================================================
    window.openPopup = (a, b) => {
      popupText.textContent = `${a} vs ${b} ê²½ê¸°ê²°ê³¼`;

      const scores = ["3-0","3-1","3-2","2-0","2-1","0-0"];
      scoreButtons.innerHTML = "";

      scores.forEach(s => {
        const btn = document.createElement("button");
        btn.textContent = s;
        btn.onclick = () => {
          results[`${a}__${b}`] = s;

          // ë°˜ëŒ€ ë°©í–¥ ìë™ ì €ì¥
          const [x, y] = s.split("-").map(Number);
          results[`${b}__${a}`] = `${y}-${x}`;

          set(resultsRef, results);
          popup.style.display = "none";
          renderSchedule();
        };
        scoreButtons.appendChild(btn);
      });

      popup.style.display = "block";
    };

    window.closePopup = () => popup.style.display = "none";

  </script>

</body>
</html>
