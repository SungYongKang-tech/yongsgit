<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KOEN ë‹¨ì‹ ë¦¬ê·¸ì „(ì‹¤ì‹œê°„ì˜¨ë¼ì¸)</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    padding: 20px;
  }

  .player {
    margin: 4px;
    padding: 6px 10px;
    background: #e3f2fd;
    border: 1px solid #2196f3;
    border-radius: 6px;
    display: inline-block;
    cursor: pointer;
  }

  .player.selected {
    background: #1976d2;
    color: white;
  }

 table {
  border-collapse: collapse;
  width: 100%;
  margin-top: 20px;
  background-color: white;
}
td, th {
  border: 1px solid #888;
  padding: 8px 12px;
  text-align: center;
  font-size: 16px;
}

/* ë§¨ ìœ—ì¤„ ì „ì²´ ì˜¤ë Œì§€ìƒ‰ */
table tr:first-child th,
table tr:first-child td {
  background-color: #ffe0b2 !important;
}

/* ë§¨ ì™¼ìª½ ì—´ ì˜¤ë Œì§€ìƒ‰ */
td:first-child,
th:first-child {
  background-color: #ffe0b2 !important;
  font-weight: bold;
}

/* ë‘ ë²ˆì§¸ ì¤„ë¶€í„° ê°€ë¡œì¤„ ê¸°ì¤€ í™€/ì§ ì¤„ ìƒ‰ìƒ */
table tr:nth-child(n+2):nth-child(odd) td {
  background-color: #e3f2fd;
}
table tr:nth-child(n+2):nth-child(even) td {
  background-color: #ffffff;
}


   #popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border: 2px solid #000;
    padding: 20px;
    z-index: 9999; /* ë†’ì„ */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    min-width: 250px;
  }

  #popupOverlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.4);
    z-index: 9998; /* íŒì—… ì•„ë˜ */
  }

    #popup button {
    margin: 5px;
    padding: 6px 12px;
    font-size: 14px;
  }
</style>


</head>
<body>
  <h1>KOEN ë‹¨ì‹ ë¦¬ê·¸ì „(ì‹¤ì‹œê°„ì˜¨ë¼ì¸)</h1>
  <p>ì‹¤ì‹œê°„ ì—°ë™ ë²„ì „ : ëª¨ë“  ì‚¬ëŒ ë‹¤ ë³¼ìˆ˜ ìˆê³  ìˆ˜ì •ê°€ëŠ¥</p>
  <input type="text" id="playerName" placeholder="ì„ ìˆ˜ ì´ë¦„">
  <input type="text" id="playerLevel" placeholder="ë¶€ìˆ˜ (ì˜ˆ: 5)">
  <button id="addPlayerBtn">ì„ ìˆ˜ ì¶”ê°€</button>
  <button id="resetScoresBtn">ì ìˆ˜ ì´ˆê¸°í™”</button>
  <button id="deletePlayersBtn">ì„ ìˆ˜ ëª©ë¡ ì‚­ì œ</button>

  <h2>ì„ ìˆ˜ ëª©ë¡</h2>
  <div id="playerList"></div>
  <div id="leagueTable" style="margin-top: 30px;"></div>

<div id="popupOverlay"></div>
<div id="popup">
  <p id="popupText"></p>
  <div id="scoreButtons"></div>
  <button type="button" onclick="closePopup()">ë‹«ê¸°</button>

</div>

  <div id="rankingTable" style="margin-top: 40px;"></div>

 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  // Firebase ì„¤ì •
  const firebaseConfig = {
    apiKey: "AIzaSyDKe0-6H2z6Ed-wgN_eX_ROuNcfTusYBKg",
    authDomain: "koen-singleague.firebaseapp.com",
    databaseURL: "https://koen-singleague-default-rtdb.firebaseio.com",
    projectId: "koen-singleague",
    storageBucket: "koen-singleague.appspot.com",
    messagingSenderId: "793588437102",
    appId: "1:793588437102:web:846b6a1d9f88e480ec567f"
  };

  // Firebase ì´ˆê¸°í™”
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const playersRef = ref(db, "players");
  const resultsRef = ref(db, "results");
  const selectionRef = ref(db, "selection");

  // ì´ˆê¸° ë“±ë¡ìš© ì„ ìˆ˜ ëª©ë¡
  const allPlayers = [
    { name: "ê¹€í¬ì˜", level: 4 }, { name: "ê°•ì„±ìš©", level: 5 }, { name: "ê¹€ë²”ì¼", level: 5 },
    { name: "ì´ì˜ì§„", level: 6 }, { name: "ë°•ì£¼ë¯¼", level: 6 }, { name: "ê°•ë‹¤í›ˆ", level: 6 },
    { name: "ë°•ì§„ìš°", level: 7 }, { name: "ë°°ì„±êµ­", level: 7 }, { name: "ì´ìƒì¤€", level: 7 },
    { name: "í™©ê²½ì§„", level: 8 }, { name: "ì–‘ì¶©í˜„", level: 8 }, { name: "ì„ì¶˜ê·¼", level: 9 },
    { name: "ì „ì„±ë¬´", level: 9 }, { name: "ë°•ì¸ì°¬", level: 8 }, { name: "ì†¡ì°½ê·¼", level: 9 },
    { name: "ê°•í˜¸ì„ ", level: 10 }, { name: "ì¡°ë³´ë¯¸", level: 12 }, { name: "í™ì§€ì›", level: 13 },
    { name: "ì†¡ì€ì•„", level: 13 }, { name: "ì´ë‚­ì£¼", level: 13 }, { name: "ì´ìŠ¹ì² ", level: 13 },
    { name: "ë°•ë‚˜ë ¹", level: 14 }, { name: "ê³ ì€ì„ ", level: 14 }
  ];

  // Firebaseì— ì´ˆê¸° ì„ ìˆ˜ ë“±ë¡ (ë‹¨ 1íšŒë§Œ)
  onValue(playersRef, (snapshot) => {
    if (!snapshot.exists()) {
      const initialList = allPlayers.map(p => `${p.name}(${p.level}ë¶€)`);
      set(playersRef, initialList);
    }
  }, { onlyOnce: true });

  let currentPlayers = [];
  let results = {};
  let selectedIndices = new Set();

  function renderPlayerList(players) {
    const container = document.getElementById("playerList");
    container.innerHTML = "";
    players.forEach((player, i) => {
      const el = document.createElement("div");
      el.className = "player";
      if (selectedIndices.has(i)) el.classList.add("selected");
      el.innerText = player;
      el.addEventListener("click", () => {
        if (selectedIndices.has(i)) {
          selectedIndices.delete(i);
        } else {
          selectedIndices.add(i);
        }
        set(selectionRef, Array.from(selectedIndices));
      });
      container.appendChild(el);
    });
  }

  function generateLeague(players) {
    const leagueTable = document.getElementById("leagueTable");
    const rankingTable = document.getElementById("rankingTable");

    if (!players || players.length < 2) {
      leagueTable.innerHTML = "";
      rankingTable.innerHTML = "";
      return;
    }

    const table = document.createElement("table");
    const header = table.insertRow();
    header.insertCell().innerText = "ì„  ìˆ˜";
    players.forEach(p => header.insertCell().innerText = p);

    players.forEach((rowPlayer, i) => {
      const row = table.insertRow();
      row.insertCell().innerText = rowPlayer;
      players.forEach((colPlayer, j) => {
        const cell = row.insertCell();
        if (i === j) {
          cell.innerText = "-";
        } else {
          const key = `${rowPlayer}-${colPlayer}`;
          cell.innerText = results[key] || "";
          cell.style.cursor = "pointer";
          cell.addEventListener("click", () => openPopup(rowPlayer, colPlayer));
        }
      });
    });

    leagueTable.innerHTML = "<h2>ë¦¬ê·¸ì „ í‘œ</h2>";
    leagueTable.appendChild(table);
    renderRanking(players);
  }

  function renderRanking(players) {
    if (!players || players.length === 0) return;

    const scores = players.map(_ => ({ win: 0, pointDiff: 0 }));

    players.forEach((p1, i) => {
      players.forEach((p2, j) => {
        if (i === j) return;
        const result = results[`${p1}-${p2}`];
        if (result) {
          const [a, b] = result.split("-").map(Number);
          if (a > b) scores[i].win++;
          scores[i].pointDiff += a - b;
        }
      });
    });

    const rankingData = players.map((p, i) => ({
      name: p,
      win: scores[i].win,
      diff: scores[i].pointDiff
    })).sort((a, b) => b.win - a.win || b.diff - a.diff);

    const table = document.createElement("table");
    const header = table.insertRow();
    ["ì´ ë¦„", "ìŠ¹ ìˆ˜", "ë“ì‹¤ì°¨", "ìˆœ ìœ„"].forEach(h => header.insertCell().innerText = h);

    rankingData.forEach((r, i) => {
      const row = table.insertRow();
      row.insertCell().innerText = r.name;
      row.insertCell().innerText = r.win;
      row.insertCell().innerText = r.diff;
      row.insertCell().innerText = i + 1;
    });

    const rankingDiv = document.getElementById("rankingTable");
    rankingDiv.innerHTML = "<h2>ìˆœìœ„í‘œ</h2>";
    rankingDiv.appendChild(table);
  }

  function openPopup(p1, p2) {
  const popup = document.getElementById("popup");
  const scoreButtons = document.getElementById("scoreButtons");
  const popupText = document.getElementById("popupText");
  popupText.innerText = `${p1} ì„ ìˆ˜ê°€ ${p2} ì„ ìˆ˜ì—ê²Œ ëª‡ ëŒ€ ëª‡ìœ¼ë¡œ ì´ê²¼ë‚˜ìš”?`;

  scoreButtons.innerHTML = "";

  // ì ìˆ˜ ì…ë ¥ ë²„íŠ¼ë“¤
  ["3-0", "3-1", "3-2", "2-0", "2-1", "0-0"].forEach(score => {
    const btn = document.createElement("button");
    btn.textContent = score;
    btn.onclick = () => {
  if (score === "0-0") {
    results[`${p1}-${p2}`] = "0-0";
    results[`${p2}-${p1}`] = "0-0";
  } else {
    results[`${p1}-${p2}`] = score;
    const [a, b] = score.split("-").map(Number);
    results[`${p2}-${p1}`] = `${b}-${a}`;
  }

  // âœ… Firebase ì €ì¥ í›„ ë‹«ê¸°
  set(resultsRef, results).then(() => {
    closePopup();
  });
};
    scoreButtons.appendChild(btn);
  });

  // ğŸ—‘ ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
  const deleteBtn = document.createElement("button");
deleteBtn.textContent = "ì‚­ì œ";
deleteBtn.style.backgroundColor = "#f44336";
deleteBtn.style.color = "#fff";
deleteBtn.onclick = () => {
  delete results[`${p1}-${p2}`];
  delete results[`${p2}-${p1}`];
  set(resultsRef, results).then(() => {
    closePopup();
  });
};
scoreButtons.appendChild(deleteBtn);

   document.getElementById("popupOverlay").style.display = "block";
  popup.style.display = "block";
}


 function closePopup() {
  document.getElementById("popup").style.display = "none";
  document.getElementById("popupOverlay").style.display = "none";

  // ë‚´ë¶€ í…ìŠ¤íŠ¸ ë° ë²„íŠ¼ ì´ˆê¸°í™”
  document.getElementById("popupText").innerText = "";
  document.getElementById("scoreButtons").innerHTML = "";

  // í¬ì»¤ìŠ¤ í•´ì œ (ëª¨ë°”ì¼ì—ì„œ íŒì—… ë‚´ì— ëˆŒë ¤ ìˆë˜ ë²„íŠ¼ íš¨ê³¼ ì œê±°)
  document.activeElement?.blur();
}



  document.getElementById("addPlayerBtn").addEventListener("click", () => {
    const name = document.getElementById("playerName").value;
    const level = document.getElementById("playerLevel").value;
    if (!name || !level) return alert("ì´ë¦„ê³¼ ë¶€ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
    const newPlayer = `${name}(${level}ë¶€)`;
    onValue(playersRef, (snapshot) => {
      let current = snapshot.val() || [];
      if (!current.includes(newPlayer)) {
        current.push(newPlayer);
        set(playersRef, current);
      }
    }, { onlyOnce: true });
  });

  document.getElementById("resetScoresBtn").addEventListener("click", () => {
    results = {};
    set(resultsRef, results);
  });

  document.getElementById("deletePlayersBtn").addEventListener("click", () => {
    remove(playersRef);
    remove(resultsRef);
    remove(selectionRef);
    location.reload();
  });

  onValue(playersRef, (snapshot) => {
    const data = snapshot.val();
    if (data && Array.isArray(data)) {
      currentPlayers = data;
      renderPlayerList(currentPlayers);
      const selectedPlayers = Array.from(selectedIndices)
        .map(idx => currentPlayers[idx])
        .filter(Boolean);
      generateLeague(selectedPlayers);
    }
  });

  onValue(resultsRef, (snapshot) => {
    results = snapshot.val() || {};
    if (selectedIndices.size > 1) {
      const selectedPlayers = Array.from(selectedIndices)
        .map(idx => currentPlayers[idx])
        .filter(Boolean);
      generateLeague(selectedPlayers);
    }
  });

  onValue(selectionRef, (snapshot) => {
    const data = snapshot.val() || [];
    selectedIndices = new Set(data);
    renderPlayerList(currentPlayers);
    const selectedPlayers = Array.from(selectedIndices)
      .map(idx => currentPlayers[idx])
      .filter(Boolean);
    generateLeague(selectedPlayers);
  });
</script>

</body>
</html>
