<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>íŒ€ ì¶œì „ëª…ë‹¨ êµ¬ì„±</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      margin: 0;
      background-color: #f9f9f9;
    }
    .player-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }
    .player {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
    }
    .selected {
      background-color: #c8e6c9;
      font-weight: bold;
    }
    .hidden {
      display: none;
    }
    .lineup-section {
      margin-top: 30px;
    }
    .lineup-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .lineup-table td, .lineup-table th {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    button {
      margin: 5px;
      padding: 6px 12px;
      cursor: pointer;
    }
    @media screen and (max-width: 600px) {
      .player-list {
        flex-direction: column;
      }
      .player {
        width: 100%;
        box-sizing: border-box;
      }
      .lineup-table td, .lineup-table th {
        padding: 6px;
        font-size: 0.9em;
      }
      .lineup-table input {
        width: 100%;
        box-sizing: border-box;
      }
    }
  </style>
</head>
<body>
  <h2 id="teamTitle">íŒ€ ì¶œì „ëª…ë‹¨ êµ¬ì„±</h2>
  <div id="matchOrderDisplay"></div>

  <h3>â‘  íŒ€ì› ì„ íƒ</h3>
  <div class="player-list" id="playerList"></div>
  <button onclick="confirmTeamMembers()">íŒ€ì› í™•ì •</button>
  <button onclick="unconfirmTeamMembers()">íŒ€ì› í™•ì • í•´ì œ</button>

  <div class="lineup-section">
    <h3>â‘¡ ê²½ê¸°ë³„ ì¶œì „ ëª…ë‹¨</h3>
    <div id="lineupArea"></div>
    <button onclick="saveLineup()">ëª…ë‹¨ ì €ì¥</button>
    <button onclick="toggleOpen()" id="openBtn">ê³µê°œ</button>
  </div>

  <div style="margin-top: 40px; text-align: center;">
    <a href="index.html">
      <button style="background-color: #388e3c; color: white; font-size: 16px; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">
        ğŸ“‹ ëŒ€ì§„í‘œ ë³´ëŸ¬ ê°€ê¸°
      </button>
    </a>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDcJO_DClEdSo1HiPsL1KYbSWOVzMgSgEs",
      authDomain: "koen-teammatch.firebaseapp.com",
      databaseURL: "https://koen-teammatch-default-rtdb.firebaseio.com",
      projectId: "koen-teammatch",
      storageBucket: "koen-teammatch.appspot.com",
      messagingSenderId: "302792900934",
      appId: "1:302792900934:web:8e727af88df3de536f2547"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const teamId = urlParams.get('team');
    if (!teamId) alert("URLì— ?team=0 ê³¼ ê°™ì´ íŒ€ IDë¥¼ ì§€ì •í•´ì£¼ì„¸ìš”.");

    let matchOrder = [];
    let teamData = {};
    let allPlayers = [];
    let currentInput = null;

    function fetchMatchOrder() {
      db.ref("matchOrder").once("value").then(snap => {
        matchOrder = snap.val() || [];
        document.getElementById("matchOrderDisplay").innerText = "ê²½ê¸° ìˆœì„œ: " + matchOrder.join(" â†’ ");
        renderLineupInputs();
      });
    }

    function fetchAllPlayers() {
      allPlayers = [
        { name: "ê¹€í¬ì˜", level: 4 }, { name: "ê°•ì„±ìš©", level: 5 }, { name: "ê¹€ë²”ì¼", level: 5 },
        { name: "ì´ì˜ì§„", level: 6 }, { name: "ë°•ì£¼ë¯¼", level: 6 }, { name: "ê°•ë‹¤í›ˆ", level: 6 }, { name: "ì¡°ë‚­ì—°", level: 6 },
        { name: "ë°•ì§„ìš°", level: 7 }, { name: "ë°°ì„±êµ­", level: 7 }, { name: "ì´ìƒì¤€", level: 7 },
        { name: "í™©ê²½ì§„", level: 8 }, { name: "ì–‘ì¶©í˜„", level: 8 }, { name: "ì„ì¶˜ê·¼", level: 9 },
        { name: "ì „ì„±ë¬´", level: 9 }, { name: "ë°•ì¸ì°¬", level: 8 }, { name: "ì†¡ì°½ê·¼", level: 9 },
        { name: "ê°•í˜¸ì„ ", level: 10 }, { name: "ì¡°ë³´ë¯¸", level: 12 }, { name: "í™ì§€ì›", level: 13 },
        { name: "ì†¡ì€ì•„", level: 13 }, { name: "ì´ë‚­ì£¼", level: 13 }, { name: "ì´ìŠ¹ì² ", level: 13 },
        { name: "ë°•ë‚˜ë ¹", level: 14 }, { name: "ê³ ì€ì„ ", level: 14 }
      ];
      renderPlayerList();
    }

    function fetchTeam() {
      db.ref("teams/" + teamId).once("value").then(snap => {
        teamData = snap.val() || {};
        document.getElementById("teamTitle").innerText = teamData.name + " ì¶œì „ëª…ë‹¨ êµ¬ì„±";
        renderPlayerList();
        renderLineupInputs();
        updateOpenButton();
      });
    }

    function renderPlayerList() {
      const listEl = document.getElementById("playerList");
      listEl.innerHTML = "";
      allPlayers.forEach(player => {
        const div = document.createElement("div");
        div.className = "player";
        div.textContent = `${player.name} (${player.level})`;
        div.dataset.name = player.name;
        if (teamData.members?.includes(player.name)) div.classList.add("selected");
        if (teamData.confirmed && !teamData.members?.includes(player.name)) div.classList.add("hidden");
        div.onclick = () => {
          if (teamData.confirmed) return;
          if (currentInput) currentInput.value = player.name;
        };
        listEl.appendChild(div);
      });
    }

    function confirmTeamMembers() {
      const selected = [...document.querySelectorAll(".player.selected")].map(div => div.dataset.name);
      db.ref(`teams/${teamId}`).update({ members: selected, confirmed: true });
      teamData.members = selected;
      teamData.confirmed = true;
      renderPlayerList();
    }

    function unconfirmTeamMembers() {
      if (!confirm("íŒ€ì› í™•ì •ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      db.ref(`teams/${teamId}`).update({ confirmed: false }).then(() => {
        teamData.confirmed = false;
        renderPlayerList();
      });
    }

    function renderLineupInputs() {
      const area = document.getElementById("lineupArea");
      if (!matchOrder.length || !teamData.members) return;
      area.innerHTML = "";
      const table = document.createElement("table");
      table.className = "lineup-table";
      const tbody = document.createElement("tbody");
      matchOrder.forEach((type, idx) => {
        const row = document.createElement("tr");
        const label = document.createElement("td");
        label.innerHTML = `<strong>${idx + 1}. ${type}</strong>`;
        row.appendChild(label);
        const count = type.includes("ë³µì‹") ? 2 : 1;
        for (let i = 0; i < count; i++) {
          const cell = document.createElement("td");
          const input = document.createElement("input");
          input.type = "text";
          input.placeholder = "ì„ ìˆ˜ ì´ë¦„";
          input.value = teamData.lineup?.[idx]?.[i] || "";
          input.onclick = () => currentInput = input;
          cell.appendChild(input);
          row.appendChild(cell);
        }
        tbody.appendChild(row);
      });
      table.appendChild(tbody);
      area.appendChild(table);
    }

    function saveLineup() {
      const rows = document.querySelectorAll(".lineup-table tr");
      const result = {};
      rows.forEach((row, idx) => {
        const inputs = row.querySelectorAll("input");
        result[idx] = [...inputs].map(i => i.value.trim());
      });
      db.ref(`teams/${teamId}/lineup`).set(result);
      alert("ì¶œì „ ëª…ë‹¨ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function toggleOpen() {
      const newState = !teamData.open;
      db.ref(`teams/${teamId}/open`).set(newState);
      teamData.open = newState;
      updateOpenButton();
    }

    function updateOpenButton() {
      const btn = document.getElementById("openBtn");
      btn.textContent = teamData.open ? "ğŸ™ˆ ë¹„ê³µê°œ" : "ğŸ‘ ê³µê°œ";
    }

    fetchMatchOrder();
    fetchAllPlayers();
    fetchTeam();
  </script>
</body>
</html>
