<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>팀 출전명단 구성</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      margin: 0;
      background-color: #f9f9f9;
    }
    .player-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }
    .player {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
    }
    .selected {
      background-color: #c8e6c9;
      font-weight: bold;
    }
    .hidden {
      display: none;
    }
    .lineup-section {
      margin-top: 30px;
    }
    .lineup-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .lineup-table td, .lineup-table th {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    button {
      margin: 5px;
      padding: 6px 12px;
      cursor: pointer;
    }
    @media screen and (max-width: 600px) {
      .player-list {
        flex-direction: column;
      }
      .player {
        width: 100%;
        box-sizing: border-box;
      }
      .lineup-table td, .lineup-table th {
        padding: 6px;
        font-size: 0.9em;
      }
      .lineup-table input {
        width: 100%;
        box-sizing: border-box;
      }
    }
  </style>
</head>
<body>
  <h2 id="teamTitle">팀 출전명단 구성</h2>
  <div id="matchOrderDisplay"></div>

  <h3>① 팀원 선택</h3>
  <div class="player-list" id="playerList"></div>
  <button onclick="confirmTeamMembers()">팀원 확정</button>
  <button onclick="unconfirmTeamMembers()">팀원 확정 해제</button>

  <div class="lineup-section">
    <h3>② 경기별 출전 명단</h3>
    <div id="lineupArea"></div>
    <button onclick="saveLineup()">명단 저장</button>
    <button onclick="toggleOpen()" id="openBtn">공개</button>
  </div>

  <div style="margin-top: 40px; text-align: center;">
    <a href="index.html">
      <button style="background-color: #388e3c; color: white; font-size: 16px; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">
        📋 대진표 보러 가기
      </button>
    </a>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDcJO_DClEdSo1HiPsL1KYbSWOVzMgSgEs",
      authDomain: "koen-teammatch.firebaseapp.com",
      databaseURL: "https://koen-teammatch-default-rtdb.firebaseio.com",
      projectId: "koen-teammatch",
      storageBucket: "koen-teammatch.appspot.com",
      messagingSenderId: "302792900934",
      appId: "1:302792900934:web:8e727af88df3de536f2547"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const teamId = urlParams.get('team');
    if (!teamId) alert("URL에 ?team=0 과 같이 팀 ID를 지정해주세요.");

    let matchOrder = [];
    let teamData = {};
    let allPlayers = [];
    let currentInput = null;

    function fetchMatchOrder() {
      db.ref("matchOrder").once("value").then(snap => {
        matchOrder = snap.val() || [];
        document.getElementById("matchOrderDisplay").innerText = "경기 순서: " + matchOrder.join(" → ");
        renderLineupInputs();
      });
    }

    function fetchAllPlayers() {
      allPlayers = [
        { name: "김희영", level: 4 }, { name: "강성용", level: 5 }, { name: "김범일", level: 5 },
        { name: "이영진", level: 6 }, { name: "박주민", level: 6 }, { name: "강다훈", level: 6 }, { name: "조낭연", level: 6 },
        { name: "박진우", level: 7 }, { name: "배성국", level: 7 }, { name: "이상준", level: 7 },
        { name: "황경진", level: 8 }, { name: "양충현", level: 8 }, { name: "임춘근", level: 9 },
        { name: "전성무", level: 9 }, { name: "박인찬", level: 8 }, { name: "송창근", level: 9 },
        { name: "강호선", level: 10 }, { name: "조보미", level: 12 }, { name: "홍지원", level: 13 },
        { name: "송은아", level: 13 }, { name: "이낭주", level: 13 }, { name: "이승철", level: 13 },
        { name: "박나령", level: 14 }, { name: "고은선", level: 14 }
      ];
      renderPlayerList();
    }

    function fetchTeam() {
      db.ref("teams/" + teamId).once("value").then(snap => {
        teamData = snap.val() || {};
        document.getElementById("teamTitle").innerText = teamData.name + " 출전명단 구성";
        renderPlayerList();
        renderLineupInputs();
        updateOpenButton();
      });
    }

    function renderPlayerList() {
      const listEl = document.getElementById("playerList");
      listEl.innerHTML = "";
      allPlayers.forEach(player => {
        const div = document.createElement("div");
        div.className = "player";
        div.textContent = `${player.name} (${player.level})`;
        div.dataset.name = player.name;
        if (teamData.members?.includes(player.name)) div.classList.add("selected");
        if (teamData.confirmed && !teamData.members?.includes(player.name)) div.classList.add("hidden");
        div.onclick = () => {
          if (teamData.confirmed) return;
          if (currentInput) currentInput.value = player.name;
        };
        listEl.appendChild(div);
      });
    }

    function confirmTeamMembers() {
      const selected = [...document.querySelectorAll(".player.selected")].map(div => div.dataset.name);
      db.ref(`teams/${teamId}`).update({ members: selected, confirmed: true });
      teamData.members = selected;
      teamData.confirmed = true;
      renderPlayerList();
    }

    function unconfirmTeamMembers() {
      if (!confirm("팀원 확정을 해제하시겠습니까?")) return;
      db.ref(`teams/${teamId}`).update({ confirmed: false }).then(() => {
        teamData.confirmed = false;
        renderPlayerList();
      });
    }

    function renderLineupInputs() {
      const area = document.getElementById("lineupArea");
      if (!matchOrder.length || !teamData.members) return;
      area.innerHTML = "";
      const table = document.createElement("table");
      table.className = "lineup-table";
      const tbody = document.createElement("tbody");
      matchOrder.forEach((type, idx) => {
        const row = document.createElement("tr");
        const label = document.createElement("td");
        label.innerHTML = `<strong>${idx + 1}. ${type}</strong>`;
        row.appendChild(label);
        const count = type.includes("복식") ? 2 : 1;
        for (let i = 0; i < count; i++) {
          const cell = document.createElement("td");
          const input = document.createElement("input");
          input.type = "text";
          input.placeholder = "선수 이름";
          input.value = teamData.lineup?.[idx]?.[i] || "";
          input.onclick = () => currentInput = input;
          cell.appendChild(input);
          row.appendChild(cell);
        }
        tbody.appendChild(row);
      });
      table.appendChild(tbody);
      area.appendChild(table);
    }

    function saveLineup() {
      const rows = document.querySelectorAll(".lineup-table tr");
      const result = {};
      rows.forEach((row, idx) => {
        const inputs = row.querySelectorAll("input");
        result[idx] = [...inputs].map(i => i.value.trim());
      });
      db.ref(`teams/${teamId}/lineup`).set(result);
      alert("출전 명단이 저장되었습니다.");
    }

    function toggleOpen() {
      const newState = !teamData.open;
      db.ref(`teams/${teamId}/open`).set(newState);
      teamData.open = newState;
      updateOpenButton();
    }

    function updateOpenButton() {
      const btn = document.getElementById("openBtn");
      btn.textContent = teamData.open ? "🙈 비공개" : "👁 공개";
    }

    fetchMatchOrder();
    fetchAllPlayers();
    fetchTeam();
  </script>
</body>
</html>
