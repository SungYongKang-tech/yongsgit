<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>â­KOEN íƒêµ¬ ì›”ê°„ë¦¬ê·¸</title>
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --card:#fff; --bg:#f5f7fb;
      --primary:#0d47a1; --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
      --shadow:0 8px 28px rgba(0,0,0,.08)
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; color:var(--ink); background:var(--bg)}
    header{position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #e5e7eb}
    .wrap{max-width:1040px; margin:0 auto; padding:14px 16px}
    h1{margin:4px 0 6px; font-size:clamp(18px,4vw,24px); color:var(--primary)}
    main{max-width:1040px; margin:16px auto; padding:0 16px 28px}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{border:1px solid #d1d5db; border-radius:10px; padding:8px 12px; font-size:14px; background:#fff; cursor:pointer}
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
    .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#eef2ff; border:1px solid #d1d5db; border-radius:999px; font-size:13px}
    .card{background:var(--card); border:1px solid #e5e7eb; border-radius:16px; padding:14px; box-shadow:var(--shadow); margin:12px 0}

    table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:12px;
      overflow:hidden;
      table-layout: fixed;
    }
    thead th{background:#f8fafc; border-bottom:1px solid #e5e7eb; padding:8px 10px; font-size:14px; color:#334155; text-align:left}
    tbody td{
      border-bottom:1px solid #f1f5f9;
      padding:8px 10px;
      font-size:14px;
      line-height:1.25;
      white-space: nowrap;
    }
    tbody tr:hover{background:#fafafa}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .delta.pos{color:var(--ok); font-weight:600}
    .delta.neg{color:var(--danger); font-weight:600}
    .awards{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px}
    .award{border:1px dashed #d1d5db; border-radius:14px; padding:12px}
    .award b{font-size:16px}
    .small{font-size:12px}

    /* í‘œ ì»¬ëŸ¼ í­ */
    table col.col-no    { width: 24px; }
    table col.col-name  { width: 56px; }
    table col.col-games { width: 48px; }
    table col.col-wp    { width: 48px; }
    table col.col-prev  { width: 50px; }
    table col.col-month { width: 50px; }
    table col.col-delta { width: 50px; }

    /* ëª¨ë°”ì¼: ì´ë¦„ í­ ë„‰ë„‰íˆ */
    @media (max-width: 640px){
      table col.col-name { width: 50%; }
      thead th, tbody td { padding: 6px 8px; }
    }

    /* ì´ë¦„ì€ ì¤„ë°”ê¿ˆ ê¸ˆì§€(ellipsis ë¯¸ì‚¬ìš©) */
    tbody td.name { white-space: nowrap; }
    .capture-ready * { -webkit-font-smoothing: antialiased; }

    /* ìˆœìœ„ ë¦¬ìŠ¤íŠ¸: ìˆ«ì ë§ˆì»¤ ìˆ¨ê¹€ */
ol.rank{ list-style:none; margin:6px 0 0 0; padding:0; }

/* í—¤ë” 'ì´ë¦„'ë§Œ í•œ ì¤„(ê°€ë¡œ) */
table thead tr > th:nth-child(2){ white-space: nowrap; }

/* í—¤ë”Â·ë°”ë”” ì „ë¶€ ì¤‘ì•™ */
thead th, tbody td { text-align: center; }

  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <h1 style="margin-right:7px">â­íƒêµ¬ ì›”ê°„ë¦¬ê·¸
        <span id="titleMonth" class="muted" style="margin-left:7px; font-weight:500"></span>
      </h1>
      <a class="btn primary" href="./" title="ì„±ì ì…ë ¥ìœ¼ë¡œ ëŒì•„ê°€ê¸°">ì „ì ì…ë ¥<br></a>
    </div>
    <div class="row">
      <button id="sortWinrate" class="btn primary">ìŠ¹ë¥ </button>
      <button id="sortGames" class="btn">ìµœë‹¤ê²½ê¸°</button>
      <button id="sortWins" class="btn">ë‹¤ìŠ¹</button>
      <button id="saveImage" class="btn">ì´ë¯¸ì§€ ì €ì¥</button>
    </div>
  </div>
</header>

<main>
  <!-- ìº¡ì²˜ ì˜ì—­ -->
  <div id="captureArea">

    <!-- ì´ë‹¬ ì „ì  í‘œ -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:700">ì´ë‹¬ì˜ ì „ì </div>
        <div class="muted small">ì´ì „ ìŠ¹ë¥  = ì§€ë‚œë‹¬, ì´ë‹¬ ìŠ¹ë¥  = ì´ë²ˆë‹¬, ìŠ¹ë¥  ì¦ê° = ì´ë‹¬ âˆ’ ì§€ë‚œë‹¬</div>
      </div>
      <div style="overflow:auto; margin-top:8px">
        <table>
          <colgroup>
            <col class="col-no" />
            <col class="col-name" />
            <col class="col-games" />
            <col class="col-wp" />
            <col class="col-prev" />
            <col class="col-month" />
            <col class="col-delta" />
          </colgroup>
          <thead>
            <tr>
              <th>ë²ˆí˜¸</th>
              <th>ì´ë¦„</th>
              <th class="right">ê²Œì„íšŸìˆ˜</th>
              <th class="right">ìŠ¹/íŒ¨</th>
              <th class="right">ì´ì „ìŠ¹ë¥ </th>
              <th class="right">ì´ë‹¬ìŠ¹ë¥ </th>
              <th class="right">ìŠ¹ë¥ ì¦ê°</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- ì´ë‹¬ ì–´ì›Œë“œ -->
    <section class="card">
      <div class="awards">
        <div class="award">
          <b>ìµœë‹¤ê²½ê¸° TOP3</b>
          <!-- â–¼ div â†’ ol ë¡œ ë³€ê²½ -->
          <ol id="mostGames" class="rank"></ol>
        </div>
        <div class="award">
          <b>ë‹¤ìŠ¹ TOP3</b>
          <ol id="topWins" class="rank"></ol>
        </div>
       <div class="award">
  <b>ê¸°ëŸ‰ìƒìŠ¹ TOP3</b>
  <ol id="risingTop3" class="rank"></ol>
  <div class="small muted">(ì¡°ê±´: ì´ë²ˆë‹¬ 15ê²½ê¸° ì´ìƒ, ìŠ¹ë¥  ìƒìŠ¹ ìƒìœ„ 3ëª…)</div>
</div>

       
        <div class="award">
          <b>ë¶€ìˆ˜ìƒí–¥ ê¶Œê³ </b>
          <ul id="upgradeList" style="margin:6px 0 0 18px; padding:0"></ul>
          <div class="small muted">(ì¡°ê±´: ì´ë²ˆë‹¬ 10ê²½ê¸° ì´ìƒ, ìŠ¹ë¥  â‰¥ 70%)</div>
        </div>
      </div>
    </section>

    <!-- ì§€ë‚œë‹¬ ì „ì  í‘œ (ì—†ìœ¼ë©´ ìˆ¨ê¹€) -->
    <section id="prevSection" class="card" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:700">ì§€ë‚œë‹¬ ì „ì  <span id="prevTitleMonth" class="muted" style="margin-left:6px; font-weight:500"></span></div>
        <div class="muted small">ì§€ë‚œë‹¬ì˜ ìˆœìˆ˜ ì „ì (ìŠ¹/íŒ¨, ìŠ¹ë¥ )ì„ ì§‘ê³„í•©ë‹ˆë‹¤.</div>
      </div>
      <div style="overflow:auto; margin-top:8px">
        <table>
          <colgroup>
            <col class="col-no" />
            <col class="col-name" />
            <col class="col-games" />
            <col class="col-wp" />
            <col class="col-month" />
          </colgroup>
          <thead>
            <tr>
              <th>ë²ˆí˜¸</th>
              <th>ì´ë¦„</th>
              <th class="right">ê²Œì„íšŸìˆ˜</th>
              <th class="right">ìŠ¹/íŒ¨</th>
              <th class="right">ìŠ¹ë¥ </th>
            </tr>
          </thead>
          <tbody id="prevTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- ì§€ë‚œë‹¬ ì–´ì›Œë“œ (ì—†ìœ¼ë©´ ìˆ¨ê¹€) -->
    <section id="prevAwards" class="card" style="display:none">
      <div class="awards">
        <div class="award">
          <b>ì§€ë‚œë‹¬ ìµœë‹¤ê²½ê¸° TOP3</b>
          <!-- â–¼ div â†’ ol ë¡œ ë³€ê²½ -->
          <ol id="prevMostGames" class="rank"></ol>
        </div>
        <div class="award">
          <b>ì§€ë‚œë‹¬ ë‹¤ìŠ¹ TOP3</b>
          <ol id="prevTopWins" class="rank"></ol>
        </div>
        <div class="award">
          <b>ì§€ë‚œë‹¬ ë¶€ìˆ˜ìƒí–¥ ê¶Œê³ </b>
          <ul id="prevUpgradeList" style="margin:6px 0 0 18px; padding:0"></ul>
          <div class="small muted">(ì¡°ê±´: ì§€ë‚œë‹¬ 10ê²½ê¸° ì´ìƒ, ìŠ¹ë¥  â‰¥ 70%)</div>
        </div>
      </div>
    </section>

  </div>
</main>

<!-- html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  // ========== Firebase ==========
  const firebaseConfig = {
    apiKey: "AIzaSyC5iq3VY0QtBh8FVn70gi_Gsg7GXzkxdu8",
    authDomain: "koen-pingpong.firebaseapp.com",
    databaseURL: "https://koen-pingpong-default-rtdb.firebaseio.com",
    projectId: "koen-pingpong",
    storageBucket: "koen-pingpong.appspot.com",
    messagingSenderId: "597358811982",
    appId: "1:597358811982:web:b66dcb6a7159fb5f321c1f"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // ========== KST ê¸°ì¤€ ì›” í‚¤ ==========
  const pad = (n)=> String(n).padStart(2,'0');
  const toKST = (t = Date.now()) => new Date(
    new Date(t).toLocaleString('en-US', { timeZone: 'Asia/Seoul' })
  );
  function monthKeyFromTs(ts){
    const d = toKST(ts);
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
  }
  function prevMonthKey(key){
    const [y,m] = key.split('-').map(Number);
    const d = new Date(y, m-2, 1);
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
  }
  function titleMon(key){
    const [y,m] = key.split('-').map(Number);
    return `('${String(y).slice(-2)}.${pad(m)})`;
  }

  const qs = new URLSearchParams(location.search);
  const monOverride = qs.get('mon');
  const nowKST = toKST();
  const CUR_MON  = monOverride && /^\d{4}-\d{2}$/.test(monOverride) ? monOverride
                  : `${nowKST.getFullYear()}-${pad(nowKST.getMonth()+1)}`;
  const PREV_MON = prevMonthKey(CUR_MON);

  // ì œëª© ì˜† ì›” í‘œì‹œ
  const titleMonthEl = document.getElementById('titleMonth');
  if (titleMonthEl) titleMonthEl.textContent = titleMon(CUR_MON);

  // ========== ì •ë ¬ ìƒíƒœ ==========
  let sortMode = 'winrate';
  const toggleSortButtons = ()=>{
    document.getElementById('sortWinrate').classList.toggle('primary', sortMode==='winrate');
    document.getElementById('sortGames').classList.toggle('primary', sortMode==='games');
    document.getElementById('sortWins').classList.toggle('primary', sortMode==='wins');
  };
  document.getElementById('sortWinrate').onclick = ()=>{ sortMode='winrate'; render(); toggleSortButtons(); };
  document.getElementById('sortGames').onclick   = ()=>{ sortMode='games';   render(); toggleSortButtons(); };
  document.getElementById('sortWins').onclick    = ()=>{ sortMode='wins';    render(); toggleSortButtons(); };
  toggleSortButtons();

  // ========== ìœ í‹¸ ==========
  const slugify = (s)=> s?.toString().replace(/[()]/g,'').replace(/\s+/g,'-').replace(/[^\p{L}\p{N}-]/gu,'').toLowerCase();
  const pct = (v)=> isFinite(v) ? (v*100).toFixed(1)+'%' : '-';
  const fmtIntOrHalf = (n)=> Number.isInteger(n) ? n.toString() : n.toFixed(1);
  const isNum = (v)=> typeof v === 'number' && isFinite(v);

  // ========== ì§‘ê³„ ìƒíƒœ ==========
  const names  = {};
  const prev   = {};
  const mon    = {};
  const prevMon= {};
  function ensurePrev(pid){ if(!prev[pid])    prev[pid]    = {gw:0, ww:0}; }
  function ensureMon(pid){  if(!mon[pid])     mon[pid]     = {games:0, wins:0, losses:0, gw:0, ww:0}; }
  function ensurePrevMon(pid){ if(!prevMon[pid]) prevMon[pid] = {games:0, wins:0, losses:0, gw:0, ww:0}; }

  // ê²½ê¸° ë°˜ì˜ (ë¦¬í¬íŠ¸ëŠ” ê°€ì¤‘ì¹˜ ë¯¸ì‚¬ìš©)
  function addMatch(bucket, m){
    const weight = 1;
    const sideA = (m.membersA && m.membersA.length ? m.membersA.map((pid,i)=>[pid, m.namesA?.[i]]) :
                  (m.namesA && m.namesA.length ? m.namesA.map((nm)=>[slugify(nm), nm]) : []));
    const sideB = (m.membersB && m.membersB.length ? m.membersB.map((pid,i)=>[pid, m.namesB?.[i]]) :
                  (m.namesB && m.namesB.length ? m.namesB.map((nm)=>[slugify(nm), nm]) : []));
    const winA = m.winnerSide === 'A';
    const winB = m.winnerSide === 'B';

    if(bucket === 'month'){
      sideA.forEach(([pid, nm])=>{ ensureMon(pid); if(nm) names[pid]=nm;
        mon[pid].games+=1; mon[pid].wins+=(winA?1:0); mon[pid].losses+=(winB?1:0);
        mon[pid].gw+=weight; mon[pid].ww+=(winA?weight:0);
      });
      sideB.forEach(([pid, nm])=>{ ensureMon(pid); if(nm) names[pid]=nm;
        mon[pid].games+=1; mon[pid].wins+=(winB?1:0); mon[pid].losses+=(winA?1:0);
        mon[pid].gw+=weight; mon[pid].ww+=(winB?weight:0);
      });
    }else{
      sideA.forEach(([pid, nm])=>{ ensurePrev(pid); ensurePrevMon(pid); if(nm) names[pid]=nm;
        prev[pid].gw+=weight; prev[pid].ww+=(winA?weight:0);
        prevMon[pid].games+=1; prevMon[pid].wins+=(winA?1:0); prevMon[pid].losses+=(winB?1:0);
        prevMon[pid].gw+=weight; prevMon[pid].ww+=(winA?weight:0);
      });
      sideB.forEach(([pid, nm])=>{ ensurePrev(pid); ensurePrevMon(pid); if(nm) names[pid]=nm;
        prev[pid].gw+=weight; prev[pid].ww+=(winB?weight:0);
        prevMon[pid].games+=1; prevMon[pid].wins+=(winB?1:0); prevMon[pid].losses+=(winA?1:0);
        prevMon[pid].gw+=weight; prevMon[pid].ww+=(winB?weight:0);
      });
    }
  }

  // ì „ì²´ ì¬ì§‘ê³„
  function rebuild(all){
    for(const k in prev)    delete prev[k];
    for(const k in mon)     delete mon[k];
    for(const k in prevMon) delete prevMon[k];

    Object.values(all || {}).forEach((m)=>{
      const ts = isNum(m.ts) ? m.ts : (isNum(m.createdAt) ? m.createdAt : NaN);
      const key = m.monthKey || (isFinite(ts) ? monthKeyFromTs(ts) : null);
      if(!key) return;

      if(key === CUR_MON)      addMatch('month', m);
      else if(key === PREV_MON) addMatch('prev',  m);
    });
  }

  // ì´ë‹¬ í‘œìš© ë°ì´í„°
  function buildRows(){
    const pids = Object.keys(mon).filter(pid=> mon[pid].games>0);
    const rows = pids.map(pid=>{
      const m = mon[pid], p = prev[pid] || {gw:0, ww:0};
      const prevRate  = (p.gw>0) ? (p.ww/p.gw) : NaN;
      const monthRate = (m.gw>0) ? (m.ww/m.gw) : NaN;
      const delta = (isFinite(prevRate) && isFinite(monthRate)) ? (monthRate - prevRate) : NaN;
      return { pid, name:names[pid]||pid, games:m.games, wins:m.wins, losses:m.losses,
               prevRate, monthRate, delta, weightedWins:m.ww };
    });

    if(sortMode==='winrate'){
  rows.sort((a, b) => {
    // ìš°ì„ ìˆœìœ„:
    // 1. 5ê²Œì„ ì´ìƒ vs ì´í•˜: 5ê²Œì„ ì´ìƒì´ ìš°ì„ 
    const a5 = a.games >= 5 ? 1 : 0;
    const b5 = b.games >= 5 ? 1 : 0;
    if (a5 !== b5) return b5 - a5;

    // 2. ìŠ¹ë¥  (ìœ íš¨í•œ ê°’ì¼ ë•Œ)
    const ar = isFinite(a.monthRate) ? a.monthRate : -1;
    const br = isFinite(b.monthRate) ? b.monthRate : -1;
    if (br !== ar) return br - ar;

    // 3. ê²Œì„ íšŸìˆ˜
    if (b.games !== a.games) return b.games - a.games;

    // 4. ì´ë¦„ (ê°€ë‚˜ë‹¤ìˆœ)
    return a.name.localeCompare(b.name, 'ko');
  });
}
else if(sortMode==='games'){
      rows.sort((a,b)=> (b.games-a.games) || (b.wins-a.wins) || a.name.localeCompare(b.name,'ko'));
    }else{
      rows.sort((a,b)=> (b.weightedWins-a.weightedWins) || (b.games-a.games) || a.name.localeCompare(b.name,'ko'));
    }
    return rows;
  }

  function render(){
    // ===== ì´ë‹¬ í‘œ =====
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';
    const rows = buildRows();

    rows.forEach((r, i)=>{
      const tr = document.createElement('tr');
      const tdNo = document.createElement('td'); tdNo.textContent = (i+1).toString(); tr.appendChild(tdNo);
      const tdNm = document.createElement('td'); tdNm.className = 'name'; tdNm.textContent = r.name; tr.appendChild(tdNm);
      const tdGm = document.createElement('td'); tdGm.className='right'; tdGm.textContent = r.games.toString(); tr.appendChild(tdGm);
      const tdWP = document.createElement('td'); tdWP.className='right'; tdWP.textContent = `${fmtIntOrHalf(r.wins)}/${fmtIntOrHalf(r.losses)}`; tr.appendChild(tdWP);
      const tdPrev = document.createElement('td'); tdPrev.className='right muted'; tdPrev.textContent = pct(r.prevRate); tr.appendChild(tdPrev);
      const tdMon  = document.createElement('td'); tdMon.className='right'; tdMon.textContent  = pct(r.monthRate); tr.appendChild(tdMon);
      const tdDelta= document.createElement('td'); tdDelta.className='right';
      if(isFinite(r.delta)){ tdDelta.textContent = (r.delta>=0?'+':'') + (r.delta*100).toFixed(1) + '%p'; tdDelta.classList.add('delta', (r.delta>=0 ? 'pos' : 'neg')); }
      else { tdDelta.textContent = '-'; tdDelta.classList.add('muted'); }
      tr.appendChild(tdDelta);
      tbody.appendChild(tr);
    });

// ì „ì²´ ê²Œì„ ìˆ˜ í•©ê³„ í–‰ ì¶”ê°€
const totalGames = rows.reduce((sum, r) => sum + r.games, 0);
if (rows.length > 0) {
  const trTotal = document.createElement('tr');
  trTotal.style.fontWeight = 'bold';
  trTotal.style.background = '#f8fafc';

  const tdLabel = document.createElement('td');
  tdLabel.colSpan = 2;          // ë²ˆí˜¸ + ì´ë¦„ í•©ì¹˜ê¸°
  tdLabel.textContent = 'ì „ì²´ ê²½ê¸°ìˆ˜';
  trTotal.appendChild(tdLabel);

  const tdGames = document.createElement('td');
  tdGames.className = 'right';
  tdGames.textContent = `${totalGames} ê²Œì„`;   // ğŸ‘‰ ìˆ«ì + "ê²Œì„"
  trTotal.appendChild(tdGames);

  // ë‚˜ë¨¸ì§€ 4ì¹¸ì€ ë¹ˆì¹¸ ì²˜ë¦¬
  for (let i = 0; i < 4; i++) {
    const td = document.createElement('td');
    trTotal.appendChild(td);
  }

  tbody.appendChild(trTotal);
}



    // ===== ì´ë‹¬ ì–´ì›Œë“œ =====
    const mostGamesList = document.getElementById('mostGames');
    const topWinsList   = document.getElementById('topWins');

    if(rows.length){
      // ìµœë‹¤ê²½ê¸° TOP3
      const byGames = [...rows].sort((a,b)=> (b.games-a.games) || (b.wins-a.wins) || a.name.localeCompare(b.name,'ko'));
      mostGamesList.innerHTML = '';
      byGames.slice(0,3).forEach((p, idx)=>{
        const li = document.createElement('li');
        li.textContent = `${idx+1}ìœ„ ${p.name} Â· ${p.games}ê²½ê¸°`;
        mostGamesList.appendChild(li);
      });

      // ë‹¤ìŠ¹ TOP3
      const byWins = [...rows].sort((a,b)=> (b.weightedWins-a.weightedWins) || (b.games-a.games) || a.name.localeCompare(b.name,'ko'));
      topWinsList.innerHTML = '';
      byWins.slice(0,3).forEach((p, idx)=>{
        const li = document.createElement('li');
        const winTxt = Number.isInteger(p.weightedWins) ? p.weightedWins : p.weightedWins.toFixed(1);
        li.textContent = `${idx+1}ìœ„ ${p.name} Â· ${winTxt}ìŠ¹`;
        topWinsList.appendChild(li);
      });
     
      // ê¸°ëŸ‰ìƒìŠ¹ TOP3
const risingList = document.getElementById('risingTop3');
if (rows.length) {
  const rising = [...rows]
    .filter(r => r.games >= 15 && isFinite(r.delta))
    .sort((a,b) => b.delta - a.delta)
    .slice(0,3);

  risingList.innerHTML = '';
  if (rising.length) {
    rising.forEach((p, idx) => {
      const li = document.createElement('li');
      li.textContent = `${idx+1}ìœ„ ${p.name} Â· ${(p.delta*100).toFixed(1)}%p`;
      risingList.appendChild(li);
    });
  } else {
    const li = document.createElement('li');
    li.className = 'muted';
    li.textContent = 'í•´ë‹¹ ì—†ìŒ';
    risingList.appendChild(li);
  }
}



    }else{
      mostGamesList.innerHTML='';
      topWinsList.innerHTML='';
    }

    // ë¶€ìˆ˜ìƒí–¥ ê¶Œê³  (ì´ë‹¬)
    const upList = document.getElementById('upgradeList');
    if (upList) {
      const candidates = rows
        .filter(r => r.games >= 10 && isFinite(r.monthRate) && r.monthRate >= 0.7)
        .sort((a,b) => (b.monthRate - a.monthRate) || (b.games - a.games) || a.name.localeCompare(b.name,'ko'));

      upList.innerHTML = '';
      if (candidates.length) {
        candidates.forEach(p => {
          const li = document.createElement('li');
          li.textContent = `${p.name} Â· ìŠ¹ë¥  ${(p.monthRate*100).toFixed(0)}% / ${p.games}ê²½ê¸°`;
          upList.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.className = 'muted';
        li.textContent = 'í•´ë‹¹ ì—†ìŒ';
        upList.appendChild(li);
      }
    }

    // ===== ì§€ë‚œë‹¬ í‘œ/ì–´ì›Œë“œ =====
    const prevSection = document.getElementById('prevSection');
    const prevAwards  = document.getElementById('prevAwards');
    const prevTbody   = document.getElementById('prevTbody');

    const prevRows = Object.keys(prevMon)
      .filter(pid => prevMon[pid].games > 0)
      .map(pid => {
        const p = prevMon[pid];
        const rate = (p.gw > 0) ? (p.ww / p.gw) : NaN;
        return { pid, name: names[pid] || pid, games: p.games, wins: p.wins, losses: p.losses, rate, weightedWins: p.ww };
      });

    if (prevRows.length){
      // ì œëª© ì›” í‘œì‹œ
      const prevTitleMonth = document.getElementById('prevTitleMonth');
      if (prevTitleMonth) prevTitleMonth.textContent = titleMon(PREV_MON);

      // í‘œ ì •ë ¬(ìŠ¹ë¥  > ê²Œì„ìˆ˜ > ì´ë¦„)
      prevRows.sort((a,b)=>{
        const ar = isFinite(a.rate) ? a.rate : -1;
        const br = isFinite(b.rate) ? b.rate : -1;
        return (br-ar) || (b.games-a.games) || a.name.localeCompare(b.name,'ko');
      });

      // í‘œ ë Œë”
      prevTbody.innerHTML = '';
      prevRows.forEach((r, i)=>{
        const tr = document.createElement('tr');
        const tdNo = document.createElement('td'); tdNo.textContent = (i+1).toString(); tr.appendChild(tdNo);
        const tdNm = document.createElement('td'); tdNm.className='name'; tdNm.textContent = r.name; tr.appendChild(tdNm);
        const tdGm = document.createElement('td'); tdGm.className='right'; tdGm.textContent = r.games.toString(); tr.appendChild(tdGm);
        const tdWP = document.createElement('td'); tdWP.className='right'; tdWP.textContent = `${r.wins}/${r.losses}`; tr.appendChild(tdWP);
        const tdRt = document.createElement('td'); tdRt.className='right'; tdRt.textContent = isFinite(r.rate)? (r.rate*100).toFixed(1)+'%' : '-'; tr.appendChild(tdRt);
        prevTbody.appendChild(tr);
      });

      // ì§€ë‚œë‹¬ ì–´ì›Œë“œ: ìµœë‹¤ê²½ê¸° TOP3
      const prevMostGames = document.getElementById('prevMostGames');
      const prevTopWins   = document.getElementById('prevTopWins');
      const prevUpList    = document.getElementById('prevUpgradeList');

      const byGamesPrev = [...prevRows].sort((a,b)=> (b.games-a.games) || (b.wins-a.wins) || a.name.localeCompare(b.name,'ko'));
      prevMostGames.innerHTML = '';
      byGamesPrev.slice(0,3).forEach((p, idx)=>{
        const li = document.createElement('li');
        li.textContent = `${idx+1}ìœ„ ${p.name} Â· ${p.games}ê²½ê¸°`;
        prevMostGames.appendChild(li);
      });

      // ì§€ë‚œë‹¬ ì–´ì›Œë“œ: ë‹¤ìŠ¹ TOP3
      prevTopWins.innerHTML = '';
      const byWinsPrev = [...prevRows].sort((a,b)=> (b.weightedWins-a.weightedWins) || (b.games-a.games) || a.name.localeCompare(b.name,'ko'));
      byWinsPrev.slice(0,3).forEach((p, idx)=>{
        const li = document.createElement('li');
        const winTxt = Number.isInteger(p.weightedWins) ? p.weightedWins : p.weightedWins.toFixed(1);
        li.textContent = `${idx+1}ìœ„ ${p.name} Â· ${winTxt}ìŠ¹`;
        prevTopWins.appendChild(li);
      });

      // ì§€ë‚œë‹¬ ë¶€ìˆ˜ìƒí–¥ ê¶Œê³ 
      prevUpList.innerHTML = '';
      const prevCandidates = prevRows
        .filter(r => r.games >= 10 && isFinite(r.rate) && r.rate >= 0.7)
        .sort((a,b)=> (b.rate - a.rate) || (b.games - a.games) || a.name.localeCompare(b.name,'ko'));
      if(prevCandidates.length){
        prevCandidates.forEach(p=>{
          const li = document.createElement('li');
          li.textContent = `${p.name} Â· ìŠ¹ë¥  ${(p.rate*100).toFixed(0)}% / ${p.games}ê²½ê¸°`;
          prevUpList.appendChild(li);
        });
      }else{
        const li = document.createElement('li');
        li.className = 'muted';
        li.textContent = 'í•´ë‹¹ ì—†ìŒ';
        prevUpList.appendChild(li);
      }

      // ì„¹ì…˜ ë³´ì´ê¸°
      prevSection.style.display = '';
      prevAwards.style.display  = '';
    }else{
      prevSection.style.display = 'none';
      prevAwards.style.display  = 'none';
    }
  }

  // ===== ì „ì „ë‹¬ ì´ì „ ë°ì´í„° ìë™ ì •ë¦¬(ì´ë‹¬+ì§€ë‚œë‹¬ë§Œ ìœ ì§€) =====
  const realNowKST   = toKST();
  const REAL_CUR_MON = `${realNowKST.getFullYear()}-${pad(realNowKST.getMonth()+1)}`;
  const REAL_PREV_MON= prevMonthKey(REAL_CUR_MON);

  async function pruneOld(all){
    const removals = [];
    Object.entries(all || {}).forEach(([key, m])=>{
      const ts  = isNum(m.ts) ? m.ts : (isNum(m.createdAt) ? m.createdAt : NaN);
      const mon = m.monthKey || (isFinite(ts) ? monthKeyFromTs(ts) : null);
      if(!mon) return;
      // REAL_PREV_MON ë³´ë‹¤ ì´ì „(ì „ì „ë‹¬ í¬í•¨ ê·¸ ì´ì „) ë°ì´í„° ì‚­ì œ
      if (mon < REAL_PREV_MON) removals.push(key);
    });
    if (!removals.length) return;
    try{
      await Promise.all(removals.map(id => remove(ref(db, 'matches/'+id))));
      console.log('[prune] removed old months:', removals.length);
    }catch(e){
      console.error('[prune] failed:', e);
    }
  }

  // ì‹¤ì‹œê°„ êµ¬ë…
  onAuthStateChanged(auth, (user)=>{
    if(!user) return;
    onValue(ref(db,'matches'), async (snap)=>{
      const all = snap.val() || {};
      window.lastAll = all;
      rebuild(all);
      render();
      await pruneOld(all);
    }, (err)=>{ console.error(err); });
  });

  // ë¡œê·¸ì¸
  signInAnonymously(auth).catch(e=>{ console.error(e); });

  // ================== ì´ë¯¸ì§€ ì €ì¥ ==================
  function downloadDataUrl(filename, dataUrl){
    const a = document.createElement('a');
    a.href = dataUrl; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
  }
  async function saveCaptureAsImage(){
    const area = document.getElementById('captureArea');
    if(!area){ alert('ìº¡ì²˜ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
    area.classList.add('capture-ready');
    const scale = Math.min(window.devicePixelRatio || 1, 2);
    if(!window.html2canvas){
      alert('ì´ë¯¸ì§€ ëª¨ë“ˆ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      area.classList.remove('capture-ready'); return;
    }
    const canvas = await window.html2canvas(area, { backgroundColor:'#ffffff', scale, useCORS:true, windowWidth:document.documentElement.clientWidth });
    area.classList.remove('capture-ready');
    const dataUrl = canvas.toDataURL('image/png');
    const fname = `KOEN_ì›”ê°„ë¦¬ê·¸_${CUR_MON}.png`;
    downloadDataUrl(fname, dataUrl);
  }
  const saveBtn = document.getElementById('saveImage');
  if(saveBtn) saveBtn.addEventListener('click', saveCaptureAsImage);
</script>
</body>
</html>
