<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>⭐KOEN 탁구 월간리그</title>
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --card:#fff; --bg:#f5f7fb;
      --primary:#0d47a1; --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
      --shadow:0 8px 28px rgba(0,0,0,.08)
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; color:var(--ink); background:var(--bg)}
    header{position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #e5e7eb}
    .wrap{max-width:1040px; margin:0 auto; padding:14px 16px}
    h1{margin:4px 0 6px; font-size:clamp(18px,4vw,24px); color:var(--primary)}
    main{max-width:1040px; margin:16px auto; padding:0 16px 28px}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{border:1px solid #d1d5db; border-radius:10px; padding:8px 12px; font-size:14px; background:#fff; cursor:pointer}
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
    .card{background:var(--card); border:1px solid #e5e7eb; border-radius:16px; padding:14px; box-shadow:var(--shadow); margin:12px 0}

    table{width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; table-layout: fixed;}
    thead th{background:#f8fafc; border-bottom:1px solid #e5e7eb; padding:8px 10px; font-size:14px; color:#334155}
    tbody td{border-bottom:1px solid #f1f5f9; padding:8px 10px; font-size:14px; line-height:1.25; white-space: nowrap}
    tbody tr:hover{background:#fafafa}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .delta.pos{color:var(--ok); font-weight:600}
    .delta.neg{color:var(--danger); font-weight:600}
    .awards{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px}
    .award{border:1px dashed #d1d5db; border-radius:14px; padding:12px}
    .award b{font-size:16px}
    .small{font-size:12px}
    ol.rank{list-style:none; margin:6px 0 0; padding:0}
    thead th, tbody td{text-align:center}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <h1>⭐탁구 월간리그 <span id="titleMonth" class="muted"></span></h1>
      <a class="btn primary" href="./">전적입력</a>
    </div>
    <div class="row">
      <button id="sortWinrate" class="btn primary">승률</button>
      <button id="sortGames" class="btn">최다경기</button>
      <button id="sortWins" class="btn">다승</button>
      <button id="saveImage" class="btn">이미지 저장</button>
    </div>
  </div>
</header>

<main>
  <div id="captureArea">
    <!-- 이번달 전적 -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <div id="thisMonthTitle" style="font-weight:700">이달의 전적</div>
        <div class="muted small">이전 승률 = 지난달, 이달 승률 = 이번달</div>
      </div>
      <div style="overflow:auto; margin-top:8px">
        <table>
          <thead>
            <tr>
              <th>번호</th><th>이름</th><th>게임횟수</th>
              <th>승/패</th><th>이전승률</th><th>이달승률</th><th>승률증감</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- 이번달 어워드 -->
    <section class="card">
      <div class="awards">
        <div class="award"><b>최다경기 TOP3</b><ol id="mostGames" class="rank"></ol></div>
        <div class="award"><b>다승 TOP3</b><ol id="topWins" class="rank"></ol></div>
        <div class="award"><b>기량상승 TOP3</b><ol id="risingTop3" class="rank"></ol></div>
        <div class="award"><b>부수상향 권고</b><ul id="upgradeList"></ul></div>
      </div>
    </section>

    <!-- 지난달 전적 -->
    <section id="prevSection" class="card" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div id="prevTitle" style="font-weight:700">지난달 전적</div>
      </div>
      <div style="overflow:auto; margin-top:8px">
        <table>
          <thead>
            <tr>
              <th>번호</th><th>이름</th><th>게임횟수</th><th>승/패</th><th>승률</th>
            </tr>
          </thead>
          <tbody id="prevTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- 지난달 어워드 -->
    <section id="prevAwards" class="card" style="display:none">
      <div class="awards">
        <div class="award"><b>지난달 최다경기 TOP3</b><ol id="prevMostGames" class="rank"></ol></div>
        <div class="award"><b>지난달 다승 TOP3</b><ol id="prevTopWins" class="rank"></ol></div>
        <div class="award"><b>지난달 부수상향 권고</b><ul id="prevUpgradeList"></ul></div>
      </div>
    </section>
  </div>
</main>

<!-- html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  // ===== Firebase 설정 =====
  const firebaseConfig = {
    apiKey: "AIzaSyC5iq3VY0QtBh8FVn70gi_Gsg7GXzkxdu8",
    authDomain: "koen-pingpong.firebaseapp.com",
    databaseURL: "https://koen-pingpong-default-rtdb.firebaseio.com",
    projectId: "koen-pingpong",
    storageBucket: "koen-pingpong.appspot.com",
    messagingSenderId: "597358811982",
    appId: "1:597358811982:web:b66dcb6a7159fb5f321c1f"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // ===== 월 키 계산 =====
  const pad = (n)=> String(n).padStart(2,'0');
  const toKST = (t=Date.now())=> new Date(new Date(t).toLocaleString('en-US',{timeZone:'Asia/Seoul'}));
  function prevMonthKey(key){ const [y,m]=key.split('-').map(Number); return `${new Date(y,m-2,1).getFullYear()}-${pad(new Date(y,m-2,1).getMonth()+1)}`;}
  function titleMon(key){ const [y,m]=key.split('-').map(Number); return `'${String(y).slice(-2)}.${pad(m)}`;}
  function monthKeyFromTs(ts){ const d=new Date(ts); return `${d.getFullYear()}-${pad(d.getMonth()+1)}`; }
  function pct(v){ return isFinite(v) ? (v*100).toFixed(1)+'%' : '-'; }

  const nowKST = toKST();
  const CUR_MON = `${nowKST.getFullYear()}-${pad(nowKST.getMonth()+1)}`;
  const PREV_MON = prevMonthKey(CUR_MON);

  document.getElementById('titleMonth').textContent = `(${titleMon(CUR_MON)})`;
  document.getElementById('thisMonthTitle').textContent = `이달(${titleMon(CUR_MON)})의 전적`;
  document.getElementById('prevTitle').textContent = `지난달(${titleMon(PREV_MON)})의 전적`;

  // ===== 데이터 저장소 =====
  let thisMon = {}, prevMon = {}, names = {};

  function rebuild(all){
    thisMon={}; prevMon={};
    Object.entries(all).forEach(([id,m])=>{
      const ts=m.ts||m.createdAt; if(!ts) return;
      const monKey=monthKeyFromTs(ts);
      const pid=m.pid||m.player||'unknown';
      if(!names[pid]) names[pid]=m.name||pid;
      let target;
      if(monKey===CUR_MON) target=thisMon;
      else if(monKey===PREV_MON) target=prevMon;
      else return;
      if(!target[pid]) target[pid]={games:0,wins:0,losses:0,ww:0,gw:0};
      target[pid].games++;
      if(m.result==='W'){target[pid].wins++; target[pid].ww++;}
      else if(m.result==='L'){target[pid].losses++;}
      target[pid].gw++;
    });
  }

  function buildRows(){
    const rows=[];
    Object.keys(thisMon).forEach(pid=>{
      const p=thisMon[pid];
      const prev=prevMon[pid]||{ww:0,gw:0};
      const prevRate=prev.gw>0?prev.ww/prev.gw:NaN;
      const monthRate=p.gw>0?p.ww/p.gw:NaN;
      const delta=(isFinite(prevRate)&&isFinite(monthRate))?(monthRate-prevRate):NaN;
      rows.push({pid,name:names[pid]||pid,games:p.games,wins:p.wins,losses:p.losses,prevRate,monthRate,delta,weightedWins:p.ww});
    });
    return rows;
  }

  function render(){
    // --- 이번달 표 ---
    const tbody=document.getElementById('tbody');
    tbody.innerHTML='';
    const rows=buildRows();

    rows.forEach((r,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${i+1}</td><td>${r.name}</td>
        <td class="right">${r.games}</td>
        <td class="right">${r.wins}/${r.losses}</td>
        <td class="right muted">${pct(r.prevRate)}</td>
        <td class="right">${pct(r.monthRate)}</td>
        <td class="right ${isFinite(r.delta)?(r.delta>=0?'delta pos':'delta neg'):'muted'}">
          ${isFinite(r.delta)?(r.delta>=0?'+':'')+(r.delta*100).toFixed(1)+'%p':'-'}
        </td>`;
      tbody.appendChild(tr);
    });

    // 전체 경기수
    const totalGames=rows.reduce((s,r)=>s+r.games,0);
    if(rows.length){
      const tr=document.createElement('tr');
      tr.style.fontWeight='bold'; tr.style.background='#f8fafc';
      tr.innerHTML=`<td colspan="3">전체 경기수</td><td class="right">${totalGames} 게임</td><td></td><td></td><td></td>`;
      tbody.appendChild(tr);
    }

    // --- 이번달 어워드 ---
    const mostGames=document.getElementById('mostGames');
    const topWins=document.getElementById('topWins');
    const rising=document.getElementById('risingTop3');
    mostGames.innerHTML=topWins.innerHTML=rising.innerHTML='';

    [...rows].sort((a,b)=>b.games-a.games).slice(0,3).forEach((p,idx)=>{
      mostGames.innerHTML+=`<li>${idx+1}위 ${p.name} · ${p.games}경기</li>`;
    });
    [...rows].sort((a,b)=>b.weightedWins-a.weightedWins).slice(0,3).forEach((p,idx)=>{
      topWins.innerHTML+=`<li>${idx+1}위 ${p.name} · ${p.weightedWins}승</li>`;
    });
    const risingRows=[...rows].filter(r=>r.games>=15 && isFinite(r.delta)).sort((a,b)=>b.delta-a.delta).slice(0,3);
    if(risingRows.length){
      risingRows.forEach((p,idx)=>{ rising.innerHTML+=`<li>${idx+1}위 ${p.name} · ${(p.delta*100).toFixed(1)}%p</li>`; });
    } else rising.innerHTML='<li class="muted">해당 없음</li>';

    // --- 지난달 표 ---
    const prevSection=document.getElementById('prevSection');
    const prevAwards=document.getElementById('prevAwards');
    const prevTbody=document.getElementById('prevTbody');
    const prevRows=Object.keys(prevMon).map(pid=>{
      const p=prevMon[pid];
      const rate=p.gw>0?p.ww/p.gw:NaN;
      return {pid,name:names[pid]||pid,games:p.games,wins:p.wins,losses:p.losses,rate,weightedWins:p.ww};
    });

    if(prevRows.length){
      prevSection.style.display=prevAwards.style.display='';
      prevTbody.innerHTML='';
      prevRows.forEach((r,i)=>{
        prevTbody.innerHTML+=`
          <tr><td>${i+1}</td><td>${r.name}</td>
          <td class="right">${r.games}</td><td class="right">${r.wins}/${r.losses}</td>
          <td class="right">${isFinite(r.rate)?(r.rate*100).toFixed(1)+'%':'-'}</td></tr>`;
      });
      const totalPrev=prevRows.reduce((s,r)=>s+r.games,0);
      prevTbody.innerHTML+=`<tr style="font-weight:bold;background:#f8fafc"><td colspan="2">전체 경기수</td><td class="right">${totalPrev} 게임</td><td></td><td></td></tr>`;
      // 어워드(지난달)
      const pm=document.getElementById('prevMostGames');
      const pw=document.getElementById('prevTopWins');
      const pu=document.getElementById('prevUpgradeList');
      pm.innerHTML=pw.innerHTML=pu.innerHTML='';
      [...prevRows].sort((a,b)=>b.games-a.games).slice(0,3).forEach((p,idx)=>{ pm.innerHTML+=`<li>${idx+1}위 ${p.name} · ${p.games}경기</li>`; });
      [...prevRows].sort((a,b)=>b.weightedWins-a.weightedWins).slice(0,3).forEach((p,idx)=>{ pw.innerHTML+=`<li>${idx+1}위 ${p.name} · ${p.weightedWins}승</li>`; });
      const candidates=prevRows.filter(r=>r.games>=10 && isFinite(r.rate) && r.rate>=0.7);
      if(candidates.length){ candidates.forEach(p=>{ pu.innerHTML+=`<li>${p.name} · 승률 ${(p.rate*100).toFixed(0)}% / ${p.games}경기</li>`; }); }
      else pu.innerHTML='<li class="muted">해당 없음</li>';
    } else { prevSection.style.display=prevAwards.style.display='none'; }
  }

  // 데이터 구독
  onAuthStateChanged(auth,(user)=>{
    if(!user) return;
    onValue(ref(db,'matches'),(snap)=>{
      const all=snap.val()||{}; rebuild(all); render();
    });
  });
  signInAnonymously(auth).catch(e=>console.error(e));

  // 이미지 저장
  async function saveCaptureAsImage(){
    const area=document.getElementById('captureArea'); if(!area) return;
    const scale=Math.min(window.devicePixelRatio||1,2);
    const canvas=await window.html2canvas(area,{backgroundColor:'#fff',scale});
    const dataUrl=canvas.toDataURL('image/png');
    const a=document.createElement('a'); a.href=dataUrl; a.download=`KOEN_월간리그_${CUR_MON}.png`; a.click();
  }
  document.getElementById('saveImage').onclick=saveCaptureAsImage;
</script>
</body>
</html>
