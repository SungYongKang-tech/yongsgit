<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>KOEN íƒêµ¬ ì„±ì  í™•ì¸í‘œ</title>
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --card:#fff; --bg:#f5f7fb;
      --primary:#0d47a1; --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
      --shadow:0 8px 28px rgba(0,0,0,.08)
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; color:var(--ink); background:var(--bg)}
    header{position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #e5e7eb}
    .wrap{max-width:1040px; margin:0 auto; padding:14px 16px}
    h1{margin:4px 0 6px; font-size:clamp(18px,4vw,24px); color:var(--primary)}
    main{max-width:1040px; margin:16px auto; padding:0 16px 28px}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{border:1px solid #d1d5db; border-radius:10px; padding:8px 12px; font-size:14px; background:#fff; cursor:pointer}
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
    .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#eef2ff; border:1px solid #d1d5db; border-radius:999px; font-size:13px}
    .card{background:var(--card); border:1px solid #e5e7eb; border-radius:16px; padding:14px; box-shadow:var(--shadow); margin:12px 0}

    table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:12px;
      overflow:hidden;
      table-layout: fixed;
    }
    thead th{background:#f8fafc; border-bottom:1px solid #e5e7eb; padding:8px 10px; font-size:14px; color:#334155; text-align:left}
    tbody td{
      border-bottom:1px solid #f1f5f9;
      padding:8px 10px;
      font-size:14px;
      line-height:1.25;
      white-space: nowrap;
    }
    tbody tr:hover{background:#fafafa}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .delta.pos{color:var(--ok); font-weight:600}
    .delta.neg{color:var(--danger); font-weight:600}
    .awards{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px}
    .award{border:1px dashed #d1d5db; border-radius:14px; padding:12px}
    .award b{font-size:16px}
    .small{font-size:12px}

    /* í‘œ ì»¬ëŸ¼ í­ */
    table col.col-no    { width: 24px; }
    table col.col-name  { width: 96px; }
    table col.col-games { width: 48px; }
    table col.col-wp    { width: 48px; }
    table col.col-prev  { width: 48px; }
    table col.col-month { width: 48px; }
    table col.col-delta { width: 48px; }

    @media (max-width: 640px){
      table col.col-name { width: 42%; }
      thead th, tbody td { padding: 6px 8px; }
    }
    @media (max-width: 640px){
      table col.col-name { width: 38%; }
      tbody td, thead th { padding: 8px; }
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <h1 style="margin-right:auto">KOEN íƒêµ¬ Â· ì´ë²ˆë‹¬ ì„±ì  í™•ì¸í‘œ</h1>
      <a class="btn primary" href="./" title="ì„±ì ì…ë ¥ìœ¼ë¡œ ëŒì•„ê°€ê¸°">â† ì„±ì ì…ë ¥</a>
    </div>
    <div class="row">
      <span id="monthBadge" class="badge">ì´ë²ˆë‹¬: -</span>
      <span id="lastUpdate" class="badge">ì‹¤ì‹œê°„ ì—°ê²°: ëŒ€ê¸°ì¤‘</span>
      <button id="sortWinrate" class="btn primary">ì •ë ¬: ìŠ¹ë¥ </button>
      <button id="sortGames" class="btn">ì •ë ¬: ìµœë‹¤ê²½ê¸°</button>
      <button id="sortWins" class="btn">ì •ë ¬: ë‹¤ìŠ¹</button>
     <!-- <span id="dwNote" class="small muted">â€» ë³µì‹ì€ ìŠ¹ë¥  ê³„ì‚°ì— 0.5ë°° ë°˜ì˜ë©ë‹ˆë‹¤.</span>-->
    </div>
  </div>
</header>

<main>
  <section class="card">
    <div class="awards">
      <div class="award">
        <div class="muted small">ì–´ì›Œë“œ</div>
        <b>ìµœë‹¤ê²½ê¸°ì™•</b>
        <div id="mostGames" style="margin-top:6px">-</div>
      </div>
      <div class="award">
        <div class="muted small">ì–´ì›Œë“œ</div>
        <b>ë‹¤ìŠ¹ TOP3</b>
        <ol id="topWins" style="margin:6px 0 0 18px; padding:0"></ol>
      </div>
      <div class="award">
        <div class="muted small">ì–´ì›Œë“œ</div>
        <b>ë¶€ìˆ˜ìƒí–¥ ê¶Œê³ </b>
        <ul id="upgradeList" style="margin:6px 0 0 18px; padding:0"></ul>
        <div class="small muted">(ì¡°ê±´: ì´ë²ˆë‹¬ 10ê²½ê¸° ì´ìƒ, ìŠ¹ë¥  â‰¥ 70%)</div>
</div>

    </div>
  </section>

  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div style="font-weight:700">ì„ ìˆ˜ë³„ ìƒì„¸(ì´ë²ˆë‹¬)</div>
      <div class="muted small">ì´ì „ ìŠ¹ë¥  = ì „ì›” ì´ì „ ëˆ„ì , ì´ë‹¬ ìŠ¹ë¥  = ì´ë²ˆë‹¬, ìŠ¹ë¥  ì¦ê° = ì´ë‹¬ âˆ’ ì´ì „</div>
    </div>
    <div style="overflow:auto; margin-top:8px">
      <table>
        <colgroup>
          <col class="col-no" />
          <col class="col-name" />
          <col class="col-games" />
          <col class="col-wp" />
          <col class="col-prev" />
          <col class="col-month" />
          <col class="col-delta" />
        </colgroup>
        <thead>
          <tr>
            <th>ë²ˆí˜¸</th>
            <th>ì´ë¦„</th>
            <th class="right">ê²Œì„ìˆ˜</th>
            <th class="right">ìŠ¹/íŒ¨</th>
            <th class="right">ì´ì „ ìŠ¹ë¥ </th>
            <th class="right">ì´ë‹¬ ìŠ¹ë¥ </th>
            <th class="right">ìŠ¹ë¥  ì¦ê°</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  // ========== Firebase ==========
  const firebaseConfig = {
    apiKey: "AIzaSyC5iq3VY0QtBh8FVn70gi_Gsg7GXzkxdu8",
    authDomain: "koen-pingpong.firebaseapp.com",
    databaseURL: "https://koen-pingpong-default-rtdb.firebaseio.com",
    projectId: "koen-pingpong",
    storageBucket: "koen-pingpong.appspot.com",
    messagingSenderId: "597358811982",
    appId: "1:597358811982:web:b66dcb6a7159fb5f321c1f"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // === ë³µì‹ ê°€ì¤‘ì¹˜ ì‹¤ì‹œê°„ êµ¬ë… ===
  let DOUBLE_WEIGHT = 0.5;
  onValue(ref(db, 'config/doubleWeight'), (s) => {
    const v = parseFloat(s.val());
    DOUBLE_WEIGHT = (isFinite(v) ? v : 0.5);

    // ì´ë¯¸ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¬ì§‘ê³„
    if (window.lastAll) { rebuild(window.lastAll); render(); }

    const note = document.getElementById('dwNote');
    if (note) note.textContent = `â€» ë³µì‹ì€ ìŠ¹ë¥  ê³„ì‚°ì— ${DOUBLE_WEIGHT}ë°° ë°˜ì˜ë©ë‹ˆë‹¤.`;
  });

  // === ì‹¤ë ¥ì°¨ ë³´ì • ì„¤ì • êµ¬ë… (perLevel, minFav, maxDog) ===
  let SKILL = { perLevel: 0.05, minFav: 0.6, maxDog: 1.8 };
  onValue(ref(db, 'config/skillAdjust'), (s) => {
    const v = s.val();
    if (v && typeof v === 'object') {
      SKILL = {
        perLevel: Number(v.perLevel ?? 0.05),
        minFav:   Number(v.minFav   ?? 0.6 ),
        maxDog:   Number(v.maxDog   ?? 1.8 )
      };
      if (window.lastAll) { rebuild(window.lastAll); render(); }
    }
  });

  // ========== KST ê¸°ì¤€ ì›” í‚¤ ==========
  const pad = (n)=> String(n).padStart(2,'0');
  const toKST = (t = Date.now()) => new Date(
    new Date(t).toLocaleString('en-US', { timeZone: 'Asia/Seoul' })
  );
  function monthKeyFromTs(ts){
    const d = toKST(ts);
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
  }
  const qs = new URLSearchParams(location.search);
  const monOverride = qs.get('mon'); // 'YYYY-MM' or null
  const nowKST = toKST();
  const CUR_MON = monOverride && /^\d{4}-\d{2}$/.test(monOverride) ? monOverride
                : `${nowKST.getFullYear()}-${pad(nowKST.getMonth()+1)}`;
  document.getElementById('monthBadge').textContent = `ì´ë²ˆë‹¬: ${CUR_MON}`;

  // ========== ì •ë ¬ ìƒíƒœ ==========
  let sortMode = 'winrate';
  const toggleSortButtons = ()=>{
    document.getElementById('sortWinrate').classList.toggle('primary', sortMode==='winrate');
    document.getElementById('sortGames').classList.toggle('primary', sortMode==='games');
    document.getElementById('sortWins').classList.toggle('primary', sortMode==='wins');
  };
  document.getElementById('sortWinrate').onclick = ()=>{ sortMode='winrate'; render(); toggleSortButtons(); };
  document.getElementById('sortGames').onclick   = ()=>{ sortMode='games';   render(); toggleSortButtons(); };
  document.getElementById('sortWins').onclick    = ()=>{ sortMode='wins';    render(); toggleSortButtons(); };
  toggleSortButtons();

  // ========== ìœ í‹¸ ==========
  const slugify = (s)=> s?.toString().replace(/[()]/g,'').replace(/\s+/g,'-').replace(/[^\p{L}\p{N}-]/gu,'').toLowerCase();
  const pct = (v)=> isFinite(v) ? (v*100).toFixed(1)+'%' : '-';
  const fmtIntOrHalf = (n)=> Number.isInteger(n) ? n.toString() : n.toFixed(1);
  const isNum = (v)=> typeof v === 'number' && isFinite(v);
  const lastBadge = document.getElementById('lastUpdate');

  // === ë³´ì • í•¨ìˆ˜/ëŒ€í‘œ ë ˆë²¨ ===
  const clamp = (min, x, max) => Math.max(min, Math.min(max, x));
  function getAdjustedWeight(levelA, levelB, winner){
    const la = (levelA ?? 99), lb = (levelB ?? 99);
    const d = Math.abs(la - lb);
    const aIsFav = la < lb; // ìˆ«ì ì‘ì„ìˆ˜ë¡ ìƒìœ„
    const favWin = clamp(SKILL.minFav, 1 - SKILL.perLevel * d, 1);
    const dogWin = clamp(1,            1 + SKILL.perLevel * d, SKILL.maxDog);
    if (winner === 'A') return aIsFav ? favWin : dogWin;
    const bIsFav = lb < la;
    return bIsFav ? favWin : dogWin;
  }
  function repLevel(levels, type){
    if (!Array.isArray(levels) || !levels.length) return null;
    if (type === 'single') return levels[0] ?? null;
    return Math.min(...levels.map(v => (v == null ? 99 : v)));
  }

  // ========== ì§‘ê³„ ìƒíƒœ ==========
  const names = {};                 // pid -> ìµœì‹  ì´ë¦„
  const prev  = {};                 // pid -> {gw, ww}
  const mon   = {};                 // pid -> {games, wins, losses, gw, ww}
  function ensurePrev(pid){ if(!prev[pid]) prev[pid] = {gw:0, ww:0}; }
  function ensureMon(pid){ if(!mon[pid])  mon[pid]  = {games:0, wins:0, losses:0, gw:0, ww:0}; }

  // ê²½ê¸° 1ê±´ì„ ì§‘ê³„ì— ë°˜ì˜
  function addMatch(bucket, m){
    // íƒ€ì… íŒë³„
    let type = m.type;
    if (!type) {
      const la = (m.membersA?.length || 0), lb = (m.membersB?.length || 0);
      type = (la >= 2 || lb >= 2) ? 'double' : 'single';
    }

    // ğŸ” ê°€ì¤‘ì¹˜ ê²°ì •: 1) ê¸°ë¡ëœ finalWeight ìš°ì„ , 2) ì—†ìœ¼ë©´ ì‹¤ì‹œê°„ ì„¤ì •ìœ¼ë¡œ ì¬ê³„ì‚°
    let weight;
    if (m?.weights && typeof m.weights.finalWeight === 'number' && isFinite(m.weights.finalWeight)) {
      weight = Number(m.weights.finalWeight);
    } else {
      const rA = repLevel(m.levelsA, type);
      const rB = repLevel(m.levelsB, type);
      const skillW = (rA != null && rB != null && (m.winnerSide === 'A' || m.winnerSide === 'B'))
        ? getAdjustedWeight(rA, rB, m.winnerSide)
        : 1;
      const dblW = (type === 'double') ? DOUBLE_WEIGHT : 1;
      weight = skillW * dblW;
    }

    // A/B ëª…ë‹¨ (id, name)
    const sideA = (m.membersA && m.membersA.length ? m.membersA.map((pid,i)=>[pid, m.namesA?.[i]]) :
                  (m.namesA && m.namesA.length ? m.namesA.map((nm)=>[slugify(nm), nm]) : []));
    const sideB = (m.membersB && m.membersB.length ? m.membersB.map((pid,i)=>[pid, m.namesB?.[i]]) :
                  (m.namesB && m.namesB.length ? m.namesB.map((nm)=>[slugify(nm), nm]) : []));
    const winA = m.winnerSide === 'A';
    const winB = m.winnerSide === 'B';

    if(bucket === 'month'){
      sideA.forEach(([pid, nm])=>{
        ensureMon(pid); if(nm) names[pid]=nm;
        mon[pid].games  += 1;                 // ê²Œì„ìˆ˜(í‘œì‹œìš©)ëŠ” 1ì”©
        mon[pid].wins   += (winA?1:0);
        mon[pid].losses += (winB?1:0);
        mon[pid].gw     += weight;            // ìŠ¹ë¥  ë¶„ëª¨(ê°€ì¤‘ ê²Œì„ìˆ˜)
        mon[pid].ww     += (winA?weight:0);   // ìŠ¹(ê°€ì¤‘)
      });
      sideB.forEach(([pid, nm])=>{
        ensureMon(pid); if(nm) names[pid]=nm;
        mon[pid].games  += 1;
        mon[pid].wins   += (winB?1:0);
        mon[pid].losses += (winA?1:0);
        mon[pid].gw     += weight;
        mon[pid].ww     += (winB?weight:0);
      });
    }else{ // ì´ì „ ëˆ„ì 
      sideA.forEach(([pid, nm])=>{
        ensurePrev(pid); if(nm) names[pid]=nm;
        prev[pid].gw += weight;
        prev[pid].ww += (winA?weight:0);
      });
      sideB.forEach(([pid, nm])=>{
        ensurePrev(pid); if(nm) names[pid]=nm;
        prev[pid].gw += weight;
        prev[pid].ww += (winB?weight:0);
      });
    }
  }

  // ì „ì²´ ìŠ¤ëƒ…ìƒ·ì„ KST ì›” ê¸°ì¤€ìœ¼ë¡œ ì¬ì§‘ê³„
  function rebuild(all){
    for(const k in prev) delete prev[k];
    for(const k in mon)  delete mon[k];

    Object.values(all || {}).forEach((m)=>{
      const ts = isNum(m.ts) ? m.ts : (isNum(m.createdAt) ? m.createdAt : NaN);
      const key = m.monthKey || (isFinite(ts) ? monthKeyFromTs(ts) : null);
      if(!key) return;

      if(key === CUR_MON){
        addMatch('month', m);
      }else if(key < CUR_MON){
        addMatch('prev', m);
      }
    });
  }

  // ë Œë” ë°ì´í„° êµ¬ì„±
  function buildRows(){
    const pids = Object.keys(mon).filter(pid=> mon[pid].games>0);
    const rows = pids.map(pid=>{
      const m = mon[pid], p = prev[pid] || {gw:0, ww:0};
      const prevRate  = (p.gw>0) ? (p.ww/p.gw) : NaN;
      const monthRate = (m.gw>0) ? (m.ww/m.gw) : NaN;
      const delta = (isFinite(prevRate) && isFinite(monthRate)) ? (monthRate - prevRate) : NaN;
      return {
        pid, name: names[pid] || pid,
        games: m.games, wins: m.wins, losses: m.losses,
        prevRate, monthRate, delta,
        weightedWins: m.ww
      };
    });

    if(sortMode==='winrate'){
      rows.sort((a,b)=>{
        const ar = isFinite(a.monthRate) ? a.monthRate : -1;
        const br = isFinite(b.monthRate) ? b.monthRate : -1;
        if(br!==ar) return br - ar;
        if(b.games!==a.games) return b.games - a.games;
        return a.name.localeCompare(b.name,'ko');
      });
    }else if(sortMode==='games'){
      rows.sort((a,b)=> (b.games - a.games) || (b.wins - a.wins) || a.name.localeCompare(b.name,'ko'));
    }else{
      rows.sort((a,b)=> (b.weightedWins - a.weightedWins) || (b.games - a.games) || a.name.localeCompare(b.name,'ko'));
    }

    return rows;
  }

  // ë Œë”
  function render(){
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  const rows = buildRows();

  // í‘œ ë Œë”
  rows.forEach((r, i)=>{
    const tr = document.createElement('tr');

    const tdNo = document.createElement('td');
    tdNo.textContent = (i+1).toString();
    tr.appendChild(tdNo);

    const tdNm = document.createElement('td');
    tdNm.className = 'name';
    tdNm.textContent = r.name;
    tr.appendChild(tdNm);

    const tdGm = document.createElement('td');
    tdGm.className='right';
    tdGm.textContent = r.games.toString();
    tr.appendChild(tdGm);

    const tdWP = document.createElement('td');
    tdWP.className='right';
    tdWP.textContent = `${fmtIntOrHalf(r.wins)}/${fmtIntOrHalf(r.losses)}`;
    tr.appendChild(tdWP);

    const tdPrev = document.createElement('td');
    tdPrev.className='right muted';
    tdPrev.textContent = pct(r.prevRate);
    tr.appendChild(tdPrev);

    const tdMon  = document.createElement('td');
    tdMon.className='right';
    tdMon.textContent  = pct(r.monthRate);
    tr.appendChild(tdMon);

    const tdDelta= document.createElement('td');
    tdDelta.className='right';
    if(isFinite(r.delta)){
      tdDelta.textContent = (r.delta>=0?'+':'') + (r.delta*100).toFixed(1) + '%p';
      tdDelta.classList.add('delta', (r.delta>=0 ? 'pos' : 'neg'));
    }else{
      tdDelta.textContent = '-';
      tdDelta.classList.add('muted');
    }
    tr.appendChild(tdDelta);

    tbody.appendChild(tr);
  });

  // ê¸°ì¡´ ì–´ì›Œë“œ: ìµœë‹¤ê²½ê¸°ì™• / ë‹¤ìŠ¹ TOP3
  const mostGamesBox = document.getElementById('mostGames');
  const topWinsList  = document.getElementById('topWins');

  if(rows.length){
    const byGames = [...rows].sort((a,b)=> (b.games-a.games) || (b.wins-a.wins) || a.name.localeCompare(b.name,'ko'));
    mostGamesBox.textContent = `${byGames[0].name} Â· ${byGames[0].games}ê²½ê¸°`;

    const byWins = [...rows].sort((a,b)=> (b.weightedWins-a.weightedWins) || (b.games-a.games) || a.name.localeCompare(b.name,'ko'));
    topWinsList.innerHTML = '';
    byWins.slice(0,3).forEach((p, idx)=>{
      const li = document.createElement('li');
      const winTxt = Number.isInteger(p.weightedWins) ? p.weightedWins : p.weightedWins.toFixed(1);
      li.textContent = `${idx+1}ìœ„ ${p.name} Â· ${winTxt}ìŠ¹`;
      topWinsList.appendChild(li);
    });
  }else{
    mostGamesBox.textContent='-';
    topWinsList.innerHTML='';
  }

  // âœ… ìƒˆ ì–´ì›Œë“œ: ë¶€ìˆ˜ìƒí–¥ ê¶Œê³  (10ê²½ê¸° ì´ìƒ & ìŠ¹ë¥  70% ì´ìƒ)
  const upList = document.getElementById('upgradeList');
  if (upList) {
    const candidates = rows
      .filter(r => r.games >= 10 && isFinite(r.monthRate) && r.monthRate >= 0.7)
      .sort((a,b) =>
        (b.monthRate - a.monthRate) || (b.games - a.games) || a.name.localeCompare(b.name,'ko')
      );

    upList.innerHTML = '';
    if (candidates.length) {
      candidates.forEach(p => {
        const li = document.createElement('li');
        li.textContent = `${p.name} Â· ìŠ¹ë¥  ${(p.monthRate*100).toFixed(0)}% / ${p.games}ê²½ê¸°`;
        upList.appendChild(li);
      });
    } else {
      const li = document.createElement('li');
      li.className = 'muted';
      li.textContent = 'í•´ë‹¹ ì—†ìŒ';
      upList.appendChild(li);
    }
  }
}


  // ========== ì‹¤ì‹œê°„ êµ¬ë… ==========
  onAuthStateChanged(auth, (user)=>{
    if(!user) return;
    const lastBadge = document.getElementById('lastUpdate');
    lastBadge.textContent = 'ì‹¤ì‹œê°„ ì—°ê²°: ì—°ê²°ë¨';
    onValue(ref(db,'matches'), (snap)=>{
      const all = snap.val() || {};
      window.lastAll = all;
      rebuild(all);
      render();
      lastBadge.textContent = 'ì‹¤ì‹œê°„ ì—°ê²°: ê°±ì‹  ' + new Date().toLocaleTimeString('ko-KR');
    }, (err)=>{
      console.error(err);
      lastBadge.textContent = 'ì‹¤ì‹œê°„ ì—°ê²°: ì˜¤ë¥˜';
    });
  });

  // ë¡œê·¸ì¸ ì‹œì‘
  signInAnonymously(auth).catch(e=>{
    console.error(e);
    const lastBadge = document.getElementById('lastUpdate');
    lastBadge.textContent = 'ì‹¤ì‹œê°„ ì—°ê²°: ë¡œê·¸ì¸ ì‹¤íŒ¨';
  });
</script>
</body>
</html>
