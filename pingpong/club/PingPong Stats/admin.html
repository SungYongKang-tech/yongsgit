<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>KOEN íƒêµ¬ Â· ê´€ë¦¬ì</title>
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --card:#fff; --bg:#f5f7fb;
      --primary:#0d47a1; --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
      --shadow:0 8px 28px rgba(0,0,0,.08)
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; color:var(--ink); background:var(--bg)}
    header{position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #e5e7eb}
    .wrap{max-width:1040px; margin:0 auto; padding:14px 16px}
    h1{margin:4px 0 6px; font-size:clamp(18px,4vw,24px); color:var(--primary)}
    main{max-width:1040px; margin:16px auto; padding:0 16px 40px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{border:1px solid #d1d5db; border-radius:10px; padding:8px 12px; font-size:14px; background:#fff; cursor:pointer}
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
    .btn.warn{background:#ef4444; color:#fff; border-color:#ef4444}
    .btn.ok{background:#16a34a; color:#fff; border-color:#16a34a}
    .card{background:var(--card); border:1px solid #e5e7eb; border-radius:16px; padding:14px; box-shadow:var(--shadow); margin:12px 0}
    table{width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden}
    thead th{background:#f8fafc; border-bottom:1px solid #e5e7eb; padding:10px; font-size:14px; color:#334155; text-align:left}
    tbody td{border-bottom:1px solid #f1f5f9; padding:8px; font-size:14px}
    .right{text-align:right}
    .muted{color:var(--muted)}
    input[type="number"]{width:90px; padding:6px 8px}
    input[type="text"]{padding:6px 8px}
    .grid{display:grid; gap:12px}
    .grid.cols-2{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    .small{font-size:12px}
    .hint{color:#64748b; font-size:13px}
    .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#eef2ff; border:1px solid #d1d5db; border-radius:999px; font-size:12px}
    .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#111827; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; pointer-events:none; transition:.25s}
    .toast.show{opacity:1}
    .preview{background:#f9fafb; border:1px dashed #e5e7eb; border-radius:12px; padding:10px}
    .grow{flex:1}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <h1 style="margin-right:auto">KOEN íƒêµ¬ Â· ê´€ë¦¬ì</h1>
      <a class="btn" href="./">â† ì„±ì ì…ë ¥</a>
      <a class="btn" href="monthly-report.html">ğŸ“Š ì´ë²ˆë‹¬ ì„±ì í‘œ</a>
    </div>
    <div class="row">
      <span class="badge">ì‹¤í—˜íŒ Â· ë¸Œë¼ìš°ì €ì—ì„œ ë™ì‘</span>
      <span class="small muted">â€» ì˜ˆì•½ ì €ì¥/í†µê³„ ë°˜ì˜ì€ Cloud Functions ê¶Œì¥</span>
    </div>
  </div>
</header>

<main>
  <!-- ë¡œìŠ¤í„° ê´€ë¦¬ -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div style="font-weight:700">ì„ ìˆ˜(ë¡œìŠ¤í„°) ê´€ë¦¬</div>
      <div class="small muted">ë¶€ìˆ˜ëŠ” ìˆ«ì ì‘ì„ìˆ˜ë¡ ìƒìœ„ì…ë‹ˆë‹¤.</div>
    </div>
    <div class="grid cols-2" style="margin-top:8px">
      <div>
        <div class="muted small" style="margin-bottom:6px">ì„ ìˆ˜ ì¶”ê°€</div>
        <div class="row">
          <input id="newName" type="text" placeholder="ì´ë¦„" />
          <input id="newLevel" type="number" min="1" max="20" step="1" placeholder="ë¶€ìˆ˜" />
          <button id="addPlayer" class="btn ok">ì¶”ê°€</button>
        </div>
        <div class="hint" style="margin-top:6px">ì´ë¦„ë§Œ ì…ë ¥í•´ë„ ë˜ì§€ë§Œ ë¶€ìˆ˜ ì…ë ¥ì„ ê¶Œì¥í•©ë‹ˆë‹¤.</div>
      </div>
      <div>
        <div class="muted small" style="margin-bottom:6px">ì •ë ¬</div>
        <div class="row">
          <button id="sortByLevel" class="btn primary">ë¶€ìˆ˜ ì˜¤ë¦„ì°¨ìˆœ</button>
          <button id="sortByName" class="btn">ì´ë¦„ ê°€ë‚˜ë‹¤</button>
        </div>
      </div>
    </div>

    <div style="overflow:auto; margin-top:12px">
      <table>
        <thead>
          <tr>
            <th style="width:56px">ë²ˆí˜¸</th>
            <th>ì´ë¦„</th>
            <th style="width:120px" class="right">ë¶€ìˆ˜</th>
            <th style="width:220px" class="right">ì‘ì—…</th>
          </tr>
        </thead>
        <tbody id="playerBody"></tbody>
      </table>
    </div>
  </section>

  <!-- í†µê³„/ì˜µì…˜ -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div style="font-weight:700">í†µê³„ ì˜µì…˜</div>
      <div class="small muted">ì›”ê°„ ë¦¬í¬íŠ¸ëŠ” ì´ ê°’ì„ ì¦‰ì‹œ ë°˜ì˜(ì½ê¸°)í•˜ë„ë¡ êµ¬í˜„ ê¶Œì¥</div>
    </div>

    <div class="grid cols-2" style="margin-top:8px">
      <!-- ë³µì‹ ê°€ì¤‘ì¹˜ -->
      <div class="card" style="margin:0">
        <div class="muted small" style="margin-bottom:6px">ë³µì‹ ê°€ì¤‘ì¹˜</div>
        <div class="row">
          <input id="doubleWeight" type="number" min="0" max="1" step="0.1" />
          <button id="saveDoubleWeight" class="btn primary">ì €ì¥</button>
        </div>
        <div class="hint" style="margin-top:6px">ì˜ˆ) 0.5 â‡’ ë³µì‹ì€ ë‹¨ì‹ì˜ ì ˆë°˜ ê°€ì¤‘</div>
      </div>

      <!-- ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ -->
      <div class="card" style="margin:0">
        <div class="muted small" style="margin-bottom:6px">ì‚­ì œ ë¹„ë°€ë²ˆí˜¸</div>
        <div class="row">
          <input id="deletePassword" type="text" placeholder="ì˜ˆ: 7910" />
          <button id="saveDeletePassword" class="btn primary">ì €ì¥</button>
        </div>
        <div class="hint" style="margin-top:6px">ì„±ì ì…ë ¥ í™”ë©´ì—ì„œ ì‚­ì œ ì‹œ ì‚¬ìš©í•˜ëŠ” 4ìë¦¬ ë¹„ë°€ë²ˆí˜¸</div>
      </div>
    </div>
  </section>

  <!-- ì‹¤ë ¥ì°¨ ë³´ì •(ê³ ìˆ˜/í•˜ìˆ˜ ê°€ì¤‘ì¹˜) -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div style="font-weight:700">ì‹¤ë ¥ì°¨ ë³´ì • (ê³ ìˆ˜/í•˜ìˆ˜ ìŠ¹ë¥  ê°€ì¤‘ì¹˜)</div>
      <div class="small muted">ë ˆë²¨ ì°¨ì— ë”°ë¼ ê²½ê¸° ê²°ê³¼ ë°˜ì˜ ê°€ì¤‘ì¹˜ë¥¼ ìë™ ì¡°ì •</div>
    </div>

    <div class="grid cols-2" style="margin-top:8px">
      <div class="card" style="margin:0">
        <div class="muted small" style="margin-bottom:6px">ë³´ì • íŒŒë¼ë¯¸í„°</div>
        <div class="row">
          <label class="small muted" style="width:110px">ë ˆë²¨ë‹¹ ì¦ê°(perLevel)</label>
          <input id="saPerLevel" type="number" min="0" max="1" step="0.01" value="0.05">
        </div>
        <div class="row" style="margin-top:6px">
          <label class="small muted" style="width:110px">ê³ ìˆ˜ìŠ¹ ìµœì†Œ(minFav)</label>
          <input id="saMinFav" type="number" min="0" max="1" step="0.01" value="0.6">
        </div>
        <div class="row" style="margin-top:6px">
          <label class="small muted" style="width:110px">í•˜ìˆ˜ìŠ¹ ìµœëŒ€(maxDog)</label>
          <input id="saMaxDog" type="number" min="1" max="3" step="0.01" value="1.8">
        </div>
        <div class="row" style="margin-top:8px">
          <button id="saveSkillAdjust" class="btn primary">ë³´ì •ê°’ ì €ì¥</button>
        </div>
        <div class="hint" style="margin-top:6px">
          ê³µì‹: d = |Lv ì°¨|, ê³ ìˆ˜ ìŠ¹ë¦¬ â‡’ max(minFav, 1 - perLevelÂ·d), í•˜ìˆ˜ ìŠ¹ë¦¬ â‡’ min(maxDog, 1 + perLevelÂ·d)
        </div>
      </div>

      <div class="card preview" style="margin:0">
        <div class="muted small" style="margin-bottom:6px">ë¯¸ë¦¬ë³´ê¸° ê³„ì‚°ê¸°</div>
        <div class="row">
          <label class="small muted">A ë¶€ìˆ˜</label><input id="pvLvA" type="number" min="1" max="20" step="1" value="5">
          <label class="small muted">B ë¶€ìˆ˜</label><input id="pvLvB" type="number" min="1" max="20" step="1" value="9">
          <button id="pvCalc" class="btn">ê³„ì‚°</button>
        </div>
        <div id="pvOut" class="hint" style="margin-top:8px; white-space:pre-line">
          Aê°€ ê³ ìˆ˜(ìˆ«ì ì‘ìŒ)ì¼ ë•Œ ê³ ìˆ˜ìŠ¹ ê°€ì¤‘ì¹˜, í•˜ìˆ˜ìŠ¹ ê°€ì¤‘ì¹˜ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
        </div>
      </div>
    </div>

    <div class="hint" style="margin-top:8px">
      âš™ï¸ ì ìš© ë°©ë²•(ì„±ì ì…ë ¥/í†µê³„ ì½”ë“œ): ê²½ê¸° í™•ì • ì‹œ
      <code>weight = getAdjustedWeight(levelA, levelB, winner)</code>ë¥¼ ê³±í•´ ìŠ¹/íŒ¨/í¬ì¸íŠ¸ì— ë°˜ì˜í•˜ì„¸ìš”.
    </div>
  </section>
</main>

<div id="toast" class="toast">Saved</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getDatabase, ref, push, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  // ===== Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyC5iq3VY0QtBh8FVn70gi_Gsg7GXzkxdu8",
    authDomain: "koen-pingpong.firebaseapp.com",
    databaseURL: "https://koen-pingpong-default-rtdb.firebaseio.com",
    projectId: "koen-pingpong",
    storageBucket: "koen-pingpong.appspot.com",
    messagingSenderId: "597358811982",
    appId: "1:597358811982:web:b66dcb6a7159fb5f321c1f"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // ===== Utils =====
  const $ = (s, ctx=document)=>ctx.querySelector(s);
  const toast = (msg='ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤')=>{
    const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600);
  };
  const pad = (n)=> String(n).padStart(2,'0');

  // ===== ë¡œìŠ¤í„° =====
  let players = []; // {id, name, level}
  let sortMode = 'level';

  function renderPlayers(){
    const body = $('#playerBody'); body.innerHTML='';
    const rows = [...players];
    if(sortMode==='level'){
      rows.sort((a,b)=> (a.level??999) - (b.level??999) || a.name.localeCompare(b.name,'ko'));
    }else{
      rows.sort((a,b)=> a.name.localeCompare(b.name,'ko') || (a.level??999)-(b.level??999));
    }
    rows.forEach((p, idx)=>{
      const tr = document.createElement('tr');

      const tdNo = document.createElement('td'); tdNo.textContent = String(idx+1); tr.appendChild(tdNo);

      const tdName = document.createElement('td');
      const nameIn = document.createElement('input'); nameIn.type='text'; nameIn.value=p.name; nameIn.style.width='100%';
      tdName.appendChild(nameIn); tr.appendChild(tdName);

      const tdLevel = document.createElement('td'); tdLevel.className='right';
      const lvlIn = document.createElement('input'); lvlIn.type='number'; lvlIn.min='1'; lvlIn.max='20'; lvlIn.step='1'; lvlIn.value = (p.level ?? '');
      tdLevel.appendChild(lvlIn); tr.appendChild(tdLevel);

      const tdAct = document.createElement('td'); tdAct.className='right';
      const btnSave = document.createElement('button'); btnSave.className='btn primary'; btnSave.textContent='ì €ì¥';
      const btnDel  = document.createElement('button'); btnDel.className='btn warn'; btnDel.style.marginLeft='6px'; btnDel.textContent='ì‚­ì œ';
      btnSave.onclick = async()=>{
        const name = nameIn.value.trim(); const level = lvlIn.value==='' ? null : Number(lvlIn.value);
        if(!name){ toast('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
        await update(ref(db,'players/'+p.id), { name, level });
        toast('ì €ì¥ë¨');
      };
      btnDel.onclick = async()=>{
        if(!confirm(`ì •ë§ ì‚­ì œí• ê¹Œìš”? (${p.name})`)) return;
        await remove(ref(db,'players/'+p.id));
        toast('ì‚­ì œë¨');
      };
      tdAct.append(btnSave, btnDel); tr.appendChild(tdAct);

      body.appendChild(tr);
    });
  }

  $('#addPlayer').onclick = async()=>{
    const name = $('#newName').value.trim();
    const levelStr = $('#newLevel').value.trim();
    const level = levelStr==='' ? null : Number(levelStr);
    if(!name){ toast('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
    const key = push(ref(db,'players')).key; // keyë¥¼ idë¡œ ì‚¬ìš©
    await set(ref(db,'players/'+key), {
      name, level, createdAt: Date.now()
    });
    $('#newName').value=''; $('#newLevel').value='';
    toast('ì¶”ê°€ë¨');
  };
  $('#sortByLevel').onclick=()=>{ sortMode='level'; renderPlayers(); };
  $('#sortByName').onclick =()=>{ sortMode='name' ; renderPlayers(); };

  onValue(ref(db,'players'), (snap)=>{
    const val = snap.val() || {};
    players = Object.entries(val).map(([id, v])=>({ id, name:v.name, level:v.level }));
    renderPlayers();
  });

  // ===== ì˜µì…˜: ë³µì‹ ê°€ì¤‘ì¹˜ / ì‚­ì œ ë¹„ë²ˆ =====
  onValue(ref(db,'config/doubleWeight'), (s)=>{
    const v = s.val(); $('#doubleWeight').value = (v ?? 0.5);
  });
  $('#saveDoubleWeight').onclick = async()=>{
    const v = parseFloat($('#doubleWeight').value);
    if(!isFinite(v) || v<0 || v>1){ toast('0~1 ì‚¬ì´ì˜ ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
    await set(ref(db,'config/doubleWeight'), v);
    toast('ë³µì‹ ê°€ì¤‘ì¹˜ ì €ì¥');
  };

  onValue(ref(db,'config/deletePassword'), (s)=>{
    const v = s.val(); $('#deletePassword').value = (v ?? '7910');
  });
  $('#saveDeletePassword').onclick = async()=>{
    const v = $('#deletePassword').value.trim();
    if(!v){ toast('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
    await set(ref(db,'config/deletePassword'), v);
    toast('ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ ì €ì¥');
  };

  // ===== ì‹¤ë ¥ì°¨ ë³´ì • ì„¤ì • =====
  // DB: config/skillAdjust = { perLevel:number, minFav:number, maxDog:number }
  function clamp(min, x, max){ return Math.max(min, Math.min(max, x)); }

  function getAdjustedWeight(levelA, levelB, winner){ // winner: 'A' | 'B'
    const sa = currentSA;
    const d = Math.abs((levelA ?? 99) - (levelB ?? 99)); // level ë¯¸ì…ë ¥ì‹œ í° ê°’ìœ¼ë¡œ ì·¨ê¸‰
    // ìˆ«ì ì‘ì„ìˆ˜ë¡ ìƒìœ„(ê³ ìˆ˜)
    const aIsFav = (levelA ?? 99) < (levelB ?? 99);
    const favWin = clamp(sa.minFav, 1 - sa.perLevel * d, 1);
    const dogWin = clamp(1, 1 + sa.perLevel * d, sa.maxDog);
    if(winner === 'A'){
      return aIsFav ? favWin : dogWin;
    }else{ // winner === 'B'
      const bIsFav = !aIsFav;
      return bIsFav ? favWin : dogWin;
    }
  }

  let currentSA = { perLevel:0.05, minFav:0.6, maxDog:1.8 };

  function renderSAInputs(sa){
    $('#saPerLevel').value = sa.perLevel;
    $('#saMinFav').value  = sa.minFav;
    $('#saMaxDog').value  = sa.maxDog;
  }

  onValue(ref(db,'config/skillAdjust'), (s)=>{
    const v = s.val();
    if(v && typeof v === 'object'){
      currentSA = {
        perLevel: Number(v.perLevel ?? 0.05),
        minFav:   Number(v.minFav   ?? 0.6 ),
        maxDog:   Number(v.maxDog   ?? 1.8 )
      };
      renderSAInputs(currentSA);
    }else{
      // ì´ˆê¸°ê°’ í‘œì‹œ
      renderSAInputs(currentSA);
    }
  });

  $('#saveSkillAdjust').onclick = async()=>{
    const perLevel = parseFloat($('#saPerLevel').value);
    const minFav   = parseFloat($('#saMinFav').value);
    const maxDog   = parseFloat($('#saMaxDog').value);

    if(!(perLevel>=0 && perLevel<=1)) { toast('perLevelì€ 0~1 ì‚¬ì´ë¡œ ì…ë ¥í•˜ì„¸ìš”'); return; }
    if(!(minFav>=0 && minFav<=1))     { toast('minFavëŠ” 0~1 ì‚¬ì´ë¡œ ì…ë ¥í•˜ì„¸ìš”'); return; }
    if(!(maxDog>=1 && maxDog<=3))     { toast('maxDogëŠ” 1~3 ì‚¬ì´ë¡œ ì…ë ¥í•˜ì„¸ìš”'); return; }
    if(minFav > 1)                    { toast('minFavëŠ” ìµœëŒ€ 1ì…ë‹ˆë‹¤'); return; }
    if(maxDog < 1)                    { toast('maxDogëŠ” ìµœì†Œ 1ì…ë‹ˆë‹¤'); return; }

    const sa = { perLevel, minFav, maxDog };
    await set(ref(db,'config/skillAdjust'), sa);
    currentSA = sa;
    toast('ì‹¤ë ¥ì°¨ ë³´ì • ì €ì¥');
  };

  // ë¯¸ë¦¬ë³´ê¸° ê³„ì‚°ê¸°
  function showPreview(){
    const lvA = Number($('#pvLvA').value);
    const lvB = Number($('#pvLvB').value);
    const d = Math.abs(lvA - lvB);
    const fav = (lvA < lvB) ? 'A' : (lvB < lvA) ? 'B' : 'ë™ì¼';
    const wA = getAdjustedWeight(lvA, lvB, 'A');
    const wB = getAdjustedWeight(lvA, lvB, 'B');
    const text =
`ë ˆë²¨ ì°¨ d = ${d} (ì‘ì„ìˆ˜ë¡ ìƒìœ„)
ê³ ìˆ˜ëŠ”: ${fav === 'ë™ì¼' ? 'ì—†ìŒ(ë™ì¼ ë ˆë²¨)' : fav}

Aê°€ ìŠ¹ë¦¬ ì‹œ ê°€ì¤‘ì¹˜: ${wA.toFixed(3)}
Bê°€ ìŠ¹ë¦¬ ì‹œ ê°€ì¤‘ì¹˜: ${wB.toFixed(3)}

â€» ê³ ìˆ˜ ìŠ¹ë¦¬(ê¸°ëŒ€ ê²°ê³¼)ëŠ” ${currentSA.minFav} ì´ìƒìœ¼ë¡œ ì‘ê²Œ,
   í•˜ìˆ˜ ìŠ¹ë¦¬(ì´ë³€)ëŠ” ${currentSA.maxDog} ì´í•˜ë¡œ í¬ê²Œ ë°˜ì˜`;
    $('#pvOut').textContent = text;
  }
  $('#pvCalc').onclick = showPreview;

  // ===== ì‹œì‘ =====
  signInAnonymously(auth).catch(console.error);
  onAuthStateChanged(auth, ()=>{ /* no-op */ });
</script>
</body>
</html>
