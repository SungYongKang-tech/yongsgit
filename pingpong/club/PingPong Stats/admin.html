<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>KOEN íƒêµ¬ Â· ê´€ë¦¬ì</title>
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --card:#fff; --bg:#f5f7fb;
      --primary:#0d47a1; --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
      --shadow:0 8px 28px rgba(0,0,0,.08)
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; color:var(--ink); background:var(--bg)}
    header{position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #e5e7eb}
    .wrap{max-width:1040px; margin:0 auto; padding:14px 16px}
    h1{margin:4px 0 6px; font-size:clamp(18px,4vw,24px); color:var(--primary)}
    main{max-width:1040px; margin:16px auto; padding:0 16px 40px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{border:1px solid #d1d5db; border-radius:10px; padding:8px 12px; font-size:14px; background:#fff; cursor:pointer}
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
    .btn.warn{background:#ef4444; color:#fff; border-color:#ef4444}
    .btn.ok{background:#16a34a; color:#fff; border-color:#16a34a}
    .card{background:var(--card); border:1px solid #e5e7eb; border-radius:16px; padding:14px; box-shadow:var(--shadow); margin:12px 0}
    table{width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden}
    thead th{background:#f8fafc; border-bottom:1px solid #e5e7eb; padding:10px; font-size:14px; color:#334155; text-align:left}
    tbody td{border-bottom:1px solid #f1f5f9; padding:8px; font-size:14px}
    .right{text-align:right}
    .muted{color:var(--muted)}
    input[type="number"]{width:90px; padding:6px 8px}
    input[type="text"]{padding:6px 8px}
    .grid{display:grid; gap:12px}
    .grid.cols-2{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    .small{font-size:12px}
    .hint{color:#64748b; font-size:13px}
    .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#eef2ff; border:1px solid #d1d5db; border-radius:999px; font-size:12px}
    .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#111827; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; pointer-events:none; transition:.25s}
    .toast.show{opacity:1}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <h1 style="margin-right:auto">KOEN íƒêµ¬ Â· ê´€ë¦¬ì</h1>
      <a class="btn" href="./">â† ì„±ì ì…ë ¥</a>
      <a class="btn" href="monthly-report.html">ğŸ“Š ì´ë²ˆë‹¬ ì„±ì í‘œ</a>
    </div>
    <div class="row">
      <span class="badge">ì‹¤í—˜íŒ Â· ë¸Œë¼ìš°ì €ì—ì„œ ë™ì‘</span>
      <span class="small muted">â€» ì˜ˆì•½ ì €ì¥/í†µê³„ ë°˜ì˜ì€ Cloud Functions ê¶Œì¥</span>
    </div>
  </div>
</header>

<main>
  <!-- í†µê³„/ì˜µì…˜ -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div style="font-weight:700">í†µê³„ ì˜µì…˜</div>
      <div class="small muted">ì›”ê°„ ë¦¬í¬íŠ¸ëŠ” ì´ ê°’ì„ ì¦‰ì‹œ ë°˜ì˜(ì½ê¸°)í•˜ë„ë¡ êµ¬í˜„ ê¶Œì¥</div>
    </div>

    <div class="grid cols-2" style="margin-top:8px">
      <!-- ë³µì‹ ê°€ì¤‘ì¹˜ -->
      <div class="card" style="margin:0">
        <div class="muted small" style="margin-bottom:6px">ë³µì‹ ê°€ì¤‘ì¹˜</div>
        <div class="row">
          <input id="doubleWeight" type="number" min="0" max="1" step="0.1" />
          <button id="saveDoubleWeight" class="btn primary">ì €ì¥</button>
        </div>
        <div class="hint" style="margin-top:6px">ì˜ˆ) 0.5 â‡’ ë³µì‹ì€ ë‹¨ì‹ì˜ ì ˆë°˜ ê°€ì¤‘</div>
      </div>

      <!-- ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ -->
      <div class="card" style="margin:0">
        <div class="muted small" style="margin-bottom:6px">ì‚­ì œ ë¹„ë°€ë²ˆí˜¸</div>
        <div class="row">
          <input id="deletePassword" type="text" placeholder="ì˜ˆ: 7910" />
          <button id="saveDeletePassword" class="btn primary">ì €ì¥</button>
        </div>
        <div class="hint" style="margin-top:6px">ì„±ì ì…ë ¥ í™”ë©´ì—ì„œ ì‚­ì œ ì‹œ ì‚¬ìš©í•˜ëŠ” 4ìë¦¬ ë¹„ë°€ë²ˆí˜¸</div>
      </div>
    </div>
  </section>

  <!-- ì„ ìˆ˜ ê´€ë¦¬ -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div style="font-weight:700">ì„ ìˆ˜ ê´€ë¦¬</div>
      <div class="small muted">ë¹„í™œì„±í™” í›„ 2ê°œì›” ë’¤ ìë™ ì™„ì „ ì‚­ì œ</div>
    </div>
    <div style="overflow:auto; margin-top:8px">
      <table>
        <thead>
          <tr>
            <th>ì´ë¦„</th>
            <th>ë¶€ìˆ˜</th>
            <th>ìƒíƒœ</th>
            <th>ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody id="playersTableBody"></tbody>
      </table>
    </div>
    <div class="small muted" style="margin-top:8px">
      Â· ë¹„í™œì„±í™” = ì¹©/ì…ë ¥ì—ì„œ ìˆ¨ê¹€(ê¸°ë¡ì€ ë³´ì¡´) Â· ì™„ì „ ì‚­ì œ = ìµœê·¼ 2ê°œì›” ê¸°ë¡ì´ ì—†ì„ ë•Œë§Œ í—ˆìš©
    </div>
  </section>

  <!-- ë°ì´í„° ê´€ë¦¬ -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div style="font-weight:700; color:#b91c1c">ë°ì´í„° ê´€ë¦¬</div>
      <div class="small muted">ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë‹ˆ ì£¼ì˜í•˜ì„¸ìš”.</div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="purgeMatches" class="btn warn">ğŸ—‘ï¸ ëª¨ë“  ê²½ê¸° ê¸°ë¡ ì‚­ì œ</button>
      <span class="hint">`matches` ì „ì²´ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. (ì›”ê°„ í†µê³„ëŠ” ë³„ë„ ê´€ë¦¬ ì‹œ ê·¸ëŒ€ë¡œ ë‚¨ìŠµë‹ˆë‹¤)</span>
    </div>
  </section>
</main>

<div id="toast" class="toast">Saved</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getDatabase, ref, set, remove, onValue, update, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  // ===== Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyC5iq3VY0QtBh8FVn70gi_Gsg7GXzkxdu8",
    authDomain: "koen-pingpong.firebaseapp.com",
    databaseURL: "https://koen-pingpong-default-rtdb.firebaseio.com",
    projectId: "koen-pingpong",
    storageBucket: "koen-pingpong.appspot.com",
    messagingSenderId: "597358811982",
    appId: "1:597358811982:web:b66dcb6a7159fb5f321c1f"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // ===== Utils =====
  const $ = (s, ctx=document)=>ctx.querySelector(s);
  const toast = (msg='ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤')=>{
    const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600);
  };

  // ===== ì˜µì…˜: ë³µì‹ ê°€ì¤‘ì¹˜ / ì‚­ì œ ë¹„ë²ˆ =====
  let currentDeletePw = '7910';

  onValue(ref(db,'config/doubleWeight'), (s)=>{
    $('#doubleWeight').value = (s.val() ?? 0.5);
  });
  $('#saveDoubleWeight').onclick = async()=>{
    const v = parseFloat($('#doubleWeight').value);
    if(!isFinite(v) || v<0 || v>1){ toast('0~1 ì‚¬ì´ì˜ ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
    await set(ref(db,'config/doubleWeight'), v);
    toast('ë³µì‹ ê°€ì¤‘ì¹˜ ì €ì¥');
  };

  onValue(ref(db,'config/deletePassword'), (s)=>{
    const val = s.val();
    $('#deletePassword').value = (val ?? '7910');
    currentDeletePw = val ?? '7910';
  });
  $('#saveDeletePassword').onclick = async()=>{
    const v = $('#deletePassword').value.trim();
    if(!v){ toast('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
    await set(ref(db,'config/deletePassword'), v);
    currentDeletePw = v;
    toast('ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ ì €ì¥');
  };

  // ===== ğŸ”¥ ëª¨ë“  ê²½ê¸° ê¸°ë¡ ì‚­ì œ =====
  async function purgeAllMatches(){
    const pw = prompt('ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    if (pw !== currentDeletePw){ toast('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤'); return; }
    if (!confirm('ì •ë§ ëª¨ë“  ê²½ê¸° ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”? ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
    await remove(ref(db, 'matches'));
    toast('ëª¨ë“  ê²½ê¸° ê¸°ë¡ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤');
  }
  $('#purgeMatches').onclick = purgeAllMatches;

  // ===== ì„ ìˆ˜ ê´€ë¦¬ =====
  const playersTable = document.getElementById('playersTableBody');

  function renderPlayers(players){
    playersTable.innerHTML = '';
    Object.entries(players).forEach(([key, player])=>{
      const tr = document.createElement('tr');
      if (player.active === false) tr.style.opacity = '0.5';

      const safeName = String(player.name ?? '');
      const safeLevel = String(player.level ?? '');

      tr.innerHTML = `
        <td>${safeName}</td>
        <td>${safeLevel}</td>
        <td>${player.active === false ? 'ë¹„í™œì„±í™”' : 'í™œì„±'}</td>
        <td style="display:flex; gap:6px; flex-wrap:wrap">
          ${player.active === false
            ? `<button class="btn ok"   data-act="activate"   data-id="${key}" data-name="${safeName}">ë³µêµ¬</button>`
            : `<button class="btn warn" data-act="deactivate" data-id="${key}" data-name="${safeName}">ë¹„í™œì„±í™”</button>`}
          <button class="btn" data-act="hardDelete" data-id="${key}" data-name="${safeName}">ì™„ì „ ì‚­ì œ(ì•ˆì „)</button>
        </td>
      `;
      playersTable.appendChild(tr);
    });
  }

  function loadPlayers(){
    onValue(ref(db, 'players'), (snap)=>{
      const players = snap.val() || {};
      renderPlayers(players);
    });
  }

  // í…Œì´ë¸” ë²„íŠ¼ ìœ„ì„
  playersTable.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]');
    if(!btn) return;
    const act = btn.dataset.act;
    const id = btn.dataset.id;
    const name = btn.dataset.name || id;

    if(act === 'deactivate'){
      const pw = prompt(`${name} ì„ ìˆ˜ ë¹„í™œì„±í™”. ë¹„ë°€ë²ˆí˜¸?`);
      if(pw !== currentDeletePw){ toast('ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜'); return; }
      if(!confirm(`${name} ì„ ìˆ˜ë¥¼ ë¹„í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì¹©/ì…ë ¥ì—ì„œ ìˆ¨ê²¨ì§€ê³  ê¸°ë¡ì€ ë³´ì¡´ë©ë‹ˆë‹¤.`)) return;
      await update(ref(db, 'players/'+id), { active:false });
      toast(`${name} ë¹„í™œì„±í™”ë¨`);
    }

    if(act === 'activate'){
      if(!confirm(`${name} ì„ ìˆ˜ë¥¼ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      await update(ref(db, 'players/'+id), { active:true });
      toast(`${name} ë³µêµ¬ë¨`);
    }

    if(act === 'hardDelete'){
      const pw = prompt(`${name} ì„ ìˆ˜ë¥¼ ì™„ì „ ì‚­ì œí•©ë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸?`);
      if(pw !== currentDeletePw){ toast('ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜'); return; }

      // ìµœê·¼ 2ê°œì›” matchesì— ì°¸ì—¬ ê¸°ë¡ì´ ìˆëŠ”ì§€ ê²€ì‚¬ â†’ ìˆìœ¼ë©´ ì‚­ì œ ê¸ˆì§€
      const matchesSnap = await get(ref(db, 'matches'));
      const all = matchesSnap.val() || {};
      let hasRecent = false;
      for(const m of Object.values(all)){
        const a = (m.membersA||[]);
        const b = (m.membersB||[]);
        if(a.includes(id) || b.includes(id)){ hasRecent = true; break; }
      }
      if(hasRecent){
        alert('ìµœê·¼ 2ê°œì›” ë‚´ ê²½ê¸° ê¸°ë¡ì´ ìˆì–´ ì™„ì „ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nâ†’ ë¹„í™œì„±í™” ìƒíƒœë¡œ ìœ ì§€í•˜ì„¸ìš”.');
        return;
      }

      if(!confirm(`[ìµœì¢… í™•ì¸]\nì •ë§ ${name} ì„ ìˆ˜ë¥¼ ì™„ì „ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)`)) return;
      await remove(ref(db, 'players/'+id));
      toast(`${name} ì™„ì „ ì‚­ì œë¨`);
    }
  });

  // ì‹œì‘
  signInAnonymously(auth).catch(console.error);
  onAuthStateChanged(auth, ()=> loadPlayers());
</script>
</body>
</html>
