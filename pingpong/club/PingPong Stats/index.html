<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KOEN 탁구 Manager · 성적입력</title>
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --card:#ffffff; --bg:#f5f7fb; --primary:#0d47a1; --accent:#2563eb; --danger:#ef4444; --ok:#16a34a;
      --shadow:0 8px 28px rgba(0,0,0,.08)
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; color:var(--ink); background:var(--bg)}
    header{position:sticky; top:0; z-index:20; background:#fff; border-bottom:1px solid #e5e7eb}
    .wrap{max-width:980px; margin:0 auto; padding:14px 16px}
    h1{margin:4px 0 6px; font-size:clamp(18px,4vw,24px); color:var(--primary)}

    main{max-width:980px; margin:12px auto; padding:0 16px 30px}
    .card{background:var(--card); border:1px solid #e5e7eb; border-radius:16px; padding:14px; box-shadow:var(--shadow); margin:12px 0}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row>.grow{flex:1}
    label{font-size:13px; color:var(--muted)}
    select, input[type="datetime-local"], .btn{border:1px solid #d1d5db; border-radius:10px; padding:10px 12px; font-size:15px; background:#fff}
    .btn{cursor:pointer; display:inline-flex; align-items:center; gap:8px}
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
    .btn.warn{background:var(--danger); color:#fff; border-color:var(--danger)}
    .btn.ok{background:var(--ok); color:#fff; border-color:var(--ok)}

    .chips{display:flex; flex-wrap:wrap; gap:6px; margin-top:8px}
    .chip{padding:8px 10px; border-radius:999px; border:1px solid #d1d5db; cursor:pointer; background:#eef2ff}

    .slots{display:grid; grid-template-columns:1fr 24px 1fr; gap:10px; align-items:start; margin-top:8px}
    .slot{border:1px dashed #cbd5e1; min-height:44px; border-radius:10px; padding:8px; background:#fff}
    .pill{display:inline-flex; padding:6px 10px; margin:4px; border-radius:999px; background:#e2e8f0; gap:6px; align-items:center}
    .pill b{font-weight:600}
    .pill button{border:0; background:transparent; cursor:pointer; color:#475569}
    .vs{display:grid; place-items:center; color:#64748b; font-weight:700}

    .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#111827; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; pointer-events:none; transition:.25s}
    .toast.show{opacity:1}

    /* 코드 블록(제목 바로 아래 array 표시용) */
    pre.code{
      background:#0b1020; color:#e5e7eb; border-radius:12px; padding:12px 14px; overflow:auto;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:13px;
      border:1px solid #1f2937; box-shadow:var(--shadow); margin-top:8px;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>KOEN 탁구 Manager · 성적입력</h1>
      <!-- 제목 바로 아래: defaultPlayersRaw를 그대로 보여주는 코드 블록 -->
      <pre id="defaultListBlock" class="code"></pre>
    </div>
  </header>

  <main>
    <!-- 성적입력 단일 화면 -->
    <section id="secResult" class="active">
      <div class="card">
        <div class="row">
          <label>경기 종류</label>
          <select id="resType">
            <option value="single" selected>단식</option>
            <option value="double">복식</option>
          </select>

          <div class="grow"></div>

          <label>시각</label>
          <input id="resTime" type="datetime-local">
        </div>

        <!-- 선수 선택: 칩 + 슬롯 -->
        <div class="card">
          <div class="chips" id="resChips"></div>
          <div class="slots">
            <div class="slot" id="resSlotA"></div>
            <div class="vs">VS</div>
            <div class="slot" id="resSlotB"></div>
          </div>
        </div>

        <div class="row" style="margin-top:10px; gap:8px">
          <label>승자</label>
          <select id="resWinner">
            <option value="A">A팀</option>
            <option value="B">B팀</option>
          </select>
          <label>스코어(선택)</label>
          <select id="resScore">
            <option value="">스코어 선택(선택)</option>
            <option>3-2</option><option>3-1</option><option>3-0</option>
            <option>2-1</option><option>2-0</option>
          </select>
          <button class="btn primary" id="saveResult">저장</button>
        </div>
        <div style="font-size:12px; color:var(--muted); margin-top:6px">저장 후 폼이 초기화되어 연속 입력이 빠릅니다.</div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast">Saved</div>

  <!-- Firebase SDK (ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref, get, set, push, update, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // ---- 0) Firebase 초기화 (사용자 제공 설정) ----
    const firebaseConfig = {
      apiKey: "AIzaSyC5iq3VY0QtBh8FVn70gi_Gsg7GXzkxdu8",
      authDomain: "koen-pingpong.firebaseapp.com",
      databaseURL: "https://koen-pingpong-default-rtdb.firebaseio.com",
      projectId: "koen-pingpong",
      storageBucket: "koen-pingpong.firebasestorage.app",
      messagingSenderId: "597358811982",
      appId: "1:597358811982:web:b66dcb6a7159fb5f321c1f"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ---- 1) 유틸 ----
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const toast = (msg='저장되었습니다')=>{
      const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600)
    };

    // ---- 2) 기본 선수 목록 (DB 초기 등록용) ----
    const defaultPlayersRaw = [
      "김희영(4)","강성용(5)","김범일(5)","이영진(6)","박주민(6)","강다훈(6)",
      "박진우(7)","배성국(7)","이상준(7)","황경진(8)","양충현(8)","임춘근(9)",
      "박인찬(8)","전성무(9)","송창근(9)","김승일(9)","문우용(9)","김현곤(9)","오국환(9)","조보미(12)",
      "송은아(13)","이낭주(13)","이승철(13)","박나령(14)","고은선(14)","정승목(14)"
    ];

    // 제목 바로 아래 코드블록에 동일 내용 그대로 출력
    const codeBlock = $('#defaultListBlock');
    codeBlock.textContent =
`const defaultPlayersRaw = [
  "김희영(4)","강성용(5)","김범일(5)","이영진(6)","박주민(6)","강다훈(6)",
  "박진우(7)","배성국(7)","이상준(7)","황경진(8)","양충현(8)","임춘근(9)",
  "박인찬(8)","전성무(9)","송창근(9)","김승일(9)","문우용(9)","김현곤(9)","오국환(9)","조보미(12)",
  "송은아(13)","이낭주(13)","이승철(13)","박나령(14)","고은선(14)","정승목(14)"
];`;

    function slugify(str){
      return str
        .replace(/[()]/g,'')
        .replace(/\s+/g,'-')
        .replace(/[^\p{L}\p{N}-]/gu,'')
        .toLowerCase();
    }

    async function ensurePlayers(){
      const snap = await get(ref(db,'players'));
      if(!snap.exists()){
        const batch = {};
        const seen = new Set();
        defaultPlayersRaw.forEach((s,i)=>{
          const m = s.match(/^(.*)\((\d+)\)$/);
          if(!m) return;
          const name = m[1];
          const level = Number(m[2]);
          let key = slugify(name);
          while(seen.has(key)) key = key + ("-"+(i+1));
          seen.add(key);
          batch[key] = { name, level, isActive:true, createdAt: Date.now() };
        });
        await set(ref(db,'players'), batch);
      }
    }

    // ---- 3) 데이터 로딩/칩 렌더 ----
    let players = []; // [{id,name,level}]
    const mapPlayers = (obj)=> !obj ? [] : Object.entries(obj)
      .map(([id,v])=>({id, ...v}))
      .sort((a,b)=> a.name.localeCompare(b.name,'ko'));

    function renderResChips(){
      const chipsEl = $('#resChips');
      chipsEl.innerHTML='';
      players.forEach(p=>{
        const chip = document.createElement('button');
        chip.className='chip';
        chip.textContent = `${p.name}(${p.level})`;
        chip.onclick = ()=> addToSlot(p);
        chipsEl.appendChild(chip);
      });
    }

    onValue(ref(db,'players'), (snap)=>{
      players = mapPlayers(snap.val());
      renderResChips();
    });

    // ---- 4) 성적입력 선택/저장 ----
    const resState = { type:'single', selA:[], selB:[] };
    $('#resType').onchange = (e)=>{
      resState.type = e.target.value;
      trimSlots();
      drawSlots();
    };

    function needCount(){ return resState.type==='single'?1:2 }
    function trimSlots(){
      const n = needCount();
      resState.selA = resState.selA.slice(0,n);
      resState.selB = resState.selB.slice(0,n);
    }
    function drawSlots(){
      const slotA = $('#resSlotA'); const slotB = $('#resSlotB');
      const draw = (slot, arr, side)=>{
        slot.innerHTML='';
        arr.forEach(p=>{
          const span = document.createElement('span');
          span.className='pill';
          span.innerHTML = `<b>${p.name}</b> (${p.level}) <button title="제거">×</button>`;
          span.querySelector('button').onclick=()=> removeFromSlot(side, p.id);
          slot.appendChild(span);
        });
      }
      draw(slotA, resState.selA, 'A'); draw(slotB, resState.selB, 'B');
    }
    function addToSlot(p){
      const n = needCount();
      if(resState.selA.concat(resState.selB).some(x=>x.id===p.id)) return;
      if(resState.selA.length<n) resState.selA.push(p);
      else if(resState.selB.length<n) resState.selB.push(p);
      drawSlots();
    }
    function removeFromSlot(side,id){
      if(side==='A') resState.selA = resState.selA.filter(x=>x.id!==id);
      else resState.selB = resState.selB.filter(x=>x.id!==id);
      drawSlots();
    }

    function defaultDateTimeLocal(){
      const d = new Date();
      const pad=n=>String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    $('#resTime').value = defaultDateTimeLocal();

    async function saveResult(){
      const need = needCount();
      if(resState.selA.length!==need || resState.selB.length!==need){
        toast('선수를 먼저 선택하세요'); return;
      }
      const winnerSide = $('#resWinner').value;
      const score = $('#resScore').value || '';
      const tsLocal = $('#resTime').value;
      const ts = tsLocal ? new Date(tsLocal).getTime() : Date.now();
      const match = {
        ts,
        type: resState.type,
        membersA: resState.selA.map(p=>p.id),
        membersB: resState.selB.map(p=>p.id),
        winnerSide,
        score: score||null,
        createdBy: (auth.currentUser&&auth.currentUser.uid)||'anon',
        createdAt: Date.now()
      };
      await push(ref(db,'matches'), match);
      toast('성적이 저장되었습니다');
      // 초기화
      $('#resScore').value=''; $('#resWinner').value='A'; $('#resTime').value = defaultDateTimeLocal();
      resState.selA=[]; resState.selB=[]; drawSlots();
    }
    $('#saveResult').onclick=saveResult;

    // ---- 5) 시작 시퀀스 ----
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, async ()=>{
      await ensurePlayers();
      // 최초 1회 즉시 렌더
      const snap = await get(ref(db,'players'));
      players = mapPlayers(snap.val());
      renderResChips();
    });
  </script>
</body>
</html>
