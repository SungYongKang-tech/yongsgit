<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KOEN 탁구 Manager · 성적입력</title>
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --card:#ffffff; --bg:#f5f7fb;
      --primary:#0d47a1; --accent:#2563eb; --danger:#ef4444; --ok:#16a34a;
      --shadow:0 8px 28px rgba(0,0,0,.08)
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; color:var(--ink); background:var(--bg)}
    header{position:sticky; top:0; z-index:20; background:#fff; border-bottom:1px solid #e5e7eb}
    .wrap{max-width:980px; margin:0 auto; padding:14px 16px}
    h1{margin:4px 0 6px; font-size:clamp(18px,4vw,24px); color:var(--primary)}
    main{max-width:980px; margin:12px auto; padding:0 16px 30px}
    .card{background:var(--card); border:1px solid #e5e7eb; border-radius:16px; padding:14px; box-shadow:var(--shadow); margin:12px 0}

    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{padding:10px 12px; border-radius:999px; border:1px solid #d1d5db; cursor:pointer; background:#eef2ff; font-size:15px}
    .chip.selected{outline:2px solid var(--accent); background:#fff}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row.center{justify-content:center}
    .btn{border:1px solid #d1d5db; border-radius:10px; padding:10px 14px; font-size:15px; cursor:pointer; background:#fff}
    .btn.ok{background:var(--ok); color:#fff; border-color:var(--ok)}
    .btn.warn{background:var(--danger); color:#fff; border-color:var(--danger)}

    .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#111827; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; pointer-events:none; transition:.25s}
    .toast.show{opacity:1}

<<<<<<< HEAD
    table{width:100%; border-collapse:collapse}
    th,td{border-bottom:1px solid #e5e7eb; padding:8px 10px; text-align:left}
    th{background:#f8fafc; font-weight:700}
    td .levelBox{display:inline-flex; align-items:center; gap:6px}
    td .levelBox button{width:28px; height:28px; border-radius:8px; border:1px solid #d1d5db; background:#fff; cursor:pointer}

    .search{display:flex; gap:8px; align-items:center}
    .search input{flex:1}

    /* 승률표 모달 */
    .modal-wrap{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:16px; z-index:50}
    .modal{background:#fff; width:min(720px, 96vw); max-height:92vh; overflow:auto; border-radius:16px; box-shadow:var(--shadow); border:1px solid #e5e7eb}
    .modal header{position:sticky; top:0; background:#fff; border-bottom:1px solid #e5e7eb}
    .modal .wrap{padding:12px 16px}
    .modal h2{margin:0; font-size:18px}
    .kv{display:grid; grid-template-columns:140px 1fr; gap:6px; margin:8px 0}
    .pill-sm{display:inline-block; padding:4px 8px; border-radius:999px; background:#eef2ff; border:1px solid #dbe2ff; margin:2px}
    .table-like{width:100%; border-collapse:collapse; margin-top:6px}
    .table-like th, .table-like td{border-bottom:1px solid #e5e7eb; padding:6px 8px; text-align:left}
=======
    /* 최근 저장 리스트 */
    ul.log{margin:8px 0 0 0; padding-left:18px}
>>>>>>> 73bb3c78ef1726971608a15eb8165c41434e6949
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>KOEN 탁구 Manager · 성적입력</h1>
      <!-- 검은 코드블록( defaultPlayersRaw 표시 ) 제거됨 -->
    </div>
  </header>

  <main>
    <section class="active">
      <div class="card">
        <div class="row">
          <div style="font-size:14px; color:var(--muted)">
            단식: <b>두 선수</b>를 선택한 뒤 아래 <b>승자 버튼</b>을 누르면 저장됩니다.
          </div>
          <button id="clearSel" class="btn" style="margin-left:auto">선택 초기화</button>
        </div>

        <div id="chips" class="chips"></div>

        <div class="card" id="winnerBox" style="display:none; margin-top:12px">
          <div class="row center" style="gap:12px">
            <button id="winA" class="btn ok">승자: <span id="nameA"></span></button>
            <button id="winB" class="btn warn">승자: <span id="nameB"></span></button>
          </div>
          <div style="text-align:center; margin-top:6px; color:var(--muted); font-size:13px">
            저장 후 자동 초기화됩니다.
          </div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:700; margin-bottom:6px">최근 저장</div>
        <ul id="recent" class="log"></ul>
        <div id="recentEmpty" style="color:var(--muted); font-size:13px">아직 기록이 없습니다.</div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast">Saved</div>

  <!-- 승률표 모달 -->
  <div id="statsModal" class="modal-wrap" role="dialog" aria-modal="true" aria-labelledby="statsTitle">
    <div class="modal">
      <header><div class="wrap" style="display:flex;align-items:center;gap:8px">
        <h2 id="statsTitle">개인 승률</h2>
        <div class="grow"></div>
        <button id="statsClose" class="btn ghost">닫기</button>
      </div></header>
      <div class="wrap" id="statsBody"></div>
    </div>
  </div>

  <!-- Firebase SDK (ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
<<<<<<< HEAD
    import { getDatabase, ref, child, get, set, push, update, onValue, query, orderByChild } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // ---- 0) Firebase ----
=======
    import {
      getDatabase, ref, push, onValue, query, orderByChild, limitToLast
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // 0) Firebase
>>>>>>> 73bb3c78ef1726971608a15eb8165c41434e6949
    const firebaseConfig = {
      apiKey: "AIzaSyC5iq3VY0QtBh8FVn70gi_Gsg7GXzkxdu8",
      authDomain: "koen-pingpong.firebaseapp.com",
      databaseURL: "https://koen-pingpong-default-rtdb.firebaseio.com",
      projectId: "koen-pingpong",
      storageBucket: "koen-pingpong.appspot.com",
      messagingSenderId: "597358811982",
      appId: "1:597358811982:web:b66dcb6a7159fb5f321c1f"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

<<<<<<< HEAD
    // ---- 1) 로그인 ----
    signInAnonymously(auth).catch(console.error);

    // ---- 2) 유틸 ----
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
    const toast = (msg='저장되었습니다')=>{ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600) };
    const fmtRate = (w,l)=> (w+l? ((w/(w+l))*100).toFixed(1):'0.0') + '%';

    function slugify(str){
      return str.replace(/[()]/g,'').replace(/\s+/g,'-').replace(/[^\p{L}\p{N}-]/gu,'').toLowerCase();
    }
    function includesHangul(a,b){ return a.toLowerCase().includes((b||'').toLowerCase()); }

    // ---- 3) 기본 선수 목록 ----
=======
    // 유틸
    const $ = (sel, ctx=document)=>ctx.querySelector(sel);
    const toast = (msg='저장되었습니다')=>{
      const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600)
    };
    const slugify = (s)=> s.replace(/[()]/g,'').replace(/\s+/g,'-').replace(/[^\p{L}\p{N}-]/gu,'').toLowerCase();

    // 1) 기본 선수 (코드 기반)
>>>>>>> 73bb3c78ef1726971608a15eb8165c41434e6949
    const defaultPlayersRaw = [
      "김희영(4)","강성용(5)","김범일(5)","이영진(6)","박주민(6)","강다훈(6)",
      "박진우(7)","배성국(7)","이상준(7)","황경진(8)","양충현(8)","임춘근(9)",
      "박인찬(8)","전성무(9)","송창근(9)","김승일(9)","문우용(9)","김현곤(9)","오국환(9)","조보미(12)",
      "송은아(13)","이낭주(13)","이승철(13)","박나령(14)","고은선(14)","정승목(14)"
    ];

<<<<<<< HEAD
    async function ensurePlayers(){
      const snap = await get(ref(db,'players'));
      if(!snap.exists()){
        const batch = {};
        const seen = new Set();
        defaultPlayersRaw.forEach((s,i)=>{
          const m = s.match(/^(.*)\((\d+)\)$/);
          if(!m) return;
          const name = m[1];
          const level = Number(m[2]);
          let key = slugify(name);
          while(seen.has(key)) key = key + ("-"+(i+1));
          seen.add(key);
          batch[key] = { name, level, isActive:true, createdAt: Date.now() };
        });
        await set(ref(db,'players'), batch);
=======
    // 파싱 → [{id,name,level}]
    const players = defaultPlayersRaw.map((s,i)=>{
      const m = s.match(/^(.*)\((\d+)\)$/); if(!m) return null;
      const name = m[1]; const level = Number(m[2]);
      let id = slugify(name);
      return { id: id + '-' + i, name, level };
    }).filter(Boolean).sort((a,b)=> a.name.localeCompare(b.name,'ko'));

    // 2) UI: 칩, 선택, 승자 박스
    const state = { sel: [] }; // 단식: 2명 제한
    function renderChips(){
      const box = $('#chips'); box.innerHTML='';
      players.forEach(p=>{
        const btn = document.createElement('button');
        btn.className='chip';
        btn.textContent = `${p.name}(${p.level})`;
        if(state.sel.some(x=>x.id===p.id)) btn.classList.add('selected');
        btn.onclick = ()=>{
          const idx = state.sel.findIndex(x=>x.id===p.id);
          if(idx>=0) state.sel.splice(idx,1);
          else{
            if(state.sel.length>=2){ toast('단식은 두 명만 선택'); return; }
            state.sel.push(p);
          }
          renderChips(); renderWinnerBox();
        };
        box.appendChild(btn);
      });
    }
    function renderWinnerBox(){
      const wb = $('#winnerBox');
      if(state.sel.length===2){
        $('#nameA').textContent = state.sel[0].name;
        $('#nameB').textContent = state.sel[1].name;
        wb.style.display='';
      }else wb.style.display='none';
    }
    $('#clearSel').onclick=()=>{ state.sel=[]; renderChips(); renderWinnerBox(); };

    // 3) 저장 (Firebase /matches)
    async function saveWinner(side){
      if(state.sel.length!==2){ toast('두 선수를 먼저 선택하세요'); return; }
      const [a,b] = state.sel;
      const match = {
        ts: Date.now(),
        type: 'single',
        membersA: [a.id], membersB: [b.id],
        namesA: [a.name], namesB: [b.name],
        levelsA: [a.level], levelsB: [b.level],
        winnerSide: side,
        score: null,
        createdBy: (auth.currentUser && auth.currentUser.uid) || 'anon',
        createdAt: Date.now()
      };
      try{
        await push(ref(db,'matches'), match);
        toast('성적이 저장되었습니다');
        state.sel=[]; renderChips(); renderWinnerBox();
      }catch(e){
        console.error(e);
        toast(e?.message || '저장 실패');
>>>>>>> 73bb3c78ef1726971608a15eb8165c41434e6949
      }
    }
    $('#winA').onclick=()=>saveWinner('A');
    $('#winB').onclick=()=>saveWinner('B');

<<<<<<< HEAD
    // ---- 4) 탭 전환 ----
    const tabStart=$('#tabStart'), tabResult=$('#tabResult'), tabLevels=$('#tabLevels');
    const secStart=$('#secStart'), secResult=$('#secResult'), secLevels=$('#secLevels');
    function show(sec){ [secStart,secResult,secLevels].forEach(s=>s.classList.remove('active')); sec.classList.add('active');
      [tabStart,tabResult,tabLevels].forEach(b=>b.classList.remove('active'));
      if(sec===secStart) tabStart.classList.add('active');
      if(sec===secResult) tabResult.classList.add('active');
      if(sec===secLevels) tabLevels.classList.add('active');
    }
    tabStart.onclick=()=>show(secStart);
    tabResult.onclick=()=>show(secResult);
    tabLevels.onclick=()=>show(secLevels);

    // ---- 5) 선수/경기 데이터 로딩 ----
    let players = []; // [{id,name,level}]
    let playersById = {};
    let matches = []; // [{...}]

    function mapPlayers(obj){
      if(!obj) return [];
      const arr = Object.entries(obj).map(([id,v])=>({id, ...v})).sort((a,b)=> a.name.localeCompare(b.name,'ko'));
      playersById = Object.fromEntries(arr.map(p=>[p.id,p]));
      return arr;
    }

    onValue(ref(db,'players'), (snap)=>{
      players = mapPlayers(snap.val());
      renderAllUIs();
      renderLevelsTable();
    });

    // 전체 matches 실시간 수신 (승률표 계산용)
    onValue(query(ref(db,'matches'), orderByChild('ts')), (snap)=>{
      const val = snap.val()||{};
      matches = Object.values(val);
    });

    function filterPlayers(keyword){
      if(!keyword) return players;
      return players.filter(p=> includesHangul(p.name, keyword) );
    }

    // 칩 렌더 (칩 더블클릭/우클릭 → 승률표)
    function renderChips(container, keyword, onClick){
      const list = filterPlayers(keyword);
      container.innerHTML = '';
      list.forEach(p=>{
        const chip = document.createElement('button');
        chip.className = 'chip';
        chip.textContent = `${p.name}(${p.level})`;
        chip.onclick = ()=> onClick(p);
        chip.ondblclick = (e)=>{ e.preventDefault(); openStats(p.id); };
        chip.oncontextmenu = (e)=>{ e.preventDefault(); openStats(p.id); };
        container.appendChild(chip);
      });
    }

    // ---- 6) 공통 선택 상태(단식=1, 복식=2) ----
    function makeSelector(typeToggleId, chipsId, slotAId, slotBId, searchId, clearBtnId){
      const typeToggle = $(typeToggleId);
      const chipsEl = $(chipsId);
      const slotA = $(slotAId);
      const slotB = $(slotBId);
      const search = $(searchId);
      const clearBtn = $(clearBtnId);
      let type = 'single';
      let selA = []; let selB = [];

      function limit(){ return type==='single'?1:2 }

      function updateSlots(){
        const renderSlot = (slot, arr, side)=>{
          slot.innerHTML='';
          arr.forEach(p=>{
            const pill = document.createElement('span');
            pill.className='pill';
            pill.innerHTML = `<b class="name">${p.name}</b> (${p.level}) <button title="제거">×</button>`;
            pill.querySelector('button').onclick=()=>{ remove(side,p.id); };
            // 슬롯 안의 이름 클릭 → 승률표
            pill.querySelector('.name').onclick = ()=> openStats(p.id);
            slot.appendChild(pill);
          });
        };
        renderSlot(slotA, selA, 'A');
        renderSlot(slotB, selB, 'B');
      }

      function add(side, p){
        const arr = side==='A'? selA: selB;
        if(arr.some(x=>x.id===p.id)) return; // 중복 금지
        if(selA.concat(selB).some(x=>x.id===p.id)) return; // 교차 금지
        if(arr.length >= limit()) return; // 최대 인원
        arr.push(p); updateSlots(); updateGuide();
      }
      function remove(side, id){
        if(side==='A') selA = selA.filter(x=>x.id!==id); else selB = selB.filter(x=>x.id!==id);
        updateSlots(); updateGuide();
      }

      function hookToggle(){
        typeToggle.querySelectorAll('button').forEach(btn=>{
          btn.onclick=()=>{
            typeToggle.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            type = btn.dataset.v;
            // 초과 인원 잘라냄 (복식 지원)
            selA = selA.slice(0, limit()); selB = selB.slice(0, limit());
            updateSlots(); updateGuide(); renderChips(chipsEl, search.value, onChipClick);
          };
        })
      }

      function onChipClick(p){ add(selA.length<limit()? 'A':'B', p); }

      function wire(){
        hookToggle();
        renderChips(chipsEl, '', onChipClick);
        search.oninput = ()=> renderChips(chipsEl, search.value, onChipClick);
        clearBtn.onclick = ()=>{ selA=[]; selB=[]; updateSlots(); updateGuide(); };
      }

      function getState(){ return { type, selA, selB } }

      function setState({type:v, selA:a, selB:b}){
        type = v || type; selA = a||selA; selB = b||selB; updateSlots(); updateGuide();
        typeToggle.querySelectorAll('button').forEach(b=> b.classList.toggle('active', b.dataset.v===type));
      }

      function updateGuide(){}

      wire();
      return { getState, setState, updateGuide, add, remove, updateSlots, chipsEl };
    }

    // ---- 7) 경기시작 전용 가이드 & 저장(승자 버튼) ----
    const startSel = makeSelector('#startTypeToggle','#startChips','#startSlotA','#startSlotB','#startSearch','#startClearSel');
    function refreshStartGuide(){
      const {type, selA, selB} = startSel.getState();
      const g = $('#startGuide');
      const hA = Number($('#handicapA').value||0), hB = Number($('#handicapB').value||0);
      const need = type==='single'?1:2;
      if(selA.length!==need || selB.length!==need){
        g.textContent = '선수를 선택하면 여기에서 “누구(팀)에게 몇 점 주고 경기하라” 안내가 표시됩니다.';
        return;
      }
      const A = selA.map(p=>p.name).join(', '); const B = selB.map(p=>p.name).join(', ');
      const hand = (hA||hB)? ` (핸디: A ${hA}점, B ${hB}점)` : '';
      g.textContent = `${type==='single'?'단식':'복식'}: A팀(${A}) vs B팀(${B}) — 승자 버튼을 눌러 저장하세요.${hand}`;
    }
    ['handicapA','handicapB','startScore'].forEach(id=> $("#"+id).oninput=refreshStartGuide );
    startSel.updateGuide = refreshStartGuide;

    async function saveWinner(side){
      const {type, selA, selB} = startSel.getState();
      const need = type==='single'?1:2;
      if(selA.length!==need || selB.length!==need) return toast('선수를 먼저 선택하세요');
      const score = $('#startScore').value || '';
      const match = {
        ts: Date.now(), type,
        membersA: selA.map(p=>p.id), membersB: selB.map(p=>p.id),
        winnerSide: side, score: score||null,
        createdBy: (auth.currentUser&&auth.currentUser.uid)||'anon',
        createdAt: Date.now()
      };
      await push(ref(db,'matches'), match);
      toast('결과가 저장되었습니다');
      // 초기화
      $('#startScore').value=''; $('#handicapA').value=0; $('#handicapB').value=0;
      startSel.setState({ selA:[], selB:[] });
    }
    $('#winnerA').onclick=()=>saveWinner('A');
    $('#winnerB').onclick=()=>saveWinner('B');

    // ---- 8) 성적입력 폼 저장 ----
    const resSel = makeSelector('#resTypeToggle','#resChips','#resSlotA','#resSlotB','#resSearch','#resClearSel');
    function defaultDateTimeLocal(){
      const d = new Date();
      const pad=n=>String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    $('#resTime').value = defaultDateTimeLocal();

    async function saveResult(){
      const {type, selA, selB} = resSel.getState();
      const need = type==='single'?1:2;
      if(selA.length!==need || selB.length!==need) return toast('선수를 먼저 선택하세요');
      const winnerSide = $('#resWinner').value;
      const score = $('#resScore').value || '';
      const tsLocal = $('#resTime').value;
      const ts = tsLocal ? new Date(tsLocal).getTime() : Date.now();
      const match = {
        ts, type,
        membersA: selA.map(p=>p.id), membersB: selB.map(p=>p.id),
        winnerSide, score: score||null,
        createdBy: (auth.currentUser&&auth.currentUser.uid)||'anon',
        createdAt: Date.now()
      };
      await push(ref(db,'matches'), match);
      toast('성적이 저장되었습니다');
      // 초기화
      $('#resScore').value=''; $('#resWinner').value='A'; $('#resTime').value = defaultDateTimeLocal();
      resSel.setState({ selA:[], selB:[] });
    }
    $('#saveResult').onclick=saveResult;

    // ---- 9) 부수 확인/조정 + "이름 클릭→승률표" ----
    function renderLevelsTable(){
      const kw = $('#lvlSearch').value||'';
      const tbody = $('#lvlTbody');
      const list = filterPlayers(kw);
      tbody.innerHTML='';
      list.forEach(p=>{
        const tr = document.createElement('tr');
        const tdN = document.createElement('td');
        const nameBtn = document.createElement('button');
        nameBtn.textContent = p.name;
        nameBtn.style.cssText='background:none;border:0;color:#0f172a;font-size:15px;cursor:pointer;text-align:left;padding:0';
        nameBtn.onclick = ()=> openStats(p.id); // ← 클릭 시 승률표
        tdN.appendChild(nameBtn);
        tr.appendChild(tdN);

        const tdL = document.createElement('td'); tdL.textContent = p.level; tr.appendChild(tdL);

        const tdA = document.createElement('td');
        const box = document.createElement('div'); box.className='levelBox';
        const minus = document.createElement('button'); minus.textContent='-';
        const plus = document.createElement('button'); plus.textContent='+';
        const span = document.createElement('span'); span.textContent=p.level;
        minus.onclick= async()=>{ const v=Math.max(1, (p.level||1)-1); await update(ref(db,`players/${p.id}`),{level:v}); toast(`${p.name} 부수 ${p.level}→${v}`) };
        plus.onclick= async()=>{ const v=(p.level||1)+1; await update(ref(db,`players/${p.id}`),{level:v}); toast(`${p.name} 부수 ${p.level}→${v}`) };
        box.append(minus, span, plus); tdA.appendChild(box); tr.appendChild(tdA);
        tbody.appendChild(tr);
      })
    }
    $('#lvlSearch').oninput=renderLevelsTable;
    $('#refreshPlayers').onclick=()=>onValue(ref(db,'players'),()=>{}, {onlyOnce:true});

    function renderAllUIs(){
      renderChips($('#startChips'), $('#startSearch').value, (p)=> startSel.add(startSel.getState().selA.length < (startSel.getState().type==='single'?1:2) ? 'A':'B', p));
      renderChips($('#resChips'), $('#resSearch').value, (p)=> resSel.add(resSel.getState().selA.length < (resSel.getState().type==='single'?1:2) ? 'A':'B', p));
      startSel.updateGuide();
      renderLevelsTable();
    }

    // ---- 10) 승률표 계산 & 모달 ----
    function openStats(pid){
      const player = playersById[pid];
      if(!player){ return; }
      const name = player.name;

      // 이 선수가 참여한 경기
      const myMatches = matches.filter(m=> (m.membersA||[]).includes(pid) || (m.membersB||[]).includes(pid) );
      const total = myMatches.length;
      const isWin = (m)=> ((m.membersA||[]).includes(pid) && m.winnerSide==='A') || ((m.membersB||[]).includes(pid) && m.winnerSide==='B');
      const wins = myMatches.filter(isWin).length;
      const losses = total - wins;

      const singles = myMatches.filter(m=>m.type==='single');
      const singlesW = singles.filter(isWin).length;
      const singlesL = singles.length - singlesW;

      const doubles = myMatches.filter(m=>m.type==='double');
      const doublesW = doubles.filter(isWin).length;
      const doublesL = doubles.length - doublesW;

      // 파트너/상대 빈도 (복식 중심)
      const partnerMap = new Map(); // id -> {name, total, wins}
      const oppMap = new Map(); // id -> {name, total, winsAgainst}

      function addCount(map, id, won){
        if(!playersById[id]) return;
        const o = map.get(id) || { name: playersById[id].name, total:0, wins:0 };
        o.total += 1; if(won) o.wins += 1; map.set(id,o);
      }

      doubles.forEach(m=>{
        const inA = (m.membersA||[]).includes(pid);
        const team = inA ? (m.membersA||[]) : (m.membersB||[]);
        const opp = inA ? (m.membersB||[]) : (m.membersA||[]);
        const won = (inA && m.winnerSide==='A') || (!inA && m.winnerSide==='B');
        team.filter(x=>x!==pid).forEach(x=> addCount(partnerMap, x, won));
        opp.forEach(x=> addCount(oppMap, x, won)); // wins = 내 팀이 이겼을 때
      });

      const partners = Array.from(partnerMap.values()).sort((a,b)=> b.total-a.total).slice(0,5);
      const opps = Array.from(oppMap.values()).sort((a,b)=> b.total-a.total).slice(0,5);

      // 최근 10경기
      const recent = myMatches.slice().sort((a,b)=> b.ts-a.ts).slice(0,10).map(m=>{
        const inA = (m.membersA||[]).includes(pid);
        const oppTeamIds = inA ? (m.membersB||[]) : (m.membersA||[]);
        const oppNames = oppTeamIds.map(id=> playersById[id]?.name || id).join(', ');
        const result = isWin(m)?'W':'L';
        const when = new Date(m.ts||0).toLocaleString('ko-KR');
        const t = m.type==='double'?'복식':'단식';
        return `${when} · ${t} vs ${oppNames} → ${result}`;
      });

      // 모달 DOM 작성
      $('#statsTitle').textContent = `개인 승률 · ${name}`;
      $('#statsBody').innerHTML = `
        <div class="kv">
          <div>총 전적</div><div><span class="pill-sm">W ${wins}</span> <span class="pill-sm">L ${losses}</span> <span class="pill-sm">승률 ${fmtRate(wins,losses)}</span></div>
          <div>단식</div><div><span class="pill-sm">W ${singlesW}</span> <span class="pill-sm">L ${singlesL}</span> <span class="pill-sm">승률 ${fmtRate(singlesW,singlesL)}</span></div>
          <div>복식</div><div><span class="pill-sm">W ${doublesW}</span> <span class="pill-sm">L ${doublesL}</span> <span class="pill-sm">승률 ${fmtRate(doublesW,doublesL)}</span></div>
        </div>

        <div class="card" style="margin:10px 0">
          <div class="title">주요 파트너(복식)</div>
          <table class="table-like">
            <thead><tr><th>이름</th><th>전적</th><th>승률</th></tr></thead>
            <tbody>
              ${partners.map(p=>`<tr><td>${p.name}</td><td>${p.wins}승 ${p.total-p.wins}패</td><td>${fmtRate(p.wins, p.total-p.wins)}</td></tr>`).join('') || `<tr><td colspan="3" class="help">데이터 없음</td></tr>`}
            </tbody>
          </table>
        </div>

        <div class="card" style="margin:10px 0">
          <div class="title">주요 상대</div>
          <table class="table-like">
            <thead><tr><th>이름</th><th>전적</th><th>승률</th></tr></thead>
            <tbody>
              ${opps.map(o=>`<tr><td>${o.name}</td><td>${o.wins}승 ${o.total-o.wins}패</td><td>${fmtRate(o.wins, o.total-o.wins)}</td></tr>`).join('') || `<tr><td colspan="3" class="help">데이터 없음</td></tr>`}
            </tbody>
          </table>
        </div>

        <div class="card" style="margin:10px 0">
          <div class="title">최근 경기 (10)</div>
          <div class="help">${recent.length? recent.map(x=>`<div>• ${x}</div>`).join('') : '데이터 없음'}</div>
        </div>
      `;
      $('#statsModal').style.display='flex';
    }
    $('#statsClose').onclick = ()=> $('#statsModal').style.display='none';
    $('#statsModal').addEventListener('click', (e)=>{ if(e.target.id==='statsModal') $('#statsModal').style.display='none'; });

    // ---- 11) 시작 시퀀스 ----
    onAuthStateChanged(auth, async ()=>{
      await ensurePlayers();
      // players / matches onValue 훅이 렌더 담당
=======
    // 4) 최근 저장 표시
    function watchRecent(){
      const q = query(ref(db,'matches'), orderByChild('ts'), limitToLast(10));
      onValue(q, snap=>{
        const ul = $('#recent'), empty = $('#recentEmpty');
        ul.innerHTML='';
        const val = snap.val();
        if(!val){ empty.style.display=''; return; }
        empty.style.display='none';
        const arr = Object.values(val).sort((a,b)=>a.ts-b.ts);
        arr.forEach(m=>{
          const li = document.createElement('li');
          const A = m.namesA?.[0] || players.find(p=>p.id===m.membersA?.[0])?.name || 'A';
          const B = m.namesB?.[0] || players.find(p=>p.id===m.membersB?.[0])?.name || 'B';
          li.textContent = `${new Date(m.ts).toLocaleString()} · ${A} vs ${B} → 승자 ${m.winnerSide}`;
          ul.appendChild(li);
        });
      });
    }

    // 5) 시작
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, ()=>{
      renderChips(); renderWinnerBox();
      watchRecent();
>>>>>>> 73bb3c78ef1726971608a15eb8165c41434e6949
    });
  </script>
</body>
</html>
