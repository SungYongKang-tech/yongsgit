<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KOEN íƒêµ¬ Manager Â· ì„±ì ì…ë ¥</title>
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --card:#ffffff; --bg:#f5f7fb;
      --primary:#0d47a1; --accent:#2563eb; --danger:#ef4444; --ok:#16a34a;
      --shadow:0 8px 28px rgba(0,0,0,.08)
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; color:var(--ink); background:var(--bg)}
    header{position:sticky; top:0; z-index:20; background:#fff; border-bottom:1px solid #e5e7eb}
    .wrap{max-width:980px; margin:0 auto; padding:14px 16px}
    h1{margin:4px 0 6px; font-size:clamp(18px,4vw,24px); color:var(--primary)}
    main{max-width:980px; margin:12px auto; padding:0 16px 30px}
    .card{background:var(--card); border:1px solid #e5e7eb; border-radius:16px; padding:14px; box-shadow:var(--shadow); margin:12px 0}

    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{padding:10px 12px; border-radius:999px; border:1px solid #d1d5db; cursor:pointer; background:#eef2ff; font-size:15px}
    .chip.selected{outline:2px solid var(--accent); background:#fff}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row.center{justify-content:center}
    .btn{border:1px solid #d1d5db; border-radius:10px; padding:10px 14px; font-size:15px; cursor:pointer; background:#fff}
    .btn.ok{background:var(--ok); color:#fff; border-color:var(--ok)}
    .btn.warn{background:var(--danger); color:#fff; border-color:var(--danger)}
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}

    .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#111827; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; pointer-events:none; transition:.25s}
    .toast.show{opacity:1}

    /* ìµœê·¼ ì €ì¥ ë¦¬ìŠ¤íŠ¸ */
    ul.log{margin:8px 0 0 0; padding-left:18px}

    /* âœ… í—¤ë” ë²„íŠ¼ì´ í™•ì‹¤íˆ ë³´ì´ë„ë¡ ê°•ì œ */
    header a.btn.primary{
      display:inline-block;
      white-space:nowrap;
      background:var(--accent) !important;
      color:#fff !important;
      border-color:var(--accent) !important;
      outline:0;
    }
    @media (max-width:520px){
      header .row{justify-content:space-between}
      header a.btn.primary{flex:0 0 auto}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="gap:8px; align-items:center; justify-content:space-between">
        <h1 style="margin:4px 0 6px; font-size:clamp(18px,4vw,24px); color:var(--primary)">
          KOEN íƒêµ¬ Manager Â· ì„±ì ì…ë ¥
        </h1>
        <a id="reportBtn" href="monthly-report.html" class="btn primary">ğŸ“Š ì´ë²ˆë‹¬ ì„±ì  í™•ì¸í‘œ</a>
      </div>
    </div>
  </header>

  <main>
    <section class="active">
      <div class="card">
        <div class="row">
          <div style="font-size:14px; color:var(--muted)">
            ë‹¨ì‹: <b>ë‘ ì„ ìˆ˜</b>ë¥¼ ì„ íƒí•œ ë’¤ ì•„ë˜ <b>ìŠ¹ì ë²„íŠ¼</b>ì„ ëˆ„ë¥´ë©´ ì €ì¥ë©ë‹ˆë‹¤.
          </div>
          <button id="clearSel" class="btn" style="margin-left:auto">ì„ íƒ ì´ˆê¸°í™”</button>
        </div>

        <div id="chips" class="chips"></div>

        <div class="card" id="winnerBox" style="display:none; margin-top:12px">
          <div class="row center" style="gap:12px">
            <button id="winA" class="btn ok">ìŠ¹ì: <span id="nameA"></span></button>
            <button id="winB" class="btn warn">ìŠ¹ì: <span id="nameB"></span></button>
          </div>
          <div style="text-align:center; margin-top:6px; color:var(--muted); font-size:13px">
            ì €ì¥ í›„ ìë™ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.
          </div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:700; margin-bottom:6px">ìµœê·¼ ì €ì¥</div>
        <ul id="recent" class="log"></ul>
        <div id="recentEmpty" style="color:var(--muted); font-size:13px">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast">Saved</div>

  <!-- Firebase SDK (ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getDatabase, ref, push, onValue, query, orderByChild, limitToLast
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    /* âœ… í—¤ë” ë²„íŠ¼ì´ ì—†ì„ ë•Œ(ë°°í¬/ìºì‹œ ë“±) ìë™ ìƒì„± */
    (() => {
      const wrap = document.querySelector('header .wrap');
      const exists = document.getElementById('reportBtn');
      if (wrap && !exists) {
        const row = document.createElement('div');
        row.className = 'row';
        row.style.gap = '8px';
        row.style.alignItems = 'center';
        row.style.justifyContent = 'space-between';
        const h1 = document.createElement('h1');
        h1.textContent = 'KOEN íƒêµ¬ Manager Â· ì„±ì ì…ë ¥';
        h1.style.margin = '4px 0 6px';
        h1.style.fontSize = 'clamp(18px,4vw,24px)';
        h1.style.color = 'var(--primary)';
        const a = document.createElement('a');
        a.id = 'reportBtn';
        a.href = 'monthly-report.html';
        a.className = 'btn primary';
        a.textContent = 'ğŸ“Š ì´ë²ˆë‹¬ ì„±ì  í™•ì¸í‘œ';
        row.append(h1, a);
        wrap.appendChild(row);
      }
    })();

    // 0) Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyC5iq3VY0QtBh8FVn70gi_Gsg7GXzkxdu8",
      authDomain: "koen-pingpong.firebaseapp.com",
      databaseURL: "https://koen-pingpong-default-rtdb.firebaseio.com",
      projectId: "koen-pingpong",
      storageBucket: "koen-pingpong.appspot.com",
      messagingSenderId: "597358811982",
      appId: "1:597358811982:web:b66dcb6a7159fb5f321c1f"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ìœ í‹¸
    const $ = (sel, ctx=document)=>ctx.querySelector(sel);
    const toast = (msg='ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤')=>{
      const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600)
    };
    const slugify = (s)=> s.replace(/[()]/g,'').replace(/\s+/g,'-').replace(/[^\p{L}\p{N}-]/gu,'').toLowerCase();

    // 1) ê¸°ë³¸ ì„ ìˆ˜ (ì½”ë“œ ê¸°ë°˜)
    const defaultPlayersRaw = [
      "ê¹€í¬ì˜(4)","ê°•ì„±ìš©(5)","ê¹€ë²”ì¼(5)","ì´ì˜ì§„(6)","ë°•ì£¼ë¯¼(6)","ê°•ë‹¤í›ˆ(6)",
      "ë°•ì§„ìš°(7)","ë°°ì„±êµ­(7)","ì´ìƒì¤€(7)","í™©ê²½ì§„(8)","ì–‘ì¶©í˜„(8)","ì„ì¶˜ê·¼(9)",
      "ë°•ì¸ì°¬(8)","ì „ì„±ë¬´(9)","ì†¡ì°½ê·¼(9)","ê¹€ìŠ¹ì¼(9)","ë¬¸ìš°ìš©(9)","ê¹€í˜„ê³¤(9)","ì˜¤êµ­í™˜(9)","ì¡°ë³´ë¯¸(12)",
      "ì†¡ì€ì•„(13)","ì´ë‚­ì£¼(13)","ì´ìŠ¹ì² (13)","ë°•ë‚˜ë ¹(14)","ê³ ì€ì„ (14)","ì •ìŠ¹ëª©(14)"
    ];

    // íŒŒì‹± â†’ [{id,name,level}]
    const players = defaultPlayersRaw.map((s,i)=>{
      const m = s.match(/^(.*)\((\d+)\)$/); if(!m) return null;
      const name = m[1]; const level = Number(m[2]);
      let id = slugify(name);
      return { id: id + '-' + i, name, level };
    }).filter(Boolean).sort((a,b)=> a.name.localeCompare(b.name,'ko'));

    // 2) UI: ì¹©, ì„ íƒ, ìŠ¹ì ë°•ìŠ¤
    const state = { sel: [] }; // ë‹¨ì‹: 2ëª… ì œí•œ
    function renderChips(){
      const box = $('#chips'); box.innerHTML='';
      players.forEach(p=>{
        const btn = document.createElement('button');
        btn.className='chip';
        btn.textContent = `${p.name}(${p.level})`;
        if(state.sel.some(x=>x.id===p.id)) btn.classList.add('selected');
        btn.onclick = ()=>{
          const idx = state.sel.findIndex(x=>x.id===p.id);
          if(idx>=0) state.sel.splice(idx,1);
          else{
            if(state.sel.length>=2){ toast('ë‹¨ì‹ì€ ë‘ ëª…ë§Œ ì„ íƒ'); return; }
            state.sel.push(p);
          }
          renderChips(); renderWinnerBox();
        };
        box.appendChild(btn);
      });
    }
    function renderWinnerBox(){
      const wb = $('#winnerBox');
      if(state.sel.length===2){
        $('#nameA').textContent = state.sel[0].name;
        $('#nameB').textContent = state.sel[1].name;
        wb.style.display='';
      }else wb.style.display='none';
    }
    $('#clearSel').onclick=()=>{ state.sel=[]; renderChips(); renderWinnerBox(); };

    // 3) ì €ì¥ (Firebase /matches)
    // 3) ì €ì¥ (Firebase /matches)
async function saveWinner(side){
  if(state.sel.length!==2){ toast('ë‘ ì„ ìˆ˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”'); return; }
  const [a,b] = state.sel;

  // âœ… ì¶”ê°€: KST(Asia/Seoul) ê¸°ì¤€ monthKey("YYYY-MM") ê³„ì‚°
  const nowKST = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
  const monthKey = `${nowKST.getFullYear()}-${String(nowKST.getMonth()+1).padStart(2,'0')}`;

  // âœ… monthKeyë¥¼ í•¨ê»˜ ì €ì¥ (ts/createdAtì€ ê·¸ëŒ€ë¡œ ìˆ«ì ms)
  const match = {
    ts: Date.now(),
    monthKey,                 // â† ì¶”ê°€ë¨
    type: 'single',
    membersA: [a.id], membersB: [b.id],
    namesA: [a.name], namesB: [b.name],
    levelsA: [a.level], levelsB: [b.level],
    winnerSide: side,
    score: null,
    createdBy: (auth.currentUser && auth.currentUser.uid) || 'anon',
    createdAt: Date.now()
  };

  try{
    await push(ref(db,'matches'), match);
    toast('ì„±ì ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    state.sel=[]; renderChips(); renderWinnerBox();
  }catch(e){
    console.error(e);
    toast(e?.message || 'ì €ì¥ ì‹¤íŒ¨');
  }
}

    $('#winA').onclick=()=>saveWinner('A');
    $('#winB').onclick=()=>saveWinner('B');

    // 4) ìµœê·¼ ì €ì¥ í‘œì‹œ
    function watchRecent(){
      const q = query(ref(db,'matches'), orderByChild('ts'), limitToLast(10));
      onValue(q, snap=>{
        const ul = $('#recent'), empty = $('#recentEmpty');
        ul.innerHTML='';
        const val = snap.val();
        if(!val){ empty.style.display=''; return; }
        empty.style.display='none';
        const arr = Object.values(val).sort((a,b)=>a.ts-b.ts);
        arr.forEach(m=>{
          const A = m.namesA?.[0] || players.find(p=>p.id===m.membersA?.[0])?.name || 'A';
          const B = m.namesB?.[0] || players.find(p=>p.id===m.membersB?.[0])?.name || 'B';
          const winnerName = m.winnerSide === 'A' ? A : B;  // âœ… ìŠ¹ì ì´ë¦„ í‘œì‹œ
          const li = document.createElement('li');
          li.textContent = `${new Date(m.ts).toLocaleString()} Â· ${A} vs ${B} â†’ ìŠ¹ì ${winnerName}`;
          ul.appendChild(li);
        });
      });
    }

    // 5) ì‹œì‘
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, ()=>{
      renderChips(); renderWinnerBox();
      watchRecent();
    });
  </script>
</body>
</html>
