<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KOEN íƒêµ¬ Manager Â· ì„±ì ì…ë ¥</title>
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --card:#ffffff; --bg:#f5f7fb; --primary:#0d47a1; --accent:#2563eb; --danger:#ef4444; --ok:#16a34a;
      --chip:#eef2ff; --chip2:#e0f2fe; --chip3:#fef3c7; --shadow:0 8px 28px rgba(0,0,0,.08)
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; color:var(--ink); background:var(--bg)}
    header{position:sticky; top:0; z-index:20; background:#fff; border-bottom:1px solid #e5e7eb}
    .wrap{max-width:980px; margin:0 auto; padding:14px 16px}
    h1{margin:4px 0 6px; font-size:clamp(18px,4vw,24px); color:var(--primary)}

    main{max-width:980px; margin:12px auto; padding:0 16px 30px}
    .card{background:var(--card); border:1px solid #e5e7eb; border-radius:16px; padding:14px; box-shadow:var(--shadow); margin:12px 0}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row>.grow{flex:1}
    label{font-size:13px; color:var(--muted)}
    select, input[type="number"], .btn{border:1px solid #d1d5db; border-radius:10px; padding:10px 12px; font-size:15px; background:#fff}
    .btn{cursor:pointer; display:inline-flex; align-items:center; gap:8px}
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
    .btn.ghost{background:#fff}
    .btn.warn{background:var(--danger); color:#fff; border-color:var(--danger)}
    .btn.ok{background:var(--ok); color:#fff; border-color:var(--ok)}

    .chips{display:flex; flex-wrap:wrap; gap:6px; margin-top:8px}
    .chip{padding:8px 10px; border-radius:999px; border:1px solid #d1d5db; cursor:pointer; background:var(--chip)}
    .chip:hover{filter:brightness(0.97)}

    .slots{display:grid; grid-template-columns:1fr 24px 1fr; gap:10px; align-items:start; margin-top:8px}
    .slot{border:1px dashed #cbd5e1; min-height:44px; border-radius:10px; padding:8px; background:#fff}
    .slot .pill{display:inline-flex; padding:6px 10px; margin:4px; border-radius:999px; background:#e2e8f0; gap:6px; align-items:center}
    .slot .pill b{font-weight:600; cursor:pointer}
    .slot .pill button{border:0; background:transparent; cursor:pointer; color:#475569}
    .vs{display:grid; place-items:center; color:#64748b; font-weight:700}

    .help{font-size:13px; color:var(--muted)}
    .hint{font-size:12px; color:var(--muted); margin:6px 2px 0}
    .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#111827; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; pointer-events:none; transition:.25s}
    .toast.show{opacity:1}

    /* ìŠ¹ë¥ í‘œ ëª¨ë‹¬ */
    .modal-wrap{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:16px; z-index:50}
    .modal{background:#fff; width:min(720px, 96vw); max-height:92vh; overflow:auto; border-radius:16px; box-shadow:var(--shadow); border:1px solid #e5e7eb}
    .modal header{position:sticky; top:0; background:#fff; border-bottom:1px solid #e5e7eb}
    .modal .wrap{padding:12px 16px}
    .modal h2{margin:0; font-size:18px}
    .kv{display:grid; grid-template-columns:140px 1fr; gap:6px; margin:8px 0}
    .pill-sm{display:inline-block; padding:4px 8px; border-radius:999px; background:#eef2ff; border:1px solid #dbe2ff; margin:2px}
    .table-like{width:100%; border-collapse:collapse; margin-top:6px}
    .table-like th, .table-like td{border-bottom:1px solid #e5e7eb; padding:6px 8px; text-align:left}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>KOEN íƒêµ¬ Manager Â· ì„±ì ì…ë ¥</h1>
    </div>
  </header>

  <main>
    <!-- âœ… ì„±ì ì…ë ¥ ë‹¨ì¼ í™”ë©´ -->
    <section id="secResult" class="active">
      <div class="card">
        <div class="row">
          <label>ê²½ê¸° ì¢…ë¥˜</label>
          <div class="toggle" id="resTypeToggle" style="display:inline-flex; border:1px solid #d1d5db; border-radius:12px; overflow:hidden">
            <button data-v="single" class="active" style="padding:8px 12px; background:#111827; color:#fff; border:0; cursor:pointer">ë‹¨ì‹</button>
            <button data-v="double" style="padding:8px 12px; background:#fff; border:0; cursor:pointer">ë³µì‹</button>
          </div>
          <div class="grow"></div>
          <div class="row">
            <label>ì‹œê°</label>
            <input id="resTime" type="datetime-local">
          </div>
        </div>

        <!-- ğŸ”µ ì„ ìˆ˜ ë²„íŠ¼ ëª©ë¡ (ì´ˆì„±/ê²€ìƒ‰ ì—†ìŒ, ì „ì²´ ë°”ë¡œ í‘œì‹œ) -->
        <div class="card" style="margin-top:10px">
          <div class="chips" id="resChips"></div>
          <div class="hint">ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ Aâ†’Bâ†’Aâ†’B ìˆœì„œë¡œ ìë™ ë°°ì¹˜ë©ë‹ˆë‹¤. (ë³µì‹ì€ íŒ€ë‹¹ 2ëª…)</div>
        </div>

        <div class="slots">
          <div>
            <div class="help" style="margin:2px 4px 6px">AíŒ€</div>
            <div class="slot" id="resSlotA"></div>
            <div class="row" style="margin-top:6px">
              <button class="btn ghost" id="clearA">A ë¹„ìš°ê¸°</button>
            </div>
          </div>
          <div class="vs">VS</div>
          <div>
            <div class="help" style="margin:2px 4px 6px">BíŒ€</div>
            <div class="slot" id="resSlotB"></div>
            <div class="row" style="margin-top:6px">
              <button class="btn ghost" id="clearB">B ë¹„ìš°ê¸°</button>
            </div>
          </div>
        </div>
        <div class="row">
          <button class="btn ghost" id="clearAll">ì „ì²´ ì´ˆê¸°í™”</button>
        </div>

        <div class="row" style="margin-top:10px; gap:8px">
          <label>ìŠ¹ì</label>
          <select id="resWinner">
            <option value="A">AíŒ€</option>
            <option value="B">BíŒ€</option>
          </select>
          <label>ìŠ¤ì½”ì–´(ì„ íƒ)</label>
          <select id="resScore">
            <option value="">ìŠ¤ì½”ì–´ ì„ íƒ(ì„ íƒ)</option>
            <option>3-2</option><option>3-1</option><option>3-0</option>
            <option>2-1</option><option>2-0</option>
          </select>
          <button class="btn primary" id="saveResult">ì €ì¥</button>
        </div>
        <div class="hint">ì €ì¥ í›„ í¼ì´ ì´ˆê¸°í™”ë˜ì–´ ì—°ì† ì…ë ¥ì´ ë¹ ë¦…ë‹ˆë‹¤.</div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast">Saved</div>

  <!-- ìŠ¹ë¥ í‘œ ëª¨ë‹¬(ì„ ìˆ˜ ì´ë¦„ ë”ë¸”í´ë¦­/ìš°í´ë¦­ ì‹œ ì—´ë¦¼) -->
  <div id="statsModal" class="modal-wrap" role="dialog" aria-modal="true" aria-labelledby="statsTitle">
    <div class="modal">
      <header><div class="wrap" style="display:flex;align-items:center;gap:8px">
        <h2 id="statsTitle">ê°œì¸ ìŠ¹ë¥ </h2>
        <div class="grow"></div>
        <button id="statsClose" class="btn">ë‹«ê¸°</button>
      </div></header>
      <div class="wrap" id="statsBody"></div>
    </div>
  </div>

  <!-- Firebase SDK (ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref, get, set, push, update, onValue, query, orderByChild } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // ---- Firebase ----
    const firebaseConfig = {
      apiKey: "AIzaSyC5iq3VY0QtBh8FVn70gi_Gsg7GXzkxdu8",
      authDomain: "koen-pingpong.firebaseapp.com",
      databaseURL: "https://koen-pingpong-default-rtdb.firebaseio.com",
      projectId: "koen-pingpong",
      storageBucket: "koen-pingpong.firebasestorage.app",
      messagingSenderId: "597358811982",
      appId: "1:597358811982:web:b66dcb6a7159fb5f321c1f"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ---- ê³µí†µ ìœ í‹¸ ----
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const toast = (msg='ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤')=>{ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600) };
    const fmtRate = (w,l)=> (w+l? ((w/(w+l))*100).toFixed(1):'0.0') + '%';
    const slugify = (str)=> str.replace(/[()]/g,'').replace(/\s+/g,'-').replace(/[^\p{L}\p{N}-]/gu,'').toLowerCase();

    // ---- ê¸°ë³¸ ì„ ìˆ˜(ìµœì´ˆ ìë™ ë“±ë¡) ----
    const defaultPlayersRaw = [
      "ê¹€í¬ì˜(4)","ê°•ì„±ìš©(5)","ê¹€ë²”ì¼(5)","ì´ì˜ì§„(6)","ë°•ì£¼ë¯¼(6)","ê°•ë‹¤í›ˆ(6)",
      "ë°•ì§„ìš°(7)","ë°°ì„±êµ­(7)","ì´ìƒì¤€(7)","í™©ê²½ì§„(8)","ì–‘ì¶©í˜„(8)","ì„ì¶˜ê·¼(9)",
      "ë°•ì¸ì°¬(8)","ì „ì„±ë¬´(9)","ì†¡ì°½ê·¼(9)","ê¹€ìŠ¹ì¼(9)","ë¬¸ìš°ìš©(9)","ê¹€í˜„ê³¤(9)","ì˜¤êµ­í™˜(9)","ì¡°ë³´ë¯¸(12)",
      "ì†¡ì€ì•„(13)","ì´ë‚­ì£¼(13)","ì´ìŠ¹ì² (13)","ë°•ë‚˜ë ¹(14)","ê³ ì€ì„ (14)","ì •ìŠ¹ëª©(14)"
    ];
    async function ensurePlayers(){
      const snap = await get(ref(db,'players'));
      if(!snap.exists()){
        const batch = {};
        const seen = new Set();
        defaultPlayersRaw.forEach((s,i)=>{
          const m = s.match(/^(.*)\((\d+)\)$/); if(!m) return;
          const name = m[1]; const level = Number(m[2]);
          let key = slugify(name); while(seen.has(key)) key = key + ("-"+(i+1));
          seen.add(key); batch[key] = { name, level, isActive:true, createdAt: Date.now() };
        });
        await set(ref(db,'players'), batch);
      }
    }

    // ---- ìƒíƒœ ----
    let players = [];         // [{id,name,level}]
    let playersById = {};
    let matches = [];         // ì €ì¥ëœ ê²½ê¸°(ìŠ¹ë¥ í‘œìš©)

    function mapPlayers(obj){
      if(!obj) return [];
      const arr = Object.entries(obj).map(([id,v])=>({id, ...v})).sort((a,b)=> a.name.localeCompare(b.name,'ko'));
      playersById = Object.fromEntries(arr.map(p=>[p.id,p]));
      return arr;
    }

    // ì‹¤ì‹œê°„ ë¡œë”©
    onValue(ref(db,'players'), (snap)=>{ players = mapPlayers(snap.val()); renderResChips(); });
    onValue(query(ref(db,'matches'), orderByChild('ts')), (snap)=>{ matches = Object.values(snap.val()||{}); });

    // ---- ì„±ì ì…ë ¥: ì„ íƒê¸° ----
    const resTypeToggle = $('#resTypeToggle');
    let resType = 'single';
    let selA = []; let selB = [];
    function limit(){ return resType==='single'?1:2 }

    resTypeToggle.querySelectorAll('button').forEach(btn=>{
      btn.onclick=()=>{
        resTypeToggle.querySelectorAll('button').forEach(b=>{ b.classList.remove('active'); b.style.background='#fff'; b.style.color='#000'; });
        btn.classList.add('active'); btn.style.background='#111827'; btn.style.color='#fff';
        resType = btn.dataset.v;
        selA = selA.slice(0,limit()); selB = selB.slice(0,limit());
        renderSlots();
      };
    });

    // ì „ì²´ ì„ ìˆ˜ ë²„íŠ¼ ë Œë”ë§
    function renderResChips(){
      const container = $('#resChips');
      container.innerHTML = '';
      players.forEach(p=>{
        const chip=document.createElement('button');
        chip.className='chip'; chip.textContent=`${p.name}(${p.level})`;
        chip.onclick=()=> addToSlots(p);
        // ìŠ¹ë¥ í‘œ: ì´ë¦„ ë”ë¸”í´ë¦­/ìš°í´ë¦­
        chip.ondblclick=(e)=>{ e.preventDefault(); openStats(p.id); };
        chip.oncontextmenu=(e)=>{ e.preventDefault(); openStats(p.id); };
        container.appendChild(chip);
      });
    }

    function renderSlots(){
      const slotA = $('#resSlotA'); const slotB = $('#resSlotB');
      slotA.innerHTML=''; slotB.innerHTML='';
      const draw=(slot, arr, side)=>{
        arr.forEach(p=>{
          const pill = document.createElement('span');
          pill.className='pill';
          pill.innerHTML = `<b class="name">${p.name}</b> (${p.level}) <button title="ì œê±°">Ã—</button>`;
          pill.querySelector('button').onclick=()=> removeFromSlots(side,p.id);
          pill.querySelector('.name').onclick=()=> openStats(p.id);
          slot.appendChild(pill);
        });
      };
      draw(slotA, selA, 'A'); draw(slotB, selB, 'B');
    }

    // í´ë¦­í´ë¦­ ìë™ ë°°ì¹˜: A â†’ B â†’ A â†’ B â€¦
    function addToSlots(p){
      // ì´ë¯¸ ì„ íƒëœ ì„ ìˆ˜ëŠ” ë¬´ì‹œ
      if(selA.concat(selB).some(x=>x.id===p.id)) return;
      const need = limit();
      // ìš°ì„  ë¹ˆ íŒ€ë¶€í„° ë„£ê³ , ë‘ íŒ€ì´ ë™ì¼ ì¸ì› ìˆ˜ë©´ Aì— ë„£ê¸°
      const aLen = selA.length, bLen = selB.length;
      let target = null;
      if(aLen < need || bLen < need){
        if(aLen === bLen){ target = 'A'; }
        else if(aLen < bLen){ target = 'A'; }
        else { target = 'B'; }
      }
      if(!target) target = 'A';
      if(target==='A' && selA.length < need) selA.push(p);
      else if(target==='B' && selB.length < need) selB.push(p);
      else if(selA.length < need) selA.push(p);
      else if(selB.length < need) selB.push(p);
      renderSlots();
    }
    function removeFromSlots(side,id){
      if(side==='A') selA = selA.filter(x=>x.id!==id);
      else selB = selB.filter(x=>x.id!==id);
      renderSlots();
    }

    // ì´ˆê¸°í™” ë²„íŠ¼
    $('#clearA').onclick=()=>{ selA=[]; renderSlots(); };
    $('#clearB').onclick=()=>{ selB=[]; renderSlots(); };
    $('#clearAll').onclick=()=>{ selA=[]; selB=[]; renderSlots(); };

    // ---- ì €ì¥ ----
    function defaultDateTimeLocal(){
      const d = new Date(); const pad=n=>String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    $('#resTime').value = defaultDateTimeLocal();

    async function saveResult(){
      const need = limit();
      if(selA.length!==need || selB.length!==need) return toast('ì„ ìˆ˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”');
      const winnerSide = $('#resWinner').value;
      const score = $('#resScore').value || '';
      const tsLocal = $('#resTime').value;
      const ts = tsLocal ? new Date(tsLocal).getTime() : Date.now();
      const match = {
        ts, type: resType,
        membersA: selA.map(p=>p.id), membersB: selB.map(p=>p.id),
        winnerSide, score: score||null,
        createdBy: (auth.currentUser&&auth.currentUser.uid)||'anon',
        createdAt: Date.now()
      };
      await push(ref(db,'matches'), match);
      toast('ì„±ì ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
      // ì´ˆê¸°í™”
      $('#resScore').value=''; $('#resWinner').value='A'; $('#resTime').value = defaultDateTimeLocal();
      selA=[]; selB=[]; renderSlots();
    }
    $('#saveResult').onclick=saveResult;

    // ---- ìŠ¹ë¥ í‘œ ----
    function openStats(pid){
      const player = playersById[pid]; if(!player) return;
      const myMatches = matches.filter(m=> (m.membersA||[]).includes(pid) || (m.membersB||[]).includes(pid) );
      const isWin = (m)=> ((m.membersA||[]).includes(pid) && m.winnerSide==='A') || ((m.membersB||[]).includes(pid) && m.winnerSide==='B');
      const wins = myMatches.filter(isWin).length; const losses = myMatches.length - wins;

      const singles = myMatches.filter(m=>m.type==='single');
      const singlesW = singles.filter(isWin).length; const singlesL = singles.length - singlesW;

      const doubles = myMatches.filter(m=>m.type==='double');
      const doublesW = doubles.filter(isWin).length; const doublesL = doubles.length - doublesW;

      const partnerMap = new Map(), oppMap = new Map();
      function addCount(map, id, won){
        if(!playersById[id]) return;
        const o = map.get(id) || { name: playersById[id].name, total:0, wins:0 };
        o.total += 1; if(won) o.wins += 1; map.set(id,o);
      }
      doubles.forEach(m=>{
        const inA = (m.membersA||[]).includes(pid);
        const team = inA ? (m.membersA||[]) : (m.membersB||[]);
        const opp  = inA ? (m.membersB||[]) : (m.membersA||[]);
        const won = (inA && m.winnerSide==='A') || (!inA && m.winnerSide==='B');
        team.filter(x=>x!==pid).forEach(x=> addCount(partnerMap, x, won));
        opp.forEach(x=> addCount(oppMap, x, won));
      });

      const partners = Array.from(partnerMap.values()).sort((a,b)=> b.total-a.total).slice(0,5);
      const opps = Array.from(oppMap.values()).sort((a,b)=> b.total-a.total).slice(0,5);
      const recent = myMatches.slice().sort((a,b)=> b.ts-a.ts).slice(0,10).map(m=>{
        const inA = (m.membersA||[]).includes(pid);
        const oppTeamIds = inA ? (m.membersB||[]) : (m.membersA||[]);
        const oppNames = oppTeamIds.map(id=> playersById[id]?.name || id).join(', ');
        const result = isWin(m)?'W':'L';
        const when = new Date(m.ts||0).toLocaleString('ko-KR');
        const t = m.type==='double'?'ë³µì‹':'ë‹¨ì‹';
        return `${when} Â· ${t} vs ${oppNames} â†’ ${result}`;
      });

      $('#statsTitle').textContent = `ê°œì¸ ìŠ¹ë¥  Â· ${player.name}`;
      $('#statsBody').innerHTML = `
        <div class="kv">
          <div>ì´ ì „ì </div><div><span class="pill-sm">W ${wins}</span> <span class="pill-sm">L ${losses}</span> <span class="pill-sm">ìŠ¹ë¥  ${fmtRate(wins,losses)}</span></div>
          <div>ë‹¨ì‹</div><div><span class="pill-sm">W ${singlesW}</span> <span class="pill-sm">L ${singlesL}</span> <span class="pill-sm">ìŠ¹ë¥  ${fmtRate(singlesW,singlesL)}</span></div>
          <div>ë³µì‹</div><div><span class="pill-sm">W ${doublesW}</span> <span class="pill-sm">L ${doublesL}</span> <span class="pill-sm">ìŠ¹ë¥  ${fmtRate(doublesW,doublesL)}</span></div>
        </div>
        <div class="card" style="margin:10px 0">
          <div class="title">ì£¼ìš” íŒŒíŠ¸ë„ˆ(ë³µì‹)</div>
          <table class="table-like">
            <thead><tr><th>ì´ë¦„</th><th>ì „ì </th><th>ìŠ¹ë¥ </th></tr></thead>
            <tbody>
              ${partners.map(p=>`<tr><td>${p.name}</td><td>${p.wins}ìŠ¹ ${p.total-p.wins}íŒ¨</td><td>${fmtRate(p.wins, p.total-p.wins)}</td></tr>`).join('') || `<tr><td colspan="3" class="help">ë°ì´í„° ì—†ìŒ</td></tr>`}
            </tbody>
          </table>
        </div>
        <div class="card" style="margin:10px 0">
          <div class="title">ì£¼ìš” ìƒëŒ€</div>
          <table class="table-like">
            <thead><tr><th>ì´ë¦„</th><th>ì „ì </th><th>ìŠ¹ë¥ </th></tr></thead>
            <tbody>
              ${opps.map(o=>`<tr><td>${o.name}</td><td>${o.wins}ìŠ¹ ${o.total-o.wins}íŒ¨</td><td>${fmtRate(o.wins, o.total-o.wins)}</td></tr>`).join('') || `<tr><td colspan="3" class="help">ë°ì´í„° ì—†ìŒ</td></tr>`}
            </tbody>
          </table>
        </div>
        <div class="card" style="margin:10px 0">
          <div class="title">ìµœê·¼ ê²½ê¸° (10)</div>
          <div class="help">${recent.length? recent.map(x=>`<div>â€¢ ${x}</div>`).join('') : 'ë°ì´í„° ì—†ìŒ'}</div>
        </div>
      `;
      $('#statsModal').style.display='flex';
    }
    $('#statsClose').onclick = ()=> $('#statsModal').style.display='none';
    $('#statsModal').addEventListener('click', (e)=>{ if(e.target.id==='statsModal') $('#statsModal').style.display='none'; });

    // ---- ì‹œì‘ ----
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, async ()=>{ await ensurePlayers(); });

  </script>
</body>
</html>
