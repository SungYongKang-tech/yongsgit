<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>KOEN 탁구 · 관리자</title>
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --card:#fff; --bg:#f5f7fb;
      --primary:#0d47a1; --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
      --shadow:0 8px 28px rgba(0,0,0,.08)
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; color:var(--ink); background:var(--bg)}
    header{position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #e5e7eb}
    .wrap{max-width:1040px; margin:0 auto; padding:14px 16px}
    h1{margin:4px 0 6px; font-size:clamp(18px,4vw,24px); color:var(--primary)}
    main{max-width:1040px; margin:16px auto; padding:0 16px 40px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{border:1px solid #d1d5db; border-radius:10px; padding:8px 12px; font-size:14px; background:#fff; cursor:pointer}
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
    .btn.warn{background:#ef4444; color:#fff; border-color:#ef4444}
    .btn.ok{background:var(--ok); color:#fff; border-color:var(--ok)}
    .card{background:var(--card); border:1px solid #e5e7eb; border-radius:16px; padding:14px; box-shadow:var(--shadow); margin:12px 0}
    table{width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden}
    thead th{background:#f8fafc; border-bottom:1px solid #e5e7eb; padding:10px; font-size:14px; color:#334155; text-align:left}
    tbody td{border-bottom:1px solid #f1f5f9; padding:8px; font-size:14px}
    .muted{color:var(--muted)}
    input[type="text"], input[type="number"]{padding:6px 8px; font-size:14px}
    input[type="number"]{width:90px}
    .small{font-size:12px}
    .hint{color:#64748b; font-size:13px}
    .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#111827; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; pointer-events:none; transition:.25s}
    .toast.show{opacity:1}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <h1 style="margin-right:auto">KOEN 탁구 · 관리자</h1>
      <a class="btn" href="./">← 성적입력</a>
      <a class="btn" href="monthly-report.html">📊 이번달 성적표</a>
    </div>
    <div class="row">
      <span class="small muted">※ 복식 가중치, 숨김 선수, 삭제 비밀번호, 경기 기록 초기화 관리</span>
    </div>
  </div>
</header>

<main>
  <!-- 통계 옵션 -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div style="font-weight:700">통계 옵션</div>
    </div>
    <div class="grid cols-2" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:8px">
      <!-- 복식 가중치 -->
      <div class="card" style="margin:0">
        <div class="muted small" style="margin-bottom:6px">복식 가중치</div>
        <div class="row">
          <input id="doubleWeight" type="number" min="0" max="1" step="0.1" />
          <button id="saveDoubleWeight" class="btn primary">저장</button>
        </div>
        <div class="hint" style="margin-top:6px">예) 0.5 ⇒ 복식은 단식의 절반 가중</div>
      </div>

      <!-- 삭제 비밀번호 -->
      <div class="card" style="margin:0">
        <div class="muted small" style="margin-bottom:6px">삭제 비밀번호</div>
        <div class="row">
          <input id="deletePassword" type="text" placeholder="예: 7910" />
          <button id="saveDeletePassword" class="btn primary">저장</button>
        </div>
        <div class="hint" style="margin-top:6px">성적입력 화면에서 삭제 시 사용하는 4자리 비밀번호</div>
      </div>
    </div>
  </section>

  <!-- 숨김 선수 관리 -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div style="font-weight:700">숨김 선수 관리</div>
      <div class="small muted">숨김 처리 시 경기 입력 화면에 버튼이 표시되지 않습니다.</div>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="playerNameInput" type="text" placeholder="예: 송창근" />
      <button id="addHiddenPlayer" class="btn primary">숨김 추가</button>
    </div>
    <div class="hint" style="margin-top:6px">선수 이름을 정확히 입력 후 숨김 추가하세요.</div>

    <div style="overflow:auto; margin-top:14px">
      <table>
        <thead>
          <tr>
            <th>이름</th>
            <th>관리</th>
          </tr>
        </thead>
        <tbody id="hiddenPlayersTable"></tbody>
      </table>
    </div>
  </section>

  <!-- 데이터 관리 -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div style="font-weight:700; color:#b91c1c">데이터 관리</div>
      <div class="small muted">되돌릴 수 없으니 주의하세요.</div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="purgeMatches" class="btn warn">🗑️ 모든 경기 기록 삭제</button>
      <span class="hint">`matches` 전체를 삭제합니다.</span>
    </div>
  </section>
</main>

<div id="toast" class="toast">Saved</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getDatabase, ref, set, remove, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  // ===== Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyC5iq3VY0QtBh8FVn70gi_Gsg7GXzkxdu8",
    authDomain: "koen-pingpong.firebaseapp.com",
    databaseURL: "https://koen-pingpong-default-rtdb.firebaseio.com",
    projectId: "koen-pingpong",
    storageBucket: "koen-pingpong.appspot.com",
    messagingSenderId: "597358811982",
    appId: "1:597358811982:web:b66dcb6a7159fb5f321c1f"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // ===== Utils =====
  const $ = (s, ctx=document)=>ctx.querySelector(s);
  const toast = (msg='저장되었습니다')=>{
    const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600);
  };

  // ===== 복식 가중치 관리 =====
  onValue(ref(db,'config/doubleWeight'), (s)=>{
    $('#doubleWeight').value = (s.val() ?? 0.5);
  });
  $('#saveDoubleWeight').onclick = async()=>{
    const v = parseFloat($('#doubleWeight').value);
    if(!isFinite(v) || v<0 || v>1){ toast('0~1 사이의 수를 입력하세요'); return; }
    await set(ref(db,'config/doubleWeight'), v);
    toast('복식 가중치 저장');
  };

  // ===== 삭제 비밀번호 관리 =====
  let currentDeletePw = '7910';
  onValue(ref(db,'config/deletePassword'), (s)=>{
    $('#deletePassword').value = (s.val() ?? '7910');
    currentDeletePw = s.val() ?? '7910';
  });
  $('#saveDeletePassword').onclick = async()=>{
    const v = $('#deletePassword').value.trim();
    if(!v){ toast('비밀번호를 입력하세요'); return; }
    await set(ref(db,'config/deletePassword'), v);
    currentDeletePw = v;
    toast('삭제 비밀번호 저장');
  };

  // ===== 숨김 선수 관리 =====
  const hiddenPlayersRef = ref(db, 'hiddenPlayers');
  let hiddenPlayers = [];

  function renderHiddenPlayers() {
    const tbody = $('#hiddenPlayersTable');
    tbody.innerHTML = '';

    hiddenPlayers.forEach((name, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${name}</td>
        <td><button class="btn warn" onclick="removeHiddenPlayer(${index})">복구</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  onValue(hiddenPlayersRef, (snapshot) => {
    hiddenPlayers = snapshot.val() || [];
    renderHiddenPlayers();
  });

  // 숨김 추가
  $('#addHiddenPlayer').onclick = async () => {
    const name = $('#playerNameInput').value.trim();
    if (!name) { toast('이름을 입력하세요'); return; }
    if (hiddenPlayers.includes(name)) { toast('이미 숨김 처리된 선수입니다'); return; }

    hiddenPlayers.push(name);
    await set(hiddenPlayersRef, hiddenPlayers);
    $('#playerNameInput').value = '';
    toast(`${name} 숨김 추가 완료`);
  };

  // 숨김 해제
  window.removeHiddenPlayer = async (index) => {
    const name = hiddenPlayers[index];
    if (!confirm(`${name} 선수를 복구하시겠습니까?`)) return;
    hiddenPlayers.splice(index, 1);
    await set(hiddenPlayersRef, hiddenPlayers);
    toast(`${name} 복구 완료`);
  };

  // ===== 모든 경기 기록 삭제 =====
  async function purgeAllMatches(){
    const pw = prompt('삭제 비밀번호 4자리를 입력하세요.');
    if (pw !== currentDeletePw){ toast('비밀번호가 올바르지 않습니다'); return; }
    if (!confirm('정말 모든 경기 기록을 삭제할까요? 되돌릴 수 없습니다.')) return;
    await remove(ref(db, 'matches'));
    toast('모든 경기 기록을 삭제했습니다');
  }
  $('#purgeMatches').onclick = purgeAllMatches;

  // 시작
  signInAnonymously(auth).catch(console.error);
  onAuthStateChanged(auth, ()=>{ /* 자동 동기화 */ });
</script>
</body>
</html>
