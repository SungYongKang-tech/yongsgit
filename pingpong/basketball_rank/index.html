<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ğŸ€ ê²½ê¸° ì…ë ¥ rtdb</title>

<style>
@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

:root{
  --ink:#0f172a; --mut:#64748b; --bg:#f5f7fb; --card:#fff;
  --accent:#2563eb; --ok:#16a34a; --danger:#ef4444; --bd:#e5e7eb;
  --shadow:0 8px 28px rgba(0,0,0,.08); --r:14px;
}

*{box-sizing:border-box}
body{margin:0;font-family:Pretendard,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--ink);font-weight:650}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bd);z-index:10}
.hin{padding:14px 10px;text-align:center}
h1{margin:0 0 8px;color:var(--accent);font-weight:900;font-size:22px}
.row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center}

.btn{border:1px solid #d1d5db;border-radius:10px;padding:7px 12px;background:#fff;cursor:pointer;font-weight:800}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.ok{background:var(--ok);color:#fff;border-color:var(--ok)}

main{max-width:1060px;margin:0 auto;padding:12px}
.card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;margin:10px 0}
h3{margin:0 0 10px}
input{border:1px solid #cbd5e1;border-radius:10px;padding:10px 12px;font-weight:800}

.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:760px){ .grid2{grid-template-columns:1fr} }

.box{border:1px solid var(--bd);border-radius:12px;padding:12px;background:#fff}
.small{color:var(--mut);font-size:13px}

hr{border:none;border-top:1px solid #eef2f7;margin:12px 0}

.log{border-bottom:1px solid #eef2f7;padding:10px 6px;position:relative}
.log:last-child{border-bottom:none}
.log .t{font-size:13px;color:#334155;font-weight:900}
.log .m{font-size:15px;margin-top:4px}
.del{position:absolute;right:8px;top:8px;border:none;background:transparent;color:#9ca3af;cursor:pointer;font-size:18px}
.del:hover{color:var(--danger)}

.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;transition:.25s;z-index:500}
.toast.show{opacity:1}

/* âœ… ì„ ìˆ˜ ì„ íƒ ì¹© ê·¸ë¦¬ë“œ: ê´€ë¦¬ì ì„¤ì •(ê¸°ë³¸ 4ì—´) */
.chipgrid{
  --mcols: 4; /* JSê°€ ë®ì–´ì”€: config/uiMobileCols */
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(140px, 1fr));
  gap:10px;
  margin-top:12px;
}
@media (max-width: 640px){
  .chipgrid{
    grid-template-columns:repeat(var(--mcols), 1fr);
    gap:8px;
  }
}
.chipbtn{
  width:100%;
  min-width:0;
  border:1px solid var(--bd);
  background:#fff;
  border-radius:12px;

  /* PC ê¸°ì¤€ */
  padding:6px 4px;
  min-height:32px;

  cursor:pointer;
  font-weight:900;
  font-size:16px;
  line-height:1.2;

  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  transition:.12s;
}

/* âœ… ëª¨ë°”ì¼ ì „ìš© (ë” ì••ì¶•) */
@media (max-width: 640px){
  .chipbtn{
    padding:4px 2px;
    min-height:26px;
    font-size:13px;
    border-radius:10px;
  }
}

.chipbtn:hover{ transform:translateY(-1px); }
.chipbtn.selected{
  border-color:var(--accent);
  background:#fef08a;
}
.chipbtn.locked{
  opacity:.45;
  cursor:not-allowed;
  transform:none;
}

/* =========================
   âœ… A/B íŒ€ ë°•ìŠ¤ ìƒ‰ìƒ ë¶„ë¦¬
========================= */
.teamBoxA{
  border:1px solid #bfdbfe;
  background:linear-gradient(180deg, #eff6ff 0%, #ffffff 65%);
}
.teamBoxB{
  border:1px solid #fecaca;
  background:linear-gradient(180deg, #fff1f2 0%, #ffffff 65%);
}
.teamHead{
  display:flex; align-items:center; justify-content:space-between;
  gap:10px;
}
.badgeTeam{
  display:inline-flex; align-items:center; gap:8px;
  font-weight:950;
}
.dotA,.dotB{
  width:10px;height:10px;border-radius:50%;
  display:inline-block;
}
.dotA{background:#2563eb}
.dotB{background:#ef4444}

/* =========================
   âœ… ì„ íƒ ìš”ì•½ + ì ìˆ˜ ì…ë ¥ ì˜ì—­
========================= */
.matchCard{
  border:1px solid var(--bd);
  border-radius:14px;
  padding:14px;
  background:#fff;
}
.matchTitle{
  font-weight:950;
  font-size:16px;
  text-align:center;
}
.vsLine{
  margin-top:8px;
  font-weight:900;
  text-align:center;
  line-height:1.6;
}
.vsLine .a{color:#1d4ed8}
.vsLine .b{color:#b91c1c}
.scoreRow{
  margin-top:12px;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
.scoreRow input{
  width:110px;
  text-align:center;
  font-size:16px;
}
.scoreSep{
  font-weight:950;
  color:#334155;
  font-size:18px;
}
</style>
</head>

<body>
<header>
  <div class="hin">
    <h1 id="pageTitle">ğŸ€ ê²½ê¸° ì…ë ¥</h1>
    <div class="row">
      <button id="adminBtn" class="btn">âš™ ê´€ë¦¬ì</button>
      <button id="todayBtn" class="btn primary">ğŸ“Š ì˜¤ëŠ˜ì˜ ì „ì </button>
      <a href="monthly-report.html" class="btn primary">ğŸ“ˆ ì›”ê°„ ë¦¬í¬íŠ¸</a>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <h3>ê²½ê¸° ì…ë ¥</h3>

    <!-- âœ… (ë³€ê²½) ìƒë‹¨ì€ ì„ ìˆ˜ ì„ íƒë§Œ -->
    <div class="grid2">
      <div class="box teamBoxA">
        <div class="teamHead">
          <div class="badgeTeam"><span class="dotA"></span> AíŒ€ ì„ ìˆ˜</div>
          <div class="small">ì„ ìˆ˜ ì„ íƒ</div>
        </div>
        <div id="playersA" class="chipgrid"></div>
      </div>

      <div class="box teamBoxB">
        <div class="teamHead">
          <div class="badgeTeam"><span class="dotB"></span> BíŒ€ ì„ ìˆ˜</div>
          <div class="small">ì„ ìˆ˜ ì„ íƒ</div>
        </div>
        <div id="playersB" class="chipgrid"></div>
      </div>
    </div>

    <hr/>

    <!-- âœ… (ì¶”ê°€) ì„ íƒ ìš”ì•½ + ì ìˆ˜ ì…ë ¥ -->
    <div class="matchCard">
      <div class="matchTitle">ì„ íƒëœ ë§¤ì¹˜ì—…</div>
      <div id="matchSummary" class="vsLine small">
        AíŒ€ ì„ ìˆ˜ì™€ BíŒ€ ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
      </div>

      <div class="scoreRow">
        <input id="scoreA" type="number" inputmode="numeric" placeholder="AíŒ€ ë“ì " />
        <span class="scoreSep">:</span>
        <input id="scoreB" type="number" inputmode="numeric" placeholder="BíŒ€ ë“ì " />
      </div>

      <div class="row" style="margin-top:12px">
        <button id="saveGame" class="btn ok">âœ… ê²½ê¸° ì €ì¥</button>
        <button id="resetSel" class="btn">ì„ íƒ ì´ˆê¸°í™”</button>
      </div>

      <div class="small" style="text-align:center;margin-top:8px">
        â€» íŒ€ ì´ë¦„ ì…ë ¥ì€ ì œê±°í–ˆìŠµë‹ˆë‹¤. í•­ìƒ <b>AíŒ€ vs BíŒ€</b>ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.
      </div>
    </div>
  </section>

  <section class="card">
    <h3>ìµœê·¼ ê²½ê¸° ë¡œê·¸</h3>
    <div id="logs"></div>
  </section>
</main>

<!-- âœ… ì˜¤ëŠ˜ì˜ ì „ì  íŒì—… -->
<div id="todayResults"
     style="display:none; position:fixed; top:50%; left:50%;
            transform:translate(-50%,-50%);
            width:92%; max-width:440px; background:#fff;
            border-radius:16px; box-shadow:0 8px 28px rgba(0,0,0,0.2);
            padding:20px 20px 24px; z-index:200;">
  <button id="closeToday"
          style="position:absolute; top:10px; right:12px;
                 background:transparent; border:none;
                 font-size:22px; color:#9ca3af; cursor:pointer;">âœ–</button>
  <h3 style="text-align:center; color:#2563eb; margin-top:0; margin-bottom:12px;">
    ğŸ“Š ì˜¤ëŠ˜ì˜ ì „ì 
  </h3>
  <div id="todayList"
       style="font-size:16px; line-height:1.8; font-weight:900; text-align:center; color:#111;">
  </div>
</div>

<div id="toast" class="toast">ì €ì¥</div>

<script type="module">
import { db } from "./firebase.js";
import { ref, onValue, get, push, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const $ = (s)=>document.querySelector(s);
const toast = (m="ì™„ë£Œ")=>{
  const t=$("#toast"); t.textContent=m; t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1500);
};

const pad2 = (n)=>String(n).padStart(2,"0");
const isoNowKST = ()=>{
  const d = new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Seoul"}));
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
};
const monthKeyKST = ()=>{
  const d = new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Seoul"}));
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
};
const kstTime = (ts)=>{
  const d = new Date(ts);
  const k = new Date(d.toLocaleString("en-US",{timeZone:"Asia/Seoul"}));
  return `${k.getFullYear()}-${pad2(k.getMonth()+1)}-${pad2(k.getDate())} ${pad2(k.getHours())}:${pad2(k.getMinutes())}`;
};
const kstDateKey = (ts)=>{
  const d = new Date(new Date(ts).toLocaleString("en-US",{timeZone:"Asia/Seoul"}));
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
};

// ---- title
onValue(ref(db,"config/title"), s=>{
  const v = s.val() ?? "Basketball";
  document.title = `ğŸ€ ${v} ê²½ê¸° ì…ë ¥`;
  $("#pageTitle").textContent = `ğŸ€ ${v} ê²½ê¸° ì…ë ¥`;
});

// ---- admin gate
$("#adminBtn").onclick = async()=>{
  const snap = await get(ref(db,"config/adminPassword"));
  const saved = snap.exists()? String(snap.val()):"1234";
  const input = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
  if(input===null) return;
  if(input.trim() !== saved.trim()) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
  location.href="admin.html";
};

// ---- data caches
let PLAYERS = {};
let GAMES = {};
let deletePassword = "7910";

get(ref(db,"config/deletePassword")).then(s=>{
  if(s.exists()) deletePassword = String(s.val());
});

onValue(ref(db,"players"), snap=>{
  PLAYERS = snap.val() || {};
  renderPlayerPickers();
});

onValue(ref(db,"games"), snap=>{
  GAMES = snap.val() || {};
  renderLogs();
});

function playerArr(){
  return Object.entries(PLAYERS).map(([id,p])=>({id,...p}))
    .sort((a,b)=>String(a.name).localeCompare(String(b.name),'ko'));
}

// âœ… ì¹© ë²„íŠ¼ ë Œë”
function chipHtml(side, p){
  return `<button type="button" class="chipbtn" data-side="${side}" data-player="${p.id}">${p.name}</button>`;
}

function renderPlayerPickers(){
  const boxA = $("#playersA");
  const boxB = $("#playersB");
  const arr = playerArr();

  if(!arr.length){
    boxA.innerHTML = `<div class="small">ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ì„œ ë“±ë¡í•˜ì„¸ìš”.</div>`;
    boxB.innerHTML = `<div class="small">ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ì„œ ë“±ë¡í•˜ì„¸ìš”.</div>`;
    return;
  }

  boxA.innerHTML = arr.map(p=>chipHtml("A", p)).join("");
  boxB.innerHTML = arr.map(p=>chipHtml("B", p)).join("");

  document.querySelectorAll(".chipbtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      if(btn.classList.contains("locked")) return;
      btn.classList.toggle("selected");
      syncLocked();
      renderMatchSummary(); // âœ… ì¶”ê°€
    });
  });

  syncLocked();
  renderMatchSummary(); // âœ… ì¶”ê°€
}

// A/B ì¤‘ë³µ ì„ íƒ ë°©ì§€(ìë™ ì ê¸ˆ)
function syncLocked(){
  const selA = new Set([...document.querySelectorAll('.chipbtn[data-side="A"].selected')].map(b=>b.dataset.player));
  const selB = new Set([...document.querySelectorAll('.chipbtn[data-side="B"].selected')].map(b=>b.dataset.player));

  document.querySelectorAll('.chipbtn[data-side="B"]').forEach(b=>{
    const pid = b.dataset.player;
    if(selA.has(pid)){
      b.classList.add("locked");
      b.classList.remove("selected");
    }else{
      b.classList.remove("locked");
    }
  });

  document.querySelectorAll('.chipbtn[data-side="A"]').forEach(b=>{
    const pid = b.dataset.player;
    if(selB.has(pid)){
      b.classList.add("locked");
      b.classList.remove("selected");
    }else{
      b.classList.remove("locked");
    }
  });
}

// âœ… ì„ íƒ ìš”ì•½ ë Œë”
function selectedIds(side){
  return [...document.querySelectorAll(`.chipbtn[data-side="${side}"].selected`)].map(b=>b.dataset.player);
}
function namesFromIds(ids){
  const names = ids.map(id=>PLAYERS?.[id]?.name).filter(Boolean);
  return names.length ? names.join(", ") : "-";
}
function renderMatchSummary(){
  const aIds = selectedIds("A");
  const bIds = selectedIds("B");

  const box = $("#matchSummary");
  if(!aIds.length && !bIds.length){
    box.classList.add("small");
    box.innerHTML = `AíŒ€ ì„ ìˆ˜ì™€ BíŒ€ ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.`;
    return;
  }

  const aNames = namesFromIds(aIds);
  const bNames = namesFromIds(bIds);

  box.classList.remove("small");
  box.innerHTML = `
    <div><span class="a"><b>AíŒ€</b></span>: ${aNames}</div>
    <div style="margin:4px 0;font-weight:950;color:#334155;">vs</div>
    <div><span class="b"><b>BíŒ€</b></span>: ${bNames}</div>
  `;
}

// ---- reset
$("#resetSel").onclick = ()=>{
  document.querySelectorAll('.chipbtn.selected').forEach(b=>b.classList.remove("selected"));
  syncLocked();
  $("#scoreA").value=""; $("#scoreB").value="";
  renderMatchSummary();
  toast("ì´ˆê¸°í™” ì™„ë£Œ");
};

// ---- save game
$("#saveGame").onclick = async()=>{
  const playersA = selectedIds("A");
  const playersB = selectedIds("B");
  if(playersA.length===0 || playersB.length===0) return toast("ì–‘ íŒ€ ì„ ìˆ˜ëŠ” ìµœì†Œ 1ëª…ì”© ì„ íƒí•˜ì„¸ìš”");

  const scoreA = Number($("#scoreA").value);
  const scoreB = Number($("#scoreB").value);

  if(!Number.isFinite(scoreA) || !Number.isFinite(scoreB)) return toast("ë“ì ì„ ì…ë ¥í•˜ì„¸ìš”");
  if(scoreA < 0 || scoreB < 0) return toast("ë“ì ì€ 0 ì´ìƒ");
  if(scoreA === scoreB) return toast("ë™ì ì€ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤(ì—°ì¥ í›„ ê²°ê³¼ ì…ë ¥)");

  const winner = scoreA > scoreB ? "A" : "B";

  // âœ… ì›”ê°„ë¦¬í¬íŠ¸ í˜¸í™˜ ìœ ì§€
  const obj = {
    date: isoNowKST(),
    monthKey: monthKeyKST(),
    teamAId: "A",
    teamBId: "B",
    scoreA, scoreB,
    playersA, playersB,
    winner,
    createdAt: Date.now()
  };

  await push(ref(db,"games"), obj);
  toast("ê²½ê¸° ì €ì¥ ì™„ë£Œ");
  $("#resetSel").click();
};

// ---- logs
function renderLogs(){
  const box=$("#logs");
  const arr = Object.entries(GAMES).map(([id,g])=>({id,...g}))
    .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0))
    .slice(0, 30);

  if(!arr.length){
    box.innerHTML = `<div class="small" style="text-align:center">ìµœê·¼ ê²½ê¸° ì—†ìŒ</div>`;
    return;
  }

  box.innerHTML = "";
  arr.forEach(g=>{
    const ta = "AíŒ€";
    const tb = "BíŒ€";
    const aNames = (g.playersA||[]).map(id=>PLAYERS?.[id]?.name).filter(Boolean).join(", ");
    const bNames = (g.playersB||[]).map(id=>PLAYERS?.[id]?.name).filter(Boolean).join(", ");

    const winText = g.winner==="A" ? `${ta} ìŠ¹` : `${tb} ìŠ¹`;
    const div=document.createElement("div");
    div.className="log";
    div.innerHTML = `
      <div class="t">${kstTime(g.createdAt)} / ${winText}</div>
      <div class="m">
        <b>${ta}</b> ${g.scoreA} : ${g.scoreB} <b>${tb}</b><br/>
        <span class="small">A(${aNames || "-"}) / B(${bNames || "-"})</span>
      </div>
      <button class="del" title="ì‚­ì œ" data-del="${g.id}">ğŸ—‘ï¸</button>
    `;
    div.querySelector("[data-del]").onclick = ()=>deleteGame(g.id);
    box.appendChild(div);
  });
}

async function deleteGame(id){
  const input = prompt("ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
  if(input===null) return;
  if(String(input).trim() !== String(deletePassword).trim()){
    return toast("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤");
  }
  if(!confirm("ì •ë§ ì´ ê²½ê¸° ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  await remove(ref(db,`games/${id}`));
  toast("ì‚­ì œ ì™„ë£Œ");
}

// ===== ì˜¤ëŠ˜ì˜ ì „ì  =====
let todayVisible = false;

function buildTodayHtml(){
  const todayKey = kstDateKey(Date.now());
  const todayGames = Object.values(GAMES).filter(g => g?.createdAt && kstDateKey(g.createdAt) === todayKey);

  if(!todayGames.length) return "ì˜¤ëŠ˜ ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤";

  const stats = {};
  todayGames.forEach(g=>{
    const aWin = g.winner === "A";
    (g.playersA || []).forEach(pid=>{
      if(!stats[pid]) stats[pid] = {win:0, lose:0};
      if(aWin) stats[pid].win++; else stats[pid].lose++;
    });
    (g.playersB || []).forEach(pid=>{
      if(!stats[pid]) stats[pid] = {win:0, lose:0};
      if(!aWin) stats[pid].win++; else stats[pid].lose++;
    });
  });

  const arr = Object.entries(stats).map(([pid,wl])=>{
    const name = PLAYERS?.[pid]?.name || `ë¯¸ë“±ë¡(${pid})`;
    const win = wl.win, lose = wl.lose;
    const total = win + lose;
    const score = win*2 - lose*1;
    return { pid, name, win, lose, total, score };
  }).sort((a,b)=>
    b.score - a.score ||
    b.win - a.win ||
    b.total - a.total ||
    a.name.localeCompare(b.name,'ko')
  );

  const maxWin = Math.max(...arr.map(x=>x.win));
  let html = "";

  arr.forEach((p,i)=>{
    const isTop = p.win === maxWin;
    const color = p.win >= p.lose ? "#1e40af" : "#111";
    const text = `${p.name} ${p.win}ìŠ¹${p.lose}íŒ¨`;

    html += `<span style="color:${color}; display:inline-block; width:48%; text-align:center; margin:6px 0;">
      ${isTop ? `<b>${text}</b>` : text}
    </span>`;
    if((i+1)%2===0) html += "<br>";
  });

  html += `<div style="margin-top:10px;color:#64748b;font-size:13px;font-weight:900;">
    ì˜¤ëŠ˜ ê²½ê¸° ìˆ˜: ${todayGames.length} ê²½ê¸°
  </div>`;

  return html;
}

document.getElementById("todayBtn").addEventListener("click", ()=>{
  const box  = document.getElementById("todayResults");
  const list = document.getElementById("todayList");

  if(todayVisible){
    box.style.display = "none";
    todayVisible = false;
    return;
  }

  const html = buildTodayHtml();
  if(html === "ì˜¤ëŠ˜ ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤"){
    toast(html);
    return;
  }

  list.innerHTML = html;
  box.style.display = "block";
  todayVisible = true;
});

document.getElementById("closeToday").addEventListener("click", ()=>{
  document.getElementById("todayResults").style.display = "none";
  todayVisible = false;
});

window.addEventListener("keydown", (e)=>{
  if(e.key === "Escape" && todayVisible){
    document.getElementById("todayResults").style.display = "none";
    todayVisible = false;
  }
});

// âœ… ëª¨ë°”ì¼ ì¹© ì—´ ìˆ˜(3/4) ê´€ë¦¬ì ì„¤ì •: config/uiMobileCols
onValue(ref(db, "config/uiMobileCols"), (snap)=>{
  let cols = Number(snap.val());
  if(!Number.isFinite(cols) || cols < 2 || cols > 6) cols = 4;
  document.documentElement.style.setProperty("--mcols", String(cols));
});
</script>
</body>
</html>
