<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ğŸ“ˆ ì›”ê°„ ë¦¬í¬íŠ¸</title>
<style>
@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
:root{
  --ink:#0f172a; --mut:#64748b; --bg:#f5f7fb; --card:#fff;
  --accent:#2563eb; --bd:#e5e7eb; --shadow:0 8px 28px rgba(0,0,0,.08); --r:14px;
  --win:#dc2626; --lose:#2563eb;
}
*{box-sizing:border-box}
body{margin:0;font-family:Pretendard,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--ink);font-weight:650}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bd);z-index:10}
.hin{padding:14px 10px;text-align:center}
h1{margin:0 0 6px;color:var(--accent);font-weight:900;font-size:22px}
.sub{color:var(--mut);font-size:13px;font-weight:800}
.row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center;margin-top:8px}
.btn{border:1px solid #d1d5db;border-radius:10px;padding:7px 12px;background:#fff;cursor:pointer;font-weight:900}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
main{max-width:980px;margin:0 auto;padding:12px}

.card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;margin:10px 0}

.table{width:100%;border-collapse:collapse;font-size:14px;overflow:hidden;border-radius:12px}
.table th,.table td{border-bottom:1px solid #eef2f7;padding:10px 8px;text-align:center;white-space:nowrap}
.table th{background:#f1f5f9;color:#334155;font-weight:900}
tbody tr:hover{background:#f9fafb}
.win{color:var(--win);font-weight:900}
.lose{color:var(--lose);font-weight:900}
.small{color:var(--mut);font-size:13px;font-weight:800}

.sectionHead{
  display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap;
  margin-bottom:10px;
}
.sectionHead h2{
  margin:0; font-size:16px; font-weight:950; color:#1e40af;
}
.metaLine{color:var(--mut);font-size:13px;font-weight:850}

/* âœ… TOP3 ì¹´ë“œ */
.summary{
  margin-top:14px;
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(240px, 1fr));
  gap:12px;
}
.summary .scard{
  background:var(--card);
  border:1px solid var(--bd);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  padding:14px 14px;
}
.summary h3{
  margin:0 0 10px;
  color:var(--accent);
  font-size:16px;
  font-weight:900;
}
.summary ul{
  margin:0;
  padding-left:18px;
  line-height:1.55;
  font-weight:850;
}
.summary li{ margin:4px 0; }
.summary .note{
  margin-top:8px;
  color:var(--mut);
  font-size:12.5px;
  font-weight:800;
}
</style>
</head>
<body>
<header>
  <div class="hin">
    <h1 id="pageTitle">ğŸ“ˆ ì›”ê°„ ë¦¬í¬íŠ¸</h1>
    <div class="sub" id="subTitle">ì„ ìˆ˜ë³„ ì„±ì </div>

    <div class="row">
      <button id="adminBtn" class="btn">âš™ ê´€ë¦¬ì</button>
      <button id="todayBtn" class="btn">ğŸ“Š ì˜¤ëŠ˜ì˜ ì „ì </button>
      <a href="index.html" class="btn primary">â¬… ê²½ê¸° ì…ë ¥</a>
    </div>
  </div>
</header>

<main>
  <!-- âœ… ì´ë²ˆë‹¬ -->
  <section class="card">
    <div class="sectionHead">
      <h2 id="thisMonthTitle">ì´ë²ˆë‹¬ ì„±ì </h2>
      <div class="metaLine" id="thisMeta"></div>
    </div>

    <table class="table">
      <thead>
        <tr>
          <th>ìˆœìœ„</th>
          <th>ì„ ìˆ˜</th>
          <th>ìŠ¹</th>
          <th>íŒ¨</th>
          <th>ê²½ê¸°</th>
          <th>ìŠ¹ë¥ </th>
        </tr>
      </thead>
      <tbody id="tbodyThis"></tbody>
    </table>

    <div class="small" style="text-align:center;margin-top:10px">
      â€» ìŠ¹ë¥  â†’ ê²½ê¸°ìˆ˜ â†’ ì´ë¦„ ìˆœìœ¼ë¡œ ì •ë ¬í•©ë‹ˆë‹¤.
    </div>

    <!-- âœ… ì´ë²ˆë‹¬ TOP3 -->
    <div id="summaryThis" class="summary"></div>
  </section>

  <!-- âœ… ì§€ë‚œë‹¬(ë§¨ í•˜ë‹¨) -->
  <section class="card">
    <div class="sectionHead">
      <h2 id="lastMonthTitle">ì§€ë‚œë‹¬ ì„±ì </h2>
      <div class="metaLine" id="lastMeta"></div>
    </div>

    <table class="table">
      <thead>
        <tr>
          <th>ìˆœìœ„</th>
          <th>ì„ ìˆ˜</th>
          <th>ìŠ¹</th>
          <th>íŒ¨</th>
          <th>ê²½ê¸°</th>
          <th>ìŠ¹ë¥ </th>
        </tr>
      </thead>
      <tbody id="tbodyLast"></tbody>
    </table>

    <!-- âœ… ì§€ë‚œë‹¬ TOP3 -->
    <div id="summaryLast" class="summary"></div>
  </section>
</main>

<!-- âœ… ì˜¤ëŠ˜ì˜ ì „ì  íŒì—… -->
<div id="todayResults"
     style="display:none; position:fixed; top:50%; left:50%;
            transform:translate(-50%,-50%);
            width:92%; max-width:440px; background:#fff;
            border-radius:16px; box-shadow:0 8px 28px rgba(0,0,0,0.2);
            padding:20px 20px 24px; z-index:200;">
  <button id="closeToday"
          style="position:absolute; top:10px; right:12px;
                 background:transparent; border:none;
                 font-size:22px; color:#9ca3af; cursor:pointer;">âœ–</button>
  <h3 style="text-align:center; color:#2563eb; margin-top:0; margin-bottom:12px;">
    ğŸ“Š ì˜¤ëŠ˜ì˜ ì „ì 
  </h3>
  <div id="todayList"
       style="font-size:16px; line-height:1.8; font-weight:900; text-align:center; color:#111;">
  </div>
</div>

<script type="module">
import { db } from "./firebase.js";
import { ref, onValue, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const $ = (s)=>document.querySelector(s);
const pad2 = (n)=>String(n).padStart(2,"0");
const kstNow = ()=> new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Seoul"}));

const monthKeyKST = (d=kstNow()) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
const prevMonthKeyKST = ()=>{
  const d = kstNow();
  d.setDate(1);
  d.setMonth(d.getMonth()-1);
  return monthKeyKST(d);
};

const pct = (w,l)=>{
  const t = w+l;
  if(!t) return 0;
  return Math.round((w/t*100)*10)/10;
};

let PLAYERS = {};
let GAMES = {};

// ---- title
onValue(ref(db,"config/title"), s=>{
  const v = s.val() ?? "ìš°ë¦¬";
  document.title = `ğŸ“ˆ ${v} ì›”ê°„ ë¦¬í¬íŠ¸`;
  $("#pageTitle").textContent = `ğŸ“ˆ ${v} ì›”ê°„ ë¦¬í¬íŠ¸`;
});

// ---- admin gate
$("#adminBtn").onclick = async()=>{
  const snap = await get(ref(db,"config/adminPassword"));
  const saved = snap.exists()? String(snap.val()):"1234";
  const input = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
  if(input===null) return;
  if(input.trim() !== saved.trim()) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
  location.href="admin.html";
};

onValue(ref(db,"players"), snap=>{
  PLAYERS = snap.val() || {};
  drawAll();
});

onValue(ref(db,"games"), snap=>{
  GAMES = snap.val() || {};
  drawAll();
});

function computeRows(monthKey){
  const games = Object.values(GAMES).filter(g=>g?.monthKey===monthKey);

  const stat = {};
  games.forEach(g=>{
    const aWin = g.winner==="A";
    (g.playersA||[]).forEach(pid=>{
      if(!stat[pid]) stat[pid]={w:0,l:0};
      if(aWin) stat[pid].w++; else stat[pid].l++;
    });
    (g.playersB||[]).forEach(pid=>{
      if(!stat[pid]) stat[pid]={w:0,l:0};
      if(!aWin) stat[pid].w++; else stat[pid].l++;
    });
  });

  const rows = Object.entries(stat).map(([pid,wl])=>{
    const name = PLAYERS?.[pid]?.name || `ë¯¸ë“±ë¡(${pid})`;
    const w = wl.w, l = wl.l;
    const t = w+l;
    const r = pct(w,l);
    return { pid, name, w, l, t, r };
  })
  .sort((a,b)=>
    b.r - a.r ||
    b.t - a.t ||
    a.name.localeCompare(b.name,'ko')
  );

  return { rows, totalMatches: games.length };
}

function renderTable(tbodySel, rows){
  const tb = $(tbodySel);
  if(!rows.length){
    tb.innerHTML = `<tr><td colspan="6" class="small" style="text-align:center;padding:16px">ì €ì¥ëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
    return;
  }
  tb.innerHTML = rows.map((p,idx)=>`
    <tr>
      <td>${idx+1}</td>
      <td style="font-weight:900">${p.name}</td>
      <td class="win">${p.w}</td>
      <td class="lose">${p.l}</td>
      <td>${p.t}</td>
      <td style="font-weight:900">${p.r}%</td>
    </tr>
  `).join("");
}

function renderSummary(boxSel, rows, totalMatches){
  const box = $(boxSel);

  // âœ… ë°ì´í„° ì—†ì„ ë•Œ ì•ˆë‚´ ì¹´ë“œ í‘œì‹œ
  if(!rows.length){
    box.innerHTML = `
      <div class="scard" style="text-align:center">
        <h3>ğŸ… TOP3</h3>
        <div class="note" style="margin-top:6px">
          í•´ë‹¹ ì›” ê²½ê¸° ê¸°ë¡ì´ ì—†ì–´<br/>
          TOP3ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </div>
      </div>
    `;
    return;
  }

  // ---- ê¸°ì¡´ ë¡œì§
  const topPlay = rows.slice()
    .sort((a,b)=> b.t - a.t || a.name.localeCompare(b.name,'ko'))
    .slice(0,3);

  const topWin = rows.slice()
    .sort((a,b)=> b.w - a.w || (b.r - a.r) || a.name.localeCompare(b.name,'ko'))
    .slice(0,3);

  box.innerHTML = `
    <div class="scard">
      <h3>ğŸ® ìµœë‹¤ê²½ê¸° TOP3</h3>
      <ul>
        ${topPlay.map(p=>`<li>${p.name} (${p.t}ê²½ê¸°)</li>`).join("")}
      </ul>
      <div class="note">í•´ë‹¹ ì›” ì´ ê²½ê¸°: ${totalMatches} ê²½ê¸°</div>
    </div>

    <div class="scard">
      <h3>ğŸ† ë‹¤ìŠ¹ TOP3</h3>
      <ul>
        ${topWin.map(p=>`<li>${p.name} (${p.w}ìŠ¹)</li>`).join("")}
      </ul>
      <div class="note">ë™ë¥  ì‹œ ìŠ¹ë¥ /ì´ë¦„ ìˆœ</div>
    </div>
  `;
}


function drawAll(){
  const thisKey = monthKeyKST();
  const lastKey = prevMonthKeyKST();

  $("#thisMonthTitle").textContent = `ì´ë²ˆë‹¬ ì„±ì  (${thisKey})`;
  $("#lastMonthTitle").textContent = `ì§€ë‚œë‹¬ ì„±ì  (${lastKey})`;

  // ì´ë²ˆë‹¬ + TOP3
  const cur = computeRows(thisKey);
  renderTable("#tbodyThis", cur.rows);
  $("#thisMeta").textContent = `ì´ ê²½ê¸° ìˆ˜: ${cur.totalMatches} ê²½ê¸° / ì„ ìˆ˜ ìˆ˜: ${cur.rows.length}ëª…`;
  renderSummary("#summaryThis", cur.rows, cur.totalMatches);

  // ì§€ë‚œë‹¬ + TOP3
  const prev = computeRows(lastKey);
  renderTable("#tbodyLast", prev.rows);
  $("#lastMeta").textContent = `ì´ ê²½ê¸° ìˆ˜: ${prev.totalMatches} ê²½ê¸° / ì„ ìˆ˜ ìˆ˜: ${prev.rows.length}ëª…`;
  renderSummary("#summaryLast", prev.rows, prev.totalMatches);
}

// =========================
// âœ… ì˜¤ëŠ˜ì˜ ì „ì  (ì›”ê°„ë¦¬í¬íŠ¸ í˜ì´ì§€ìš©)
// =========================
const kstDateKey = (ts)=>{
  const d = new Date(new Date(ts).toLocaleString("en-US",{timeZone:"Asia/Seoul"}));
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
};

let todayVisible = false;

function buildTodayHtml(){
  const todayKey = kstDateKey(Date.now());
  const todayGames = Object.values(GAMES).filter(g => g?.createdAt && kstDateKey(g.createdAt) === todayKey);

  if(!todayGames.length) return "ì˜¤ëŠ˜ ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤";

  const stats = {};
  todayGames.forEach(g=>{
    const aWin = g.winner === "A";
    (g.playersA || []).forEach(pid=>{
      if(!stats[pid]) stats[pid] = {win:0, lose:0};
      if(aWin) stats[pid].win++; else stats[pid].lose++;
    });
    (g.playersB || []).forEach(pid=>{
      if(!stats[pid]) stats[pid] = {win:0, lose:0};
      if(!aWin) stats[pid].win++; else stats[pid].lose++;
    });
  });

  const arr = Object.entries(stats).map(([pid,wl])=>{
    const name = PLAYERS?.[pid]?.name || `ë¯¸ë“±ë¡(${pid})`;
    const win = wl.win, lose = wl.lose;
    const total = win + lose;
    const score = win*2 - lose*1;
    return { pid, name, win, lose, total, score };
  }).sort((a,b)=>
    b.score - a.score ||
    b.win - a.win ||
    b.total - a.total ||
    a.name.localeCompare(b.name,'ko')
  );

  const maxWin = Math.max(...arr.map(x=>x.win));
  let html = "";

  arr.forEach((p,i)=>{
    const isTop = p.win === maxWin;
    const color = p.win >= p.lose ? "#1e40af" : "#111";
    const text = `${p.name} ${p.win}ìŠ¹${p.lose}íŒ¨`;

    html += `<span style="color:${color}; display:inline-block; width:48%; text-align:center; margin:6px 0;">
      ${isTop ? `<b>${text}</b>` : text}
    </span>`;
    if((i+1)%2===0) html += "<br>";
  });

  html += `<div style="margin-top:10px;color:#64748b;font-size:13px;font-weight:900;">
    ì˜¤ëŠ˜ ê²½ê¸° ìˆ˜: ${todayGames.length} ê²½ê¸°
  </div>`;

  return html;
}

document.getElementById("todayBtn").addEventListener("click", ()=>{
  const box  = document.getElementById("todayResults");
  const list = document.getElementById("todayList");

  if(todayVisible){
    box.style.display = "none";
    todayVisible = false;
    return;
  }

  const html = buildTodayHtml();
  if(html === "ì˜¤ëŠ˜ ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤"){
    alert(html);
    return;
  }

  list.innerHTML = html;
  box.style.display = "block";
  todayVisible = true;
});

document.getElementById("closeToday").addEventListener("click", ()=>{
  document.getElementById("todayResults").style.display = "none";
  todayVisible = false;
});

window.addEventListener("keydown", (e)=>{
  if(e.key === "Escape" && todayVisible){
    document.getElementById("todayResults").style.display = "none";
    todayVisible = false;
  }
});
</script>
</body>
</html>
