<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ğŸ“ˆ ì›”ê°„ ë¦¬í¬íŠ¸</title>
<style>
@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
:root{
  --ink:#0f172a; --mut:#64748b; --bg:#f5f7fb; --card:#fff;
  --accent:#2563eb; --bd:#e5e7eb; --shadow:0 8px 28px rgba(0,0,0,.08); --r:14px;
  --win:#dc2626; --lose:#2563eb;
}
*{box-sizing:border-box}
body{margin:0;font-family:Pretendard,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--ink);font-weight:650}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bd);z-index:10}
.hin{padding:14px 10px;text-align:center}
h1{margin:0 0 6px;color:var(--accent);font-weight:900;font-size:22px}
.sub{color:var(--mut);font-size:13px;font-weight:800}
.row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center;margin-top:8px}
.btn{border:1px solid #d1d5db;border-radius:10px;padding:7px 12px;background:#fff;cursor:pointer;font-weight:900}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
main{max-width:980px;margin:0 auto;padding:12px}

.card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;margin:10px 0}
.tools{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center}
select{border:1px solid #cbd5e1;border-radius:10px;padding:10px 12px;font-weight:800;background:#fff}

.table{width:100%;border-collapse:collapse;font-size:14px;overflow:hidden;border-radius:12px}
.table th,.table td{border-bottom:1px solid #eef2f7;padding:10px 8px;text-align:center;white-space:nowrap}
.table th{background:#f1f5f9;color:#334155;font-weight:900}
tbody tr:hover{background:#f9fafb}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;background:#e8f0ff;color:#1e40af;font-weight:900;font-size:12px}
.win{color:var(--win);font-weight:900}
.lose{color:var(--lose);font-weight:900}
.right{display:flex;justify-content:flex-end}
.small{color:var(--mut);font-size:13px;font-weight:800}

/* âœ… ìš”ì•½ ì¹´ë“œ ì˜ì—­ */
.summary{
  margin-top:14px;
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(240px, 1fr));
  gap:12px;
}
.summary .scard{
  background:var(--card);
  border:1px solid var(--bd);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  padding:14px 14px;
}
.summary h3{
  margin:0 0 10px;
  color:var(--accent);
  font-size:16px;
  font-weight:900;
}
.summary ul{
  margin:0;
  padding-left:18px;
  line-height:1.55;
  font-weight:850;
}
.summary li{ margin:4px 0; }
.summary .note{
  margin-top:8px;
  color:var(--mut);
  font-size:12.5px;
  font-weight:800;
}
</style>
</head>
<body>
<header>
  <div class="hin">
    <h1 id="pageTitle">ğŸ“ˆ ì›”ê°„ ë¦¬í¬íŠ¸</h1>
    <div class="sub" id="subTitle">ì„ ìˆ˜ë³„ ì„±ì </div>
    <div class="row">
      <a href="index.html" class="btn primary">â¬… ê²½ê¸° ì…ë ¥</a>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <div class="tools">
      <span class="badge">ì›” ì„ íƒ</span>
      <select id="monthSel"></select>
    </div>
    <div class="right" style="margin-top:10px">
      <div class="small" id="metaText"></div>
    </div>
  </section>

  <section class="card">
    <table class="table">
      <thead>
        <tr>
          <th>ìˆœìœ„</th>
          <th>ì„ ìˆ˜</th>
          <th>ìŠ¹</th>
          <th>íŒ¨</th>
          <th>ê²½ê¸°</th>
          <th>ìŠ¹ë¥ </th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="small" style="text-align:center;margin-top:10px">
      â€» ìŠ¹ë¥  â†’ ê²½ê¸°ìˆ˜ â†’ ì´ë¦„ ìˆœìœ¼ë¡œ ì •ë ¬í•©ë‹ˆë‹¤.
    </div>

    <!-- âœ… í‘œ ì•„ë˜ìª½(ìš”ì²­í•˜ì‹  ìœ„ì¹˜)ì— TOP3 ìš”ì•½ -->
    <div id="summary" class="summary"></div>
  </section>
</main>

<script type="module">
import { db } from "./firebase.js";
import { ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const $ = (s)=>document.querySelector(s);
const pad2 = (n)=>String(n).padStart(2,"0");
const kstNow = ()=> new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Seoul"}));
const monthKeyKST = (d=kstNow()) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
const pct = (w,l)=>{
  const t = w+l;
  if(!t) return 0;
  return Math.round((w/t*100)*10)/10; // ì†Œìˆ˜ 1ìë¦¬
};

let PLAYERS = {};
let GAMES = {};

onValue(ref(db,"config/title"), s=>{
  const v = s.val() ?? "ìš°ë¦¬";
  document.title = `ğŸ“ˆ ${v} ì›”ê°„ ë¦¬í¬íŠ¸`;
  $("#pageTitle").textContent = `ğŸ“ˆ ${v} ì›”ê°„ ë¦¬í¬íŠ¸`;
});

onValue(ref(db,"players"), snap=>{
  PLAYERS = snap.val() || {};
  render();
});

onValue(ref(db,"games"), snap=>{
  GAMES = snap.val() || {};
  render();
});

function render(){
  // ì›” ëª©ë¡ ë§Œë“¤ê¸° (games ê¸°ì¤€, ì—†ìœ¼ë©´ í˜„ì¬ì›”)
  const months = new Set();
  Object.values(GAMES).forEach(g=>{
    if(g?.monthKey) months.add(g.monthKey);
  });
  if(months.size===0) months.add(monthKeyKST());

  const monthArr = [...months].sort((a,b)=>String(b).localeCompare(String(a))); // ìµœì‹ ì›” ë¨¼ì €

  const sel = $("#monthSel");
  const current = sel.value || monthArr[0];

  sel.innerHTML = monthArr.map(m=>`<option value="${m}">${m}</option>`).join("");
  sel.value = monthArr.includes(current) ? current : monthArr[0];

  sel.onchange = ()=> draw(sel.value);

  draw(sel.value);
}

function draw(monthKey){
  const games = Object.values(GAMES).filter(g=>g?.monthKey===monthKey);

  // ì„ ìˆ˜ í†µê³„: pid -> {w,l}
  const stat = {};
  games.forEach(g=>{
    const aWin = g.winner==="A";
    (g.playersA||[]).forEach(pid=>{
      if(!stat[pid]) stat[pid]={w:0,l:0};
      if(aWin) stat[pid].w++; else stat[pid].l++;
    });
    (g.playersB||[]).forEach(pid=>{
      if(!stat[pid]) stat[pid]={w:0,l:0};
      if(!aWin) stat[pid].w++; else stat[pid].l++;
    });
  });

  const rows = Object.entries(stat).map(([pid,wl])=>{
    const name = PLAYERS?.[pid]?.name || `ë¯¸ë“±ë¡(${pid})`;
    const w = wl.w, l = wl.l;
    const t = w+l;
    const r = pct(w,l);
    return { pid, name, w, l, t, r };
  })
  .sort((a,b)=>
    b.r - a.r ||
    b.t - a.t ||
    a.name.localeCompare(b.name,'ko')
  );

  // í‘œì‹œ
  const tb = $("#tbody");
  if(rows.length===0){
    tb.innerHTML = `<tr><td colspan="6" class="small" style="text-align:center;padding:16px">ì´ ë‹¬ì— ì €ì¥ëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
  }else{
    tb.innerHTML = rows.map((p,idx)=>`
      <tr>
        <td>${idx+1}</td>
        <td style="font-weight:900">${p.name}</td>
        <td class="win">${p.w}</td>
        <td class="lose">${p.l}</td>
        <td>${p.t}</td>
        <td style="font-weight:900">${p.r}%</td>
      </tr>
    `).join("");
  }

  // ë©”íƒ€
  const totalMatches = games.length;
  $("#metaText").textContent = `${monthKey} / ì´ ê²½ê¸° ìˆ˜: ${totalMatches} ê²½ê¸° / ì„ ìˆ˜ ìˆ˜: ${rows.length}ëª…`;

  // âœ… TOP3 ìš”ì•½(í‘œ ì•„ë˜ìª½)
  renderSummary(rows, totalMatches);
}

function renderSummary(rows, totalMatches){
  const box = $("#summary");

  if(!rows.length){
    box.innerHTML = "";
    return;
  }

  // ìµœë‹¤ê²½ê¸° TOP3 (ê²½ê¸°ìˆ˜ t ê¸°ì¤€)
  const topPlay = rows.slice()
    .sort((a,b)=> b.t - a.t || a.name.localeCompare(b.name,'ko'))
    .slice(0,3);

  // ë‹¤ìŠ¹ TOP3 (ìŠ¹ w ê¸°ì¤€)
  const topWin = rows.slice()
    .sort((a,b)=> b.w - a.w || (b.r - a.r) || a.name.localeCompare(b.name,'ko'))
    .slice(0,3);

  box.innerHTML = `
    <div class="scard">
      <h3>ğŸ® ìµœë‹¤ê²½ê¸° TOP3</h3>
      <ul>
        ${topPlay.map(p=>`<li>${p.name} (${p.t}ê²½ê¸°)</li>`).join("")}
      </ul>
      <div class="note">í•´ë‹¹ ì›” ì´ ê²½ê¸°: ${totalMatches} ê²½ê¸°</div>
    </div>

    <div class="scard">
      <h3>ğŸ† ë‹¤ìŠ¹ TOP3</h3>
      <ul>
        ${topWin.map(p=>`<li>${p.name} (${p.w}ìŠ¹)</li>`).join("")}
      </ul>
      <div class="note">ë™ë¥  ì‹œ ìŠ¹ë¥ /ì´ë¦„ ìˆœ</div>
    </div>
  `;
}
</script>
</body>
</html>
