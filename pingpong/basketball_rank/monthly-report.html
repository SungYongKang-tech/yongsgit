<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ€ ì›”ê°„ ë¦¬í¬íŠ¸</title>
<style>
@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb;
  --accent:#2563eb; --danger:#ef4444; --shadow:0 8px 28px rgba(0,0,0,.08); --card:#fff;
}
body{
  margin:0;
  font-family:"Pretendard","Noto Sans KR",sans-serif;
  background:var(--bg); color:var(--ink); font-weight:600;
}
header{
  background:#fff; border-bottom:1px solid #e5e7eb;
  text-align:center; padding:14px 0; position:sticky; top:0; z-index:10;
}
h1{margin:4px 0 10px; color:var(--accent); font-size:clamp(18px,4vw,24px); font-weight:800;}
.row{display:flex;justify-content:center;gap:8px;margin-bottom:10px;flex-wrap:wrap}
.btn{
  border:1px solid #d1d5db; border-radius:8px; padding:6px 10px; font-size:14px;
  background:#fff; cursor:pointer; font-weight:700; transition:.15s;
}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
main{max-width:900px;margin:0 auto;padding:10px 10px 60px;}
table{
  width:100%; border-collapse:collapse; background:var(--card);
  box-shadow:var(--shadow); border-radius:12px; overflow:hidden; font-size:15px;
}
thead th{
  background:#f1f5f9;border-bottom:1px solid #e2e8f0;padding:10px 6px;
  text-align:center;color:#334155;font-weight:900;white-space:nowrap;
}
tbody td{border-bottom:1px solid #f1f5f9;padding:10px 6px;text-align:center;}
tbody tr:hover{background:#f9fafb}
.win{color:#dc2626;font-weight:900}
.lose{color:#2563eb;font-weight:900}
.small{color:var(--muted);font-size:13px;font-weight:650;text-align:center;margin-top:10px}
</style>
</head>

<body>
<header>
  <h1 id="pageHeader">ğŸ€ ì›”ê°„ ë¦¬í¬íŠ¸</h1>
  <div class="row">
    <button id="adminBtn" class="btn">âš™ ê´€ë¦¬ìëª¨ë“œ</button>
    <a href="index.html" class="btn primary">ê²½ê¸° ì…ë ¥</a>
  </div>
</header>

<main>
  <table>
    <thead>
      <tr>
        <th>ìˆœìœ„</th>
        <th>ì„ ìˆ˜</th>
        <th>ê²½ê¸°</th>
        <th>ìŠ¹/íŒ¨</th>
        <th>ìŠ¹ë¥ </th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div id="note" class="small"></div>
</main>

<script type="module">
import { db } from "./firebase.js";
import { ref, get, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const pad2 = (n)=>String(n).padStart(2,"0");
const monthKeyKST = ()=>{
  const d = new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Seoul"}));
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
};
const fmt1 = (n)=> (Math.round(n*10)/10).toFixed(1);

const titleRef  = ref(db, "config/title");
const gamesRef  = ref(db, "games");
const playersRef= ref(db, "players");

let PLAYERS = {}; // {id:{name}}
let GAMES = {};   // {id:{monthKey,playersA,playersB,winner}}

onValue(titleRef, snap=>{
  const title = snap.exists()? snap.val() : "Basketball";
  document.getElementById("pageHeader").textContent = `ğŸ€ ${title} ì›”ê°„ ë¦¬í¬íŠ¸ (${monthKeyKST()})`;
});

onValue(playersRef, snap=>{
  PLAYERS = snap.val() || {};
  render();
});
onValue(gamesRef, snap=>{
  GAMES = snap.val() || {};
  render();
});

// --- admin gate
document.getElementById("adminBtn").addEventListener("click", async ()=>{
  const s = await get(ref(db,"config/adminPassword"));
  const saved = s.exists()? String(s.val()) : "1234";
  const input = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
  if(input===null) return;
  if(String(input).trim() !== saved.trim()) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
  window.location.href = "admin.html";
});

function render(){
  const thisMonth = monthKeyKST();

  // ì´ë²ˆë‹¬ ê²½ê¸°ë§Œ
  const games = Object.values(GAMES).filter(g=>g?.monthKey===thisMonth);

  // player stats: pid -> {w,l}
  const stats = {};
  games.forEach(g=>{
    const aWin = g.winner==="A";
    const a = g.playersA || [];
    const b = g.playersB || [];

    a.forEach(pid=>{
      if(!stats[pid]) stats[pid]={w:0,l:0};
      if(aWin) stats[pid].w++; else stats[pid].l++;
    });
    b.forEach(pid=>{
      if(!stats[pid]) stats[pid]={w:0,l:0};
      if(!aWin) stats[pid].w++; else stats[pid].l++;
    });
  });

  const arr = Object.entries(stats)
    .map(([pid,s])=>{
      const p = PLAYERS[pid];
      if(!p) return null;
      const total = s.w + s.l;
      const rate = total ? (s.w/total*100) : 0;
      return { pid, name: p.name, win:s.w, lose:s.l, total, rate };
    })
    .filter(Boolean)
    // ì •ë ¬: ìŠ¹ë¥  â†“, ê²½ê¸°ìˆ˜ â†“, ì´ë¦„ â†‘
    .sort((a,b)=> b.rate-a.rate || b.total-a.total || a.name.localeCompare(b.name,'ko'));

  const tbody = document.getElementById("tbody");
  if(!arr.length){
    tbody.innerHTML = `<tr><td colspan="5" class="small">ì´ë²ˆë‹¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
    document.getElementById("note").textContent = "";
    return;
  }

  tbody.innerHTML = arr.map((p,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${p.name}</td>
      <td>${p.total}</td>
      <td><span class="win">${p.win}</span>/<span class="lose">${p.lose}</span></td>
      <td>${fmt1(p.rate)}%</td>
    </tr>
  `).join("");

  // ì°¸ê³ : ì´ ê²½ê¸° ìˆ˜(í•œ ê²½ê¸°ë‹¹ ì„ ìˆ˜í•©ê³„/íŒ€ì´ ë‹¬ë¼ë„ ê²½ê¸° ìˆ˜ëŠ” games ê°œìˆ˜)
  document.getElementById("note").textContent =
    `ì´ë²ˆë‹¬ ì´ ê²½ê¸° ìˆ˜: ${games.length} ê²½ê¸°`;
}
</script>
</body>
</html>
