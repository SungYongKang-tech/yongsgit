<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“ KOEN vs LH ë¦¬ê·¸ ì¸ì‚¬ì´íŠ¸</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --koen:#2563eb; --lh:#f97316;
  --bg:#f6f8fb; --card:#fff;
  --muted:#64748b; --ink:#0f172a;
  --shadow:0 6px 20px rgba(0,0,0,0.08);
}
* { box-sizing:border-box; font-family:"Pretendard","Noto Sans KR",sans-serif; }
body {
  margin:0;
  background:var(--bg);
  color:var(--ink);
  padding:18px;
  display:flex;
  flex-direction:column;
  align-items:center;
}
header { text-align:center; margin-bottom:16px; }
h1 { font-size:clamp(22px,5vw,28px); margin-bottom:6px; }
p { color:var(--muted); font-size:14px; }
section {
  width:100%;
  max-width:740px;
  background:var(--card);
  border-radius:16px;
  box-shadow:var(--shadow);
  padding:20px;
  margin-bottom:20px;
}
.section-title { text-align:center; font-size:18px; margin-bottom:10px; }
.winner-banner {
  text-align:center;
  background:linear-gradient(90deg,var(--koen),var(--lh));
  color:white;
  padding:12px;
  border-radius:12px;
  margin-bottom:8px;
  font-weight:600;
  box-shadow:0 4px 10px rgba(0,0,0,.1);
}
.chart-container {
  width:100%;
  height:380px;
  min-height:300px;
}
footer { text-align:center; color:var(--muted); font-size:13px; margin-top:10px; }

/* ğŸ§¾ ì§€í‘œ ì„¤ëª… */
.desc-box {
  margin-top:8px;
  font-size:13px;
  color:#475569;
  line-height:1.5;
  background:#f8fafc;
  border-radius:8px;
  padding:10px 14px;
}
.desc-box b { color:#1e3a8a; }
</style>
</head>
<body>
<header>
  <h1>ğŸ“ KOEN vs LH ë¦¬ê·¸ ì¸ì‚¬ì´íŠ¸</h1>
  <p id="monthText"></p>
</header>

<!-- ğŸ•¸ï¸ ì›”ê°„ ì¢…í•© ë¹„êµ -->
<section>
  <div class="winner-banner" id="winnerText">ë°ì´í„° ê³„ì‚° ì¤‘...</div>
  <div class="section-title">ğŸ•¸ï¸ 5ê°í˜• ì¢…í•© ë¹„êµ</div>
  <div class="chart-container"><canvas id="radarChart"></canvas></div>

  <!-- ğŸ“˜ ì§€í‘œ ì„¤ëª… -->
<div class="desc-box">
  <div style="display:flex;flex-direction:column;gap:6px;">
    <div><span style="color:#2563eb;">âš™ï¸ <b>í™œë™ì§€ìˆ˜</b></span> â€” ì „ì²´ ê²½ê¸° ì¤‘ íšŒì›ë“¤ì˜ ì‹¤ì œ ì°¸ì—¬ ë¹„ìœ¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</div>
    <div><span style="color:#7e22ce;">ğŸ“Š <b>ì°¸ì—¬ìœ¨</b></span> â€” íšŒì› 1ì¸ë‹¹ í‰ê·  ê²½ê¸° íšŸìˆ˜ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</div>
    <div><span style="color:#f97316;">ğŸ•’ <b>ì‹œê°„ëŒ€ì§€ìˆ˜</b></span> â€” í•˜ë£¨ ì¤‘ ê°€ì¥ ì§‘ì¤‘ëœ ê²½ê¸° ì‹œê°„ëŒ€ì˜ ë¹„ìœ¨(%)ì„ ëœ»í•©ë‹ˆë‹¤.</div>
  </div>
</div>

</section>

<!-- ğŸ“ˆ ë¶€ìˆ˜(Level) ë¶„í¬ -->
<section>
  <div class="section-title">ğŸ“ˆ ë¶€ìˆ˜(Level) ë¶„í¬ ë¹„êµ</div>
  <div class="chart-container"><canvas id="levelChart"></canvas></div>
</section>

<footer>Â© 2025 ë‚¨ë™ë³¸ì‚¬ & LH íƒêµ¬ë™í˜¸íšŒ</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// === ë‚ ì§œ ì„¤ì • ===
const now = new Date();
const year = now.getFullYear();
const month = String(now.getMonth() + 1).padStart(2, "0");
const monthKey = `${year}-${month}`;
document.getElementById("monthText").textContent = `${year}ë…„ ${month}ì›” ë¦¬ê·¸ í™œë™ ë¹„êµ`;

// === Firebase ì„¤ì • ===
const koenConfig = {
  apiKey:"AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain:"pingpongclub-4a5fd.firebaseapp.com",
  databaseURL:"https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId:"pingpongclub-4a5fd"
};
const lhConfig = {
  apiKey:"AIzaSyCM6FQqWaeI4Rx3ovD6OnhA_o-sgFvyWyI",
  authDomain:"pingpongclub2-6ce04.firebaseapp.com",
  databaseURL:"https://pingpongclub2-6ce04-default-rtdb.firebaseio.com",
  projectId:"pingpongclub2-6ce04"
};
const appKoen = initializeApp(koenConfig, "koen");
const appLh = initializeApp(lhConfig, "lh");
const dbKoen = getDatabase(appKoen);
const dbLh = getDatabase(appLh);

// === ê³„ì‚° í•¨ìˆ˜ ===
function calcTimeIndex(matches){
  if(!matches.length)return 0;
  const zones={morning:0,noon:0,evening:0,night:0};
  matches.forEach(m=>{
    const h=new Date(m.createdAt||0).getHours();
    if(h>=5&&h<11)zones.morning++;
    else if(h>=11&&h<15)zones.noon++;
    else if(h>=15&&h<21)zones.evening++;
    else zones.night++;
  });
  return ((Math.max(...Object.values(zones))/matches.length)*100).toFixed(1);
}
function calcLevelCount(players){
  const arr=new Array(14).fill(0);
  players.forEach(p=>{
    const lv=parseInt(p.level||0);
    if(lv>=1&&lv<=14)arr[lv-1]++;
  });
  return arr;
}

// === ì‹¤ì‹œê°„ ìˆ˜ì‹  ===
function listenClub(db, name, cb){
  const pRef = ref(db, "players");
  const mRef = ref(db, "matches");

  onValue(pRef, pSnap => {
    onValue(mRef, mSnap => {
      const players = pSnap.exists() ? Object.values(pSnap.val()) : [];
      const allMatches = mSnap.exists() ? Object.values(mSnap.val()) : [];
      const matches = allMatches.filter(m => {
        if (!m.createdAt) return false;
        const d = new Date(m.createdAt);
        return d.getFullYear() === now.getFullYear() && (d.getMonth() + 1) === (now.getMonth() + 1);
      });
      const memberCount = players.length;
      const games = matches.length;
      const activeRate = memberCount ? ((games / memberCount) * 10).toFixed(1) : 0;
      const score = Math.round(games * (activeRate / 100));
      const timeIndex = calcTimeIndex(matches);
      const levelCount = calcLevelCount(players);
      cb({ name, memberCount, games, activeRate, score, timeIndex, levelCount });
    });
  });
}

// === ë Œë”ë§ ===
let koen={}, lh={}, radar, level;
function render(koen, lh){
  const totalK = koen.score + parseFloat(koen.timeIndex);
  const totalL = lh.score + parseFloat(lh.timeIndex);
  const winner = totalK > totalL ? "KOEN ğŸ†" : totalK < totalL ? "LH ğŸ†" : "ë¬´ìŠ¹ë¶€ ğŸ¤";
  document.getElementById("winnerText").textContent = `${winner}ì´(ê°€) ${monthKey}ì›” ê°€ì¥ í™œë°œíˆ í™œë™í–ˆìŠµë‹ˆë‹¤!`;

  if (radar) radar.destroy();

  const labels = ["íšŒì›ìˆ˜", "ê²½ê¸°ìˆ˜", "ì°¸ì—¬ìœ¨", "í™œë™ì§€ìˆ˜", "ì‹œê°„ëŒ€ì§€ìˆ˜"];
  const koenVals = [koen.memberCount, koen.games, koen.activeRate, koen.score, koen.timeIndex];
  const lhVals = [lh.memberCount, lh.games, lh.activeRate, lh.score, lh.timeIndex];

  const normalize = (val, max) => max === 0 ? 0 : Math.min(100, (val / max) * 100);
  const koenData = koenVals.map((v, i) => normalize(v, Math.max(koenVals[i], lhVals[i])));
  const lhData = lhVals.map((v, i) => normalize(v, Math.max(koenVals[i], lhVals[i])));

  radar = new Chart(document.getElementById("radarChart"), {
    type: "radar",
    data: {
      labels,
      datasets: [
        { label: "KOEN", data: koenData, borderColor: "rgba(37,99,235,0.6)", backgroundColor: "rgba(37,99,235,0.25)", pointBackgroundColor: "#2563eb", borderWidth: 1, pointRadius: 3 },
        { label: "LH", data: lhData, borderColor: "rgba(249,115,22,0.6)", backgroundColor: "rgba(249,115,22,0.25)", pointBackgroundColor: "#f97316", borderWidth: 1, pointRadius: 3 }
      ]
    },
    options: {
      maintainAspectRatio: false,
      layout: { padding: { left: 50, right: 20, top: 20, bottom: 20 } },  // âœ… ì™¼ìª½ ì—¬ë°± í™•ë³´
      plugins: { legend: { position: "bottom" }, customLabels: { koenVals, lhVals } },
      scales: { r: { beginAtZero: true, ticks: { display: false }, pointLabels: { display: false } } }
    },
    plugins: [{
      id: "coloredLabels",
      afterDraw(chart) {
        const { ctx } = chart;
        const rScale = chart.scales.r;
        const cx = rScale.xCenter;
        const cy = rScale.yCenter;
        const radius = rScale.drawingArea * 0.85;
        const angleStep = (Math.PI * 2) / labels.length;

        ctx.save();
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.font = "13px Pretendard";

        labels.forEach((label, i) => {
          const angle = i * angleStep - Math.PI / 2;
          const x = cx + Math.cos(angle) * (radius + 20);
          const y = cy + Math.sin(angle) * (radius + 20);
          ctx.fillStyle = "#334155";
          ctx.fillText(label, x, y - 10);
          const kv = koenVals[i], lv = lhVals[i];
          const kw = ctx.measureText(kv).width, lw = ctx.measureText(lv).width, sw = ctx.measureText("/").width;
          let startX = x - (kw + lw + sw + 6) / 2;
          ctx.fillStyle = "#2563eb"; ctx.fillText(kv, startX + kw / 2, y + 10);
          startX += kw + 2; ctx.fillStyle = "#64748b"; ctx.fillText("/", startX + sw / 2, y + 10);
          startX += sw + 2; ctx.fillStyle = "#f97316"; ctx.fillText(lv, startX + lw / 2, y + 10);
        });
        ctx.restore();
      }
    }]
  });

  // === ë¶€ìˆ˜(Level) ê·¸ë˜í”„ ===
  if (level) level.destroy();
  const ctx = document.getElementById("levelChart");
  level = new Chart(ctx, {
    type: "line",
    data: {
      labels: Array.from({ length: 14 }, (_, i) => `Lv${i + 1}`),
      datasets: [
        { label: "KOEN", data: koen.levelCount, borderColor: "#2563eb", backgroundColor: "rgba(37,99,235,0.2)", fill: true, tension: 0.35 },
        { label: "LH", data: lh.levelCount, borderColor: "#f97316", backgroundColor: "rgba(249,115,22,0.2)", fill: true, tension: 0.35 }
      ]
    },
    options: { maintainAspectRatio: false, plugins: { legend: { position: "bottom" } }, scales: { y: { beginAtZero: true } } }
  });
}

// === ì‹¤í–‰ ===
listenClub(dbKoen, "koen", data => { koen = data; if (lh.name) render(koen, lh); });
listenClub(dbLh, "lh", data => { lh = data; if (koen.name) render(koen, lh); });
</script>
</body>
</html>
