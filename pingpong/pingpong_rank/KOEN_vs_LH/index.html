<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“ KOEN vs LH ë¦¬ê·¸ ì¸ì‚¬ì´íŠ¸</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --koen:#2563eb; --lh:#f97316; --bg:#f6f8fb; --card:#fff;
  --muted:#64748b; --ink:#0f172a; --shadow:0 6px 20px rgba(0,0,0,0.08);
}
*{box-sizing:border-box;font-family:"Pretendard","Noto Sans KR",sans-serif;}
body{margin:0;background:var(--bg);color:var(--ink);padding:18px;display:flex;flex-direction:column;align-items:center;}
header{text-align:center;margin-bottom:16px;}
h1{font-size:clamp(22px,5vw,28px);margin-bottom:6px;}
p{color:var(--muted);font-size:14px;}
section{width:100%;max-width:740px;background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:20px;margin-bottom:20px;}
.section-title{text-align:center;font-size:18px;margin-bottom:10px;}
.winner-banner{
  text-align:center;background:linear-gradient(90deg,var(--koen),var(--lh));
  color:white;padding:12px;border-radius:12px;margin-bottom:8px;
  font-weight:600;box-shadow:0 4px 10px rgba(0,0,0,.1);
}
.chart-container{
  width:100%;
  height300px;       /* ê¸°ì¡´ë³´ë‹¤ 1.5ë°° ë†’ê²Œ */
  min-height:380px;   /* ëª¨ë°”ì¼ì—ì„œë„ ì„¸ë¡œ ì—¬ìœ  ìœ ì§€ */
}

footer{text-align:center;color:var(--muted);font-size:13px;margin-top:10px;}
.insights{display:grid;gap:10px;margin-top:10px;}
.insight-card{
  background:var(--bg);border-left:4px solid var(--koen);
  padding:10px 12px;border-radius:8px;font-size:14px;line-height:1.5;
}
.insight-card.lh{border-left-color:var(--lh);}
</style>
</head>
<body>
<header>
  <h1>ğŸ“ KOEN vs LH ë¦¬ê·¸ ì¸ì‚¬ì´íŠ¸</h1>
  <p id="monthText"></p>
</header>

<section>
  <div class="winner-banner" id="winnerText">ë°ì´í„° ê³„ì‚° ì¤‘...</div>

  <div class="section-title">ğŸ•¸ï¸ 5ê°í˜• ì¢…í•© ë¹„êµ</div>
  <div class="chart-container"><canvas id="radarChart"></canvas></div>

  <!-- ğŸ“˜ ì§€í‘œ ì„¤ëª… -->
  <div style="margin-top:14px;font-size:14px;color:#334155;line-height:1.5;">
    <b>ğŸ“Š ì°¸ì—¬ìœ¨</b>ì€ íšŒì› 1ì¸ë‹¹ ê²½ê¸° í‰ê· ,<br>
    <b>âš™ï¸ í™œë™ì§€ìˆ˜</b>ëŠ” ì „ì²´ ê²½ê¸° ì°¸ì—¬ ë¹„ì¤‘,<br>
    <b>ğŸ•’ ì‹œê°„ëŒ€ì§€ìˆ˜</b>ëŠ” í•˜ë£¨ ì¤‘ ì§‘ì¤‘ëœ ê²½ê¸° ë¹„ìœ¨(%)ì„ ëœ»í•©ë‹ˆë‹¤.
  </div>
</section>

<section>
  <div class="section-title">ğŸ’¡ ì´ë²ˆ ë‹¬ ì£¼ìš” ì¸ì‚¬ì´íŠ¸</div>
  <div class="insights" id="insightBox">
    <div class="insight-card">ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div>
  </div>
</section>

<section>
  <div class="section-title">ğŸ“ˆ ë¶€ìˆ˜(Level) ë¶„í¬ ë¹„êµ</div>
  <div class="chart-container"><canvas id="levelChart"></canvas></div>
</section>

<footer>Â© 2025 ë‚¨ë™ë³¸ì‚¬ & LH íƒêµ¬ë™í˜¸íšŒ</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const now=new Date();
const year=now.getFullYear();
const month=String(now.getMonth()+1).padStart(2,"0");
const monthKey=`${year}-${month}`;
document.getElementById("monthText").textContent=`${year}ë…„ ${month}ì›” ë¦¬ê·¸ í™œë™ ë¹„êµ`;

const koenConfig={apiKey:"AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",authDomain:"pingpongclub-4a5fd.firebaseapp.com",databaseURL:"https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",projectId:"pingpongclub-4a5fd"};
const lhConfig={apiKey:"AIzaSyCM6FQqWaeI4Rx3ovD6OnhA_o-sgFvyWyI",authDomain:"pingpongclub2-6ce04.firebaseapp.com",databaseURL:"https://pingpongclub2-6ce04-default-rtdb.firebaseio.com",projectId:"pingpongclub2-6ce04"};

const appKoen=initializeApp(koenConfig,"koen");
const appLh=initializeApp(lhConfig,"lh");
const dbKoen=getDatabase(appKoen);
const dbLh=getDatabase(appLh);

function calcTimeIndex(matches){
  if(!matches.length)return 0;
  const zones={morning:0,noon:0,evening:0,night:0};
  matches.forEach(m=>{
    const h=new Date(m.createdAt||0).getHours();
    if(h>=5&&h<11)zones.morning++;
    else if(h>=11&&h<15)zones.noon++;
    else if(h>=15&&h<21)zones.evening++;
    else zones.night++;
  });
  return ((Math.max(...Object.values(zones))/matches.length)*100).toFixed(1);
}
function calcLevelCount(players){
  const arr=new Array(14).fill(0);
  players.forEach(p=>{const lv=parseInt(p.level||0);if(lv>=1&&lv<=14)arr[lv-1]++;});
  return arr;
}

function listenClub(db,name,cb){
  const pRef=ref(db,"players");
  const mRef=ref(db,`matches/${monthKey}`);
  onValue(pRef,pSnap=>{
    onValue(mRef,mSnap=>{
      const players=pSnap.exists()?Object.values(pSnap.val()):[];
      const matches=mSnap.exists()?Object.values(mSnap.val()):[];
      const memberCount=players.length;
      const games=matches.length;
      const activeRate=memberCount?((games/memberCount)*10).toFixed(1):0;
      const score=Math.round(games*(activeRate/100));
      const timeIndex=calcTimeIndex(matches);
      const levelCount=calcLevelCount(players);
      cb({name,memberCount,games,activeRate,score,timeIndex,levelCount});
    });
  });
}

let koen={}, lh={}, radar, level;
function render(koen,lh){
  const totalK=koen.score+parseFloat(koen.timeIndex);
  const totalL=lh.score+parseFloat(lh.timeIndex);
  const winner=totalK>totalL?"KOEN ğŸ†":totalK<totalL?"LH ğŸ†":"ë¬´ìŠ¹ë¶€ ğŸ¤";
  document.getElementById("winnerText").textContent=`${winner}ì´(ê°€) ${monthKey}ì›” ê°€ì¥ í™œë°œíˆ í™œë™í–ˆìŠµë‹ˆë‹¤!`;

  // ğŸ•¸ï¸ Radar Chart
  if(radar)radar.destroy();
  radar=new Chart(document.getElementById("radarChart"),{
    type:"radar",
    data:{
      labels:["íšŒì›ìˆ˜","ê²½ê¸°ìˆ˜","ì°¸ì—¬ìœ¨","í™œë™ì§€ìˆ˜","ì‹œê°„ëŒ€ì§€ìˆ˜"],
      datasets:[
        {label:"KOEN",data:[koen.memberCount,koen.games,koen.activeRate,koen.score,koen.timeIndex],
         borderColor:"rgba(37,99,235,0.6)",backgroundColor:"rgba(37,99,235,0.25)",borderWidth:1,pointRadius:3,pointBackgroundColor:"#2563eb"},
        {label:"LH",data:[lh.memberCount,lh.games,lh.activeRate,lh.score,lh.timeIndex],
         borderColor:"rgba(249,115,22,0.6)",backgroundColor:"rgba(249,115,22,0.25)",borderWidth:1,pointRadius:3,pointBackgroundColor:"#f97316"}
      ]
    },
    options:{plugins:{legend:{position:"bottom"}},scales:{r:{beginAtZero:true}}}
  });

  // ğŸ“ˆ Level Chart
if(level) level.destroy();
const ctx=document.getElementById("levelChart");
const gK=ctx.getContext("2d").createLinearGradient(0,0,0,450);
gK.addColorStop(0,"rgba(37,99,235,0.4)");
gK.addColorStop(1,"rgba(37,99,235,0)");
const gL=ctx.getContext("2d").createLinearGradient(0,0,0,450);
gL.addColorStop(0,"rgba(249,115,22,0.4)");
gL.addColorStop(1,"rgba(249,115,22,0)");
const labels=Array.from({length:14},(_,i)=>`Lv${i+1}`);

level=new Chart(ctx,{
  type:"line",
  data:{
    labels,
    datasets:[
      {
        label:"KOEN",
        data:koen.levelCount,
        fill:true,
        borderColor:"#2563eb",
        backgroundColor:gK,
        tension:0.35
      },
      {
        label:"LH",
        data:lh.levelCount,
        fill:true,
        borderColor:"#f97316",
        backgroundColor:gL,
        tension:0.35
      }
    ]
  },
  options:{
    maintainAspectRatio:false,  // âœ… ì„¸ë¡œ 600px ì ìš©ë¨
    responsive:true,
    plugins:{
      legend:{position:"bottom"},
      tooltip:{callbacks:{label:(ctx)=>`${ctx.dataset.label}: ${ctx.parsed.y}ëª…`}}
    },
    scales:{
      x:{grid:{display:false},ticks:{font:{size:11},color:"#444"}},
      y:{beginAtZero:true,grid:{color:"rgba(0,0,0,0.08)"},ticks:{stepSize:1,font:{size:11},color:"#555"}}
    }
  }
});


  // ğŸ’¬ ì¸ì‚¬ì´íŠ¸ ìƒì„±
  const box=document.getElementById("insightBox");
  box.innerHTML="";
  const insight=(text,cls="")=>{
    const d=document.createElement("div");
    d.className=`insight-card ${cls}`;
    d.textContent=text;
    box.appendChild(d);
  };
  if(koen.timeIndex>lh.timeIndex) insight(`KOENì€ íŠ¹ì • ì‹œê°„ëŒ€(${koen.timeIndex}% ì§‘ì¤‘) í™œë™ì´ í™œë°œí•©ë‹ˆë‹¤.`);
  else insight(`LHëŠ” íŠ¹ì • ì‹œê°„ëŒ€(${lh.timeIndex}% ì§‘ì¤‘) í™œë™ì´ ë” ê³ ë¥´ê²Œ ë¶„í¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`,`lh`);

  if(koen.games>lh.games) insight(`KOENì´ ì´ë²ˆ ë‹¬ ${koen.games-lh.games}ê²½ê¸° ë” ë§ì´ ì§„í–‰í–ˆìŠµë‹ˆë‹¤.`);
  else if(lh.games>koen.games) insight(`LHê°€ ì´ë²ˆ ë‹¬ ${lh.games-koen.games}ê²½ê¸° ë” ë§ì´ ì§„í–‰í–ˆìŠµë‹ˆë‹¤.`,`lh`);

  if(koen.activeRate>lh.activeRate) insight(`KOEN íšŒì›ì˜ í‰ê·  ì°¸ì—¬ìœ¨ì´ ${koen.activeRate}%ë¡œ ë†’ì•˜ìŠµë‹ˆë‹¤.`);
  else insight(`LH íšŒì›ì˜ í‰ê·  ì°¸ì—¬ìœ¨ì´ ${lh.activeRate}%ë¡œ ë†’ì•˜ìŠµë‹ˆë‹¤.`,`lh`);
}

// ì‹¤ì‹œê°„ ìˆ˜ì‹ 
listenClub(dbKoen,"koen",data=>{koen=data;if(lh.name)render(koen,lh);});
listenClub(dbLh,"lh",data=>{lh=data;if(koen.name)render(koen,lh);});
</script>
</body>
</html>
