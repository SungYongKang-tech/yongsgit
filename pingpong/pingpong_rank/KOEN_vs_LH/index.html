<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🏓 KOEN vs LH 리그 인사이트</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --koen:#2563eb; --lh:#f97316; --bg:#f6f8fb; --card:#fff;
  --muted:#64748b; --ink:#0f172a; --shadow:0 6px 20px rgba(0,0,0,0.08);
}
*{box-sizing:border-box;font-family:"Pretendard","Noto Sans KR",sans-serif;}
body{margin:0;background:var(--bg);color:var(--ink);padding:18px;display:flex;flex-direction:column;align-items:center;}
header{text-align:center;margin-bottom:16px;}
h1{font-size:clamp(22px,5vw,28px);margin-bottom:6px;}
p{color:var(--muted);font-size:14px;}
section{width:100%;max-width:740px;background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:20px;margin-bottom:20px;}
.section-title{text-align:center;font-size:18px;margin-bottom:10px;}
.winner-banner{
  text-align:center;background:linear-gradient(90deg,var(--koen),var(--lh));
  color:white;padding:12px;border-radius:12px;margin-bottom:8px;
  font-weight:600;box-shadow:0 4px 10px rgba(0,0,0,.1);
}
.chart-container{
  width:100%;
  height:400px;
  min-height:320px;
}
footer{text-align:center;color:var(--muted);font-size:13px;margin-top:10px;}
.insights{display:grid;gap:10px;margin-top:10px;}
.insight-card{
  background:var(--bg);border-left:4px solid var(--koen);
  padding:10px 12px;border-radius:8px;font-size:14px;line-height:1.5;
}
.insight-card.lh{border-left-color:var(--lh);}
</style>
</head>
<body>
<header>
  <h1>🏓 KOEN vs LH 리그 인사이트</h1>
  <p id="monthText"></p>
</header>

<!-- 🕸️ 월간 종합 비교 -->
<section>
  <div class="winner-banner" id="winnerText">데이터 계산 중...</div>
  <div class="section-title">🕸️ 5각형 종합 비교</div>
  <div class="chart-container"><canvas id="radarChart"></canvas></div>
</section>

<!-- 📆 일별 경기수 추이 -->
<section>
  <div class="section-title">📆 일별 경기수 추이</div>
  <div class="chart-container"><canvas id="dailyChart"></canvas></div>
</section>

<!-- 🏅 승률 분포 -->
<section>
  <div class="section-title">🏅 승률 분포 비교</div>
  <div style="display:flex;justify-content:space-around;flex-wrap:wrap;">
    <div style="width:45%;min-width:220px;"><canvas id="koenWinChart"></canvas></div>
    <div style="width:45%;min-width:220px;"><canvas id="lhWinChart"></canvas></div>
  </div>
</section>

<!-- 📈 부수(Level) 분포 -->
<section>
  <div class="section-title">📈 부수(Level) 분포 비교</div>
  <div class="chart-container"><canvas id="levelChart"></canvas></div>
</section>

<footer>© 2025 남동본사 & LH 탁구동호회</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// === 날짜 ===
const now=new Date();
const year=now.getFullYear();
const month=String(now.getMonth()+1).padStart(2,"0");
const monthKey=`${year}-${month}`;
document.getElementById("monthText").textContent=`${year}년 ${month}월 리그 활동 비교`;

// === Firebase 설정 ===
const koenConfig={apiKey:"AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",authDomain:"pingpongclub-4a5fd.firebaseapp.com",databaseURL:"https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",projectId:"pingpongclub-4a5fd"};
const lhConfig={apiKey:"AIzaSyCM6FQqWaeI4Rx3ovD6OnhA_o-sgFvyWyI",authDomain:"pingpongclub2-6ce04.firebaseapp.com",databaseURL:"https://pingpongclub2-6ce04-default-rtdb.firebaseio.com",projectId:"pingpongclub2-6ce04"};
const appKoen=initializeApp(koenConfig,"koen");
const appLh=initializeApp(lhConfig,"lh");
const dbKoen=getDatabase(appKoen);
const dbLh=getDatabase(appLh);

// === 유틸 ===
function calcTimeIndex(matches){
  if(!matches.length)return 0;
  const zones={morning:0,noon:0,evening:0,night:0};
  matches.forEach(m=>{
    const h=new Date(m.createdAt||0).getHours();
    if(h>=5&&h<11)zones.morning++;
    else if(h>=11&&h<15)zones.noon++;
    else if(h>=15&&h<21)zones.evening++;
    else zones.night++;
  });
  return ((Math.max(...Object.values(zones))/matches.length)*100).toFixed(1);
}
function calcLevelCount(players){
  const arr=new Array(14).fill(0);
  players.forEach(p=>{
    const lv=parseInt(p.level||0);
    if(lv>=1&&lv<=14)arr[lv-1]++;
  });
  return arr;
}
function calcDailyData(matches){
  const days=Array(31).fill(0);
  matches.forEach(m=>{
    const d=new Date(m.createdAt||0).getDate();
    days[d-1]++;
  });
  return days;
}
function calcWinData(matches, clubName) {
  let win = 0, lose = 0;

  matches.forEach(m => {
    if (!m.winner) return;

    const w = String(m.winner).toLowerCase();

    // ✅ 여러 경우 커버
    if (["a", "koen", "승자a", "team_a"].includes(w) && clubName === "koen") win++;
    else if (["b", "lh", "승자b", "team_b"].includes(w) && clubName === "koen") lose++;
    else if (["b", "lh", "승자b", "team_b"].includes(w) && clubName === "lh") win++;
    else if (["a", "koen", "승자a", "team_a"].includes(w) && clubName === "lh") lose++;

    // ✅ 혹시 승자이름이 들어오는 경우도 감지 (예: "김승일" 등)
    if (w.includes("koen") && clubName === "koen") win++;
    if (w.includes("lh") && clubName === "lh") win++;
  });

  return { win, lose };
}


// === 실시간 리스너 ===
function listenClub(db, name, cb) {
  const pRef = ref(db, "players");
  const mRef = ref(db, "matches"); // ✅ 전체 matches 감시
  onValue(pRef, pSnap => {
    onValue(mRef, mSnap => {
      const players = pSnap.exists() ? Object.values(pSnap.val()) : [];
      const allMatches = mSnap.exists() ? Object.values(mSnap.val()) : [];

      // ✅ 이번 달에 해당하는 경기만 필터
      const matches = allMatches.filter(m => {
        if (!m.createdAt) return false;
        const d = new Date(m.createdAt);
        return d.getFullYear() === now.getFullYear() && d.getMonth() + 1 === now.getMonth() + 1;
      });

      const memberCount = players.length;
      const games = matches.length;
      const activeRate = memberCount ? ((games / memberCount) * 10).toFixed(1) : 0;
      const score = Math.round(games * (activeRate / 100));
      const timeIndex = calcTimeIndex(matches);
      const levelCount = calcLevelCount(players);
      const dailyData = calcDailyData(matches);
      const winData = calcWinData(matches);
      cb({ name, memberCount, games, activeRate, score, timeIndex, levelCount, dailyData, winData });
    });
  });
}


// === 렌더링 ===
let koen={}, lh={}, radar, daily, level, winK, winL;
function render(koen,lh){
  const totalK=koen.score+parseFloat(koen.timeIndex);
  const totalL=lh.score+parseFloat(lh.timeIndex);
  const winner=totalK>totalL?"KOEN 🏆":totalK<totalL?"LH 🏆":"무승부 🤝";
  document.getElementById("winnerText").textContent=`${winner}이(가) ${monthKey}월 가장 활발히 활동했습니다!`;

  // 🕸️ Radar
  if(radar)radar.destroy();
  radar=new Chart(document.getElementById("radarChart"),{
    type:"radar",
    data:{
      labels:["회원수","경기수","참여율","활동지수","시간대지수"],
      datasets:[
        {label:"KOEN",data:[koen.memberCount,koen.games,koen.activeRate,koen.score,koen.timeIndex],borderColor:"rgba(37,99,235,0.6)",backgroundColor:"rgba(37,99,235,0.25)"},
        {label:"LH",data:[lh.memberCount,lh.games,lh.activeRate,lh.score,lh.timeIndex],borderColor:"rgba(249,115,22,0.6)",backgroundColor:"rgba(249,115,22,0.25)"}
      ]
    },
    options:{maintainAspectRatio:false,plugins:{legend:{position:"bottom"}},scales:{r:{beginAtZero:true}}}
  });

  // 📆 일별 경기수
  if(daily)daily.destroy();
  const days=Array.from({length:31},(_,i)=>`${i+1}일`);
  daily=new Chart(document.getElementById("dailyChart"),{
    type:"line",
    data:{
      labels:days,
      datasets:[
        {label:"KOEN",data:koen.dailyData,borderColor:"#2563eb",backgroundColor:"rgba(37,99,235,0.1)",fill:true,tension:0.3},
        {label:"LH",data:lh.dailyData,borderColor:"#f97316",backgroundColor:"rgba(249,115,22,0.1)",fill:true,tension:0.3}
      ]
    },
    options:{maintainAspectRatio:false,plugins:{legend:{position:"bottom"}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}
  });

  // 🏅 승률
 if(winK)winK.destroy(); 
if(winL)winL.destroy();

const safeData = (d) => (d.win + d.lose === 0 ? [1,0] : [d.win, d.lose]);

winK = new Chart(document.getElementById("koenWinChart"), {
  type: "doughnut",
  data: {
    labels: ["승", "패"],
    datasets: [{
      data: safeData(koen.winData),
      backgroundColor: ["#2563eb", "#cbd5e1"]
    }]
  },
  options: {
    plugins: {
      title: { display: true, text: "KOEN" },
      legend: { position: "bottom" }
    },
    cutout: "65%"
  }
});

winL = new Chart(document.getElementById("lhWinChart"), {
  type: "doughnut",
  data: {
    labels: ["승", "패"],
    datasets: [{
      data: safeData(lh.winData),
      backgroundColor: ["#f97316", "#fde68a"]
    }]
  },
  options: {
    plugins: {
      title: { display: true, text: "LH" },
      legend: { position: "bottom" }
    },
    cutout: "65%"
  }
});


  // 📈 레벨 분포
  if(level) level.destroy();
  const ctx=document.getElementById("levelChart");
  level=new Chart(ctx,{
    type:"line",
    data:{labels:Array.from({length:14},(_,i)=>`Lv${i+1}`),
      datasets:[
        {label:"KOEN",data:koen.levelCount,borderColor:"#2563eb",backgroundColor:"rgba(37,99,235,0.2)",fill:true,tension:0.35},
        {label:"LH",data:lh.levelCount,borderColor:"#f97316",backgroundColor:"rgba(249,115,22,0.2)",fill:true,tension:0.35}
      ]
    },
    options:{maintainAspectRatio:false,plugins:{legend:{position:"bottom"}},scales:{y:{beginAtZero:true}}}
  });
}

// === 실행 ===
listenClub(dbKoen, "koen", data => {
  koen = data;
  koen.winData = calcWinData(Object.values(data.dailyData || {}), "koen");
  if (lh.name) render(koen, lh);
});
listenClub(dbLh, "lh", data => {
  lh = data;
  lh.winData = calcWinData(Object.values(data.dailyData || {}), "lh");
  if (koen.name) render(koen, lh);
});

</script>
</body>
</html>
