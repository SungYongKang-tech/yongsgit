<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“ KOEN vs LH ë¦¬ê·¸ ì¸ì‚¬ì´íŠ¸</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --koen:#2563eb; --lh:#f97316; --bg:#f6f8fb; --card:#fff;
  --muted:#64748b; --ink:#0f172a; --shadow:0 6px 20px rgba(0,0,0,0.08);
}
*{box-sizing:border-box;font-family:"Pretendard","Noto Sans KR",sans-serif;}
body{margin:0;background:var(--bg);color:var(--ink);padding:18px;display:flex;flex-direction:column;align-items:center;}
header{text-align:center;margin-bottom:16px;}
h1{font-size:clamp(22px,5vw,28px);margin-bottom:6px;}
p{color:var(--muted);font-size:14px;}
section{width:100%;max-width:740px;background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:20px;margin-bottom:20px;}
.section-title{text-align:center;font-size:18px;margin-bottom:10px;}
.winner-banner{
  text-align:center;background:linear-gradient(90deg,var(--koen),var(--lh));
  color:white;padding:12px;border-radius:12px;margin-bottom:8px;
  font-weight:600;box-shadow:0 4px 10px rgba(0,0,0,.1);
}
.chart-container{width:100%;height:380px;min-height:320px;}
footer{text-align:center;color:var(--muted);font-size:13px;margin-top:10px;}
</style>
</head>
<body>
<header>
  <h1>ğŸ“ KOEN vs LH ë¦¬ê·¸ ì¸ì‚¬ì´íŠ¸</h1>
  <p id="monthText"></p>
</header>

<section>
  <div class="winner-banner" id="winnerText">ë°ì´í„° ê³„ì‚° ì¤‘...</div>
  <div class="section-title">ğŸ•¸ï¸ 5ê°í˜• ì¢…í•© ë¹„êµ</div>
  <div class="chart-container"><canvas id="radarChart"></canvas></div>

  <div class="desc-box" style="margin-top:18px;padding:14px 16px;background:linear-gradient(135deg,#f9fafb,#f1f5f9);border-radius:12px;font-size:14px;line-height:1.7;color:#334155;">
    <div><span style="color:#2563eb;font-weight:600;">ğŸ“Š ì°¸ì—¬ìœ¨</span> â€” íšŒì› 1ì¸ë‹¹ í‰ê·  ê²½ê¸° íšŸìˆ˜ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.</div>
    <div><span style="color:#16a34a;font-weight:600;">ğŸ† ìŠ¹ë¥ ì§€ìˆ˜</span> â€” 1~9ë¶€ë³„ ê²½ê¸° ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê³„ì‚°ëœ <b>ë¶€ìˆ˜ë³„ í‰ê·  ìŠ¹ë¥ </b>ì…ë‹ˆë‹¤. ê° ë¶€ì˜ ì‹¤ë ¥ ê· í˜•ì´ ì˜ ì¡íìˆ˜ë¡ 50%ì— ê°€ê¹Œì›Œì§‘ë‹ˆë‹¤.</div>
    <div><span style="color:#f97316;font-weight:600;">ğŸ•’ ì‹œê°„ëŒ€ì§€ìˆ˜</span> â€” ê²½ê¸°ê°€ íŠ¹ì • ì‹œê°„ëŒ€ì— ëª°ë¦¬ì§€ ì•Šê³ , <b>ì—¬ëŸ¬ ì‹œê°„ëŒ€ë¡œ ê³ ë¥´ê²Œ ë¶„ì‚°ë ìˆ˜ë¡ ë†’ê²Œ</b> í‘œì‹œë©ë‹ˆë‹¤.</div>
  </div>
</section>

<footer>Â© 2025 ë‚¨ë™ë³¸ì‚¬ & LH íƒêµ¬ë™í˜¸íšŒ</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// === ë‚ ì§œ ===
const now = new Date();
const year = now.getFullYear();
const month = String(now.getMonth() + 1).padStart(2, "0");
const monthKey = `${year}-${month}`;
document.getElementById("monthText").textContent = `${year}ë…„ ${month}ì›” ë¦¬ê·¸ í™œë™ ë¹„êµ`;

// === Firebase ì„¤ì • ===
const koenConfig = { apiKey:"AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo", authDomain:"pingpongclub-4a5fd.firebaseapp.com", databaseURL:"https://pingpongclub-4a5fd-default-rtdb.firebaseio.com", projectId:"pingpongclub-4a5fd" };
const lhConfig = { apiKey:"AIzaSyCM6FQqWaeI4Rx3ovD6OnhA_o-sgFvyWyI", authDomain:"pingpongclub2-6ce04.firebaseapp.com", databaseURL:"https://pingpongclub2-6ce04-default-rtdb.firebaseio.com", projectId:"pingpongclub2-6ce04" };
const appKoen = initializeApp(koenConfig, "koen");
const appLh = initializeApp(lhConfig, "lh");
const dbKoen = getDatabase(appKoen);
const dbLh = getDatabase(appLh);

// === ìœ í‹¸ ===
function calcTimeIndex(matches) {
  if (!matches.length) return 0;
  const zones = { morning: 0, noon: 0, evening: 0, night: 0 };
  matches.forEach(m => {
    const h = new Date(m.createdAt || 0).getHours();
    if (h >= 5 && h < 11) zones.morning++;
    else if (h >= 11 && h < 15) zones.noon++;
    else if (h >= 15 && h < 21) zones.evening++;
    else zones.night++;
  });
  const concentration = (Math.max(...Object.values(zones)) / matches.length) * 100;
  return (100 - concentration).toFixed(1);
}

function calcWinRateByLevel(matches, players) {
  if (!matches.length || !players.length) return 0;
  const levelMap = {};
  players.forEach(p => {
    const lv = parseInt(p.level || 0);
    if (lv >= 1 && lv <= 9 && p.name) levelMap[p.name] = lv;
  });
  const levelStats = {};
  matches.forEach(m => {
    if (!m.winner || !m.loser) return;
    const wLv = levelMap[m.winner];
    const lLv = levelMap[m.loser];
    if (!wLv || !lLv) return;
    if (!levelStats[wLv]) levelStats[wLv] = { win: 0, total: 0 };
    if (!levelStats[lLv]) levelStats[lLv] = { win: 0, total: 0 };
    levelStats[wLv].win++; levelStats[wLv].total++;
    levelStats[lLv].total++;
  });
  let totalRate = 0, count = 0;
  for (let lv = 1; lv <= 9; lv++) {
    const s = levelStats[lv];
    if (s && s.total > 0) {
      const rate = (s.win / s.total) * 100;
      totalRate += rate;
      count++;
    }
  }
  return count > 0 ? (totalRate / count).toFixed(1) : 0;
}

// === ë¦¬ìŠ¤ë„ˆ (ìë™ ê°ì§€ + í•„í„°ë§ ì¶”ê°€) ===
function listenClub(db, name, cb) {
  const pRef = ref(db, "players");
  const mRef = ref(db, "matches");
  onValue(pRef, pSnap => {
    onValue(mRef, mSnap => {
      const players = pSnap.exists() ? Object.values(pSnap.val()) : [];
      const allMatches = mSnap.exists() ? Object.values(mSnap.val()) : [];

      // âœ… ì´ë²ˆ ë‹¬ ë°ì´í„°ë§Œ í•„í„°ë§
      const matches = allMatches.filter(m => {
        if (!m.createdAt) return false;
        const d = new Date(m.createdAt);
        return d.getFullYear() === now.getFullYear() && (d.getMonth() + 1) === now.getMonth() + 1;
      });

      const memberCount = players.length;
      const games = matches.length;
      const activeRate = memberCount ? ((games / memberCount) * 10).toFixed(1) : 0;
      const timeIndex = calcTimeIndex(matches);
      const winRate = calcWinRateByLevel(matches, players);

      cb({ name, memberCount, games, activeRate, timeIndex, winRate });
    });
  });
}

// === ë Œë” ===
let koen = {}, lh = {}, radar;
function render(koen, lh) {
  const totalK = koen.games + parseFloat(koen.timeIndex) + parseFloat(koen.winRate);
  const totalL = lh.games + parseFloat(lh.timeIndex) + parseFloat(lh.winRate);
  const winner = totalK > totalL ? "KOEN ğŸ†" : totalK < totalL ? "LH ğŸ†" : "ë¬´ìŠ¹ë¶€ ğŸ¤";
  document.getElementById("winnerText").textContent = `${winner}ì´(ê°€) ${monthKey}ì›” ê°€ì¥ í™œë°œíˆ í™œë™í–ˆìŠµë‹ˆë‹¤!`;

  if (radar) radar.destroy();
  const normalize = (v, max) => (max === 0 ? 0 : Math.min(100, (v / max) * 100));
  const maxMembers = Math.max(koen.memberCount, lh.memberCount, 1);
  const maxGames = Math.max(koen.games, lh.games, 1);
  const maxActive = Math.max(koen.activeRate, lh.activeRate, 1);
  const maxWin = Math.max(koen.winRate, lh.winRate, 1);
  const maxTime = Math.max(koen.timeIndex, lh.timeIndex, 1);

  const labels = [
    `íšŒì›ìˆ˜\n(${koen.memberCount}/${lh.memberCount})`,
    `ê²½ê¸°ìˆ˜\n(${koen.games}/${lh.games})`,
    `ì°¸ì—¬ìœ¨\n(${koen.activeRate}/${lh.activeRate})`,
    `ìŠ¹ë¥ ì§€ìˆ˜\n(${koen.winRate}/${lh.winRate})`,
    `ì‹œê°„ëŒ€ì§€ìˆ˜\n(${koen.timeIndex}/${lh.timeIndex})`
  ];

  radar = new Chart(document.getElementById("radarChart"), {
    type: "radar",
    data: {
      labels,
      datasets: [
        { label: "KOEN", data: [
          normalize(koen.memberCount, maxMembers),
          normalize(koen.games, maxGames),
          normalize(koen.activeRate, maxActive),
          normalize(koen.winRate, maxWin),
          normalize(koen.timeIndex, maxTime)
        ], borderColor: "rgba(37,99,235,0.6)", backgroundColor: "rgba(37,99,235,0.25)", pointBackgroundColor: "#2563eb" },
        { label: "LH", data: [
          normalize(lh.memberCount, maxMembers),
          normalize(lh.games, maxGames),
          normalize(lh.activeRate, maxActive),
          normalize(lh.winRate, maxWin),
          normalize(lh.timeIndex, maxTime)
        ], borderColor: "rgba(249,115,22,0.6)", backgroundColor: "rgba(249,115,22,0.25)", pointBackgroundColor: "#f97316" }
      ]
    },
    options: {
      maintainAspectRatio: false,
      plugins: { legend: { position: "bottom" } },
      scales: {
        r: {
          beginAtZero: true,
          max: 100,
          ticks: { display: false },
          grid: { color: "rgba(0,0,0,0.08)" },
          pointLabels: {
            padding: 24,
            font: { size: 12, weight: "500" },
            color: "#334155",
            callback: value => value.split("\n")
          }
        }
      }
    }
  });
}

// === ì‹¤ì‹œê°„ ë°˜ì˜ ===
listenClub(dbKoen, "koen", data => { koen = data; if (lh.name) render(koen, lh); });
listenClub(dbLh, "lh", data => { lh = data; if (koen.name) render(koen, lh); });
</script>
</body>
</html>
