<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ“ KOEN vs LH ë¦¬ê·¸ í™œë™ ë¶„ì„ (ì‹¤ì‹œê°„)</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --koen:#2563eb; --lh:#f97316;
  --bg:#f5f7fb; --card:#fff; --ink:#0f172a; --muted:#64748b;
  --shadow:0 6px 20px rgba(0,0,0,0.08);
}
*{box-sizing:border-box;font-family:"Pretendard","Noto Sans KR",sans-serif;}
body{margin:0;background:var(--bg);color:var(--ink);padding:18px;display:flex;flex-direction:column;align-items:center;}
header{text-align:center;margin-bottom:18px;}
h1{font-size:clamp(20px,5vw,28px);margin-bottom:4px;}
p{color:var(--muted);font-size:clamp(13px,3vw,15px);}
section{width:100%;max-width:720px;background:var(--card);box-shadow:var(--shadow);border-radius:16px;padding:20px;margin-bottom:20px;}
.section-title{text-align:center;font-size:18px;margin-bottom:12px;}
.card-wrap{display:flex;flex-wrap:wrap;justify-content:space-around;gap:12px;}
.card{flex:1;min-width:150px;background:var(--bg);border-radius:12px;padding:12px;}
.card h3{margin:0;font-size:17px;}
.card p{margin:4px 0;font-size:14px;color:var(--muted);}
.winner-banner{
  text-align:center;background:linear-gradient(90deg,var(--koen),var(--lh));
  color:white;padding:10px 0;border-radius:12px;margin-bottom:10px;
  font-size:clamp(14px,3vw,16px);font-weight:600;box-shadow:0 4px 10px rgba(0,0,0,0.1);
}
.chart-container{width:100%;height:300px;}
footer{text-align:center;color:var(--muted);font-size:13px;margin-top:12px;}
</style>
</head>
<body>

<header>
  <h1>ğŸ“ KOEN vs LH ë¦¬ê·¸ í™œë™ ë¶„ì„</h1>
  <p id="monthText">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
</header>

<section>
  <div class="winner-banner" id="winnerText">ê²°ê³¼ ê³„ì‚° ì¤‘...</div>
  <div class="card-wrap">
    <div class="card" style="border:2px solid var(--koen)">
      <h3>KOEN</h3>
      <p>íšŒì› ìˆ˜: <b id="koenMembers">-</b></p>
      <p>ê²½ê¸° ìˆ˜: <b id="koenGames">-</b></p>
      <p>ì°¸ì—¬ìœ¨: <b id="koenActive">-</b>%</p>
      <p>í™œë™ì§€ìˆ˜: <b id="koenScore">-</b></p>
      <p>ì‹œê°„ëŒ€ì§€ìˆ˜: <b id="koenTime">-</b></p>
    </div>
    <div class="card" style="border:2px solid var(--lh)">
      <h3>LH</h3>
      <p>íšŒì› ìˆ˜: <b id="lhMembers">-</b></p>
      <p>ê²½ê¸° ìˆ˜: <b id="lhGames">-</b></p>
      <p>ì°¸ì—¬ìœ¨: <b id="lhActive">-</b>%</p>
      <p>í™œë™ì§€ìˆ˜: <b id="lhScore">-</b></p>
      <p>ì‹œê°„ëŒ€ì§€ìˆ˜: <b id="lhTime">-</b></p>
    </div>
  </div>
</section>

<section>
  <div class="section-title">ğŸ•¸ï¸ 5ê°í˜• ì¢…í•© ë¹„êµ (Radar Chart)</div>
  <div class="chart-container"><canvas id="radarChart"></canvas></div>

  <!-- ğŸ”½ ì§€í‘œ ì„¤ëª… -->
  <div style="margin-top:14px; font-size:14px; color:#334155; line-height:1.5;">
    <b>ğŸ“Š ì°¸ì—¬ìœ¨</b> â€” íšŒì› 1ì¸ë‹¹ í‰ê·  ê²½ê¸° íšŸìˆ˜ë¥¼ 10ë°°ë¡œ í™˜ì‚°í•œ ê°’ì…ë‹ˆë‹¤.<br>
    <b>âš™ï¸ í™œë™ì§€ìˆ˜</b> â€” ì „ì²´ ê²½ê¸° ìˆ˜ì— ì°¸ì—¬ìœ¨ì„ ê³±í•´ í™œë™ì„±ì„ ì¢…í•©ì ìœ¼ë¡œ í‰ê°€í•œ ì§€í‘œì…ë‹ˆë‹¤.<br>
    <b>ğŸ•’ ì‹œê°„ëŒ€ì§€ìˆ˜</b> â€” í•˜ë£¨ ì¤‘ ê°€ì¥ í™œë°œí•œ ì‹œê°„ëŒ€(ì˜ˆ: ì €ë…, ì ì‹¬ ë“±)ì— ì§‘ì¤‘ëœ ê²½ê¸° ë¹„ìœ¨(%)ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
  </div>
</section>

<section>
  <div class="section-title">ğŸ“ˆ í´ëŸ½ë³„ ë¶€ìˆ˜(Level) ë¶„í¬ ë¹„êµ</div>
  <div class="chart-container"><canvas id="levelChart"></canvas></div>
</section>

<footer>Â© 2025 ë‚¨ë™ë³¸ì‚¬ & LH íƒêµ¬ë™í˜¸íšŒ</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const now = new Date();
const year = now.getFullYear();
const month = String(now.getMonth() + 1).padStart(2,"0");
const monthKey = `${year}-${month}`;
document.getElementById("monthText").textContent = `${year}ë…„ ${month}ì›” ë°ì´í„° ë¹„êµ`;

// ğŸ”¹ Firebase ì„¤ì •
const koenConfig = {
  apiKey:"AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain:"pingpongclub-4a5fd.firebaseapp.com",
  databaseURL:"https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId:"pingpongclub-4a5fd",
  storageBucket:"pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId:"802826774007",
  appId:"1:802826774007:web:ca4d05be778eeaf1723af2"
};
const lhConfig = {
  apiKey:"AIzaSyCM6FQqWaeI4Rx3ovD6OnhA_o-sgFvyWyI",
  authDomain:"pingpongclub2-6ce04.firebaseapp.com",
  databaseURL:"https://pingpongclub2-6ce04-default-rtdb.firebaseio.com",
  projectId:"pingpongclub2-6ce04",
  storageBucket:"pingpongclub2-6ce04.firebasestorage.app",
  messagingSenderId:"27948766659",
  appId:"1:27948766659:web:b7f79c1937c2123ed29976"
};

const appKoen = initializeApp(koenConfig, "koenApp");
const appLh = initializeApp(lhConfig, "lhApp");
const dbKoen = getDatabase(appKoen);
const dbLh = getDatabase(appLh);

// âš™ï¸ ê³„ì‚° í•¨ìˆ˜
function calcTimeIndex(matches){
  if(!matches.length) return 0;
  const zones={morning:0,noon:0,evening:0,night:0};
  matches.forEach(m=>{
    const h=new Date(m.createdAt||0).getHours();
    if(h>=5&&h<11)zones.morning++;else if(h>=11&&h<15)zones.noon++;
    else if(h>=15&&h<21)zones.evening++;else zones.night++;
  });
  return ((Math.max(...Object.values(zones))/matches.length)*100).toFixed(1);
}
function calcLevelCount(players){
  const arr=new Array(14).fill(0);
  players.forEach(p=>{const lv=parseInt(p.level||0);if(lv>=1&&lv<=14)arr[lv-1]++;});
  return arr;
}

// ğŸ§© ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ
function listenClub(db, name, callback){
  const playersRef=ref(db,"players");
  const matchesRef=ref(db,`matches/${monthKey}`);
  onValue(playersRef,pSnap=>{
    onValue(matchesRef,mSnap=>{
      const players=pSnap.exists()?Object.values(pSnap.val()):[];
      const matches=mSnap.exists()?Object.values(mSnap.val()):[];
      const memberCount=players.length;
      const games=matches.length;
      const activeRate=memberCount?((games/memberCount)*10).toFixed(1):0;
      const score=Math.round(games*(activeRate/100));
      const timeIndex=calcTimeIndex(matches);
      const levelCount=calcLevelCount(players);
      callback({name,memberCount,games,activeRate,score,timeIndex,levelCount});
    });
  });
}

// ğŸ•¸ï¸ ì°¨íŠ¸ ë³€ìˆ˜ ì „ì—­í™”
let radarChart, levelChart;
function renderCharts(koen,lh){
  const totalK=koen.score+parseFloat(koen.timeIndex);
  const totalL=lh.score+parseFloat(lh.timeIndex);
  const winner=totalK>totalL?"KOEN ğŸ†":totalK<totalL?"LH ğŸ†":"ë¬´ìŠ¹ë¶€ ğŸ¤";
  document.getElementById("winnerText").textContent=`${winner}ì´(ê°€) ${monthKey}ì›” ê°€ì¥ í™œë°œíˆ í™œë™í–ˆìŠµë‹ˆë‹¤!`;

  // ì¹´ë“œ ì—…ë°ì´íŠ¸
  const update=(id,val)=>document.getElementById(id).textContent=val;
  update("koenMembers",koen.memberCount);
  update("koenGames",koen.games);
  update("koenActive",koen.activeRate);
  update("koenScore",koen.score);
  update("koenTime",koen.timeIndex);
  update("lhMembers",lh.memberCount);
  update("lhGames",lh.games);
  update("lhActive",lh.activeRate);
  update("lhScore",lh.score);
  update("lhTime",lh.timeIndex);

  // ê¸°ì¡´ ì°¨íŠ¸ ìˆìœ¼ë©´ ì‚­ì œ í›„ ì¬ìƒì„±
  if(radarChart) radarChart.destroy();
  if(levelChart) levelChart.destroy();

  // Radar Chart
  radarChart=new Chart(document.getElementById("radarChart"),{
    type:"radar",
    data:{
      labels:["íšŒì›ìˆ˜","ê²½ê¸°ìˆ˜","ì°¸ì—¬ìœ¨","í™œë™ì§€ìˆ˜","ì‹œê°„ëŒ€ì§€ìˆ˜"],
      datasets:[
        {label:"KOEN",data:[koen.memberCount,koen.games,koen.activeRate,koen.score,koen.timeIndex],
         borderColor:"rgba(37,99,235,0.6)",backgroundColor:"rgba(37,99,235,0.2)",borderWidth:1,pointRadius:3,pointBackgroundColor:"#2563eb"},
        {label:"LH",data:[lh.memberCount,lh.games,lh.activeRate,lh.score,lh.timeIndex],
         borderColor:"rgba(249,115,22,0.6)",backgroundColor:"rgba(249,115,22,0.2)",borderWidth:1,pointRadius:3,pointBackgroundColor:"#f97316"}
      ]
    },
    options:{plugins:{legend:{position:"bottom"}},scales:{r:{beginAtZero:true,angleLines:{color:"rgba(0,0,0,0.05)"},grid:{color:"rgba(0,0,0,0.08)"}}}}
  });

  // ë¶€ìˆ˜(Level) ë¶„í¬ ê·¸ë˜í”„
  const ctx=document.getElementById("levelChart");
  const gK=ctx.getContext("2d").createLinearGradient(0,0,0,250);
  gK.addColorStop(0,"rgba(37,99,235,0.4)"); gK.addColorStop(1,"rgba(37,99,235,0)");
  const gL=ctx.getContext("2d").createLinearGradient(0,0,0,250);
  gL.addColorStop(0,"rgba(249,115,22,0.4)"); gL.addColorStop(1,"rgba(249,115,22,0)");
  const labels=Array.from({length:14},(_,i)=>`Lv${i+1}`);

  levelChart=new Chart(ctx,{
    type:"line",
    data:{
      labels,
      datasets:[
        {label:"KOEN",data:koen.levelCount,fill:true,borderColor:"#2563eb",backgroundColor:gK,borderWidth:2,tension:0.35,pointRadius:3,pointBackgroundColor:"#2563eb"},
        {label:"LH",data:lh.levelCount,fill:true,borderColor:"#f97316",backgroundColor:gL,borderWidth:2,tension:0.35,pointRadius:3,pointBackgroundColor:"#f97316"}
      ]
    },
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{position:"bottom"},tooltip:{callbacks:{label:(ctx)=>`${ctx.dataset.label}: ${ctx.parsed.y}ëª…`}}},
      scales:{x:{grid:{display:false},ticks:{font:{size:11},color:"#444"}},y:{beginAtZero:true,grid:{color:"rgba(0,0,0,0.08)"},ticks:{stepSize:1,font:{size:11},color:"#555"}}}
    }
  });
}

// ğŸ”„ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì‹¤í–‰
let koenData={}, lhData={};
listenClub(dbKoen,"koen",data=>{koenData=data;if(lhData.name)renderCharts(koenData,lhData);});
listenClub(dbLh,"lh",data=>{lhData=data;if(koenData.name)renderCharts(koenData,lhData);});
</script>
</body>
</html>
