<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>🏓 KOEN vs LH 리그 인사이트</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{ --koen:#2563eb; --lh:#f97316; --bg:#f6f8fb; --card:#fff; --muted:#64748b; --ink:#0f172a; --shadow:0 6px 20px rgba(0,0,0,0.08); }
*{box-sizing:border-box;font-family:"Pretendard","Noto Sans KR",sans-serif;}
body{margin:0;background:var(--bg);color:var(--ink);padding:18px;display:flex;flex-direction:column;align-items:center;}
header{text-align:center;margin-bottom:16px;}
h1{font-size:clamp(22px,5vw,28px);margin-bottom:6px;}
p{color:var(--muted);font-size:14px;}
section{width:100%;max-width:740px;background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:20px;margin-bottom:20px;display: flex;flex-direction: column;align-items: stretch;}
.section-title{text-align:center;font-size:18px;margin:4px 0 6px;}
.banner{padding:10px;border-radius:10px;margin-bottom:8px;font-weight:600;}
.winner-banner{ text-align:center;background:linear-gradient(90deg,var(--koen),var(--lh));color:white; }
.error-banner{ background:#fee2e2;color:#991b1b; display:none; }
.chart-container{width:100%;height:auto;min-height:auto;margin-top: 0;display: flex;justify-content: center;align-items: center;}
footer{text-align:center;color:var(--muted);font-size:13px;margin-top:10px;}
#monthlyReport{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:18px;}
.report-wrapper{display:flex;flex-wrap:wrap;gap:16px;margin-top:10px;}
.report-card{flex:1 1 340px;background:var(--bg);border-radius:12px;padding:12px 14px;border-left:5px solid var(--koen);}
.report-card.lh{border-left-color:var(--lh);}
.report-card h4{margin:0 0 10px;font-size:15px;color:var(--ink);}
.report-card table{width:100%;border-collapse:collapse;font-size:14px;}
.report-card th,.report-card td{text-align:center;padding:6px 0;}
.report-card th{background:#f1f5f9;font-weight:600;color:#334155;}
.report-card tr:nth-child(even) td{background:rgba(0,0,0,0.02);}
.top-player{ text-align:center;margin-bottom:14px;padding:10px;background:linear-gradient(90deg,#fef3c7,#fde68a);border-radius:12px;font-weight:600;color:#78350f;box-shadow:0 3px 8px rgba(0,0,0,0.08); }

.section-title { margin-bottom: 2px; }
.chart-container { margin-top: 0; }

/* 🌙 다크모드 대응 */
@media (prefers-color-scheme: dark) {
  :root {
    --bg: #1e293b;          /* 전체 배경 - 어두운 남회색 */
    --card: #334155;        /* 카드 배경 - 살짝 밝은 남회색 */
    --ink: #f1f5f9;         /* 본문 글자 - 밝은 흰색 */
    --muted: #cbd5e1;       /* 설명 텍스트 - 은은한 회색 */
    --shadow: 0 6px 20px rgba(0,0,0,0.4); /* 그림자 조금 진하게 */
  }

  body {
    background: var(--bg);
    color: var(--ink);
  }

  section {
    background: var(--card);
    box-shadow: var(--shadow);
  }

  .banner.winner-banner {
    background: linear-gradient(90deg, #3b82f6, #fb923c);
  }

  footer {
    color: var(--muted);
  }
}


</style>
</head>
<body>
<header>
  <h1>🏓 KOEN vs LH 리그 인사이트</h1>
  
</header>

<section>
  <div id="errorText" class="banner error-banner">에러가 발생했습니다.</div>
  <div class="banner winner-banner" id="winnerText">데이터 계산 중...</div>
 <!-- <div class="section-title">🏓 월간 리그 퍼포먼스 비교</div>-->
  <div class="chart-container"><canvas id="radarChart"></canvas></div>

<!-- ✅ 여기에 추가 -->
  <div class="index-guide">
    <h3>📘 지표 설명</h3>
    <ul>
      <li>🕒 <b>시간대지수</b> : 특정 시간대에 얼마나 활발하게 경기가 열렸나</li>
      <li>🏅 <b>승률지수</b> : 전체 회원의 평균 승률로, 팀의 전반적인 경기력</li>
      <li>🎯 <b>참여율</b> : 전체 회원 중 실제로 경기에 참여한 비율</li>
    </ul>
  </div>

</section>

<section id="monthlyReport">
  <div class="section-title">📅 지난달 클럽별 월간 리포트<br>(15경기 이상)</div>
  <div class="report-wrapper">
    <div class="report-card" id="koenReport"></div>
    <div class="report-card lh" id="lhReport"></div>
  </div>
</section>

<section id="levelDist">
  <div class="section-title">🏓 부수별 인원 분포 비교</div>
  <div class="chart-container"><canvas id="levelChart"></canvas></div>
</section>

<section id="timeDist">
  <div class="section-title">🕒 경기 시간대 분포 비교</div>
  <div class="chart-container" style="display:flex;flex-wrap:wrap;gap:16px;justify-content:center;">
    <div style="flex:1;min-width:300px;">
      <h4 style="text-align:center;margin-bottom:8px;color:#2563eb;">KOEN</h4>
      <canvas id="chartKoenTime"></canvas>
    </div>
    <div style="flex:1;min-width:300px;">
      <h4 style="text-align:center;margin-bottom:8px;color:#f97316;">LH</h4>
      <canvas id="chartLhTime"></canvas>
    </div>
  </div>
</section>


<footer>© 2025 남동본사 & LH 탁구동호회</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";


/* ========= 날짜 ========= */
const now = new Date();
const year = now.getFullYear();
const month = String(now.getMonth()+1).padStart(2,"0");
const monthKey = `${year}-${month}`;
const prev = new Date(now.getFullYear(), now.getMonth()-1);
const prevKey = `${prev.getFullYear()}-${String(prev.getMonth()+1).padStart(2,"0")}`;

/* ========= Firebase ========= */
const koenConfig={apiKey:"AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",authDomain:"pingpongclub-4a5fd.firebaseapp.com",databaseURL:"https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",projectId:"pingpongclub-4a5fd"};
const lhConfig={apiKey:"AIzaSyCM6FQqWaeI4Rx3ovD6OnhA_o-sgFvyWyI",authDomain:"pingpongclub2-6ce04.firebaseapp.com",databaseURL:"https://pingpongclub2-6ce04-default-rtdb.firebaseio.com",projectId:"pingpongclub2-6ce04"};
const appKoen=initializeApp(koenConfig,"koen");
const appLh=initializeApp(lhConfig,"lh");
const dbKoen=getDatabase(appKoen);
const dbLh=getDatabase(appLh);

/* ========= 공통 유틸 ========= */
const showError = (msg) => {
  const el = document.getElementById('errorText');
  el.textContent = `⚠️ ${msg}`;
  el.style.display = 'block';
  console.error(msg);
};
window.addEventListener('error', e => showError(e.message));

function calcTimeIndex(matches){
  if(!matches.length) return 0;
  const z={morning:0,noon:0,evening:0,night:0};
  matches.forEach(m=>{
    const h=new Date(m.createdAt||0).getHours();
    if(h>=5&&h<11)z.morning++; else if(h>=11&&h<15)z.noon++;
    else if(h>=15&&h<21)z.evening++; else z.night++;
  });
  const concentration=(Math.max(...Object.values(z))/matches.length)*100;
  return (100 - concentration).toFixed(1);
}

/* ✅ 승률지수: winnerSide + namesA/B + 1~9부만 */
function calcWinRateByLevel(matches, players){
  if(!matches.length || !players.length) return 0;
  const levelMap = {};
  players.forEach(p=>{
    const lv=parseInt(p.level||0);
    if(lv>=1 && lv<=9 && p.name) levelMap[p.name.trim()] = lv;
  });

  const levelStats = {};
  matches.forEach(m=>{
    if(!m.winnerSide) return;
    const A = m.namesA || [], B = m.namesB || [];
    const winners = m.winnerSide === "A" ? A : (m.winnerSide === "B" ? B : []);
    const losers  = m.winnerSide === "A" ? B : (m.winnerSide === "B" ? A : []);

    winners.forEach(n=>{
      const lv = levelMap[n];
      if(!lv) return;
      if(!levelStats[lv]) levelStats[lv] = { win:0, total:0 };
      levelStats[lv].win++; levelStats[lv].total++;
    });
    losers.forEach(n=>{
      const lv = levelMap[n];
      if(!lv) return;
      if(!levelStats[lv]) levelStats[lv] = { win:0, total:0 };
      levelStats[lv].total++;
    });
  });

  let totalRate=0, count=0;
  for(let lv=1; lv<=9; lv++){
    const s=levelStats[lv];
    if(s && s.total>0){
      totalRate += (s.win/s.total)*100;
      count++;
    }
  }
  const avg = count>0 ? (totalRate/count).toFixed(1) : 0;
  console.debug("🏓 승률지수:", {avg, levelStats});
  return avg;
}

/* ========= 실시간 구독: matches는 루트에서 읽고 monthKey로 필터 ========= */
function listenClub(db, name, cb){
  const pRef = ref(db, "players");
  const mRef = ref(db, "matches"); // ✅ 루트
  onValue(pRef, pSnap=>{
    onValue(mRef, mSnap=>{
      const players = pSnap.exists()? Object.values(pSnap.val()) : [];
      const all = mSnap.exists()? Object.values(mSnap.val()) : [];

      // 이번 달만 필터
      const matches = all.filter(m => m?.monthKey === monthKey);

      const memberCount = players.length;
      const games = matches.length;
      const activeRate = memberCount ? ((games/memberCount)*10).toFixed(1) : 0;
      const timeIndex = calcTimeIndex(matches);
      const winRate = calcWinRateByLevel(matches, players);

      cb({ name, memberCount, games, activeRate, timeIndex, winRate });
    }, err => showError(`matches 구독 오류: ${err?.message||err}`));
  }, err => showError(`players 구독 오류: ${err?.message||err}`));
}

/* ========= 레이더 ========= */
let radar;
function render(koen, lh){
  try{
document.getElementById("winnerText").textContent = `${year}년 ${month}월 리그 퍼포먼스 비교`;

    if(radar) radar.destroy();
    const normalize = (v,max)=> (max===0?0:Math.min(100,(v/max)*100));
    const maxMembers=Math.max(koen.memberCount, lh.memberCount, 1);
    const maxGames=Math.max(koen.games, lh.games, 1);
    const maxActive=Math.max(koen.activeRate, lh.activeRate, 1);
    const maxWin=Math.max(koen.winRate, lh.winRate, 1);
    const maxTime=Math.max(koen.timeIndex, lh.timeIndex, 1);

    const labels=[
      `회원수\n(${koen.memberCount}/${lh.memberCount})`,
      `경기수\n(${koen.games}/${lh.games})`,
      `참여율\n(${koen.activeRate}/${lh.activeRate})`,
      `승률지수\n(${koen.winRate}/${lh.winRate})`,
      `시간대지수\n(${koen.timeIndex}/${lh.timeIndex})`
    ];

    radar = new Chart(document.getElementById("radarChart"), {
      type: "radar",
      data: {
        labels,
        datasets: [
          {
            label: "KOEN",
            data: [
              normalize(koen.memberCount, maxMembers),
              normalize(koen.games, maxGames),
              normalize(koen.activeRate, maxActive),
              normalize(koen.winRate, maxWin),
              normalize(koen.timeIndex, maxTime)
            ],
            borderColor:"rgba(37,99,235,0.6)",
            backgroundColor:"rgba(37,99,235,0.25)",
            pointBackgroundColor:"#2563eb"
          },
          {
            label: "LH",
            data: [
              normalize(lh.memberCount, maxMembers),
              normalize(lh.games, maxGames),
              normalize(lh.activeRate, maxActive),
              normalize(lh.winRate, maxWin),
              normalize(lh.timeIndex, maxTime)
            ],
            borderColor:"rgba(249,115,22,0.6)",
            backgroundColor:"rgba(249,115,22,0.25)",
            pointBackgroundColor:"#f97316"
          }
        ]
      },
      options:{
        maintainAspectRatio:false,
        plugins:{legend:{position:"bottom"}},
        scales:{
          r:{
            beginAtZero:true,max:100,ticks:{display:false},
            grid:{color:"rgba(0,0,0,0.08)"},
            pointLabels:{padding:18,font:{size:12,weight:"500"},color:"#334155",callback:v=>v.split("\n")}
          }
        }
      }
    });
  }catch(e){
    showError(`레이더 렌더 오류: ${e.message}`);
  }
}

listenClub(dbKoen, "koen", data => { 
  koen = data; 
  if(lh.name) render(koen, lh); 
});
listenClub(dbLh, "lh", data => { 
  lh = data; 
  if(koen.name) render(koen, lh); 
});

// 🧩 두 클럽 선수 데이터도 불러와서 부수별 분포 렌더링

async function loadLevelDist(){
  const pKoenSnap = await get(ref(dbKoen, "players"));
  const pLhSnap = await get(ref(dbLh, "players"));
  const koenPlayers = pKoenSnap.exists()? Object.values(pKoenSnap.val()) : [];
  const lhPlayers = pLhSnap.exists()? Object.values(pLhSnap.val()) : [];
  renderLevelDistribution(koenPlayers, lhPlayers);
}
loadLevelDist();

/* ========= 경기 시간대 분포 ========= */
function calcTimeDistData(matches){
  const z={morning:0,noon:0,evening:0,night:0};
  matches.forEach(m=>{
    const h=new Date(m.createdAt||0).getHours();
    if(h>=5 && h<9) z.morning++;        // 🌅 아침 (05~09시)
    else if(h>=11 && h<13) z.noon++;    // ☀ 점심 (11~13시)
    else if(h>=18 && h<20) z.evening++; // 🌇 저녁 (18~20시)
    else if(h>=20 && h<22) z.night++;   // 🌙 야간 (20~22시)
  });
  return z;
}

async function renderTimeDistribution(){
  const [koenSnap, lhSnap] = await Promise.all([
    get(ref(dbKoen,"matches")),
    get(ref(dbLh,"matches"))
  ]);
  const koenMatches = koenSnap.exists()?Object.values(koenSnap.val()).filter(m=>m.monthKey===monthKey):[];
  const lhMatches   = lhSnap.exists()?Object.values(lhSnap.val()).filter(m=>m.monthKey===monthKey):[];

  const k=calcTimeDistData(koenMatches);
  const l=calcTimeDistData(lhMatches);

  const labels=['🌅 아침(05~09시)','☀ 점심(11~13시)','🌇 저녁(18~20시)','🌙 야간(20~22시)'];
  const koenData=[k.morning,k.noon,k.evening,k.night];
  const lhData=[l.morning,l.noon,l.evening,l.night];

  const makeChart=(ctx,data,color)=>new Chart(ctx,{
    type:'doughnut',
    data:{
      labels,
      datasets:[{
        data,
        backgroundColor:[
          '#93c5fd', // 아침 - 연하늘
          '#fde68a', // 점심 - 밝은 노랑
          '#fca5a5', // 저녁 - 코랄
          '#a78bfa'  // 야간 - 연보라
        ],
        borderColor:'#fff',
        borderWidth:2
      }]
    },
    options: {
    plugins: {
      legend: {
        position: 'bottom',
        labels:{
  font:{ size:13 },
  color: window.matchMedia('(prefers-color-scheme: dark)').matches 
    ? '#f8fafc' // 🌙 더 밝은 흰색
    : '#334155'
}
      },
      title: { display: false }
    },
    cutout: '55%'
    }
  });

  makeChart(document.getElementById('chartKoenTime'),koenData,'#2563eb');
  makeChart(document.getElementById('chartLhTime'),lhData,'#f97316');
}

renderTimeDistribution();

/* ========= 지난달 리포트 (15경기 이상) ========= */
function calcPlayerStatsDetailed(matches, players){
  const stats={}; const levelMap={};
  players.forEach(p => levelMap[p.name] = p.level || "-");
  matches.forEach(m=>{
    const A = m.namesA || [], B = m.namesB || [];
    if(m.winnerSide==="A"){
      A.forEach(n=>{ stats[n] = stats[n]||{win:0,lose:0,games:0}; stats[n].win++;  stats[n].games++; });
      B.forEach(n=>{ stats[n] = stats[n]||{win:0,lose:0,games:0}; stats[n].lose++; stats[n].games++; });
    }else if(m.winnerSide==="B"){
      B.forEach(n=>{ stats[n] = stats[n]||{win:0,lose:0,games:0}; stats[n].win++;  stats[n].games++; });
      A.forEach(n=>{ stats[n] = stats[n]||{win:0,lose:0,games:0}; stats[n].lose++; stats[n].games++; });
    }
  });
  return Object.entries(stats)
    .filter(([_,s])=> s.games>=15)
    .map(([name,s])=>({ name, level: levelMap[name]||"-", games:s.games, win:s.win, lose:s.lose, rate: ((s.win/s.games)*100).toFixed(1) }))
    .sort((a,b)=> b.rate - a.rate);
}

function renderMonthlyReport(db, clubName, containerId){
  const reportRef = ref(db, `monthlyReports/${prevKey}/players`);

  onValue(reportRef, snap => {
    const box = document.getElementById(containerId);

    if (!snap.exists()) {
      box.innerHTML = `<h4>${clubName.toUpperCase()} ⚪ 데이터 없음</h4>
        <p style="color:var(--muted);font-size:13px;">${prevKey}월 리포트 없음</p>`;
      return;
    }

    // Firebase의 players 배열 데이터
    const stats = Object.values(snap.val())
      .filter(s => s.total >= 15) // ✅ 15경기 이상
      .sort((a, b) => b.rate - a.rate);

    if (!stats.length) {
      box.innerHTML = `<h4>${clubName.toUpperCase()} ⚪ 데이터 없음</h4>
        <p style="color:var(--muted);font-size:13px;">15경기 이상 참가자 없음</p>`;
      return;
    }

    const top = stats[0];
// ✅ 총 경기 수 계산
    const totalMatches = Math.round(stats.reduce((sum, s) => sum + s.total, 0) / 2);

    box.innerHTML = `
      <div class="top-player">🏆 TOP PLAYER: ${top.name} (${top.level}) — 승률 ${top.rate}% (${top.win}승 ${top.lose}패)</div>
      <h4>${clubName.toUpperCase()} 클럽</h4>
      <table>
        <thead>
          <tr><th>이름(부수)</th><th>경기수</th><th>승/패</th><th>승률</th></tr>
        </thead>
        <tbody>
          ${stats.map(s => `
            <tr>
              <td>${s.name} (${s.level})</td>
              <td>${s.total}</td>
              <td>${s.win}/${s.lose}</td>
              <td>${s.rate}%</td>
            </tr>`).join("")}
        </tbody>
      </table>
      <p style="text-align:center;margin-top:8px;font-size:13px;color:#1e3a8a;font-weight:600;">
        🔹 총 경기 수: <b>${totalMatches} 경기</b>
      </p>
    `;

  });
}


/* ========= 실행 ========= */
let koen={}, lh={};
listenClub(dbKoen, "koen", data => { koen = data; if(lh.name) render(koen, lh); });
listenClub(dbLh, "lh",   data => { lh   = data; if(koen.name) render(koen, lh); });

renderMonthlyReport(dbKoen, "koen", "koenReport");
renderMonthlyReport(dbLh, "lh",   "lhReport");

/* ========= 부수별 인원 분포 ========= */
function renderLevelDistribution(koenPlayers, lhPlayers){
  const getLevelCount = (players)=>{
    const counts = Array(10).fill(0); // 1~9부
    players.forEach(p=>{
      const lv = parseInt(p.level);
      if(lv>=1 && lv<=9) counts[lv]++;
    });
    return counts.slice(1);
  };

  const ctx = document.getElementById('levelChart').getContext('2d');
  const labels = ['1부','2부','3부','4부','5부','6부','7부','8부','9부'];
  const koenCounts = getLevelCount(koenPlayers);
  const lhCounts = getLevelCount(lhPlayers);

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'KOEN',
          data: koenCounts,
          backgroundColor: 'rgba(37,99,235,0.6)'
        },
        {
          label: 'LH',
          data: lhCounts,
          backgroundColor: 'rgba(249,115,22,0.6)'
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true, ticks: { stepSize: 1 } }
      },
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
}

</script>
</body>
</html>
