<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸ“ KOEN ë¶„ì„ JSON ìƒì„±ê¸°</title>

<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

<style>
body{
  margin:0; padding:20px;
  font-family:"Pretendard","Noto Sans KR",sans-serif;
  background:#f8fafc; color:#0f172a;
}
.container{
  max-width:900px; margin:0 auto;
  background:white; padding:20px 26px;
  border-radius:18px;
  box-shadow:0 10px 30px rgba(0,0,0,0.07);
}
h1{
  font-size:22px; color:#2563eb; font-weight:900;
}
.btn{
  padding:10px 14px; margin:6px 0;
  background:#2563eb; color:white;
  border:none; border-radius:10px;
  font-size:15px; font-weight:700;
  cursor:pointer;
}
textarea{
  width:100%; height:360px; resize:none;
  padding:12px; border-radius:12px;
  border:1px solid #cbd5e1;
  font-size:15px;
  font-family:monospace;
}
</style>
</head>
<body>

<div class="container">
  <h1>ğŸ“ KOEN ë¶„ì„ JSON ìë™ ìƒì„±ê¸°</h1>

  <button class="btn" id="btnLoad">1) Firebase ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
  <button class="btn" id="btnAnalyze">2) ìë™ ë¶„ì„ ìƒì„±</button>
  <button class="btn" id="btnCopy">3) JSON ë³µì‚¬í•˜ê¸°</button>

  <h3>ê²°ê³¼(JSON):</h3>
  <textarea id="resultBox">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</textarea>
</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// âœ… Firebase ì„¤ì •
const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let players = {};      // ì „ì²´ ì„ ìˆ˜ ëª©ë¡
let matches = [];      // ì „ì²´ ê²½ê¸° ê¸°ë¡

// âœ… 1) ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
document.getElementById("btnLoad").onclick = async ()=>{

  const pSnap = await get(ref(db, "players"));
  const mSnap = await get(ref(db, "matches"));

  if (!pSnap.exists() || !mSnap.exists()) {
    alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  players = pSnap.val();
  matches = Object.values(mSnap.val());

  document.getElementById("resultBox").value = 
    "âœ… ë°ì´í„° ë¶ˆëŸ¬ì˜´!\n" +
    `- ì„ ìˆ˜: ${Object.keys(players).length}ëª…\n` +
    `- ê²½ê¸°: ${matches.length}ê±´`;
};


// âœ… 2) ìë™ ë¶„ì„ ìƒì„±
document.getElementById("btnAnalyze").onclick = ()=>{

  if (!Object.keys(players).length){
    alert("ë¨¼ì € ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.");
    return;
  }

  const output = {};

  for (const pid in players){
    const name = players[pid].name;

    if (!name) continue;

    const analysis = generatePlayerAnalysis(name);
    output[name] = analysis;
  }

  document.getElementById("resultBox").value =
    JSON.stringify(output, null, 2);
};


// âœ… ì„ ìˆ˜ë³„ ë¶„ì„ ìƒì„± í•¨ìˆ˜
function generatePlayerAnalysis(player){

  let sWin=0, sLose=0, dWin=0, dLose=0;
  let opponents = {};
  let partners = {};

  matches.forEach(m=>{
    const A = m.namesA || [];
    const B = m.namesB || [];
    const mode = m.mode || "single";

    if (![...A,...B].includes(player)) return;

    const winA = (m.winnerSide === "A");
    const iAmA = A.includes(player);
    const iWon = (winA && iAmA) || (!winA && !iAmA);

    // ë‹¨ì‹
    if (mode === "single"){
      if (iWon) sWin++; else sLose++;

      const opp = iAmA ? B[0] : A[0];
      if (opp){
        if (!opponents[opp]) opponents[opp] = {win:0, lose:0};
        if (iWon) opponents[opp].win++; else opponents[opp].lose++;
      }
    }

    // ë³µì‹
    if (mode === "double"){
      if (iWon) dWin++; else dLose++;

      const partner = iAmA 
        ? A.find(x=>x!==player)
        : B.find(x=>x!==player);

      if (partner){
        if (!partners[partner]) partners[partner] = {win:0, lose:0};
        if (iWon) partners[partner].win++; else partners[partner].lose++;
      }
    }
  });

  // ìƒëŒ€Â·íŒŒíŠ¸ë„ˆ sorting
  const topOpp = Object.entries(opponents)
     .sort((a,b)=>(b[1].win+b[1].lose)-(a[1].win+a[1].lose))[0];

  const topPartner = Object.entries(partners)
     .sort((a,b)=>(b[1].win+b[1].lose)-(a[1].win+a[1].lose))[0];

  // âœ… ë¶„ì„ ë¬¸êµ¬ ìƒì„±
  let text = 
`${player} ì„ ìˆ˜ì˜ ê²½ê¸° ìŠ¤íƒ€ì¼ ë¶„ì„ì…ë‹ˆë‹¤.

â–  ì „ì²´ ì„±í–¥
- ë‹¨ì‹ ì „ì : ${sWin}ìŠ¹ ${sLose}íŒ¨
- ë³µì‹ ì „ì : ${dWin}ìŠ¹ ${dLose}íŒ¨

â–  ë‹¨ì‹ ë¶„ì„
${
  topOpp 
  ? `- ê°€ì¥ ë§ì´ ê²¨ë£¬ ìƒëŒ€ëŠ” ${topOpp[0]}ì´ë©°, ì „ì ì€ ${topOpp[1].win}ìŠ¹ ${topOpp[1].lose}íŒ¨`
  : "- ì¶©ë¶„í•œ ë‹¨ì‹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
}

â–  ë³µì‹ ë¶„ì„
${
  topPartner
  ? `- ê°€ì¥ ë§ì´ í˜¸í¡ì„ ë§ì¶˜ íŒŒíŠ¸ë„ˆëŠ” ${topPartner[0]}ì´ë©°, ì „ì ì€ ${topPartner[1].win}ìŠ¹ ${topPartner[1].lose}íŒ¨`
  : "- ë³µì‹ íŒŒíŠ¸ë„ˆ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."
}

â–  í”Œë ˆì´ ìŠ¤íƒ€ì¼ ìš”ì•½
- ê²½ê¸° ìˆ˜Â·ìŠ¹ë¥ ì„ ê¸°ì¤€ìœ¼ë¡œ ì•ˆì •ì„±, ê³µê²©ì„±, íŒŒíŠ¸ë„ˆ ê¶í•© ë“±ì„ ë¶„ì„í•œ ê²°ê³¼  
  ${player} ì„ ìˆ˜ëŠ” ìì‹ ì˜ ê°•ì ì„ ì‚´ë ¤ ê²½ê¸°ë¥¼ ìš´ì˜í•˜ëŠ” ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤.
(í•„ìš”ì‹œ ChatGPTë¡œ ë” ì‹¬ì¸µ ë¶„ì„ ê°€ëŠ¥)

`;

  return text.trim();
}


// âœ… 3) JSON ë³µì‚¬í•˜ê¸°
document.getElementById("btnCopy").onclick = ()=>{
  const box = document.getElementById("resultBox");
  box.select();
  document.execCommand("copy");
  alert("âœ… JSONì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
};

</script>

</body>
</html>
