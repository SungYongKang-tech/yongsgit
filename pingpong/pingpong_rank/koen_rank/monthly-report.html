<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“ ì›”ê°„ íƒêµ¬ë¦¬ê·¸ ë¦¬í¬íŠ¸</title>
<style>
@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb;
  --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
  --shadow:0 8px 28px rgba(0,0,0,.08); --card:#fff;
}
body{
  margin:0;
  font-family:"Pretendard","Noto Sans KR",sans-serif;
  background:var(--bg); color:var(--ink); font-weight:600;
}
header{
  background:#fff; border-bottom:1px solid #e5e7eb;
  text-align:center; padding:14px 0; position:sticky; top:0; z-index:10;
}
h1{margin:4px 0 10px; color:var(--accent); font-size:clamp(18px,4vw,24px); font-weight:700;}
.btn{border:1px solid #d1d5db; border-radius:8px; padding:6px 10px; font-size:14px;
  background:#fff; cursor:pointer; font-weight:600; transition:.15s;}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.row{display:flex;justify-content:center;gap:8px;margin-bottom:10px;}
main{max-width:900px;margin:0 auto;padding:10px 10px 60px;}
table{width:100%;border-collapse:collapse;background:var(--card);box-shadow:var(--shadow);
  border-radius:12px;overflow:hidden;font-size:15px;}
thead th{background:#f1f5f9;border-bottom:1px solid #e2e8f0;padding:10px 6px;
  text-align:center;color:#334155;font-weight:700;white-space:nowrap;}
tbody td{border-bottom:1px solid #f1f5f9;padding:10px 6px;text-align:center;}
tbody tr:hover{background:#f9fafb}
.win { 
  color: #dc2626;   /* ğŸ”´ ë¹¨ê°•(ìŠ¹ë¦¬) */
  font-weight: 700;
}

.lose { 
  color: #2563eb;   /* ğŸ”µ íŒŒë‘(íŒ¨ë°°) */
  font-weight: 700;
}
.delta{font-weight:700;}
/* âœ… ìŠ¹ë¥  ì¦ê°€(ë¹¨ê°•), ê°ì†Œ(íŒŒë‘) */
.delta.up { 
  color: #dc2626;   /* ğŸ”´ ìŠ¹ë¥  ì¦ê°€ */
}

.delta.down { 
  color: #2563eb;   /* ğŸ”µ ìŠ¹ë¥  ê°ì†Œ */
}
.summary{
  margin-top:28px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:16px;
}
.card{background:var(--card);border-radius:12px;box-shadow:var(--shadow);
  padding:18px 20px;display:flex;flex-direction:column;gap:8px;}
.card h3{margin:0 0 6px;font-size:18px;color:var(--accent);}
.card ul{margin:0;padding-left:22px;font-size:16px;line-height:1.5;}
.card li{margin:3px 0;}
.total{grid-column:1 / -1;text-align:center;font-size:19px;font-weight:700;
  color:var(--ink);background:#e8f0ff;border-radius:12px;padding:12px;}
@media(max-width:640px){
  table{font-size:13px;} thead th, tbody td{padding:7px 1px;}
  .card ul{font-size:15px;}
}
.btn.ok {
  background:#0d9488;   /* ë¯¼íŠ¸ìƒ‰ ê³„ì—´ */
  color:#fff;
  border-color:#0d9488;
}
.btn.ok:hover {
  background:#0f766e;   /* ì‚´ì§ ì–´ë‘ìš´ í˜¸ë²„ */
}

</style>
</head>
<body>
<header>
  <h1 id="pageHeader">ğŸ“ ì›”ê°„ íƒêµ¬ë¦¬ê·¸ ë¦¬í¬íŠ¸</h1>
  <div class="row">
    <button id="adminBtn" class="btn">âš™ ê´€ë¦¬ìëª¨ë“œ</button>
    <a href="index.html" class="btn primary">ê²½ê¸°ê²°ê³¼ ì…ë ¥</a>
    <!--<a href="monthly-report.html" class="btn primary">í†µí•© ì „ì </a>  -->
    <a href="monthly-report2.html" class="btn primary">ë‹¨/ë³µì‹ ì „ì </a>
   </div>
</header>

<main>
  <table>
    <thead>
      <tr>
        <th>ìˆœìœ„</th><th>ì´ë¦„(ë¶€ìˆ˜)</th><th>ê²½ê¸°</th><th>ìŠ¹/íŒ¨</th>
        <th>ì´ì „<br>ìŠ¹ë¥ </th><th>ì´ë‹¬<br>ìŠ¹ë¥ </th><th>ì¦ê°</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
  <div id="summary" class="summary"></div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, onValue, remove, set } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// === ê¸°ë³¸ ì„¤ì • ===
const titleRef = ref(db, "config/title");
get(titleRef).then(snap=>{
  const title = snap.exists()?snap.val():"ìš°ë¦¬íšŒì‚¬";
  document.getElementById("pageHeader").textContent = `ğŸ“ ${title} ì›”ê°„ í†µí•©ë¦¬ê·¸`;
});

const matchRef = ref(db, "matches");
const playerRef = ref(db, "players");

let players = {};
let cleanedOldMatches = false;  // âœ… ì˜¤ë˜ëœ ê²½ê¸° ì‚­ì œ 1íšŒë§Œ
let autoClosed = false;        // âœ… ì›”ë§ˆê° ìƒì„± 1íšŒë§Œ

onValue(playerRef, snap=>{players = snap.val() || {};});

function formatNum(n){ return (Math.round(n*10)/10).toFixed(1); }

async function autoClosePreviousMonth() {
  const now = new Date();

  // âœ… ì „ë‹¬ ì›” ê³„ì‚°(ì •í™•)
  const prevDate2 = new Date(now.getFullYear(), now.getMonth() - 1, 1);
  const prevMonth = `${prevDate2.getFullYear()}-${String(prevDate2.getMonth() + 1).padStart(2, '0')}`;

  const reportRef = ref(db, `monthlyReports/${prevMonth}/players`);

  // âœ… ì´ë¯¸ ì €ì¥ëœ ë¦¬í¬íŠ¸ê°€ ìˆìœ¼ë©´ ì¤‘ë³µ ìƒì„± ë°©ì§€
  const existing = await get(reportRef);
  if (existing.exists()) {
    console.log(`â„¹ï¸ ${prevMonth} ì›” ë¦¬í¬íŠ¸ ì´ë¯¸ ì¡´ì¬`);
    return;
  }

  console.log(`ğŸ“¦ ${prevMonth} ì›” ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘...`);

  // ğŸ”¹ ì§€ë‚œë‹¬ ê²½ê¸° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  const matchSnap = await get(ref(db, 'matches'));
  const matchData = matchSnap.val() || {};
  const playerSnap = await get(ref(db, 'players'));
  const playerData = playerSnap.val() || {};

  const stats = {};
  Object.values(matchData).forEach(m => {
    if (m.monthKey !== prevMonth) return;

    const names = [...(m.namesA || []), ...(m.namesB || [])];
    names.forEach(n => { if (!stats[n]) stats[n] = { win: 0, lose: 0 }; });

    if (m.winnerSide === 'A') {
      (m.namesA || []).forEach(n => stats[n].win++);
      (m.namesB || []).forEach(n => stats[n].lose++);
    } else if (m.winnerSide === 'B') {
      (m.namesB || []).forEach(n => stats[n].win++);
      (m.namesA || []).forEach(n => stats[n].lose++);
    }
  });

  const reportArr = Object.entries(playerData).map(([id, p]) => {
    const d = stats[p.name] || { win: 0, lose: 0 };
    const total = d.win + d.lose;
    const rate = total ? (d.win / total * 100) : 0;
    return { name: p.name, level: p.level, total, win: d.win, lose: d.lose, rate };
  }).filter(p => p.total > 0);

  if (reportArr.length === 0) {
    console.log(`âš ï¸ ${prevMonth} ì›” ê²½ê¸° ì—†ìŒ â€” ë§ˆê° ìŠ¤í‚µ`);
    return;
  }

  const reportObj = {};
reportArr.forEach(p => {
  const safeKey = p.name.replace(/[.#$\[\]\/]/g, "_");
  reportObj[safeKey] = p;
});
await set(reportRef, reportObj);


  console.log(`âœ… ${prevMonth} ì›” ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ`);
}


// === ë©”ì¸ ë¡œì§ ===
onValue(matchRef, async (snap)=>{
   // âœ… ì›”ë§ˆê°(ì§€ë‚œë‹¬ ë¦¬í¬íŠ¸ ìƒì„±) 1íšŒë§Œ ì‹¤í–‰
  if (!autoClosed) {
    autoClosed = true;
    await autoClosePreviousMonth();
  }
  const data = snap.val() || {};
  const now = new Date();
  const thisMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const prevDate = new Date(now.getFullYear(), now.getMonth() - 1);
  const prevMonth = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}`;

  const twoMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 2, 1);
  const oldMonth = `${twoMonthsAgo.getFullYear()}-${String(twoMonthsAgo.getMonth()+1).padStart(2,'0')}`;

  const stats = {};

  // 2ê°œì›” ì´ì „ ì‚­ì œ (âœ… 1íšŒë§Œ ì‹¤í–‰)
if (!cleanedOldMatches) {
  cleanedOldMatches = true;

  Object.entries(data).forEach(([id, m]) => {
    if (m.monthKey && m.monthKey <= oldMonth) {
      remove(ref(db, `matches/${id}`));
    }
  });
}


  // ì´ë²ˆë‹¬ í†µê³„ ê³„ì‚°
  Object.values(data).forEach(m=>{
    if(m.monthKey !== thisMonth) return;
    const names = [...m.namesA, ...m.namesB];
    names.forEach(n=>{ if(!stats[n]) stats[n]={win:0,lose:0}; });
    if(m.winnerSide==='A'){
      m.namesA.forEach(n=>stats[n].win++);
      m.namesB.forEach(n=>stats[n].lose++);
    }else if(m.winnerSide==='B'){
      m.namesB.forEach(n=>stats[n].win++);
      m.namesA.forEach(n=>stats[n].lose++);
    }
  });

  const curArr = Object.entries(players).map(([id,p])=>{
    const d = stats[p.name] || {win:0,lose:0};
    const total = d.win+d.lose;
    const rate = total ? (d.win/total*100) : 0;
    return {name:p.name, level:p.level, total, win:d.win, lose:d.lose, rate};
  }).filter(p=>p.total>0).sort((a,b)=>b.rate-a.rate||b.total-a.total||a.level-b.level);

  // === ì§€ë‚œë‹¬ ë¦¬í¬íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ===
  const prevArr=[]; const prevMap={};
  const prevReportRef = ref(db, `monthlyReports/${prevMonth}/players`);
  const prevSnap = await get(prevReportRef);
if(prevSnap.exists()){
  const data = prevSnap.val();
Object.values(data).forEach(p => {

  // ì´ë¯¸ ìë™ë§ˆê°ì—ì„œ win/lose/rateë¡œ ì €ì¥ë˜ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
  const win = p.win ?? p.wins ?? 0;
  const lose = p.lose ?? p.losses ?? 0;
  const rate = p.rate ?? p.winRate ?? 0;
  const total = p.total ?? (win + lose);

  prevArr.push({
    name: p.name,
    level: p.level,
    win,
    lose,
    total,
    rate
  });

  prevMap[p.name] = rate;
});

}



  const curAug = curArr.map(p=>{
    const prev = prevMap[p.name] ?? null;
    const delta = (prev===null)?null:(p.rate - prev);
    return {...p, prev, delta};
  });

  render(curAug,thisMonth,prevArr,prevMonth);
  summary(curAug,prevArr,prevMap);
});


// === render í•¨ìˆ˜ ===
function render(curArr, thisMonth, prevArr, prevMonth) {
  const main = document.querySelector('main');
  const summaryBox = document.querySelector('#summary');

  // âœ… ì´ë‹¬ì˜ ì „ì  í‘œ
  main.innerHTML = `
    <h2 style="text-align:center;font-size:22px;color:#1e3a8a;margin:20px 0 14px;font-weight:800;">
      ğŸ“ ì´ë‹¬ì˜ í†µí•©ì „ì  (${thisMonth})
    </h2>
    <table id="tableCurrent">
      <thead>
        <tr>
          <th>ìˆœìœ„</th><th>ì´ë¦„(ë¶€ìˆ˜)</th><th>ê²½ê¸°</th><th>ìŠ¹/íŒ¨</th>
          <th>ì´ì „<br>ìŠ¹ë¥ </th><th>ì´ë‹¬<br>ìŠ¹ë¥ </th><th>ì¦ê°</th>
        </tr>
      </thead>
      <tbody id="tbodyCurrent"></tbody>
    </table>
  `;

  // âœ… summary ë°•ìŠ¤ ì¶”ê°€
  main.appendChild(summaryBox);

  // âœ… ë‚ ì§œë³„ ê²½ê¸° ìˆ˜ ê¸°ì¤€
  const today = new Date();
  const day = today.getDate();

 // âœ… "2ì¼ì— 1ê²½ê¸°" ê·œì¹™ ì ìš©
  let minGames = Math.ceil(day / 2);


  // âœ… ì¡°ê±´ ì¶©ì¡± / ë¯¸ì¶©ì¡±ì ë¶„ë¦¬
const qualified = curArr
  .filter(p => p.total >= minGames)
  .sort((a, b) =>
      b.rate - a.rate ||     // âœ… ìŠ¹ë¥  ë†’ì€ìˆœ
      b.total - a.total ||   // âœ… ê²½ê¸° ë§ì€ìˆœ
      a.level - b.level      // âœ… ë¶€ìˆ˜ ë‚®ì€ìˆœ
  );

const unqualified = curArr
  .filter(p => p.total < minGames)
  .sort((a, b) =>
      b.rate - a.rate ||     // âœ… ìŠ¹ë¥  ë†’ì€ìˆœ
      b.total - a.total ||   // âœ… ê²½ê¸° ë§ì€ìˆœ
      a.level - b.level
  );


  const tbody = document.querySelector('#tbodyCurrent');

  // âœ… ì¡°ê±´ ì¶©ì¡±ì (ìˆœìœ„ ìˆìŒ, í•˜ëŠ˜ìƒ‰ ë°°ê²½)
  qualified.forEach((p, i) => {
    const cls = p.delta > 0 ? 'up' : p.delta < 0 ? 'down' : '';
    const sign = p.delta > 0 ? 'â–²' : p.delta < 0 ? 'â–¼' : 'â€“';
    const prevText = p.prev !== null ? `${formatNum(p.prev)}%` : 'â€“';
    const deltaText = p.prev !== null ? `${sign} ${formatNum(Math.abs(p.delta))}%p` : 'â€“';

    tbody.insertAdjacentHTML('beforeend', `
      <tr style="background:#e0f2fe;">
        <td>${i + 1}</td>

        <td>
        <a href="player.html?name=${encodeURIComponent(p.name)}"
        style="color:#2563eb; font-weight:700; text-decoration:none;">
     ${p.name}(${p.level})
        </a>
        </td>

        <td>${p.total}</td>
        <td><span class="win">${p.win}</span>/<span class="lose">${p.lose}</span></td>
        <td>${prevText}</td>
        <td>${formatNum(p.rate)}%</td>
        <td class="delta ${cls}">${deltaText}</td>
      </tr>
    `);
  });

  // âœ… ì¡°ê±´ ë¯¸ì¶©ì¡±ì (ìˆœìœ„ â€œâ€“â€, íšŒìƒ‰ ë°°ê²½, ê²½ê¸°ìˆœ ë‚´ë¦¼ì°¨ìˆœ)
  unqualified.forEach(p => {
    const cls = p.delta > 0 ? 'up' : p.delta < 0 ? 'down' : '';
    const sign = p.delta > 0 ? 'â–²' : p.delta < 0 ? 'â–¼' : 'â€“';
    const prevText = p.prev !== null ? `${formatNum(p.prev)}%` : 'â€“';
    const deltaText = p.prev !== null ? `${sign} ${formatNum(Math.abs(p.delta))}%p` : 'â€“';

    tbody.insertAdjacentHTML('beforeend', `
      <tr style="background:#f9fafb;">
        <td>â€“</td>
        <td>
        <a href="player.html?name=${encodeURIComponent(p.name)}"
     style="color:#2563eb; font-weight:700; text-decoration:none;">
     ${p.name}(${p.level})
        </a>
        </td>
        <td>${p.total}</td>
        <td><span class="win">${p.win}</span>/<span class="lose">${p.lose}</span></td>
        <td>${prevText}</td>
        <td>${formatNum(p.rate)}%</td>
        <td class="delta ${cls}">${deltaText}</td>
      </tr>
    `);
  });

  // âœ… ì•ˆë‚´ì¤„ (í‘œ ë°”ë¡œ ì•„ë˜, ì‘ì€ ê¸€ì”¨)
  document.querySelector('#tableCurrent').insertAdjacentHTML('afterend', `
    <p id="ruleNote" style="
      text-align:center;
      color:#475569;
      font-size:12.5px;
      margin-top:6px;
      margin-bottom:14px;
      font-weight:500;
    ">
      âš ï¸ ìˆœìœ„ ë°˜ì˜ ê¸°ì¤€: <b>2ì¼ì— 1ê²½ê¸° ì´ìƒ (ì˜¤ëŠ˜ ê¸°ì¤€ ìµœì†Œ ${minGames}ê²½ê¸°)</b>

    </p>
  `);

  // âœ… ì§€ë‚œë‹¬ ì „ì  (summary ì•„ë˜ìª½ì— ì¶œë ¥)
  if (prevArr.length) {
    main.insertAdjacentHTML('beforeend', `
      <h3 style="text-align:center;font-size:20px;color:#334155;margin:28px 0 8px;
      border-top:2px solid #e2e8f0;padding-top:12px;">
        ì§€ë‚œë‹¬ ì „ì  (${prevMonth})
      </h3>
      <table id="tablePrev">
        <thead>
          <tr>
            <th>ìˆœìœ„</th><th>ì´ë¦„(ë¶€ìˆ˜)</th><th>ê²½ê¸°</th><th>ìŠ¹/íŒ¨</th><th>ìŠ¹ë¥ </th>
          </tr>
        </thead>
        <tbody id="tbodyPrev"></tbody>
      </table>
    `);

    const tb = document.querySelector('#tbodyPrev');

    // âœ… ì§€ë‚œë‹¬ë„ 15ê²½ê¸° ê¸°ì¤€ ë¶„ë¦¬
    const qualifiedPrev = prevArr
  .filter(p => p.total >= 15)
  .sort((a, b) => 
      b.rate - a.rate ||        // ìŠ¹ë¥  ìˆœ
      b.total - a.total ||      // ê²½ê¸°ìˆ˜ ìˆœ
      a.level - b.level         // ë¶€ìˆ˜ ë‚®ì€ ìˆœ
  );

    const unqualifiedPrev = prevArr
  .filter(p => p.total < 15)
  .sort((a, b) =>
      b.rate - a.rate || 
      b.total - a.total || 
      a.level - b.level
  );

    // âœ… 15ê²½ê¸° ì´ìƒ (í•˜ëŠ˜ìƒ‰ + ìˆœìœ„ ìˆìŒ)
    qualifiedPrev.forEach((p, i) => {
      tb.insertAdjacentHTML('beforeend', `
        <tr style="background:#e0f2fe;">
          <td>${i + 1}</td>
          <td>
            <a href="player.html?name=${encodeURIComponent(p.name)}"
            style="color:#2563eb; font-weight:700; text-decoration:none;">
            ${p.name}  </a>
          </td>

          <td>${p.total}</td>
          <td><span class="win">${p.win}</span>/<span class="lose">${p.lose}</span></td>
          <td>${formatNum(p.rate)}%</td>
        </tr>
      `);
    });

    // âœ… 15ê²½ê¸° ë¯¸ë§Œ (íšŒìƒ‰ + ìˆœìœ„ â€œâ€“â€)
    unqualifiedPrev.forEach(p => {
      tb.insertAdjacentHTML('beforeend', `
        <tr style="background:#f9fafb;">
          <td>â€“</td>
          <td>
            <a href="player.html?name=${encodeURIComponent(p.name)}"
            style="color:#2563eb; font-weight:700; text-decoration:none;">
            ${p.name}  </a>
          </td>
          <td>${p.total}</td>
          <td><span class="win">${p.win}</span>/<span class="lose">${p.lose}</span></td>
          <td>${formatNum(p.rate)}%</td>
        </tr>
      `);
    });

      // âœ… í‘œ ë°”ê¹¥(ì•„ë˜)ì— ì´ ê²½ê¸° ìˆ˜ í‘œì‹œ
    const totalPrevMatches = Math.round(prevArr.reduce((sum, p) => sum + p.total, 0) / 2);
    document.querySelector('#tablePrev').insertAdjacentHTML('afterend', `
      <p style="
        text-align:center;
        margin-top:8px;
        font-size:13px;
        color:#1e3a8a;
        font-weight:600;
      ">
        ğŸ”¹ ì§€ë‚œë‹¬ ì´ ê²½ê¸° ìˆ˜: <b>${totalPrevMatches} ê²½ê¸°</b>
      </p>
      <p id="ruleNotePrev" style="
        text-align:center;
        color:#475569;
        font-size:12.5px;
        margin-top:4px;
        margin-bottom:14px;
        font-weight:500;
      ">
        âš ï¸ ì§€ë‚œë‹¬ ìˆœìœ„ ë°˜ì˜ ê¸°ì¤€: <b>15ê²½ê¸° ì´ìƒ</b>
      </p>
    `);
  }
}

// === summary ===
function summary(arr,prevArr,prevMap){
  const box=document.querySelector('#summary');
  const totalMatches=Math.round(arr.reduce((s,p)=>s+p.total,0)/2);
  const topPlay=arr.slice().sort((a,b)=>b.total-a.total).slice(0,3);
  const topWin=arr.slice().sort((a,b)=>b.win-a.win).slice(0,3);
  const topDelta=arr.filter(p=>{
    const prev=prevMap[p.name];
    const prevData=prevArr.find(x=>x.name===p.name);
    const prevTotal=prevData?prevData.total:0;
    return(p.delta>0&&p.prev!==null&&prevTotal>=15&&p.total>=15);
  }).sort((a,b)=>b.delta-a.delta).slice(0,3);
  const promote=arr.filter(p=>{
    const prev=prevMap[p.name];
    const prevData=prevArr.find(x=>x.name===p.name);
    const prevTotal=prevData?prevData.total:0;
    return(p.rate>=70&&p.total>=15&&prev!==undefined&&prev>=70&&prevTotal>=15);
  }).slice(0,5);

  box.innerHTML=`
    <div class="total">ì´ ê²½ê¸° ìˆ˜: ${totalMatches} ê²½ê¸°</div>
    <div class="card"><h3>ğŸ® ìµœë‹¤ê²½ê¸° TOP3</h3><ul>${topPlay.map(p=>`<li>${p.name} (${p.total}ê²½ê¸°)</li>`).join('')}</ul></div>
    <div class="card"><h3>ğŸ† ë‹¤ìŠ¹ TOP3</h3><ul>${topWin.map(p=>`<li>${p.name} (${p.win}ìŠ¹)</li>`).join('')}</ul></div>
    <div class="card"><h3>ğŸ“ˆ ê¸°ëŸ‰ìƒìŠ¹ TOP3</h3>
      <ul>${topDelta.length?topDelta.map(p=>`<li>${p.name} (+${formatNum(p.delta)}%p)</li>`).join(''):'<li>ì—†ìŒ</li>'}</ul>
      <p style="margin:6px 0 0;font-size:14px;color:#475569;">(ì „ë‹¬Â·ì´ë²ˆë‹¬ ê°ê° 15ê²½ê¸° ì´ìƒ / ì´ë²ˆë‹¬ ìŠ¹ë¥  ìƒìŠ¹ìë§Œ)</p>
    </div>
    <div class="card"><h3>ğŸš€ ë¶€ìˆ˜ìƒí–¥ ê¶Œê³ </h3>
      <ul>${promote.length?promote.map(p=>`<li>${p.name} (${formatNum(p.rate)}%)</li>`).join(''):'<li>ì—†ìŒ</li>'}</ul>
      <p style="margin:6px 0 0;font-size:14px;color:#475569;">(ì „ë‹¬Â·ì´ë²ˆë‹¬ ê°ê° 70% ì´ìƒ / 15ê²½ê¸° ì´ìƒ ë‘ ë‹¬ ì—°ì† ë‹¬ì„±ì)</p>
    </div>`;
}

// === ê´€ë¦¬ìëª¨ë“œ ===
document.getElementById("adminBtn").addEventListener("click", async ()=>{
  const pwRef=ref(db,"config/adminPassword");
  const snap=await get(pwRef);
  const saved=snap.exists()?snap.val():"1234";
  const input=prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
  if(!input) return;
  if(input!==saved) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
  window.location.href="admin.html";
});



</script>
</body>
</html>
