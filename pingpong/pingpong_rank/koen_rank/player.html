<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“ ê°œì¸ íƒêµ¬ ì„±ì </title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

<!-- Chart.js (ì§€ì—° ë¡œë”© ì „ê¹Œì§€ëŠ” ì•ˆ ì“°ì§€ë§Œ ë¯¸ë¦¬ ì„ ì–¸í•´ë„ ë¬´ë°©) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb; --card:#ffffff;
  --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
  --shadow:0 10px 30px rgba(2,6,23,.08);
  --soft:#eaf1ff; --soft2:#eef2ff;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:"Pretendard","Noto Sans KR",system-ui,-apple-system,sans-serif;
  background:var(--bg); color:var(--ink); font-weight:600;
}
header{
  position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #e5e7eb;
}
.header-inner{
  max-width:1080px; margin:0 auto; padding:14px 16px; display:flex; gap:10px; align-items:center; justify-content:space-between;
}
h1{margin:0; font-size:clamp(18px,4vw,22px); color:var(--accent); font-weight:800}
.sub{font-size:16px; color:#334155; font-weight:700}
.btn{
  border:1px solid #d1d5db; background:#fff; color:#0f172a; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700;
}
.btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
.btn.ghost{background:#f8fafc}
.wrap{max-width:1080px; margin:0 auto; padding:16px}
.grid{
  display:grid; gap:14px;
  grid-template-columns: repeat(12, 1fr);
}
.card{
  background:var(--card); border-radius:16px; box-shadow:var(--shadow); padding:16px;
}
.card h3{margin:0 0 8px; font-size:18px; color:#1e3a8a}
.kv{display:flex; flex-wrap:wrap; gap:10px}
.badge{display:inline-block; padding:6px 10px; border-radius:999px; font-size:13px; background:var(--soft); color:#1e3a8a}
.big{
  font-size:30px; font-weight:900; color:#0f172a; letter-spacing:-.5px;
}
.row{display:flex; align-items:center; gap:8px}
.hr{height:1px; background:#eef2f7; margin:12px 0}
.dim{color:#64748b; font-weight:700; font-size:13px}
.kpi{
  display:grid; gap:10px; grid-template-columns: repeat(4,1fr);
}
.kpi .mini{
  border:1px solid #e5e7eb; border-radius:12px; padding:14px; background:linear-gradient(180deg,#fff, #fbfdff 85%);
}
.kpi .mini h4{margin:0 0 6px; font-size:13px; color:#334155}
.kpi .mini .v{font-size:22px; font-weight:900}
.kpi .good{border-color:#c7f3d5; background:linear-gradient(180deg,#fff, #f3fff7 85%)}
.kpi .warn{border-color:#ffd5d5; background:linear-gradient(180deg,#fff, #fff6f6 85%)}
.block-title{font-size:16px; font-weight:900; color:#0f172a; margin-bottom:8px}
.list{
  display:grid; gap:8px;
}
.item{
  border:1px solid #e5e7eb; padding:10px 12px; border-radius:12px; display:flex; align-items:center; justify-content:space-between;
  background:linear-gradient(180deg,#fff, #fbfdff 85%);
  box-shadow:0 2px 10px rgba(2,6,23,.02);
}
.item .l{display:flex; gap:8px; align-items:center}
.tag{font-size:12px; background:#e2efff; color:#1e40af; padding:4px 8px; border-radius:999px; font-weight:800}
.item .r{font-weight:900}
.btn-xl{
  display:inline-flex; align-items:center; gap:8px; padding:12px 16px; border-radius:12px; border:1px solid #c7d2fe;
  background:linear-gradient(180deg,#fff, #f3f5ff 75%); color:#1e3a8a; font-size:15px; font-weight:900; cursor:pointer;
}
.canvas-box{
  background:#fff; border:1px dashed #dbe3ff; border-radius:12px; padding:12px; display:none;
}
.canvas-grid{
  display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
}
.note{
  font-size:12.5px; color:#475569; margin-top:6px; text-align:right
}
@media (max-width:900px){
  .kpi{grid-template-columns: repeat(2,1fr)}
}

@media (max-width: 600px){
  .item{
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;                 /* ëª¨ë°”ì¼ ê°„ê²© ì¡°ê¸ˆë§Œ í‚¤ì›€ */
  }
  .item .l, .item .r{
    width: 100%;
  }
  .item .r{
    text-align: left;         /* ëª¨ë°”ì¼ì€ ì¢Œì¸¡ì •ë ¬ì´ ê°€ë…ì„± ì¢‹ìŒ */
    font-size: 13px;
    line-height: 1.45;
  }
}

/* ìƒì„¸ ë¶„ì„ ë¦¬ìŠ¤íŠ¸ì—ì„œ í•œ ì¤„ ì •ë ¬ */
#opponentSingles .item .r,
#partnerDoubles .item .r {
  display: flex;
  gap: 6px;
  white-space: nowrap;
  font-size: 14px;
  font-weight: 800;
}
/* âœ… ìƒì„¸ ë¶„ì„ìš© í•œ ì¤„ ìœ ì§€ */
.item-inline {
  display: flex;
  flex-direction: row !important;  /* âœ… row ê°•ì œ */
  align-items: center;
  gap: 8px;
  white-space: nowrap;
  width: 100%;
}

/* âœ… ëª¨ë°”ì¼ì—ì„œ .item ì„¤ì •ì„ ë¬´ì‹œí•˜ê³  row ìœ ì§€ */
@media (max-width: 600px) {
  .item-inline {
    flex-direction: row !important;   /* âœ… column ë¬´ì‹œ */
  }
}

/* ğŸ“… ì›”ë³„ í†µí•© ê¸°ë¡ ê¸€ì”¨ í¬ê²Œ */
#monthList .item .r {
  font-size: 20px;
  line-height: 1.45;
}
#monthList .item .r div {
  font-size: 20px;
}

/* âœ… ìƒì„¸ë¶„ì„ â€” í•œì¤„í˜• ë‚´ìš© ì¢Œì¸¡ ì •ë ¬í•˜ê¸° */
.item-inline {
  justify-content: flex-start !important;  /* ì™¼ìª½ ì‹œì‘ ì •ë ¬ */
  text-align: left !important;
}

.item-inline span {
  text-align: left !important;
}

@media (orientation: landscape) {
  .canvas-grid {
    grid-template-columns: 1fr !important;  /* âœ… í•œ ì¤„ í•˜ë‚˜ì”© */
  }
}

/* âœ… ì°¨íŠ¸ ë†’ì´ ëª…ì‹œ */
#chartOpp, #chartPartner {
  height: 360px !important;   /* ë‹¨ì‹/ë³µì‹ ìŠ¹ë¥  ê·¸ë˜í”„ */
}

#chartRate, #chartGames, #chartModePie, #chartPoints {
  height: 320px !important;   /* ë‚˜ë¨¸ì§€ ê·¸ë˜í”„ */
}



</style>
</head>
<body>
<header>
  <div class="header-inner">
    <div>
      <h1>ğŸ“íƒêµ¬ì„±ì </h1>
      <div class="sub" id="playerNameSub">ì„ ìˆ˜ ì´ë¦„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
    </div>
    <div class="row">
      <a class="btn" href="monthly-report.html">â† ì›”ê°„ ë¦¬í¬íŠ¸</a>
      <button id="openCharts" class="btn primary">ğŸ“Š ê·¸ë˜í”„ ì—´ê¸°</button>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- ìƒë‹¨ ìš”ì•½ -->
  <section class="grid" style="grid-template-columns:repeat(12,1fr);">
    <div class="card" style="grid-column: span 12;">
      <div class="row" style="justify-content:space-between;">
        <div class="row" style="gap:12px">
          <div class="badge" id="periodBadge">ë°ì´í„° ê¸°ê°„: ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
          <div class="badge" id="modeBadge">11ì›”ë¶€í„° ë‹¨ì‹/ë³µì‹ ìë™ ë¶„ë¦¬</div>
        </div>
       <!-- <div class="row">
          <span class="dim">ìŠ¹ì  ê·œì¹™: ìŠ¹ +2 / íŒ¨ -1</span>
        </div> -->
      </div>

      <div class="hr"></div>

      <div class="kpi" id="kpiWrap">
        <!-- KPI íƒ€ì¼ 4ê°œ: í†µí•©ì „ì (ëˆ„ì ), 11ì›”~ ë‹¨ì‹, 11ì›”~ ë³µì‹, 11ì›”~ ëˆ„ì  ìŠ¹ì  -->
        <div class="mini"><h4>ëˆ„ì  ê²½ê¸°(í†µí•©)</h4><div class="v" id="kpiAllTotal">-</div><div class="dim" id="kpiAllWL">-</div></div>
        <div class="mini"><h4>11ì›”~ ë‹¨ì‹</h4><div class="v" id="kpiSglTotal">-</div><div class="dim" id="kpiSglWL">-</div></div>
        <div class="mini"><h4>11ì›”~ ë³µì‹</h4><div class="v" id="kpiDblTotal">-</div><div class="dim" id="kpiDblWL">-</div></div>
        <div class="mini"><h4>11ì›”~ ëˆ„ì  ìŠ¹ì </h4><div class="v" id="kpiPoints">-</div><div class="dim">ìŠ¹Ã—2 - íŒ¨</div></div>
      </div>
    </div>
  </section>

  <!-- ì›”ë³„ ì¹´ë“œ -->
  <section class="grid" style="margin-top:12px;">
    <div class="card" style="grid-column: span 12;">
      <h3>ğŸ“… ì›”ë³„ í†µí•© ê¸°ë¡</h3>

      <div id="monthList" class="list"></div>
      <div class="note">* '25ë…„ 9ì›”, 10ì›”ì€ ë‹¨/ë³µì‹ êµ¬ë¶„ ì—†ì´ í†µí•©ì „ì ë§Œ ì œê³µ</div>
    </div>
  </section>

  <!-- ìƒì„¸ ë¶„ì„ -->
  <section class="grid" style="margin-top:12px;">
    <div class="card" style="grid-column: span 12;">
      <h3>ğŸ” ìƒì„¸ ë¶„ì„ (11ì›”~)</h3>
      <div class="grid" style="grid-template-columns:repeat(12,1fr); gap:12px;">
       <div class="card" style="grid-column: span 12;">

          <div class="block-title">ë‹¨ì‹ â€” ìƒëŒ€ë³„ ì „ì </div>
          <div id="opponentSingles" class="list"></div>
        </div>
       <div class="card" style="grid-column: span 12;">

          <div class="block-title">ë³µì‹ â€” íŒŒíŠ¸ë„ˆë³„ ì „ì </div>
          <div id="partnerDoubles" class="list"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ê·¸ë˜í”„(ì§€ì—° ë¡œë”©) -->
  <section class="grid" style="margin-top:12px;">
    <div class="card" style="grid-column: span 12;">
      <h3>ğŸ“Š ì‹œê°í™”</h3>
      <button class="btn-xl" id="btnLoadCharts">ğŸ“ˆ ê·¸ë˜í”„ ì—´ê¸° (ì§€ì—° ë¡œë”©)</button>
      <div class="canvas-box" id="canvasBox" style="margin-top:12px;">
        <div class="canvas-grid">
          <canvas id="chartRate"></canvas>
          <canvas id="chartGames"></canvas>
          <canvas id="chartModePie"></canvas>
          <canvas id="chartOpp"></canvas>
          <canvas id="chartPartner"></canvas>
          <canvas id="chartPoints"></canvas>
        </div>
      </div>
      <div class="note">* ë²„íŠ¼ì„ ëˆŒëŸ¬ ê·¸ë˜í”„ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤. (ëª¨ë°”ì¼ ìµœì í™”)</div>
    </div>
  </section>

</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// ===== Firebase =====
const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

// ===== Utils =====
// YYYY-MM â†’ 'YY-MM ë³€í™˜
const shortMonth = (m) => `'${m.slice(2)}`;
const $ = s => document.querySelector(s);
const fmt1 = n => (Math.round(n*10)/10).toFixed(1);
const yyyymm = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
const KST = (ts)=> new Date(new Date(ts).toLocaleString("en-US",{timeZone:"Asia/Seoul"}));
const cmpMonth = (a,b)=> a.localeCompare(b); // YYYY-MM ë¬¸ìì—´ ë¹„êµ
const POINT_WIN = 2, POINT_LOSE = -1;

// ===== Query Param =====
const params = new URLSearchParams(location.search);
const playerName = params.get('name') || '';
$('#playerNameSub').textContent = playerName ? `ì„ ìˆ˜: ${playerName}` : 'ì„ ìˆ˜ ì´ë¦„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤';

// ===== Data holders =====
let playerLevels = {};      // {name: level}
let months = [];            // ìˆ˜ì§‘ëœ ì›”(ë¬¸ìì—´) ì •ë ¬
let perMonthAll = {};       // { 'YYYY-MM': { total, win, lose, rate } }  // í†µí•©
let perMonthSingle = {};    // { 'YYYY-MM': { total, win, lose, rate } }  // 11ì›”~
let perMonthDouble = {};    // { 'YYYY-MM': { total, win, lose, rate, points } } // 11ì›”~
let oppMapSingle = {};      // { opponentName: { win, lose } } (11ì›”~)
let partnerMapDouble = {};  // { "íŒŒíŠ¸ë„ˆ": { win, lose, points } } (11ì›”~)
let sumPointsFromNov = 0;   // 11ì›”~ ê°œì¸ ëˆ„ì  ìŠ¹ì 
let sumSglTotal = 0, sumSglWin = 0, sumSglLose = 0;
let sumDblTotal = 0, sumDblWin = 0, sumDblLose = 0;
let sumAllTotal = 0, sumAllWin = 0, sumAllLose = 0;

// ===== Fetch players level =====
const playerSnap = await get(ref(db,'players'));
if (playerSnap.exists()){
  const pdata = playerSnap.val() || {};
  Object.values(pdata).forEach(p=>{
    if (p.name) playerLevels[p.name] = p.level ?? '-';
  });
}

// ===== 1) 9ì›”/10ì›”: monthlyReports â†’ í†µí•©ì „ì ë§Œ =====
async function loadPastMonths(){
  const targets = ['2025-09','2025-10'];
  for (const m of targets){
    const snap = await get(ref(db, `monthlyReports/${m}/players`));
    if (!snap.exists()) continue;
    const arr = Object.values(snap.val());
    // ë°ì´í„° ìŠ¤í‚¤ë§ˆ ê°€ë³€ ëŒ€ì‘: wins/losses/winRate or win/lose/rate
    const row = arr.find(r => (r.name === playerName));
    if (!row) continue;

    const win = Number(row.wins ?? row.win ?? 0);
    const lose = Number(row.losses ?? row.lose ?? 0);
    const total = win + lose;
    const rate = total ? (win/total*100) : 0;

    perMonthAll[m] = { total, win, lose, rate };
    months.push(m);

    sumAllTotal += total; sumAllWin += win; sumAllLose += lose;
  }
}

// ===== 2) 11ì›”~: matches â†’ ë‹¨ì‹/ë³µì‹ ë¶„ë¦¬ & ìƒì„¸ =====
async function loadMatchesFromNov(){
  const snap = await get(ref(db,'matches'));
  if (!snap.exists()) return;
  const data = Object.values(snap.val());

  const NOV_2025 = '2025-11';

  // ì„ ë³„: monthKey >= 2025-11 & ì´ ì„ ìˆ˜ í¬í•¨ ê²½ê¸°
  const myMatches = data.filter(m=>{
    const mk = m.monthKey || yyyymm(KST(m.createdAt ?? Date.now()));
    if (cmpMonth(mk, NOV_2025) < 0) return false;
    const names = [...(m.namesA||[]), ...(m.namesB||[])];
    return names.includes(playerName);
  });

  // ì›” ëª©ë¡
  myMatches.forEach(m=>{
    const mk = m.monthKey || yyyymm(KST(m.createdAt ?? Date.now()));
    if (!months.includes(mk)) months.push(mk);
  });

  // ì´ˆê¸°í™”
  months.forEach(m=>{
    if (!perMonthAll[m])    perMonthAll[m]    = { total:0, win:0, lose:0, rate:0 };
    if (!perMonthSingle[m]) perMonthSingle[m] = { total:0, win:0, lose:0, rate:0 };
    if (!perMonthDouble[m]) perMonthDouble[m] = { total:0, win:0, lose:0, rate:0, points:0 };
  });

  // ì§‘ê³„
  myMatches.forEach(m=>{
    const mk = m.monthKey || yyyymm(KST(m.createdAt ?? Date.now()));
    const sideA = m.namesA || [];
    const sideB = m.namesB || [];
    const mode  = m.mode || 'single'; // ì•ˆì „
    const winA = (m.winnerSide === 'A');
    const iAmA = sideA.includes(playerName);
    const iAmB = sideB.includes(playerName);

    const iWon = (winA && iAmA) || (!winA && iAmB);
    const iLose= !iWon;

    // í†µí•©
    perMonthAll[mk].total++; if (iWon) perMonthAll[mk].win++; else perMonthAll[mk].lose++;

    // ë‹¨/ë³µì‹ ë¶„ê¸°
    if (mode === 'single'){
      perMonthSingle[mk].total++; if (iWon) perMonthSingle[mk].win++; else perMonthSingle[mk].lose++;

      // ìƒëŒ€ ì´ë¦„
      const opp = iAmA ? sideB[0] : sideA[0];
      if (opp){
        if (!oppMapSingle[opp]) oppMapSingle[opp] = { win:0, lose:0 };
        if (iWon) oppMapSingle[opp].win++; else oppMapSingle[opp].lose++;
      }
    } else if (mode === 'double'){
      perMonthDouble[mk].total++; if (iWon) perMonthDouble[mk].win++; else perMonthDouble[mk].lose++;

      // ìŠ¹ì 
      perMonthDouble[mk].points += iWon ? POINT_WIN : POINT_LOSE;
      sumPointsFromNov += iWon ? POINT_WIN : POINT_LOSE;

      // íŒŒíŠ¸ë„ˆ: ê°™ì€ ì‚¬ì´ë“œì—ì„œ ë‚˜ ë§ê³  í•œ ëª…
      let partner = null;
      if (iAmA) partner = sideA.find(n => n !== playerName);
      else if (iAmB) partner = sideB.find(n => n !== playerName);
      if (partner){
        if (!partnerMapDouble[partner]) partnerMapDouble[partner] = { win:0, lose:0, points:0 };
        if (iWon){ partnerMapDouble[partner].win++; partnerMapDouble[partner].points += POINT_WIN; }
        else     { partnerMapDouble[partner].lose++; partnerMapDouble[partner].points += POINT_LOSE; }
      }
    }
  });

  // ë¹„ìœ¨ ê³„ì‚° + ëˆ„ì í•© ë°˜ì˜
  months.forEach(m=>{
    const a = perMonthAll[m];    a.rate = a.total? (a.win/a.total*100):0;
    if (perMonthSingle[m]){ const s = perMonthSingle[m]; s.rate = s.total? (s.win/s.total*100):0; }
    if (perMonthDouble[m]){ const d = perMonthDouble[m]; d.rate = d.total? (d.win/d.total*100):0; }
  });

  // KPI ì§‘ê³„
  months.forEach(m=>{
    const s = perMonthSingle[m] || { total:0, win:0, lose:0 };
    const d = perMonthDouble[m] || { total:0, win:0, lose:0 };
    sumSglTotal += s.total; sumSglWin += s.win; sumSglLose += s.lose;
    sumDblTotal += d.total; sumDblWin += d.win; sumDblLose += d.lose;
  });
}

// ===== ë Œë”: KPI & ì›”ë³„ ë¦¬ìŠ¤íŠ¸ & ìƒì„¸ =====
function renderKPI(){
  // ëˆ„ì  í†µí•©
  // (9~10ì›” monthlyReports + 11ì›”~ matches í•©ì‚°)
  // ì´ë¯¸ sumAll...ì€ 9~10ì›” ë°˜ì˜ë¨ â†’ 11ì›”~ í†µí•©ì„ ë”í•œë‹¤
  months.forEach(m=>{
    if (cmpMonth(m,'2025-11')>=0){
      const a = perMonthAll[m] || { total:0, win:0, lose:0 };
      sumAllTotal += a.total; sumAllWin += a.win; sumAllLose += a.lose;
    }
  });

// ëˆ„ì  ê²½ê¸°(í†µí•©)
$('#kpiAllTotal').textContent = `${sumAllTotal} ê²½ê¸°`;
$('#kpiAllWL').textContent    = `${sumAllWin}ìŠ¹ / ${sumAllLose}íŒ¨`;

// 11ì›”~ ë‹¨ì‹
$('#kpiSglTotal').textContent = `${sumSglTotal} ê²½ê¸°`;
$('#kpiSglWL').textContent    = `${sumSglWin}ìŠ¹ / ${sumSglLose}íŒ¨`;

// 11ì›”~ ë³µì‹
$('#kpiDblTotal').textContent = `${sumDblTotal} ê²½ê¸°`;
$('#kpiDblWL').textContent    = `${sumDblWin}ìŠ¹ / ${sumDblLose}íŒ¨`;

// 11ì›”~ ëˆ„ì  ìŠ¹ì 
$('#kpiPoints').textContent   = `${sumPointsFromNov} ì `;



  const lastMonth = months.length ? months.slice().sort().pop() : null;
$('#periodBadge').textContent =
  lastMonth
    ? `ì§‘ê³„ ë²”ìœ„: ${shortMonth('2025-09')} ~ ${shortMonth(lastMonth)}`
    : `ì§‘ê³„ ë²”ìœ„: ${shortMonth('2025-09')} ~ í˜„ì¬`;

}

function renderMonthCards(){
  const box = $('#monthList');
  box.innerHTML = '';

  const sortedMonths = months.slice().sort();
  sortedMonths.forEach(m=>{
    const a = perMonthAll[m] || { total:0, win:0, lose:0, rate:0 };
    const s = perMonthSingle[m] || { total:0, win:0, lose:0, rate:0 };
    const d = perMonthDouble[m] || { total:0, win:0, lose:0, rate:0, points:0 };

    const fromNov = cmpMonth(m,'2025-11')>=0;
    const pill = fromNov 
      ? `<span class="tag">ë‹¨/ë³µì‹ ë¶„ë¦¬</span>` 
      : `<span class="tag" style="background:#eef2ff;color:#3730a3">í†µí•©ì „ì </span>`;

    box.insertAdjacentHTML('beforeend', `
      <div class="item">
        <div class="l">
          ${pill}
          <div><b>${shortMonth(m)}</b></div>
        </div>
        <div class="r">
          ${fromNov
            ? `
              <div><b>í†µí•©</b> : ${a.total}ê²½ê¸°&nbsp;&nbsp;&nbsp;${fmt1(a.rate)}%</div>
              <div><b>ë‹¨ì‹</b> : ${s.total}ê²½ê¸°&nbsp;&nbsp;&nbsp;${fmt1(s.rate)}%</div>
              <div><b>ë³µì‹</b> : ${d.total}ê²½ê¸°&nbsp;&nbsp;&nbsp;${fmt1(d.rate)}%&nbsp;&nbsp;&nbsp;ìŠ¹ì  ${d.points}</div>
            `
            : `í†µí•© : ${a.total}ê²½ê¸°&nbsp;&nbsp;&nbsp;${a.win}ìŠ¹ ${a.lose}íŒ¨&nbsp;&nbsp;&nbsp;${fmt1(a.rate)}%`
          }
        </div>
      </div>
    `);
  });
}


function renderDetails(){
  // ë‹¨ì‹ â€” ìƒëŒ€ë³„
  const oppBox = $('#opponentSingles');
  oppBox.innerHTML = '';
  const oppArr = Object.entries(oppMapSingle)
  .map(([name,v])=>({
    name,
    win: v.win,
    lose: v.lose,
    total: v.win + v.lose,
    rate: (v.win + v.lose)
      ? ((v.win - v.lose) / (v.win + v.lose) * 100)
      : 0
  }))
  .sort((a,b)=> b.total - a.total)
  .slice(0,8);


new Chart($('#chartOpp'), {
  type:'bar',
  data:{
    labels: oppArr.map(o=>o.name),
    datasets:[{
      label:'ë‹¨ì‹ ìˆœìŠ¹ë¥ (%)',
      data: oppArr.map(o=>o.rate),
      backgroundColor:'#2563eb'
    }]
  },
  options:{
    responsive:true,
   // maintainAspectRatio:false,
    scales:{ y:{ min:-100, max:100 } }
  }
});

  if (!oppArr.length){
    oppBox.innerHTML = `<div class="dim">11ì›” ì´í›„ ë‹¨ì‹ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  }else{
    oppArr.forEach(o=>{
      const lvl = playerLevels[o.name] ?? '-';
      
      oppBox.insertAdjacentHTML('beforeend', `
  <div class="item item-inline">
    <span class="tag">ìƒëŒ€</span>
    <span>${o.name}(${lvl})&nbsp;&nbsp;&nbsp;${o.win}ìŠ¹ ${o.lose}íŒ¨&nbsp;&nbsp;&nbsp;${fmt1(o.rate)}%</span>
  </div>
`);



    });
  }

  // ë³µì‹ â€” íŒŒíŠ¸ë„ˆë³„
  const ptnBox = $('#partnerDoubles');
  ptnBox.innerHTML = '';
const ptnArr = Object.entries(partnerMapDouble)
  .map(([name,v])=>({
    name,
    win: v.win,
    lose: v.lose,
    total: v.win + v.lose,
    rate: (v.win + v.lose)
      ? ((v.win - v.lose) / (v.win + v.lose) * 100)
      : 0
  }))
  .sort((a,b)=> b.total - a.total)
  .slice(0,8);

new Chart($('#chartPartner'), {
  type:'bar',
  data:{
    labels: ptnArr.map(o=>o.name),
    datasets:[{
      label:'ë³µì‹ ìˆœìŠ¹ë¥ (%)',
      data: ptnArr.map(o=>o.rate),
      backgroundColor:'#16a34a'
    }]
  },
  options:{
    responsive:true,
    scales:{
      y:{
        min:-100,
        max:100
      }
    }
  }
});

  if (!ptnArr.length){
    ptnBox.innerHTML = `<div class="dim">11ì›” ì´í›„ ë³µì‹ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  }else{
    ptnArr.forEach(p=>{
      const lvl = playerLevels[p.name] ?? '-';
      const sign = p.points>0? `+${p.points}` : `${p.points}`;
    
      ptnBox.insertAdjacentHTML('beforeend', `
  <div class="item item-inline">
    <span class="tag">íŒŒíŠ¸ë„ˆ</span>
    <span>${p.name}(${lvl})&nbsp;&nbsp;&nbsp;${p.win}ìŠ¹ ${p.lose}íŒ¨&nbsp;&nbsp;&nbsp;${fmt1(p.rate)}% </span>
  </div>
`);



    });
  }
}

// ===== Charts (ì§€ì—° ë¡œë”©) =====
let chartsLoaded = false;
function buildCharts(){
  if (chartsLoaded) return;
  chartsLoaded = true;
  $('#canvasBox').style.display = 'block';

  // ì›” ì •ë ¬
  const ms = months.slice().sort();

  // 1) ì›”ë³„ ìŠ¹ë¥ (í†µí•©)
  const rateAll = ms.map(m=> (perMonthAll[m]?.rate ?? 0));
  new Chart($('#chartRate'), {
    type:'line',
    data:{
      labels: ms.map(shortMonth), datasets:[{label:'ì›”ë³„ ìŠ¹ë¥ (í†µí•©%)', data:rateAll, tension:.2}]
    },
    options:{responsive:true, plugins:{legend:{display:true}}}
  });

  // 2) ì›”ë³„ ê²½ê¸°ìˆ˜(í†µí•©)
  const gamesAll = ms.map(m=> (perMonthAll[m]?.total ?? 0));
  new Chart($('#chartGames'), {
    type:'bar',
    data:{labels: ms.map(shortMonth), datasets:[{label:'ì›”ë³„ ê²½ê¸°ìˆ˜(í†µí•©)', data:gamesAll}]},
    options:{responsive:true}
  });

  // 3) ë‹¨ì‹/ë³µì‹ ë¹„ìœ¨ (11ì›”~ í•©ì‚°)
  const sglSum = sumSglTotal;
  const dblSum = sumDblTotal;
  new Chart($('#chartModePie'), {
    type:'doughnut',
    data:{labels:['ë‹¨ì‹','ë³µì‹'], datasets:[{data:[sglSum, dblSum]}]},
    options:{responsive:true}
  });

  // 4) ìƒëŒ€ë³„ ìŠ¹ë¥  (Top 8)
 const oppArr = Object.entries(oppMapSingle).map(([name,v])=>({
  name,
  win: v.win,
  lose: v.lose,
  total: v.win + v.lose,
  rate: (v.win + v.lose) ? (v.win / (v.win + v.lose) * 100) : 0
}))
.sort((a,b)=> b.total - a.total)  // âœ… ê²Œì„ìˆ˜ ë§ì€ ìˆœìœ¼ë¡œ ì •ë ¬
.slice(0,8);                      // âœ… ìƒìœ„ 8ëª…ë§Œ ì„ íƒ

  new Chart($('#chartOpp'), {
    type:'bar',
    data:{labels: oppArr.map(o=>o.name), datasets:[{label:'ë‹¨ì‹ ìƒëŒ€ë³„ ìŠ¹ë¥ (%)', data: oppArr.map(o=>o.rate)}]},
    options:{responsive:true}
  });

  // 5) íŒŒíŠ¸ë„ˆë³„ ìŠ¹ë¥  (Top 8)
  const ptnArr = Object.entries(partnerMapDouble).map(([name,v])=>({
  name,
  win: v.win,
  lose: v.lose,
  total: v.win + v.lose,
  rate: (v.win + v.lose) ? (v.win / (v.win + v.lose) * 100) : 0
}))
.sort((a,b)=> b.total - a.total)  // âœ… ê²½ê¸°ìˆ˜ ë§ì€ ìˆœ
.slice(0,8);                      // âœ… ìƒìœ„ 8ëª…

  new Chart($('#chartPartner'), {
    type:'bar',
    data:{labels: ptnArr.map(o=>o.name), datasets:[{label:'ë³µì‹ íŒŒíŠ¸ë„ˆë³„ ìŠ¹ë¥ (%)', data: ptnArr.map(o=>o.rate)}]},
    options:{responsive:true}
  });

  // 6) ì›”ë³„ ëˆ„ì  ìŠ¹ì (ë³µì‹)
  const pts = ms.map(m => (perMonthDouble[m]?.points ?? 0));
  // ëˆ„ì í•©
  let run = 0; const ptsCum = pts.map(v=> (run+=v));
  new Chart($('#chartPoints'), {
    type:'line',
    data:{labels: ms.map(shortMonth), datasets:[{label:'ë³µì‹ ëˆ„ì  ìŠ¹ì ', data:ptsCum, tension:.2}]},
    options:{responsive:true}
  });
}

// ===== Bootstrap =====
await loadPastMonths();     // 2025-09, 2025-10 (í†µí•©)
await loadMatchesFromNov(); // 2025-11~ (ë‹¨/ë³µì‹ ë¶„ë¦¬)

months = [...new Set(months)].sort();

renderKPI();
renderMonthCards();
renderDetails();

// ë²„íŠ¼ë“¤
$('#openCharts').addEventListener('click', ()=>{ $('#btnLoadCharts').scrollIntoView({behavior:'smooth',block:'center'}); });
$('#btnLoadCharts').addEventListener('click', buildCharts);
</script>
</body>
</html>
