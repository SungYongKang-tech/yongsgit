<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ“ ê°œì¸ íƒêµ¬ ì„±ì  ë¦¬í¬íŠ¸</title>

<!-- Pretendard -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />

<style>
:root {
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb;
  --accent:#2563eb; --ok:#16a34a; --danger:#ef4444; 
  --card:#fff; --shadow:0 8px 28px rgba(0,0,0,.08);
}

body {
  margin:0;
  padding:0;
  font-family:"Pretendard","Noto Sans KR",sans-serif;
  background:var(--bg);
  color:var(--ink);
  font-weight:600;
}

header {
  background:#fff;
  box-shadow:var(--shadow);
  padding:18px 10px;
  text-align:center;
  position:sticky;
  top:0;
  z-index:50;
}
header h1 {
  margin:0;
  color:var(--accent);
  font-size:clamp(20px,4vw,26px);
  font-weight:800;
}

main {
  max-width:900px;
  margin:0 auto;
  padding:20px 10px 80px;
}

.section {
  margin-bottom:26px;
}

.section-title {
  font-size:20px;
  font-weight:800;
  margin-bottom:10px;
  color:#1e3a8a;
}

.card {
  background:var(--card);
  border-radius:14px;
  padding:20px;
  margin-bottom:16px;
  box-shadow:var(--shadow);
}

.summary-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:14px;
}

.summary-box {
  background:#e0f2fe;
  border-radius:10px;
  padding:14px;
  text-align:center;
  font-size:17px;
  font-weight:700;
}

.stat-list li {
  margin:5px 0;
  font-size:15px;
}

.table-wrap {
  overflow-x:auto;
}

table {
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:10px;
  overflow:hidden;
  font-size:14px;
  box-shadow:var(--shadow);
}

thead th {
  background:#e2e8f0;
  padding:10px 6px;
  text-align:center;
  white-space:nowrap;
}

tbody td {
  border-bottom:1px solid #f1f5f9;
  text-align:center;
  padding:9px 6px;
}

.win { color:var(--ok); font-weight:700; }
.lose { color:var(--danger); font-weight:700; }

.graph-btn {
  width:100%;
  background:var(--accent);
  color:#fff;
  padding:12px;
  text-align:center;
  border-radius:10px;
  font-size:17px;
  font-weight:700;
  cursor:pointer;
  margin-top:16px;
}

canvas {
  margin-top:16px;
  background:#fff;
  border-radius:12px;
  box-shadow:var(--shadow);
}
</style>
</head>

<body>
<header>
  <h1>ğŸ“ ê°œì¸ íƒêµ¬ ì„±ì  ë¦¬í¬íŠ¸</h1>
</header>

<main>
  
  <!-- âœ… í”„ë¡œí•„ ì˜ì—­ -->
  <section class="section" id="profileSection">
    <div class="card">
      <h2 class="section-title" id="playerNameTitle">ì„ ìˆ˜ ì´ë¦„</h2>
      <p style="font-size:16px; color:#475569;" id="levelInfo">ë¶€ìˆ˜: -</p>
    </div>
  </section>

  <!-- âœ… ìš”ì•½ ì˜ì—­ -->
  <section class="section">
    <div class="section-title">ğŸ“Œ ìš”ì•½ í†µê³„</div>
    <div class="summary-grid" id="summaryGrid"></div>
  </section>

  <!-- âœ… 9ì›”Â·10ì›” í†µí•© ì „ì  -->
  <section class="section" id="prevStatsSection">
    <div class="section-title">ğŸ“ 9ì›” Â· 10ì›” í†µí•© ì „ì </div>
    <div id="prevStatsCard" class="card"></div>
  </section>

  <!-- âœ… 11ì›” ì´í›„ ë‹¨ì‹/ë³µì‹ ë¶„ì„ -->
  <section class="section" id="detailedStatsSection">
    <div class="section-title">ğŸ“Š 11ì›” ì´í›„ ìƒì„¸ ë¶„ì„</div>
    <div id="detailedStatsCard" class="card"></div>
  </section>

  <!-- âœ… ê·¸ë˜í”„ ë²„íŠ¼ -->
  <button id="loadGraphsBtn" class="graph-btn">ğŸ“Š ê·¸ë˜í”„ ì—´ê¸°</button>

  <!-- âœ… ê·¸ë˜í”„ ì˜ì—­ -->
  <section class="section" id="graphSection" style="display:none;">
    <div class="section-title">ğŸ“ˆ ê°œì¸ ê·¸ë˜í”„ ë¶„ì„</div>

    <canvas id="chart_monthly_rate"></canvas>
    <canvas id="chart_monthly_games"></canvas>
    <canvas id="chart_type_ratio"></canvas>
    <canvas id="chart_vs"></canvas>
    <canvas id="chart_partner"></canvas>
    <canvas id="chart_score"></canvas>
  </section>

</main>


<!-- âœ… Firebase + ë°ì´í„° ì²˜ë¦¬ ìŠ¤í¬ë¦½íŠ¸ -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};

// âœ… Firebase ì´ˆê¸°í™”
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

// âœ… URL íŒŒë¼ë¯¸í„°ì—ì„œ name ì¶”ì¶œ
const params     = new URLSearchParams(window.location.search);
const playerName = params.get("name");

document.getElementById("playerNameTitle").innerText = `${playerName} ì„ ìˆ˜ ì„±ì  ë¦¬í¬íŠ¸`;

function format(n){ return (Math.round(n*10)/10).toFixed(1); }

// âœ… ê¸€ë¡œë²Œ ëˆ„ì  ë°ì´í„°
let playerLevel = "-";

// âœ… 9ì›”, 10ì›” ë°ì´í„° ì €ì¥
let prevStats = {
  total: 0,
  win: 0,
  lose: 0,
  rate: 0
};

// âœ… 11ì›” ì´í›„ ë‹¨ì‹/ë³µì‹/ìƒëŒ€/íŒŒíŠ¸ë„ˆ/ìŠ¹ì  ë°ì´í„°
let analysis = {
  single: { total:0, win:0, lose:0 },
  double: { total:0, win:0, lose:0 },
  vs: {},          // ìƒëŒ€ë³„ ì „ì 
  partner: {},     // íŒŒíŠ¸ë„ˆë³„ ì „ì 
  pointHistory: [] // ì›”ë³„ ìŠ¹ì 
};

// âœ… ë‹¨ê³„ 1 â€” ì„ ìˆ˜ ë¶€ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadPlayerLevel() {
  const snap = await get(ref(db, "players"));
  if (!snap.exists()) return;

  const players = snap.val();
  Object.values(players).forEach(p => {
    if (p.name === playerName) {
      playerLevel = p.level;
    }
  });

  document.getElementById("levelInfo").innerText = `ë¶€ìˆ˜: ${playerLevel}`;
}

// âœ… ë‹¨ê³„ 2 â€” 9ì›”/10ì›” í†µí•© ì „ì  ë¶ˆëŸ¬ì˜¤ê¸°
async function loadPreviousMonths() {
  const months = ["2025-09", "2025-10"];

  for (let m of months) {
    const snap = await get(ref(db, `monthlyReports/${m}/players`));
    if (!snap.exists()) continue;

    const arr = snap.val();

    Object.values(arr).forEach(p => {
      if (p.name === playerName) {
        prevStats.win   += p.wins ?? p.win ?? 0;
        prevStats.lose  += p.losses ?? p.lose ?? 0;
      }
    });
  }

  prevStats.total = prevStats.win + prevStats.lose;
  prevStats.rate  = prevStats.total ? (prevStats.win / prevStats.total * 100) : 0;

  renderPrevStats();
}

// âœ… ë‹¨ê³„ 3 â€” 11ì›” ì´í›„ ìƒì„¸ ë¶„ì„
async function loadDetailedStats() {
  const snap = await get(ref(db, "matches"));
  if (!snap.exists()) return;

  const matches = snap.val();

  Object.values(matches).forEach(m => {
    if (!m.monthKey || m.monthKey < "2025-11") return;

    const isSingle = m.mode === "single";
    const isDouble = m.mode === "double";

    let isInvolved = false;
    if (m.namesA.includes(playerName) || m.namesB.includes(playerName)) {
      isInvolved = true;
    }
    if (!isInvolved) return;

    // âœ… ë‹¨ì‹/ë³µì‹ ì¹´ìš´íŠ¸
    let statType = isSingle ? analysis.single : analysis.double;
    statType.total++;

    let win = false;
    if (m.winnerSide === 'A' && m.namesA.includes(playerName)) win = true;
    if (m.winnerSide === 'B' && m.namesB.includes(playerName)) win = true;

    if (win) statType.win++; else statType.lose++;

    // âœ… ìŠ¹ì  ê¸°ë¡ (+2 / -1)
    analysis.pointHistory.push({
      month: m.monthKey,
      point: win ? 2 : -1
    });

    // âœ… ìƒëŒ€ë³„ ì „ì 
    let opponents = m.namesA.includes(playerName) ? m.namesB : m.namesA;
    opponents.forEach(op => {
      if (!analysis.vs[op]) analysis.vs[op] = { win:0, lose:0 };
      if (win) analysis.vs[op].win++; else analysis.vs[op].lose++;
    });

    // âœ… íŒŒíŠ¸ë„ˆ ì „ì  (ë³µì‹ë§Œ)
    if (isDouble) {
      let myTeam = m.namesA.includes(playerName) ? m.namesA : m.namesB;
      myTeam.forEach(p => {
        if (p === playerName) return;
        if (!analysis.partner[p]) analysis.partner[p] = { win:0, lose:0 };
        if (win) analysis.partner[p].win++; else analysis.partner[p].lose++;
      });
    }
  });

  renderDetailedStats();
  updateSummary();
}

// âœ… 9ì›”Â·10ì›” ê²°ê³¼ ì¶œë ¥
function renderPrevStats() {
  const box = document.getElementById("prevStatsCard");

  if (prevStats.total === 0) {
    box.innerHTML = `<p style="color:#64748b;">ê¸°ë¡ ì—†ìŒ</p>`;
    return;
  }

  box.innerHTML = `
    <ul class="stat-list">
      <li><b>ì´ ê²½ê¸°:</b> ${prevStats.total}</li>
      <li><b>ìŠ¹ / íŒ¨:</b> ${prevStats.win}ìŠ¹ / ${prevStats.lose}íŒ¨</li>
      <li><b>ìŠ¹ë¥ :</b> ${format(prevStats.rate)}%</li>
    </ul>
  `;
}

// âœ… 11ì›” ì´í›„ ìƒì„¸ ë¶„ì„ ì¶œë ¥
function renderDetailedStats() {
  const box = document.getElementById("detailedStatsCard");

  const s = analysis.single;
  const d = analysis.double;

  box.innerHTML = `
    <ul class="stat-list">
      <li><b>ë‹¨ì‹:</b> ${s.total}ê²½ê¸° (${s.win}ìŠ¹ / ${s.lose}íŒ¨)</li>
      <li><b>ë³µì‹:</b> ${d.total}ê²½ê¸° (${d.win}ìŠ¹ / ${d.lose}íŒ¨)</li>
      <li><b>ì „ì²´ ìŠ¹ë¥ :</b> ${format((s.win + d.win) / (s.total + d.total) * 100 || 0)}%</li>
    </ul>
  `;
}

// âœ… ìš”ì•½ í†µê³„ ë°•ìŠ¤ ì—…ë°ì´íŠ¸
function updateSummary() {
  const grid = document.getElementById("summaryGrid");

  const totalGames = prevStats.total + analysis.single.total + analysis.double.total;
  const totalWin   = prevStats.win + analysis.single.win + analysis.double.win;
  const totalRate  = totalGames ? (totalWin / totalGames * 100) : 0;

  grid.innerHTML = `
    <div class="summary-box">ì´ ê²½ê¸°: ${totalGames}</div>
    <div class="summary-box">ì´ ìŠ¹ë¥ : ${format(totalRate)}%</div>
    <div class="summary-box">ë‹¨ì‹ ${analysis.single.win}ìŠ¹</div>
    <div class="summary-box">ë³µì‹ ${analysis.double.win}ìŠ¹</div>
  `;
}

// âœ… ì´ˆê¸° ë¡œë”© ì‹¤í–‰
await loadPlayerLevel();
await loadPreviousMonths();
await loadDetailedStats();
</script>

<!-- âœ… Chart.js + ê·¸ë˜í”„ ë Œë”ë§ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// âœ… Chart ì¸ìŠ¤í„´ìŠ¤ ë³´ê´€ (ê²¹ì¹¨ ë°©ì§€!)
let chartMonthlyRate   = null;
let chartMonthlyGames  = null;
let chartTypeRatio     = null;
let chartVs            = null;
let chartPartner       = null;
let chartScore         = null;

// âœ… ì´ë¯¸ ë¡œë”©í–ˆëŠ”ì§€ ì²´í¬
let graphLoaded = false;

// âœ… ê·¸ë˜í”„ ìƒì„± í•¨ìˆ˜
function createCharts() {
  if (graphLoaded) return;   // âœ… ì¤‘ë³µ ìƒì„± ë°©ì§€
  graphLoaded = true;

  document.getElementById("graphSection").style.display = "block";

  // âœ… 1) ì›”ë³„ ìŠ¹ë¥ 
  {
    const ctx = document.getElementById("chart_monthly_rate").getContext("2d");

    const monthMap = {};

    // 9ì›”~10ì›”
    if (prevStats.total > 0) {
      monthMap["2025-09~10"] = {
        win: prevStats.win,
        lose: prevStats.lose
      };
    }

    // 11ì›” ì´í›„
    analysis.pointHistory.forEach(item => {
      if (!monthMap[item.month]) monthMap[item.month] = { win: 0, lose: 0 };
      if (item.point === 2) monthMap[item.month].win++;
      else monthMap[item.month].lose++;
    });

    const labels = Object.keys(monthMap);
    const rateData = labels.map(m => {
      const w = monthMap[m].win;
      const l = monthMap[m].lose;
      return (w + l) ? (w / (w + l) * 100) : 0;
    });

    if (chartMonthlyRate) chartMonthlyRate.destroy();
    chartMonthlyRate = new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: "ìŠ¹ë¥  (%)",
          data: rateData,
          backgroundColor: "#2563eb88",
          borderColor: "#2563eb",
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, max: 100 }
        }
      }
    });
  }

  // âœ… 2) ì›”ë³„ ê²½ê¸° ìˆ˜
  {
    const ctx = document.getElementById("chart_monthly_games").getContext("2d");

    const monthMap = {};

    if (prevStats.total > 0) {
      monthMap["2025-09~10"] = prevStats.total;
    }

    analysis.pointHistory.forEach(item => {
      if (!monthMap[item.month]) monthMap[item.month] = 0;
      monthMap[item.month]++;
    });

    const labels = Object.keys(monthMap);
    const gameData = Object.values(monthMap);

    if (chartMonthlyGames) chartMonthlyGames.destroy();
    chartMonthlyGames = new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: "ê²½ê¸° ìˆ˜",
          data: gameData,
          backgroundColor: "#1e40af99",
          borderColor: "#1e40af",
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  // âœ… 3) ë‹¨ì‹/ë³µì‹ ë¹„ìœ¨ (ë„ë„›)
  {
    const ctx = document.getElementById("chart_type_ratio").getContext("2d");

    let single = analysis.single.total;
    let double = analysis.double.total;

    if (chartTypeRatio) chartTypeRatio.destroy();
    chartTypeRatio = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: ["ë‹¨ì‹", "ë³µì‹"],
        datasets: [{
          data: [single, double],
          backgroundColor: ["#3b82f6", "#60a5fa"]
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: "bottom" } }
      }
    });
  }

  // âœ… 4) ìƒëŒ€ë³„ ì „ì 
  {
    const ctx = document.getElementById("chart_vs").getContext("2d");

    const labels = Object.keys(analysis.vs);
    const winData = labels.map(n => analysis.vs[n].win);
    const loseData = labels.map(n => analysis.vs[n].lose);

    if (chartVs) chartVs.destroy();
    chartVs = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            label: "ìŠ¹",
            data: winData,
            backgroundColor: "#16a34a"
          },
          {
            label: "íŒ¨",
            data: loseData,
            backgroundColor: "#ef4444"
          }
        ]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  // âœ… 5) íŒŒíŠ¸ë„ˆë³„ ì „ì 
  {
    const ctx = document.getElementById("chart_partner").getContext("2d");

    const labels = Object.keys(analysis.partner);
    const winData = labels.map(n => analysis.partner[n].win);
    const loseData = labels.map(n => analysis.partner[n].lose);

    if (chartPartner) chartPartner.destroy();
    chartPartner = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            label: "ìŠ¹",
            data: winData,
            backgroundColor: "#0d9488"
          },
          {
            label: "íŒ¨",
            data: loseData,
            backgroundColor: "#f97316"
          }
        ]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  // âœ… 6) ëˆ„ì  ìŠ¹ì  ë³€í™”
  {
    const ctx = document.getElementById("chart_score").getContext("2d");

    let monthGroup = {};

    analysis.pointHistory.forEach(item => {
      if (!monthGroup[item.month]) monthGroup[item.month] = 0;
      monthGroup[item.month] += item.point;
    });

    const labels = Object.keys(monthGroup);
    const scoreData = Object.values(monthGroup);

    if (chartScore) chartScore.destroy();
    chartScore = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "ì›”ë³„ ìŠ¹ì ",
          data: scoreData,
          borderColor: "#2563eb",
          borderWidth: 3,
          pointBackgroundColor: "#1d4ed8",
          tension: 0.25
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });
  }
}

// âœ… ë²„íŠ¼ í´ë¦­ ì‹œ ê·¸ë˜í”„ ìƒì„±
document.getElementById("loadGraphsBtn").addEventListener("click", createCharts);
</script>


</body>
</html>
