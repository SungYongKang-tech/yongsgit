<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“ ê°œì¸ íƒêµ¬ ì„±ì  ë¦¬í¬íŠ¸</title>

<!-- Pretendard -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb; --card:#ffffff;
  --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
  --shadow:0 10px 30px rgba(2,6,23,.08);
  --soft:#eaf1ff; --soft2:#eef2ff;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:"Pretendard","Noto Sans KR",system-ui,-apple-system,sans-serif;
  background:var(--bg); color:var(--ink); font-weight:600;
}
header{
  position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #e5e7eb;
}
.header-inner{
  max-width:1080px; margin:0 auto; padding:14px 16px; display:flex; gap:10px; align-items:center; justify-content:space-between;
}
h1{margin:0; font-size:clamp(18px,4vw,22px); color:var(--accent); font-weight:800}
.sub{font-size:13px; color:#334155; font-weight:700}
.btn{
  border:1px solid #d1d5db; background:#fff; color:#0f172a; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700;
}
.btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
.btn.ghost{background:#f8fafc}
.wrap{max-width:1080px; margin:0 auto; padding:16px}
.grid{
  display:grid; gap:14px;
  grid-template-columns: repeat(12, 1fr);
}
.card{
  background:var(--card); border-radius:16px; box-shadow:var(--shadow); padding:16px;
}
.card h3{margin:0 0 8px; font-size:18px; color:#1e3a8a}
.kv{display:flex; flex-wrap:wrap; gap:10px}
.badge{display:inline-block; padding:6px 10px; border-radius:999px; font-size:13px; background:var(--soft); color:#1e3a8a}
.big{
  font-size:30px; font-weight:900; color:#0f172a; letter-spacing:-.5px;
}
.row{display:flex; align-items:center; gap:8px}
.hr{height:1px; background:#eef2f7; margin:12px 0}
.dim{color:#64748b; font-weight:700; font-size:13px}
.kpi{
  display:grid; gap:10px; grid-template-columns: repeat(4,1fr);
}
.kpi .mini{
  border:1px solid #e5e7eb; border-radius:12px; padding:14px; background:linear-gradient(180deg,#fff, #fbfdff 85%);
}
.kpi .mini h4{margin:0 0 6px; font-size:13px; color:#334155}
.kpi .mini .v{font-size:22px; font-weight:900}
.kpi .good{border-color:#c7f3d5; background:linear-gradient(180deg,#fff, #f3fff7 85%)}
.kpi .warn{border-color:#ffd5d5; background:linear-gradient(180deg,#fff, #fff6f6 85%)}
.block-title{font-size:16px; font-weight:900; color:#0f172a; margin-bottom:8px}
.list{
  display:grid; gap:8px;
}
.item{
  border:1px solid #e5e7eb; padding:10px 12px; border-radius:12px; display:flex; align-items:center; justify-content:space-between;
  background:linear-gradient(180deg,#fff, #fbfdff 85%);
  box-shadow:0 2px 10px rgba(2,6,23,.02);
}
.item .l{display:flex; gap:8px; align-items:center}
.tag{font-size:12px; background:#e2efff; color:#1e40af; padding:4px 8px; border-radius:999px; font-weight:800}
.item .r{font-weight:900}
.btn-xl{
  display:inline-flex; align-items:center; gap:8px; padding:12px 16px; border-radius:12px; border:1px solid #c7d2fe;
  background:linear-gradient(180deg,#fff, #f3f5ff 75%); color:#1e3a8a; font-size:15px; font-weight:900; cursor:pointer;
}
.canvas-box{
  background:#fff; border:1px dashed #dbe3ff; border-radius:12px; padding:12px; display:none;
}
.canvas-grid{
  display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
}
.note{
  font-size:12.5px; color:#475569; margin-top:6px; text-align:right
}
@media (max-width:900px){
  .kpi{grid-template-columns: repeat(2,1fr)}
}
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div>
      <h1>ğŸ“ ê°œì¸ íƒêµ¬ ì„±ì  ë¦¬í¬íŠ¸</h1>
      <div class="sub" id="playerNameSub">ì„ ìˆ˜ ì´ë¦„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
    </div>
    <div class="row">
      <a class="btn" href="monthly-report.html">â† ì›”ê°„ ë¦¬í¬íŠ¸</a>
      <button id="openCharts" class="btn primary">ğŸ“Š ê·¸ë˜í”„ ì—´ê¸°</button>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- âœ… ìƒë‹¨ KPI ì˜ì—­ -->
  <section class="grid" style="grid-template-columns:repeat(12,1fr);">
    <div class="card" style="grid-column: span 12;">
      <div class="row" style="justify-content:space-between;">
        <div class="row" style="gap:12px">
          <div class="badge" id="periodBadge">ë°ì´í„° ê¸°ê°„: ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
          <div class="badge" id="modeBadge">11ì›”ë¶€í„° ë‹¨ì‹/ë³µì‹ ìë™ ë¶„ë¦¬</div>
        </div>
        <div class="row">
          <span class="dim">ìŠ¹ì  ê·œì¹™: ìŠ¹ +2 / íŒ¨ -1</span>
        </div>
      </div>

      <div class="hr"></div>

      <div class="kpi" id="kpiWrap">
        <div class="mini">
          <h4>ëˆ„ì  ê²½ê¸°(í†µí•©)</h4>
          <div class="v" id="kpiAllTotal">-</div>
          <div class="dim" id="kpiAllWL">-</div>
        </div>
        <div class="mini">
          <h4>11ì›”~ ë‹¨ì‹</h4>
          <div class="v" id="kpiSglTotal">-</div>
          <div class="dim" id="kpiSglWL">-</div>
        </div>
        <div class="mini">
          <h4>11ì›”~ ë³µì‹</h4>
          <div class="v" id="kpiDblTotal">-</div>
          <div class="dim" id="kpiDblWL">-</div>
        </div>
        <div class="mini">
          <h4>11ì›”~ ëˆ„ì  ìŠ¹ì </h4>
          <div class="v" id="kpiPoints">-</div>
          <div class="dim">ìŠ¹Ã—2 - íŒ¨</div>
        </div>
      </div>
    </div>
  </section>

  <!-- âœ… ì›”ë³„ ì¹´ë“œ -->
  <section class="grid" style="margin-top:12px;">
    <div class="card" style="grid-column: span 12;">
      <h3>ğŸ“… ì›”ë³„ í†µí•© ê¸°ë¡ (2025-09, 2025-10: í†µí•©ì „ì  / 2025-11~: ë‹¨ì‹Â·ë³µì‹ ë¶„ë¦¬)</h3>
      <div id="monthList" class="list"></div>
      <div class="note">* 2025-09 ~ 2025-10ì€ ë‹¨Â·ë³µì‹ êµ¬ë¶„ ì—†ì´ í†µí•©ì „ì ë§Œ ì œê³µë©ë‹ˆë‹¤.</div>
    </div>
  </section>

  <!-- âœ… ìƒì„¸ ë¶„ì„ -->
  <section class="grid" style="margin-top:12px;">
    <div class="card" style="grid-column: span 12;">
      <h3>ğŸ” ìƒì„¸ ë¶„ì„ (11ì›”~)</h3>
      <div class="grid" style="grid-template-columns:repeat(12,1fr); gap:12px;">
        <div class="card" style="grid-column: span 6;">
          <div class="block-title">ë‹¨ì‹ â€” ìƒëŒ€ë³„ ì „ì </div>
          <div id="opponentSingles" class="list"></div>
        </div>
        <div class="card" style="grid-column: span 6;">
          <div class="block-title">ë³µì‹ â€” íŒŒíŠ¸ë„ˆë³„ ì „ì </div>
          <div id="partnerDoubles" class="list"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- âœ… ê·¸ë˜í”„ (ì§€ì—° ë¡œë”©) -->
  <section class="grid" style="margin-top:12px;">
    <div class="card" style="grid-column: span 12;">
      <h3>ğŸ“Š ì‹œê°í™”</h3>
      <button class="btn-xl" id="btnLoadCharts">ğŸ“ˆ ê·¸ë˜í”„ ì—´ê¸° (ì§€ì—° ë¡œë”©)</button>
      
      <div class="canvas-box" id="canvasBox" style="margin-top:12px;">
        <div class="canvas-grid">
          <canvas id="chartRate"></canvas>
          <canvas id="chartGames"></canvas>
          <canvas id="chartModePie"></canvas>
          <canvas id="chartOpp"></canvas>
          <canvas id="chartPartner"></canvas>
          <canvas id="chartPoints"></canvas>
        </div>
      </div>
      <div class="note">* ë²„íŠ¼ì„ ëˆŒëŸ¬ ê·¸ë˜í”„ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤. (ëª¨ë°”ì¼ ìµœì í™”)</div>
    </div>
  </section>

</main>

<!-- âœ… Firebase + ë°ì´í„° ì²˜ë¦¬ -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

/* ------------------------------
   âœ… Firebase ì´ˆê¸°í™”
------------------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ------------------------------
   âœ… Utils
------------------------------ */
const $ = s => document.querySelector(s);
const fmt1 = n => (Math.round(n*10)/10).toFixed(1);
const yyyymm = (d)=> `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
const POINT_WIN  = 2;
const POINT_LOSE = -1;

// ì›” ë¹„êµ
const cmpMonth = (a,b)=> a.localeCompare(b);

/* ------------------------------
   âœ… URL íŒŒë¼ë¯¸í„°
------------------------------ */
const params     = new URLSearchParams(location.search);
const playerName = params.get("name") || "";
$("#playerNameSub").textContent = playerName ? `ì„ ìˆ˜: ${playerName}` : "ì„ ìˆ˜ ì •ë³´ ì—†ìŒ";

/* ------------------------------
   âœ… ë¡œì»¬ ë°ì´í„° êµ¬ì¡°
------------------------------ */
let playerLevels = {};
let months = [];

let perMonthAll    = {}; // ì›”ë³„ í†µí•©
let perMonthSingle = {}; // ì›”ë³„ ë‹¨ì‹
let perMonthDouble = {}; // ì›”ë³„ ë³µì‹

let oppMapSingle   = {}; // ìƒëŒ€ë³„ ë‹¨ì‹
let partnerMapDouble = {}; // íŒŒíŠ¸ë„ˆë³„ ë³µì‹

let sumAllTotal = 0, sumAllWin = 0, sumAllLose = 0;
let sumSglTotal = 0, sumSglWin = 0, sumSglLose = 0;
let sumDblTotal = 0, sumDblWin = 0, sumDblLose = 0;
let sumPoints = 0;

/* ------------------------------
   âœ… 1) Players (ë¶€ìˆ˜) ë¡œë”©
------------------------------ */
async function loadPlayers() {
  const snap = await get(ref(db, "players"));
  if (!snap.exists()) return;

  const data = snap.val();
  Object.values(data).forEach(p => {
    if (p.name) playerLevels[p.name] = p.level ?? "-";
  });
}

/* ------------------------------
   âœ… 2) 2025-09, 10 : monthlyReports (í†µí•©ì „ì )
------------------------------ */
async function loadPastReports() {
  const targets = ["2025-09", "2025-10"];

  for (let m of targets) {
    const snap = await get(ref(db, `monthlyReports/${m}/players`));
    if (!snap.exists()) continue;

    const arr = Object.values(snap.val());
    const row = arr.find(p => p.name === playerName);
    if (!row) continue;

    const win  = Number(row.wins ?? row.win ?? 0);
    const lose = Number(row.losses ?? row.lose ?? 0);
    const total = win + lose;
    const rate  = total ? win / total * 100 : 0;

    perMonthAll[m] = { total, win, lose, rate };
    months.push(m);

    sumAllTotal += total;
    sumAllWin   += win;
    sumAllLose  += lose;
  }
}

/* ------------------------------
   âœ… 3) 11ì›” ì´í›„: matchesì—ì„œ ë‹¨ì‹Â·ë³µì‹ ë¶„ë¦¬
------------------------------ */
async function loadAfterNov() {
  const snap = await get(ref(db, "matches"));
  if (!snap.exists()) return;

  const NOV = "2025-11";
  const matches = Object.values(snap.val());

  const myGames = matches.filter(m => {
    const mk = m.monthKey;
    if (!mk) return false;
    if (cmpMonth(mk, NOV) < 0) return false;

    return [...m.namesA, ...m.namesB].includes(playerName);
  });

  // ì›” ëª©ë¡ í™•ë³´
  myGames.forEach(g => {
    if (!months.includes(g.monthKey)) months.push(g.monthKey);
  });

  // ì›”ë³„ ì´ˆê¸°í™”
  months.forEach(m => {
    if (!perMonthAll[m]) perMonthAll[m] = { total:0, win:0, lose:0, rate:0 };
    if (!perMonthSingle[m]) perMonthSingle[m] = { total:0, win:0, lose:0, rate:0 };
    if (!perMonthDouble[m]) perMonthDouble[m] = { total:0, win:0, lose:0, rate:0, points:0 };
  });

  // ì§‘ê³„
  myGames.forEach(g => {
    const mk = g.monthKey;
    const mode = g.mode || "single";

    const A = g.namesA || [];
    const B = g.namesB || [];
    const iAmA = A.includes(playerName);
    const iWon = (g.winnerSide === "A" && iAmA) || (g.winnerSide === "B" && !iAmA);

    // í†µí•©
    perMonthAll[mk].total++;
    if (iWon) perMonthAll[mk].win++; else perMonthAll[mk].lose++;

    // ë‹¨ì‹
    if (mode === "single") {
      perMonthSingle[mk].total++;
      if (iWon) perMonthSingle[mk].win++; else perMonthSingle[mk].lose++;

      const opp = iAmA ? B[0] : A[0];
      if (opp) {
        if (!oppMapSingle[opp]) oppMapSingle[opp] = { win:0, lose:0 };
        if (iWon) oppMapSingle[opp].win++; else oppMapSingle[opp].lose++;
      }

    // ë³µì‹
    } else if (mode === "double") {
      perMonthDouble[mk].total++;
      if (iWon) perMonthDouble[mk].win++; else perMonthDouble[mk].lose++;

      const pts = iWon ? POINT_WIN : POINT_LOSE;
      perMonthDouble[mk].points += pts;
      sumPoints += pts;

      const team = iAmA ? A : B;
      const partner = team.find(n => n !== playerName);
      if (partner) {
        if (!partnerMapDouble[partner]) partnerMapDouble[partner] = { win:0, lose:0, points:0 };
        if (iWon) {
          partnerMapDouble[partner].win++;
          partnerMapDouble[partner].points += POINT_WIN;
        } else {
          partnerMapDouble[partner].lose++;
          partnerMapDouble[partner].points += POINT_LOSE;
        }
      }
    }
  });

  // ìŠ¹ë¥  ê³„ì‚°
  months.forEach(m => {
    const a = perMonthAll[m]; 
    const s = perMonthSingle[m];
    const d = perMonthDouble[m];

    a.rate = a.total ? a.win / a.total * 100 : 0;
    if (s) s.rate = s.total ? s.win / s.total * 100 : 0;
    if (d) d.rate = d.total ? d.win / d.total * 100 : 0;

    sumSglTotal += s.total; sumSglWin += s.win; sumSglLose += s.lose;
    sumDblTotal += d.total; sumDblWin += d.win; sumDblLose += d.lose;

    sumAllTotal += a.total; sumAllWin += a.win; sumAllLose += a.lose;
  });
}

/* ------------------------------
   âœ… KPI ë Œë”ë§
------------------------------ */
function renderKPI() {
  $("#kpiAllTotal").textContent = sumAllTotal;
  $("#kpiAllWL").textContent    = `${sumAllWin}ìŠ¹ / ${sumAllLose}íŒ¨`;

  $("#kpiSglTotal").textContent = sumSglTotal;
  $("#kpiSglWL").textContent    = `${sumSglWin}ìŠ¹ / ${sumSglLose}íŒ¨`;

  $("#kpiDblTotal").textContent = sumDblTotal;
  $("#kpiDblWL").textContent    = `${sumDblWin}ìŠ¹ / ${sumDblLose}íŒ¨`;

  $("#kpiPoints").textContent   = sumPoints;

  const last = months.slice().sort().at(-1) || "í˜„ì¬";
  $("#periodBadge").textContent = `ì§‘ê³„ ë²”ìœ„: 2025-09 ~ ${last}`;
}

/* ------------------------------
   âœ… ì›”ë³„ ì¹´ë“œ ë Œë”ë§
------------------------------ */
function renderMonthCards() {
  const box = $("#monthList");
  box.innerHTML = "";

  const sorted = months.slice().sort();

  sorted.forEach(m => {
    const a = perMonthAll[m];
    const s = perMonthSingle[m];
    const d = perMonthDouble[m];

    const isAfterNov = cmpMonth(m, "2025-11") >= 0;

    box.insertAdjacentHTML("beforeend", `
      <div class="item">
        <div class="l">
          ${isAfterNov 
            ? `<span class="tag">ë‹¨/ë³µì‹</span>` 
            : `<span class="tag" style="background:#eef2ff;color:#3730a3">í†µí•©</span>`}
          <div><b>${m}</b></div>
        </div>
        <div class="r">
          ${isAfterNov
            ? `í†µí•© ${a.total}G Â· ${fmt1(a.rate)}% / ë‹¨ì‹ ${s.total}G Â· ${fmt1(s.rate)}% / ë³µì‹ ${d.total}G Â· ${fmt1(d.rate)}% Â· ìŠ¹ì  ${d.points}`
            : `í†µí•© ${a.total}G Â· ${a.win}ìŠ¹ ${a.lose}íŒ¨ Â· ${fmt1(a.rate)}%`
          }
        </div>
      </div>
    `);
  });
}

/* ------------------------------
   âœ… ìƒì„¸ ë¶„ì„ ë Œë”ë§
------------------------------ */
function renderDetails() {
  const oppBox = $("#opponentSingles");
  const ptnBox = $("#partnerDoubles");

  oppBox.innerHTML = "";
  ptnBox.innerHTML = "";

  // ë‹¨ì‹ â€” ìƒëŒ€
  const oppArr = Object.entries(oppMapSingle).map(([name,v]) => ({
    name,
    total: v.win + v.lose,
    win: v.win,
    lose: v.lose,
    rate: (v.win + v.lose) ? (v.win / (v.win + v.lose) * 100) : 0
  })).sort((a,b) =>
      b.rate - a.rate ||
      b.total - a.total ||
      (playerLevels[a.name] ?? 99) - (playerLevels[b.name] ?? 99)
  );

  if (!oppArr.length) {
    oppBox.innerHTML = `<div class="dim">ë‹¨ì‹ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  } else {
    oppArr.forEach(o => {
      const lvl = playerLevels[o.name] ?? "-";
      oppBox.insertAdjacentHTML("beforeend", `
        <div class="item">
          <div class="l">
            <span class="tag">ìƒëŒ€</span>
            <div>${o.name}(${lvl})</div>
          </div>
          <div class="r">${o.win}ìŠ¹ ${o.lose}íŒ¨ Â· ${fmt1(o.rate)}%</div>
        </div>
      `);
    });
  }

  // ë³µì‹ â€” íŒŒíŠ¸ë„ˆ
  const ptnArr = Object.entries(partnerMapDouble).map(([name,v]) => ({
    name,
    win: v.win,
    lose: v.lose,
    points: v.points,
    total: v.win + v.lose,
    rate: (v.win + v.lose) ? (v.win / (v.win + v.lose) * 100) : 0
  })).sort((a,b) =>
      (b.points - a.points) ||
      (b.rate - a.rate) ||
      (b.total - a.total)
  );

  if (!ptnArr.length) {
    ptnBox.innerHTML = `<div class="dim">ë³µì‹ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  } else {
    ptnArr.forEach(p => {
      const lvl = playerLevels[p.name] ?? "-";
      const sign = p.points > 0 ? `+${p.points}` : p.points;
      ptnBox.insertAdjacentHTML("beforeend", `
        <div class="item">
          <div class="l">
            <span class="tag">íŒŒíŠ¸ë„ˆ</span>
            <div>${p.name}(${lvl})</div>
          </div>
          <div class="r">${p.win}ìŠ¹ ${p.lose}íŒ¨ Â· ${fmt1(p.rate)}% Â· ìŠ¹ì  ${sign}</div>
        </div>
      `);
    });
  }
}

/* ------------------------------
   âœ… ë°ì´í„° ë¡œë”© â†’ ë Œë” ì‹¤í–‰
------------------------------ */
await loadPlayers();
await loadPastReports();
await loadAfterNov();

renderKPI();
renderMonthCards();
renderDetails();

</script>

<!-- âœ… Part 4 / 4 â€” Chart.js: ì¤‘ë³µ ë°©ì§€ + destroy í¬í•¨ -->
<script>
/* ===== ì•ˆì „ ê°€ë“œ: Part 3ê°€ ë°ì´í„°ë¥¼ ë…¸ì¶œí–ˆëŠ”ì§€ í™•ì¸ =====
   Part 3 ë§¨ ë§ˆì§€ë§‰ ì¤„ì— ì•„ë˜ í•œ ì¤„ì´ ë°˜ë“œì‹œ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
   window.__pp = { months, perMonthAll, perMonthSingle, perMonthDouble, oppMapSingle, partnerMapDouble, sumSglTotal, sumDblTotal };
*/
if (!window.__pp) {
  console.warn("â›” window.__pp ê°€ ì—†ìŠµë‹ˆë‹¤. Part 3 ë§ˆì§€ë§‰ì— window.__pp í• ë‹¹ì„ ì¶”ê°€í•˜ì„¸ìš”.");
  window.__pp = { months:[], perMonthAll:{}, perMonthSingle:{}, perMonthDouble:{}, oppMapSingle:{}, partnerMapDouble:{}, sumSglTotal:0, sumDblTotal:0 };
}

/* ===== Chart ì¸ìŠ¤í„´ìŠ¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ===== */
window.__charts = window.__charts || {};
window.__chartsLoaded = window.__chartsLoaded || false;

function destroyAllCharts(){
  if (!window.__charts) return;
  Object.values(window.__charts).forEach(ch => {
    try { ch && ch.destroy && ch.destroy(); } catch(e) {}
  });
  window.__charts = {};
  window.__chartsLoaded = false;
}

/* ===== ê·¸ë˜í”„ ìƒì„± (í•œ ë²ˆë§Œ) ===== */
function buildChartsOnce(){
  if (window.__chartsLoaded) return;  // ì¤‘ë³µ ìƒì„± ë°©ì§€
  window.__chartsLoaded = true;

  const { months, perMonthAll, perMonthSingle, perMonthDouble, oppMapSingle, partnerMapDouble, sumSglTotal, sumDblTotal } = window.__pp;

  // ìº”ë²„ìŠ¤ ì˜ì—­ í‘œì‹œ
  const box = document.getElementById("canvasBox");
  if (box) box.style.display = "block";

  // ê³µí†µ: ì •ë ¬ëœ ì›”
  const ms = months.slice().sort();

  // 1) ì›”ë³„ ìŠ¹ë¥ (í†µí•©)
  {
    const ctx = document.getElementById("chartRate");
    if (ctx){
      const data = ms.map(m => (perMonthAll[m]?.rate ?? 0));
      window.__charts.chartRate = new Chart(ctx, {
        type:'line',
        data:{ labels:ms, datasets:[{ label:'ì›”ë³„ ìŠ¹ë¥ (í†µí•© %)', data, tension:.25 }]},
        options:{ responsive:true, scales:{ y:{ beginAtZero:true, max:100 } } }
      });
    }
  }

  // 2) ì›”ë³„ ê²½ê¸°ìˆ˜(í†µí•©)
  {
    const ctx = document.getElementById("chartGames");
    if (ctx){
      const data = ms.map(m => (perMonthAll[m]?.total ?? 0));
      window.__charts.chartGames = new Chart(ctx, {
        type:'bar',
        data:{ labels:ms, datasets:[{ label:'ì›”ë³„ ê²½ê¸°ìˆ˜(í†µí•©)', data }]},
        options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
      });
    }
  }

  // 3) ë‹¨ì‹/ë³µì‹ ë¹„ìœ¨ (11ì›”~ í•©ì‚°)
  {
    const ctx = document.getElementById("chartModePie");
    if (ctx){
      window.__charts.chartModePie = new Chart(ctx, {
        type:'doughnut',
        data:{ labels:['ë‹¨ì‹','ë³µì‹'], datasets:[{ data:[Number(sumSglTotal)||0, Number(sumDblTotal)||0] }]},
        options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
      });
    }
  }

  // 4) ë‹¨ì‹ ìƒëŒ€ë³„ ìŠ¹ë¥  Top 8
  {
    const ctx = document.getElementById("chartOpp");
    if (ctx){
      const arr = Object.entries(oppMapSingle).map(([name,v])=>({
        name, rate: (v.win+v.lose)? v.win/(v.win+v.lose)*100 : 0
      })).sort((a,b)=> b.rate - a.rate).slice(0,8);

      window.__charts.chartOpp = new Chart(ctx, {
        type:'bar',
        data:{ labels: arr.map(o=>o.name), datasets:[{ label:'ë‹¨ì‹ ìƒëŒ€ë³„ ìŠ¹ë¥ (%)', data: arr.map(o=>o.rate) }]},
        options:{ responsive:true, scales:{ y:{ beginAtZero:true, max:100 } } }
      });
    }
  }

  // 5) ë³µì‹ íŒŒíŠ¸ë„ˆë³„ ìŠ¹ë¥  Top 8
  {
    const ctx = document.getElementById("chartPartner");
    if (ctx){
      const arr = Object.entries(partnerMapDouble).map(([name,v])=>({
        name, rate: (v.win+v.lose)? v.win/(v.win+v.lose)*100 : 0
      })).sort((a,b)=> b.rate - a.rate).slice(0,8);

      window.__charts.chartPartner = new Chart(ctx, {
        type:'bar',
        data:{ labels: arr.map(o=>o.name), datasets:[{ label:'ë³µì‹ íŒŒíŠ¸ë„ˆë³„ ìŠ¹ë¥ (%)', data: arr.map(o=>o.rate) }]},
        options:{ responsive:true, scales:{ y:{ beginAtZero:true, max:100 } } }
      });
    }
  }

  // 6) ì›”ë³„ ëˆ„ì  ìŠ¹ì (ë³µì‹)
  {
    const ctx = document.getElementById("chartPoints");
    if (ctx){
      const pts = ms.map(m => (perMonthDouble[m]?.points ?? 0));
      let run = 0; const cum = pts.map(v => (run += v));
      window.__charts.chartPoints = new Chart(ctx, {
        type:'line',
        data:{ labels:ms, datasets:[{ label:'ë³µì‹ ëˆ„ì  ìŠ¹ì ', data:cum, tension:.25 }]},
        options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
      });
    }
  }
}

/* ===== í•„ìš” ì‹œ ê°•ì œ ì¬ìƒì„± (destroy í›„ ë‹¤ì‹œ ìƒì„±) ===== */
function rebuildCharts(){
  destroyAllCharts();
  buildChartsOnce();
}

/* ===== ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”© ===== */
document.getElementById("btnLoadCharts")?.addEventListener("click", buildChartsOnce);
document.getElementById("openCharts")?.addEventListener("click", () => {
  document.getElementById("btnLoadCharts")?.scrollIntoView({ behavior:"smooth", block:"center" });
});

/* ===== í˜ì´ì§€ ì´íƒˆ ì‹œ ì •ë¦¬(ì„ íƒ) ===== */
window.addEventListener("beforeunload", destroyAllCharts);
</script>

</body>
</html>
