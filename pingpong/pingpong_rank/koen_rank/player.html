<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>🏓 개인 탁구 성적 리포트</title>

<!-- Pretendard -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb; --card:#ffffff;
  --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
  --shadow:0 10px 30px rgba(2,6,23,.08);
  --soft:#eaf1ff; --soft2:#eef2ff;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:"Pretendard","Noto Sans KR",system-ui,-apple-system,sans-serif;
  background:var(--bg); color:var(--ink); font-weight:600;
}
header{
  position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #e5e7eb;
}
.header-inner{
  max-width:1080px; margin:0 auto; padding:14px 16px; display:flex; gap:10px; align-items:center; justify-content:space-between;
}
h1{margin:0; font-size:clamp(18px,4vw,22px); color:var(--accent); font-weight:800}
.sub{font-size:13px; color:#334155; font-weight:700}
.btn{
  border:1px solid #d1d5db; background:#fff; color:#0f172a; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700;
}
.btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
.btn.ghost{background:#f8fafc}
.wrap{max-width:1080px; margin:0 auto; padding:16px}
.grid{
  display:grid; gap:14px;
  grid-template-columns: repeat(12, 1fr);
}
.card{
  background:var(--card); border-radius:16px; box-shadow:var(--shadow); padding:16px;
}
.card h3{margin:0 0 8px; font-size:18px; color:#1e3a8a}
.kv{display:flex; flex-wrap:wrap; gap:10px}
.badge{display:inline-block; padding:6px 10px; border-radius:999px; font-size:13px; background:var(--soft); color:#1e3a8a}
.big{
  font-size:30px; font-weight:900; color:#0f172a; letter-spacing:-.5px;
}
.row{display:flex; align-items:center; gap:8px}
.hr{height:1px; background:#eef2f7; margin:12px 0}
.dim{color:#64748b; font-weight:700; font-size:13px}
.kpi{
  display:grid; gap:10px; grid-template-columns: repeat(4,1fr);
}
.kpi .mini{
  border:1px solid #e5e7eb; border-radius:12px; padding:14px; background:linear-gradient(180deg,#fff, #fbfdff 85%);
}
.kpi .mini h4{margin:0 0 6px; font-size:13px; color:#334155}
.kpi .mini .v{font-size:22px; font-weight:900}
.kpi .good{border-color:#c7f3d5; background:linear-gradient(180deg,#fff, #f3fff7 85%)}
.kpi .warn{border-color:#ffd5d5; background:linear-gradient(180deg,#fff, #fff6f6 85%)}
.block-title{font-size:16px; font-weight:900; color:#0f172a; margin-bottom:8px}
.list{
  display:grid; gap:8px;
}
.item{
  border:1px solid #e5e7eb; padding:10px 12px; border-radius:12px; display:flex; align-items:center; justify-content:space-between;
  background:linear-gradient(180deg,#fff, #fbfdff 85%);
  box-shadow:0 2px 10px rgba(2,6,23,.02);
}
.item .l{display:flex; gap:8px; align-items:center}
.tag{font-size:12px; background:#e2efff; color:#1e40af; padding:4px 8px; border-radius:999px; font-weight:800}
.item .r{font-weight:900}
.btn-xl{
  display:inline-flex; align-items:center; gap:8px; padding:12px 16px; border-radius:12px; border:1px solid #c7d2fe;
  background:linear-gradient(180deg,#fff, #f3f5ff 75%); color:#1e3a8a; font-size:15px; font-weight:900; cursor:pointer;
}
.canvas-box{
  background:#fff; border:1px dashed #dbe3ff; border-radius:12px; padding:12px; display:none;
}
.canvas-grid{
  display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
}
.note{
  font-size:12.5px; color:#475569; margin-top:6px; text-align:right
}
@media (max-width:900px){
  .kpi{grid-template-columns: repeat(2,1fr)}
}
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div>
      <h1>🏓 개인 탁구 성적 리포트</h1>
      <div class="sub" id="playerNameSub">선수 이름을 불러오는 중…</div>
    </div>
    <div class="row">
      <a class="btn" href="monthly-report.html">← 월간 리포트</a>
      <button id="openCharts" class="btn primary">📊 그래프 열기</button>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- ✅ 상단 KPI 영역 -->
  <section class="grid" style="grid-template-columns:repeat(12,1fr);">
    <div class="card" style="grid-column: span 12;">
      <div class="row" style="justify-content:space-between;">
        <div class="row" style="gap:12px">
          <div class="badge" id="periodBadge">데이터 기간: 불러오는 중…</div>
          <div class="badge" id="modeBadge">11월부터 단식/복식 자동 분리</div>
        </div>
        <div class="row">
          <span class="dim">승점 규칙: 승 +2 / 패 -1</span>
        </div>
      </div>

      <div class="hr"></div>

      <div class="kpi" id="kpiWrap">
        <div class="mini">
          <h4>누적 경기(통합)</h4>
          <div class="v" id="kpiAllTotal">-</div>
          <div class="dim" id="kpiAllWL">-</div>
        </div>
        <div class="mini">
          <h4>11월~ 단식</h4>
          <div class="v" id="kpiSglTotal">-</div>
          <div class="dim" id="kpiSglWL">-</div>
        </div>
        <div class="mini">
          <h4>11월~ 복식</h4>
          <div class="v" id="kpiDblTotal">-</div>
          <div class="dim" id="kpiDblWL">-</div>
        </div>
        <div class="mini">
          <h4>11월~ 누적 승점</h4>
          <div class="v" id="kpiPoints">-</div>
          <div class="dim">승×2 - 패</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ✅ 월별 카드 -->
  <section class="grid" style="margin-top:12px;">
    <div class="card" style="grid-column: span 12;">
      <h3>📅 월별 통합 기록 (2025-09, 2025-10: 통합전적 / 2025-11~: 단식·복식 분리)</h3>
      <div id="monthList" class="list"></div>
      <div class="note">* 2025-09 ~ 2025-10은 단·복식 구분 없이 통합전적만 제공됩니다.</div>
    </div>
  </section>

  <!-- ✅ 상세 분석 -->
  <section class="grid" style="margin-top:12px;">
    <div class="card" style="grid-column: span 12;">
      <h3>🔎 상세 분석 (11월~)</h3>
      <div class="grid" style="grid-template-columns:repeat(12,1fr); gap:12px;">
        <div class="card" style="grid-column: span 6;">
          <div class="block-title">단식 — 상대별 전적</div>
          <div id="opponentSingles" class="list"></div>
        </div>
        <div class="card" style="grid-column: span 6;">
          <div class="block-title">복식 — 파트너별 전적</div>
          <div id="partnerDoubles" class="list"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ✅ 그래프 (지연 로딩) -->
  <section class="grid" style="margin-top:12px;">
    <div class="card" style="grid-column: span 12;">
      <h3>📊 시각화</h3>
      <button class="btn-xl" id="btnLoadCharts">📈 그래프 열기 (지연 로딩)</button>
      
      <div class="canvas-box" id="canvasBox" style="margin-top:12px;">
        <div class="canvas-grid">
          <canvas id="chartRate"></canvas>
          <canvas id="chartGames"></canvas>
          <canvas id="chartModePie"></canvas>
          <canvas id="chartOpp"></canvas>
          <canvas id="chartPartner"></canvas>
          <canvas id="chartPoints"></canvas>
        </div>
      </div>
      <div class="note">* 버튼을 눌러 그래프를 로드합니다. (모바일 최적화)</div>
    </div>
  </section>

</main>

<!-- ✅ Firebase + 데이터 처리 -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

/* ------------------------------
   ✅ Firebase 초기화
------------------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ------------------------------
   ✅ Utils
------------------------------ */
const $ = s => document.querySelector(s);
const fmt1 = n => (Math.round(n*10)/10).toFixed(1);
const yyyymm = (d)=> `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
const POINT_WIN  = 2;
const POINT_LOSE = -1;

// 월 비교
const cmpMonth = (a,b)=> a.localeCompare(b);

/* ------------------------------
   ✅ URL 파라미터
------------------------------ */
const params     = new URLSearchParams(location.search);
const playerName = params.get("name") || "";
$("#playerNameSub").textContent = playerName ? `선수: ${playerName}` : "선수 정보 없음";

/* ------------------------------
   ✅ 로컬 데이터 구조
------------------------------ */
let playerLevels = {};
let months = [];

let perMonthAll    = {}; // 월별 통합
let perMonthSingle = {}; // 월별 단식
let perMonthDouble = {}; // 월별 복식

let oppMapSingle   = {}; // 상대별 단식
let partnerMapDouble = {}; // 파트너별 복식

let sumAllTotal = 0, sumAllWin = 0, sumAllLose = 0;
let sumSglTotal = 0, sumSglWin = 0, sumSglLose = 0;
let sumDblTotal = 0, sumDblWin = 0, sumDblLose = 0;
let sumPoints = 0;

/* ------------------------------
   ✅ 1) Players (부수) 로딩
------------------------------ */
async function loadPlayers() {
  const snap = await get(ref(db, "players"));
  if (!snap.exists()) return;

  const data = snap.val();
  Object.values(data).forEach(p => {
    if (p.name) playerLevels[p.name] = p.level ?? "-";
  });
}

/* ------------------------------
   ✅ 2) 2025-09, 10 : monthlyReports (통합전적)
------------------------------ */
async function loadPastReports() {
  const targets = ["2025-09", "2025-10"];

  for (let m of targets) {
    const snap = await get(ref(db, `monthlyReports/${m}/players`));
    if (!snap.exists()) continue;

    const arr = Object.values(snap.val());
    const row = arr.find(p => p.name === playerName);
    if (!row) continue;

    const win  = Number(row.wins ?? row.win ?? 0);
    const lose = Number(row.losses ?? row.lose ?? 0);
    const total = win + lose;
    const rate  = total ? win / total * 100 : 0;

    perMonthAll[m] = { total, win, lose, rate };
    months.push(m);

    sumAllTotal += total;
    sumAllWin   += win;
    sumAllLose  += lose;
  }
}

/* ------------------------------
   ✅ 3) 11월 이후: matches에서 단식·복식 분리
------------------------------ */
async function loadAfterNov() {
  const snap = await get(ref(db, "matches"));
  if (!snap.exists()) return;

  const NOV = "2025-11";
  const matches = Object.values(snap.val());

  const myGames = matches.filter(m => {
    const mk = m.monthKey;
    if (!mk) return false;
    if (cmpMonth(mk, NOV) < 0) return false;

    return [...m.namesA, ...m.namesB].includes(playerName);
  });

  // 월 목록 확보
  myGames.forEach(g => {
    if (!months.includes(g.monthKey)) months.push(g.monthKey);
  });

  // 월별 초기화
  months.forEach(m => {
    if (!perMonthAll[m]) perMonthAll[m] = { total:0, win:0, lose:0, rate:0 };
    if (!perMonthSingle[m]) perMonthSingle[m] = { total:0, win:0, lose:0, rate:0 };
    if (!perMonthDouble[m]) perMonthDouble[m] = { total:0, win:0, lose:0, rate:0, points:0 };
  });

  // 집계
  myGames.forEach(g => {
    const mk = g.monthKey;
    const mode = g.mode || "single";

    const A = g.namesA || [];
    const B = g.namesB || [];
    const iAmA = A.includes(playerName);
    const iWon = (g.winnerSide === "A" && iAmA) || (g.winnerSide === "B" && !iAmA);

    // 통합
    perMonthAll[mk].total++;
    if (iWon) perMonthAll[mk].win++; else perMonthAll[mk].lose++;

    // 단식
    if (mode === "single") {
      perMonthSingle[mk].total++;
      if (iWon) perMonthSingle[mk].win++; else perMonthSingle[mk].lose++;

      const opp = iAmA ? B[0] : A[0];
      if (opp) {
        if (!oppMapSingle[opp]) oppMapSingle[opp] = { win:0, lose:0 };
        if (iWon) oppMapSingle[opp].win++; else oppMapSingle[opp].lose++;
      }

    // 복식
    } else if (mode === "double") {
      perMonthDouble[mk].total++;
      if (iWon) perMonthDouble[mk].win++; else perMonthDouble[mk].lose++;

      const pts = iWon ? POINT_WIN : POINT_LOSE;
      perMonthDouble[mk].points += pts;
      sumPoints += pts;

      const team = iAmA ? A : B;
      const partner = team.find(n => n !== playerName);
      if (partner) {
        if (!partnerMapDouble[partner]) partnerMapDouble[partner] = { win:0, lose:0, points:0 };
        if (iWon) {
          partnerMapDouble[partner].win++;
          partnerMapDouble[partner].points += POINT_WIN;
        } else {
          partnerMapDouble[partner].lose++;
          partnerMapDouble[partner].points += POINT_LOSE;
        }
      }
    }
  });

  // 승률 계산
  months.forEach(m => {
    const a = perMonthAll[m]; 
    const s = perMonthSingle[m];
    const d = perMonthDouble[m];

    a.rate = a.total ? a.win / a.total * 100 : 0;
    if (s) s.rate = s.total ? s.win / s.total * 100 : 0;
    if (d) d.rate = d.total ? d.win / d.total * 100 : 0;

    sumSglTotal += s.total; sumSglWin += s.win; sumSglLose += s.lose;
    sumDblTotal += d.total; sumDblWin += d.win; sumDblLose += d.lose;

    sumAllTotal += a.total; sumAllWin += a.win; sumAllLose += a.lose;
  });
}

/* ------------------------------
   ✅ KPI 렌더링
------------------------------ */
function renderKPI() {
  $("#kpiAllTotal").textContent = sumAllTotal;
  $("#kpiAllWL").textContent    = `${sumAllWin}승 / ${sumAllLose}패`;

  $("#kpiSglTotal").textContent = sumSglTotal;
  $("#kpiSglWL").textContent    = `${sumSglWin}승 / ${sumSglLose}패`;

  $("#kpiDblTotal").textContent = sumDblTotal;
  $("#kpiDblWL").textContent    = `${sumDblWin}승 / ${sumDblLose}패`;

  $("#kpiPoints").textContent   = sumPoints;

  const last = months.slice().sort().at(-1) || "현재";
  $("#periodBadge").textContent = `집계 범위: 2025-09 ~ ${last}`;
}

/* ------------------------------
   ✅ 월별 카드 렌더링
------------------------------ */
function renderMonthCards() {
  const box = $("#monthList");
  box.innerHTML = "";

  const sorted = months.slice().sort();

  sorted.forEach(m => {
    const a = perMonthAll[m];
    const s = perMonthSingle[m];
    const d = perMonthDouble[m];

    const isAfterNov = cmpMonth(m, "2025-11") >= 0;

    box.insertAdjacentHTML("beforeend", `
      <div class="item">
        <div class="l">
          ${isAfterNov 
            ? `<span class="tag">단/복식</span>` 
            : `<span class="tag" style="background:#eef2ff;color:#3730a3">통합</span>`}
          <div><b>${m}</b></div>
        </div>
        <div class="r">
          ${isAfterNov
            ? `통합 ${a.total}G · ${fmt1(a.rate)}% / 단식 ${s.total}G · ${fmt1(s.rate)}% / 복식 ${d.total}G · ${fmt1(d.rate)}% · 승점 ${d.points}`
            : `통합 ${a.total}G · ${a.win}승 ${a.lose}패 · ${fmt1(a.rate)}%`
          }
        </div>
      </div>
    `);
  });
}

/* ------------------------------
   ✅ 상세 분석 렌더링
------------------------------ */
function renderDetails() {
  const oppBox = $("#opponentSingles");
  const ptnBox = $("#partnerDoubles");

  oppBox.innerHTML = "";
  ptnBox.innerHTML = "";

  // 단식 — 상대
  const oppArr = Object.entries(oppMapSingle).map(([name,v]) => ({
    name,
    total: v.win + v.lose,
    win: v.win,
    lose: v.lose,
    rate: (v.win + v.lose) ? (v.win / (v.win + v.lose) * 100) : 0
  })).sort((a,b) =>
      b.rate - a.rate ||
      b.total - a.total ||
      (playerLevels[a.name] ?? 99) - (playerLevels[b.name] ?? 99)
  );

  if (!oppArr.length) {
    oppBox.innerHTML = `<div class="dim">단식 기록이 없습니다.</div>`;
  } else {
    oppArr.forEach(o => {
      const lvl = playerLevels[o.name] ?? "-";
      oppBox.insertAdjacentHTML("beforeend", `
        <div class="item">
          <div class="l">
            <span class="tag">상대</span>
            <div>${o.name}(${lvl})</div>
          </div>
          <div class="r">${o.win}승 ${o.lose}패 · ${fmt1(o.rate)}%</div>
        </div>
      `);
    });
  }

  // 복식 — 파트너
  const ptnArr = Object.entries(partnerMapDouble).map(([name,v]) => ({
    name,
    win: v.win,
    lose: v.lose,
    points: v.points,
    total: v.win + v.lose,
    rate: (v.win + v.lose) ? (v.win / (v.win + v.lose) * 100) : 0
  })).sort((a,b) =>
      (b.points - a.points) ||
      (b.rate - a.rate) ||
      (b.total - a.total)
  );

  if (!ptnArr.length) {
    ptnBox.innerHTML = `<div class="dim">복식 기록이 없습니다.</div>`;
  } else {
    ptnArr.forEach(p => {
      const lvl = playerLevels[p.name] ?? "-";
      const sign = p.points > 0 ? `+${p.points}` : p.points;
      ptnBox.insertAdjacentHTML("beforeend", `
        <div class="item">
          <div class="l">
            <span class="tag">파트너</span>
            <div>${p.name}(${lvl})</div>
          </div>
          <div class="r">${p.win}승 ${p.lose}패 · ${fmt1(p.rate)}% · 승점 ${sign}</div>
        </div>
      `);
    });
  }
}

/* ------------------------------
   ✅ 데이터 로딩 → 렌더 실행
------------------------------ */
await loadPlayers();
await loadPastReports();
await loadAfterNov();

renderKPI();
renderMonthCards();
renderDetails();

</script>

<!-- ✅ Part 4 / 4 — Chart.js: 중복 방지 + destroy 포함 -->
<script>
/* ===== 안전 가드: Part 3가 데이터를 노출했는지 확인 =====
   Part 3 맨 마지막 줄에 아래 한 줄이 반드시 있어야 합니다.
   window.__pp = { months, perMonthAll, perMonthSingle, perMonthDouble, oppMapSingle, partnerMapDouble, sumSglTotal, sumDblTotal };
*/
if (!window.__pp) {
  console.warn("⛔ window.__pp 가 없습니다. Part 3 마지막에 window.__pp 할당을 추가하세요.");
  window.__pp = { months:[], perMonthAll:{}, perMonthSingle:{}, perMonthDouble:{}, oppMapSingle:{}, partnerMapDouble:{}, sumSglTotal:0, sumDblTotal:0 };
}

/* ===== Chart 인스턴스 레지스트리 ===== */
window.__charts = window.__charts || {};
window.__chartsLoaded = window.__chartsLoaded || false;

function destroyAllCharts(){
  if (!window.__charts) return;
  Object.values(window.__charts).forEach(ch => {
    try { ch && ch.destroy && ch.destroy(); } catch(e) {}
  });
  window.__charts = {};
  window.__chartsLoaded = false;
}

/* ===== 그래프 생성 (한 번만) ===== */
function buildChartsOnce(){
  if (window.__chartsLoaded) return;  // 중복 생성 방지
  window.__chartsLoaded = true;

  const { months, perMonthAll, perMonthSingle, perMonthDouble, oppMapSingle, partnerMapDouble, sumSglTotal, sumDblTotal } = window.__pp;

  // 캔버스 영역 표시
  const box = document.getElementById("canvasBox");
  if (box) box.style.display = "block";

  // 공통: 정렬된 월
  const ms = months.slice().sort();

  // 1) 월별 승률(통합)
  {
    const ctx = document.getElementById("chartRate");
    if (ctx){
      const data = ms.map(m => (perMonthAll[m]?.rate ?? 0));
      window.__charts.chartRate = new Chart(ctx, {
        type:'line',
        data:{ labels:ms, datasets:[{ label:'월별 승률(통합 %)', data, tension:.25 }]},
        options:{ responsive:true, scales:{ y:{ beginAtZero:true, max:100 } } }
      });
    }
  }

  // 2) 월별 경기수(통합)
  {
    const ctx = document.getElementById("chartGames");
    if (ctx){
      const data = ms.map(m => (perMonthAll[m]?.total ?? 0));
      window.__charts.chartGames = new Chart(ctx, {
        type:'bar',
        data:{ labels:ms, datasets:[{ label:'월별 경기수(통합)', data }]},
        options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
      });
    }
  }

  // 3) 단식/복식 비율 (11월~ 합산)
  {
    const ctx = document.getElementById("chartModePie");
    if (ctx){
      window.__charts.chartModePie = new Chart(ctx, {
        type:'doughnut',
        data:{ labels:['단식','복식'], datasets:[{ data:[Number(sumSglTotal)||0, Number(sumDblTotal)||0] }]},
        options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
      });
    }
  }

  // 4) 단식 상대별 승률 Top 8
  {
    const ctx = document.getElementById("chartOpp");
    if (ctx){
      const arr = Object.entries(oppMapSingle).map(([name,v])=>({
        name, rate: (v.win+v.lose)? v.win/(v.win+v.lose)*100 : 0
      })).sort((a,b)=> b.rate - a.rate).slice(0,8);

      window.__charts.chartOpp = new Chart(ctx, {
        type:'bar',
        data:{ labels: arr.map(o=>o.name), datasets:[{ label:'단식 상대별 승률(%)', data: arr.map(o=>o.rate) }]},
        options:{ responsive:true, scales:{ y:{ beginAtZero:true, max:100 } } }
      });
    }
  }

  // 5) 복식 파트너별 승률 Top 8
  {
    const ctx = document.getElementById("chartPartner");
    if (ctx){
      const arr = Object.entries(partnerMapDouble).map(([name,v])=>({
        name, rate: (v.win+v.lose)? v.win/(v.win+v.lose)*100 : 0
      })).sort((a,b)=> b.rate - a.rate).slice(0,8);

      window.__charts.chartPartner = new Chart(ctx, {
        type:'bar',
        data:{ labels: arr.map(o=>o.name), datasets:[{ label:'복식 파트너별 승률(%)', data: arr.map(o=>o.rate) }]},
        options:{ responsive:true, scales:{ y:{ beginAtZero:true, max:100 } } }
      });
    }
  }

  // 6) 월별 누적 승점(복식)
  {
    const ctx = document.getElementById("chartPoints");
    if (ctx){
      const pts = ms.map(m => (perMonthDouble[m]?.points ?? 0));
      let run = 0; const cum = pts.map(v => (run += v));
      window.__charts.chartPoints = new Chart(ctx, {
        type:'line',
        data:{ labels:ms, datasets:[{ label:'복식 누적 승점', data:cum, tension:.25 }]},
        options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
      });
    }
  }
}

/* ===== 필요 시 강제 재생성 (destroy 후 다시 생성) ===== */
function rebuildCharts(){
  destroyAllCharts();
  buildChartsOnce();
}

/* ===== 버튼 이벤트 바인딩 ===== */
document.getElementById("btnLoadCharts")?.addEventListener("click", buildChartsOnce);
document.getElementById("openCharts")?.addEventListener("click", () => {
  document.getElementById("btnLoadCharts")?.scrollIntoView({ behavior:"smooth", block:"center" });
});

/* ===== 페이지 이탈 시 정리(선택) ===== */
window.addEventListener("beforeunload", destroyAllCharts);
</script>

</body>
</html>
