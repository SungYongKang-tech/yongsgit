<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>🏓 개인 탁구 성적 리포트</title>

<!-- Pretendard -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb; --card:#ffffff;
  --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
  --shadow:0 10px 30px rgba(2,6,23,.08);
  --soft:#eaf1ff; --soft2:#eef2ff;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:"Pretendard","Noto Sans KR",system-ui,-apple-system,sans-serif;
  background:var(--bg); color:var(--ink); font-weight:600;
}
header{
  position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #e5e7eb;
}
.header-inner{
  max-width:1080px; margin:0 auto; padding:14px 16px; display:flex; gap:10px; align-items:center; justify-content:space-between;
}
h1{margin:0; font-size:clamp(18px,4vw,22px); color:var(--accent); font-weight:800}
.sub{font-size:13px; color:#334155; font-weight:700}
.btn{
  border:1px solid #d1d5db; background:#fff; color:#0f172a; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700;
}
.btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
.wrap{max-width:1080px; margin:0 auto; padding:16px}
.grid{
  display:grid; gap:14px;
  grid-template-columns: repeat(12, 1fr);
}
.card{
  background:var(--card); border-radius:16px; box-shadow:var(--shadow); padding:16px;
}
.card h3{margin:0 0 8px; font-size:18px; color:#1e3a8a}
.badge{display:inline-block; padding:6px 10px; border-radius:999px; font-size:13px; background:var(--soft); color:#1e3a8a}
.row{display:flex; align-items:center; gap:8px}
.hr{height:1px; background:#eef2f7; margin:12px 0}
.dim{color:#64748b; font-weight:700; font-size:13px}
.kpi{
  display:grid; gap:10px; grid-template-columns: repeat(4,1fr);
}
.kpi .mini{
  border:1px solid #e5e7eb; border-radius:12px; padding:14px; background:linear-gradient(180deg,#fff, #fbfdff 85%);
}
.kpi .mini h4{margin:0 0 6px; font-size:13px; color:#334155}
.kpi .mini .v{font-size:22px; font-weight:900}
.block-title{font-size:16px; font-weight:900; color:#0f172a; margin-bottom:8px}
.list{display:grid; gap:8px}
.item{
  border:1px solid #e5e7eb; padding:10px 12px; border-radius:12px; display:flex; align-items:center; justify-content:space-between;
  background:linear-gradient(180deg,#fff, #fbfdff 85%); box-shadow:0 2px 10px rgba(2,6,23,.02);
}
.item .l{display:flex; gap:8px; align-items:center}
.tag{font-size:12px; background:#e2efff; color:#1e40af; padding:4px 8px; border-radius:999px; font-weight:800}
.item .r{font-weight:900}
.btn-xl{
  display:inline-flex; align-items:center; gap:8px; padding:12px 16px; border-radius:12px; border:1px solid #c7d2fe;
  background:linear-gradient(180deg,#fff, #f3f5ff 75%); color:#1e3a8a; font-size:15px; font-weight:900; cursor:pointer;
}
.canvas-box{
  background:#fff; border:1px dashed #dbe3ff; border-radius:12px; padding:12px; display:none;
}
.canvas-grid{
  display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
}
.note{
  font-size:12.5px; color:#475569; margin-top:6px; text-align:right
}
</style>
</head>

<body>

<header>
  <div class="header-inner">
    <div>
      <h1>🏓 개인 탁구 성적 리포트</h1>
      <div class="sub" id="playerNameSub">선수 이름을 불러오는 중…</div>
    </div>
    <div class="row">
      <a class="btn" href="monthly-report.html">← 월간 리포트</a>
      <button id="openCharts" class="btn primary">📊 그래프 열기</button>
    </div>
  </div>
</header>

<main class="wrap">

    <!-- ✅ Firebase + 데이터 로딩 -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

/* ----------------------------------------------------
   ✅ Firebase 설정
---------------------------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ----------------------------------------------------
   ✅ Utils
---------------------------------------------------- */
const $ = s => document.querySelector(s);
const fmt1 = n => (Math.round(n*10)/10).toFixed(1);
const cmpMonth = (a,b)=> a.localeCompare(b);
const POINT_WIN = 2, POINT_LOSE = -1;

/* ----------------------------------------------------
   ✅ URL 파라미터
---------------------------------------------------- */
const params = new URLSearchParams(location.search);
const playerName = params.get("name") || "";
$("#playerNameSub").textContent = playerName ? `선수: ${playerName}` : "선수 정보 없음";

/* ----------------------------------------------------
   ✅ 전역 데이터
---------------------------------------------------- */
let playerLevels = {};
let months = [];
let perMonthAll = {};
let perMonthSingle = {};
let perMonthDouble = {};

let oppMapSingle = {};
let partnerMapDouble = {};

let sumAllTotal=0, sumAllWin=0, sumAllLose=0;
let sumSglTotal=0, sumSglWin=0, sumSglLose=0;
let sumDblTotal=0, sumDblWin=0, sumDblLose=0;
let sumPoints=0;

/* ----------------------------------------------------
   ✅ 1) Players (부수)
---------------------------------------------------- */
async function loadPlayers(){
  const snap = await get(ref(db,"players"));
  if (!snap.exists()) return;

  const data = snap.val();
  Object.values(data).forEach(p=>{
    if (p.name) playerLevels[p.name] = p.level ?? "-";
  });
}

/* ----------------------------------------------------
   ✅ 2) 2025-09, 10 — monthlyReports (통합전적)
---------------------------------------------------- */
async function loadPastReports(){
  const targets = ["2025-09","2025-10"];

  for (let m of targets){
    const snap = await get(ref(db,`monthlyReports/${m}/players`));
    if (!snap.exists()) continue;

    const arr = Object.values(snap.val());
    const row = arr.find(p => p.name === playerName);
    if (!row) continue;

    const win  = Number(row.wins ?? row.win ?? 0);
    const lose = Number(row.losses ?? row.lose ?? 0);
    const total = win + lose;
    const rate  = total ? win/total*100 : 0;

    perMonthAll[m] = { total, win, lose, rate };
    months.push(m);

    sumAllTotal += total;
    sumAllWin   += win;
    sumAllLose  += lose;
  }
}

/* ----------------------------------------------------
   ✅ 3) 2025-11 이후 matches 단식/복식 분리
---------------------------------------------------- */
async function loadAfterNov(){
  const snap = await get(ref(db,"matches"));
  if (!snap.exists()) return;

  const NOV = "2025-11";
  const games = Object.values(snap.val());

  const myGames = games.filter(g=>{
    const mk = g.monthKey;
    if (!mk) return false;
    if (cmpMonth(mk,NOV) < 0) return false;
    return [...g.namesA, ...g.namesB].includes(playerName);
  });

  // ✅ 월 목록 추가
  myGames.forEach(g=>{
    if (!months.includes(g.monthKey)) months.push(g.monthKey);
  });

  // ✅ months 중복 제거
  months = [...new Set(months)];

  // ✅ 월별 초기화
  months.forEach(m=>{
    if (!perMonthAll[m]) perMonthAll[m] = { total:0, win:0, lose:0, rate:0 };
    if (!perMonthSingle[m]) perMonthSingle[m] = { total:0, win:0, lose:0, rate:0 };
    if (!perMonthDouble[m]) perMonthDouble[m] = { total:0, win:0, lose:0, rate:0, points:0 };
  });

  // ✅ 집계
  myGames.forEach(g=>{
    const mk = g.monthKey;
    const mode = g.mode || "single";
    const A = g.namesA || [];
    const B = g.namesB || [];

    const iAmA = A.includes(playerName);
    const iWon = (g.winnerSide==="A" && iAmA) || (g.winnerSide==="B" && !iAmA);

    // ✅ 통합
    perMonthAll[mk].total++;
    if (iWon) perMonthAll[mk].win++; else perMonthAll[mk].lose++;

    // ✅ 단식
    if (mode === "single"){
      perMonthSingle[mk].total++;
      if (iWon) perMonthSingle[mk].win++; else perMonthSingle[mk].lose++;

      const opp = iAmA ? B[0] : A[0];
      if (opp){
        if (!oppMapSingle[opp]) oppMapSingle[opp] = { win:0, lose:0 };
        if (iWon) oppMapSingle[opp].win++; else oppMapSingle[opp].lose++;
      }

    // ✅ 복식
    } else {
      perMonthDouble[mk].total++;
      if (iWon) perMonthDouble[mk].win++; else perMonthDouble[mk].lose++;

      // 승점
      const pts = iWon ? POINT_WIN : POINT_LOSE;
      perMonthDouble[mk].points += pts;
      sumPoints += pts;

      // 파트너
      const team = iAmA ? A : B;
      const partner = team.find(n => n !== playerName);
      if (partner){
        if (!partnerMapDouble[partner]) partnerMapDouble[partner] = { win:0, lose:0, points:0 };
        if (iWon){
          partnerMapDouble[partner].win++;
          partnerMapDouble[partner].points += POINT_WIN;
        } else {
          partnerMapDouble[partner].lose++;
          partnerMapDouble[partner].points += POINT_LOSE;
        }
      }
    }
  });

  // ✅ 승률 계산 및 합계 생성
  months.forEach(m=>{
    const a = perMonthAll[m];
    const s = perMonthSingle[m];
    const d = perMonthDouble[m];

    a.rate = a.total ? a.win/a.total*100 : 0;
    s.rate = s.total ? s.win/s.total*100 : 0;
    d.rate = d.total ? d.win/d.total*100 : 0;

    sumSglTotal += s.total; sumSglWin += s.win; sumSglLose += s.lose;
    sumDblTotal += d.total; sumDblWin += d.win; sumDblLose += d.lose;

    sumAllTotal += a.total; sumAllWin += a.win; sumAllLose += a.lose;
  });
}

/* ----------------------------------------------------
   ✅ 렌더링: KPI / 월별 카드 / 상세 분석
---------------------------------------------------- */
function renderKPI(){
  $("#kpiAllTotal").textContent = sumAllTotal;
  $("#kpiAllWL").textContent    = `${sumAllWin}승 / ${sumAllLose}패`;

  $("#kpiSglTotal").textContent = sumSglTotal;
  $("#kpiSglWL").textContent    = `${sumSglWin}승 / ${sumSglLose}패`;

  $("#kpiDblTotal").textContent = sumDblTotal;
  $("#kpiDblWL").textContent    = `${sumDblWin}승 / ${sumDblLose}패`;

  $("#kpiPoints").textContent   = sumPoints;

  const last = months.slice().sort().at(-1) || "현재";
  $("#periodBadge").textContent = `집계 범위: 2025-09 ~ ${last}`;
}

function renderMonthCards(){
  const box = $("#monthList");
  box.innerHTML = "";

  const sorted = months.slice().sort();

  sorted.forEach(m=>{
    const a = perMonthAll[m];
    const s = perMonthSingle[m];
    const d = perMonthDouble[m];
    const afterNov = cmpMonth(m,"2025-11") >= 0;

    box.insertAdjacentHTML("beforeend",`
      <div class="item">
        <div class="l">
          ${afterNov
            ? `<span class="tag">단/복식</span>`
            : `<span class="tag" style="background:#eef2ff;color:#3730a3">통합</span>`}
          <div><b>${m}</b></div>
        </div>
        <div class="r">
          ${afterNov
            ? `통합 ${a.total}G · ${fmt1(a.rate)}% / 단식 ${s.total}G · ${fmt1(s.rate)}% / 복식 ${d.total}G · ${fmt1(d.rate)}% · 승점 ${d.points}`
            : `통합 ${a.total}G · ${a.win}승 ${a.lose}패 · ${fmt1(a.rate)}%`}
        </div>
      </div>
    `);
  });
}

function renderDetails(){
  const oppBox = $("#opponentSingles");
  const ptnBox = $("#partnerDoubles");

  oppBox.innerHTML = "";
  ptnBox.innerHTML = "";

  /* ✅ 단식 상대 */
  const oppArr = Object.entries(oppMapSingle).map(([name,v])=>({
    name,
    win:v.win, lose:v.lose,
    total:v.win+v.lose,
    rate:(v.win+v.lose)? v.win/(v.win+v.lose)*100 : 0
  })).sort((a,b)=>
      b.rate - a.rate ||
      b.total - a.total ||
      (playerLevels[a.name]??99) - (playerLevels[b.name]??99)
  );

  if (!oppArr.length){
    oppBox.innerHTML = `<div class="dim">단식 기록이 없습니다.</div>`;
  } else {
    oppArr.forEach(o=>{
      const lvl = playerLevels[o.name] ?? "-";
      oppBox.insertAdjacentHTML("beforeend",`
        <div class="item">
          <div class="l">
            <span class="tag">상대</span>
            <div>${o.name}(${lvl})</div>
          </div>
          <div class="r">${o.win}승 ${o.lose}패 · ${fmt1(o.rate)}%</div>
        </div>
      `);
    });
  }

  /* ✅ 복식 파트너 */
  const ptnArr = Object.entries(partnerMapDouble).map(([name,v])=>({
    name,
    win:v.win, lose:v.lose,
    points:v.points,
    total:v.win+v.lose,
    rate:(v.win+v.lose)? v.win/(v.win+v.lose)*100 : 0
  })).sort((a,b)=>
      b.points - a.points ||
      b.rate - a.rate ||
      b.total - a.total
  );

  if (!ptnArr.length){
    ptnBox.innerHTML = `<div class="dim">복식 기록이 없습니다.</div>`;
  } else {
    ptnArr.forEach(p=>{
      const lvl = playerLevels[p.name] ?? "-";
      const sign = p.points>0 ? `+${p.points}` : `${p.points}`;
      ptnBox.insertAdjacentHTML("beforeend",`
        <div class="item">
          <div class="l">
            <span class="tag">파트너</span>
            <div>${p.name}(${lvl})</div>
          </div>
          <div class="r">${p.win}승 ${p.lose}패 · ${fmt1(p.rate)}% · 승점 ${sign}</div>
        </div>
      `);
    });
  }
}

/* ----------------------------------------------------
   ✅ 데이터 로딩 → 렌더 → window.__pp 생성 → pp-ready 이벤트 발행
---------------------------------------------------- */
await loadPlayers();
await loadPastReports();
await loadAfterNov();

renderKPI();
renderMonthCards();
renderDetails();

window.__pp = {
  months,
  perMonthAll,
  perMonthSingle,
  perMonthDouble,
  oppMapSingle,
  partnerMapDouble,
  sumSglTotal,
  sumDblTotal
};

/* ✅ 차트 모듈이 확실히 실행되도록 이벤트로 알림 */
document.dispatchEvent(new Event("pp-ready"));
</script>

<!-- ✅ 그래프 박스 UI -->
<section class="card" style="margin-top:20px;">
  <h3>📊 개인 종합 그래프</h3>
  <p class="dim">그래프는 버튼을 눌러 로딩합니다. 데이터는 자동으로 불러옵니다.</p>

  <button class="btn-xl" id="btnLoadCharts">📈 그래프 불러오기</button>

  <div id="canvasBox" class="canvas-box" style="margin-top:16px;">
    <div class="canvas-grid">

      <div>
        <canvas id="chartRate" height="240"></canvas>
        <div class="note">월별 승률 (%)</div>
      </div>

      <div>
        <canvas id="chartGames" height="240"></canvas>
        <div class="note">월별 경기 수</div>
      </div>

      <div>
        <canvas id="chartModePie" height="240"></canvas>
        <div class="note">단식/복식 비율</div>
      </div>

      <div>
        <canvas id="chartOpp" height="240"></canvas>
        <div class="note">단식 상대별 승률 TOP 8</div>
      </div>

      <div>
        <canvas id="chartPartner" height="240"></canvas>
        <div class="note">복식 파트너 승률 TOP 8</div>
      </div>

      <div>
        <canvas id="chartPoints" height="240"></canvas>
        <div class="note">월별 복식 누적 승점</div>
      </div>

    </div>
  </div>
</section>

<!-- ✅ Chart.js 그래프 모듈 -->
<script>
/* ----------------------------------------------------------
   ✅ 준비: 차트 상태 저장
---------------------------------------------------------- */
window.__charts = {};
window.__chartsLoaded = false;

/* ✅ 모든 차트 제거 */
function destroyAllCharts(){
  Object.values(window.__charts).forEach(ch=>{
    try { ch.destroy(); } catch(e){}
  });
  window.__charts = {};
  window.__chartsLoaded = false;
}

/* ----------------------------------------------------------
   ✅ 그래프 생성 (pp-ready 시만 실행)
---------------------------------------------------------- */
function buildChartsOnce(){
  if (window.__chartsLoaded) return;
  window.__chartsLoaded = true;

  /* ✅ pp-data */
  const {
    months,
    perMonthAll,
    perMonthSingle,
    perMonthDouble,
    oppMapSingle,
    partnerMapDouble,
    sumSglTotal,
    sumDblTotal
  } = window.__pp;

  const ms = months.slice().sort();
  if (!ms.length){
    console.warn("⚠ 월별 데이터 없음 — 그래프 생성 스킵");
    return;
  }

  /* ✅ 박스 표시 */
  const box = document.getElementById("canvasBox");
  if (box) box.style.display = "block";

  /* ----------------------------------------------------------
     ✅ 1. 월별 승률 — Line
  ---------------------------------------------------------- */
  {
    const el = document.getElementById("chartRate");
    if (el){
      const data = ms.map(m => perMonthAll[m]?.rate ?? 0);

      window.__charts.chartRate = new Chart(el.getContext("2d"), {
        type:"line",
        data:{
          labels:ms,
          datasets:[{
            label:"월별 승률(%)",
            data,
            borderColor:"#2563eb",
            backgroundColor:"#2563eb33",
            borderWidth:2,
            tension:0.25
          }]
        },
        options:{
          responsive:true,
          scales:{ y:{ beginAtZero:true, max:100 }}
        }
      });
    }
  }

  /* ----------------------------------------------------------
     ✅ 2. 월별 경기 수 — Bar
  ---------------------------------------------------------- */
  {
    const el = document.getElementById("chartGames");
    if (el){
      const data = ms.map(m => perMonthAll[m]?.total ?? 0);

      window.__charts.chartGames = new Chart(el.getContext("2d"), {
        type:"bar",
        data:{
          labels: ms,
          datasets:[{
            label:"월별 경기 수",
            data,
            borderColor:"#1e40af",
            backgroundColor:"#1e40af66",
            borderWidth:1
          }]
        },
        options:{
          responsive:true,
          scales:{ y:{ beginAtZero:true }}
        }
      });
    }
  }

  /* ----------------------------------------------------------
     ✅ 3. 단식/복식 비율 — Doughnut
  ---------------------------------------------------------- */
  {
    const el = document.getElementById("chartModePie");
    if (el){
      window.__charts.chartModePie = new Chart(el.getContext("2d"), {
        type:"doughnut",
        data:{
          labels:["단식","복식"],
          datasets:[{
            data:[sumSglTotal, sumDblTotal],
            backgroundColor:["#3b82f6","#60a5fa"]
          }]
        },
        options:{ responsive:true }
      });
    }
  }

  /* ----------------------------------------------------------
     ✅ 4. 단식 상대 승률 TOP 8 — Bar
  ---------------------------------------------------------- */
  {
    const el = document.getElementById("chartOpp");
    if (el){
      const arr = Object.entries(oppMapSingle)
        .map(([name,v])=>({
          name,
          rate:(v.win+v.lose)? v.win/(v.win+v.lose)*100 : 0
        }))
        .sort((a,b)=>b.rate - a.rate)
        .slice(0,8);

      window.__charts.chartOpp = new Chart(el.getContext("2d"), {
        type:"bar",
        data:{
          labels: arr.map(o=>o.name),
          datasets:[{
            label:"상대 승률(%)",
            data: arr.map(o=>o.rate),
            backgroundColor:"#16a34a"
          }]
        },
        options:{
          responsive:true,
          scales:{ y:{ beginAtZero:true }}
        }
      });
    }
  }

  /* ----------------------------------------------------------
     ✅ 5. 복식 파트너 승률 TOP 8 — Bar
  ---------------------------------------------------------- */
  {
    const el = document.getElementById("chartPartner");
    if (el){
      const arr = Object.entries(partnerMapDouble)
        .map(([name,v])=>({
          name,
          rate:(v.win+v.lose)? v.win/(v.win+v.lose)*100 : 0
        }))
        .sort((a,b)=>b.rate - a.rate)
        .slice(0,8);

      window.__charts.chartPartner = new Chart(el.getContext("2d"), {
        type:"bar",
        data:{
          labels: arr.map(o=>o.name),
          datasets:[{
            label:"파트너 승률(%)",
            data: arr.map(o=>o.rate),
            backgroundColor:"#0d9488"
          }]
        },
        options:{
          responsive:true,
          scales:{ y:{ beginAtZero:true }}
        }
      });
    }
  }

  /* ----------------------------------------------------------
     ✅ 6. 월별 복식 누적 승점 — Line
  ---------------------------------------------------------- */
  {
    const el = document.getElementById("chartPoints");
    if (el){
      const pts = ms.map(m => perMonthDouble[m]?.points ?? 0);
      let run = 0;
      const cum = pts.map(v => (run += v));

      window.__charts.chartPoints = new Chart(el.getContext("2d"), {
        type:"line",
        data:{
          labels:ms,
          datasets:[{
            label:"복식 누적 승점",
            data:cum,
            borderColor:"#2563eb",
            backgroundColor:"#2563eb44",
            borderWidth:2,
            tension:0.25
          }]
        },
        options:{ responsive:true }
      });
    }
  }
}

/* ----------------------------------------------------------
   ✅ 버튼 이벤트
---------------------------------------------------------- */
document.getElementById("btnLoadCharts")?.addEventListener("click", buildChartsOnce);

/* ✅ 상단 버튼 스크롤 */
document.getElementById("openCharts")?.addEventListener("click", ()=>{
  document.getElementById("btnLoadCharts")?.scrollIntoView({behavior:"smooth"});
});

/* ✅ 페이지 떠날 때 차트 정리 */
window.addEventListener("beforeunload", destroyAllCharts);

/* ✅ 데이터 준비(pp-ready) 이후 차트 준비 OK */
document.addEventListener("pp-ready", ()=>{
  console.log("✅ pp-ready: 데이터 로딩 완료 — 그래프 생성 준비됨");
});
</script>

</main>

</body>
</html>
