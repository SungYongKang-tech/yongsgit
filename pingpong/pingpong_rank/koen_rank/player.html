<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“ ê°œì¸ íƒêµ¬ ì„±ì  ë¦¬í¬íŠ¸</title>

<!-- Pretendard -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb; --card:#ffffff;
  --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
  --shadow:0 10px 30px rgba(2,6,23,.08);
  --soft:#eaf1ff; --soft2:#eef2ff;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:"Pretendard","Noto Sans KR",system-ui,-apple-system,sans-serif;
  background:var(--bg); color:var(--ink); font-weight:600;
}
header{
  position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #e5e7eb;
}
.header-inner{
  max-width:1080px; margin:0 auto; padding:14px 16px; display:flex; gap:10px; align-items:center; justify-content:space-between;
}
h1{margin:0; font-size:clamp(18px,4vw,22px); color:var(--accent); font-weight:800}
.sub{font-size:13px; color:#334155; font-weight:700}
.btn{
  border:1px solid #d1d5db; background:#fff; color:#0f172a; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700;
}
.btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
.wrap{max-width:1080px; margin:0 auto; padding:16px}
.grid{
  display:grid; gap:14px;
  grid-template-columns: repeat(12, 1fr);
}
.card{
  background:var(--card); border-radius:16px; box-shadow:var(--shadow); padding:16px;
}
.card h3{margin:0 0 8px; font-size:18px; color:#1e3a8a}
.badge{display:inline-block; padding:6px 10px; border-radius:999px; font-size:13px; background:var(--soft); color:#1e3a8a}
.row{display:flex; align-items:center; gap:8px}
.hr{height:1px; background:#eef2f7; margin:12px 0}
.dim{color:#64748b; font-weight:700; font-size:13px}
.kpi{
  display:grid; gap:10px; grid-template-columns: repeat(4,1fr);
}
.kpi .mini{
  border:1px solid #e5e7eb; border-radius:12px; padding:14px; background:linear-gradient(180deg,#fff, #fbfdff 85%);
}
.kpi .mini h4{margin:0 0 6px; font-size:13px; color:#334155}
.kpi .mini .v{font-size:22px; font-weight:900}
.block-title{font-size:16px; font-weight:900; color:#0f172a; margin-bottom:8px}
.list{display:grid; gap:8px}
.item{
  border:1px solid #e5e7eb; padding:10px 12px; border-radius:12px; display:flex; align-items:center; justify-content:space-between;
  background:linear-gradient(180deg,#fff, #fbfdff 85%); box-shadow:0 2px 10px rgba(2,6,23,.02);
}
.item .l{display:flex; gap:8px; align-items:center}
.tag{font-size:12px; background:#e2efff; color:#1e40af; padding:4px 8px; border-radius:999px; font-weight:800}
.item .r{font-weight:900}
.btn-xl{
  display:inline-flex; align-items:center; gap:8px; padding:12px 16px; border-radius:12px; border:1px solid #c7d2fe;
  background:linear-gradient(180deg,#fff, #f3f5ff 75%); color:#1e3a8a; font-size:15px; font-weight:900; cursor:pointer;
}
.canvas-box{
  background:#fff; border:1px dashed #dbe3ff; border-radius:12px; padding:12px; display:none;
}
.canvas-grid{
  display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
}
.note{
  font-size:12.5px; color:#475569; margin-top:6px; text-align:right
}
</style>
</head>

<body>

<header>
  <div class="header-inner">
    <div>
      <h1>ğŸ“ ê°œì¸ íƒêµ¬ ì„±ì  ë¦¬í¬íŠ¸</h1>
      <div class="sub" id="playerNameSub">ì„ ìˆ˜ ì´ë¦„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
    </div>
    <div class="row">
      <a class="btn" href="monthly-report.html">â† ì›”ê°„ ë¦¬í¬íŠ¸</a>
      <button id="openCharts" class="btn primary">ğŸ“Š ê·¸ë˜í”„ ì—´ê¸°</button>
    </div>
  </div>
</header>

<main class="wrap">

    <!-- âœ… Firebase + ë°ì´í„° ë¡œë”© -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

/* ----------------------------------------------------
   âœ… Firebase ì„¤ì •
---------------------------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ----------------------------------------------------
   âœ… Utils
---------------------------------------------------- */
const $ = s => document.querySelector(s);
const fmt1 = n => (Math.round(n*10)/10).toFixed(1);
const cmpMonth = (a,b)=> a.localeCompare(b);
const POINT_WIN = 2, POINT_LOSE = -1;

/* ----------------------------------------------------
   âœ… URL íŒŒë¼ë¯¸í„°
---------------------------------------------------- */
const params = new URLSearchParams(location.search);
const playerName = params.get("name") || "";
$("#playerNameSub").textContent = playerName ? `ì„ ìˆ˜: ${playerName}` : "ì„ ìˆ˜ ì •ë³´ ì—†ìŒ";

/* ----------------------------------------------------
   âœ… ì „ì—­ ë°ì´í„°
---------------------------------------------------- */
let playerLevels = {};
let months = [];
let perMonthAll = {};
let perMonthSingle = {};
let perMonthDouble = {};

let oppMapSingle = {};
let partnerMapDouble = {};

let sumAllTotal=0, sumAllWin=0, sumAllLose=0;
let sumSglTotal=0, sumSglWin=0, sumSglLose=0;
let sumDblTotal=0, sumDblWin=0, sumDblLose=0;
let sumPoints=0;

/* ----------------------------------------------------
   âœ… 1) Players (ë¶€ìˆ˜)
---------------------------------------------------- */
async function loadPlayers(){
  const snap = await get(ref(db,"players"));
  if (!snap.exists()) return;

  const data = snap.val();
  Object.values(data).forEach(p=>{
    if (p.name) playerLevels[p.name] = p.level ?? "-";
  });
}

/* ----------------------------------------------------
   âœ… 2) 2025-09, 10 â€” monthlyReports (í†µí•©ì „ì )
---------------------------------------------------- */
async function loadPastReports(){
  const targets = ["2025-09","2025-10"];

  for (let m of targets){
    const snap = await get(ref(db,`monthlyReports/${m}/players`));
    if (!snap.exists()) continue;

    const arr = Object.values(snap.val());
    const row = arr.find(p => p.name === playerName);
    if (!row) continue;

    const win  = Number(row.wins ?? row.win ?? 0);
    const lose = Number(row.losses ?? row.lose ?? 0);
    const total = win + lose;
    const rate  = total ? win/total*100 : 0;

    perMonthAll[m] = { total, win, lose, rate };
    months.push(m);

    sumAllTotal += total;
    sumAllWin   += win;
    sumAllLose  += lose;
  }
}

/* ----------------------------------------------------
   âœ… 3) 2025-11 ì´í›„ matches ë‹¨ì‹/ë³µì‹ ë¶„ë¦¬
---------------------------------------------------- */
async function loadAfterNov(){
  const snap = await get(ref(db,"matches"));
  if (!snap.exists()) return;

  const NOV = "2025-11";
  const games = Object.values(snap.val());

  const myGames = games.filter(g=>{
    const mk = g.monthKey;
    if (!mk) return false;
    if (cmpMonth(mk,NOV) < 0) return false;
    return [...g.namesA, ...g.namesB].includes(playerName);
  });

  // âœ… ì›” ëª©ë¡ ì¶”ê°€
  myGames.forEach(g=>{
    if (!months.includes(g.monthKey)) months.push(g.monthKey);
  });

  // âœ… months ì¤‘ë³µ ì œê±°
  months = [...new Set(months)];

  // âœ… ì›”ë³„ ì´ˆê¸°í™”
  months.forEach(m=>{
    if (!perMonthAll[m]) perMonthAll[m] = { total:0, win:0, lose:0, rate:0 };
    if (!perMonthSingle[m]) perMonthSingle[m] = { total:0, win:0, lose:0, rate:0 };
    if (!perMonthDouble[m]) perMonthDouble[m] = { total:0, win:0, lose:0, rate:0, points:0 };
  });

  // âœ… ì§‘ê³„
  myGames.forEach(g=>{
    const mk = g.monthKey;
    const mode = g.mode || "single";
    const A = g.namesA || [];
    const B = g.namesB || [];

    const iAmA = A.includes(playerName);
    const iWon = (g.winnerSide==="A" && iAmA) || (g.winnerSide==="B" && !iAmA);

    // âœ… í†µí•©
    perMonthAll[mk].total++;
    if (iWon) perMonthAll[mk].win++; else perMonthAll[mk].lose++;

    // âœ… ë‹¨ì‹
    if (mode === "single"){
      perMonthSingle[mk].total++;
      if (iWon) perMonthSingle[mk].win++; else perMonthSingle[mk].lose++;

      const opp = iAmA ? B[0] : A[0];
      if (opp){
        if (!oppMapSingle[opp]) oppMapSingle[opp] = { win:0, lose:0 };
        if (iWon) oppMapSingle[opp].win++; else oppMapSingle[opp].lose++;
      }

    // âœ… ë³µì‹
    } else {
      perMonthDouble[mk].total++;
      if (iWon) perMonthDouble[mk].win++; else perMonthDouble[mk].lose++;

      // ìŠ¹ì 
      const pts = iWon ? POINT_WIN : POINT_LOSE;
      perMonthDouble[mk].points += pts;
      sumPoints += pts;

      // íŒŒíŠ¸ë„ˆ
      const team = iAmA ? A : B;
      const partner = team.find(n => n !== playerName);
      if (partner){
        if (!partnerMapDouble[partner]) partnerMapDouble[partner] = { win:0, lose:0, points:0 };
        if (iWon){
          partnerMapDouble[partner].win++;
          partnerMapDouble[partner].points += POINT_WIN;
        } else {
          partnerMapDouble[partner].lose++;
          partnerMapDouble[partner].points += POINT_LOSE;
        }
      }
    }
  });

  // âœ… ìŠ¹ë¥  ê³„ì‚° ë° í•©ê³„ ìƒì„±
  months.forEach(m=>{
    const a = perMonthAll[m];
    const s = perMonthSingle[m];
    const d = perMonthDouble[m];

    a.rate = a.total ? a.win/a.total*100 : 0;
    s.rate = s.total ? s.win/s.total*100 : 0;
    d.rate = d.total ? d.win/d.total*100 : 0;

    sumSglTotal += s.total; sumSglWin += s.win; sumSglLose += s.lose;
    sumDblTotal += d.total; sumDblWin += d.win; sumDblLose += d.lose;

    sumAllTotal += a.total; sumAllWin += a.win; sumAllLose += a.lose;
  });
}

/* ----------------------------------------------------
   âœ… ë Œë”ë§: KPI / ì›”ë³„ ì¹´ë“œ / ìƒì„¸ ë¶„ì„
---------------------------------------------------- */
function renderKPI(){
  $("#kpiAllTotal").textContent = sumAllTotal;
  $("#kpiAllWL").textContent    = `${sumAllWin}ìŠ¹ / ${sumAllLose}íŒ¨`;

  $("#kpiSglTotal").textContent = sumSglTotal;
  $("#kpiSglWL").textContent    = `${sumSglWin}ìŠ¹ / ${sumSglLose}íŒ¨`;

  $("#kpiDblTotal").textContent = sumDblTotal;
  $("#kpiDblWL").textContent    = `${sumDblWin}ìŠ¹ / ${sumDblLose}íŒ¨`;

  $("#kpiPoints").textContent   = sumPoints;

  const last = months.slice().sort().at(-1) || "í˜„ì¬";
  $("#periodBadge").textContent = `ì§‘ê³„ ë²”ìœ„: 2025-09 ~ ${last}`;
}

function renderMonthCards(){
  const box = $("#monthList");
  box.innerHTML = "";

  const sorted = months.slice().sort();

  sorted.forEach(m=>{
    const a = perMonthAll[m];
    const s = perMonthSingle[m];
    const d = perMonthDouble[m];
    const afterNov = cmpMonth(m,"2025-11") >= 0;

    box.insertAdjacentHTML("beforeend",`
      <div class="item">
        <div class="l">
          ${afterNov
            ? `<span class="tag">ë‹¨/ë³µì‹</span>`
            : `<span class="tag" style="background:#eef2ff;color:#3730a3">í†µí•©</span>`}
          <div><b>${m}</b></div>
        </div>
        <div class="r">
          ${afterNov
            ? `í†µí•© ${a.total}G Â· ${fmt1(a.rate)}% / ë‹¨ì‹ ${s.total}G Â· ${fmt1(s.rate)}% / ë³µì‹ ${d.total}G Â· ${fmt1(d.rate)}% Â· ìŠ¹ì  ${d.points}`
            : `í†µí•© ${a.total}G Â· ${a.win}ìŠ¹ ${a.lose}íŒ¨ Â· ${fmt1(a.rate)}%`}
        </div>
      </div>
    `);
  });
}

function renderDetails(){
  const oppBox = $("#opponentSingles");
  const ptnBox = $("#partnerDoubles");

  oppBox.innerHTML = "";
  ptnBox.innerHTML = "";

  /* âœ… ë‹¨ì‹ ìƒëŒ€ */
  const oppArr = Object.entries(oppMapSingle).map(([name,v])=>({
    name,
    win:v.win, lose:v.lose,
    total:v.win+v.lose,
    rate:(v.win+v.lose)? v.win/(v.win+v.lose)*100 : 0
  })).sort((a,b)=>
      b.rate - a.rate ||
      b.total - a.total ||
      (playerLevels[a.name]??99) - (playerLevels[b.name]??99)
  );

  if (!oppArr.length){
    oppBox.innerHTML = `<div class="dim">ë‹¨ì‹ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  } else {
    oppArr.forEach(o=>{
      const lvl = playerLevels[o.name] ?? "-";
      oppBox.insertAdjacentHTML("beforeend",`
        <div class="item">
          <div class="l">
            <span class="tag">ìƒëŒ€</span>
            <div>${o.name}(${lvl})</div>
          </div>
          <div class="r">${o.win}ìŠ¹ ${o.lose}íŒ¨ Â· ${fmt1(o.rate)}%</div>
        </div>
      `);
    });
  }

  /* âœ… ë³µì‹ íŒŒíŠ¸ë„ˆ */
  const ptnArr = Object.entries(partnerMapDouble).map(([name,v])=>({
    name,
    win:v.win, lose:v.lose,
    points:v.points,
    total:v.win+v.lose,
    rate:(v.win+v.lose)? v.win/(v.win+v.lose)*100 : 0
  })).sort((a,b)=>
      b.points - a.points ||
      b.rate - a.rate ||
      b.total - a.total
  );

  if (!ptnArr.length){
    ptnBox.innerHTML = `<div class="dim">ë³µì‹ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  } else {
    ptnArr.forEach(p=>{
      const lvl = playerLevels[p.name] ?? "-";
      const sign = p.points>0 ? `+${p.points}` : `${p.points}`;
      ptnBox.insertAdjacentHTML("beforeend",`
        <div class="item">
          <div class="l">
            <span class="tag">íŒŒíŠ¸ë„ˆ</span>
            <div>${p.name}(${lvl})</div>
          </div>
          <div class="r">${p.win}ìŠ¹ ${p.lose}íŒ¨ Â· ${fmt1(p.rate)}% Â· ìŠ¹ì  ${sign}</div>
        </div>
      `);
    });
  }
}

/* ----------------------------------------------------
   âœ… ë°ì´í„° ë¡œë”© â†’ ë Œë” â†’ window.__pp ìƒì„± â†’ pp-ready ì´ë²¤íŠ¸ ë°œí–‰
---------------------------------------------------- */
await loadPlayers();
await loadPastReports();
await loadAfterNov();

renderKPI();
renderMonthCards();
renderDetails();

window.__pp = {
  months,
  perMonthAll,
  perMonthSingle,
  perMonthDouble,
  oppMapSingle,
  partnerMapDouble,
  sumSglTotal,
  sumDblTotal
};

/* âœ… ì°¨íŠ¸ ëª¨ë“ˆì´ í™•ì‹¤íˆ ì‹¤í–‰ë˜ë„ë¡ ì´ë²¤íŠ¸ë¡œ ì•Œë¦¼ */
document.dispatchEvent(new Event("pp-ready"));
</script>

<!-- âœ… ê·¸ë˜í”„ ë°•ìŠ¤ UI -->
<section class="card" style="margin-top:20px;">
  <h3>ğŸ“Š ê°œì¸ ì¢…í•© ê·¸ë˜í”„</h3>
  <p class="dim">ê·¸ë˜í”„ëŠ” ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¡œë”©í•©ë‹ˆë‹¤. ë°ì´í„°ëŠ” ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</p>

  <button class="btn-xl" id="btnLoadCharts">ğŸ“ˆ ê·¸ë˜í”„ ë¶ˆëŸ¬ì˜¤ê¸°</button>

  <div id="canvasBox" class="canvas-box" style="margin-top:16px;">
    <div class="canvas-grid">

      <div>
        <canvas id="chartRate" height="240"></canvas>
        <div class="note">ì›”ë³„ ìŠ¹ë¥  (%)</div>
      </div>

      <div>
        <canvas id="chartGames" height="240"></canvas>
        <div class="note">ì›”ë³„ ê²½ê¸° ìˆ˜</div>
      </div>

      <div>
        <canvas id="chartModePie" height="240"></canvas>
        <div class="note">ë‹¨ì‹/ë³µì‹ ë¹„ìœ¨</div>
      </div>

      <div>
        <canvas id="chartOpp" height="240"></canvas>
        <div class="note">ë‹¨ì‹ ìƒëŒ€ë³„ ìŠ¹ë¥  TOP 8</div>
      </div>

      <div>
        <canvas id="chartPartner" height="240"></canvas>
        <div class="note">ë³µì‹ íŒŒíŠ¸ë„ˆ ìŠ¹ë¥  TOP 8</div>
      </div>

      <div>
        <canvas id="chartPoints" height="240"></canvas>
        <div class="note">ì›”ë³„ ë³µì‹ ëˆ„ì  ìŠ¹ì </div>
      </div>

    </div>
  </div>
</section>

<!-- âœ… Chart.js ê·¸ë˜í”„ ëª¨ë“ˆ -->
<script>
/* ----------------------------------------------------------
   âœ… ì¤€ë¹„: ì°¨íŠ¸ ìƒíƒœ ì €ì¥
---------------------------------------------------------- */
window.__charts = {};
window.__chartsLoaded = false;

/* âœ… ëª¨ë“  ì°¨íŠ¸ ì œê±° */
function destroyAllCharts(){
  Object.values(window.__charts).forEach(ch=>{
    try { ch.destroy(); } catch(e){}
  });
  window.__charts = {};
  window.__chartsLoaded = false;
}

/* ----------------------------------------------------------
   âœ… ê·¸ë˜í”„ ìƒì„± (pp-ready ì‹œë§Œ ì‹¤í–‰)
---------------------------------------------------------- */
function buildChartsOnce(){
  if (window.__chartsLoaded) return;
  window.__chartsLoaded = true;

  /* âœ… pp-data */
  const {
    months,
    perMonthAll,
    perMonthSingle,
    perMonthDouble,
    oppMapSingle,
    partnerMapDouble,
    sumSglTotal,
    sumDblTotal
  } = window.__pp;

  const ms = months.slice().sort();
  if (!ms.length){
    console.warn("âš  ì›”ë³„ ë°ì´í„° ì—†ìŒ â€” ê·¸ë˜í”„ ìƒì„± ìŠ¤í‚µ");
    return;
  }

  /* âœ… ë°•ìŠ¤ í‘œì‹œ */
  const box = document.getElementById("canvasBox");
  if (box) box.style.display = "block";

  /* ----------------------------------------------------------
     âœ… 1. ì›”ë³„ ìŠ¹ë¥  â€” Line
  ---------------------------------------------------------- */
  {
    const el = document.getElementById("chartRate");
    if (el){
      const data = ms.map(m => perMonthAll[m]?.rate ?? 0);

      window.__charts.chartRate = new Chart(el.getContext("2d"), {
        type:"line",
        data:{
          labels:ms,
          datasets:[{
            label:"ì›”ë³„ ìŠ¹ë¥ (%)",
            data,
            borderColor:"#2563eb",
            backgroundColor:"#2563eb33",
            borderWidth:2,
            tension:0.25
          }]
        },
        options:{
          responsive:true,
          scales:{ y:{ beginAtZero:true, max:100 }}
        }
      });
    }
  }

  /* ----------------------------------------------------------
     âœ… 2. ì›”ë³„ ê²½ê¸° ìˆ˜ â€” Bar
  ---------------------------------------------------------- */
  {
    const el = document.getElementById("chartGames");
    if (el){
      const data = ms.map(m => perMonthAll[m]?.total ?? 0);

      window.__charts.chartGames = new Chart(el.getContext("2d"), {
        type:"bar",
        data:{
          labels: ms,
          datasets:[{
            label:"ì›”ë³„ ê²½ê¸° ìˆ˜",
            data,
            borderColor:"#1e40af",
            backgroundColor:"#1e40af66",
            borderWidth:1
          }]
        },
        options:{
          responsive:true,
          scales:{ y:{ beginAtZero:true }}
        }
      });
    }
  }

  /* ----------------------------------------------------------
     âœ… 3. ë‹¨ì‹/ë³µì‹ ë¹„ìœ¨ â€” Doughnut
  ---------------------------------------------------------- */
  {
    const el = document.getElementById("chartModePie");
    if (el){
      window.__charts.chartModePie = new Chart(el.getContext("2d"), {
        type:"doughnut",
        data:{
          labels:["ë‹¨ì‹","ë³µì‹"],
          datasets:[{
            data:[sumSglTotal, sumDblTotal],
            backgroundColor:["#3b82f6","#60a5fa"]
          }]
        },
        options:{ responsive:true }
      });
    }
  }

  /* ----------------------------------------------------------
     âœ… 4. ë‹¨ì‹ ìƒëŒ€ ìŠ¹ë¥  TOP 8 â€” Bar
  ---------------------------------------------------------- */
  {
    const el = document.getElementById("chartOpp");
    if (el){
      const arr = Object.entries(oppMapSingle)
        .map(([name,v])=>({
          name,
          rate:(v.win+v.lose)? v.win/(v.win+v.lose)*100 : 0
        }))
        .sort((a,b)=>b.rate - a.rate)
        .slice(0,8);

      window.__charts.chartOpp = new Chart(el.getContext("2d"), {
        type:"bar",
        data:{
          labels: arr.map(o=>o.name),
          datasets:[{
            label:"ìƒëŒ€ ìŠ¹ë¥ (%)",
            data: arr.map(o=>o.rate),
            backgroundColor:"#16a34a"
          }]
        },
        options:{
          responsive:true,
          scales:{ y:{ beginAtZero:true }}
        }
      });
    }
  }

  /* ----------------------------------------------------------
     âœ… 5. ë³µì‹ íŒŒíŠ¸ë„ˆ ìŠ¹ë¥  TOP 8 â€” Bar
  ---------------------------------------------------------- */
  {
    const el = document.getElementById("chartPartner");
    if (el){
      const arr = Object.entries(partnerMapDouble)
        .map(([name,v])=>({
          name,
          rate:(v.win+v.lose)? v.win/(v.win+v.lose)*100 : 0
        }))
        .sort((a,b)=>b.rate - a.rate)
        .slice(0,8);

      window.__charts.chartPartner = new Chart(el.getContext("2d"), {
        type:"bar",
        data:{
          labels: arr.map(o=>o.name),
          datasets:[{
            label:"íŒŒíŠ¸ë„ˆ ìŠ¹ë¥ (%)",
            data: arr.map(o=>o.rate),
            backgroundColor:"#0d9488"
          }]
        },
        options:{
          responsive:true,
          scales:{ y:{ beginAtZero:true }}
        }
      });
    }
  }

  /* ----------------------------------------------------------
     âœ… 6. ì›”ë³„ ë³µì‹ ëˆ„ì  ìŠ¹ì  â€” Line
  ---------------------------------------------------------- */
  {
    const el = document.getElementById("chartPoints");
    if (el){
      const pts = ms.map(m => perMonthDouble[m]?.points ?? 0);
      let run = 0;
      const cum = pts.map(v => (run += v));

      window.__charts.chartPoints = new Chart(el.getContext("2d"), {
        type:"line",
        data:{
          labels:ms,
          datasets:[{
            label:"ë³µì‹ ëˆ„ì  ìŠ¹ì ",
            data:cum,
            borderColor:"#2563eb",
            backgroundColor:"#2563eb44",
            borderWidth:2,
            tension:0.25
          }]
        },
        options:{ responsive:true }
      });
    }
  }
}

/* ----------------------------------------------------------
   âœ… ë²„íŠ¼ ì´ë²¤íŠ¸
---------------------------------------------------------- */
document.getElementById("btnLoadCharts")?.addEventListener("click", buildChartsOnce);

/* âœ… ìƒë‹¨ ë²„íŠ¼ ìŠ¤í¬ë¡¤ */
document.getElementById("openCharts")?.addEventListener("click", ()=>{
  document.getElementById("btnLoadCharts")?.scrollIntoView({behavior:"smooth"});
});

/* âœ… í˜ì´ì§€ ë– ë‚  ë•Œ ì°¨íŠ¸ ì •ë¦¬ */
window.addEventListener("beforeunload", destroyAllCharts);

/* âœ… ë°ì´í„° ì¤€ë¹„(pp-ready) ì´í›„ ì°¨íŠ¸ ì¤€ë¹„ OK */
document.addEventListener("pp-ready", ()=>{
  console.log("âœ… pp-ready: ë°ì´í„° ë¡œë”© ì™„ë£Œ â€” ê·¸ë˜í”„ ìƒì„± ì¤€ë¹„ë¨");
});
</script>

</main>

</body>
</html>
