<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>🏓 개인 탁구 성적 리포트</title>

<!-- Pretendard -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />

<style>
:root {
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb;
  --accent:#2563eb; --ok:#16a34a; --danger:#ef4444; 
  --card:#fff; --shadow:0 8px 28px rgba(0,0,0,.08);
}

body {
  margin:0;
  padding:0;
  font-family:"Pretendard","Noto Sans KR",sans-serif;
  background:var(--bg);
  color:var(--ink);
  font-weight:600;
}

header {
  background:#fff;
  box-shadow:var(--shadow);
  padding:18px 10px;
  text-align:center;
  position:sticky;
  top:0;
  z-index:50;
}
header h1 {
  margin:0;
  color:var(--accent);
  font-size:clamp(20px,4vw,26px);
  font-weight:800;
}

main {
  max-width:900px;
  margin:0 auto;
  padding:20px 10px 80px;
}

.section {
  margin-bottom:26px;
}

.section-title {
  font-size:20px;
  font-weight:800;
  margin-bottom:10px;
  color:#1e3a8a;
}

.card {
  background:var(--card);
  border-radius:14px;
  padding:20px;
  margin-bottom:16px;
  box-shadow:var(--shadow);
}

.summary-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:14px;
}

.summary-box {
  background:#e0f2fe;
  border-radius:10px;
  padding:14px;
  text-align:center;
  font-size:17px;
  font-weight:700;
}

.stat-list li {
  margin:5px 0;
  font-size:15px;
}

.table-wrap {
  overflow-x:auto;
}

table {
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:10px;
  overflow:hidden;
  font-size:14px;
  box-shadow:var(--shadow);
}

thead th {
  background:#e2e8f0;
  padding:10px 6px;
  text-align:center;
  white-space:nowrap;
}

tbody td {
  border-bottom:1px solid #f1f5f9;
  text-align:center;
  padding:9px 6px;
}

.win { color:var(--ok); font-weight:700; }
.lose { color:var(--danger); font-weight:700; }

.graph-btn {
  width:100%;
  background:var(--accent);
  color:#fff;
  padding:12px;
  text-align:center;
  border-radius:10px;
  font-size:17px;
  font-weight:700;
  cursor:pointer;
  margin-top:16px;
}

canvas {
  margin-top:16px;
  background:#fff;
  border-radius:12px;
  box-shadow:var(--shadow);
}
</style>
</head>

<body>
<header>
  <h1>🏓 개인 탁구 성적 리포트</h1>
</header>

<main>
  
  <!-- ✅ 프로필 영역 -->
  <section class="section" id="profileSection">
    <div class="card">
      <h2 class="section-title" id="playerNameTitle">선수 이름</h2>
      <p style="font-size:16px; color:#475569;" id="levelInfo">부수: -</p>
    </div>
  </section>

  <!-- ✅ 요약 영역 -->
  <section class="section">
    <div class="section-title">📌 요약 통계</div>
    <div class="summary-grid" id="summaryGrid"></div>
  </section>

  <!-- ✅ 9월·10월 통합 전적 -->
  <section class="section" id="prevStatsSection">
    <div class="section-title">📁 9월 · 10월 통합 전적</div>
    <div id="prevStatsCard" class="card"></div>
  </section>

  <!-- ✅ 11월 이후 단식/복식 분석 -->
  <section class="section" id="detailedStatsSection">
    <div class="section-title">📊 11월 이후 상세 분석</div>
    <div id="detailedStatsCard" class="card"></div>
  </section>

  <!-- ✅ 그래프 버튼 -->
  <button id="loadGraphsBtn" class="graph-btn">📊 그래프 열기</button>

  <!-- ✅ 그래프 영역 -->
  <section class="section" id="graphSection" style="display:none;">
    <div class="section-title">📈 개인 그래프 분석</div>

    <canvas id="chart_monthly_rate"></canvas>
    <canvas id="chart_monthly_games"></canvas>
    <canvas id="chart_type_ratio"></canvas>
    <canvas id="chart_vs"></canvas>
    <canvas id="chart_partner"></canvas>
    <canvas id="chart_score"></canvas>
  </section>

</main>


<!-- ✅ Firebase + 데이터 처리 스크립트 -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};

// ✅ Firebase 초기화
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

// ✅ URL 파라미터에서 name 추출
const params     = new URLSearchParams(window.location.search);
const playerName = params.get("name");

document.getElementById("playerNameTitle").innerText = `${playerName} 선수 성적 리포트`;

function format(n){ return (Math.round(n*10)/10).toFixed(1); }

// ✅ 글로벌 누적 데이터
let playerLevel = "-";

// ✅ 9월, 10월 데이터 저장
let prevStats = {
  total: 0,
  win: 0,
  lose: 0,
  rate: 0
};

// ✅ 11월 이후 단식/복식/상대/파트너/승점 데이터
let analysis = {
  single: { total:0, win:0, lose:0 },
  double: { total:0, win:0, lose:0 },
  vs: {},          // 상대별 전적
  partner: {},     // 파트너별 전적
  pointHistory: [] // 월별 승점
};

// ✅ 단계 1 — 선수 부수 불러오기
async function loadPlayerLevel() {
  const snap = await get(ref(db, "players"));
  if (!snap.exists()) return;

  const players = snap.val();
  Object.values(players).forEach(p => {
    if (p.name === playerName) {
      playerLevel = p.level;
    }
  });

  document.getElementById("levelInfo").innerText = `부수: ${playerLevel}`;
}

// ✅ 단계 2 — 9월/10월 통합 전적 불러오기
async function loadPreviousMonths() {
  const months = ["2025-09", "2025-10"];

  for (let m of months) {
    const snap = await get(ref(db, `monthlyReports/${m}/players`));
    if (!snap.exists()) continue;

    const arr = snap.val();

    Object.values(arr).forEach(p => {
      if (p.name === playerName) {
        prevStats.win   += p.wins ?? p.win ?? 0;
        prevStats.lose  += p.losses ?? p.lose ?? 0;
      }
    });
  }

  prevStats.total = prevStats.win + prevStats.lose;
  prevStats.rate  = prevStats.total ? (prevStats.win / prevStats.total * 100) : 0;

  renderPrevStats();
}

// ✅ 단계 3 — 11월 이후 상세 분석
async function loadDetailedStats() {
  const snap = await get(ref(db, "matches"));
  if (!snap.exists()) return;

  const matches = snap.val();

  Object.values(matches).forEach(m => {
    if (!m.monthKey || m.monthKey < "2025-11") return;

    const isSingle = m.mode === "single";
    const isDouble = m.mode === "double";

    let isInvolved = false;
    if (m.namesA.includes(playerName) || m.namesB.includes(playerName)) {
      isInvolved = true;
    }
    if (!isInvolved) return;

    // ✅ 단식/복식 카운트
    let statType = isSingle ? analysis.single : analysis.double;
    statType.total++;

    let win = false;
    if (m.winnerSide === 'A' && m.namesA.includes(playerName)) win = true;
    if (m.winnerSide === 'B' && m.namesB.includes(playerName)) win = true;

    if (win) statType.win++; else statType.lose++;

    // ✅ 승점 기록 (+2 / -1)
    analysis.pointHistory.push({
      month: m.monthKey,
      point: win ? 2 : -1
    });

    // ✅ 상대별 전적
    let opponents = m.namesA.includes(playerName) ? m.namesB : m.namesA;
    opponents.forEach(op => {
      if (!analysis.vs[op]) analysis.vs[op] = { win:0, lose:0 };
      if (win) analysis.vs[op].win++; else analysis.vs[op].lose++;
    });

    // ✅ 파트너 전적 (복식만)
    if (isDouble) {
      let myTeam = m.namesA.includes(playerName) ? m.namesA : m.namesB;
      myTeam.forEach(p => {
        if (p === playerName) return;
        if (!analysis.partner[p]) analysis.partner[p] = { win:0, lose:0 };
        if (win) analysis.partner[p].win++; else analysis.partner[p].lose++;
      });
    }
  });

  renderDetailedStats();
  updateSummary();
}

// ✅ 9월·10월 결과 출력
function renderPrevStats() {
  const box = document.getElementById("prevStatsCard");

  if (prevStats.total === 0) {
    box.innerHTML = `<p style="color:#64748b;">기록 없음</p>`;
    return;
  }

  box.innerHTML = `
    <ul class="stat-list">
      <li><b>총 경기:</b> ${prevStats.total}</li>
      <li><b>승 / 패:</b> ${prevStats.win}승 / ${prevStats.lose}패</li>
      <li><b>승률:</b> ${format(prevStats.rate)}%</li>
    </ul>
  `;
}

// ✅ 11월 이후 상세 분석 출력
function renderDetailedStats() {
  const box = document.getElementById("detailedStatsCard");

  const s = analysis.single;
  const d = analysis.double;

  box.innerHTML = `
    <ul class="stat-list">
      <li><b>단식:</b> ${s.total}경기 (${s.win}승 / ${s.lose}패)</li>
      <li><b>복식:</b> ${d.total}경기 (${d.win}승 / ${d.lose}패)</li>
      <li><b>전체 승률:</b> ${format((s.win + d.win) / (s.total + d.total) * 100 || 0)}%</li>
    </ul>
  `;
}

// ✅ 요약 통계 박스 업데이트
function updateSummary() {
  const grid = document.getElementById("summaryGrid");

  const totalGames = prevStats.total + analysis.single.total + analysis.double.total;
  const totalWin   = prevStats.win + analysis.single.win + analysis.double.win;
  const totalRate  = totalGames ? (totalWin / totalGames * 100) : 0;

  grid.innerHTML = `
    <div class="summary-box">총 경기: ${totalGames}</div>
    <div class="summary-box">총 승률: ${format(totalRate)}%</div>
    <div class="summary-box">단식 ${analysis.single.win}승</div>
    <div class="summary-box">복식 ${analysis.double.win}승</div>
  `;
}

// ✅ 초기 로딩 실행
await loadPlayerLevel();
await loadPreviousMonths();
await loadDetailedStats();
</script>

<!-- ✅ Chart.js + 그래프 렌더링 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// ✅ Chart 인스턴스 보관 (겹침 방지!)
let chartMonthlyRate   = null;
let chartMonthlyGames  = null;
let chartTypeRatio     = null;
let chartVs            = null;
let chartPartner       = null;
let chartScore         = null;

// ✅ 이미 로딩했는지 체크
let graphLoaded = false;

// ✅ 그래프 생성 함수
function createCharts() {
  if (graphLoaded) return;   // ✅ 중복 생성 방지
  graphLoaded = true;

  document.getElementById("graphSection").style.display = "block";

  // ✅ 1) 월별 승률
  {
    const ctx = document.getElementById("chart_monthly_rate").getContext("2d");

    const monthMap = {};

    // 9월~10월
    if (prevStats.total > 0) {
      monthMap["2025-09~10"] = {
        win: prevStats.win,
        lose: prevStats.lose
      };
    }

    // 11월 이후
    analysis.pointHistory.forEach(item => {
      if (!monthMap[item.month]) monthMap[item.month] = { win: 0, lose: 0 };
      if (item.point === 2) monthMap[item.month].win++;
      else monthMap[item.month].lose++;
    });

    const labels = Object.keys(monthMap);
    const rateData = labels.map(m => {
      const w = monthMap[m].win;
      const l = monthMap[m].lose;
      return (w + l) ? (w / (w + l) * 100) : 0;
    });

    if (chartMonthlyRate) chartMonthlyRate.destroy();
    chartMonthlyRate = new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: "승률 (%)",
          data: rateData,
          backgroundColor: "#2563eb88",
          borderColor: "#2563eb",
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, max: 100 }
        }
      }
    });
  }

  // ✅ 2) 월별 경기 수
  {
    const ctx = document.getElementById("chart_monthly_games").getContext("2d");

    const monthMap = {};

    if (prevStats.total > 0) {
      monthMap["2025-09~10"] = prevStats.total;
    }

    analysis.pointHistory.forEach(item => {
      if (!monthMap[item.month]) monthMap[item.month] = 0;
      monthMap[item.month]++;
    });

    const labels = Object.keys(monthMap);
    const gameData = Object.values(monthMap);

    if (chartMonthlyGames) chartMonthlyGames.destroy();
    chartMonthlyGames = new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: "경기 수",
          data: gameData,
          backgroundColor: "#1e40af99",
          borderColor: "#1e40af",
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  // ✅ 3) 단식/복식 비율 (도넛)
  {
    const ctx = document.getElementById("chart_type_ratio").getContext("2d");

    let single = analysis.single.total;
    let double = analysis.double.total;

    if (chartTypeRatio) chartTypeRatio.destroy();
    chartTypeRatio = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: ["단식", "복식"],
        datasets: [{
          data: [single, double],
          backgroundColor: ["#3b82f6", "#60a5fa"]
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: "bottom" } }
      }
    });
  }

  // ✅ 4) 상대별 전적
  {
    const ctx = document.getElementById("chart_vs").getContext("2d");

    const labels = Object.keys(analysis.vs);
    const winData = labels.map(n => analysis.vs[n].win);
    const loseData = labels.map(n => analysis.vs[n].lose);

    if (chartVs) chartVs.destroy();
    chartVs = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            label: "승",
            data: winData,
            backgroundColor: "#16a34a"
          },
          {
            label: "패",
            data: loseData,
            backgroundColor: "#ef4444"
          }
        ]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  // ✅ 5) 파트너별 전적
  {
    const ctx = document.getElementById("chart_partner").getContext("2d");

    const labels = Object.keys(analysis.partner);
    const winData = labels.map(n => analysis.partner[n].win);
    const loseData = labels.map(n => analysis.partner[n].lose);

    if (chartPartner) chartPartner.destroy();
    chartPartner = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            label: "승",
            data: winData,
            backgroundColor: "#0d9488"
          },
          {
            label: "패",
            data: loseData,
            backgroundColor: "#f97316"
          }
        ]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  // ✅ 6) 누적 승점 변화
  {
    const ctx = document.getElementById("chart_score").getContext("2d");

    let monthGroup = {};

    analysis.pointHistory.forEach(item => {
      if (!monthGroup[item.month]) monthGroup[item.month] = 0;
      monthGroup[item.month] += item.point;
    });

    const labels = Object.keys(monthGroup);
    const scoreData = Object.values(monthGroup);

    if (chartScore) chartScore.destroy();
    chartScore = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "월별 승점",
          data: scoreData,
          borderColor: "#2563eb",
          borderWidth: 3,
          pointBackgroundColor: "#1d4ed8",
          tension: 0.25
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });
  }
}

// ✅ 버튼 클릭 시 그래프 생성
document.getElementById("loadGraphsBtn").addEventListener("click", createCharts);
</script>


</body>
</html>
