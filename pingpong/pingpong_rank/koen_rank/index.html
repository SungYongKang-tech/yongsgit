<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ“ ê²½ê¸°ê²°ê³¼ ì…ë ¥</title>
<style>
@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

:root {
  --ink:#0f172a; --muted:#64748b; --card:#fff; --bg:#f5f7fb;
  --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
  --shadow:0 8px 28px rgba(0,0,0,.08);
}
body {
  margin:0;
  font-family:"Pretendard","Noto Sans KR",sans-serif;
  font-weight:600;
  background:var(--bg);
  color:var(--ink);
}
header {
  background:#fff;
  border-bottom:1px solid #e5e7eb;
  position:sticky; top:0; z-index:10;
}
.header-inner {
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:12px 0;
}
h1 {
  margin:2px 0 8px;
  font-size:clamp(20px,4vw,24px);
  color:var(--accent);
  font-weight:700;
}
.row {
  display:flex; flex-wrap:wrap; gap:8px;
  align-items:center; justify-content:center;
}
.btn {
  border:1px solid #ccc; border-radius:8px; padding:6px 10px;
  font-size:14px; cursor:pointer; background:#fff; transition:.2s; font-weight:600;
}
.btn.primary {background:var(--accent); color:#fff; border-color:var(--accent);}
.btn.ok {background:var(--ok); color:#fff; border-color:var(--ok);}
.btn.danger {background:var(--danger); color:#fff; border-color:var(--danger);}
.wrap {max-width:960px; margin:0 auto; padding:14px 16px;}

.chip {
  border:1px solid #ccc;
  border-radius:999px;
  padding:6px 12px;       /* âœ… ë‚´ë¶€ ì—¬ë°± ì‚´ì§ ì¦ê°€ */
  font-size:16px;         /* âœ… ê¸€ì”¨ ì•½ê°„ í™•ëŒ€ */
  background:#fff;
  color:#111;
  cursor:pointer;
  font-weight:600;
}
.chip.selected {
  border:1px solid var(--accent) !important;
  background:#efef07 !important;
}
@media (max-width:640px){
  .chip {
    font-size:16px !important;       /* âœ… ëª¨ë°”ì¼ì—ì„œë„ ì„ ëª…í•˜ê²Œ */
    padding:2px 10px !important;
  }
}

#logs {
  margin-top:20px;
  background:#fff;
  border-radius:12px;
  box-shadow:var(--shadow);
  padding:12px;
}
.log-item {
  border-bottom:1px solid #e5e7eb; padding:10px 4px; position:relative;
}
.log-item:last-child {border-bottom:none;}
.log-time {
  font-size:15px;  /* âœ… ì¼ì‹œ í¬ê¸° í™•ëŒ€ */
  color:#334155;
  display:block;
  margin-bottom:4px;
  font-weight:700; /* âœ… ê¸€ì”¨ ë‘ê»ê²Œ */
}
.log-match {font-size:16px; font-weight:600;}
.log-win {color:#2563eb; font-weight:700;}
.delete-btn {
  position:absolute; right:8px; top:6px; font-size:16px; border:none;
  background:transparent; color:#9ca3af; cursor:pointer; transition:.2s;
}
.delete-btn:hover {color:#ef4444; transform:scale(1.1);}
.toast {
  position:fixed; bottom:18px; left:50%; transform:translateX(-50%);
  background:#111827; color:#fff; padding:9px 14px; border-radius:10px;
  opacity:0; transition:.25s;
  font-size:15px; font-weight:600;
}
.toast.show {opacity:1;}
@media (max-width:640px){
  .chip{font-size:16px; padding:2px 6px;}
  .btn{font-size:13px; padding:5px 8px;}
  .log-match{font-size:15px;}
  .log-time{font-size:14px;}
}

#teamDisplay {
  margin-top: 24px;           /* ìœ„ìª½ ì—¬ë°± ë„‰ë„‰í•˜ê²Œ */
  margin-bottom: 16px;        /* ì•„ë˜ìª½ ì—¬ë°± ì¶”ê°€ */
  text-align: center;         /* ì¤‘ì•™ ì •ë ¬ */
  font-size: 18px;            /* ê¸€ì”¨ ì‚´ì§ í‚¤ì›€ */
  font-weight: 600;
  line-height: 1.6;           /* ì¤„ ê°„ê²© í™•ë³´ */
}

#matchButtons {
  display: none;
  text-align: center;         /* ì¤‘ì•™ ì •ë ¬ */
  margin-top: 12px;
  margin-bottom: 22px;        /* í•˜ë‹¨ ì—¬ë°± ì¶”ê°€ */
}

#matchButtons .btn {
  margin: 0 8px;              /* ë²„íŠ¼ ê°„ê²© */
  padding: 8px 16px;          /* ë²„íŠ¼ í¬ê¸° ì—¬ìœ ë¡­ê²Œ */
  font-size: 16px;            /* ë²„íŠ¼ ê¸€ì í‚¤ì›€ */
}

/* âœ… ì‚¬ìš©ë²• ëª¨ë‹¬ì°½ */
.modal {
  display: none;
  position: fixed;
  z-index: 100;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  justify-content: center;
  align-items: center;
}
.modal-content {
  background: #fff;
  border-radius: 14px;
  padding: 20px;
  max-width: 340px;
  width: 80%;
  text-align: left;
  box-shadow: 0 8px 28px rgba(0,0,0,0.2);
  max-height: 80vh;      /* í™”ë©´ ë†’ì´ì˜ 80%ê¹Œì§€ë§Œ ì‚¬ìš© */
  overflow-y: auto;      /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ */
}
.modal-content h2 {
  font-size: 18px;
  color: #1e3a8a;
  margin-bottom: 10px;
  text-align:center;
}
.modal-content ul {
  list-style:none;
  padding-left:0;
  margin:0;
  color:#1f2937;
  font-size:15px;
  line-height:1.6;
}
.modal-content li::before { content:"â€¢ "; color:#2563eb; }
@media (max-width:640px){
  .modal-content{font-size:14px;padding:16px;}
}


</style>
</head>
<body>
<header>
  <div class="header-inner">
    <h1 id="pageTitle">ğŸ“ ê²½ê¸°ê²°ê³¼ ì…ë ¥</h1>
    <div class="row">
     <button id="adminBtn" class="btn">âš™ ê´€ë¦¬ìëª¨ë“œ</button>
      <a href="monthly-report.html" class="btn primary">í†µí•© ì „ì </a>
      <a href="monthly-report2.html" class="btn primary">ë‹¨/ë³µì‹ ì „ì </a>
     <button id="todayBtn" class="btn primary">ì˜¤ëŠ˜ì˜ ì „ì </button>
     <button id="helpBtn" class="btn">â„¹ ì‚¬ìš©ë²•</button>
   
     <!-- âœ… ì˜¤ëŠ˜ì˜ ì „ì  íŒì—… -->
<div id="todayResults"
     style="display:none; 
            position:fixed; top:50%; left:50%; 
            transform:translate(-50%,-50%);
            width:90%; max-width:420px; 
            background:#fff; 
            border-radius:16px; 
            box-shadow:0 8px 28px rgba(0,0,0,0.2);
            padding:20px 20px 24px;
            z-index:200;">
  
  <button id="closeToday"
          style="position:absolute; top:10px; right:12px;
                 background:transparent; border:none; 
                 font-size:22px; color:#9ca3af; 
                 cursor:pointer; transition:.2s;">âœ–</button>

  <h3 style="text-align:center; color:#2563eb; margin-top:0; margin-bottom:12px;">ğŸ“Š ì˜¤ëŠ˜ì˜ ì „ì </h3>
  <div id="todayList" 
       style="font-size:16px; line-height:1.8; font-weight:600; text-align:center; color:#111;">
  </div>
</div>

</header>

<main class="wrap">
  <div id="chips" class="row" style="margin-top:10px;"></div>
  <div id="teamDisplay"></div>

  <div id="matchButtons">
    <button id="winA" class="btn ok">AíŒ€ ìŠ¹</button>
    <button id="winB" class="btn danger">BíŒ€ ìŠ¹</button>
  </div>

  <div id="logs"></div>
</main>

<div id="toast" class="toast">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</div>

<div id="helpModal" class="modal">
  <div class="modal-content">
    <h2>ğŸ“˜ ê²½ê¸°ê²°ê³¼ ì…ë ¥ ì‚¬ìš©ë²•</h2>
    <ul>
      <li>1ï¸âƒ£ ì¹©ì„ ëˆŒëŸ¬ ì„ ìˆ˜ 2ëª…(ë‹¨ì‹) ë˜ëŠ” 4ëª…(ë³µì‹)ì„ ì„ íƒí•©ë‹ˆë‹¤.</li>

<li>2ï¸âƒ£ AíŒ€/BíŒ€ ìë™ ë°°ì •ì´ ìƒì„±ë˜ë©°, <b>AíŒ€ ìŠ¹</b> ë˜ëŠ” <b>BíŒ€ ìŠ¹</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ ê²°ê³¼ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.</li>

<li>3ï¸âƒ£ ìµœê·¼ ê²½ê¸°ê²°ê³¼ëŠ” í™”ë©´ í•˜ë‹¨ì—ì„œ í™•ì¸Â·ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>

<li>4ï¸âƒ£ <b>í†µí•© ì „ì </b> : ì›”ë³„ ê²½ê¸°ìˆ˜, ìŠ¹/íŒ¨, ìŠ¹ë¥ ì„ ë‹¨ì‹+ë³µì‹ ê¸°ì¤€ìœ¼ë¡œ í•œëˆˆì— ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>

<li>5ï¸âƒ£ <b>ë‹¨/ë³µì‹ ì „ì </b> : ëª¨ë“  ì„ ìˆ˜ ëª©ë¡ì´ í‘œì‹œë˜ë©°, ê° ì„ ìˆ˜ì˜ ë‹¨ì‹/ë³µì‹ ì „ì ì„ ë”°ë¡œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>

<li>6ï¸âƒ£ <b>ê°œì¸ ìƒì„¸ í˜ì´ì§€(ì„ ìˆ˜ í´ë¦­)</b> :  
   â–¸ ì›”ë³„ ì„±ì (í†µí•©/ë‹¨ì‹/ë³µì‹),  
   â–¸ ë‹¨ì‹ ìƒëŒ€ë³„ ì „ì  TOP 8,  
   â–¸ ë³µì‹ íŒŒíŠ¸ë„ˆë³„ ì „ì  TOP 8,  
   â–¸ ìŠ¹ë¥  ê·¸ë˜í”„, ê²½ê¸°ìˆ˜ ê·¸ë˜í”„, ë‹¨/ë³µì‹ ë¹„ì¤‘, ëˆ„ì  ìŠ¹ì  ê·¸ë˜í”„ ë“±ì´ í‘œì‹œë©ë‹ˆë‹¤.</li>

<li>7ï¸âƒ£ <b>ìƒì„¸ í˜ì´ì§€ ìƒë‹¨ ë²„íŠ¼</b> :  
   â–¸ <b>ê²½ê¸°ê²°ê³¼ ì…ë ¥</b>  
   â–¸ <b>í†µí•©ì „ì </b>  
   â–¸ <b>ë‹¨/ë³µì‹ ì „ì </b>  
   ë¡œ ì´ë™í•  ìˆ˜ ìˆëŠ” ë¹ ë¥¸ ë©”ë‰´ê°€ ì œê³µë©ë‹ˆë‹¤.</li>

<li>8ï¸âƒ£ <b>ìƒëŒ€/íŒŒíŠ¸ë„ˆ ë¶„ì„</b> :  
   ê°€ì¥ ë§ì´ ì´ê¸´ ìƒëŒ€, ê°€ì¥ ë§ì´ ì§„ ìƒëŒ€, ê°€ì¥ ì˜ ë§ëŠ”/ì•ˆ ë§ëŠ” íŒŒíŠ¸ë„ˆê°€ ìë™ ê³„ì‚°ë˜ë©°,  
   ì´ë¦„ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ì„ ìˆ˜ì˜ ìƒì„¸ í˜ì´ì§€ë¡œ ë°”ë¡œ ì´ë™í•©ë‹ˆë‹¤.</li>

<li>9ï¸âƒ£ <b>ê·¸ë˜í”„</b> :  
   ì›”ë³„ ìŠ¹ë¥ , ê²½ê¸°ìˆ˜, ë‹¨/ë³µì‹ ë¹„ìœ¨, ìƒëŒ€ë³„ ìŠ¹ë¥ , íŒŒíŠ¸ë„ˆë³„ ìŠ¹ë¥ , ë³µì‹ ëˆ„ì  ìŠ¹ì ì´ ì‹œê°í™”ë©ë‹ˆë‹¤.</li>

<li>ğŸ”Ÿ <b>ì›”ë³„ í†µí•© ê¸°ë¡</b> :  
   â–¸ â€™25ë…„ 9~10ì›” â†’ í†µí•©ì „ì ë§Œ í‘œì‹œ  
   â–¸ â€™25ë…„ 11ì›” ì´í›„ â†’ ë‹¨ì‹/ë³µì‹ ì „ì ì„ ê°œë³„ í‘œì‹œ  
   ë””ìì¸ ê°œì„ ëœ ì¹´ë“œë¡œ ê²½ê¸°ìˆ˜Â·ìŠ¹íŒ¨Â·ìŠ¹ë¥ ì„ ë³´ê¸° ì¢‹ê²Œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>

    </ul>
    <button id="closeModal" class="btn ok" style="margin-top:10px;">ë‹«ê¸°</button>
  </div>
</div>







<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue, push, remove, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const $ = s => document.querySelector(s);
const toast = (msg="ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤")=>{
  const t=$("#toast"); t.textContent=msg; t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1500);
};

// ===== ì œëª© ìºì‹œ + ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ =====
const titleRef = ref(db, 'config/title');
const cachedTitle = localStorage.getItem('siteTitle');
if (cachedTitle) {
  document.title = `ğŸ“ ${cachedTitle} íƒêµ¬ê²½ê¸° ê²°ê³¼ì…ë ¥`;
  $('#pageTitle').textContent = `ğŸ“ ${cachedTitle} íƒêµ¬ê²½ê¸° ê²°ê³¼ì…ë ¥`;
}
onValue(titleRef, snap => {
  const val = snap.val() ?? 'PingPong Club';
  localStorage.setItem('siteTitle', val);
  document.title = `ğŸ“ ${val} íƒêµ¬ê²½ê¸° ê²°ê³¼ì…ë ¥`;
  $('#pageTitle').textContent = `ğŸ“ ${val} íƒêµ¬ê²½ê¸° ê²°ê³¼ì…ë ¥`;
});

// ===== ë°ì´í„° ì°¸ì¡° =====
const matchRef = ref(db,'matches');
const playerRef = ref(db,'players');
const deletePwRef = ref(db,'config/deletePassword');
let players=[], sel=[], deletePassword='7910';

// âœ… ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ ë¶ˆëŸ¬ì˜¤ê¸°
get(deletePwRef).then(s=>{
  if(s.exists()) deletePassword = s.val();
});

// âœ… ë¶€ìˆ˜ë³„ ìƒ‰ìƒ
const LEVEL_COLORS = {
  1: '#ef4444',  // ë¹¨ê°•
  2: '#f97316',  // ì£¼í™©
  3: '#f59e0b',  // ë…¸ë‘
  4: '#84cc16',  // ì—°ë‘
  5: '#10b981',  // ì´ˆë¡
  6: '#06b6d4',  // í•˜ëŠ˜
  7: '#8b5cf6',  // ë³´ë¼
  8: '#22c55e',  // ì²­ë¡
  9: '#3b82f6',  // íŒŒë‘
  10: '#d946ef', // ì—°ë³´ë¼
  11: '#ec4899', // ë¶„í™
  12: '#f43f5e', // ì§„ë¶„í™
  13: '#a855f7', // ë³´ë¼í•‘í¬
  14: '#6366f1',  // ë‚¨ìƒ‰
};
// ê¸°ì¡´
// const shuffledColors = Object.values(LEVEL_COLORS).sort(()=>Math.random()-0.5);

// ìˆ˜ì •: ìˆœì„œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
const colorList = Object.values(LEVEL_COLORS);

// âœ… ì„ ìˆ˜ ëª©ë¡ í‘œì‹œ
onValue(playerRef,snap=>{
  const data=snap.val()||{};
  players=Object.values(data)
    .map(p=>({name:p.name,level:p.level}))
    .sort((a,b)=>(a.level-b.level)||a.name.localeCompare(b.name,'ko'));
  renderChips();
});

// âœ… ì¹© ë Œë”ë§
function renderChips(){
  const box = $("#chips");
  box.innerHTML = "";
  players.forEach(p=>{
    const btn = document.createElement('button');
    btn.className = 'chip';
    const c = colorList[p.level % colorList.length];  // ê³ ì • ìƒ‰ìƒ
    btn.style.borderColor = c;
    btn.style.background = c + '22';
    btn.textContent = `${p.name}(${p.level})`;
    if(sel.some(x=>x.name===p.name)){
      btn.classList.add('selected');
      btn.style.background='#fff';
      btn.style.outline=`2px solid ${c}`;
    }
    btn.onclick=()=>{
      const idx=sel.findIndex(x=>x.name===p.name);
      if(idx>=0) sel.splice(idx,1);
      else {
        if(sel.length>=4){toast("ìµœëŒ€ 4ëª…ê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤");return;}
        sel.push(p);
      }
      renderChips(); updateTeams();
    };
    box.appendChild(btn);
  });
}

// âœ… íŒ€ ì—…ë°ì´íŠ¸
function updateTeams(){
  const disp=$("#teamDisplay");
  const btns=$("#matchButtons");
  if(sel.length>0){
    const half=Math.floor(sel.length/2);
    const a=sel.slice(0,half).map(p=>p.name).join('/');
    const b=sel.slice(half).map(p=>p.name).join('/');
    disp.innerHTML=`<b>AíŒ€:</b> ${a||'-'}ã€€|ã€€<b>BíŒ€:</b> ${b||'-'}`;
  } else disp.innerHTML='';
  btns.style.display = (sel.length===2 || sel.length===4) ? 'block' : 'none';
}

// âœ… ê²½ê¸° ì €ì¥
function getMonthKey(ts=Date.now()){
  const d=new Date(new Date(ts).toLocaleString('en-US',{timeZone:'Asia/Seoul'}));
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
}
$("#winA").onclick=()=>saveMatch('A');
$("#winB").onclick=()=>saveMatch('B');

function saveMatch(winner){
  if(!(sel.length===2 || sel.length===4)){toast("2ëª… ë˜ëŠ” 4ëª…ì„ ì„ íƒí•˜ì„¸ìš”");return;}
  const mode=(sel.length===2)?'single':'double';
  const a=sel.slice(0,sel.length/2).map(p=>p.name);
  const b=sel.slice(sel.length/2).map(p=>p.name);
  const obj={mode,monthKey:getMonthKey(),namesA:a,namesB:b,winnerSide:winner,createdAt:Date.now()};
  push(matchRef,obj);
  toast("ê²½ê¸°ê²°ê³¼ ì €ì¥ ì™„ë£Œ");
  sel=[];renderChips();updateTeams();
}

// âœ… ê²½ê¸° ë¡œê·¸ í‘œì‹œ
onValue(matchRef,snap=>{
  const data=snap.val()||{};
  const arr=Object.entries(data).map(([id,m])=>({...m,id}))
    .sort((a,b)=>b.createdAt-a.createdAt);
  renderLogs(arr);
});

function renderLogs(arr){
  const logs = $("#logs"); 
  logs.innerHTML = "";

  if (!arr.length) {
    logs.innerHTML = '<div style="text-align:center;color:#999">ìµœê·¼ ê²½ê¸° ì—†ìŒ</div>';
    return;
  }

  arr.forEach(m => {
    const d = new Date(m.createdAt);
    const kst = new Date(d.toLocaleString('en-US', { timeZone:'Asia/Seoul' }));
    const time =
      `${kst.getFullYear()}-${String(kst.getMonth()+1).padStart(2,'0')}-${String(kst.getDate()).padStart(2,'0')} ` +
      `${String(kst.getHours()).padStart(2,'0')}:${String(kst.getMinutes()).padStart(2,'0')}`;

    const winA = m.winnerSide === 'A';
    const a = m.namesA.join('/');
    const b = m.namesB.join('/');

    // âœ… ìŠ¹ì ë’¤ì—ë§Œ (ìŠ¹) / (ìŠ¹)ì€ ë¹¨ê°„ìƒ‰ + bold
    const aHtml = winA
      ? `<span class="log-win">${a} <span style="color:#ef4444;font-weight:700;">(ìŠ¹)</span></span>`
      : `<span>${a}</span>`;

    const bHtml = !winA
      ? `<span class="log-win">${b} <span style="color:#ef4444;font-weight:700;">(ìŠ¹)</span></span>`
      : `<span>${b}</span>`;

    logs.insertAdjacentHTML("beforeend", `
      <div class="log-item">
        <span class="log-time">${time} [${m.mode==='double' ? 'ë³µì‹' : 'ë‹¨ì‹'}]</span>
        <div class="log-match">
          ${aHtml}  vs  ${bHtml}
        </div>
        <button class="delete-btn" onclick="deleteMatch('${m.id}')">ğŸ—‘ï¸</button>
      </div>
    `);
  });
}


// âœ… ê²½ê¸° ì‚­ì œ
window.deleteMatch = async (id) => {
  const input = prompt("ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
  if (input !== deletePassword) return toast("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤");
  if (!confirm("ì •ë§ ì´ ê²½ê¸°ê²°ê³¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  await remove(ref(db, 'matches/' + id));
  toast("ê²½ê¸°ê²°ê³¼ ì‚­ì œ ì™„ë£Œ");
};

// âœ… ëª¨ë°”ì¼/PC ëª¨ë‘ ì‘ë™í•˜ëŠ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ í™•ì¸
window.addEventListener("DOMContentLoaded", () => {
  const adminBtn = document.getElementById("adminBtn");
  if (!adminBtn) return;

  adminBtn.addEventListener("click", async () => {
    try {
      const adminPwRef = ref(db, "config/adminPassword");
      const snap = await get(adminPwRef);
      const savedPw = snap.exists() ? snap.val() : "1234";

      const input = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      if (input === null) return; // ì·¨ì†Œ ì‹œ ì¢…ë£Œ
      if (input !== savedPw) {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      // âœ… ì„±ê³µ ì‹œ ê°•ì œ ì´ë™
      window.location.href = "admin.html";
    } catch (err) {
      console.error("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì˜¤ë¥˜:", err);
      alert("ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  });
});

// âœ… ì‚¬ìš©ë²• ë²„íŠ¼ í´ë¦­ â†’ ëª¨ë‹¬ í‘œì‹œ
const helpBtn = document.getElementById("helpBtn");
const modal = document.getElementById("helpModal");
const closeModal = document.getElementById("closeModal");

helpBtn.addEventListener("click", () => {
  modal.style.display = "flex";
});

closeModal.addEventListener("click", () => {
  modal.style.display = "none";
});

// âœ… ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
window.addEventListener("click", (e) => {
  if (e.target === modal) modal.style.display = "none";
});


// âœ… ì˜¤ëŠ˜ì˜ ì „ì : í† ê¸€ + ë Œë” í•˜ë‚˜ë¡œ í†µí•©
let todayVisible = false;

async function buildTodayHtml() {
  const snap = await get(matchRef);
  if (!snap.exists()) return null;

  const data = Object.values(snap.val());
  const today = new Date().toLocaleDateString("ko-KR", { timeZone: "Asia/Seoul" });

  // ì˜¤ëŠ˜ ê²½ê¸°ë§Œ í•„í„°
  const todayMatches = data.filter(m => {
    const d = new Date(m.createdAt);
    const kst = new Date(d.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
    return kst.toLocaleDateString("ko-KR") === today;
  });

  if (!todayMatches.length) return "ì˜¤ëŠ˜ ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤";

  // ìŠ¹/íŒ¨ ì§‘ê³„
  const stats = {};
  todayMatches.forEach(m => {
    const winners = m.winnerSide === "A" ? m.namesA : m.namesB;
    const losers  = m.winnerSide === "A" ? m.namesB : m.namesA;
    winners.forEach(n => { if (!stats[n]) stats[n] = { win:0, lose:0 }; stats[n].win++; });
    losers.forEach(n  => { if (!stats[n]) stats[n] = { win:0, lose:0 }; stats[n].lose++; });
  });

  // âœ… ìŠ¹ì  ê³„ì‚° + ì •ë ¬ (ìŠ¹ì  â†’ ë¶€ìˆ˜ ë‚®ì€ ìˆœ â†’ ì´ë¦„ìˆœ)
const sorted = Object.entries(stats)
  .map(([name, { win, lose }]) => {
    const p = players.find(v => v.name === name);
    const level = p ? p.level : 99;
    const score = win * 2 - lose * 1;   // âœ… ìŠ¹ì  ê³„ì‚°

    return { name, win, lose, level, score };
  })
  .sort((a, b) =>
    b.score - a.score ||      // âœ… ìŠ¹ì  ë†’ì€ ìˆœ
    a.level - b.level ||      // âœ… ë¶€ìˆ˜ ë‚®ì€ ìˆœ (ìˆ«ì ì‘ì„ìˆ˜ë¡ ê³ ìˆ˜)
    a.name.localeCompare(b.name, 'ko')
  );

  // âœ… ë‘ ì¤„(2ì—´) ë ˆì´ì•„ì›ƒ + ìŠ¹/íŒ¨ í•œ ì¤„ í‘œê¸° + ìŠ¹ì´ ê°€ì¥ ë§ì€ ì‚¬ëŒ ì§„í•˜ê²Œ
  const maxWin = Math.max(...sorted.map(p => p.win)); // ê°€ì¥ ë§ì€ ìŠ¹ë¦¬ ìˆ˜

  let html = "";
  sorted.forEach((p, i) => {
    const isTop = p.win === maxWin; // ìµœê³  ìŠ¹ë¦¬ì ì—¬ë¶€
    const color = p.win > p.lose ? "#1e40af" : "#111";
    const text = `${p.name}(${p.level}) ${p.win}ìŠ¹${p.lose}íŒ¨`;
    html += `<span style="color:${color}; display:inline-block; width:48%; text-align:center; margin:6px 0;">
               ${isTop ? `<b>${text}</b>` : text}
             </span>`;
    if ((i + 1) % 2 === 0) html += "<br>";
  });

  return html;

}

// âœ… ë²„íŠ¼ í•œ ê°œë§Œ ì—°ê²° (í† ê¸€)
document.getElementById("todayBtn").addEventListener("click", async () => {
  const box = document.getElementById("todayResults");
  const list = document.getElementById("todayList");

  // í† ê¸€ ë‹«ê¸°
  if (todayVisible) {
    box.style.display = "none";
    todayVisible = false;
    return;
  }

  const html = await buildTodayHtml();
  if (html === null) { toast("ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤"); return; }
  if (html === "ì˜¤ëŠ˜ ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤") { toast(html); box.style.display = "none"; todayVisible = false; return; }

  list.innerHTML = html;
  box.style.display = "block";
  todayVisible = true;
});

// âœ… ë‹«ê¸° ë²„íŠ¼
document.getElementById("closeToday").addEventListener("click", () => {
  document.getElementById("todayResults").style.display = "none";
  todayVisible = false;
});


</script>
</body>
</html>