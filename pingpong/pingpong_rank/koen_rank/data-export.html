<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“¤ KOEN íƒêµ¬ í´ëŸ½ ë°ì´í„° ì¶”ì¶œ (GPTs í…ìŠ¤íŠ¸ìš©)</title>
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
<style>
:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb; --card:#fff;
  --accent:#2563eb; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
  --shadow:0 8px 28px rgba(2,6,23,.08);
}
*{box-sizing:border-box}
body{margin:0; font-family:"Pretendard","Noto Sans KR",system-ui,sans-serif; background:var(--bg); color:var(--ink); font-weight:600}
.wrap{max-width:1000px; margin:0 auto; padding:16px}
header{position:sticky; top:0; background:#fff; border-bottom:1px solid #e5e7eb; z-index:10}
.head-in{max-width:1000px; margin:0 auto; padding:12px 16px; display:flex; gap:10px; align-items:center; justify-content:space-between}
h1{margin:0; font-size:20px; color:#1e40af; font-weight:900}
.card{background:var(--card); border:1px solid #e5e7eb; border-radius:16px; box-shadow:var(--shadow); padding:16px; margin-top:12px}
.row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.btn{border:1px solid #d1d5db; padding:8px 12px; border-radius:10px; background:#fff; cursor:pointer; font-weight:800}
.btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
.small{font-size:13px; color:#475569}
textarea{width:100%; min-height:380px; resize:vertical; padding:12px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:13.5px; border:1px solid #e5e7eb; border-radius:12px; background:#fff;}
.badge{padding:4px 8px;border-radius:999px;background:#e2efff;color:#1e40af;font-size:12px;font-weight:900}
.kv{display:grid; gap:8px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
input[type="number"],select{padding:8px 10px; border:1px solid #d1d5db; border-radius:10px; background:#fff; font-weight:800}
.hr{height:1px; background:#eef2f7; margin:12px 0}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.dim{color:#64748b}
</style>
</head>
<body>
<header>
  <div class="head-in">
    <h1>ğŸ“¤ KOEN ë°ì´í„° ì¶”ì¶œ (GPTs í…ìŠ¤íŠ¸)</h1>
    <div class="row">
      <span class="badge" id="stateBadge">ëŒ€ê¸°</span>
      <button class="btn" id="btnReload">ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div class="row">
      <div class="small">Â· 2025-09, 2025-10ì€ <b>ì›”ê°„ í†µí•©ì „ì </b> ë°˜ì˜ Â· 2025-11 ì´í›„ëŠ” <b>ë‹¨ì‹/ë³µì‹ ë¶„ë¦¬ + ìƒì„¸(ìƒëŒ€/íŒŒíŠ¸ë„ˆ)</b></div>
      <div class="small">Â· ì•„ë˜ ì˜µì…˜ìœ¼ë¡œ ê°€ë…ì„± ì¡°ì ˆ í›„ â€œì „ì²´ í…ìŠ¤íŠ¸ ë³µì‚¬â€ â†’ GPTsì— ë¶™ì—¬ë„£ê¸°</div>
    </div>
    <div class="kv" style="margin-top:8px">
      <label class="row">ë‹¨ì‹ ìƒëŒ€ Top N
        <input type="number" id="topOppN" min="1" max="20" value="8" style="width:90px">
      </label>
      <label class="row">ë³µì‹ íŒŒíŠ¸ë„ˆ Top N
        <input type="number" id="topPtnN" min="1" max="20" value="8" style="width:90px">
      </label>
      <label class="row">ë¹ˆ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        <select id="hideEmpty">
          <option value="yes" selected>ì˜ˆ (ê¶Œì¥)</option>
          <option value="no">ì•„ë‹ˆì˜¤</option>
        </select>
      </label>
      <label class="row">ì„ ìˆ˜ ì •ë ¬
        <select id="sortBy">
          <option value="name" selected>ì´ë¦„(ê°€ë‚˜ë‹¤)</option>
          <option value="allRate">ì „ì²´ ìŠ¹ë¥ â†“</option>
          <option value="games">ì „ì²´ ê²½ê¸°ìˆ˜â†“</option>
        </select>
      </label>
    </div>
    <div class="hr"></div>
    <div class="row">
      <button class="btn primary" id="btnBuild">ë°ì´í„° ìƒì„±</button>
      <button class="btn" id="btnCopy">ì „ì²´ í…ìŠ¤íŠ¸ ë³µì‚¬</button>
      <span class="small dim">ìƒì„± ì‹œê°„: <span id="builtAt">-</span></span>
    </div>
  </section>

  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div class="small"><b>ì¶œë ¥ ë¯¸ë¦¬ë³´ê¸°</b> (GPTsì— ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤)</div>
      <div class="small mono" id="summaryLine">-</div>
    </div>
    <textarea id="outBox" placeholder="ì—¬ê¸°ì— ê²°ê³¼ê°€ ìƒì„±ë©ë‹ˆë‹¤â€¦"></textarea>
  </section>
</main>

<script type="module">
/* ========== Firebase ========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain:"pingpongclub-4a5fd.firebaseapp.com",
  databaseURL:"https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId:"pingpongclub-4a5fd",
  storageBucket:"pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId:"802826774007",
  appId:"1:802826774007:web:ca4d05be778eeaf1723af2"
};
initializeApp(firebaseConfig);
const db = getDatabase();

/* ========== Helpers ========== */
const $ = s => document.querySelector(s);
const shortMonth = (m) => `'${m.slice(2)}`; // YYYY-MM â†’ 'YY-MM
const fmt1 = n => (Math.round(n*10)/10).toFixed(1);
const pct = (w,t) => t? Math.round(w/t*100) : 0;
const yyyymm = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
const KST = (ts)=> new Date(new Date(ts ?? Date.now()).toLocaleString("en-US",{timeZone:"Asia/Seoul"}));
const cmpMonth = (a,b) => a.localeCompare(b);

const NOV_2025 = '2025-11';
const POINT_WIN = 2, POINT_LOSE = -1;

/* ========== Global Data ========== */
let PLAYERS = [];            // [{name, level}]
let MR_09 = {}, MR_10 = {};  // ì›”ê°„ í†µí•©ì „ì : { name: {win,lose,total,rate} }
let MATCHES = [];            // ì „ì²´ matches ë°°ì—´

/* ========== Loaders ========== */
async function loadPlayers(){
  const s = await get(ref(db,'players'));
  if (!s.exists()) return [];
  const arr = Object.values(s.val());
  return arr.map(p => ({ name: p.name, level: p.level ?? '-' }))
            .filter(p => p.name);
}

async function loadMonthly(m){
  const s = await get(ref(db,`monthlyReports/${m}/players`));
  if (!s.exists()) return {};
  const map = {};
  Object.values(s.val()).forEach(r=>{
    if (!r.name) return;
    const win = Number(r.wins ?? r.win ?? 0);
    const lose= Number(r.losses ?? r.lose ?? 0);
    const total = win + lose;
    map[r.name] = { win, lose, total, rate: pct(win,total) };
  });
  return map;
}

async function loadMatches(){
  const s = await get(ref(db,'matches'));
  if (!s.exists()) return [];
  return Object.values(s.val());
}

/* ========== Aggregation per Player ========== */
function buildPerPlayerText(options){
  const topOppN = Number(options.topOppN ?? 8);
  const topPtnN = Number(options.topPtnN ?? 8);
  const hideEmpty = options.hideEmpty !== 'no';

  // ì„ ìˆ˜ ëª©ë¡(ì´ë¦„ â†’ ë ˆë²¨)
  const levelByName = Object.fromEntries(PLAYERS.map(p=>[p.name,p.level]));

  // ì„ ìˆ˜ë³„ ì»¨í…Œì´ë„ˆ
  const byPlayer = {};
  PLAYERS.forEach(p=>{
    byPlayer[p.name] = {
      level: levelByName[p.name] ?? '-',
      // 9~10ì›” í†µí•©
      m910: {
        win: (MR_09[p.name]?.win ?? 0) + (MR_10[p.name]?.win ?? 0),
        lose:(MR_09[p.name]?.lose?? 0) + (MR_10[p.name]?.lose?? 0),
      },
      // 11ì›”~ ë‹¨/ë³µì‹
      sgl:{win:0,lose:0}, dbl:{win:0,lose:0,points:0},
      // ìƒì„¸
      oppSingles:{},     // {opp:{win,lose}}
      ptnDoubles:{},     // {ptn:{win,lose,points}}
      // ì›”ë³„ í†µí•©(ë¬¸ì ë³´ê³ ìš©)
      monthAll:{}        // {'YYYY-MM':{total,win,lose,rate}}
    };
  });

  // 9~10ì›” ì›”ë³„ í†µí•© ì €ì¥(ë³´ê¸°ìš©)
  ['2025-09','2025-10'].forEach(m=>{
    const MR = (m==='2025-09') ? MR_09 : MR_10;
    Object.entries(MR).forEach(([name, row])=>{
      if(!byPlayer[name]) return;
      byPlayer[name].monthAll[m] = { total: row.total, win: row.win, lose: row.lose, rate: row.rate };
    });
  });

  // 11ì›”~ matches ìŠ¤ìº”
  MATCHES.forEach(m=>{
    const mk = m.monthKey || yyyymm(KST(m.createdAt));
    if (cmpMonth(mk, NOV_2025) < 0) return;

    const A = m.namesA || [], B = m.namesB || [];
    const winA = (m.winnerSide === 'A');
    const mode = m.mode || 'single';

    // ê²½ê¸°ì— ë‚˜ì˜¨ ëª¨ë“  ì„ ìˆ˜ ì´ë¦„
    const participants = [...A, ...B];
    participants.forEach(name=>{
      if(!byPlayer[name]) return; // players ë¦¬ìŠ¤íŠ¸ì— ì—†ìœ¼ë©´ ìŠ¤í‚µ(ì•ˆì „)
      const iAmA = A.includes(name);
      const iWon = (winA && iAmA) || (!winA && !iAmA);

      // ì›”ë³„ í†µí•©(ë³´ê¸°ìš©)
      byPlayer[name].monthAll[mk] ??= { total:0, win:0, lose:0, rate:0 };
      byPlayer[name].monthAll[mk].total++;
      if (iWon) byPlayer[name].monthAll[mk].win++; else byPlayer[name].monthAll[mk].lose++;

      // ë‹¨/ë³µì‹ ë¶„ê¸°
      if (mode === 'single'){
        if (iWon) byPlayer[name].sgl.win++; else byPlayer[name].sgl.lose++;
        // ìƒëŒ€ ê¸°ë¡
        const opp = iAmA ? (B[0]||'') : (A[0]||'');
        if (opp){
          byPlayer[name].oppSingles[opp] ??= {win:0,lose:0};
          if (iWon) byPlayer[name].oppSingles[opp].win++; else byPlayer[name].oppSingles[opp].lose++;
        }
      } else {
        if (iWon) byPlayer[name].dbl.win++; else byPlayer[name].dbl.lose++;
        byPlayer[name].dbl.points += iWon ? POINT_WIN : POINT_LOSE;
        // íŒŒíŠ¸ë„ˆ ê¸°ë¡
        const team = iAmA ? A : B;
        const partner = team.find(n=>n!==name);
        if (partner){
          byPlayer[name].ptnDoubles[partner] ??= {win:0,lose:0,points:0};
          if (iWon){ byPlayer[name].ptnDoubles[partner].win++; byPlayer[name].ptnDoubles[partner].points+=POINT_WIN; }
          else     { byPlayer[name].ptnDoubles[partner].lose++;byPlayer[name].ptnDoubles[partner].points+=POINT_LOSE; }
        }
      }
    });
  });

  // ì›”ë³„ ìŠ¹ë¥  ê³„ì‚°
  Object.values(byPlayer).forEach(p=>{
    Object.values(p.monthAll).forEach(o=>{
      o.rate = pct(o.win, o.total);
    });
  });

  // ì„ ìˆ˜ ì •ë ¬ í‚¤ ìƒì„±
  const playerStatsForSort = Object.entries(byPlayer).map(([name,p])=>{
    const mAll = p.monthAll;
    // ì „ì²´ í•©ê³„(9~10 + 11~ì›”ë³„ í•©)
    let allWin = p.m910.win, allLose = p.m910.lose, allTot = allWin + allLose;
    Object.values(mAll).forEach(o=>{ allWin+=o.win; allLose+=o.lose; allTot+=o.total; });
    const allRate = pct(allWin, allTot);
    return { name, level:p.level, games:allTot, allRate };
  });

  // ì •ë ¬
  const sortBy = $('#sortBy').value;
  if (sortBy === 'name'){
    playerStatsForSort.sort((a,b)=> a.name.localeCompare(b.name,'ko'));
  } else if (sortBy === 'allRate'){
    playerStatsForSort.sort((a,b)=> b.allRate - a.allRate || b.games - a.games || a.name.localeCompare(b.name,'ko'));
  } else if (sortBy === 'games'){
    playerStatsForSort.sort((a,b)=> b.games - a.games || b.allRate - a.allRate || a.name.localeCompare(b.name,'ko'));
  }

  // í…ìŠ¤íŠ¸ ë¹Œë“œ
  const chunks = [];
  playerStatsForSort.forEach(({name})=>{
    const p = byPlayer[name];

    // ì „ì²´ í•©ê³„
    let allWin = p.m910.win, allLose = p.m910.lose, allTot = allWin + allLose;
    Object.values(p.monthAll).forEach(o=>{ allWin+=o.win; allLose+=o.lose; allTot+=o.total; });
    const allRate = fmt1(pct(allWin, allTot));

    // ë‹¨ì‹/ë³µì‹ í•©ê³„(11ì›”~)
    const sglTot = p.sgl.win + p.sgl.lose;
    const dblTot = p.dbl.win + p.dbl.lose;
    const sglRate = fmt1(pct(p.sgl.win, sglTot));
    const dblRate = fmt1(pct(p.dbl.win, dblTot));
    const dblPts = p.dbl.points;

    // ì›”ë³„ ìš”ì•½ ë¼ì¸
    const months = Object.keys(p.monthAll).sort();
    const monthLines = months.map(m=>{
      const o = p.monthAll[m];
      return `${shortMonth(m)}: ${o.total}ê²½ê¸° Â· ${o.win}ìŠ¹ ${o.lose}íŒ¨ Â· ${o.rate}%`;
    });

    // ë‹¨ì‹ ìƒëŒ€ Top N
    const oppArr = Object.entries(p.oppSingles).map(([opp,v])=>({
      name: opp, total: v.win+v.lose, win:v.win, lose:v.lose, rate:pct(v.win,v.win+v.lose)
    })).sort((a,b)=> b.total - a.total).slice(0, topOppN);

    // ë³µì‹ íŒŒíŠ¸ë„ˆ Top N
    const ptnArr = Object.entries(p.ptnDoubles).map(([ptn,v])=>({
      name: ptn, total: v.win+v.lose, win:v.win, lose:v.lose, rate:pct(v.win,v.win+v.lose), points:v.points||0
    })).sort((a,b)=> b.total - a.total).slice(0, topPtnN);

    // ì„¹ì…˜ ë§Œë“¤ê¸°
    const L = [];
    L.push(`${name} (${p.level}ë¶€)`);
    L.push(`- ì „ì²´ì „ì : ${allTot}ì „ ${allWin}ìŠ¹ ${allLose}íŒ¨ (${allRate}%)`);
    if (months.length && !(hideEmpty && months.length===0)){
      L.push(`- ì›”ë³„(í†µí•©): ${monthLines.join(' / ') || '-'}`);
    }
    // 11ì›”~
    if (!(hideEmpty && sglTot===0)){
      L.push(`- ë‹¨ì‹(11ì›”~): ${sglTot}G Â· ${p.sgl.win}ìŠ¹ ${p.sgl.lose}íŒ¨ (${sglRate}%)`);
    }
    if (!(hideEmpty && dblTot===0)){
      L.push(`- ë³µì‹(11ì›”~): ${dblTot}G Â· ${p.dbl.win}ìŠ¹ ${p.dbl.lose}íŒ¨ (${dblRate}%) Â· ìŠ¹ì  ${dblPts>0? '+'+dblPts : dblPts}`);
    }
    if (!(hideEmpty && oppArr.length===0)){
      L.push(`- ë‹¨ì‹ ìƒëŒ€ Top${topOppN}: ${oppArr.map(o=>`${o.name} ${o.win}ìŠ¹${o.lose}íŒ¨(${o.rate}%)`).join(', ') || '-'}`);
    }
    if (!(hideEmpty && ptnArr.length===0)){
      L.push(`- ë³µì‹ íŒŒíŠ¸ë„ˆ Top${topPtnN}: ${ptnArr.map(o=>`${o.name} ${o.win}ìŠ¹${o.lose}íŒ¨(${o.rate}%)`).join(', ') || '-'}`);
    }

    chunks.push(L.join('\n'));
  });

  // í—¤ë”(ì „ì—­ ì•ˆë‚´)
  const header = [
    `# KOEN íƒêµ¬ í´ëŸ½ â€” ì„ ìˆ˜ë³„ ë¶„ì„ ë°ì´í„°(í…ìŠ¤íŠ¸)`,
    `* 2025-09, 2025-10: ì›”ê°„ í†µí•©ì „ì  ê¸°ì¤€`,
    `* 2025-11 ì´í›„: matches ê¸°ì¤€ ë‹¨ì‹/ë³µì‹ ë¶„ë¦¬ + ìƒì„¸`,
    `* ìš”ì²­: ì„ ìˆ˜ë³„ ì½”ì¹­ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.`
  ].join('\n');

  return header + '\n\n' + chunks.join('\n\n') + '\n';
}

/* ========== UI Actions ========== */
async function bootLoad(){
  $('#stateBadge').textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
  $('#stateBadge').style.background = '#fef3c7'; // warn
  try{
    [PLAYERS, MR_09, MR_10, MATCHES] = await Promise.all([
      loadPlayers(),
      loadMonthly('2025-09'),
      loadMonthly('2025-10'),
      loadMatches()
    ]);
    $('#stateBadge').textContent = `ë¡œë”© ì™„ë£Œ Â· ì„ ìˆ˜ ${PLAYERS.length}ëª…`;
    $('#stateBadge').style.background = '#dcfce7'; // ok
  }catch(e){
    console.error(e);
    $('#stateBadge').textContent = 'ì—ëŸ¬';
    $('#stateBadge').style.background = '#fee2e2';
    alert('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}
await bootLoad();

function buildNow(){
  const txt = buildPerPlayerText({
    topOppN: $('#topOppN').value,
    topPtnN: $('#topPtnN').value,
    hideEmpty: $('#hideEmpty').value
  });
  $('#outBox').value = txt;
  $('#summaryLine').textContent = `ì„ ìˆ˜ ${PLAYERS.length}ëª…, ê¸¸ì´ ${txt.length.toLocaleString()} chars`;
  $('#builtAt').textContent = new Date().toLocaleString('ko-KR');
}

$('#btnBuild').addEventListener('click', buildNow);
$('#btnReload').addEventListener('click', async ()=>{
  await bootLoad();
  buildNow();
});
$('#btnCopy').addEventListener('click', async ()=>{
  const v = $('#outBox').value;
  try{
    await navigator.clipboard.writeText(v);
    alert('âœ… ì „ì²´ í…ìŠ¤íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
  }catch(e){
    // https í˜¸í™˜/ê¶Œí•œ ì‹¤íŒ¨ ì‹œ í´ë°±
    $('#outBox').select(); document.execCommand('copy');
    alert('âœ… (í´ë°±) ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
  }
});

// ì²« í™”ë©´ ìë™ ìƒì„±
buildNow();
</script>
</body>
</html>
