<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ” íƒêµ¬ ìŠ¤íƒ€ì¼ ë¶„ì„</title>
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

<style>
/* ì „ì²´ ìŠ¤íƒ€ì¼ (ìƒëµ ì—†ì´ ì™„ì „ ë²„ì „) */
:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb; --card:#fff;
  --accent:#2563eb; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
  --shadow:0 8px 28px rgba(2,6,23,.08);
}
*{box-sizing:border-box}
body{margin:0;font-family:"Pretendard","Noto Sans KR",system-ui,sans-serif;background:var(--bg);color:var(--ink);font-weight:600}
.wrap{max-width:900px;margin:0 auto;padding:16px}
header{
  position:sticky;
  top:0;
  background:#fff;
  border-bottom:1px solid #e5e7eb;
  z-index:9999;
}
.analysis-wrap{ position:relative; z-index:1; }
.head-in{max-width:900px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between}
h1{margin:0;font-size:clamp(18px,4vw,22px);color:#1e40af}
.btn{border:1px solid #d1d5db;padding:8px 12px;border-radius:10px;background:#fff;cursor:pointer;font-weight:800}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-top:12px}
.sec-title{font-size:16px;font-weight:900;color:#0f172a;margin:0 0 8px}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#e2efff;color:#1e40af;font-size:12px;font-weight:900}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.kv{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.divider{height:1px;background:#eef2f7;margin:12px 0}
ul.clean{list-style:none;padding:0;margin:0;display:grid;gap:6px}
.small{font-size:13px;color:#475569}

input,textarea{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;font:inherit}
label{font-size:12px;color:#475569;font-weight:800}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-12{grid-column:span 12}
.col-6{grid-column:span 6}
@media(max-width:720px){.col-6{grid-column:span 12}}
</style>
</head>

<body>
<header>
  <div class="head-in">
    <h1>ğŸ” íƒêµ¬ ìŠ¤íƒ€ì¼ ë¶„ì„</h1>
    <div class="row">
      <button class="btn" id="btnBack">â† ê°œì¸ ì„±ì </button>
      <button class="btn" id="btnAdminToggle">ê´€ë¦¬ìëª¨ë“œ</button>
      <span class="badge" id="who"></span>
    </div>
  </div>
</header>

<div class="analysis-wrap">
<main class="wrap">

  <section class="card" style="margin-top:12px;">
    <div id="analysisContent"></div>
  </section>

  <section class="card">
    <div class="sec-title">ğŸ“… í†µí•©ë¦¬ê·¸ ìš”ì•½</div>
    <div id="integratedBox" class="kv"></div>
    <ul id="integratedBullets" class="clean"></ul>
    <div class="small">â€» í†µí•©ë¦¬ê·¸ëŠ” ì°¸ê³ ìš©ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.</div>
  </section>

  <section class="card">
    <div class="sec-title">ğŸ¯ ì„¸ë¶€ ì„±í–¥ (ë‹¨ì‹Â·ë³µì‹)</div>
    <div class="grid">
      <div class="col-6">
        <div class="badge">ë‹¨ì‹</div>
        <ul id="singleBullets" class="clean"></ul>
      </div>
      <div class="col-6">
        <div class="badge">ë³µì‹</div>
        <ul id="doubleBullets" class="clean"></ul>
      </div>
    </div>
    <div class="divider"></div>
    <ul id="recommend" class="clean"></ul>
  </section>

  <section class="card" id="adminCard" style="display:none">
    <div class="sec-title">ğŸ›  ê´€ë¦¬ì ë©”ëª¨</div>
    <div class="grid">
      <div class="col-6">
        <label>ìŠ¤íƒ€ì¼</label>
        <input id="ad_style" placeholder="ì˜ˆ: ê³µê²©í˜•, ì•ˆì •í˜•">
      </div>
      <div class="col-6">
        <label>ì„ í˜¸ íŒŒíŠ¸ë„ˆ</label>
        <input id="ad_favs" placeholder="í™ê¸¸ë™, ê¹€ì˜í¬">
      </div>
      <div class="col-6">
        <label>ê°•ì </label>
        <input id="ad_strengths" placeholder="ì´ˆêµ¬ ë“œë¼ì´ë¸Œ, ë°œë¹ ë¦„">
      </div>
      <div class="col-6">
        <label>ì•½ì </label>
        <input id="ad_weaknesses" placeholder="ë°± ì»¤íŠ¸, ë¦¬ì‹œë¸Œ">
      </div>
      <div class="col-12">
        <label>ì–´ë ¤ìš´ ìƒëŒ€</label>
        <input id="ad_hards" placeholder="ì´ìƒì¤€, ë°•ë‚˜ë ¹">
      </div>
      <div class="col-12">
        <label>ë©”ëª¨</label>
        <textarea id="ad_memo" rows="3" placeholder="ì „ì§„ ê³µê²© ìœ„ì£¼â€¦"></textarea>
      </div>
    </div>

    <button class="btn primary" id="btnSaveAdmin" style="margin-top:12px;">ì €ì¥</button>
  </section>

</main>
</div>


<script type="module">
/* ============================================
   âœ… Firebase ì´ˆê¸°í™”
===============================================*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};

initializeApp(firebaseConfig);
const db = getDatabase();


/* ============================================
   âœ… ê¸°ë³¸ ì„¤ì •
===============================================*/
const params = new URLSearchParams(location.search);
const playerName = params.get("name") || "";
document.getElementById("who").textContent = playerName;

const pct = (a, b) => (b ? Math.round(a / b * 100) : 0);
const fmt = n => Math.round(n * 10) / 10;

const box = document.getElementById("analysisContent");


/* ============================================
   âœ… ê´€ë¦¬ì ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°
===============================================*/
async function loadAdminMemo() {
  const snap = await get(ref(db, `playerDetail/${playerName}`));
  return snap.exists() ? snap.val() : {};
}


/* ============================================
   âœ… ê´€ë¦¬ì ë©”ëª¨ ì €ì¥
===============================================*/
document.getElementById("btnSaveAdmin")?.addEventListener("click", async () => {
  const data = {
    style: document.getElementById("ad_style").value.trim(),
    favs: document.getElementById("ad_favs").value.trim(),
    strengths: document.getElementById("ad_strengths").value.trim(),
    weaknesses: document.getElementById("ad_weaknesses").value.trim(),
    hards: document.getElementById("ad_hards").value.trim(),
    memo: document.getElementById("ad_memo").value.trim()
  };

  await set(ref(db, `playerDetail/${playerName}`), data);

  alert("âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
});


/* ============================================
   âœ…  í†µí•©ë¦¬ê·¸ ë°ì´í„° ë¡œë“œ
===============================================*/
async function loadMonthlyReports() {
  const snap = await get(ref(db, "monthlyReports"));
  if (!snap.exists()) return [];

  const data = snap.val();
  let result = [];

  Object.entries(data).forEach(([month, obj]) => {
    if (!obj.players) return;
    const me = Object.values(obj.players).find(p => p.name === playerName);
    if (!me) return;

    const win = Number(me.wins ?? me.win ?? 0);
    const lose = Number(me.losses ?? me.lose ?? 0);

    result.push({
      month, win, lose,
      total: win + lose,
      rate: pct(win, win + lose)
    });
  });

  return result.sort((a, b) => a.month.localeCompare(b.month));
}


/* ============================================
   âœ… ë‹¨ì‹/ë³µì‹ ê²½ê¸° ë¡œë“œ
===============================================*/
async function loadMatches() {
  const snap = await get(ref(db, "matches"));
  if (!snap.exists()) return [];

  const list = Object.values(snap.val());
  return list.filter(m => {
    const names = [...(m.namesA || []), ...(m.namesB || [])];
    return names.includes(playerName);
  });
}


/* ============================================
   âœ… í†µí•©ë¦¬ê·¸ ë¶„ì„
===============================================*/
function analyzeUnified(reports) {

  if (!reports.length) return {
    trend: "ë°ì´í„° ì—†ìŒ",
    best: null,
    worst: null,
    steady: null,
    pattern: "í†µí•© ê¸°ë¡ì´ ë¶€ì¡±í•˜ì—¬ ì„±í–¥ ë¶„ì„ì´ ì œí•œë©ë‹ˆë‹¤."
  };

  const best = [...reports].sort((a, b) => b.rate - a.rate)[0];
  const worst = [...reports].sort((a, b) => a.rate - b.rate)[0];

  let trend = "ì•ˆì •ì ";
  if (reports.length >= 2) {
    const diff = reports.at(-1).rate - reports[0].rate;
    if (diff >= 10) trend = "ìŠ¹ë¥  ìƒìŠ¹ì„¸";
    else if (diff <= -10) trend = "ìŠ¹ë¥  í•˜ë½ì„¸";
  }

  const totals = reports.map(r => r.total);
  const steady = fmt((Math.min(...totals) / Math.max(...totals)) * 100);

  let pattern = "";
  if (best.rate >= 65) pattern = "ì»¨ë””ì…˜ ì¢‹ì„ ë•Œ ëª°ì•„ì¹˜ëŠ” í­ë°œí˜• ê²½ê¸°ë ¥.";
  else if (best.rate >= 55) pattern = "ì „ë°˜ì ìœ¼ë¡œ ì•ˆì •ì ì¸ ê²½ê¸° íë¦„.";
  else pattern = "ì´ˆë°˜ ì‹¤ì  ê²½í–¥ì´ ìˆìœ¼ë©° ì§‘ì¤‘ë ¥ì´ ë§¤ìš° ì¤‘ìš”.";

  return { trend, best, worst, steady, pattern };
}


/* ============================================
   âœ… HTML ìƒì„± â€” ì „ì²´ ë¶„ì„
===============================================*/
function makeAnalysis(reports, matches, adminMemo) {

  let out = [];

  /* âœ… í†µí•© ì§‘ê³„ */
  let totalWin = 0, totalLose = 0;
  reports.forEach(r => { totalWin += r.win; totalLose += r.lose; });

  const allRate = pct(totalWin, totalWin + totalLose);
  const unified = analyzeUnified(reports);

  /* âœ… í—¤ë“œë¼ì¸ */
  out.push(`
    <div style="font-size:20px;font-weight:900;margin-bottom:12px;color:#1e3a8a">
      ğŸ“Œ í•µì‹¬ ìš”ì•½
    </div>
    <div class="box">
      <b>${playerName}</b> ì„ ìˆ˜ëŠ” í†µí•© ê¸°ì¤€ <b>${allRate}% ìŠ¹ë¥ </b>ì„ ê¸°ë¡ ì¤‘ì´ë©°,
      ìµœê·¼ íë¦„ì€ <b>${unified.trend}</b>ì…ë‹ˆë‹¤.
    </div>
  `);

  /* âœ… í†µí•©ë¦¬ê·¸ */
  out.push(`
    <div class="sec-title">ğŸ“… í†µí•©ë¦¬ê·¸ ë¶„ì„</div>
    <div class="box">
      ${
        reports.length
        ? `
          ìµœê³  ì„±ì  ë‹¬: <b>${unified.best.month}</b> (${unified.best.rate}%)<br>
          ì–´ë ¤ì› ë˜ ë‹¬: <b>${unified.worst.month}</b> (${unified.worst.rate}%)<br><br>
          ê¾¸ì¤€í•¨ ì§€ìˆ˜: <b>${unified.steady}%</b><br><br>
          ${unified.pattern}
        `
        : "í†µí•© ë¦¬ê·¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
      }
    </div>
  `);

  /* âœ… ë‹¨ì‹/ë³µì‹ ë¶„ì„ */
  let sWin=0, sLose=0, dWin=0, dLose=0;
  let opp={}, partner={};

  matches.forEach(m => {
    const A = m.namesA || [];
    const B = m.namesB || [];
    const isA = A.includes(playerName);
    const won = (m.winnerSide === "A" && isA) || (m.winnerSide === "B" && !isA);

    if (m.mode === "single") {
      if (won) sWin++; else sLose++;
      const other = isA ? B[0] : A[0];
      if (other) {
        if (!opp[other]) opp[other] = { win:0, lose:0 };
        won ? opp[other].win++ : opp[other].lose++;
      }
    } else {
      if (won) dWin++; else dLose++;
      const same = isA ? A : B;
      const pt = same.find(n => n !== playerName);
      if (pt) {
        if (!partner[pt]) partner[pt] = { win:0, lose:0 };
        won ? partner[pt].win++ : partner[pt].lose++;
      }
    }
  });

  const sRate = pct(sWin, sWin + sLose);
  const dRate = pct(dWin, dWin + dLose);

  const topOpp = Object.entries(opp)
    .map(([k, v]) => ({ name:k, total:v.win + v.lose }))
    .sort((a, b) => b.total - a.total)[0];

  const topPartner = Object.entries(partner)
    .map(([k, v]) => ({ name:k, total:v.win + v.lose }))
    .sort((a, b) => b.total - a.total)[0];

  out.push(`
    <div class="sec-title">ğŸ¯ ë‹¨ì‹Â·ë³µì‹ ë¶„ì„</div>
    <div class="box">
      <b>ë‹¨ì‹:</b> ${sWin+sLose ? `${sWin}ìŠ¹ ${sLose}íŒ¨ (${sRate}%)` : "ë°ì´í„° ì—†ìŒ"}<br>
      ${topOpp ? `ì£¼ìš” ìƒëŒ€: <b>${topOpp.name}</b>` : ""}

      <div style="height:6px"></div>

      <b>ë³µì‹:</b> ${dWin+dLose ? `${dWin}ìŠ¹ ${dLose}íŒ¨ (${dRate}%)` : "ë°ì´í„° ì—†ìŒ"}<br>
      ${topPartner ? `ì£¼ìš” íŒŒíŠ¸ë„ˆ: <b>${topPartner.name}</b>` : ""}
    </div>
  `);

  /* âœ… AI ì½”ì¹­ */
  out.push(`
    <div class="sec-title">ğŸ¤– AI ì½”ì¹­ ë¶„ì„</div>
    <div class="box">
      ${
        allRate >= 60
        ? "ì „ì²´ì ìœ¼ë¡œ ì•ˆì •ì ì´ë©° ìƒìœ„ê¶Œ ê°€ëŠ¥ì„±ì´ ì¶©ë¶„í•©ë‹ˆë‹¤."
        : "ë¦¬ì‹œë¸Œ ì•ˆì •í™”ì™€ ì´ˆë°˜ ì‹¤ì  ê´€ë¦¬ê°€ ìŠ¹ë¥  ìƒìŠ¹ì˜ í•µì‹¬ì…ë‹ˆë‹¤."
      }
      <br><br>
      ${
        sRate >= dRate
        ? "ë‹¨ì‹ ê°•ì ì´ ëšœë ·í•˜ë©°, ë³µì‹ì€ íŒŒíŠ¸ë„ˆ ê¶í•©ì„ ì°¾ì„ìˆ˜ë¡ ì„±ì¥í•©ë‹ˆë‹¤."
        : "ë³µì‹ ê°ê°ì´ ì¢‹ìœ¼ë©° ë‹¨ì‹ì—ì„œì˜ íë¦„ ê´€ë¦¬ ëŠ¥ë ¥ì´ ì¤‘ìš”í•©ë‹ˆë‹¤."
      }
    </div>
  `);

  /* âœ… ê´€ë¦¬ì ì…ë ¥ê°’ ë°˜ì˜ (ì…ë ¥í•œ ê²ƒë§Œ í‘œì‹œ) */
  const hasAdmin =
    adminMemo.style ||
    adminMemo.favs ||
    adminMemo.strengths ||
    adminMemo.weaknesses ||
    adminMemo.hards ||
    adminMemo.memo;

  if (hasAdmin) {
    out.push(`
      <div class="sec-title">ğŸ“ ê´€ë¦¬ì ì½”ì¹­ ì°¸ê³ </div>
      <div class="box">
        ${adminMemo.style ? `<div>â€¢ ìŠ¤íƒ€ì¼: <b>${adminMemo.style}</b></div>` : ""}
        ${adminMemo.strengths ? `<div>â€¢ ê°•ì : <b>${adminMemo.strengths}</b></div>` : ""}
        ${adminMemo.weaknesses ? `<div>â€¢ ì•½ì : <b>${adminMemo.weaknesses}</b></div>` : ""}
        ${adminMemo.favs ? `<div>â€¢ ì„ í˜¸ íŒŒíŠ¸ë„ˆ: <b>${adminMemo.favs}</b></div>` : ""}
        ${adminMemo.hards ? `<div>â€¢ ì–´ë ¤ìš´ ìƒëŒ€: <b>${adminMemo.hards}</b></div>` : ""}
        ${adminMemo.memo ? `<div style="margin-top:6px;color:#475569">${adminMemo.memo}</div>` : ""}
      </div>
    `);
  }

  return out.join("\n");
}


/* ============================================
   âœ… ì‹¤í–‰: ë°ì´í„° ë¶ˆëŸ¬ì™€ ë¶„ì„ ì¶œë ¥
===============================================*/
(async () => {
  box.innerHTML = "ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";

  const reports = await loadMonthlyReports();
  const matches = await loadMatches();
  const adminMemo = await loadAdminMemo();

  box.innerHTML = makeAnalysis(reports, matches, adminMemo);

  /* âœ… ê´€ë¦¬ìëª¨ë“œ ì…ë ¥ì°½ë„ ê¸°ì¡´ ê°’ ìë™ ì±„ì›€ */
  if (adminMemo.style) document.getElementById("ad_style").value = adminMemo.style;
  if (adminMemo.favs) document.getElementById("ad_favs").value = adminMemo.favs;
  if (adminMemo.strengths) document.getElementById("ad_strengths").value = adminMemo.strengths;
  if (adminMemo.weaknesses) document.getElementById("ad_weaknesses").value = adminMemo.weaknesses;
  if (adminMemo.hards) document.getElementById("ad_hards").value = adminMemo.hards;
  if (adminMemo.memo) document.getElementById("ad_memo").value = adminMemo.memo;
})();



</script>
/* ============================================
   âœ… ìƒë‹¨ ë²„íŠ¼ ë™ì‘ + ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì¸ì¦
===============================================*/
const btnBack = document.getElementById("btnBack");
btnBack?.addEventListener("click", () => {
  location.href = `player.html?name=${encodeURIComponent(playerName)}`;
});

const btnAdmin = document.getElementById("btnAdminToggle");
const adminCard = document.getElementById("adminCard");

let adminOn = false;  // ì´ˆê¸°ì—ëŠ” í•­ìƒ OFF

/* âœ… Firebaseì—ì„œ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë¶ˆëŸ¬ì˜¤ê¸° */
async function loadAdminPassword() {
  const snap = await get(ref(db, "config/adminPassword"));  
  return snap.exists() ? snap.val() : null;
}

/* âœ… ê´€ë¦¬ìëª¨ë“œ ë²„íŠ¼ í´ë¦­ */
btnAdmin?.addEventListener("click", async () => {

  // OFF â†’ ON ìœ¼ë¡œ ì „í™˜ ì‹œë„
  if (!adminOn) {
    const correctPw = await loadAdminPassword();

    if (!correctPw) {
      alert("âš  ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\n(ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì„¤ì • ê°€ëŠ¥)");
      return;
    }

    const input = prompt("ğŸ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
    if (input === null) return;

    if (input.trim() !== correctPw.trim()) {
      alert("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      return;
    }

    // âœ… ì„±ê³µ
    adminOn = true;
    applyAdmin();
    alert("âœ… ê´€ë¦¬ìëª¨ë“œ í™œì„±í™”");
  }

  // ì´ë¯¸ ON ìƒíƒœ â†’ OFF
  else {
    adminOn = false;
    applyAdmin();
  }

});

/* âœ… UI ì ìš© í•¨ìˆ˜ */
function applyAdmin() {
  adminCard.style.display = adminOn ? "block" : "none";
  btnAdmin.classList.toggle("primary", adminOn);
  btnAdmin.textContent = adminOn ? "ê´€ë¦¬ìëª¨ë“œ ON" : "ê´€ë¦¬ìëª¨ë“œ";
}


</body>
</html>
