<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>íƒêµ¬ ìŠ¤íƒ€ì¼ ë¶„ì„</title>

<style>
  body {
    margin:0;
    padding:0;
    font-family: "Pretendard","Noto Sans KR",sans-serif;
    background:#fff;
    color:#0f172a;
  }

  .analysis-wrap {
    padding: 10px 6px 20px 6px;
  }

  h2 {
    margin:0 0 14px 0;
    font-size:22px;
    font-weight:900;
    color:#1e3a8a;
    text-align:center;
  }

  .section-title {
    font-size:16px;
    font-weight:900;
    margin-top:20px;
    margin-bottom:8px;
    color:#1e3a8a;
  }

  .box {
    background:#f8fafc;
    border:1px solid #e2e8f0;
    padding:12px 14px;
    border-radius:12px;
    font-size:15px;
    line-height:1.55;
    margin-bottom:14px;
  }

  .highlight {
    color:#2563eb;
    font-weight:900;
  }

  .good {
    color:#0f6a00;
    font-weight:800;
  }

  .bad {
    color:#d45500;
    font-weight:800;
  }

  .sub {
    font-size:13px;
    color:#64748b;
    margin-bottom:6px;
    font-weight:700;
  }
</style>
</head>
<body>

<div class="analysis-wrap">
  <h2>ğŸ“ íƒêµ¬ ìŠ¤íƒ€ì¼ ë¶„ì„</h2>
  <div id="analysisContent">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// âœ… URLì—ì„œ playerName ì½ê¸°
const params = new URLSearchParams(location.search);
const name = params.get("name") || "";
const box = document.getElementById("analysisContent");

box.innerHTML = "ë°ì´í„° ë¶„ì„ ì¤‘...";

// âœ… Firebaseì—ì„œ ê²½ê¸° ê¸°ë¡ ì½ê¸°
async function loadMatches() {
  const snap = await get(ref(db, "matches"));
  if (!snap.exists()) return [];

  return Object.values(snap.val()).filter(m => {
    const names = [...(m.namesA || []), ...(m.namesB || [])];
    return names.includes(name); // í•´ë‹¹ ì„ ìˆ˜ í¬í•¨ ê²½ê¸°ë§Œ
  });
}

// âœ… ë¶„ì„ ìƒì„±
function makeAnalysis(matches) {
  if (!matches.length) {
    return `<div class="box">ê²½ê¸° ê¸°ë¡ì´ ë¶€ì¡±í•˜ì—¬ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
  }

  let sWin = 0, sLose = 0;
  let dWin = 0, dLose = 0;

  let opp = {};     // ë‹¨ì‹ ìƒëŒ€ë³„
  let partner = {}; // ë³µì‹ íŒŒíŠ¸ë„ˆë³„

  matches.forEach(m => {
    const A = m.namesA || [];
    const B = m.namesB || [];
    const isA = A.includes(name);
    const won = (m.winnerSide === "A" && isA) || (m.winnerSide === "B" && !isA);

    if (m.mode === "single") {
      if (won) sWin++; else sLose++;

      const other = isA ? B[0] : A[0];
      if (!opp[other]) opp[other] = { win: 0, lose: 0 };
      if (won) opp[other].win++; else opp[other].lose++;

    } else {
      if (won) dWin++; else dLose++;

      const same = isA ? A : B;
      const pt = same.find(n => n !== name);
      if (pt) {
        if (!partner[pt]) partner[pt] = { win: 0, lose: 0 };
        if (won) partner[pt].win++; else partner[pt].lose++;
      }
    }
  });

  // âœ… íŠ¹ì§• ë„ì¶œ
  const sTotal = sWin + sLose;
  const dTotal = dWin + dLose;

  const sRate = sTotal ? Math.round(sWin / sTotal * 100) : 0;
  const dRate = dTotal ? Math.round(dWin / dTotal * 100) : 0;

  const topOpp = Object.entries(opp).sort((a,b)=> (b[1].win + b[1].lose) - (a[1].win + a[1].lose))[0];
  const topPartner = Object.entries(partner).sort((a,b)=> (b[1].win + b[1].lose) - (a[1].win + a[1].lose))[0];

  return `
    <div class="section-title">ğŸ“Œ ì „ì²´ ìš”ì•½</div>
    <div class="box">
      <b class="highlight">${name}</b> ì„ ìˆ˜ëŠ” ìµœê·¼ ê²½ê¸°ì—ì„œ  
      <span class="good">ë‹¨ì‹ ${sRate}%</span>,  
      <span class="highlight">ë³µì‹ ${dRate}%</span>ì˜ ìŠ¹ë¥ ì„ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤.
      <br><br>
      ê²½ê¸° ìŠ¤íƒ€ì¼ì€ <b>ë‹¨ì‹Â·ë³µì‹ ëª¨ë‘ ì ê·¹ì ìœ¼ë¡œ ì„í•˜ì§€ë§Œ</b>  
      ë³µì‹ì—ì„œ ì¡°ê¸ˆ ë” ê°•ì ì´ ìˆëŠ” í¸ì…ë‹ˆë‹¤.
    </div>

    <div class="section-title">ğŸ¯ ë‹¨ì‹ íŠ¹ì§•</div>
    <div class="box">
      ${sTotal ? `
        ë‹¨ì‹ì€ <b>${sWin}ìŠ¹ ${sLose}íŒ¨</b>ë¡œ,  
        ìŠ¹ë¥  <span class="good">${sRate}%</span>ì…ë‹ˆë‹¤.<br>
        ${topOpp ? `<br>ê°€ì¥ ë§ì€ ê²½ê¸°ë¥¼ í•œ ìƒëŒ€ëŠ” <b>${topOpp[0]}</b>ì…ë‹ˆë‹¤.` : ""}
      ` : "ë‹¨ì‹ ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤."}
    </div>

    <div class="section-title">ğŸ¤ ë³µì‹ íŠ¹ì§•</div>
    <div class="box">
      ${dTotal ? `
        ë³µì‹ì€ <b>${dWin}ìŠ¹ ${dLose}íŒ¨</b>ì´ë©°,  
        ìŠ¹ë¥  <span class="highlight">${dRate}%</span>ì…ë‹ˆë‹¤.<br>
        ${topPartner ? `<br>ê°€ì¥ ë§ì´ í˜¸í¡ì„ ë§ì¶˜ íŒŒíŠ¸ë„ˆëŠ” <b>${topPartner[0]}</b>ì…ë‹ˆë‹¤.` : ""}
      ` : "ë³µì‹ ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤."}
    </div>

    <div class="section-title">âœ… í–¥í›„ ì—°ìŠµ ì¶”ì²œ</div>
    <div class="box">
      ${
        sRate < dRate
        ? `<b>ë‹¨ì‹ ì•ˆì •ì„± ë³´ì™„</b>ì´ ìš°ì„ ì…ë‹ˆë‹¤.  
           ì´ˆë°˜ ì‹¤ì ì„ ì¤„ì´ê¸° ìœ„í•œ ë¦¬ì‹œë¸Œ ì—°ìŠµì´ ë„ì›€ì´ ë©ë‹ˆë‹¤.`
        : `<b>ë³µì‹ ê²½ìŸë ¥ ê·¹ëŒ€í™”</b>ê°€ ì¢‹ìŠµë‹ˆë‹¤.  
           íŒŒíŠ¸ë„ˆì™€ì˜ í¬ì§€ì…˜ ì´í•´Â·ë™ì„  ì¡°ì •ì´ í° íš¨ê³¼ë¥¼ ëƒ…ë‹ˆë‹¤.`
      }
      <br><br>
      ë˜í•œ ìŠ¹ë¥ ì´ ë‚®ê±°ë‚˜ íŒ¨ë°° íšŸìˆ˜ê°€ ë§ì•˜ë˜ ìƒëŒ€ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ  
      <b class="bad">ì•½ì  ë¶„ì„</b>ì„ ì§„í–‰í•˜ë©´ ì„±ì¥ì— ë„ì›€ì´ ë©ë‹ˆë‹¤.
    </div>
  `;
}

(async ()=>{
  const matches = await loadMatches();
  box.innerHTML = makeAnalysis(matches);
})();
</script>

</body>
</html>
