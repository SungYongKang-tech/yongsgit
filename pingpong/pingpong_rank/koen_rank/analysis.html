<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>KOEN Ping-Pong | Analysis</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ---------- ìœ í‹¸ ----------
const fmt = (n)=> (Math.round(n*10)/10).toFixed(1);
const rate = (w,t)=> t? (w/t*100):0;

// ìŠ¤íŠ¸ë¦­/ë³€ë™ì„±(ìŠ¹/íŒ¨ ë°°ì—´ë§Œìœ¼ë¡œ)
function streakStats(bools){
  let cur = 0, curType = null, maxW = 0, maxL = 0, switches = 0;
  for(const r of bools){
    if(curType===null){ curType = r; cur = 1; }
    else if(r===curType){ cur++; }
    else { switches++; curType = r; cur = 1; }
    if(r) maxW = Math.max(maxW, curType===true?cur:0);
    else  maxL = Math.max(maxL, curType===false?cur:0);
  }
  const volatility = bools.length>1 ? switches/(bools.length-1) : 0; // 0(ì•ˆì •)~1(ìš”ë™)
  const currentStreak = cur>0 ? (curType? `ì—°ìŠ¹ ${cur}`:`ì—°íŒ¨ ${cur}`) : "-";
  return {maxWinStreak:maxW, maxLoseStreak:maxL, volatility, currentStreak};
}

// ëª¨ë©˜í…€(ìµœê·¼10 vs ê·¸ ì´ì „10)
function momentum(bools){
  const last = bools.slice(-10);
  const prev = bools.slice(-20,-10);
  const lastR = last.length? (last.filter(x=>x).length/last.length*100):0;
  const prevR = prev.length? (prev.filter(x=>x).length/prev.length*100):0;
  return { lastR, prevR, diff: lastR - prevR };
}

// ìƒëŒ€ ë‚œì´ë„(ë¶€ìˆ˜ ë‚®ì„ìˆ˜ë¡ ìƒìœ„ë¡œ ê°€ì •, ì—†ìœ¼ë©´ 99)
function avg(arr){ return arr.length? arr.reduce((a,b)=>a+b,0)/arr.length : 0; }
function levelOf(name, playerLevels){ return parseInt(playerLevels[name]) || 99; }

(async function run(){
  const params = new URLSearchParams(location.search);
  const name = params.get("name") || "";
  if(!name){ document.getElementById("analysisResultData").innerHTML = "<p>ì„ ìˆ˜ëª…ì´ ì—†ìŠµë‹ˆë‹¤.</p>"; return; }

  const [playersSnap, matchesSnap] = await Promise.all([
    get(ref(db,"players")),
    get(ref(db,"matches")),
  ]);
  const players = playersSnap.val()||{};
  const matches = matchesSnap.val()||{};

  // ì´ë¦„->ë¶€ìˆ˜ ë§¤í•‘
  const playerLevels = {};
  Object.values(players).forEach(p=>{
    if(p?.name) playerLevels[p.name] = p.level;
  });

  // ë‹¨ì‹/ë³µì‹ìœ¼ë¡œ ë¶„ë¦¬, ì‹œê°„ìˆœ ì •ë ¬ ê°€ì • ì—†ì´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
  const singles=[], doubles=[];
  for(const id in matches){
    const m = matches[id];
    const mode = m.mode;
    const all = [...(m.namesA||[]), ...(m.namesB||[])];
    if(!all.includes(name)) continue;

    const isA = (m.namesA||[]).includes(name);
    const win = (m.winnerSide==='A' && isA) || (m.winnerSide==='B' && !isA);

    if(mode==="single"){
      const opp = isA ? (m.namesB?.[0]||"") : (m.namesA?.[0]||"");
      singles.push({
        win,
        opponent: opp,
        opponentLevel: levelOf(opp, playerLevels),
        monthKey: m.monthKey||""
      });
    }else if(mode==="double"){
      const partner = (isA? m.namesA: m.namesB).find(n=>n!==name) || "";
      const oppTeam = isA? (m.namesB||[]) : (m.namesA||[]);
      const oppAvg = avg(oppTeam.map(n=>levelOf(n, playerLevels)));
      doubles.push({
        win,
        partner,
        partnerLevel: levelOf(partner, playerLevels),
        oppAvgLevel: oppAvg,
        monthKey: m.monthKey||""
      });
    }
  }

  // ë‹¨ì‹ ìš”ì•½
  const sW = singles.filter(x=>x.win).length, sT = singles.length, sR = rate(sW,sT);
  const sBools = singles.map(x=>x.win);
  const sStreak = streakStats(sBools);
  const sMomentum = momentum(sBools);

  // ë³µì‹ ìš”ì•½
  const dW = doubles.filter(x=>x.win).length, dT = doubles.length, dR = rate(dW,dT);
  const dBools = doubles.map(x=>x.win);
  const dStreak = streakStats(dBools);
  const dMomentum = momentum(dBools);

  // ìƒëŒ€ ë‚œì´ë„(ë‹¨ì‹): ì´ê¸´ ê²½ê¸° vs ì§„ ê²½ê¸°ì˜ ìƒëŒ€ í‰ê·  ë¶€ìˆ˜ ë¹„êµ
  const winOppLv = avg(singles.filter(x=>x.win).map(x=>x.opponentLevel));
  const loseOppLv = avg(singles.filter(x=>!x.win).map(x=>x.opponentLevel));
  const oppNote = (winOppLv && loseOppLv)
    ? (winOppLv <= loseOppLv
        ? "ìƒëŒ€ ë‚œì´ë„ê°€ ë†’ì„ìˆ˜ë¡(ë¶€ìˆ˜ ë‚®ìŒ)ë„ ìŠ¹ë¦¬ ì„±ê³¼ê°€ ë‚˜ì˜¤ëŠ” í¸ì…ë‹ˆë‹¤."
        : "ìƒëŒ€ ë‚œì´ë„ê°€ ì˜¬ë¼ê°€ë©´(ë¶€ìˆ˜ ë‚®ìŒ) ìŠ¹ë¥ ì´ ë–¨ì–´ì§€ëŠ” ê²½í–¥ì´ ìˆìŠµë‹ˆë‹¤.")
    : "ìƒëŒ€ ë‚œì´ë„ ë¹„êµë¥¼ ìœ„í•œ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";

  // íŒŒíŠ¸ë„ˆ ì‹œë„ˆì§€(ë³µì‹)
  const partnerMap = {};
  doubles.forEach(x=>{
    if(!x.partner) return;
    if(!partnerMap[x.partner]) partnerMap[x.partner] = {w:0,t:0,pl: x.partnerLevel};
    partnerMap[x.partner].t++; if(x.win) partnerMap[x.partner].w++;
  });
  const partnerArr = Object.entries(partnerMap)
    .map(([k,v])=>({name:k, total:v.t, win:v.w, rate: rate(v.w,v.t), level:v.pl}))
    .filter(p=>p.total>=3) // ìµœì†Œ í‘œë³¸(ì›í•˜ì‹œë©´ ì¡°ì •)
    .sort((a,b)=> b.rate - a.rate || b.total - a.total);

  // ì½”ì¹­ ê°€ì´ë“œ(ë£° ê¸°ë°˜: ìŠ¹/íŒ¨ë§Œ ì´ìš©)
  const tips = [];
  // ëª¨ë©˜í…€
  if(sMomentum.diff <= -10 && sT>=10) tips.push("ë‹¨ì‹ ìµœê·¼ í¼ì´ í•˜ë½ ì¤‘ì…ë‹ˆë‹¤. ë£¨í‹´(ì„œë¸ŒÂ·ë¦¬ì‹œë¸Œ ê³ ì • íŒ¨í„´) ì ê²€ìœ¼ë¡œ ì´ˆë°˜ ë¦¬ë“¬ì„ ë˜ì°¾ì•„ë³´ì„¸ìš”.");
  if(sMomentum.diff >= 10 && sT>=10)  tips.push("ë‹¨ì‹ ìµœê·¼ í¼ì´ ìƒìŠ¹ ì¤‘ì…ë‹ˆë‹¤. í˜„ì¬ì˜ ì„œë¸Œ-3êµ¬ ì—°ê²° íŒ¨í„´ì„ ìœ ì§€Â·ê°•í™”í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.");
  if(dMomentum.diff <= -10 && dT>=10) tips.push("ë³µì‹ì€ í˜¸í¡ ì €í•˜ê°€ ë³´ì—¬ íŒŒíŠ¸ë„ˆì™€ì˜ ì½œÂ·í¬ì§€ì…˜ ì „í™˜ í•©ì„ ì ê²€í•˜ì„¸ìš”.");
  if(dMomentum.diff >= 10 && dT>=10)  tips.push("ë³µì‹ ìµœê·¼ ìƒìŠ¹ì„¸ì…ë‹ˆë‹¤. ë¦¬ì‹œë¸Œ ë’¤ ì»¤ë²„ ë™ì„ ê³¼ ë¡¤ì„ ë” ëª…í™•íˆ í•˜ì„¸ìš”.");

  // ë³€ë™ì„±(ìš”ë™ì¹¨)
  if(sStreak.volatility >= 0.5 && sT>=8) tips.push("ë‹¨ì‹ ê²°ê³¼ ë³€ë™í­ì´ í½ë‹ˆë‹¤. ì„¸íŠ¸ ì´ˆë°˜ 3ë³¼ ë‚´ì—ì„œì˜ ì„ íƒ(ì»¤íŠ¸/í‘¸ì‹œ/ë“œë¼ì´ë¸Œ)ì„ ë‹¨ìˆœí™”í•´ ì•ˆì •ë„ë¥¼ ë†’ì´ì„¸ìš”.");
  if(dStreak.volatility >= 0.5 && dT>=8) tips.push("ë³µì‹ ë³€ë™ì„±ì´ í½ë‹ˆë‹¤. ë ˆì‹œë²„ ê¸°ì¤€ í¬ë¡œìŠ¤(ì•ˆì „) ìš°ì„ , ë‹¤ìš´ë”ë¼ì¸(ìœ„í—˜)ì€ ë“ì  ë£¨í‹´ì´ ëª…í™•í•  ë•Œ ì„ íƒí•˜ì„¸ìš”.");

  // ë‚œì´ë„ ëŒ€ì‘
  if(winOppLv && loseOppLv && winOppLv > loseOppLv) tips.push("ìƒìœ„ ë¶€ìˆ˜ì™€ì˜ ë‚œì „ ëŒ€ì‘ë ¥ì´ ê³¼ì œì…ë‹ˆë‹¤. ë ë¦¬ ê¸¸ì–´ì§ˆ ë•Œ ë°±í•¸ë“œ ì‹¤ìˆ˜ ì–µì œë¥¼ ìœ„í•œ ë°˜ë³µ ë“œë¦´ì„ ê¶Œì¥í•©ë‹ˆë‹¤.");

  // ë‹¨ì‹/ë³µì‹ í¸ì°¨
  if(sR - dR >= 15 && dT>=5) tips.push("ë³µì‹ ìŠ¹ë¥  ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤. ì„œë¸Œ íƒ€ì-ì»¤ë²„ ë‹´ë‹¹ì„ ê³ ì •í•˜ê³ , ë¦¬í„´ í›„ êµì°¨ ì»¤ë²„ ì—°ìŠµì„ ë°˜ë³µí•˜ì„¸ìš”.");
  if(dR - sR >= 15 && sT>=5) tips.push("ë‹¨ì‹ë³´ë‹¤ ë³µì‹ ì„±í–¥ì´ ê°•í•©ë‹ˆë‹¤. ê°œì¸ì „ì—ì„œëŠ” ì„œë¸Œ ì½”ìŠ¤ ë‹¤ì–‘í™”ë¡œ ì´ˆë°˜ ë¦¬ë“œ í™•ë³´ë¥¼ ë…¸ë¦¬ì„¸ìš”.");

  // ìŠ¤íŠ¸ë¦­ ê¸°ë°˜
  if(sStreak.maxLoseStreak >= 3) tips.push("ë‹¨ì‹ì—ì„œ ì—°íŒ¨ êµ¬ê°„ì´ ìˆì—ˆìŠµë‹ˆë‹¤. ì—°íŒ¨ íƒˆì¶œìš© ìŠ¤íƒ€íŠ¸ ì „ìˆ (ì„¸ì´í”„ ì„œë¸Œâ†’ìƒëŒ€ ë°±í•¸ë“œ ìœ ë„)ì„ ì¤€ë¹„í•˜ì„¸ìš”.");
  if(sStreak.maxWinStreak >= 3)  tips.push("ë‹¨ì‹ì—ì„œ ì—°ìŠ¹ ê²½í—˜ì´ ìˆìŠµë‹ˆë‹¤. ë‹¹ì‹œ ë“ì  ë£¨í‹´ì„ ë©”ëª¨í•´ â€˜ì¬í˜„ ê°€ëŠ¥í•œ íŒ¨í„´â€™ìœ¼ë¡œ ì •ë¦¬í•˜ì„¸ìš”.");

  // íŒŒíŠ¸ë„ˆ ì‹œë„ˆì§€
  if(partnerArr[0]) tips.push(`ë³µì‹ì€ <b>${partnerArr[0].name}</b> ì„ ìˆ˜ì™€ì˜ í˜¸í¡ì´ ê°€ì¥ ì¢‹ìŠµë‹ˆë‹¤(ìŠ¹ë¥  ${fmt(partnerArr[0].rate)}%). í•´ë‹¹ ì¡°í•©ì˜ ì„œë¸Œ/ë¦¬í„´ ë£¨í‹´ì„ í‘œì¤€í™”í•˜ì„¸ìš”.`);

  // ë¶„ì„ ì¶œë ¥ HTML
  const html = `
    <div style="font-family:'Pretendard','Noto Sans KR',sans-serif;color:#0f172a;">
      <h3 style="margin:0 0 10px;">ğŸ“ <b>${name}</b> ì„ ìˆ˜ ë¶„ì„(ìŠ¹/íŒ¨ ê¸°ë°˜)</h3>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;">
        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:12px;">
          <h4 style="margin:0 0 6px;color:#2563eb;">ë‹¨ì‹ ìš”ì•½</h4>
          <div>ê²½ê¸° ${sT} | ìŠ¹ë¥  <b>${fmt(sR)}%</b> (${sW}ìŠ¹ ${sT-sW}íŒ¨)</div>
          <div>ìµœì¥ ì—°ìŠ¹: ${sStreak.maxWinStreak} / ìµœì¥ ì—°íŒ¨: ${sStreak.maxLoseStreak}</div>
          <div>í˜„ì¬ íë¦„: ${sStreak.currentStreak}</div>
          <div>ìµœê·¼10 ìŠ¹ë¥ : ${fmt(sMomentum.lastR)}% (ì´ì „10 ëŒ€ë¹„ ${sMomentum.diff>=0?'+':''}${fmt(sMomentum.diff)}%p)</div>
          <div>ë³€ë™ì„±(0~1): ${fmt(sStreak.volatility)}</div>
        </div>

        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:12px;">
          <h4 style="margin:0 0 6px;color:#2563eb;">ë³µì‹ ìš”ì•½</h4>
          <div>ê²½ê¸° ${dT} | ìŠ¹ë¥  <b>${fmt(dR)}%</b> (${dW}ìŠ¹ ${dT-dW}íŒ¨)</div>
          <div>ìµœì¥ ì—°ìŠ¹: ${dStreak.maxWinStreak} / ìµœì¥ ì—°íŒ¨: ${dStreak.maxLoseStreak}</div>
          <div>í˜„ì¬ íë¦„: ${dStreak.currentStreak}</div>
          <div>ìµœê·¼10 ìŠ¹ë¥ : ${fmt(dMomentum.lastR)}% (ì´ì „10 ëŒ€ë¹„ ${dMomentum.diff>=0?'+':''}${fmt(dMomentum.diff)}%p)</div>
          <div>ë³€ë™ì„±(0~1): ${fmt(dStreak.volatility)}</div>
        </div>

        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:12px;">
          <h4 style="margin:0 0 6px;color:#2563eb;">ìƒëŒ€ ë‚œì´ë„(ë‹¨ì‹)</h4>
          <div>ì´ê¸´ ê²½ê¸° ìƒëŒ€ í‰ê·  ë¶€ìˆ˜: ${winOppLv?fmt(winOppLv):'-'}</div>
          <div>ì§„ ê²½ê¸° ìƒëŒ€ í‰ê·  ë¶€ìˆ˜: ${loseOppLv?fmt(loseOppLv):'-'}</div>
          <div style="margin-top:4px;color:#475569;">${oppNote}</div>
        </div>

        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:12px;">
          <h4 style="margin:0 0 6px;color:#2563eb;">ë³µì‹ íŒŒíŠ¸ë„ˆ ì‹œë„ˆì§€(í‘œë³¸â‰¥3)</h4>
          ${partnerArr.length
            ? `<ol style="margin:0;padding-left:18px;">${
                partnerArr.slice(0,5).map(p=>
                  `<li>${p.name} (ë¶€ìˆ˜ ${p.level||'-'}) â€” ${p.total}ê²½ê¸°, ìŠ¹ë¥  <b>${fmt(p.rate)}%</b></li>`
                ).join("")
              }</ol>`
            : `<div>í‘œë³¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.</div>`
          }
        </div>
      </div>

      <div style="background:#f1f5f9;border:1px solid #e2e8f0;border-radius:10px;padding:12px;margin-top:12px;">
        <h4 style="margin:0 0 6px;color:#0f172a;">ğŸ§­ ì½”ì¹­ ê°€ì´ë“œ</h4>
        ${tips.length
          ? `<ul style="margin:6px 0;padding-left:18px;">${tips.map(t=>`<li>${t}</li>`).join("")}</ul>`
          : `<div>í‘œë³¸ì´ ì ì–´ ì¼ë°˜ ê°€ì´ë“œë¥¼ ì œì‹œí•©ë‹ˆë‹¤. ì—°ìŠ¹ êµ¬ê°„ì˜ ë£¨í‹´ì„ ë©”ëª¨í•˜ê³ , ì—°íŒ¨ êµ¬ê°„ì˜ ì²« 3ë³¼ ì„ íƒì„ ë‹¨ìˆœí™”í•´ ë³€ë™ì„±ì„ ë‚®ì¶”ì„¸ìš”.</div>`
        }
      </div>
    </div>
  `;

  document.getElementById("analysisResultData").innerHTML = html;
})();
</script>
</head>
<body>
  <!-- player.htmlì—ì„œ fetch í›„ innerHTMLë¡œ ê°€ì ¸ë‹¤ ì“°ëŠ” ì˜ì—­ -->
  <div id="analysisResultData"></div>
</body>
</html>
