<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ” íƒêµ¬ ìŠ¤íƒ€ì¼ ë¶„ì„</title>
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

<style>
:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb; --card:#fff;
  --accent:#2563eb; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
  --shadow:0 8px 28px rgba(2,6,23,.08);
}
*{box-sizing:border-box}
body{margin:0;font-family:"Pretendard","Noto Sans KR",system-ui,sans-serif;background:var(--bg);color:var(--ink);font-weight:600}
.wrap{max-width:900px;margin:0 auto;padding:16px}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;z-index:9999}
.analysis-wrap{position:relative;z-index:1}
.head-in{max-width:900px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between}
h1{margin:0;font-size:clamp(18px,4vw,22px);color:#1e40af}
.btn{border:1px solid #d1d5db;padding:8px 12px;border-radius:10px;background:#fff;cursor:pointer;font-weight:800}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-top:12px}
.sec-title{font-size:16px;font-weight:900;color:#0f172a;margin:0 0 8px}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#e2efff;color:#1e40af;font-size:12px;font-weight:900}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.kv{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.divider{height:1px;background:#eef2f7;margin:12px 0}
ul.clean{list-style:none;padding:0;margin:0;display:grid;gap:6px}
.small{font-size:13px;color:#475569}
.box{border:1px dashed #e2e8f0;border-radius:12px;padding:12px;background:#fff}

input,textarea,select{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;font:inherit}
label{font-size:12px;color:#475569;font-weight:800;margin-top:8px;display:block}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-12{grid-column:span 12}
.col-6{grid-column:span 6}
@media(max-width:720px){.col-6{grid-column:span 12}}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
<header>
  <div class="head-in">
    <h1>ğŸ” íƒêµ¬ ìŠ¤íƒ€ì¼ ë¶„ì„</h1>
    <div class="row">
      <button class="btn" id="btnBack">â† ê°œì¸ ì„±ì </button>
      <button class="btn" id="btnAdminToggle">ê´€ë¦¬ìëª¨ë“œ</button>
      <span class="badge" id="who"></span>
    </div>
  </div>
</header>

<div class="analysis-wrap">
<main class="wrap">

  <!-- í•µì‹¬ ìš”ì•½/AIì½”ì¹­ ìƒë‹¨ -->
  <section class="card" style="margin-top:12px;">
    <div id="analysisContent"></div>
  </section>

  <!-- í†µí•©ë¦¬ê·¸ ìš”ì•½ -->
  <section class="card">
    <div class="sec-title">ğŸ“… í†µí•©ë¦¬ê·¸ ìš”ì•½</div>
    <div id="integratedBox" class="kv"></div>
    <ul id="integratedBullets" class="clean"></ul>
    <div class="small">â€» í†µí•©ë¦¬ê·¸ëŠ” ì°¸ê³ ìš©ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.</div>
  </section>

  <!-- ì„¸ë¶€ ì„±í–¥ -->
  <section class="card">
    <div class="sec-title">ğŸ¯ ì„¸ë¶€ ì„±í–¥ (ë‹¨ì‹Â·ë³µì‹)</div>
    <div class="grid">
      <div class="col-6">
        <div class="badge">ë‹¨ì‹</div>
        <ul id="singleBullets" class="clean"></ul>
      </div>
      <div class="col-6">
        <div class="badge">ë³µì‹</div>
        <ul id="doubleBullets" class="clean"></ul>
      </div>
    </div>
    <div class="divider"></div>
    <ul id="recommend" class="clean"></ul>
  </section>

  <!-- ê´€ë¦¬ì ì½”ì¹­ ì…ë ¥ (ë¹„ë²ˆ ë³´í˜¸) -->
  <section class="card" id="adminCard" style="display:none">
    <div class="sec-title">ğŸ›  ê´€ë¦¬ì ì½”ì¹­ ì…ë ¥</div>
    <div class="small" style="margin-bottom:10px;">
      ì•„ë˜ ì§ˆë¬¸ì— ë‹µí•˜ë©´ 5ê°í˜• ëŠ¥ë ¥ ê·¸ë˜í”„ì™€ AI ì½”ì¹­ ë©”ì‹œì§€ê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
    </div>

    <label>1) í”Œë ˆì´ ìŠ¤íƒ€ì¼ (ì˜ˆ: ì „ì§„ ê³µê²©í˜•, ì•ˆì •í˜•, ì—°ê²°í˜• ë“±)</label>
    <textarea id="q_style" rows="2" placeholder="ì˜ˆ: ì „ì§„ ê³µê²©í˜•, ì²« ë“œë¼ì´ë¸Œ ì„ í˜¸, ë°± ì•ˆì •ì "></textarea>

    <label>2) ê°•ì  (ì˜ˆ: ì´ˆêµ¬ ë“œë¼ì´ë¸Œ, ì½”ìŠ¤ ê³µëµ, ë ë¦¬ ì§€êµ¬ë ¥)</label>
    <textarea id="q_strengths" rows="2" placeholder="ì˜ˆ: ì´ˆêµ¬ ë“œë¼ì´ë¸Œ, ì½”ìŠ¤ ê³µëµ ëŠ¥ìˆ™, í¬í•¸ë“œ ê²°ì •ë ¥"></textarea>

    <label>3) ì•½ì  (ì˜ˆ: ì§§ì€ ê³µ ë¦¬ì‹œë¸Œ, ê°• ë“œë¼ì´ë¸Œ ì²« ë¸”ë¡, ë°± ì²˜ë¦¬)</label>
    <textarea id="q_weaknesses" rows="2" placeholder="ì˜ˆ: ì§§ì€ ê³µ ë¦¬ì‹œë¸Œ ì„ íƒì§€ ë¶€ì¡±, ì²« ë¸”ë¡ í”ë“¤ë¦¼"></textarea>

    <label>4) ë³µì‹ì—ì„œ ì˜ ë§ëŠ” íŒŒíŠ¸ë„ˆ ìœ í˜•/ì´ë¦„</label>
    <textarea id="q_favs" rows="2" placeholder="ì˜ˆ: ìˆ˜ë¹„ ì•ˆì •í˜• íŒŒíŠ¸ë„ˆ, ê¹€OOì™€ ê¶í•© ì¢‹ìŒ"></textarea>

    <label>5) ì–´ë ¤ìš´ ìƒëŒ€ ìœ í˜•/ì´ë¦„ + ì´ìœ </label>
    <textarea id="q_hards" rows="2" placeholder="ì˜ˆ: ê°•í•œ íšŒì „ ì„œë¸Œ êµ¬ì‚¬ì, í…œí¬ ë¹ ë¥¸ ê³µê²©í˜•(ì´OO)"></textarea>

    <label>6) ì½”ì¹˜ ë©”ëª¨(ê·¸ëŒ€ë¡œ ë©”ì‹œì§€ì— í¬í•¨ë©ë‹ˆë‹¤)</label>
    <textarea id="q_memo" rows="3" placeholder="ì˜ˆ: ì´ˆë°˜ 5í¬ì¸íŠ¸ ì•ˆì •í™”, ë¦¬ì‹œë¸Œ íŒ¨í„´ ë‹¤ì–‘í™” ì§€ë„ ì˜ˆì •"></textarea>

    <button class="btn primary" id="btnSaveAdmin" style="margin-top:12px;">âœ… ì €ì¥í•˜ê¸°</button>
  </section>

  <!-- AI ì½”ì¹­ ë©”ì‹œì§€ -->
  <section class="card">
    <div class="sec-title">ğŸ¤– AI ì½”ì¹­ ë©”ì‹œì§€</div>
    <div class="row" style="gap:8px;align-items:center;margin-bottom:8px">
      <span class="badge">ì½”ì¹˜ í†¤</span>
      <select id="coachTone" class="btn" style="padding:6px 10px">
        <option value="expert">ì „ë¬¸ê°€í˜•</option>
        <option value="emotional">ê°ì„±í˜•</option>
      </select>
      <button class="btn" id="btnRefreshCoach">ê°±ì‹ </button>
    </div>
    <div id="coachMsg" class="small" style="line-height:1.7"></div>
  </section>

  <!-- 5ê°í˜• ëŠ¥ë ¥ ê·¸ë˜í”„ -->
  <section class="card">
    <div class="sec-title">â­ 5ê°í˜• ëŠ¥ë ¥ ê·¸ë˜í”„</div>
    <canvas id="abilityRadar" height="260"></canvas>
    <div class="small" style="margin-top:6px">
      ì¶•: ì„œë¸ŒÂ·ë¦¬ì‹œë¸Œ / ë ë¦¬ ì§€ì†ë ¥ / ê³µê²© ì „í™˜ / ì „ìˆ  ì§€ëŠ¥ / íŒŒíŠ¸ë„ˆì‹­
    </div>
  </section>

</main>
</div>

<script type="module">
/* ============================================
   âœ… Firebase ì´ˆê¸°í™”
===============================================*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};
initializeApp(firebaseConfig);
const db = getDatabase();

/* ============================================
   âœ… ê¸°ë³¸ ì„¤ì •/ìœ í‹¸
===============================================*/
const params = new URLSearchParams(location.search);
const playerName = params.get("name") || "";
document.getElementById("who").textContent = playerName;

const pct = (a,b)=>b?Math.round(a/b*100):0;
const fmt = n=>Math.round(n*10)/10;
const box = document.getElementById("analysisContent");

const $ = (id)=>document.getElementById(id);

/* ============================================
   âœ… ë°ì´í„° ë¡œë“œ
===============================================*/
async function loadAdminMemo(){
  const snap = await get(ref(db,`playerDetail/${playerName}`));
  return snap.exists() ? snap.val() : {};
}
async function saveAdminMemo(q){
  await set(ref(db,`playerDetail/${playerName}`), q);
}

async function loadMonthlyReports(){
  const snap = await get(ref(db,"monthlyReports"));
  if(!snap.exists()) return [];
  const data = snap.val();
  let result=[];
  Object.entries(data).forEach(([month,obj])=>{
    if(!obj.players) return;
    const me = Object.values(obj.players).find(p=>p.name===playerName);
    if(!me) return;
    const win  = Number(me.wins ?? me.win  ?? 0);
    const lose = Number(me.losses ?? me.lose ?? 0);
    result.push({ month, win, lose, total: win+lose, rate: pct(win,win+lose) });
  });
  return result.sort((a,b)=>a.month.localeCompare(b.month));
}

async function loadMatches(){
  const snap = await get(ref(db,"matches"));
  if(!snap.exists()) return [];
  const list = Object.values(snap.val());
  return list.filter(m=>{
    const names=[...(m.namesA||[]), ...(m.namesB||[])];
    return names.includes(playerName);
  });
}

/* ============================================
   âœ… í†µí•© ë¶„ì„/ë Œë”
===============================================*/
function analyzeUnified(reports){
  if(!reports.length) return {
    trend:"ë°ì´í„° ì—†ìŒ", best:null, worst:null, steady:null,
    pattern:"í†µí•© ê¸°ë¡ ë¶€ì¡±ìœ¼ë¡œ ìƒì„¸ ë¶„ì„ ì œí•œ"
  };
  const best = [...reports].sort((a,b)=>b.rate-a.rate)[0];
  const worst= [...reports].sort((a,b)=>a.rate-b.rate)[0];

  let trend="ì•ˆì •ì ";
  if(reports.length>=2){
    const diff = reports.at(-1).rate - reports[0].rate;
    if(diff>=10) trend="ìŠ¹ë¥  ìƒìŠ¹ì„¸";
    else if(diff<=-10) trend="ìŠ¹ë¥  í•˜ë½ì„¸";
  }
  const totals = reports.map(r=>r.total);
  const steady = fmt((Math.min(...totals)/Math.max(...totals))*100);

  let pattern="";
  if(best.rate>=65) pattern="ê¸°ì„¸ë¥¼ íƒ€ë©´ ëª°ì•„ì¹˜ëŠ” í­ë°œí˜• ê²½ê¸°ë ¥.";
  else if(best.rate>=55) pattern="ì „ë°˜ì ìœ¼ë¡œ ì•ˆì •ì ì´ê³  íƒ„íƒ„í•œ ìš´ì˜.";
  else pattern="ì´ˆë°˜ ì‹¤ì  ê²½í–¥ì´ ìˆì–´ ì§‘ì¤‘ë ¥ ê´€ë¦¬ê°€ ì¤‘ìš”.";

  return { trend, best, worst, steady, pattern };
}

function makeAnalysis(reports){
  let out=[];
  let totalWin=0,totalLose=0;
  reports.forEach(r=>{ totalWin+=r.win; totalLose+=r.lose; });
  const allRate=pct(totalWin,totalWin+totalLose);
  const unified=analyzeUnified(reports);
  out.push(`
    <div style="font-size:20px;font-weight:900;margin-bottom:12px;color:#1e3a8a">ğŸ“Œ í•µì‹¬ ìš”ì•½</div>
    <div class="box">
      <b>${playerName}</b> ì„ ìˆ˜ëŠ” í†µí•© ê¸°ì¤€ <b>${allRate}% ìŠ¹ë¥ </b>ì´ë©°,
      ìµœê·¼ íë¦„ì€ <b>${unified.trend}</b>ì…ë‹ˆë‹¤.
    </div>
    <div class="sec-title" style="margin-top:12px">ğŸ“… í†µí•©ë¦¬ê·¸ ë¶„ì„</div>
    <div class="box">
      ${
        reports.length ? `
          ìµœê³  ë‹¬: <b>${unified.best.month}</b> (${unified.best.rate}%)<br>
          ì–´ë ¤ìš´ ë‹¬: <b>${unified.worst.month}</b> (${unified.worst.rate}%)<br><br>
          ê¾¸ì¤€í•¨ ì§€ìˆ˜: <b>${unified.steady}%</b><br><br>
          ${unified.pattern}
        ` : "í†µí•© ë¦¬ê·¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
      }
    </div>
  `);
  return out.join("\n");
}

/* í†µí•© ìš”ì•½ ì¹´ë“œ/ë¶ˆë¦¿ */
function fillUnifiedSummary(reports){
  const wrap=$("integratedBox"), bullets=$("integratedBullets");
  if(!wrap||!bullets) return;
  if(!reports.length){
    wrap.innerHTML=`<div class="small">í†µí•© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    bullets.innerHTML=""; return;
  }
  const totalGames=reports.reduce((t,r)=>t+r.total,0);
  const totalWins =reports.reduce((t,r)=>t+r.win,0);
  const totalLoses=reports.reduce((t,r)=>t+r.lose,0);
  const avgRate=pct(totalWins,totalGames);
  const mostGames=[...reports].sort((a,b)=>b.total-a.total)[0];
  const bestRate =[...reports].sort((a,b)=>b.rate-a.rate)[0];
  const last=reports.at(-1);

  wrap.innerHTML=`
    <div class="row" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px">
      <div class="card" style="padding:12px"><div class="small">ì´ ê²½ê¸°</div>
        <div style="font-size:20px;font-weight:900">${totalGames.toLocaleString()}</div></div>
      <div class="card" style="padding:12px"><div class="small">ìŠ¹ / íŒ¨</div>
        <div style="font-size:20px;font-weight:900">${totalWins}ìŠ¹ ${totalLoses}íŒ¨</div></div>
      <div class="card" style="padding:12px"><div class="small">í‰ê·  ìŠ¹ë¥ </div>
        <div style="font-size:20px;font-weight:900">${avgRate}%</div></div>
    </div>
  `;
  bullets.innerHTML=`
    <li>ê°€ì¥ ë§ì´ ë›´ ë‹¬: <b>${mostGames.month}</b> (${mostGames.total}ê²½ê¸°)</li>
    <li>ìŠ¹ë¥  ìµœê³  ë‹¬: <b>${bestRate.month}</b> (${bestRate.rate}%)</li>
    <li>ìµœê·¼ ë‹¬ ìŠ¹ë¥ : <b>${last.month}</b> (${last.rate}%)</li>
  `;
}

/* ë‹¨ì‹/ë³µì‹/ìƒëŒ€/íŒŒíŠ¸ë„ˆ í†µê³„ */
function buildMatchStats(matches){
  const s={win:0,lose:0}, d={win:0,lose:0};
  const opp={}, partner={}; const ptSet=new Set();
  matches.forEach(m=>{
    const A=m.namesA||[], B=m.namesB||[];
    const isA=A.includes(playerName);
    const won=(m.winnerSide==="A"&&isA)||(m.winnerSide==="B"&&!isA);
    if(m.mode==="single"){
      won?s.win++:s.lose++;
      const other=isA?B[0]:A[0];
      if(other){
        if(!opp[other]) opp[other]={win:0,lose:0};
        won?opp[other].win++:opp[other].lose++;
      }
    }else{
      won?d.win++:d.lose++;
      const same=isA?A:B;
      const pt=same.find(n=>n!==playerName);
      if(pt){
        ptSet.add(pt);
        if(!partner[pt]) partner[pt]={win:0,lose:0};
        won?partner[pt].win++:partner[pt].lose++;
      }
    }
  });
  return {
    singles:{...s,total:s.win+s.lose,rate:pct(s.win,s.win+s.lose)},
    doubles:{...d,total:d.win+d.lose,rate:pct(d.win,d.win+d.lose)},
    partnerDiversity: ptSet.size,
    oppArr:Object.entries(opp),
    partnerArr:Object.entries(partner)
  };
}

/* ì„¸ë¶€ ë¶ˆë¦¿ + ì¶”ì²œ */
function fillDetailBullets(stats){
  const S=stats.singles, D=stats.doubles;
  $("singleBullets").innerHTML=`
    <li>ì´ ê²½ê¸°: <b>${S.total}</b> ( ${S.win}ìŠ¹ ${S.lose}íŒ¨ )</li>
    <li>ìŠ¹ë¥ : <b>${S.rate}%</b></li>
    <li>${S.rate>=55?"ìì‹ ì˜ í…œí¬ ìœ ì§€ ì‹œ ì—°ì† ë“ì ë ¥ ìš°ìˆ˜":"ì´ˆë°˜ íë¦„ ê´€ë¦¬ì™€ ë¦¬ì‹œë¸Œ ì•ˆì •í™”ê°€ í•„ìš”"}</li>
  `;
  $("doubleBullets").innerHTML=`
    <li>ì´ ê²½ê¸°: <b>${D.total}</b> ( ${D.win}ìŠ¹ ${D.lose}íŒ¨ )</li>
    <li>ìŠ¹ë¥ : <b>${D.rate}%</b></li>
    <li>${D.rate>=55?"íŒŒíŠ¸ë„ˆ ì—°ê³„ê°€ ì¢‹ì•„ ê³µê²© ì „í™˜ì´ ë¹ ë¦„":"ì´ˆêµ¬ ì—­í•  ë¶„ë‹´ê³¼ ë¦¬í„´ ìœ„ì¹˜ ì„ ì • ê°œì„  í•„ìš”"}</li>
    <li>íŒŒíŠ¸ë„ˆ ë‹¤ì–‘ì„±: <b>${stats.partnerDiversity}ëª…</b></li>
  `;
  const rec=[];
  if(S.rate>=D.rate){
    rec.push("ë‹¨ì‹ ê°•ì  â†’ ë‹¨ì‹ ë¹„ì¤‘ í™•ëŒ€ ì „ëµ");
    rec.push("ì§§ì€ ê³µ ë¦¬ì‹œë¸Œ ì„ íƒì§€(í‘¸ì‹œ/ì§§ì€ ìŠ¤íŠ¸ë ˆì´íŠ¸/ë°± ë¦¬í”„íŠ¸) ê°•í™”");
  }else{
    rec.push("ë³µì‹ ê°•ì  â†’ ì´ˆêµ¬-2êµ¬ ì—­í•  ëª…í™•í™”ë¡œ ìƒìŠ¹í­ í™•ëŒ€");
    rec.push("ì²« ë¸”ë¡ ì„±ê³µë¥  í–¥ìƒì´ ë‹¨ì‹ì—ë„ ê¸ì •ì  ì˜í–¥");
  }
  $("recommend").innerHTML=rec.map(v=>`<li>${v}</li>`).join("");
}

/* ============================================
   âœ… ëŠ¥ë ¥ì¹˜ ì‚°ì¶œ/ë ˆì´ë‹¤ ì°¨íŠ¸/ì½”ì¹˜ ë©”ì‹œì§€
===============================================*/
function scoreFromAdminAndStats(admin={}, stats={}, reports=[]){
  const S=stats.singles||{rate:0}, D=stats.doubles||{rate:0};
  // ê¸°ë³¸: ìŠ¹ë¥  ê¸°ë°˜ ê°€ì¤‘ì¹˜
  let SR=40+S.rate*0.3;        // ì„œë¸ŒÂ·ë¦¬ì‹œë¸Œ
  let RALLY=35+S.rate*0.25;    // ë ë¦¬ ì§€ì†ë ¥
  let TRANS=35+D.rate*0.25;    // ê³µê²© ì „í™˜
  let TACTICS=30+(S.rate+D.rate)*0.1; // ì „ìˆ  ì§€ëŠ¥
  let PARTNER=30+D.rate*0.3;   // íŒŒíŠ¸ë„ˆì‹­

  const text = [
    admin.q_style||"", admin.q_strengths||"", admin.q_weaknesses||"",
    admin.q_favs||"", admin.q_hards||""
  ].join(" ").toLowerCase();

  const inc = (keys, amt, v)=> keys.some(k=>text.includes(k)) ? v+amt : v;
  SR      = inc(["ë¦¬ì‹œë¸Œ","ì„œë¸Œ","ì§§ì€","ì§§ê²Œ"], 8, SR);
  RALLY   = inc(["ë ë¦¬","ì§€êµ¬ë ¥","ë²„í‹´"], 8, RALLY);
  TRANS   = inc(["ì „í™˜","ë¸”ë¡","ì¹´ìš´í„°","ì´ˆêµ¬"], 8, TRANS);
  TACTICS = inc(["ì „ìˆ ","ì½”ìŠ¤","ìœ í˜•","í…œí¬"], 7, TACTICS);
  PARTNER = inc(["íŒŒíŠ¸ë„ˆ","ì—°ê³„","ê¶í•©","ë”ë¸”ìŠ¤","ë³µì‹"], 8, PARTNER);

  const clamp = v=>Math.min(95,Math.max(20,Math.round(v)));
  return {
    labels:["ì„œë¸ŒÂ·ë¦¬ì‹œë¸Œ","ë ë¦¬ ì§€ì†ë ¥","ê³µê²© ì „í™˜","ì „ìˆ  ì§€ëŠ¥","íŒŒíŠ¸ë„ˆì‹­"],
    data:[SR,RALLY,TRANS,TACTICS,PARTNER].map(clamp)
  };
}

let radarChart=null;
function drawAbilityRadar(scores){
  const ctx = $("abilityRadar");
  if(radarChart) radarChart.destroy();
  radarChart = new Chart(ctx,{
    type:"radar",
    data:{
      labels:scores.labels,
      datasets:[{
        label:"ëŠ¥ë ¥ì¹˜",
        data:scores.data,
        fill:true,
        backgroundColor:"rgba(37,99,235,0.15)",
        borderColor:"rgba(37,99,235,0.9)",
        pointBackgroundColor:"rgba(37,99,235,1)"
      }]
    },
    options:{
      plugins:{legend:{display:false}},
      scales:{r:{suggestedMin:0,suggestedMax:100,ticks:{display:false}}}
    }
  });
}

function generateCoachMessage(admin={}, stats={}, reports=[], tone="expert"){
  const S=stats.singles||{rate:0}, D=stats.doubles||{rate:0};
  const last=reports.at(-1)||{month:"-", rate:0};
  const pivot = S.rate>=D.rate ? "ë‹¨ì‹ ì¤‘ì‹¬ ìš´ì˜ì´ ìœ ë¦¬í•©ë‹ˆë‹¤." : "ë³µì‹ì—ì„œì˜ ê°•ì ì„ íŒ€ ì „ëµì— ë” ë°˜ì˜í•˜ì„¸ìš”.";

  let msg="";
  if(tone==="expert"){
    msg = `
      <b>í”Œë ˆì´ ìŠ¤íƒ€ì¼</b>: ${admin.q_style||"ì •ë³´ ì—†ìŒ"}<br>
      <b>ê°•ì </b>: ${admin.q_strengths||"ì •ë³´ ì—†ìŒ"}<br>
      <b>ì•½ì </b>: ${admin.q_weaknesses||"ì •ë³´ ì—†ìŒ"}<br>
      <b>ë³µì‹ íŒŒíŠ¸ë„ˆ</b>: ${admin.q_favs||"-"}<br>
      <b>ì–´ë ¤ìš´ ìƒëŒ€</b>: ${admin.q_hards||"-"}<br><br>
      ğŸ“Š <b>ìµœê·¼ (${last.month}) ìŠ¹ë¥ :</b> ${last.rate}%<br>
      ğŸ” <b>ì „ëµ ì œì•ˆ</b>: ${pivot}<br><br>
      ğŸ“ <b>ì½”ì¹˜ ë©”ëª¨</b>: ${admin.q_memo||"-"}
    `;
  }else{
    msg = `
      ${playerName}ë‹˜, ${last.month}ì˜ íë¦„ì€ ìŠ¹ë¥  <b>${last.rate}%</b>ì˜ˆìš”.<br><br>
      ë‹¹ì‹ ì˜ ê°•ì  <b>${admin.q_strengths||"ê°•ì "}</b>ì„(ë¥¼) ë” ë¹›ë‚˜ê²Œ í•˜ë ¤ë©´,
      <b>${admin.q_weaknesses||"ë³´ì™„ í¬ì¸íŠ¸"}</b>ë¥¼ ì²œì²œíˆ ë‹¤ë“¬ì–´ ë³´ì„¸ìš”.<br>
      ë³µì‹ì—ì„œëŠ” <b>${admin.q_favs||"ì¢‹ì€ íŒŒíŠ¸ë„ˆ ìœ í˜•"}</b>ê³¼ ë¦¬ë“¬ì„ ë§ì¶”ê³ ,
      ê¹Œë‹¤ë¡œìš´ <b>${admin.q_hards||"ìƒëŒ€"}</b> ì•ì—ì„œëŠ” í…œí¬ë¥¼ ìƒì§€ ì•ŠëŠ” ê²Œ í•µì‹¬ì…ë‹ˆë‹¤.<br><br>
      ğŸ’¬ <b>ì½”ì¹˜ ë©”ëª¨</b>: ${admin.q_memo||"ì˜¤ëŠ˜ì˜ í¬ì¸íŠ¸ë¥¼ ë§ˆìŒì— ë‹´ì•„ ë³´ì„¸ìš”."}
    `;
  }
  $("coachMsg").innerHTML = msg;
}

/* ê°±ì‹  í—ˆë¸Œ */
function updateRadarAndCoach(admin, stats, reports){
  const scores = scoreFromAdminAndStats(admin, stats, reports);
  drawAbilityRadar(scores);
  const tone = $("coachTone").value || "expert";
  generateCoachMessage(admin, stats, reports, tone);
}

/* ============================================
   âœ… ì‹¤í–‰ë¶€
===============================================*/
let __reports=[], __matches=[], __stats={}, __admin={};

(async ()=>{
  box.innerHTML="ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";
  __reports = await loadMonthlyReports();
  __matches = await loadMatches();
  __admin   = await loadAdminMemo();

  // í™”ë©´ ì±„ì›€
  box.innerHTML = makeAnalysis(__reports);
  fillUnifiedSummary(__reports);
  __stats = buildMatchStats(__matches);
  fillDetailBullets(__stats);

  // ê´€ë¦¬ì í•„ë“œ ì£¼ì…(q_ í†µì¼)
  $("q_style").value      = __admin.q_style||"";
  $("q_strengths").value  = __admin.q_strengths||"";
  $("q_weaknesses").value = __admin.q_weaknesses||"";
  $("q_favs").value       = __admin.q_favs||"";
  $("q_hards").value      = __admin.q_hards||"";
  $("q_memo").value       = __admin.q_memo||"";

  // ì´ˆê¸° ë ˆì´ë‹¤/ì½”ì¹˜ ë©”ì‹œì§€
  updateRadarAndCoach(__admin, __stats, __reports);
})();

/* ============================================
   âœ… ìƒë‹¨ ë²„íŠ¼ / ê´€ë¦¬ìëª¨ë“œ (ë¹„ë²ˆ)
===============================================*/
document.addEventListener("DOMContentLoaded", ()=>{
  $("btnBack").addEventListener("click", ()=>{
    location.href = `player.html?name=${encodeURIComponent(playerName)}`;
  });

  let adminOn=false;
  async function loadAdminPassword(){
    const snap = await get(ref(db,"config/adminPassword"));
    return snap.exists()?snap.val():null;
  }

  $("btnAdminToggle").addEventListener("click", async ()=>{
    if(!adminOn){
      const pw = await loadAdminPassword();
      if(!pw){ alert("âš  ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
      const input = prompt("ğŸ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
      if(input===null) return;
      if(input.trim()!==pw.trim()){ alert("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
      adminOn=true;
      $("adminCard").style.display="block";
      $("btnAdminToggle").classList.add("primary");
      $("btnAdminToggle").textContent="ê´€ë¦¬ìëª¨ë“œ ON";
      alert("âœ… ê´€ë¦¬ìëª¨ë“œ í™œì„±í™”");
    }else{
      adminOn=false;
      $("adminCard").style.display="none";
      $("btnAdminToggle").classList.remove("primary");
      $("btnAdminToggle").textContent="ê´€ë¦¬ìëª¨ë“œ";
    }
  });

  // ì €ì¥
  $("btnSaveAdmin").addEventListener("click", async ()=>{
    const data = {
      q_style: $("q_style").value.trim(),
      q_strengths: $("q_strengths").value.trim(),
      q_weaknesses: $("q_weaknesses").value.trim(),
      q_favs: $("q_favs").value.trim(),
      q_hards: $("q_hards").value.trim(),
      q_memo: $("q_memo").value.trim()
    };
    await saveAdminMemo(data);
    __admin = data; // ë¡œì»¬ ìµœì‹ í™”
    alert("âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
    updateRadarAndCoach(__admin, __stats, __reports);
  });

  // ì½”ì¹˜ í†¤ ë³€ê²½/ê°±ì‹ 
  $("coachTone").addEventListener("change", ()=>{
    updateRadarAndCoach(__admin, __stats, __reports);
  });
  $("btnRefreshCoach").addEventListener("click", ()=>{
    updateRadarAndCoach(__admin, __stats, __reports);
  });
});
</script>
</body>
</html>
