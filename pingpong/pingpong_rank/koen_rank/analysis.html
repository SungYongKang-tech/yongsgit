<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ” íƒêµ¬ ìŠ¤íƒ€ì¼ ë¶„ì„</title>
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

<style>
:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb; --card:#fff;
  --accent:#2563eb; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
  --shadow:0 8px 28px rgba(2,6,23,.08);
}
body{margin:0;font-family:"Pretendard","Noto Sans KR";background:var(--bg);color:var(--ink);font-weight:600}
.wrap{max-width:900px;margin:0 auto;padding:16px}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;z-index:9999}
.head-in{max-width:900px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between}
h1{margin:0;font-size:20px;color:#1e40af;font-weight:900}
.btn{border:1px solid #d1d5db;padding:8px 12px;border-radius:10px;background:#fff;cursor:pointer;font-weight:800}
.btn.primary{background:var(--accent);color:#fff}
.card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-top:12px}
.sec-title{font-size:16px;font-weight:900;color:#0f172a;margin-bottom:8px}
.badge{padding:4px 8px;border-radius:999px;background:#e2efff;color:#1e40af;font-size:12px;font-weight:900}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,textarea{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
label{font-size:12px;color:#475569;font-weight:800}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-6{grid-column:span 6}
.col-12{grid-column:span 12}
@media(max-width:720px){.col-6{grid-column:span 12}}
.box{padding:12px;background:#f1f5f9;border-radius:12px}
</style>
</head>

<body>
<header>
  <div class="head-in">
    <h1>ğŸ” íƒêµ¬ ìŠ¤íƒ€ì¼ ë¶„ì„</h1>
    <div class="row">
      <button class="btn" id="btnBack">â† ê°œì¸ ì„±ì </button>
      <button class="btn" id="btnAdminToggle">ê´€ë¦¬ìëª¨ë“œ</button>
      <span class="badge" id="who"></span>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- âœ… AI ì½”ì¹˜ ë¶„ì„ ì¶œë ¥ ì˜ì—­ -->
  <section class="card">
    <div id="analysisContent">AI ë¶„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
  </section>

  <!-- âœ… ê´€ë¦¬ì ì…ë ¥ ì˜ì—­ -->
  <section class="card" id="adminCard" style="display:none;">
    <div class="sec-title">ğŸ›  ê´€ë¦¬ì ê¸°ìˆ  ë©”ëª¨</div>

    <div class="grid">
      <div class="col-6">
        <label>íƒ€ë²• / ê·¸ë¦½</label>
        <input id="ad_grip" placeholder="ì˜ˆ: ì˜¤ë¥¸ì† ì‰ì´í¬">
      </div>

      <div class="col-6">
        <label>êµ¬ë ¥</label>
        <input id="ad_years" placeholder="ì˜ˆ: 3ë…„">
      </div>

      <div class="col-6">
        <label>ë ˆìŠ¨ ì—¬ë¶€</label>
        <input id="ad_lesson" placeholder="ì˜ˆ: ì£¼1íšŒ ë ˆìŠ¨ ì¤‘">
      </div>

      <div class="col-6">
        <label>í˜„ì¬ í¼(ì»¨ë””ì…˜)</label>
        <input id="ad_form" placeholder="ì˜ˆ: ë“œë¼ì´ë¸Œ íƒ€ì´ë° ì¢‹ì•„ì§">
      </div>

      <div class="col-6">
        <label>ê¸°ìˆ  ê°•ì </label>
        <input id="ad_strong" placeholder="ì˜ˆ: ì´ˆêµ¬ ë“œë¼ì´ë¸Œ, ì „ì§„ í”Œë¦­">
      </div>

      <div class="col-6">
        <label>ê¸°ìˆ  ì•½ì </label>
        <input id="ad_weak" placeholder="ì˜ˆ: ë°± ì „í™˜ ëŠë¦¼">
      </div>

      <div class="col-12">
        <label>ê¸°íƒ€ ë©”ëª¨</label>
        <textarea id="ad_memo" rows="3" placeholder="ì˜ˆ: ìµœê·¼ ë¼ì¼“ êµì²´ í›„ ì ì‘ ì¤‘â€¦"></textarea>
      </div>
    </div>

    <button class="btn primary" id="btnSaveAdmin" style="margin-top:12px;">ì €ì¥</button>
  </section>

</main>


<!-- âœ… Firebase + JS -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { 
  getDatabase, ref, get, set 
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

/* âœ… Firebase */
const firebaseConfig = {
  apiKey:"AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain:"pingpongclub-4a5fd.firebaseapp.com",
  databaseURL:"https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId:"pingpongclub-4a5fd",
  storageBucket:"pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId:"802826774007",
  appId:"1:802826774007:web:ca4d05be778eeaf1723af2"
};

initializeApp(firebaseConfig);
const db = getDatabase();

/* âœ… URL íŒŒë¼ë¯¸í„° */
const params = new URLSearchParams(location.search);
const playerName = params.get("name") || "";
document.getElementById("who").textContent = playerName;

/* ====================================================================
      1) ê´€ë¦¬ì ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°
==================================================================== */
async function loadAdminMemo() {
  const snap = await get(ref(db, `playerDetail/${playerName}`));
  return snap.exists() ? snap.val() : {};
}

/* ====================================================================
      2) ê²½ê¸° ë°ì´í„°(í†µí•©/ë‹¨ì‹/ë³µì‹) ë¶ˆëŸ¬ì˜¤ê¸°
==================================================================== */
async function loadMatchData() {
  const snap = await get(ref(db, "matches"));
  if (!snap.exists()) return [];

  const all = Object.values(snap.val());
  return all.filter(m => {
    const A = m.namesA || [];
    const B = m.namesB || [];
    return [...A, ...B].includes(playerName);
  });
}

/* ====================================================================
      3) ë°ì´í„° ë¶„ì„ í•¨ìˆ˜
==================================================================== */
function analyzeData(matches) {

  let totalWin=0, totalLose=0;
  let singleWin=0, singleLose=0;
  let doubleWin=0, doubleLose=0;

  let opp = {};
  let partner = {};

  matches.forEach(m => {
    const A = m.namesA || [];
    const B = m.namesB || [];
    const inA = A.includes(playerName);
    const won = (m.winnerSide==="A" && inA) || (m.winnerSide==="B" && !inA);

    if (won) totalWin++; else totalLose++;

    if (m.mode === "single") {
      if (won) singleWin++; else singleLose++;
      const other = inA ? B[0] : A[0];
      if (other) {
        if (!opp[other]) opp[other]={w:0,l:0};
        if (won) opp[other].w++; else opp[other].l++;
      }
    } else {
      if (won) doubleWin++; else doubleLose++;
      const same = inA ? A : B;
      const pt = same.find(n => n !== playerName);
      if (pt) {
        if (!partner[pt]) partner[pt]={w:0,l:0};
        if (won) partner[pt].w++; else partner[pt].l++;
      }
    }
  });

  return {
    totalWin, totalLose,
    totalRate: (totalWin+totalLose)? Math.round(totalWin/(totalWin+totalLose)*100):0,

    singleWin, singleLose,
    singleRate:(singleWin+singleLose)? Math.round(singleWin/(singleWin+singleLose)*100):0,

    doubleWin, doubleLose,
    doubleRate:(doubleWin+doubleLose)? Math.round(doubleWin/(doubleWin+doubleLose)*100):0,

    opp, partner
  };
}

/* ====================================================================
      4) AI ì½”ì¹˜ ë¬¸ì¥ ìƒì„± (ë¬¸ë‹¨í˜•, ê¸¸ê³  ê¹Šê²Œ)
==================================================================== */
function makeCoachParagraph(admin, stats) {

  let t = "";

  // âœ… ì¸íŠ¸ë¡œ
  t += `${playerName} ì„ ìˆ˜ëŠ” `;
  if (admin.grip) t += `${admin.grip} ìŠ¤íƒ€ì¼ì„ ê¸°ë°˜ìœ¼ë¡œ í•˜ë©°, `;
  if (admin.years) t += `êµ¬ë ¥ì€ ì•½ ${admin.years} ì •ë„ë¡œ ë³´ì¸ë‹¤. `;
  if (admin.lesson) t += `í˜„ì¬ëŠ” ${admin.lesson} ìƒíƒœì—ì„œ ê¸°ìˆ  ì™„ì„±ë„ë¥¼ ë†’ì´ê³  ìˆìœ¼ë©°, `;
  t += "ì „ë°˜ì ìœ¼ë¡œ ê²½ê¸° ìš´ì˜ì—ì„œ ë“œëŸ¬ë‚˜ëŠ” íŒ¨í„´ì´ ë¶„ëª…í•œ ì„ ìˆ˜ì´ë‹¤. ";

  // âœ… ì„±í–¥ ë¶„ì„
  if (stats.totalWin + stats.totalLose > 0) {
    t += `ì „ì²´ ìŠ¹ë¥ ì€ ì•½ ${stats.totalRate}%ë¡œ, `;
    if (stats.singleRate > stats.doubleRate) {
      t += `ë‹¨ì‹ì—ì„œ ë” ì•ˆì •ì ì¸ ê²½ê¸°ë ¥ì„ ë³´ì´ë©°, ë ë¦¬ íë¦„ì„ ì£¼ë„í•˜ëŠ” ê²½í–¥ì´ ê°•í•˜ë‹¤. `;
    } else {
      t += `ë³µì‹ì—ì„œ ì˜¤íˆë ¤ ë†’ì€ ì™„ì„±ë„ë¥¼ ë³´ì´ë©°, íŒ€ì›Œí¬ ê¸°ë°˜ í”Œë ˆì´ì—ì„œ ê°•ì ì´ ë“œëŸ¬ë‚œë‹¤. `;
    }
  }

  // âœ… ê´€ë¦¬ì ë©”ëª¨ ê¸°ë°˜ í™•ì¥
  if (admin.form) t += `ìµœê·¼ ì»¨ë””ì…˜ì€ "${admin.form}" ëª¨ìŠµì´ ëšœë ·í•˜ë©°, `;
  if (admin.strong) t += `íŠ¹íˆ ${admin.strong}ëŠ” ê²½ê¸° ë‚´ë‚´ ì¤‘ìš”í•œ ë“ì  ë£¨íŠ¸ë¡œ ì‘ìš©í•œë‹¤. `;
  if (admin.weak) t += `ë°˜ë©´ ${admin.weak} ë¶€ë¶„ì€ ìƒëŒ€ ìƒìœ„ê¶Œ ì„ ìˆ˜ë“¤ì—ê²Œ ì§‘ì¤‘ì ìœ¼ë¡œ ê³µëµë‹¹í•  ê°€ëŠ¥ì„±ì´ ìˆë‹¤. `;

  // âœ… ê¸°íƒ€ ë©”ëª¨
  if (admin.memo) t += `${admin.memo} `;

  return `<div class="box" style="font-size:15px;line-height:1.7">${t}</div>`;
}

/* ====================================================================
      5) ë°ì´í„°(ìŠ¹ë¥ /ìƒëŒ€/íŒŒíŠ¸ë„ˆ) ìš”ì•½ ë°•ìŠ¤
==================================================================== */
function makeSummaryBoxes(stats) {
  return `
  <div class="sec-title">ğŸ“Œ í†µí•© ìš”ì•½</div>
  <div class="box">
    ì „ì²´: ${stats.totalWin}ìŠ¹ ${stats.totalLose}íŒ¨ (ìŠ¹ë¥  ${stats.totalRate}%)
  </div>

  <div class="sec-title">ğŸ“Œ ë‹¨ì‹</div>
  <div class="box">
    ${stats.singleWin}ìŠ¹ ${stats.singleLose}íŒ¨ (ìŠ¹ë¥  ${stats.singleRate}%)
  </div>

  <div class="sec-title">ğŸ“Œ ë³µì‹</div>
  <div class="box">
    ${stats.doubleWin}ìŠ¹ ${stats.doubleLose}íŒ¨ (ìŠ¹ë¥  ${stats.doubleRate}%)
  </div>
  `;
}

/* ====================================================================
      6) ì‹¤í–‰
==================================================================== */
(async () => {

  const adminMemo = await loadAdminMemo();
  const matches = await loadMatchData();
  const stats = analyzeData(matches);

  let html = "";

  // âœ… AI ì½”ì¹˜ ë¬¸ë‹¨
  html += `<div class="sec-title" style="font-size:18px">ğŸ¤– AI ì½”ì¹˜ ë¶„ì„</div>`;
  html += makeCoachParagraph(adminMemo, stats);

  // âœ… ë°ì´í„° ìš”ì•½
  html += makeSummaryBoxes(stats);

  document.getElementById("analysisContent").innerHTML = html;

})();
</script>


</body>
</html>
