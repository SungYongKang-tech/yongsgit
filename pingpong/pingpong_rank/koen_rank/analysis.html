<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ” íƒêµ¬ ìŠ¤íƒ€ì¼ ë¶„ì„</title>
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

<style>
/* ì „ì²´ ìŠ¤íƒ€ì¼ (ìƒëµ ì—†ì´ ì™„ì „ ë²„ì „) */
:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb; --card:#fff;
  --accent:#2563eb; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
  --shadow:0 8px 28px rgba(2,6,23,.08);
}
*{box-sizing:border-box}
body{margin:0;font-family:"Pretendard","Noto Sans KR",system-ui,sans-serif;background:var(--bg);color:var(--ink);font-weight:600}
.wrap{max-width:900px;margin:0 auto;padding:16px}
header{
  position:sticky;
  top:0;
  background:#fff;
  border-bottom:1px solid #e5e7eb;
  z-index:9999;
}
.analysis-wrap{ position:relative; z-index:1; }
.head-in{max-width:900px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between}
h1{margin:0;font-size:clamp(18px,4vw,22px);color:#1e40af}
.btn{border:1px solid #d1d5db;padding:8px 12px;border-radius:10px;background:#fff;cursor:pointer;font-weight:800}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-top:12px}
.sec-title{font-size:16px;font-weight:900;color:#0f172a;margin:0 0 8px}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#e2efff;color:#1e40af;font-size:12px;font-weight:900}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.kv{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.divider{height:1px;background:#eef2f7;margin:12px 0}
ul.clean{list-style:none;padding:0;margin:0;display:grid;gap:6px}
.small{font-size:13px;color:#475569}

input,textarea{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;font:inherit}
label{font-size:12px;color:#475569;font-weight:800}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-12{grid-column:span 12}
.col-6{grid-column:span 6}
@media(max-width:720px){.col-6{grid-column:span 12}}
</style>
</head>

<body>
<header>
  <div class="head-in">
    <h1>ğŸ” íƒêµ¬ ìŠ¤íƒ€ì¼ ë¶„ì„</h1>
    <div class="row">
      <button class="btn" id="btnBack">â† ê°œì¸ ì„±ì </button>
      <button class="btn" id="btnAdminToggle">ê´€ë¦¬ìëª¨ë“œ</button>
      <span class="badge" id="who"></span>
    </div>
  </div>
</header>

<div class="analysis-wrap">
<main class="wrap">

  <section class="card" style="margin-top:12px;">
    <div id="analysisContent"></div>
  </section>

  <section class="card">
    <div class="sec-title">ğŸ“… í†µí•©ë¦¬ê·¸ ìš”ì•½</div>
    <div id="integratedBox" class="kv"></div>
    <ul id="integratedBullets" class="clean"></ul>
    <div class="small">â€» í†µí•©ë¦¬ê·¸ëŠ” ì°¸ê³ ìš©ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.</div>
  </section>

  <section class="card">
    <div class="sec-title">ğŸ¯ ì„¸ë¶€ ì„±í–¥ (ë‹¨ì‹Â·ë³µì‹)</div>
    <div class="grid">
      <div class="col-6">
        <div class="badge">ë‹¨ì‹</div>
        <ul id="singleBullets" class="clean"></ul>
      </div>
      <div class="col-6">
        <div class="badge">ë³µì‹</div>
        <ul id="doubleBullets" class="clean"></ul>
      </div>
    </div>
    <div class="divider"></div>
    <ul id="recommend" class="clean"></ul>
  </section>

  <section class="card" id="adminCard" style="display:none">
    <div class="sec-title">ğŸ›  ê´€ë¦¬ì ë©”ëª¨</div>
    <div class="grid">
      <div class="col-6">
        <label>ìŠ¤íƒ€ì¼</label>
        <input id="ad_style" placeholder="ì˜ˆ: ê³µê²©í˜•, ì•ˆì •í˜•">
      </div>
      <div class="col-6">
        <label>ì„ í˜¸ íŒŒíŠ¸ë„ˆ</label>
        <input id="ad_favs" placeholder="í™ê¸¸ë™, ê¹€ì˜í¬">
      </div>
      <div class="col-6">
        <label>ê°•ì </label>
        <input id="ad_strengths" placeholder="ì´ˆêµ¬ ë“œë¼ì´ë¸Œ, ë°œë¹ ë¦„">
      </div>
      <div class="col-6">
        <label>ì•½ì </label>
        <input id="ad_weaknesses" placeholder="ë°± ì»¤íŠ¸, ë¦¬ì‹œë¸Œ">
      </div>
      <div class="col-12">
        <label>ì–´ë ¤ìš´ ìƒëŒ€</label>
        <input id="ad_hards" placeholder="ì´ìƒì¤€, ë°•ë‚˜ë ¹">
      </div>
      <div class="col-12">
        <label>ë©”ëª¨</label>
        <textarea id="ad_memo" rows="3" placeholder="ì „ì§„ ê³µê²© ìœ„ì£¼â€¦"></textarea>
      </div>
    </div>

    <button class="btn primary" id="btnSaveAdmin" style="margin-top:12px;">ì €ì¥</button>
  </section>

</main>
</div>


<script type="module">
/* ============================================
   âœ… Firebase ì´ˆê¸°í™”
===============================================*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};

initializeApp(firebaseConfig);
const db = getDatabase();


/* ============================================
   âœ… ê¸°ë³¸ ì„¤ì •
===============================================*/
let reports = [];
let matches = [];
let stats = {};

const params = new URLSearchParams(location.search);
const playerName = params.get("name") || "";
document.getElementById("who").textContent = playerName;

const pct = (a, b) => (b ? Math.round(a / b * 100) : 0);
const fmt = n => Math.round(n * 10) / 10;

const box = document.getElementById("analysisContent");


/* ============================================
   âœ… ê´€ë¦¬ì ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°
===============================================*/
async function loadAdminMemo() {
  const snap = await get(ref(db, `playerDetail/${playerName}`));
  return snap.exists() ? snap.val() : {};
}


/* ============================================
   âœ… ê´€ë¦¬ì ë©”ëª¨ ì €ì¥
===============================================*/
document.getElementById("btnSaveAdmin")?.addEventListener("click", async () => {
  const data = {
    style: document.getElementById("ad_style").value.trim(),
    favs: document.getElementById("ad_favs").value.trim(),
    strengths: document.getElementById("ad_strengths").value.trim(),
    weaknesses: document.getElementById("ad_weaknesses").value.trim(),
    hards: document.getElementById("ad_hards").value.trim(),
    memo: document.getElementById("ad_memo").value.trim()
  };

  await set(ref(db, `playerDetail/${playerName}`), data);

  alert("âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
});


/* ============================================
   âœ…  í†µí•©ë¦¬ê·¸ ë°ì´í„° ë¡œë“œ
===============================================*/
async function loadMonthlyReports() {
  const snap = await get(ref(db, "monthlyReports"));
  if (!snap.exists()) return [];

  const data = snap.val();
  let result = [];

  Object.entries(data).forEach(([month, obj]) => {
    if (!obj.players) return;
    const me = Object.values(obj.players).find(p => p.name === playerName);
    if (!me) return;

    const win = Number(me.wins ?? me.win ?? 0);
    const lose = Number(me.losses ?? me.lose ?? 0);

    result.push({
      month, win, lose,
      total: win + lose,
      rate: pct(win, win + lose)
    });
  });

  return result.sort((a, b) => a.month.localeCompare(b.month));
}


/* ============================================
   âœ… ë‹¨ì‹/ë³µì‹ ê²½ê¸° ë¡œë“œ
===============================================*/
async function loadMatches() {
  const snap = await get(ref(db, "matches"));
  if (!snap.exists()) return [];

  const list = Object.values(snap.val());
  return list.filter(m => {
    const names = [...(m.namesA || []), ...(m.namesB || [])];
    return names.includes(playerName);
  });
}


/* ============================================
   âœ… í†µí•©ë¦¬ê·¸ ë¶„ì„
===============================================*/
function analyzeUnified(reports) {

  if (!reports.length) return {
    trend: "ë°ì´í„° ì—†ìŒ",
    best: null,
    worst: null,
    steady: null,
    pattern: "í†µí•© ê¸°ë¡ì´ ë¶€ì¡±í•˜ì—¬ ì„±í–¥ ë¶„ì„ì´ ì œí•œë©ë‹ˆë‹¤."
  };

  const best = [...reports].sort((a, b) => b.rate - a.rate)[0];
  const worst = [...reports].sort((a, b) => a.rate - b.rate)[0];

  let trend = "ì•ˆì •ì ";
  if (reports.length >= 2) {
    const diff = reports.at(-1).rate - reports[0].rate;
    if (diff >= 10) trend = "ìŠ¹ë¥  ìƒìŠ¹ì„¸";
    else if (diff <= -10) trend = "ìŠ¹ë¥  í•˜ë½ì„¸";
  }

  const totals = reports.map(r => r.total);
  const steady = fmt((Math.min(...totals) / Math.max(...totals)) * 100);

  let pattern = "";
  if (best.rate >= 65) pattern = "ì»¨ë””ì…˜ ì¢‹ì„ ë•Œ ëª°ì•„ì¹˜ëŠ” í­ë°œí˜• ê²½ê¸°ë ¥.";
  else if (best.rate >= 55) pattern = "ì „ë°˜ì ìœ¼ë¡œ ì•ˆì •ì ì¸ ê²½ê¸° íë¦„.";
  else pattern = "ì´ˆë°˜ ì‹¤ì  ê²½í–¥ì´ ìˆìœ¼ë©° ì§‘ì¤‘ë ¥ì´ ë§¤ìš° ì¤‘ìš”.";

  return { trend, best, worst, steady, pattern };
}


/* ============================================
   âœ… HTML ìƒì„± â€” ì „ì²´ ë¶„ì„
===============================================*/
function makeAnalysis(reports, matches, adminMemo, stats) {

  let out = [];

  /* âœ… í†µí•© ì§‘ê³„ */
  let totalWin = 0, totalLose = 0;
  reports.forEach(r => { totalWin += r.win; totalLose += r.lose; });

  const allRate = pct(totalWin, totalWin + totalLose);
  const unified = analyzeUnified(reports);

  /* âœ… í—¤ë“œë¼ì¸ */
  out.push(`
    <div style="font-size:20px;font-weight:900;margin-bottom:12px;color:#1e3a8a">
      ğŸ“Œ í•µì‹¬ ìš”ì•½
    </div>
    <div class="box">
      <b>${playerName}</b> ì„ ìˆ˜ëŠ” í†µí•© ê¸°ì¤€ <b>${allRate}% ìŠ¹ë¥ </b>ì„ ê¸°ë¡ ì¤‘ì´ë©°,
      ìµœê·¼ íë¦„ì€ <b>${unified.trend}</b>ì…ë‹ˆë‹¤.
    </div>
  `);

  /* âœ… í†µí•©ë¦¬ê·¸ */
  out.push(`
    <div class="sec-title">ğŸ“… í†µí•©ë¦¬ê·¸ ë¶„ì„</div>
    <div class="box">
      ${
        reports.length
        ? `
          ìµœê³  ì„±ì  ë‹¬: <b>${unified.best.month}</b> (${unified.best.rate}%)<br>
          ì–´ë ¤ì› ë˜ ë‹¬: <b>${unified.worst.month}</b> (${unified.worst.rate}%)<br><br>
          ê¾¸ì¤€í•¨ ì§€ìˆ˜: <b>${unified.steady}%</b><br><br>
          ${unified.pattern}
        `
        : "í†µí•© ë¦¬ê·¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
      }
    </div>
  `);

  /* âœ… ë‹¨ì‹/ë³µì‹ ë¶„ì„ */
  let sWin=0, sLose=0, dWin=0, dLose=0;
  let opp={}, partner={};

  matches.forEach(m => {
    const A = m.namesA || [];
    const B = m.namesB || [];
    const isA = A.includes(playerName);
    const won = (m.winnerSide === "A" && isA) || (m.winnerSide === "B" && !isA);

    if (m.mode === "single") {
      if (won) sWin++; else sLose++;
      const other = isA ? B[0] : A[0];
      if (other) {
        if (!opp[other]) opp[other] = { win:0, lose:0 };
        won ? opp[other].win++ : opp[other].lose++;
      }
    } else {
      if (won) dWin++; else dLose++;
      const same = isA ? A : B;
      const pt = same.find(n => n !== playerName);
      if (pt) {
        if (!partner[pt]) partner[pt] = { win:0, lose:0 };
        won ? partner[pt].win++ : partner[pt].lose++;
      }
    }
  });

  const sRate = pct(sWin, sWin + sLose);
  const dRate = pct(dWin, dWin + dLose);

  const topOpp = Object.entries(opp)
    .map(([k, v]) => ({ name:k, total:v.win + v.lose }))
    .sort((a, b) => b.total - a.total)[0];

  const topPartner = Object.entries(partner)
    .map(([k, v]) => ({ name:k, total:v.win + v.lose }))
    .sort((a, b) => b.total - a.total)[0];

  out.push(`
    <div class="sec-title">ğŸ¯ ë‹¨ì‹Â·ë³µì‹ ë¶„ì„</div>
    <div class="box">
      <b>ë‹¨ì‹:</b> ${sWin+sLose ? `${sWin}ìŠ¹ ${sLose}íŒ¨ (${sRate}%)` : "ë°ì´í„° ì—†ìŒ"}<br>
      ${topOpp ? `ì£¼ìš” ìƒëŒ€: <b>${topOpp.name}</b>` : ""}

      <div style="height:6px"></div>

      <b>ë³µì‹:</b> ${dWin+dLose ? `${dWin}ìŠ¹ ${dLose}íŒ¨ (${dRate}%)` : "ë°ì´í„° ì—†ìŒ"}<br>
      ${topPartner ? `ì£¼ìš” íŒŒíŠ¸ë„ˆ: <b>${topPartner.name}</b>` : ""}
    </div>
  `);

  /* âœ… AI ì½”ì¹­ */
out.push(`
  <div class="sec-title">ğŸ¤– AI ì½”ì¹­ ìƒì„¸ ë¶„ì„</div>
  <div class="box">
    <b>ğŸ“Š ì¢…í•© ì§„ë‹¨:</b><br>
    ${unified.trend === "ìŠ¹ë¥  ìƒìŠ¹ì„¸" ? "ìµœê·¼ ê²½ê¸°ë ¥ì´ ê¾¸ì¤€íˆ ìƒìŠ¹í•˜ê³  ìˆìœ¼ë©°, ê²½ê¸° í›„ë°˜ ì§‘ì¤‘ë ¥ì´ ì¢‹ì•„ì§€ê³  ìˆìŠµë‹ˆë‹¤." 
      : unified.trend === "ìŠ¹ë¥  í•˜ë½ì„¸" ? "ìµœê·¼ í”¼ë¡œ ëˆ„ì  ë˜ëŠ” ê²½ê¸° ê°ê° ì €í•˜ë¡œ ì¼ì‹œì  ë¶€ì§„ì´ ë³´ì…ë‹ˆë‹¤. ì»¨ë””ì…˜ íšŒë³µì´ ìš°ì„ ì…ë‹ˆë‹¤." 
      : "ì•ˆì •ì ì¸ ê²½ê¸° íë¦„ì„ ìœ ì§€í•˜ê³  ìˆìœ¼ë©°, ì‹¤ìˆ˜ë¥¼ ì¤„ì´ë ¤ëŠ” ì˜ì‹ì´ ê¸ì •ì ì…ë‹ˆë‹¤."}
    <br><br>

    <b>ğŸ¯ ê¸°ìˆ  ë¶„ì„:</b><br>
    ë‹¨ì‹ì—ì„œëŠ” ${sRate >= 60 ? "ê³µê²© ì „í™˜ ì†ë„ê°€ ë¹ ë¥´ê³  ì´ˆêµ¬ ë“ì  ì˜ì‹ì´ ëšœë ·" 
      : sRate >= 50 ? "ê· í˜• ì¡íŒ ë ë¦¬ ìš´ì˜ ëŠ¥ë ¥" 
      : "ìˆ˜ë¹„ ì¤‘ì‹¬ì˜ ê²½ê¸° ìš´ì˜ìœ¼ë¡œ ë“ì  ê²°ì •ë ¥ì´ ë‹¤ì†Œ ë¶€ì¡±"}í•˜ë©°, 
    ë³µì‹ì—ì„œëŠ” ${dRate >= 60 ? "íŒŒíŠ¸ë„ˆì™€ì˜ í˜¸í¡ì´ ì˜ ë§ê³  ë¦¬í„´ í›„ ì „í™˜ì´ ë¹ ë¥¸ í¸" 
      : dRate >= 50 ? "ê¸°ë³¸ì ì¸ ì—°ê²°ì€ ì•ˆì •ì ì´ì§€ë§Œ, í¬ì§€ì…˜ ì „í™˜ì´ ì•½ê°„ ëŠë¦¼" 
      : "ê³µê°„ ì»¤ë²„ì™€ ë¦¬í„´ íƒ€ì´ë° ì¡°ì •ì´ ê°œì„  í•„ìš”"}ìœ¼ë¡œ ë¶„ì„ë©ë‹ˆë‹¤.
    <br><br>

    <b>ğŸ¤ ì „ìˆ  ì œì•ˆ:</b><br>
    ${stats.partnerDiversity >= 4 
      ? "ë‹¤ì–‘í•œ íŒŒíŠ¸ë„ˆì™€ì˜ ê²½ê¸° ê²½í—˜ì´ í’ë¶€í•´ í˜‘ì—… ì ì‘ë ¥ì´ ë†’ìŠµë‹ˆë‹¤." 
      : "íŒŒíŠ¸ë„ˆ í’€ì´ ì œí•œë˜ì–´ ìˆì–´ íŠ¹ì • ìŠ¤íƒ€ì¼ì—ë§Œ ìµìˆ™í•´ì§ˆ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤. íŒŒíŠ¸ë„ˆ êµì²´ í›ˆë ¨ì´ ë„ì›€ì´ ë©ë‹ˆë‹¤."}
    ${
      stats.hardOpponents.length
        ? `<br>ì–´ë ¤ìš´ ìƒëŒ€(${stats.hardOpponents.map(o=>o.name).join(", ")})ì—ê²ŒëŠ” ì„œë¸Œ íŒ¨í„´ ëŒ€ì‘ê³¼ ë ë¦¬ ì†ë„ ì¡°ì ˆì´ í•„ìš”í•©ë‹ˆë‹¤.`
        : ""
    }
    <br><br>

    <b>ğŸ’¡ ì„±ì¥ ë°©í–¥:</b><br>
    ${allRate >= 60
      ? "ìƒìœ„ê¶Œ ì•ˆì •ì„¸ë¥¼ ìœ ì§€í•˜ë ¤ë©´ ì´ˆë°˜ ë¦¬ì‹œë¸Œ ì•ˆì •ì„±ê³¼ í›„ë°˜ ì²´ë ¥ ê´€ë¦¬ê°€ í•µì‹¬ì…ë‹ˆë‹¤. í›ˆë ¨ ì‹œ ë“ì  íŒ¨í„´ ë°˜ë³µë³´ë‹¤ â€˜ì‹¤ì  ì—†ëŠ” ë ë¦¬â€™ë¥¼ ëª©í‘œë¡œ ì„¤ì •í•˜ì„¸ìš”."
      : "ìŠ¹ë¥  ê°œì„ ì„ ìœ„í•´ ì´ˆêµ¬ ì‹¤ì±…ë¥  ê°ì†Œì™€ ë¦¬ì‹œë¸Œ ì„±ê³µë¥  í–¥ìƒì´ í•„ìš”í•©ë‹ˆë‹¤. ë˜í•œ 2êµ¬-3êµ¬ ì—°ì† ì „í™˜ ì‹œì ì˜ íŒë‹¨ í›ˆë ¨ì„ ì§‘ì¤‘í•˜ì„¸ìš”."}
  </div>
`);


  /* âœ… ê´€ë¦¬ì ì…ë ¥ê°’ ë°˜ì˜ (ì…ë ¥í•œ ê²ƒë§Œ í‘œì‹œ) */
  const hasAdmin =
    adminMemo.style ||
    adminMemo.favs ||
    adminMemo.strengths ||
    adminMemo.weaknesses ||
    adminMemo.hards ||
    adminMemo.memo;

  if (hasAdmin) {
    out.push(`
      <div class="sec-title">ğŸ“ ê´€ë¦¬ì ì½”ì¹­ ì°¸ê³ </div>
      <div class="box">
        ${adminMemo.style ? `<div>â€¢ ìŠ¤íƒ€ì¼: <b>${adminMemo.style}</b></div>` : ""}
        ${adminMemo.strengths ? `<div>â€¢ ê°•ì : <b>${adminMemo.strengths}</b></div>` : ""}
        ${adminMemo.weaknesses ? `<div>â€¢ ì•½ì : <b>${adminMemo.weaknesses}</b></div>` : ""}
        ${adminMemo.favs ? `<div>â€¢ ì„ í˜¸ íŒŒíŠ¸ë„ˆ: <b>${adminMemo.favs}</b></div>` : ""}
        ${adminMemo.hards ? `<div>â€¢ ì–´ë ¤ìš´ ìƒëŒ€: <b>${adminMemo.hards}</b></div>` : ""}
        ${adminMemo.memo ? `<div style="margin-top:6px;color:#475569">${adminMemo.memo}</div>` : ""}
      </div>
    `);
  }

  return out.join("\n");
}


/* ============================================
   âœ… ì‹¤í–‰: ë°ì´í„° ë¶ˆëŸ¬ì™€ ë¶„ì„ ì¶œë ¥
===============================================*/
(async () => {
  box.innerHTML = "ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";

  reports = await loadMonthlyReports();  // âœ… ì „ì—­ì— í• ë‹¹
  matches = await loadMatches();         // âœ… ì „ì—­ì— í• ë‹¹
  const adminMemo = await loadAdminMemo();

  stats = buildMatchStats(matches, playerName);  // âœ… ì „ì—­ì— ì €ì¥

  box.innerHTML = makeAnalysis(reports, matches, adminMemo, stats);


  /* âœ… ê´€ë¦¬ìëª¨ë“œ ì…ë ¥ì°½ë„ ê¸°ì¡´ ê°’ ìë™ ì±„ì›€ */
  if (adminMemo.style) document.getElementById("ad_style").value = adminMemo.style;
  if (adminMemo.favs) document.getElementById("ad_favs").value = adminMemo.favs;
  if (adminMemo.strengths) document.getElementById("ad_strengths").value = adminMemo.strengths;
  if (adminMemo.weaknesses) document.getElementById("ad_weaknesses").value = adminMemo.weaknesses;
  if (adminMemo.hards) document.getElementById("ad_hards").value = adminMemo.hards;
  if (adminMemo.memo) document.getElementById("ad_memo").value = adminMemo.memo;

  // âœ… ì§ˆë¬¸ ê¸°ë°˜ ë¶„ì„ ì‹¤í–‰
  fillUnifiedSummary(reports);
  const stats = buildMatchStats(matches, playerName);
  fillDetailBullets(stats);
  const suggest = buildAdminGuidedMemo(stats, reports, playerName);
  fillAdminMemoFields(suggest);

})();

/* ============================================
   âœ… ìƒë‹¨ ë²„íŠ¼ ë™ì‘ + ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ (DOM ë¡œë“œ í›„ ì ìš©)
===============================================*/
document.addEventListener("DOMContentLoaded", () => {

  const btnBack = document.getElementById("btnBack");
  const btnAdmin = document.getElementById("btnAdminToggle");
  const adminCard = document.getElementById("adminCard");

  btnBack?.addEventListener("click", () => {
    location.href = `player.html?name=${encodeURIComponent(playerName)}`;
  });

  let adminOn = false;  // ì´ˆê¸°ì—ëŠ” í•­ìƒ OFF

  /* âœ… Firebaseì—ì„œ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë¶ˆëŸ¬ì˜¤ê¸° */
  async function loadAdminPassword() {
    const snap = await get(ref(db, "config/adminPassword"));  
    return snap.exists() ? snap.val() : null;
  }

  /* âœ… ê´€ë¦¬ìëª¨ë“œ ë²„íŠ¼ í´ë¦­ */
  btnAdmin?.addEventListener("click", async () => {

    // OFF â†’ ON ì‹œë„
    if (!adminOn) {
      const correctPw = await loadAdminPassword();

      if (!correctPw) {
        alert("âš  ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\n(ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì„¤ì • ê°€ëŠ¥)");
        return;
      }

      const input = prompt("ğŸ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
      if (input === null) return;

      if (input.trim() !== correctPw.trim()) {
        alert("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      // âœ… ì„±ê³µ
      adminOn = true;
      applyAdmin();
      alert("âœ… ê´€ë¦¬ìëª¨ë“œ í™œì„±í™”");
    }

    // ON â†’ OFF
    else {
      adminOn = false;
      applyAdmin();
    }

  });

  /* âœ… UI ì ìš© í•¨ìˆ˜ */
  function applyAdmin() {
    adminCard.style.display = adminOn ? "block" : "none";
    btnAdmin.classList.toggle("primary", adminOn);
    btnAdmin.textContent = adminOn ? "ê´€ë¦¬ìëª¨ë“œ ON" : "ê´€ë¦¬ìëª¨ë“œ";
  }

}); // âœ… DOMContentLoaded ë

/* ============================================
   âœ… ì§ˆë¬¸ ê¸°ë°˜: í†µí•© ìš”ì•½/ì„¸ë¶€ì„±í–¥/ê´€ë¦¬ìë©”ëª¨ ìë™ ìƒì„±
   - reports: loadMonthlyReports() ê²°ê³¼
   - matches: loadMatches() ê²°ê³¼
   - adminMemo: loadAdminMemo() ê²°ê³¼
===============================================*/

/* ìœ í‹¸ */
function byValueDesc(a, b) { return b.value - a.value; }
function sum(arr) { return arr.reduce((a, b) => a + b, 0); }
function rate(win, total) { return total ? Math.round((win / total) * 100) : 0; }

/* í†µí•©ë¦¬ê·¸ ìš”ì•½ ìƒì + ë¶ˆë¦¿ ì±„ìš°ê¸° */
function fillUnifiedSummary(reports) {
  const wrap = document.getElementById("integratedBox");
  const bullets = document.getElementById("integratedBullets");
  if (!wrap || !bullets) return;

  if (!reports.length) {
    wrap.innerHTML = `<div class="small">í†µí•© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    bullets.innerHTML = "";
    return;
  }

  const totalGames = sum(reports.map(r => r.total));
  const totalWins = sum(reports.map(r => r.win));
  const totalLoses = sum(reports.map(r => r.lose));
  const avgRate = rate(totalWins, totalGames);

  const mostGames = [...reports].sort((a,b)=>b.total-a.total)[0];
  const bestRate = [...reports].sort((a,b)=>b.rate-a.rate)[0];
  const last = reports.at(-1);

  // 3ì¹¸ ìš”ì•½ ì¹´ë“œ
  wrap.innerHTML = `
    <div class="row" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px">
      <div class="card" style="padding:12px">
        <div class="small">ì´ ê²½ê¸°</div>
        <div style="font-size:20px;font-weight:900">${totalGames.toLocaleString()} ê²½ê¸°</div>
      </div>
      <div class="card" style="padding:12px">
        <div class="small">ìŠ¹ / íŒ¨</div>
        <div style="font-size:20px;font-weight:900">${totalWins.toLocaleString()}ìŠ¹ ${totalLoses.toLocaleString()}íŒ¨</div>
      </div>
      <div class="card" style="padding:12px">
        <div class="small">í‰ê·  ìŠ¹ë¥ </div>
        <div style="font-size:20px;font-weight:900">${avgRate}%</div>
      </div>
    </div>
  `;

  bullets.innerHTML = `
    <li>ê°€ì¥ ë§ì´ ë›´ ë‹¬: <b>${mostGames.month}</b> (${mostGames.total}ê²½ê¸°)</li>
    <li>ìŠ¹ë¥  ìµœê³  ë‹¬: <b>${bestRate.month}</b> (${bestRate.rate}%)</li>
    <li>ìµœê·¼ ë‹¬ ìŠ¹ë¥ : <b>${last.month}</b> (${last.rate}%)</li>
  `;
}

/* ë‹¨ì‹/ë³µì‹/ìƒëŒ€/íŒŒíŠ¸ë„ˆ í†µê³„ ë§Œë“¤ê¸° */
function buildMatchStats(matches, playerName) {
  const s = { win:0, lose:0 };
  const d = { win:0, lose:0 };
  const opp = {};     // { name: {win,lose} } (ë‹¨ì‹ ìƒëŒ€)
  const partner = {}; // { name: {win,lose} } (ë³µì‹ íŒŒíŠ¸ë„ˆ)
  const partnerSet = new Set();

  matches.forEach(m=>{
    const A = m.namesA || [];
    const B = m.namesB || [];
    const isA = A.includes(playerName);
    const won = (m.winnerSide === "A" && isA) || (m.winnerSide === "B" && !isA);

    if (m.mode === "single") {
      won ? s.win++ : s.lose++;
      const other = isA ? B[0] : A[0];
      if (other) {
        if (!opp[other]) opp[other] = {win:0,lose:0};
        won ? opp[other].win++ : opp[other].lose++;
      }
    } else {
      won ? d.win++ : d.lose++;
      const same = isA ? A : B;
      const pt = same.find(n => n !== playerName);
      if (pt) {
        partnerSet.add(pt);
        if (!partner[pt]) partner[pt] = {win:0,lose:0};
        won ? partner[pt].win++ : partner[pt].lose++;
      }
    }
  });

  const singlesTotal = s.win + s.lose;
  const doublesTotal = d.win + d.lose;

  const singlesRate = rate(s.win, singlesTotal);
  const doublesRate = rate(d.win, doublesTotal);

  // ìì£¼ ë§ë¶™ì€ (>=3ê²½ê¸°) ìƒëŒ€ TOP & ì–´ë ¤ìš´ ìƒëŒ€(ìŠ¹ë¥ <=40)
  const oppArr = Object.entries(opp).map(([name, wl])=>{
    const total = wl.win + wl.lose;
    return { name, total, win: wl.win, lose: wl.lose, rate: rate(wl.win,total) };
  }).sort((a,b)=>b.total - a.total);

  const keyOpponents = oppArr.filter(o=>o.total >= 3).slice(0,3);
  const hardOpponents = oppArr.filter(o=>o.total >= 3 && o.rate <= 40).slice(0,3);

  // íŒŒíŠ¸ë„ˆ TOP & ì•½í•œ ê¶í•©(ìŠ¹ë¥ <=40)
  const partnerArr = Object.entries(partner).map(([name, wl])=>{
    const total = wl.win + wl.lose;
    return { name, total, win: wl.win, lose: wl.lose, rate: rate(wl.win,total) };
  }).sort((a,b)=>b.total - a.total);

  const favPartners = partnerArr.filter(p=>p.total >= 3).slice(0,3);
  const weakPartners = partnerArr.filter(p=>p.total >= 3 && p.rate <= 40).slice(0,3);

  return {
    singles: { ...s, total: singlesTotal, rate: singlesRate },
    doubles: { ...d, total: doublesTotal, rate: doublesRate },
    oppArr, keyOpponents, hardOpponents,
    partnerArr, favPartners, weakPartners,
    partnerDiversity: partnerSet.size
  };
}

/* ë‹¨ì‹/ë³µì‹ ë¶ˆë¦¿ + ì¶”ì²œë¬¸êµ¬ ì±„ìš°ê¸° (ì§ˆë¬¸ ë°˜ì˜) */
function fillDetailBullets(stats) {
  const sUl = document.getElementById("singleBullets");
  const dUl = document.getElementById("doubleBullets");
  const recUl = document.getElementById("recommend");
  if (!sUl || !dUl || !recUl) return;

  const S = stats.singles, D = stats.doubles;

  sUl.innerHTML = `
    <li>ì´ ê²½ê¸°: <b>${S.total.toLocaleString()}</b> ( ${S.win}ìŠ¹ ${S.lose}íŒ¨ )</li>
    <li>ìŠ¹ë¥ : <b>${S.rate}%</b></li>
    <li>${S.rate >= 55 ? "ìì‹ ì˜ í…œí¬ ìœ ì§€ ì‹œ ì—°ì† ë“ì ë ¥ì´ ì¢‹ìŠµë‹ˆë‹¤." : "ì´ˆë°˜ íë¦„ ê´€ë¦¬ì™€ ë¦¬ì‹œë¸Œ ì•ˆì •í™”ê°€ ìš°ì„  ê³¼ì œì…ë‹ˆë‹¤."}</li>
  `;

  dUl.innerHTML = `
    <li>ì´ ê²½ê¸°: <b>${D.total.toLocaleString()}</b> ( ${D.win}ìŠ¹ ${D.lose}íŒ¨ )</li>
    <li>ìŠ¹ë¥ : <b>${D.rate}%</b></li>
    <li>${D.rate >= 55 ? "íŒŒíŠ¸ë„ˆ ì—°ê³„ê°€ ì¢‹ì•„ ê³µê²© ì „í™˜ì´ ë¹ ë¦…ë‹ˆë‹¤." : "ì´ˆêµ¬ ì—­í•  ë¶„ë‹´ê³¼ ë¦¬í„´ ìœ„ì¹˜ ì„ ì • ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤."}</li>
    <li>ìµœê·¼ íŒŒíŠ¸ë„ˆ ë‹¤ì–‘ì„±: <b>${stats.partnerDiversity}ëª…</b></li>
  `;

  // ì¢…í•© ì¶”ì²œ (ì§ˆë¬¸ ê°€ì´ë“œ ê¸°ë°˜)
  let recList = [];
  if (S.rate >= D.rate) {
    recList.push("ë‹¨ì‹ì— ê°•ì ì´ ëšœë ·í•˜ë¯€ë¡œ ë‹¨ì‹ ë¹„ì¤‘ì„ ë†’ì´ëŠ” ì „ëµì´ ìœ íš¨í•©ë‹ˆë‹¤.");
    recList.push("ì§§ì€ ê³µ ë¦¬ì‹œë¸Œ ì„ íƒì§€(í‘¸ì‹œ/ì§§ì€ ìŠ¤íŠ¸ë ˆì´íŠ¸/ë°± ë¦¬í”„íŠ¸)ë¥¼ ì—°ìŠµí•´ ì´ˆë°˜ 5í¬ì¸íŠ¸ë¥¼ ì•ˆì •í™”í•˜ì„¸ìš”.");
  } else {
    recList.push("ë³µì‹ì—ì„œ ê°•ì ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤. íŒŒíŠ¸ë„ˆì™€ ì´ˆêµ¬-2êµ¬ ì—­í• ì„ ëª…í™•íˆ ë‚˜ëˆ„ë©´ ìƒìŠ¹í­ì´ í½ë‹ˆë‹¤.");
    recList.push("ë¦¬ì‹œë¸Œ ì•ˆì •í™” ë° ì²« ë¸”ë¡ ì„±ê³µë¥ ì„ ë†’ì´ë©´ ë‹¨ì‹ë„ ë¹ ë¥´ê²Œ ê°œì„ ë©ë‹ˆë‹¤.");
  }
  if (stats.hardOpponents.length) {
    recList.push(`ì–´ë ¤ìš´ ìƒëŒ€(ìŠ¹ë¥  â‰¤ 40%): ${stats.hardOpponents.map(o=>`${o.name}`).join(", ")} â€” ì„œë¸Œ íŒ¨í„´ ëŒ€ë¹„ì™€ í…œí¬ ëŒ€ì‘ í›ˆë ¨ì„ ì¤‘ì ìœ¼ë¡œ.`);
  }
  recUl.innerHTML = recList.map(t=>`<li>${t}</li>`).join("");
}

/* ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜ì˜í•œ "ê´€ë¦¬ì ë©”ëª¨ ì¶”ì²œì•ˆ" ìƒì„± (ë¹ˆ ì¹¸ë§Œ ìë™ ì±„ì›€) */
function buildAdminGuidedMemo(stats, reports, playerName) {
  // ìŠ¤íƒ€ì¼ ì¶”ì • (ì§ˆë¬¸: ê³µê²©í˜•/ìˆ˜ë¹„í˜•/ì•ˆì •í˜•/ë¦¬ë“¬í˜•/ì—°ê²°í˜•?)
  // â€” ê·¼ê±°: ë‹¨ì‹ ìŠ¹ë¥ ì´ ë³µì‹ë³´ë‹¤ ë†’ê³  ì´ëŸ‰ë„ ë§ìœ¼ë©´ 'íë¦„ ì£¼ë„í˜•/ì „ì§„ ê³µê²©í˜•' ê²½í–¥,
  //          ë³µì‹ ìª½ì´ ë” ì¢‹ìœ¼ë©´ 'ì—°ê²°í˜•/í˜‘ì—…í˜•' ê²½í–¥.
  const S = stats.singles, D = stats.doubles;
  let style = "";
  if (S.total >= D.total && S.rate >= D.rate) {
    style = (S.rate >= 60) ? "ì „ì§„ ê³µê²©í˜•, íë¦„ ì£¼ë„í˜•" : "ì•ˆì •í˜•, ë¦¬ë“¬í˜•";
  } else {
    style = (D.rate >= 60) ? "ì—°ê²°í˜•(ë³µì‹ ì§€í–¥), ì „í™˜ ë¹ ë¦„" : "í˜‘ì—…í˜•, ì•ˆì •ì§€í–¥";
  }

  // ê°•ì (ì§ˆë¬¸: ê°€ì¥ ê°•í•œ ê¸°ìˆ ? ê¸´ë ë¦¬/ì§§ì€ë ë¦¬? ê²°ì •ë ¥?)
  // ë°ì´í„°ë¡œ ê¸°ìˆ ëª…ì€ íŠ¹ì • ëª»í•˜ì§€ë§Œ, íŒ¨í„´ ê¸°ë°˜ ë¬¸ì¥ìœ¼ë¡œ ì œì•ˆ
  const strengths = [
    (S.rate >= 55 ? "ë‹¨ì‹ íë¦„ ì£¼ë„ ëŠ¥ë ¥" : "ê¸´ ë ë¦¬ì—ì„œì˜ ì•ˆì •ì„±"),
    (D.rate >= 55 ? "ë³µì‹ ì—°ê³„ì™€ ì „í™˜ ì†ë„" : "ìˆ˜ë¹„ì—ì„œ ê³µê²© ì „í™˜ íƒ€ì´ë°")
  ].join(", ");

  // ì•½ì (ì§ˆë¬¸: ì§§ì€ê³µ, ì´ˆêµ¬, ë°±ì²˜ë¦¬, ê°•ë“œë¼ì´ë¸Œ ëŒ€ì‘?)
  const weaknesses = [
    "ì§§ì€ ê³µ ë¦¬ì‹œë¸Œ ì„ íƒì§€ ë¶€ì¡±",
    "ê°•í•œ ë“œë¼ì´ë¸Œ ëŒ€ì‘ ì²« ë¸”ë¡ í”ë“¤ë¦¼"
  ].join(", ");

  // ì„ í˜¸ íŒŒíŠ¸ë„ˆ (ì§ˆë¬¸: ìŠ¹ë¥ â†‘ ì´ìœ /ì—­í• ë¶„ë‹´?)
  const favs = stats.favPartners.length
    ? stats.favPartners.map(p=>`${p.name}(${p.total}ê²½ê¸° ${p.rate}%)`).slice(0,2).join(", ")
    : "";

  // ì–´ë ¤ìš´ ìƒëŒ€ (ì§ˆë¬¸: ì„œë¸Œ/í…œí¬/ìœ í˜•?)
  const hards = stats.hardOpponents.length
    ? stats.hardOpponents.map(o=>`${o.name}(${o.total}ê²½ê¸° ${o.rate}%)`).slice(0,3).join(", ")
    : "";

  // ì¢…í•© ë©”ëª¨ (ì§ˆë¬¸: ì „ìˆ  ì¡°ì–¸ + ì¥ê¸° ì„±ì¥ í¬ì¸íŠ¸)
  const last = reports.at(-1);
  const lastLine = last ? `ìµœê·¼(${last.month}) ìŠ¹ë¥  ${last.rate}% ê¸°ì¤€, ` : "";
  const memo = [
    `${lastLine}ì´ˆë°˜ 5í¬ì¸íŠ¸ êµ¬ê°„ì€ ì§§ì€ ë ë¦¬ ìœ„ì£¼ ì „ìˆ ë¡œ ì•ˆì •í™”í•˜ê³ ,`,
    `ë¦¬ì‹œë¸ŒëŠ” í‘¸ì‹œ/ì§§ì€ ìŠ¤íŠ¸ë ˆì´íŠ¸/ë°± ë¦¬í”„íŠ¸ë¥¼ ì„ì–´ íŒ¨í„´ì„ ë‹¤ì–‘í™”í•˜ì„¸ìš”.`,
    `ë³µì‹ì€ ì´ˆêµ¬-2êµ¬ ì—­í• ì„ ëª…í™•íˆ ë¶„ë‹´í•˜ê³ , ë‹¨ì‹ì€ ì²« ë¸”ë¡ ì„±ê³µë¥  í–¥ìƒì„ ìœ„í•œ ë°˜ë³µ í›ˆë ¨ì´ í•µì‹¬ì…ë‹ˆë‹¤.`
  ].join(" ");

  return { style, strengths, weaknesses, favs, hards, memo };
}

/* ê´€ë¦¬ì ì…ë ¥ì¹¸ì— ì¶”ì²œì•ˆì„ "ë¹ˆ ì¹¸ì—ë§Œ" ì±„ì›Œ ë„£ê¸° */
function fillAdminMemoFields(suggest) {
  const f = (id) => document.getElementById(id);
  const setIfEmpty = (el, val) => { if (el && !el.value.trim() && val) el.value = val; };

  setIfEmpty(f("ad_style"), suggest.style);
  setIfEmpty(f("ad_strengths"), suggest.strengths);
  setIfEmpty(f("ad_weaknesses"), suggest.weaknesses);
  setIfEmpty(f("ad_favs"), suggest.favs);
  setIfEmpty(f("ad_hards"), suggest.hards);
  setIfEmpty(f("ad_memo"), suggest.memo);
}

/* ============ ì‹¤í–‰ë¶€ ì¶”ê°€: ë°ì´í„° ë§Œë“  ë’¤ í˜¸ì¶œ ============ */
/* (ê¸°ì¡´ ì‹¤í–‰ë¶€)
   const reports = await loadMonthlyReports();
   const matches = await loadMatches();
   const adminMemo = await loadAdminMemo();
   box.innerHTML = makeAnalysis(reports, matches, adminMemo);
   ... (ê¸°ì¡´ ê°’ ì±„ì›Œë„£ê¸°)
*/

(function runQuestionBasedAnalysis() {
  // reports, matches, playerNameì€ ê¸°ì¡´ ìŠ¤ì½”í”„ì— ì´ë¯¸ ì¡´ì¬
  if (!window.__questionBasedDone__) window.__questionBasedDone__ = true; else return;

  // í†µí•© ìš”ì•½
  fillUnifiedSummary(reports);

  // ì„¸ë¶€ ì„±í–¥
  const stats = buildMatchStats(matches, playerName);
  fillDetailBullets(stats);

  // ê´€ë¦¬ì ë©”ëª¨ ì¶”ì²œì•ˆ ìƒì„± â†’ ë¹ˆì¹¸ë§Œ ìë™ ì±„ì›€
  const suggest = buildAdminGuidedMemo(stats, reports, playerName);
  fillAdminMemoFields(suggest);
})();

</script>


</body>
</html>
