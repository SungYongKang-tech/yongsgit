<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ” íƒêµ¬ ìŠ¤íƒ€ì¼ ë¶„ì„</title>
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
<style>
:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb; --card:#fff;
  --accent:#2563eb; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
  --shadow:0 8px 28px rgba(2,6,23,.08);
}
*{box-sizing:border-box}
body{margin:0;font-family:"Pretendard","Noto Sans KR",system-ui,sans-serif;background:var(--bg);color:var(--ink);font-weight:600}
.wrap{max-width:900px;margin:0 auto;padding:16px}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;z-index:5}
.head-in{max-width:900px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between}
h1{margin:0;font-size:clamp(18px,4vw,22px);color:#1e40af}
.btn{border:1px solid #d1d5db;padding:8px 12px;border-radius:10px;background:#fff;cursor:pointer;font-weight:800}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-top:12px}
.sec-title{font-size:16px;font-weight:900;color:#0f172a;margin:0 0 8px}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#e2efff;color:#1e40af;font-size:12px;font-weight:900}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.kv{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.k{font-size:13px;color:#334155}
.v{font-size:16px;font-weight:900}
.note{font-size:12.5px;color:#64748b}
ul.clean{list-style:none;padding:0;margin:0;display:grid;gap:6px}
li.i{border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;background:linear-gradient(180deg,#fff,#fbfdff 85%)}
.hl{color:#1e3a8a}
.good{color:var(--ok);font-weight:900}
.warn{color:var(--warn);font-weight:900}
.bad{color:var(--bad);font-weight:900}
a.link{color:#1e40af;text-decoration:none;font-weight:900}
.divider{height:1px;background:#eef2f7;margin:12px 0}
.small{font-size:13px;color:#475569}
input,textarea{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;font:inherit}
label{font-size:12px;color:#475569;font-weight:800}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-12{grid-column:span 12}
.col-6{grid-column:span 6}
@media(max-width:720px){.col-6{grid-column:span 12}}
#summary {
  font-size: 15.5px;   /* ê¸°ì¡´ë³´ë‹¤ ì•½ 15% ì»¤ì§ */
  line-height: 1.55; 
}

  .k-head {font-size:20px; font-weight:900; color:#0f172a; margin-bottom:10px}
  .k-core {font-size:18px; line-height:1.6; font-weight:900; color:#111827}
  .k-core b {font-weight:900}
  details.coach {border:1px solid #e5e7eb; border-radius:12px; background:#fff; padding:10px 12px; margin:10px 0}
  details.coach summary {cursor:pointer; font-weight:900; color:#1e3a8a}
  .pill {display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800; background:#eef2ff; color:#3730a3; margin-right:6px}
  .good {color:#0f6a00; font-weight:900}
  .warn {color:#b45309; font-weight:900}
  .bad  {color:#b91c1c; font-weight:900}
  .muted{color:#64748b; font-weight:700}
  ul.tight {margin:6px 0 0 18px; padding:0}
  ul.tight li{margin:4px 0}

</style>
</head>
<body>
<header>
  <div class="head-in">
    <h1>ğŸ” íƒêµ¬ ìŠ¤íƒ€ì¼ ë¶„ì„</h1>
    <div class="row">
      <button class="btn" id="btnBack">â† ê°œì¸ ì„±ì </button>
      <button class="btn" id="btnAdminToggle">ê´€ë¦¬ìëª¨ë“œ</button>
      <span class="badge" id="who"></span>
    </div>
  </div>
</header>

<div class="analysis-wrap" style="pointer-events:auto;">


<main class="wrap">
  <!-- ìš”ì•½ -->
  <section class="card">
    <div class="sec-title">ğŸ“Œ í•µì‹¬ ìš”ì•½</div>
    <div id="summary" class="small">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
  </section>

  <section class="card" style="margin-top:12px;">
    <div id="analysisContent"></div>
  </section>

  <!-- í†µí•©ë¦¬ê·¸ (9~10ì›”) -->
  <section class="card">
    <div class="sec-title">ğŸ“… í†µí•©ë¦¬ê·¸ ìš”ì•½ <span class="badge">'25-09 ~ '25-10</span></div>
    <div id="integratedBox" class="kv"></div>
    <div class="divider"></div>
    <ul id="integratedBullets" class="clean"></ul>
    <div class="note">* í†µí•©ë¦¬ê·¸ëŠ” ì°¸ê³ ìš©ìœ¼ë¡œë§Œ ë°˜ì˜ë©ë‹ˆë‹¤.</div>
  </section>

  <!-- ë‹¨ì‹/ë³µì‹ (11ì›”~) -->
  <section class="card">
    <div class="sec-title">ğŸ¯ ì„¸ë¶€ ì„±í–¥ (11ì›”~)</div>
    <div class="grid">
      <div class="col-6">
        <div class="badge">ë‹¨ì‹</div>
        <ul id="singleBullets" class="clean"></ul>
      </div>
      <div class="col-6">
        <div class="badge">ë³µì‹</div>
        <ul id="doubleBullets" class="clean"></ul>
      </div>
    </div>
    <div class="divider"></div>
    <ul id="recommend" class="clean"></ul>
  </section>

  <!-- ê´€ë¦¬ì ë©”ëª¨ (í™•ì¥í˜•) -->
  <section class="card" id="adminCard" style="display:none">
    <div class="sec-title">ğŸ›  ê´€ë¦¬ì ë©”ëª¨ (í™•ì¥í˜•)</div>
    <p class="small">ì €ì¥ ê²½ë¡œ: <code>playerDetail/{ì´ë¦„}/</code></p>
    <div class="grid">
      <div class="col-6">
        <label>ìŠ¤íƒ€ì¼ (ì˜ˆ: ê³µê²©í˜•, ìˆ˜ë¹„í˜•, ì¹´ìš´í„°)</label>
        <input id="ad_style" placeholder="ê³µê²©í˜•">
      </div>
      <div class="col-6">
        <label>ì„ í˜¸ íŒŒíŠ¸ë„ˆ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
        <input id="ad_favs" placeholder="í™ê¸¸ë™, ê¹€ì˜í¬">
      </div>
      <div class="col-6">
        <label>ê°•ì  (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
        <input id="ad_strengths" placeholder="ì´ˆêµ¬ ë“œë¼ì´ë¸Œ, ë°œë¹ ë¥¸ í’‹ì›Œí¬">
      </div>
      <div class="col-6">
        <label>ì•½ì  (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
        <input id="ad_weaknesses" placeholder="ë°±ìª½ ì»¤íŠ¸ ì²˜ë¦¬, ê¸´ ë ë¦¬">
      </div>
      <div class="col-12">
        <label>ì–´ë ¤ìš´ ìƒëŒ€ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
        <input id="ad_hards" placeholder="ì´ìƒì¤€, ë°•ë‚˜ë ¹">
      </div>
      <div class="col-12">
        <label>ë©”ëª¨</label>
        <textarea id="ad_memo" rows="3" placeholder="ì „ì§„ ê³µê²© ìœ„ì£¼. ì»¤íŠ¸ ë³¼ ëŒ€ë¹„ í•„ìš”."></textarea>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="btnSaveAdmin">ì €ì¥</button>
      <span class="note">â€» Firebase ë³´ì•ˆê·œì¹™ì—ì„œ ê´€ë¦¬ìë§Œ ì“°ê¸° ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •í•˜ì„¸ìš”.</span>
    </div>
  </section>
</main>

<script type="module">
/* ============================================
   âœ… Firebase
===============================================*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};

initializeApp(firebaseConfig);
const db = getDatabase();

/* ============================================
   âœ… ê¸°ë³¸ ë³€ìˆ˜
===============================================*/
const params = new URLSearchParams(location.search);
const playerName = params.get("name") || "";
const box = document.getElementById("analysisContent");

const pct = (a, b) => b ? Math.round(a / b * 100) : 0;
const fmt = n => (Math.round(n * 10) / 10);


/* ============================================
   âœ… 1. í†µí•© ë¦¬ê·¸ ë°ì´í„° ë¡œë“œ
===============================================*/
async function loadMonthlyReports() {
  const snap = await get(ref(db, "monthlyReports"));
  if (!snap.exists()) return [];

  const data = snap.val();
  let result = [];

  Object.entries(data).forEach(([month, obj]) => {
    if (!obj.players) return;
    const me = Object.values(obj.players).find(p => p.name === playerName);
    if (!me) return;

    const win = Number(me.wins ?? me.win ?? 0);
    const lose = Number(me.losses ?? me.lose ?? 0);

    result.push({
      month,
      win,
      lose,
      total: win + lose,
      rate: pct(win, win + lose)
    });
  });

  return result.sort((a,b)=> a.month.localeCompare(b.month));
}


/* ============================================
   âœ… 2. ë‹¨ì‹/ë³µì‹ ê²½ê¸° ë¡œë“œ
===============================================*/
async function loadMatches() {
  const snap = await get(ref(db, "matches"));
  if (!snap.exists()) return [];

  const list = Object.values(snap.val());

  return list.filter(m => {
    const names = [...(m.namesA||[]), ...(m.namesB||[])];
    return names.includes(playerName);
  });
}


/* ============================================
   âœ… í†µí•©ë¦¬ê·¸ ê¸°ë°˜ ì„¸ë¶€ ì„±í–¥ ë¶„ì„
===============================================*/
function analyzeUnified(reports) {
  if (!reports.length) return {
    trend: "ë°ì´í„° ì—†ìŒ",
    best: null,
    worst: null,
    steady: null,
    pattern: "í†µí•© ê¸°ë¡ì´ ë¶€ì¡±í•˜ì—¬ ì„±í–¥ ë¶„ì„ì´ ì œí•œë©ë‹ˆë‹¤."
  };

  const best = [...reports].sort((a,b)=> b.rate - a.rate)[0];
  const worst = [...reports].sort((a,b)=> a.rate - b.rate)[0];

  // ìŠ¹ë¥  ë³€í™”ëŸ‰(ê¸‰ìƒìŠ¹/ê¸‰í•˜ë½)
  let trend = "ì•ˆì •ì ";
  if (reports.length >= 2) {
    const first = reports[0].rate;
    const last  = reports[reports.length-1].rate;
    const diff = last - first;

    if (diff >= 10) trend = "ìŠ¹ë¥ ì´ ëšœë ·í•œ ìƒìŠ¹ì„¸";
    else if (diff <= -10) trend = "ìŠ¹ë¥ ì´ ëˆˆì— ë„ê²Œ í•˜ë½";
    else trend = "í¬ê²Œ í”ë“¤ë¦¬ì§€ ì•ŠëŠ” í¸";
  }

  // ê²½ê¸°ìˆ˜ í¸ì°¨ = ê¾¸ì¤€í•¨
  const totals = reports.map(r=>r.total);
  const steady = fmt((Math.min(...totals) / Math.max(...totals)) * 100);

  // ì„±í–¥ íŒ¨í„´
  let pattern = "";
  if (best.rate >= 65) {
    pattern += "ê°•í•œ ë‚ ì€ ëª°ì•„ì¹˜ë“¯ ìŠ¹ë¥ ì´ í¬ê²Œ ì˜¤ë¥´ë©°, ì»¨ë””ì…˜ ì˜í–¥ì´ í° íƒ€ì….";
  } else if (best.rate >= 55) {
    pattern += "ì „ë°˜ì ìœ¼ë¡œ ê¾¸ì¤€í•˜ë©°, ì‹¤ìˆ˜ ê´€ë¦¬ê°€ ì¢‹ì€ ì•ˆì •í˜• ì„ ìˆ˜.";
  } else {
    pattern += "ìŠ¹ë¶€ì˜ íë¦„ì„ íƒ€ê¸° ì „ì— ì‹¤ì ì´ ë¨¼ì € ë‚˜ëŠ” ê²½ìš°ê°€ ë§ì•„ ê²½ê¸° ì´ˆë°˜ ì§‘ì¤‘ë ¥ì´ ì¤‘ìš”.";
  }

  return { trend, best, worst, steady, pattern };
}


/* ============================================
   âœ… ë‹¨ì‹/ë³µì‹ + í†µí•©ë¦¬ê·¸ ì „ì²´ í†µí•© ë¶„ì„ ìƒì„±
===============================================*/
function makeAnalysis(reports, matches) {

  /* ===== í†µí•©ë¦¬ê·¸ ì§‘ê³„ ===== */
  let totalWin = 0, totalLose = 0;
  reports.forEach(r => { totalWin += r.win; totalLose += r.lose; });
  const allRate = pct(totalWin, totalWin+totalLose);

  const unified = analyzeUnified(reports);

  /* ===== ë‹¨ì‹/ë³µì‹ ì§‘ê³„ ===== */
  let sWin=0, sLose=0, dWin=0, dLose=0;
  let opp={}, partner={};

  matches.forEach(m=>{
    const A = m.namesA || [];
    const B = m.namesB || [];
    const isA = A.includes(playerName);
    const won = (m.winnerSide==="A" && isA) || (m.winnerSide==="B" && !isA);

    if (m.mode==="single"){
      if (won) sWin++; else sLose++;

      const other = isA ? B[0] : A[0];
      if (other){
        if (!opp[other]) opp[other]={win:0,lose:0};
        if (won) opp[other].win++; else opp[other].lose++;
      }
    } else {
      if (won) dWin++; else dLose++;

      const same = isA ? A : B;
      const pt = same.find(n=>n!==playerName);

      if(pt){
        if(!partner[pt]) partner[pt]={win:0,lose:0};
        if (won) partner[pt].win++; else partner[pt].lose++;
      }
    }
  });

  const sRate = pct(sWin, sWin+sLose);
  const dRate = pct(dWin, dWin+dLose);

  const topOpp = Object.entries(opp)
    .map(([k,v])=>({name:k, ...v, total:v.win+v.lose}))
    .sort((a,b)=>b.total-a.total)[0];

  const topPartner = Object.entries(partner)
    .map(([k,v])=>({name:k, ...v, total:v.win+v.lose}))
    .sort((a,b)=>b.total-a.total)[0];

  /* ============================================
      âœ… HTML ìƒì„±
  ============================================*/
  let out = [];

  /* âœ… í•µì‹¬ ìš”ì•½ */
  out.push(`
    <div style="font-size:20px;font-weight:900;color:#1e3a8a;margin-bottom:12px;">
      ğŸ“Œ í•µì‹¬ ìš”ì•½
    </div>
  `);

  out.push(`
    <div class="box" style="font-size:16px;">
      <b class="highlight">${playerName}</b> ì„ ìˆ˜ëŠ” ì „ì²´ í†µí•© ê¸°ì¤€ 
      <b class="highlight">${allRate}% ìŠ¹ë¥ </b>ì„ ê¸°ë¡í•˜ê³  ìˆìœ¼ë©°,
      ìµœê·¼ íë¦„ì€ <b>${unified.trend}</b>ì…ë‹ˆë‹¤.
    </div>
  `);

  /* âœ… í†µí•©ë¦¬ê·¸ ìš”ì•½ */
  out.push(`
    <div class="section-title">ğŸ“… í†µí•©ë¦¬ê·¸ ìš”ì•½</div>
    <div class="box">
      ${
        reports.length
          ? `
            ê°€ì¥ ì¢‹ì€ ë‹¬ì€ <b>${unified.best?.month}</b> (${unified.best?.rate}%),
            ê°€ì¥ ì–´ë ¤ì› ë˜ ë‹¬ì€ <b>${unified.worst?.month}</b> (${unified.worst?.rate}%)
            ì…ë‹ˆë‹¤.<br><br>
            ì›”ë³„ ê²½ê¸°ìˆ˜ í¸ì°¨ ê¸°ì¤€ ê¾¸ì¤€í•¨ ì§€ìˆ˜ëŠ” <b>${unified.steady}%</b>ë¡œ,
            ${unified.steady >= 70 ? "ìƒë‹¹íˆ ì¼ì •í•œ í˜ì´ìŠ¤ë¥¼ ìœ ì§€í•˜ëŠ” í¸ì…ë‹ˆë‹¤." 
                                   : "ê²½ê¸°ìˆ˜ ë³€í™”ê°€ ìˆì–´ ì»¨ë””ì…˜ì— ë”°ë¥¸ ì°¨ì´ê°€ ë³´ì…ë‹ˆë‹¤."}
          `
          : "í†µí•© ë¦¬ê·¸ ê¸°ë¡ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤."
      }
    </div>
  `);

  /* âœ… í†µí•© ê¸°ë°˜ ì„¸ë¶€ ì„±í–¥ */
  out.push(`
    <div class="section-title">ğŸ” í†µí•© ê¸°ë¡ ê¸°ë°˜ ì„¸ë¶€ ì„±í–¥</div>
    <div class="box">
      ${unified.pattern}
    </div>
  `);

  /* âœ… ë‹¨ì‹Â·ë³µì‹ */
  out.push(`
    <div class="section-title">ğŸ¯ ë‹¨ì‹Â·ë³µì‹ ë¶„ì„</div>
    <div class="box">
      <b>ë‹¨ì‹:</b> ${sWin+sLose ? `${sWin}ìŠ¹ ${sLose}íŒ¨ (${sRate}%)`
                                : "ì•„ì§ ë‹¨ì‹ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤."}<br>
      ${topOpp ? `ì£¼ìš” ìƒëŒ€ëŠ” <b>${topOpp.name}</b> ì…ë‹ˆë‹¤.` : ""}

      <div style="height:6px;"></div>

      <b>ë³µì‹:</b> ${dWin+dLose ? `${dWin}ìŠ¹ ${dLose}íŒ¨ (${dRate}%)`
                                : "ì•„ì§ ë³µì‹ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤."}<br>
      ${topPartner ? `ê°€ì¥ ë§ì´ í•¨ê»˜í•œ íŒŒíŠ¸ë„ˆëŠ” <b>${topPartner.name}</b>ì…ë‹ˆë‹¤.` : ""}
    </div>
  `);

  /* âœ… AI ì½”ì¹­ ë¶„ì„ */
  out.push(`
    <div class="section-title">ğŸ¤– AI ì½”ì¹­ ìŠ¤íƒ€ì¼</div>
    <div class="box">
      ${
        allRate >= 60
          ? `ê¸°ë³¸ì ì¸ ê²½ê¸°ê°€ ì•ˆì •ì ì´ë©°, ë ë¦¬ ì´ˆë°˜ ì‹¤ìˆ˜ë§Œ ì¤„ì´ë©´ ìƒìœ„ê¶Œ ì„±ì ë„ ë…¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
          : `ì´ˆë°˜ ì‹¤ì ë¥ ì„ ì¤„ì´ë©´ ì „ì²´ ìŠ¹ë¥ ì´ ë¹ ë¥´ê²Œ ì˜¬ë¼ê°ˆ ê°€ëŠ¥ì„±ì´ í½ë‹ˆë‹¤. 
             <b class="bad">ë¦¬ì‹œë¸Œ ì•ˆì •ì„± ê°•í™”</b>ë¥¼ ìš°ì„  ì¶”ì²œí•©ë‹ˆë‹¤.`
      }
      <br><br>
      ${sRate >= dRate
        ? `ë‹¨ì‹ì—ì„œ ê°•ì ì„ ë³´ì´ë©°, ë³µì‹ì€ íŒŒíŠ¸ë„ˆ ì¡°í•©ì„ ì°¾ëŠ” ê³¼ì •ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.`
        : `ë³µì‹ ê°ê°ì€ ì¢‹ì€ í¸ì´ë©°, ë‹¨ì‹ì—ì„œ ê²½ê¸° íë¦„ ê´€ë¦¬ê°€ ìŠ¹íŒ¨ë¥¼ ì¢Œìš°í•©ë‹ˆë‹¤.`}
    </div>
  `);

  return out.join("\n");
}

/* ============================================
   âœ… ì‹¤í–‰
===============================================*/
(async () => {
  box.innerHTML = "ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";

  const reports = await loadMonthlyReports();
  const matches = await loadMatches();

  box.innerHTML = makeAnalysis(reports, matches);
})();
</script>

</body>
</html>
