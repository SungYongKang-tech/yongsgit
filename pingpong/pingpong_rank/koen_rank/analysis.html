<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ” íƒêµ¬ ìŠ¤íƒ€ì¼ ë¶„ì„ (í…œí”Œë¦¿ vs AI)</title>
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
<style>
:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb; --card:#fff;
  --accent:#2563eb; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
  --shadow:0 8px 28px rgba(2,6,23,.08);
}
*{box-sizing:border-box}
body{margin:0;font-family:"Pretendard","Noto Sans KR",system-ui,sans-serif;background:var(--bg);color:var(--ink);font-weight:600}
.wrap{max-width:980px;margin:0 auto;padding:16px}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;z-index:9999}
.head-in{max-width:980px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between}
h1{margin:0;font-size:20px;color:#1e40af;font-weight:900}
.btn{border:1px solid #d1d5db;padding:8px 12px;border-radius:10px;background:#fff;cursor:pointer;font-weight:800}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.ghost{background:#f8fafc}
.card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-top:12px}
.sec-title{font-size:16px;font-weight:900;color:#0f172a;margin:0 0 8px}
.badge{padding:4px 8px;border-radius:999px;background:#e2efff;color:#1e40af;font-size:12px;font-weight:900}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,textarea{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
label{font-size:12px;color:#475569;font-weight:800}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-6{grid-column:span 6}
.col-12{grid-column:span 12}
@media(max-width:720px){.col-6{grid-column:span 12}}
.box{padding:12px;background:#f1f5f9;border-radius:12px}
.kv{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.kpi{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
.kpi .mini{border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:linear-gradient(180deg,#fff,#fbfdff 85%)}
.kpi .mini .h{font-size:12px;color:#334155;font-weight:800;margin-bottom:4px}
.kpi .mini .v{font-size:20px;font-weight:900;color:#0f172a}
.tabbar{display:flex;gap:8px;background:#fff;padding:6px;border:1px solid #e5e7eb;border-radius:12px}
.tab{padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;font-weight:900}
.tab.on{background:#e6efff;border-color:#c7d2fe;color:#1e40af}
.note{font-size:12.5px;color:#475569}
.small{font-size:13px;color:#475569}
.table{width:100%;border-collapse:collapse;font-size:14px}
.table th,.table td{border-bottom:1px solid #e5e7eb;padding:8px 6px;text-align:left}
.flex-between{display:flex;justify-content:space-between;align-items:center}
</style>
</head>

<body>
<header>
  <div class="head-in">
    <h1>ğŸ” íƒêµ¬ ìŠ¤íƒ€ì¼ ë¶„ì„</h1>
    <div class="row">
      <button class="btn" id="btnBack">â† ê°œì¸ ì„±ì </button>
      <span class="badge" id="who"></span>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- ìƒë‹¨ íƒ­: í…œí”Œë¦¿ vs AI -->
  <section class="card">
    <div class="flex-between">
      <div class="tabbar">
        <button id="tabTpl" class="tab on">í…œí”Œë¦¿ ë¶„ì„</button>
        <button id="tabAI" class="tab">AI ì½”ì¹˜ (gpt-4o-mini)</button>
      </div>
      <div class="row small">
        <span>API í‚¤</span>
        <input id="apiKey" style="width:220px" placeholder="sk-... (localStorage ì €ì¥)">
        <button class="btn ghost" id="saveKeyBtn">ì €ì¥</button>
      </div>
    </div>
    <div class="small" style="margin-top:8px">* AI ëª¨ë“œëŠ” OpenAI API í‚¤ê°€ í•„ìš”í•˜ë©°, í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</div>
  </section>

  <!-- í•µì‹¬ KPI -->
  <section class="card">
    <div class="sec-title">ğŸ“Œ í•µì‹¬ KPI</div>
    <div class="kpi" id="kpiBox"></div>
  </section>

  <!-- í†µí•©/ë‹¨ì‹/ë³µì‹ í‘œ ìš”ì•½ -->
  <section class="card">
    <div class="sec-title">ğŸ“… ì›”ë³„ ìš”ì•½</div>
    <div id="monthTableBox" class="box">ë¡œë”© ì¤‘â€¦</div>
  </section>

  <!-- ìƒì„¸ ë¶„ì„ ì¹´ë“œë“¤ -->
  <section class="card">
    <div class="sec-title">ğŸ¯ ìƒì„¸ ë¶„ì„</div>
    <div class="grid">
      <div class="col-6">
        <div class="box">
          <b>ë‹¨ì‹ â€” ìƒëŒ€ë³„ ìƒìœ„ 8</b>
          <table class="table" id="tblOpp"></table>
        </div>
      </div>
      <div class="col-6">
        <div class="box">
          <b>ë³µì‹ â€” íŒŒíŠ¸ë„ˆë³„ ìƒìœ„ 8</b>
          <table class="table" id="tblPtn"></table>
        </div>
      </div>
    </div>
    <div class="small" style="margin-top:6px">â€» 2025-11 ì´í›„ ìë£ŒëŠ” ë‹¨/ë³µì‹ ë¶„ë¦¬ ê¸°ì¤€, ê·¸ ì´ì „ì€ í†µí•© ê¸°ì¤€ì…ë‹ˆë‹¤.</div>
  </section>

  <!-- ë¶„ì„ ë¦¬í¬íŠ¸ (í…œí”Œë¦¿ / AI ê²°ê³¼ ìë¦¬) -->
  <section class="card">
    <div class="flex-between">
      <div class="sec-title" id="reportTitle">ğŸ¤– í…œí”Œë¦¿ ê¸°ë°˜ ì½”ì¹˜ ë¦¬í¬íŠ¸</div>
      <div class="row">
        <button class="btn" id="regenTpl">í…œí”Œë¦¿ ë‹¤ì‹œ ìƒì„±</button>
        <button class="btn primary" id="genAI">AIë¡œ ë¶„ì„ ìƒì„±</button>
      </div>
    </div>
    <div id="reportBox" class="box">ë°ì´í„° ë¡œë”© ì¤‘â€¦</div>
  </section>

  <!-- âœ… ê´€ë¦¬ì ëª¨ë“œ í† ê¸€ -->
<section class="card">
  <div class="sec-title">ğŸ›  ê´€ë¦¬ì ê¸°ìˆ  ë©”ëª¨</div>

  <!-- âœ… ê´€ë¦¬ì ëª¨ë“œ ì—´ê¸° ë²„íŠ¼ -->
  <button class="btn primary" id="btnAdminOpen">ê´€ë¦¬ì ëª¨ë“œ ì—´ê¸°</button>

  <!-- âœ… ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì°½ -->
  <div id="adminPwBox" style="display:none; margin-top:10px;">
    <input id="adminPwInput" type="password" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" style="width:160px;margin-right:6px;">
    <button class="btn" id="btnAdminPwConfirm">í™•ì¸</button>
  </div>

  <!-- âœ… ê´€ë¦¬ì í¼ (ì ê²¨ìˆìŒ) -->
  <div id="adminForm" style="display:none;margin-top:14px;">
    <div class="grid">
      <div class="col-6"><label>íƒ€ë²•/ê·¸ë¦½</label><input id="ad_grip"></div>
      <div class="col-6"><label>êµ¬ë ¥</label><input id="ad_years"></div>
      <div class="col-6"><label>ë ˆìŠ¨ ì—¬ë¶€</label><input id="ad_lesson"></div>
      <div class="col-6"><label>ìµœê·¼ í¼</label><input id="ad_form"></div>
      <div class="col-6"><label>ê¸°ìˆ  ê°•ì </label><input id="ad_strong"></div>
      <div class="col-6"><label>ê¸°ìˆ  ì•½ì </label><input id="ad_weak"></div>
      <div class="col-12"><label>ê¸°íƒ€ ë©”ëª¨</label><textarea id="ad_memo" rows="3"></textarea></div>
    </div>
    <button class="btn primary" id="btnSaveAdmin" style="margin-top:10px;">ì €ì¥</button>
  </div>
</section>



</main>

<script type="module">
/* ========== Firebase ========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain:"pingpongclub-4a5fd.firebaseapp.com",
  databaseURL:"https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId:"pingpongclub-4a5fd",
  storageBucket:"pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId:"802826774007",
  appId:"1:802826774007:web:ca4d05be778eeaf1723af2"
};
initializeApp(firebaseConfig);
const db = getDatabase();

/* ========== Utils ========== */
const $ = s => document.querySelector(s);
const params = new URLSearchParams(location.search);
const playerName = params.get("name") || "";
$("#who").textContent = playerName;

const pct  = (a,b)=> b? Math.round(a/b*100) : 0;
const fmt1 = n => (Math.round(n*10)/10).toFixed(1);
const monthShort = m => `'${m.slice(2)}`; // YYYY-MM -> 'YY-MM
const CMP = (a,b)=> a.localeCompare(b);

/* ========== ë„¤ë¹„ ========== */
$("#btnBack").addEventListener("click", ()=>{
  location.href = `player.html?name=${encodeURIComponent(playerName)}`;
});

/* ========== API í‚¤ ë¡œì»¬ ì €ì¥ ========== */
const apiKeyInput = $("#apiKey");
apiKeyInput.value = localStorage.getItem("OPENAI_API_KEY") || "";
$("#saveKeyBtn").addEventListener("click", ()=>{
  localStorage.setItem("OPENAI_API_KEY", apiKeyInput.value.trim());
  alert("API í‚¤ ì €ì¥ ì™„ë£Œ(localStorage).");
});

/* ========== ê´€ë¦¬ì ë©”ëª¨ ë¡œë“œ/ì €ì¥ ========== */
async function loadAdminMemo(){
  const snap = await get(ref(db, `playerDetail/${playerName}`));
  return snap.exists()? snap.val() : {};
}
async function saveAdminMemo(){
  const data = {
    grip:   $("#ad_grip").value.trim(),
    years:  $("#ad_years").value.trim(),
    lesson: $("#ad_lesson").value.trim(),
    form:   $("#ad_form").value.trim(),
    strong: $("#ad_strong").value.trim(),
    weak:   $("#ad_weak").value.trim(),
    memo:   $("#ad_memo").value.trim()
  };
  await set(ref(db, `playerDetail/${playerName}`), data);
  alert("âœ… ê´€ë¦¬ì ë©”ëª¨ ì €ì¥ ì™„ë£Œ");
}
$("#btnSaveAdmin").addEventListener("click", saveAdminMemo);

/* ========== ë°ì´í„° ìˆ˜ì§‘ (9~10ì›” í†µí•©, 11ì›”~ ë¶„ë¦¬) ========== */
let playerLevels = {};
async function loadPlayerLevels(){
  const snap = await get(ref(db,'players'));
  if (!snap.exists()) return;
  const data = snap.val() || {};
  Object.values(data).forEach(p=>{
    if (p.name) playerLevels[p.name] = p.level ?? "-";
  });
}

async function loadPastMonths(){
  const targets = ["2025-09","2025-10"]; // í†µí•©ë§Œ
  let perMonthAll = {};
  for(const m of targets){
    const s = await get(ref(db,`monthlyReports/${m}/players`));
    if (!s.exists()) continue;
    const me = Object.values(s.val()).find(r=>r.name===playerName);
    if (!me) continue;
    const win = Number(me.wins ?? me.win ?? 0);
    const lose= Number(me.losses ?? me.lose ?? 0);
    perMonthAll[m]={ total:win+lose, win, lose, rate:pct(win,win+lose) };
  }
  return perMonthAll;
}

async function loadFromMatchesNov(){
  const s = await get(ref(db,'matches'));
  if (!s.exists()) return { months:[], all:{}, sgl:{}, dbl:{}, opp:{}, ptn:{}, ptsSum:0 };
  const NOV = "2025-11";
  const rows = Object.values(s.val());
  const my = rows.filter(m=>{
    const names = [...(m.namesA||[]), ...(m.namesB||[])];
    return names.includes(playerName);
  });

  let months = new Set();
  let perAll={}, perSgl={}, perDbl={}; // by month
  let opp={}, ptn={}; // aggregate
  let ptsSum = 0;

  const POINT_WIN=2, POINT_LOSE=-1;

  my.forEach(m=>{
    const mk = m.monthKey || new Date(m.createdAt||Date.now()).toISOString().slice(0,7);
    months.add(mk);
    perAll[mk]??={total:0,win:0,lose:0,rate:0};
    perSgl[mk]??={total:0,win:0,lose:0,rate:0};
    perDbl[mk]??={total:0,win:0,lose:0,rate:0,points:0};

    const A = m.namesA||[], B=m.namesB||[];
    const amA = A.includes(playerName);
    const iWon = (m.winnerSide==="A" && amA) || (m.winnerSide==="B" && !amA);
    const mode = m.mode || "single";

    perAll[mk].total++; iWon? perAll[mk].win++ : perAll[mk].lose++;

    if (CMP(mk,NOV)>=0){
      if (mode==="single"){
        perSgl[mk].total++; iWon? perSgl[mk].win++ : perSgl[mk].lose++;
        const oppName = amA? (B[0]||"") : (A[0]||"");
        if (oppName){
          opp[oppName]??={win:0,lose:0};
          iWon? opp[oppName].win++ : opp[oppName].lose++;
        }
      } else {
        perDbl[mk].total++; iWon? perDbl[mk].win++ : perDbl[mk].lose++;
        const pName = (amA? A : B).find(n=>n!==playerName);
        if (pName){
          ptn[pName]??={win:0,lose:0,points:0};
          iWon? (ptn[pName].win++, ptn[pName].points+=POINT_WIN)
              : (ptn[pName].lose++,ptn[pName].points+=POINT_LOSE);
        }
        perDbl[mk].points += iWon? POINT_WIN:POINT_LOSE;
        ptsSum += iWon? POINT_WIN:POINT_LOSE;
      }
    }
  });

  // rate ê³„ì‚°
  Object.values(perAll).forEach(o=>{o.rate = o.total? Math.round(o.win/o.total*100):0;});
  Object.values(perSgl).forEach(o=>{o.rate = o.total? Math.round(o.win/o.total*100):0;});
  Object.values(perDbl).forEach(o=>{o.rate = o.total? Math.round(o.win/o.total*100):0;});

  return {
    months:[...months].sort(), all:perAll, sgl:perSgl, dbl:perDbl, opp, ptn, ptsSum
  };
}

/* ========== ì¢…í•© ì§‘ê³„ â†’ ë¦¬í¬íŠ¸ ì¬ë£Œ ========== */
function buildSummary(pastAll, novPack){
  // months í•©ì¹˜ê¸°
  const months = [...new Set([...Object.keys(pastAll||{}), ...(novPack.months||[])])].sort();

  // ì „ì²´ í•©ê³„
  let sumAll={total:0,win:0,lose:0};
  months.forEach(m=>{
    const a = novPack.all[m] || pastAll[m];
    if (!a) return;
    sumAll.total += a.total; sumAll.win += a.win; sumAll.lose += a.lose;
  });

  // 11ì›”~ ë‹¨/ë³µì‹ í•©ê³„
  let sumS={total:0,win:0,lose:0}, sumD={total:0,win:0,lose:0};
  Object.values(novPack.sgl).forEach(o=>{sumS.total+=o.total; sumS.win+=o.win; sumS.lose+=o.lose;});
  Object.values(novPack.dbl).forEach(o=>{sumD.total+=o.total; sumD.win+=o.win; sumD.lose+=o.lose;});

  // best/worst month(í†µí•©)
  let best=null, worst=null;
  months.forEach(m=>{
    const a = novPack.all[m] || pastAll[m];
    if (!a || a.total===0) return;
    if (!best || a.rate > best.rate) best = {month:m, rate:a.rate, win:a.win, lose:a.lose, total:a.total};
    if (!worst|| a.rate < worst.rate) worst= {month:m, rate:a.rate, win:a.win, lose:a.lose, total:a.total};
  });

  // ë‹¨ì‹ ìµœë‹¤ ëŒ€ê²° ìƒëŒ€ / ë³µì‹ ìµœë‹¤ íŒŒíŠ¸ë„ˆ
  const topOpp = Object.entries(novPack.opp||{})
    .map(([name,v])=>({name,total:v.win+v.lose,win:v.win,lose:v.lose,rate: (v.win+v.lose)? Math.round(v.win/(v.win+v.lose)*100):0}))
    .sort((a,b)=> b.total-a.total)[0] || null;

  const topPtn = Object.entries(novPack.ptn||{})
    .map(([name,v])=>({name,total:v.win+v.lose,win:v.win,lose:v.lose,points:v.points||0,rate: (v.win+v.lose)? Math.round(v.win/(v.win+v.lose)*100):0}))
    .sort((a,b)=> b.total-a.total)[0] || null;

  return {
    months,
    all:{...sumAll, rate: sumAll.total? Math.round(sumAll.win/sumAll.total*100):0},
    sgl:{...sumS, rate: sumS.total? Math.round(sumS.win/sumS.total*100):0},
    dbl:{...sumD, rate: sumD.total? Math.round(sumD.win/sumD.total*100):0, points: novPack.ptsSum || 0},
    perAll: novPack.all,
    perSgl: novPack.sgl,
    perDbl: novPack.dbl,
    topOpp, topPtn, best, worst
  };
}

/* ========== í™”ë©´ ì¶œë ¥: KPI/í‘œ ========== */
function renderKPI(sum){
  const box = $("#kpiBox"); box.innerHTML="";
  const cells = [
    {h:"ì „ì²´ ìŠ¹ë¥ ", v:`${sum.all.rate}% (${sum.all.win}ìŠ¹ ${sum.all.lose}íŒ¨ / ${sum.all.total}G)`},
    {h:"ë‹¨ì‹ ìŠ¹ë¥ (11ì›”~)", v:`${sum.sgl.rate}% (${sum.sgl.win}ìŠ¹ ${sum.sgl.lose}íŒ¨ / ${sum.sgl.total}G)`},
    {h:"ë³µì‹ ìŠ¹ë¥ (11ì›”~)", v:`${sum.dbl.rate}% (${sum.dbl.win}ìŠ¹ ${sum.dbl.lose}íŒ¨ / ${sum.dbl.total}G)`},
    {h:"ë³µì‹ ëˆ„ì  ìŠ¹ì (11ì›”~)", v:`${sum.dbl.points>0? "+"+sum.dbl.points : sum.dbl.points}`},
    {h:"ë² ìŠ¤íŠ¸ ë‹¬", v: sum.best? `${monthShort(sum.best.month)} (${sum.best.rate}%)` : "-"},
    {h:"ì–´ë ¤ì› ë˜ ë‹¬", v: sum.worst? `${monthShort(sum.worst.month)} (${sum.worst.rate}%)` : "-"},
    {h:"ë‹¨ì‹ ìµœë‹¤ ìƒëŒ€", v: sum.topOpp? `${sum.topOpp.name} Â· ${sum.topOpp.win}ìŠ¹ ${sum.topOpp.lose}íŒ¨ (${sum.topOpp.rate}%)`:"-"},
    {h:"ë³µì‹ ìµœë‹¤ íŒŒíŠ¸ë„ˆ", v: sum.topPtn? `${sum.topPtn.name} Â· ${sum.topPtn.win}ìŠ¹ ${sum.topPtn.lose}íŒ¨ (${sum.topPtn.rate}%)`:"-"},
  ];
  cells.forEach(c=>{
    const div = document.createElement("div");
    div.className="mini";
    div.innerHTML = `<div class="h">${c.h}</div><div class="v">${c.v}</div>`;
    box.appendChild(div);
  });
}

function renderMonthTable(sum, pastAll){
  const wrap = $("#monthTableBox");
  if (!sum.months.length){ wrap.textContent="ë°ì´í„° ì—†ìŒ"; return; }
  let html = `<table class="table"><thead>
    <tr><th>ì›”</th><th>í†µí•©</th><th>ë‹¨ì‹(11ì›”~)</th><th>ë³µì‹(11ì›”~)</th></tr>
  </thead><tbody>`;

  sum.months.forEach(m=>{
    const a = sum.perAll[m] || pastAll[m] || {total:0,win:0,lose:0,rate:0};
    const s = sum.perSgl[m] || {total:0,win:0,lose:0,rate:0};
    const d = sum.perDbl[m] || {total:0,win:0,lose:0,rate:0};
    html += `<tr>
      <td>${monthShort(m)}</td>
      <td>${a.total}G Â· ${a.win}ìŠ¹ ${a.lose}íŒ¨ Â· ${a.rate}%</td>
      <td>${s.total}G Â· ${s.win}ìŠ¹ ${s.lose}íŒ¨ Â· ${s.rate}%</td>
      <td>${d.total}G Â· ${d.win}ìŠ¹ ${d.lose}íŒ¨ Â· ${d.rate}%</td>
    </tr>`;
  });
  html += `</tbody></table>`;
  wrap.innerHTML = html;
}

function renderTables(novPack){
  const oppT = $("#tblOpp"); const ptnT = $("#tblPtn");
  const oppArr = Object.entries(novPack.opp||{})
    .map(([name,v])=>({name, total:v.win+v.lose, win:v.win, lose:v.lose, rate:(v.win+v.lose)? Math.round(v.win/(v.win+v.lose)*100):0}))
    .sort((a,b)=> b.total-a.total).slice(0,8);

  const ptnArr = Object.entries(novPack.ptn||{})
    .map(([name,v])=>({name, total:v.win+v.lose, win:v.win, lose:v.lose, points:v.points||0, rate:(v.win+v.lose)? Math.round(v.win/(v.win+v.lose)*100):0}))
    .sort((a,b)=> b.total-a.total).slice(0,8);

  oppT.innerHTML = `<tr><th>ìƒëŒ€</th><th>ê²½ê¸°</th><th>ì „ì </th><th>ìŠ¹ë¥ </th></tr>` +
    oppArr.map(o=>`<tr>
      <td><a href="player.html?name=${encodeURIComponent(o.name)}" style="color:#1e40af;font-weight:900;text-decoration:none">${o.name} (${playerLevels[o.name]??"-"})</a></td>
      <td>${o.total}</td><td>${o.win}ìŠ¹ ${o.lose}íŒ¨</td><td>${o.rate}%</td>
    </tr>`).join("");

  ptnT.innerHTML = `<tr><th>íŒŒíŠ¸ë„ˆ</th><th>ê²½ê¸°</th><th>ì „ì </th><th>ìŠ¹ë¥ </th></tr>` +
    ptnArr.map(p=>`<tr>
      <td><a href="player.html?name=${encodeURIComponent(p.name)}" style="color:#1e40af;font-weight:900;text-decoration:none">${p.name} (${playerLevels[p.name]??"-"})</a></td>
      <td>${p.total}</td><td>${p.win}ìŠ¹ ${p.lose}íŒ¨</td><td>${p.rate}%</td>
    </tr>`).join("");
}

/* ========== í…œí”Œë¦¿ ê¸°ë°˜ ë¦¬í¬íŠ¸ ========== */
function makeTemplateReport(sum, memo){
  // ë§¥ë½ ë³€ìˆ˜
  const rise = (sum.best && sum.worst)? (sum.best.rate - sum.worst.rate) : null;
  const sBias = sum.sgl.rate - sum.dbl.rate; // ë‹¨ì‹ ê°•/ì•½ ìƒëŒ€ ë¹„êµ
  const ptnTip = sum.topPtn ? `${sum.topPtn.name}ì™€ì˜ í•©ì€ ${sum.topPtn.rate}%ë¡œ, ì•ˆì •ì ì¸ ë ë¦¬ í…œí¬ë¥¼ ë§Œë“¤ì–´ ì£¼ëŠ” í¸ì…ë‹ˆë‹¤.` : "";
  const oppTip = sum.topOpp ? `${sum.topOpp.name}ê³¼ì˜ ëŒ€ê²°ì´ ì¦ì•˜ê³  ${sum.topOpp.rate}% ìŠ¹ë¥ ì„ ë³´ì˜€ìŠµë‹ˆë‹¤.` : "";

  const grip = memo.grip? `${memo.grip} ê¸°ë°˜ì˜ ìŠ¤íƒ ìŠ¤ë¥¼ ìœ ì§€í•˜ê³ , ` : "";
  const years= memo.years? `êµ¬ë ¥ì€ ì•½ ${memo.years}ë¡œ, ` : "";
  const lesson= memo.lesson? `${memo.lesson} ì¤‘ì´ë©°, ` : "";
  const form = memo.form? `ìµœê·¼ì—ëŠ” â€œ${memo.form}â€ ë³€í™”ê°€ ëˆˆì— ë•ë‹ˆë‹¤. ` : "";
  const strong = memo.strong? `ê°•ì ì€ ${memo.strong}ì´ê³ , ` : "";
  const weak = memo.weak? `ë³´ì™„í•  ë¶€ë¶„ì€ ${memo.weak}ì…ë‹ˆë‹¤. ` : "";
  const etc = memo.memo? `ë©”ëª¨: ${memo.memo}` : "";

  // ë³¸ë¬¸
  const lines = [];

  lines.push(
    `${playerName} ì„ ìˆ˜ëŠ” ${grip}${years}${lesson}${form}`.replace(/\s+/g," ")
      + `í†µí•© ê¸°ì¤€ ${sum.all.rate}%(${sum.all.win}ìŠ¹ ${sum.all.lose}íŒ¨/${sum.all.total}G)ì˜ ì„±ì ì„ ê¸°ë¡í•˜ê³  ìˆìŠµë‹ˆë‹¤.`
  );

  if (sum.best && sum.worst){
    lines.push(
      `ìŠ¹ë¥  ë³€ë™í­ì€ ${rise!==null? `${rise}%`:"-"}ì´ë©°, ìµœê³ ì˜ ë‹¬ì€ ${monthShort(sum.best.month)}(${sum.best.rate}%)`+
      `${sum.worst? `, ì–´ë ¤ì› ë˜ ë‹¬ì€ ${monthShort(sum.worst.month)}(${sum.worst.rate}%)`:""}ë¡œ ê´€ì°°ë©ë‹ˆë‹¤.`
    );
  }

  // ë‹¨/ë³µì‹ ë¹„êµ & ì½”ì¹­
  lines.push(
    `ë‹¨ì‹ì€ ${sum.sgl.rate}%(${sum.sgl.win}ìŠ¹ ${sum.sgl.lose}íŒ¨/${sum.sgl.total}G), ë³µì‹ì€ ${sum.dbl.rate}%(${sum.dbl.win}ìŠ¹ ${sum.dbl.lose}íŒ¨/${sum.dbl.total}G)`+
    `ì´ë©° ëˆ„ì  ìŠ¹ì ì€ ${sum.dbl.points>0? "+"+sum.dbl.points: sum.dbl.points}ì…ë‹ˆë‹¤.`
  );

  if (sBias >= 5) {
    lines.push(`ë‹¨ì‹ì—ì„œì˜ ê°•ì„¸ê°€ ë‘ë“œëŸ¬ì§‘ë‹ˆë‹¤. ë¦¬ì‹œë¸Œ í›„ ì²« ë³¼ ì „ê°œ(ì´ˆêµ¬ ì„ íƒ)ì—ì„œ ì£¼ë„ê¶Œì„ ì¡ëŠ” íŒ¨í„´ì„ ìœ ì§€í•˜ë˜, ë³µì‹ì—ì„œëŠ” íŒŒíŠ¸ë„ˆì™€ì˜ ì—­í•  ë¶„ë‹´ì„ ë” ëª…í™•íˆ í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.`);
  } else if (sBias <= -5) {
    lines.push(`ë³µì‹ ì ì‘ë ¥ì´ ìƒëŒ€ì ìœ¼ë¡œ ì¢‹ìŠµë‹ˆë‹¤. ì „ì§„ì—ì„œì˜ ë¹ ë¥¸ ì „í™˜ê³¼ 3êµ¬-5êµ¬ ì—°ê²° êµ¬ê°„ì„ ì•ˆì •í™”í•˜ë©´ ë‹¨ì‹ ìŠ¹ë¥  í–¥ìƒì—ë„ ë„ì›€ì´ ë©ë‹ˆë‹¤.`);
  } else {
    lines.push(`ë‹¨Â·ë³µì‹ ê· í˜•ì´ ì–‘í˜¸í•©ë‹ˆë‹¤. ê²½ê¸° íë¦„ì´ í”ë“¤ë¦´ ë•Œ ë ë¦¬ ê¸¸ì´ë¥¼ ì¡°ì ˆí•˜ëŠ” â€˜í…œí¬ ì„ íƒâ€™ì´ ìŠ¹ë¶€ì²˜ë¡œ ë³´ì…ë‹ˆë‹¤.`);
  }

  if (sum.topOpp)  lines.push(`ë‹¨ì‹ì—ì„œëŠ” ${oppTip}`);
  if (sum.topPtn)  lines.push(`ë³µì‹ì—ì„œëŠ” ${ptnTip}`);

  // ê´€ë¦¬ì ë©”ëª¨ ê¸°ë°˜ ì½”ì¹­ ë¬¸ì¥
  lines.push(`${strong}${weak}${etc}`.trim());

  // ìš°ì„ ìˆœìœ„ ê³¼ì œ 3ê°€ì§€
  const tasks = [];
  if (memo.weak?.includes("ë¦¬ì‹œë¸Œ") || memo.form?.includes("ë¦¬ì‹œë¸Œ")){
    tasks.push("ë¦¬ì‹œë¸Œ ì„ íƒ ë‹¨ìˆœí™”(ì§§ê²ŒÂ·ê¸¸ê²Œ 2ì˜µì…˜ ê³ ì •) í›„ ì„±ê³µë¥  70% ì´ìƒ í™•ë³´");
  } else {
    tasks.push("ì²« 3ë³¼(ì„œë¸Œ/ë¦¬ì‹œë¸Œ)ì—ì„œ â€˜ê¸¸ì´Â·íšŒì „â€™ í•œ ê°€ì§€ ë³€ìˆ˜ë§Œ ì¡°ì ˆí•˜ì—¬ ì•ˆì •ë„ ìƒìŠ¹");
  }
  if (sum.dbl.rate < sum.sgl.rate) {
    tasks.push("ë³µì‹ íŒŒíŠ¸ë„ˆì™€ì˜ ì—­í•  ìŠ¤ìœ„ì¹­(ì´ˆêµ¬/ë§ˆë¬´ë¦¬ ë‹´ë‹¹) ëª…í™•í™” ë° ì„¸íŠ¸ ì´ˆë°˜ í•©ì˜");
  } else {
    tasks.push("ë‹¨ì‹ì—ì„œ ë ë¦¬ ê¸¸ì´ 5êµ¬ ì „ ì¢…ë£Œ ë¹„ìœ¨â†‘(ë“œë¼ì´ë¸Œ ì ê·¹ì„± ìœ ì§€)");
  }
  tasks.push("ë² ìŠ¤íŠ¸ ë‹¬ê³¼ ìœ ì‚¬í•œ ì¤€ë¹„ ë£¨í‹´ ì¬í˜„(ì›Œë°ì—… ë£¨í‹´Â·ë¼ì¼“ ì„¸íŒ…Â·ì²« 3í¬ì¸íŠ¸ ì‘ì „ ê³ ì •)");

  return `
    <div style="line-height:1.75">
      ${lines.map(s=>`<p style="margin:0 0 10px">${s}</p>`).join("")}
      <div class="sec-title" style="margin-top:10px">ğŸ¯ ìš°ì„ ìˆœìœ„ ê³¼ì œ</div>
      <ul style="margin:6px 0 0 18px">
        ${tasks.map(t=>`<li>${t}</li>`).join("")}
      </ul>
    </div>
  `;
}

/* ========== OpenAI gpt-4o-mini ë¦¬í¬íŠ¸ ========== */
async function makeAIReport(sum, memo){
  const apiKey = (localStorage.getItem("OPENAI_API_KEY") || apiKeyInput.value || "").trim();
  if (!apiKey) throw new Error("API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.");

  // í”„ë¡¬í”„íŠ¸: ë¶„ì„ ì§€ì‹œ (í•œêµ­ì–´, ì½”ì¹˜ í†¤)
  const system = `
ë‹¹ì‹ ì€ íƒêµ¬ ì½”ì¹˜ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ í†µê³„(í†µí•©/ë‹¨ì‹/ë³µì‹, ì›”ë³„, ìµœë‹¤ ìƒëŒ€/íŒŒíŠ¸ë„ˆ, ë² ìŠ¤íŠ¸/ì›ŒìŠ¤íŠ¸ ë‹¬)ì™€ ê´€ë¦¬ì ê¸°ìˆ  ë©”ëª¨ë¥¼ ì¢…í•©í•˜ì—¬,
í•´ë‹¹ ì„ ìˆ˜ì˜ ê²½ê¸° ìŠ¤íƒ€ì¼/í…œí¬/ì‹¬ë¦¬Â·ì „ìˆ ì  íŠ¹ì§•ì„ ë¶„ì„í•˜ê³  ë‹¤ìŒ êµ¬ì¡°ë¡œ 700~1100ì í•œêµ­ì–´ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”.
- ê°œìš”(ìµœê·¼ ì»¨ë””ì…˜/ì „ì²´ íë¦„)
- í†µí•© íë¦„ê³¼ ì›”ë³„ íŠ¹ì§•(ë² ìŠ¤íŠ¸/ì›ŒìŠ¤íŠ¸ ë‹¬ ë§¥ë½)
- ë‹¨ì‹ vs ë³µì‹ ë¹„êµ(ê°•ì /ì•½ì /ê¶Œì¥ ë£¨í‹´)
- êµ¬ì²´ì  í›ˆë ¨ ê³¼ì œ 3ê°€ì§€(ì‹¤í–‰ ê°€ëŠ¥ ë¬¸ì¥)
ë¬¸ì²´ëŠ” ì •ì¤‘í•˜ê³  ë¶„ì„ì ìœ¼ë¡œ. ê´€ë¦¬ì ë©”ëª¨ì˜ ë¬¸êµ¬ë¥¼ ê·¸ëŒ€ë¡œ ë‚˜ì—´í•˜ì§€ ë§ê³  ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ ì“°ì„¸ìš”.
  `.trim();

  // ì‚¬ìš©ì ë°ì´í„°
  const user = {
    player: playerName,
    summary: {
      overall: sum.all, singles: sum.sgl, doubles: sum.dbl,
      best: sum.best, worst: sum.worst, topOpponent: sum.topOpp, topPartner: sum.topPtn
    },
    months: sum.months,
    memo
  };

  // API í˜¸ì¶œ
  const res = await fetch("https://api.openai.com/v1/chat/completions",{
    method:"POST",
    headers:{ "Content-Type":"application/json", "Authorization":`Bearer ${apiKey}` },
    body: JSON.stringify({
      model: "gpt-4o-mini",
      messages: [
        { role:"system", content: system },
        { role:"user",   content: JSON.stringify(user) }
      ],
      temperature: 0.8
    })
  });
  if (!res.ok){
    const t = await res.text();
    throw new Error("OpenAI API ì˜¤ë¥˜: "+t);
  }
  const data = await res.json();
  const text = data.choices?.[0]?.message?.content?.trim() || "(ì‘ë‹µ ì—†ìŒ)";
  return `<div style="white-space:pre-wrap;line-height:1.75">${text}</div>`;
}

/* ========== íƒ­ & ë²„íŠ¼ ========== */
const tabTpl = $("#tabTpl"), tabAI = $("#tabAI");
const reportTitle = $("#reportTitle"), reportBox = $("#reportBox");
let currentMode = "tpl";

tabTpl.addEventListener("click", ()=>{
  currentMode="tpl"; tabTpl.classList.add("on"); tabAI.classList.remove("on");
  reportTitle.textContent="ğŸ¤– í…œí”Œë¦¿ ê¸°ë°˜ ì½”ì¹˜ ë¦¬í¬íŠ¸";
  // ê¸°ì¡´ ê²°ê³¼ ìœ ì§€ (ì›í•˜ë©´ ì¦‰ì‹œ ì¬ìƒì„±í•˜ë„ë¡ ì•„ë˜ ë²„íŠ¼ ì‚¬ìš©)
});
tabAI.addEventListener("click", ()=>{
  currentMode="ai"; tabAI.classList.add("on"); tabTpl.classList.remove("on");
  reportTitle.textContent="ğŸ¤– AI ì½”ì¹˜ ë¦¬í¬íŠ¸ (gpt-4o-mini)";
});

/* ========== ë¶€íŒ… ì‹œ ì „ì²´ íë¦„ ========== */
let adminMemo={}, pastAll={}, novPack={}, summary={};

async function boot(){
  reportBox.textContent = "ë°ì´í„° ë¡œë”© ì¤‘â€¦";
  await loadPlayerLevels();
  adminMemo = await loadAdminMemo();
  // ë©”ëª¨ í¼ ì±„ì›€
  if (adminMemo.grip)   $("#ad_grip").value=adminMemo.grip;
  if (adminMemo.years)  $("#ad_years").value=adminMemo.years;
  if (adminMemo.lesson) $("#ad_lesson").value=adminMemo.lesson;
  if (adminMemo.form)   $("#ad_form").value=adminMemo.form;
  if (adminMemo.strong) $("#ad_strong").value=adminMemo.strong;
  if (adminMemo.weak)   $("#ad_weak").value=adminMemo.weak;
  if (adminMemo.memo)   $("#ad_memo").value=adminMemo.memo;

  pastAll = await loadPastMonths();
  novPack = await loadFromMatchesNov();
  summary = buildSummary(pastAll, novPack);

  renderKPI(summary);
  renderMonthTable(summary, pastAll);
  renderTables(novPack);

  // ê¸°ë³¸: í…œí”Œë¦¿ ë¦¬í¬íŠ¸ ì¦‰ì‹œ í‘œì‹œ
  const html = makeTemplateReport(summary, adminMemo);
  reportBox.innerHTML = html;
}
await boot();

/* ========== ì¬ìƒì„± ë²„íŠ¼ë“¤ ========== */
$("#regenTpl").addEventListener("click", ()=>{
  reportTitle.textContent="ğŸ¤– í…œí”Œë¦¿ ê¸°ë°˜ ì½”ì¹˜ ë¦¬í¬íŠ¸";
  reportBox.innerHTML = makeTemplateReport(summary, {
    grip: $("#ad_grip").value.trim(),
    years: $("#ad_years").value.trim(),
    lesson:$("#ad_lesson").value.trim(),
    form:  $("#ad_form").value.trim(),
    strong:$("#ad_strong").value.trim(),
    weak:  $("#ad_weak").value.trim(),
    memo:  $("#ad_memo").value.trim()
  });
});

$("#genAI").addEventListener("click", async ()=>{
  reportTitle.textContent="ğŸ¤– AI ì½”ì¹˜ ë¦¬í¬íŠ¸ (gpt-4o-mini)";
  reportBox.textContent="AIê°€ ë¶„ì„ ì¤‘â€¦";
  try{
    const html = await makeAIReport(summary, {
      grip: $("#ad_grip").value.trim(),
      years: $("#ad_years").value.trim(),
      lesson:$("#ad_lesson").value.trim(),
      form:  $("#ad_form").value.trim(),
      strong:$("#ad_strong").value.trim(),
      weak:  $("#ad_weak").value.trim(),
      memo:  $("#ad_memo").value.trim()
    });
    reportBox.innerHTML = html;
    tabAI.click();
  }catch(err){
    console.error(err);
    alert("AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í…œí”Œë¦¿ ë¦¬í¬íŠ¸ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.");
    reportTitle.textContent="ğŸ¤– í…œí”Œë¦¿ ê¸°ë°˜ ì½”ì¹˜ ë¦¬í¬íŠ¸(í´ë°±)";
    reportBox.innerHTML = makeTemplateReport(summary, adminMemo);
    tabTpl.click();
  }
});


/* ============================================================
      âœ… ê´€ë¦¬ì ê¸°ìˆ ë©”ëª¨ â€” Firebase adminPassword ê¸°ë°˜ ì ê¸ˆ
============================================================ */

// Firebaseì—ì„œ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë¶ˆëŸ¬ì˜¤ê¸°
let ADMIN_PASSWORD = null;

import { ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
get(ref(db, "config/adminPassword")).then(snap => {
  ADMIN_PASSWORD = snap.exists() ? snap.val() : "1234";
});

// ê¸°ì¡´ localStorage ê´€ë¦¬ì ì¸ì¦ ì—¬ë¶€
let isAdmin = localStorage.getItem("IS_ADMIN") === "true";

const btnAdminOpen = $("#btnAdminOpen");
const pwBox = $("#adminPwBox");
const adminForm = $("#adminForm");
const pwInput = $("#adminPwInput");

// âœ… ê´€ë¦¬ìëª¨ë“œ ì—´ê¸° ë²„íŠ¼
btnAdminOpen.addEventListener("click", () => {
  if (isAdmin) {
    adminForm.style.display = "block";
    pwBox.style.display = "none";
  } else {
    pwBox.style.display = "block";
  }
});

// âœ… ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ë²„íŠ¼
$("#btnAdminPwConfirm").addEventListener("click", () => {
  const inputPw = pwInput.value.trim();
  if (!ADMIN_PASSWORD) {
    alert("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
    return;
  }

  if (inputPw === ADMIN_PASSWORD.toString()) {
    alert("âœ… ê´€ë¦¬ì ì¸ì¦ ì„±ê³µ");
    isAdmin = true;
    localStorage.setItem("IS_ADMIN", "true");
    adminForm.style.display = "block";
    pwBox.style.display = "none";
  } else {
    alert("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
  }
});

// âœ… ì´ë¯¸ ì¸ì¦ëœ ê²½ìš° ë°”ë¡œ í¼ í‘œì‹œ
if (isAdmin) {
  adminForm.style.display = "block";
  pwBox.style.display = "none";
}



</script>
</body>
</html>
