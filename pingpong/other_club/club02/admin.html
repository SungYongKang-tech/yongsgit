<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ“ ê´€ë¦¬ìëª¨ë“œ</title>
<style>
@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

:root{
  --ink:#0f172a; --muted:#64748b; --card:#fff; --bg:#f5f7fb;
  --primary:#0d47a1; --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
  --shadow:0 8px 28px rgba(0,0,0,.08); --gray:#9ca3af;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Pretendard","Noto Sans KR",sans-serif;
  font-weight:600;
  color:var(--ink);
  background:var(--bg);
}
header{
  background:#fff;
  border-bottom:1px solid #e5e7eb;
  position:sticky; top:0; z-index:10;
}
.header-inner{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:14px 0;
}
h1{
  margin:4px 0 10px;
  font-size:clamp(20px,4vw,24px);
  color:var(--primary);
  font-weight:700;
}
.btn{
  border:1px solid #d1d5db;border-radius:8px;padding:6px 10px;
  font-size:14px;background:#fff;cursor:pointer;font-weight:600;
  transition:.15s;
}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.warn{background:var(--danger);color:#fff;border-color:var(--danger)}
.btn.ok{background:var(--ok);color:#fff;border-color:var(--ok)}
.card{
  background:var(--card);border:1px solid #e5e7eb;border-radius:12px;
  padding:14px;box-shadow:var(--shadow);margin:10px 0;
}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.player-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
  gap:6px;
  margin-top:10px;
}
.player-item{
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:8px;
  padding:8px 10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:15px;
}
.player-item span.name{flex:1;text-align:left;}
.player-item input{width:50px;text-align:center;border:1px solid #cbd5e1;border-radius:4px;font-size:14px;}
.toast{
  position:fixed;left:50%;transform:translateX(-50%);bottom:18px;
  background:#111827;color:#fff;padding:10px 14px;border-radius:12px;
  opacity:0;transition:.25s;font-weight:600;
}
.toast.show{opacity:1}
@media(max-width:640px){
  .player-grid{grid-template-columns:repeat(2,1fr);}
  .player-item{font-size:14px;padding:6px 8px;}
  input{font-size:13px;}
  .btn{font-size:13px;padding:5px 8px;}
}
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <h1 id="pageHeader">ğŸ“ ê´€ë¦¬ìëª¨ë“œ</h1>
    <div class="row" style="justify-content:center;">
      <a class="btn" href="index.html">â† ê²½ê¸°ê²°ê³¼ ì…ë ¥</a>
      <a class="btn primary" href="monthly-report.html">ğŸ“Š ì›”ê°„ ë¦¬í¬íŠ¸</a>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- ì œëª© ì„¤ì • -->
  <section class="card">
    <h3>ì‚¬ì´íŠ¸ ì œëª© ì„¤ì •</h3>
    <div class="row">
      <input id="siteTitle" type="text" placeholder="ì˜ˆ: ì§„ì£¼íƒêµ¬í´ëŸ½" style="flex:1"/>
      <button id="saveTitle" class="btn primary">ì €ì¥</button>
    </div>
    <small style="color:var(--muted)">ì´ ì œëª©ì€ ê²½ê¸°ê²°ê³¼/ì›”ê°„ë¦¬í¬íŠ¸/ê´€ë¦¬ìëª¨ë“œ ì „ì²´ì— ë°˜ì˜ë©ë‹ˆë‹¤.</small>
  </section>

  <!-- ì„ ìˆ˜ ë“±ë¡ -->
  <section class="card">
    <h3>ì„ ìˆ˜ ë“±ë¡</h3>
    <div class="row">
      <input id="playerName" type="text" lang="ko" placeholder="ì´ë¦„" style="flex:1;min-width:120px"/>
      <input id="playerLevel" type="number" placeholder="ë¶€ìˆ˜" style="width:60px;text-align:center"/>
      <button id="addPlayer" class="btn primary">ë“±ë¡</button>
    </div>
    <div id="playerList" class="player-grid"></div>
  </section>

  <!-- ì„¤ì • -->
  <section class="card">
    <h3>ì„¤ì • ê´€ë¦¬</h3>
    <div class="row">
      <label>ì‚­ì œ ë¹„ë°€ë²ˆí˜¸:</label>
      <input id="deletePassword" type="text" placeholder="ì˜ˆ: 7910" style="width:90px;text-align:center">
      <button id="saveDeletePassword" class="btn primary">ì €ì¥</button>
    </div>

    <div class="row" style="margin-top:6px;">
      <label>ê´€ë¦¬ì ì ‘ì† ë¹„ë°€ë²ˆí˜¸:</label>
      <input id="adminPassword" type="text" placeholder="ì˜ˆ: 1234" style="width:90px;text-align:center">
      <button id="saveAdminPassword" class="btn primary">ì €ì¥</button>
    </div>
  </section>

  <!-- ë°ì´í„° ê´€ë¦¬ -->
  <section class="card">
    <h3>ë°ì´í„° ê´€ë¦¬ (ì´ë²ˆë‹¬)</h3>
    <div class="row">
      <button id="deleteCurrentMonth" class="btn warn">ğŸ—‘ ì´ë²ˆë‹¬ ì „ì  ì „ì²´ ì‚­ì œ</button>
    </div>
    <small style="color:var(--danger);font-weight:600;">
      âš ï¸ ì£¼ì˜: ì´ ê¸°ëŠ¥ì€ í˜„ì¬ ì›”ì˜ ëª¨ë“  ê²½ê¸° ê²°ê³¼ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.<br>
      ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•´ì•¼ ì‹¤í–‰ë©ë‹ˆë‹¤.
    </small>
  </section>
  <section class="card">
  <h3>ë°ì´í„° ê´€ë¦¬ (ì§€ë‚œë‹¬)</h3>
  <div class="row">
    <button id="deletePrevMonth" class="btn warn">ğŸ—‘ ì§€ë‚œë‹¬ ì „ì  ì „ì²´ ì‚­ì œ</button>
  </div>
  <small style="color:var(--danger);font-weight:600;">
    âš ï¸ ì£¼ì˜: ì´ ê¸°ëŠ¥ì€ <b>ì§€ë‚œë‹¬</b>ì˜ ëª¨ë“  ê²½ê¸° ê²°ê³¼ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.<br>
    ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•´ì•¼ ì‹¤í–‰ë©ë‹ˆë‹¤.
  </small>
</section>


</main>

<div id="toast" class="toast">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { 
  getDatabase, ref, set, push, remove, onValue, get, child 
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:b1676264051e3dd7723af2"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const $ = s=>document.querySelector(s);
const toast=(m="ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤")=>{
  const t=$("#toast");t.textContent=m;t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1500);
};

// ===== ì œëª© ê´€ë¦¬ =====
const titleRef = ref(db, 'config/title');
const cachedTitle = localStorage.getItem('siteTitle');
if(cachedTitle){
  document.title = `ğŸ“ ${cachedTitle} ê´€ë¦¬ìëª¨ë“œ`;
  $('#pageHeader').textContent = `ğŸ“ ${cachedTitle} ê´€ë¦¬ìëª¨ë“œ`;
}
onValue(titleRef, s=>{
  const val = s.val() ?? 'PingPong Club';
  localStorage.setItem('siteTitle', val);
  document.title = `ğŸ“ ${val} ê´€ë¦¬ìëª¨ë“œ`;
  $('#pageHeader').textContent = `ğŸ“ ${val} ê´€ë¦¬ìëª¨ë“œ`;
  $('#siteTitle').value = val;
});
$('#saveTitle').onclick = async()=>{
  const title = $('#siteTitle').value.trim();
  if(!title)return toast('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
  await set(titleRef, title);
  localStorage.setItem('siteTitle', title);
  toast('ì œëª© ë³€ê²½ ì™„ë£Œ');
};

// ===== ì„ ìˆ˜ ê´€ë¦¬ =====
const playerRef = ref(db, 'players');
onValue(playerRef,snap=>{
  const list=$("#playerList");list.innerHTML="";
  const data=snap.val()||{};
  const sorted = Object.entries(data).sort(([,a],[,b])=>{
    if(a.level === b.level) return a.name.localeCompare(b.name,'ko');
    return a.level - b.level;
  });
  sorted.forEach(([id,p])=>{
    const div=document.createElement('div');
    div.className='player-item';
    div.innerHTML=`
      <span class="name">${p.name}</span>
      <input type="number" value="${p.level}" onchange="updateLevel('${id}',this.value)">
      <button class="btn warn" onclick="del('${id}')">ì‚­ì œ</button>
    `;
    list.appendChild(div);
  });
});
window.updateLevel=async(id,v)=>{await set(ref(db,`players/${id}/level`),parseInt(v));toast('ë¶€ìˆ˜ ìˆ˜ì • ì™„ë£Œ');};
$('#addPlayer').onclick=async()=>{
  const name=$('#playerName').value.trim();
  const level=parseInt($('#playerLevel').value)||0;
  if(!name)return toast('ì´ë¦„ ì…ë ¥');
  await push(playerRef,{name,level,joinedAt:Date.now()});
  $('#playerName').value='';$('#playerLevel').value='';
  toast('ì„ ìˆ˜ ë“±ë¡ ì™„ë£Œ');
};
window.del=async(id)=>{
  if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  await remove(ref(db,`players/${id}`));
  toast('ì‚­ì œ ì™„ë£Œ');
};

// ===== ì„¤ì • =====
onValue(ref(db,'config/deletePassword'),s=>$('#deletePassword').value=s.val()??'7910');
$('#saveDeletePassword').onclick=async()=>{
  const v=$('#deletePassword').value.trim();
  if(!v)return toast('ë¹„ë°€ë²ˆí˜¸ ì…ë ¥');
  await set(ref(db,'config/deletePassword'),v);
  toast('ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ ì €ì¥');
};
onValue(ref(db,'config/adminPassword'),s=>$('#adminPassword').value=s.val()??'1234');
$('#saveAdminPassword').onclick=async()=>{
  const v=$('#adminPassword').value.trim();
  if(!v)return toast('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥');
  await set(ref(db,'config/adminPassword'),v);
  toast('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì €ì¥');
};

// âœ… ì´ë²ˆë‹¬ ì „ì  ì „ì²´ ì‚­ì œ (ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í¬í•¨)
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("deleteCurrentMonth");
  if (!btn) return;

  btn.addEventListener("click", async () => {
    if (!confirm("âš ï¸ ì •ë§ ì´ë²ˆë‹¬ ê²½ê¸°ê²°ê³¼ë¥¼ ì „ë¶€ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì‚­ì œ í›„ ë³µêµ¬ ë¶ˆê°€)")) return;

    try {
      const pwRef = ref(db, "config/deletePassword");
      const pwSnap = await get(pwRef);
      const savedPw = pwSnap.exists() ? pwSnap.val() : "7910";

      const input = prompt("ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      if (input === null) return;
      if (input.trim() !== savedPw.trim()) {
        alert("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      const matchesRef = ref(db, "matches");
      const snapshot = await get(matchesRef);
      const data = snapshot.val() || {};
      const now = new Date();
      const thisMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2, '0')}`;
      let count = 0;

      for (const [id, match] of Object.entries(data)) {
        if (match.monthKey === thisMonth) {
          await remove(child(matchesRef, id));
          count++;
        }
      }

      toast(`âœ… ${thisMonth} ì „ì  ${count}ê±´ ì‚­ì œ ì™„ë£Œ`);
    } catch (err) {
      console.error(err);
      alert("âš ï¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  });
});

// âœ… ì§€ë‚œë‹¬ ì „ì  ì „ì²´ ì‚­ì œ
document.addEventListener("DOMContentLoaded", () => {
  const btnPrev = document.getElementById("deletePrevMonth");
  if (!btnPrev) return;

  btnPrev.addEventListener("click", async () => {
    if (!confirm("âš ï¸ ì •ë§ ì§€ë‚œë‹¬ ê²½ê¸°ê²°ê³¼ë¥¼ ì „ë¶€ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì‚­ì œ í›„ ë³µêµ¬ ë¶ˆê°€)")) return;

    try {
      const pwRef = ref(db, "config/deletePassword");
      const pwSnap = await get(pwRef);
      const savedPw = pwSnap.exists() ? pwSnap.val() : "7910";

      const input = prompt("ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      if (input === null) return;
      if (input.trim() !== savedPw.trim()) {
        alert("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      const matchesRef = ref(db, "matches");
      const snapshot = await get(matchesRef);
      const data = snapshot.val() || {};
      const now = new Date();
      const prevMonth = `${now.getFullYear()}-${String(now.getMonth()).padStart(2, '0')}`;
      let count = 0;

      for (const [id, match] of Object.entries(data)) {
        if (match.monthKey === prevMonth) {
          await remove(child(matchesRef, id));
          count++;
        }
      }

      toast(`âœ… ${prevMonth} ì „ì  ${count}ê±´ ì‚­ì œ ì™„ë£Œ`);
    } catch (err) {
      console.error(err);
      alert("âš ï¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  });
});

</script>
</body>
</html>
