<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PingPong Club Â· ê´€ë¦¬ì</title>
<style>
:root{
  --ink:#0f172a; --muted:#64748b; --card:#fff; --bg:#f5f7fb;
  --primary:#0d47a1; --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
  --shadow:0 8px 28px rgba(0,0,0,.08)
}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;color:var(--ink);background:var(--bg)}
.wrap{max-width:1000px;margin:0 auto;padding:14px 16px}
h1{color:var(--primary);margin:6px 0}
.card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:14px;margin:12px 0;box-shadow:var(--shadow)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{border:1px solid #d1d5db;border-radius:8px;padding:8px 12px;font-size:14px;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.warn{background:var(--danger);color:#fff;border-color:var(--danger)}
.btn.ok{background:var(--ok);color:#fff;border-color:var(--ok)}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #e5e7eb;padding:8px;font-size:14px}
thead th{background:#f1f5f9;text-align:left}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
background:#111827;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;transition:.25s}
.toast.show{opacity:1}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ“ PingPong Club ê´€ë¦¬ì</h1>

  <!-- ì„ ìˆ˜ ì¶”ê°€ -->
  <section class="card">
    <h3>ì„ ìˆ˜ ì¶”ê°€</h3>
    <div class="row">
      <input id="playerName" type="text" placeholder="ì´ë¦„" />
      <input id="playerLevel" type="number" min="1" max="20" placeholder="ë¶€ìˆ˜" />
      <button id="addPlayer" class="btn primary">ë“±ë¡</button>
    </div>
    <p style="color:var(--muted);font-size:13px;margin-top:6px">ë“±ë¡ ì¦‰ì‹œ ê²½ê¸° ì…ë ¥ í˜ì´ì§€ì— ë°˜ì˜ë©ë‹ˆë‹¤.</p>
  </section>

  <!-- ì„ ìˆ˜ ëª©ë¡ -->
  <section class="card">
    <h3>ì„ ìˆ˜ ëª©ë¡</h3>
    <table>
      <thead><tr><th>ì´ë¦„</th><th>ë¶€ìˆ˜</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
      <tbody id="playerTable"></tbody>
    </table>
  </section>
</div>

<div id="toast" class="toast">Saved</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, set, remove, onValue, get, child } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// Firebase ì—°ê²°
const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ìœ í‹¸
const $ = (s, c=document)=>c.querySelector(s);
const toast = (m)=>{
  const t=$('#toast');t.textContent=m;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),1600);
};

// ì„ ìˆ˜ ëª©ë¡ ì‹¤ì‹œê°„ í‘œì‹œ
const playerRef = ref(db,'players');
onValue(playerRef,snap=>{
  const data = snap.val() || {};
  const tbody = $('#playerTable'); tbody.innerHTML='';
  Object.entries(data).forEach(([name,info])=>{
    const tr = document.createElement('tr');
    const state = info.hidden ? 'ìˆ¨ê¹€' : 'í™œì„±';
    tr.innerHTML = `
      <td>${name}</td>
      <td>${info.level ?? '-'}</td>
      <td>${state}</td>
      <td>
        ${!info.hidden ? 
          `<button class="btn" onclick="hidePlayer('${name}')">ìˆ¨ê¹€</button>` :
          `<button class="btn ok" onclick="unhidePlayer('${name}')">ë³µêµ¬</button>`}
        <button class="btn warn" onclick="deletePlayer('${name}')">ì‚­ì œ</button>
      </td>`;
    tbody.appendChild(tr);
  });
});

// ì„ ìˆ˜ ë“±ë¡
$('#addPlayer').onclick = async()=>{
  const name = $('#playerName').value.trim();
  const level = parseInt($('#playerLevel').value);
  if(!name || !level){ toast('ì´ë¦„ê³¼ ë¶€ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
  const pRef = ref(db, 'players/'+name);
  await set(pRef, { level, hidden:false, joinedAt:Date.now() });
  $('#playerName').value=''; $('#playerLevel').value='';
  toast(`${name} ë“±ë¡ ì™„ë£Œ`);
};

// ìˆ¨ê¹€ ì²˜ë¦¬
window.hidePlayer = async(name)=>{
  await set(ref(db,'players/'+name+'/hidden'), true);
  toast(`${name} ìˆ¨ê¹€ ì²˜ë¦¬ë¨`);
};
// ë³µêµ¬
window.unhidePlayer = async(name)=>{
  await set(ref(db,'players/'+name+'/hidden'), false);
  toast(`${name} ë³µêµ¬ë¨`);
};
// ì‚­ì œ
window.deletePlayer = async(name)=>{
  if(!confirm(`${name} ì„ ìˆ˜ë¥¼ ì‚­ì œí• ê¹Œìš”?`)) return;
  await remove(ref(db,'players/'+name));
  toast(`${name} ì‚­ì œë¨`);
};

// ===== ìë™ì‚­ì œ ë¡œì§ (60ì¼ í›„ ìˆ¨ê¹€+ìŠ¹íŒ¨ì—†ìŒ) =====
async function autoCleanup(){
  const snapshot = await get(playerRef);
  const players = snapshot.val() || {};
  const matchesSnap = await get(ref(db,'matches'));
  const matches = matchesSnap.val() || {};

  const now = Date.now();
  for(const [name,info] of Object.entries(players)){
    if(info.hidden && now - (info.joinedAt||0) > 60*24*60*60*1000){
      // ê²½ê¸° ë°ì´í„°ì—ì„œ ì´ë¦„ì´ í¬í•¨ëœ ì ì´ ì—†ìœ¼ë©´ ì‚­ì œ
      const played = Object.values(matches).some(m =>
        (m.namesA?.includes(name) || m.namesB?.includes(name))
      );
      if(!played){
        await remove(ref(db,'players/'+name));
        console.log('ìë™ì‚­ì œ:',name);
      }
    }
  }
}
autoCleanup();
</script>
</body>
</html>
