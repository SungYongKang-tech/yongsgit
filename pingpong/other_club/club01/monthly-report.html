<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>📊 월간 리포트</title>
<style>
@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb;
  --accent:#2563eb; --ok:#16a34a; --danger:#ef4444; 
  --shadow:0 8px 28px rgba(0,0,0,.08);
}
body{
  margin:0;
  font-family:"Pretendard","Noto Sans KR",sans-serif;
  font-weight:600;
  color:var(--ink);
  background:var(--bg);
}
header{
  background:#fff;
  border-bottom:1px solid #e5e7eb;
  text-align:center;
  padding:14px 0;
  position:sticky;top:0;z-index:10;
}
h1{
  margin:4px 0 10px;
  color:var(--accent);
  font-weight:700;
  font-size:clamp(18px,4vw,24px);
}
.btn{
  border:1px solid #d1d5db;
  border-radius:8px;
  padding:6px 10px;
  font-size:14px;
  background:#fff;
  cursor:pointer;
  font-weight:600;
  transition:.15s;
}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.row{display:flex;justify-content:center;gap:8px;margin-bottom:10px;}
main{max-width:900px;margin:0 auto;padding:10px 10px 40px;}
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  box-shadow:var(--shadow);
  border-radius:12px;
  overflow:hidden;
  font-size:15px;
}
thead th{
  background:#f1f5f9;
  border-bottom:1px solid #e2e8f0;
  padding:6px 4px;
  text-align:center;
  color:#334155;
  font-weight:700;
  white-space:nowrap;
}
tbody td{
  border-bottom:1px solid #f1f5f9;
  padding:6px 4px;
  text-align:center;
  white-space:normal;
}
tbody tr:hover{background:#f9fafb}
.win{color:var(--ok);font-weight:700;}
.lose{color:var(--danger);font-weight:700;}
.delta{font-weight:700;}
.delta.up{color:var(--ok);}
.delta.down{color:var(--danger);}
@media(max-width:640px){
  table{font-size:13px;}
  thead th, tbody td{padding:4px 3px;}
}
</style>
</head>
<body>
<header>
  <h1 id="pageHeader">📊 월간 리포트</h1>
  <div class="row">
    <a href="index.html" class="btn">🏓 경기결과</a>
    <a href="admin.html" class="btn primary">⚙ 관리자모드</a>
  </div>
</header>

<main>
  <table>
    <thead>
      <tr>
        <th>순위</th>
        <th>이름(부수)</th>
        <th>경기</th>
        <th>승/패</th>
        <th>이전승률(%)</th>
        <th>이달승률(%)</th>
        <th>증감</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const $ = s => document.querySelector(s);

// ===== 제목 동기화 (캐시 포함) =====
const titleRef = ref(db, 'config/title');
const cachedTitle = localStorage.getItem('siteTitle');
if(cachedTitle){
  document.title = `📊 ${cachedTitle} 월간리포트`;
  $('#pageHeader').textContent = `📊 ${cachedTitle} 월간리포트`;
}
onValue(titleRef, s=>{
  const val = s.val() ?? 'PingPong Club';
  localStorage.setItem('siteTitle', val);
  document.title = `📊 ${val} 월간리포트`;
  $('#pageHeader').textContent = `📊 ${val} 월간리포트`;
});

// ===== 데이터 계산 =====
const matchRef = ref(db,'matches');
const playerRef = ref(db,'players');
let players = {};

onValue(playerRef, snap=>{
  players = snap.val() || {};
});
onValue(matchRef, snap=>{
  const data = snap.val() || {};
  const now = new Date();
  const thisMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const lastMonth = `${now.getFullYear()}-${String(now.getMonth()).padStart(2,'0')}`;

  const stats = {};
  const prevStats = {};

  // ===== 집계 =====
  Object.values(data).forEach(m=>{
    const { monthKey, winnerSide, namesA, namesB } = m;
    const names = [...namesA, ...namesB];
    if(monthKey===thisMonth || monthKey===lastMonth){
      names.forEach(n=>{
        const target = (monthKey===thisMonth)?stats:prevStats;
        if(!target[n]) target[n]={win:0,lose:0};
      });
      if(winnerSide==='A'){
        namesA.forEach(n=>{
          const target = (monthKey===thisMonth)?stats:prevStats;
          target[n].win++;
        });
        namesB.forEach(n=>{
          const target = (monthKey===thisMonth)?stats:prevStats;
          target[n].lose++;
        });
      } else if(winnerSide==='B'){
        namesB.forEach(n=>{
          const target = (monthKey===thisMonth)?stats:prevStats;
          target[n].win++;
        });
        namesA.forEach(n=>{
          const target = (monthKey===thisMonth)?stats:prevStats;
          target[n].lose++;
        });
      }
    }
  });

  // ===== 승률 계산 + 개선된 정렬 =====
  const arr = Object.entries(players).map(([id,p])=>{
    const cur = stats[p.name]||{win:0,lose:0};
    const prev = prevStats[p.name]||{win:0,lose:0};
    const curTotal = cur.win+cur.lose;
    const prevTotal = prev.win+prev.lose;
    const curRate = curTotal ? (cur.win/curTotal*100) : 0;
    const prevRate = prevTotal ? (prev.win/prevTotal*100) : 0;
    const diff = curRate - prevRate;
    return {
      name:p.name,
      level:p.level,
      total:curTotal,
      win:cur.win,
      lose:cur.lose,
      rate:curRate,
      prev:prevRate,
      delta:diff
    };
  }).filter(p=>p.total>0)
    // ✅ 개선된 정렬: 이달승률 ↓ → 경기수 ↓ → 부수 ↑
    .sort((a,b)=>{
      if(b.rate !== a.rate) return b.rate - a.rate;
      if(b.total !== a.total) return b.total - a.total;
      return a.level - b.level;
    });

  render(arr);
});

function formatNum(n){
  const val = Math.round(n*10)/10;
  return val % 1 === 0 ? val.toFixed(0) : val.toFixed(1);
}

function render(arr){
  const tbody = $('#tbody'); tbody.innerHTML = '';
  arr.forEach((p,i)=>{
    const deltaClass = p.delta>0?'up':p.delta<0?'down':'';
    const deltaSign = p.delta>0?'▲':p.delta<0?'▼':'-';
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i+1}</td>
        <td>${p.name}(${p.level})</td>
        <td>${p.total}</td>
        <td><span class="win">${p.win}</span>/<span class="lose">${p.lose}</span></td>
        <td>${formatNum(p.prev)}%</td>
        <td>${formatNum(p.rate)}%</td>
        <td class="delta ${deltaClass}">${deltaSign} ${Math.abs(formatNum(p.delta))}</td>
      </tr>
    `);
  });
}
</script>
</body>
</html>
