<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“ ì´ë‹¬ì˜ ì „ì </title>
<style>
@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb;
  --accent:#2563eb; --ok:#16a34a; --danger:#ef4444; 
  --shadow:0 8px 28px rgba(0,0,0,.08);
  --card:#ffffff;
}
body{
  margin:0;
  font-family:"Pretendard","Noto Sans KR",sans-serif;
  font-weight:600;
  color:var(--ink);
  background:var(--bg);
}
header{
  background:#fff;
  border-bottom:1px solid #e5e7eb;
  text-align:center;
  padding:14px 0;
  position:sticky;top:0;z-index:10;
}
h1{
  margin:4px 0 10px;
  color:var(--accent);
  font-weight:700;
  font-size:clamp(18px,4vw,24px);
}
.btn{
  border:1px solid #d1d5db;
  border-radius:8px;
  padding:6px 10px;
  font-size:14px;
  background:#fff;
  cursor:pointer;
  font-weight:600;
  transition:.15s;
}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.row{display:flex;justify-content:center;gap:8px;margin-bottom:10px;}
main{max-width:900px;margin:0 auto;padding:10px 10px 60px;}
/* âœ… í…Œì´ë¸” ê¸°ë³¸ ìŠ¤íƒ€ì¼ (í–‰ ë†’ì´ ê°œì„ ) */
table{
  width:100%;
  border-collapse:collapse;
  background:var(--card);
  box-shadow:var(--shadow);
  border-radius:12px;
  overflow:hidden;
  font-size:15px;
}
thead th{
  background:#f1f5f9;
  border-bottom:1px solid #e2e8f0;
  padding:10px 6px; /* âœ… ì—¬ìœ  ìˆê²Œ */
  text-align:center;
  color:#334155;
  font-weight:700;
  white-space:nowrap;
}
tbody td{
  border-bottom:1px solid #f1f5f9;
  padding:10px 6px; /* âœ… ì—¬ìœ  ìˆê²Œ */
  text-align:center;
}
tbody tr:hover{background:#f9fafb}

.win{color:var(--ok);font-weight:700;}
.lose{color:var(--danger);font-weight:700;}
.delta{font-weight:700;}
.delta.up{color:var(--ok);}
.delta.down{color:var(--danger);}

/* âœ… ìš”ì•½ ì¹´ë“œ ìŠ¤íƒ€ì¼ (ê¸€ì”¨ í‚¤ì›€ & ê°•ì¡°) */
.summary{
  margin-top:28px;
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(260px,1fr));
  gap:16px;
}
.card{
  background:var(--card);
  border-radius:12px;
  box-shadow:var(--shadow);
  padding:18px 20px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  gap:8px;
}
.card h3{
  margin:0 0 6px;
  font-size:18px; /* âœ… ê°•ì¡° */
  color:var(--accent);
  display:flex;
  align-items:center;
  gap:8px;
}
.card ul{
  margin:0;
  padding-left:22px;
  font-size:16px; /* âœ… í¬ê²Œ ë³€ê²½ */
  line-height:1.5; /* âœ… ì—¬ìœ ìˆëŠ” ê°„ê²© */
}
.card li{margin:3px 0;}
.total{
  grid-column:1 / -1;
  text-align:center;
  font-size:19px;
  font-weight:700;
  color:var(--ink);
  background:#e8f0ff;
  border-radius:12px;
  padding:12px;
}
@media(max-width:640px){
  table{font-size:13px;}
  thead th, tbody td{padding:7px 4px;} /* âœ… ëª¨ë°”ì¼ë„ ì•½ê°„ í‚¤ì›€ */
  .card ul{font-size:15px;}
}


</style>
</head>
<body>
<header>
  <h1 id="pageHeader">ğŸ“ ì´ë‹¬ì˜ ì „ì </h1>
  <div class="row">
    <a href="index.html" class="btn primary">ğŸ“ ê²½ê¸°ê²°ê³¼ ì…ë ¥</a>
    <button id="adminBtn" class="btn">âš™ ê´€ë¦¬ìëª¨ë“œ</button>
  </div>
</header>

<main>
  <table>
    <thead>
      <tr>
        <th>ìˆœìœ„</th>
        <th>ì´ë¦„(ë¶€ìˆ˜)</th>
        <th>ê²½ê¸°</th>
        <th>ìŠ¹/íŒ¨</th>
        <th>ì´ì „<br>ìŠ¹ë¥ </th>
        <th>ì´ë‹¬<br>ìŠ¹ë¥ </th>
        <th>ì¦ê°</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div id="summary" class="summary" style="display:none;"></div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue, get, remove } 
  from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
// âœ… Firebase Realtime Database ì°¸ì¡° ì„¤ì •
const matchRef = ref(db, 'matches');
const playerRef = ref(db, 'players');
const weightRef = ref(db, 'config/doubleWeight');
let players = {};
let doubleWeight = 1;

// âœ… ë³µì‹ ê°€ì¤‘ì¹˜ ë¶ˆëŸ¬ì˜¤ê¸°
get(weightRef).then(snap=>{
  if(snap.exists()) doubleWeight = parseFloat(snap.val()) || 1;
});

// âœ… ì„ ìˆ˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
onValue(playerRef, snap=>{
  players = snap.val() || {};
});

// âœ… í•­ìƒ ì†Œìˆ˜ì  í•œ ìë¦¬ê¹Œì§€ í‘œì‹œ (ì˜ˆ: 60.0%)
function formatNum(n) {
  return (Math.round(n * 10) / 10).toFixed(1);
}

// ë³µì‹ ê°€ì¤‘ì¹˜ê°€ ë¡œë“œëœ í›„ ì‹¤í–‰ë˜ë„ë¡ ë³´ì¥
setTimeout(()=> {
  onValue(matchRef, snap=>{
    // âš™ ê¸°ì¡´ ë‚´ìš© ê·¸ëŒ€ë¡œ ìœ ì§€
  });
}, 500);


// ===== ì£¼ìš” onValue ë¸”ë¡ =====
onValue(matchRef, snap=>{
  const data = snap.val() || {};
  const now = new Date();
  const thisMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const prevMonth = `${now.getFullYear()}-${String(now.getMonth()).padStart(2,'0')}`;
  const oldMonth = `${now.getFullYear()}-${String(now.getMonth()-1).padStart(2,'0')}`;

  const stats = {}, prevStats = {};

  // âœ… 2ê°œì›” ì „ ë°ì´í„° ì‚­ì œ
  Object.entries(data).forEach(([id, m])=>{
    if (!m.monthKey) return;
    if (m.monthKey <= oldMonth) remove(ref(db, `matches/${id}`));
  });

  // âœ… ì´ë‹¬ / ì „ë‹¬ ë¶„ë¦¬
  Object.values(data).forEach(m=>{
    const { monthKey, mode, winnerSide, namesA, namesB } = m;
    if (!monthKey) return;
    const names = [...namesA, ...namesB];
    const modeStr = String(mode || '').toLowerCase();
    const isDouble = ['double','doubles','ë³µì‹','mixed','mix'].includes(modeStr);
    const weight = isDouble ? doubleWeight : 1;

    const target = (monthKey===thisMonth) ? stats : (monthKey===prevMonth ? prevStats : null);
    if (!target) return;

    names.forEach(n => { if (!target[n]) target[n] = {win:0, lose:0}; });
    if (winnerSide === 'A') {
      namesA.forEach(n => target[n].win += weight);
      namesB.forEach(n => target[n].lose += weight);
    } else if (winnerSide === 'B') {
      namesB.forEach(n => target[n].win += weight);
      namesA.forEach(n => target[n].lose += weight);
    }
  });

  function makeArr(obj){
    return Object.entries(players).map(([id,p])=>{
      const d = obj[p.name] || {win:0, lose:0};
      const total = d.win + d.lose;
      const rate = total ? (d.win/total*100) : 0;
      return { name:p.name, level:p.level, total, win:d.win, lose:d.lose, rate };
    }).filter(p=>p.total>0)
      .sort((a,b)=>b.rate - a.rate || b.total - a.total || a.level - b.level);
  }

  const curArr = makeArr(stats);
  const prevArr = makeArr(prevStats);

  render(curArr, thisMonth, prevArr, prevMonth); // âœ… ì •ìƒ ë™ì‘
});

// ===== render í•¨ìˆ˜ =====
function render(curArr, thisMonth, prevArr, prevMonth){
  const main = document.querySelector('main');

  
  main.innerHTML = `
    <h2 id="currentTitle" style="
      text-align:center;
      font-size:22px;
      color:#1e3a8a;
      margin:20px 0 14px;
      font-weight:800;
    ">
      ğŸ“ ì´ë‹¬ì˜ ì „ì ('${thisMonth.slice(2)}')
    </h2>
    <table id="tableCurrent">
      <thead>
        <tr>
          <th>ìˆœìœ„</th>
          <th>ì´ë¦„(ë¶€ìˆ˜)</th>
          <th>ê²½ê¸°</th>
          <th>ìŠ¹/íŒ¨</th>
          <th>ì´ì „<br>ìŠ¹ë¥ </th>
          <th>ì´ë‹¬<br>ìŠ¹ë¥ </th>
          <th>ì¦ê°</th>
        </tr>
      </thead>
      <tbody id="tbodyCurrent"></tbody>
    </table>

    ${prevArr.length ? `
      <h3 style="
        text-align:center;
        font-size:20px;
        color:#334155;
        margin:28px 0 8px;
        border-top:2px solid #e2e8f0;
        padding-top:12px;
      ">
        ì§€ë‚œë‹¬ ì „ì ('${prevMonth.slice(2)}')
      </h3>
      <table id="tablePrev">
        <thead>
          <tr>
            <th>ìˆœìœ„</th>
            <th>ì´ë¦„(ë¶€ìˆ˜)</th>
            <th>ê²½ê¸°</th>
            <th>ìŠ¹/íŒ¨</th>
            <th>ìŠ¹ë¥ </th>
          </tr>
        </thead>
        <tbody id="tbodyPrev"></tbody>
      </table>
    ` : ''}
    
    <p id="ruleNote" style="
      text-align:center;
      color:#2563eb;
      font-size:14px;
      margin-top:16px;
      font-weight:600;
    ">
      âš ï¸ ìˆœìœ„ëŠ” ë‚ ì§œ ê¸°ì¤€ ê²½ê¸°ìˆ˜(10ì¼:5ê²½ê¸° Â· 20ì¼:10ê²½ê¸° Â· ë§ì¼:15ê²½ê¸°) ì´ìƒìë§Œ í¬í•¨ë©ë‹ˆë‹¤.
    </p>
  `;

  // === ë‚ ì§œ ê¸°ì¤€ ê²½ê¸°ìˆ˜ ì œí•œ ===
  const today = new Date().getDate();
  let requiredGames = 5;
  if (today > 20) requiredGames = 15;
  else if (today > 10) requiredGames = 10;

  // === ì´ë‹¬ ë°ì´í„° ===
  const tbodyCur = document.querySelector('#tbodyCurrent');
  const qualified = curArr.filter(p => p.total >= requiredGames);
  const unqualified = curArr.filter(p => p.total < requiredGames);

  qualified.forEach((p, i) => {
    const cls = p.delta > 0 ? 'up' : p.delta < 0 ? 'down' : '';
    const sign = p.delta > 0 ? 'â–²' : p.delta < 0 ? 'â–¼' : '-';
    const bg = 'style="background-color:#e0f2fe"';
    const prevText = (p.prev && p.prev > 0) ? `${formatNum(p.prev)}%` : 'â€“';
    const deltaText = (p.prev && p.prev > 0) ? `${sign} ${Math.abs(formatNum(p.delta)).toFixed(1)}%p` : 'â€“';
    tbodyCur.insertAdjacentHTML('beforeend', `
      <tr ${bg}>
        <td>${i + 1}</td>
        <td>${p.name}(${p.level})</td>
        <td>${formatNum(p.total)}</td>
        <td><span class="win">${formatNum(p.win)}</span>/<span class="lose">${formatNum(p.lose)}</span></td>
        <td>${prevText}</td>
        <td>${formatNum(p.rate)}%</td>
        <td class="delta ${cls}">${deltaText}</td>
      </tr>
    `);
  });

  if (unqualified.length > 0) {
    tbodyCur.insertAdjacentHTML('beforeend', `
      <tr><td colspan="7" style="text-align:center;background:#f8fafc;color:#64748b;">âšª ì´í•˜ ì¡°ê±´ ë¯¸ë‹¬ì âšª</td></tr>
    `);
    unqualified.forEach(p => {
      const cls = p.delta > 0 ? 'up' : p.delta < 0 ? 'down' : '';
      const sign = p.delta > 0 ? 'â–²' : p.delta < 0 ? 'â–¼' : '-';
      const prevText = (p.prev && p.prev > 0) ? `${formatNum(p.prev)}%` : 'â€“';
      const deltaText = (p.prev && p.prev > 0) ? `${sign} ${Math.abs(formatNum(p.delta)).toFixed(1)}%p` : 'â€“';
      tbodyCur.insertAdjacentHTML('beforeend', `
        <tr>
          <td>-</td>
          <td>${p.name}(${p.level})</td>
          <td>${formatNum(p.total)}</td>
          <td><span class="win">${formatNum(p.win)}</span>/<span class="lose">${formatNum(p.lose)}</span></td>
          <td>${prevText}</td>
          <td>${formatNum(p.rate)}%</td>
          <td class="delta ${cls}">${deltaText}</td>
        </tr>
      `);
    });
  }

  // === ì§€ë‚œë‹¬ ë°ì´í„° ===
  if (prevArr.length > 0) {
    const tbodyPrev = document.querySelector('#tbodyPrev');
    prevArr.forEach((p, i) => {
      tbodyPrev.insertAdjacentHTML('beforeend', `
        <tr style="background:#f9fafb;">
          <td>${i + 1}</td>
          <td>${p.name}(${p.level})</td>
          <td>${formatNum(p.total)}</td>
          <td><span class="win">${formatNum(p.win)}</span>/<span class="lose">${formatNum(p.lose)}</span></td>
          <td>${p.total > 0 ? `${formatNum(p.rate)}%` : 'â€“'}</td>
        </tr>
      `);
    });
  }
}



function summary(arr){
  if(!arr.length) return;
  const box=$('#summary');
  const totalMatches=Math.round(arr.reduce((s,p)=>s+p.total,0)/2);
  const topPlay=arr.slice().sort((a,b)=>b.total-a.total).slice(0,3);
  const topWin=arr.slice().sort((a,b)=>b.win-a.win).slice(0,3);
  const topDelta=arr.slice().sort((a,b)=>b.delta-a.delta).slice(0,3);
  const promote=arr.filter(p=>p.rate>=80 && p.total>=5).slice(0,5);

  box.innerHTML=`
    <div class="total">ì´ ê²½ê¸° ìˆ˜: ${totalMatches} ê²½ê¸°</div>
    <div class="card"><h3>ğŸ® ìµœë‹¤ê²½ê¸° TOP3</h3>
      <ul>${topPlay.map(p=>`<li>${p.name} (${formatNum(p.total)} ê²½ê¸°)</li>`).join('')}</ul>
    </div>
    <div class="card"><h3>ğŸ† ë‹¤ìŠ¹ TOP3</h3>
      <ul>${topWin.map(p=>`<li>${p.name} (${formatNum(p.win)}ìŠ¹)</li>`).join('')}</ul>
    </div>
    <div class="card"><h3>ğŸ“ˆ ê¸°ëŸ‰ìƒìŠ¹ TOP3</h3>
      <ul>${topDelta.map(p=>`<li>${p.name} (+${formatNum(p.delta)}%p)</li>`).join('')}</ul>
    </div>
    <div class="card"><h3>ğŸš€ ë¶€ìˆ˜ìƒí–¥ ê¶Œê³ </h3>
      <ul>${promote.length?promote.map(p=>`<li>${p.name} (${formatNum(p.rate)}%)</li>`).join(''):'<li>ì—†ìŒ</li>'}</ul>
    </div>
  `;
  box.style.display='grid';
}

// âœ… ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ í™•ì¸
window.addEventListener("DOMContentLoaded",()=>{
  const btn=document.getElementById("adminBtn");
  if(!btn)return;
  btn.addEventListener("click",async()=>{
    try{
      const pwRef=ref(db,"config/adminPassword");
      const snap=await get(pwRef);
      const saved=snap.exists()?snap.val():"1234";
      const input=prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      if(input===null)return;
      if(input!==saved){alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");return;}
      window.location.href="admin.html";
    }catch(err){alert("ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");console.error(err);}
  });
});
</script>
</body>
</html>
