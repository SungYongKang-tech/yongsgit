<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“ ê²½ê¸° ê²°ê³¼ ì…ë ¥</title>
<style>
:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb;
  --primary:#0d47a1; --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
  --chip:#eef2ff; --bd:#d1d5db;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--ink)}
.wrap{max-width:980px;margin:0 auto;padding:16px}
h1{margin:4px 0 10px;color:var(--primary);font-size:clamp(18px,4vw,24px)}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:14px;box-shadow:0 8px 28px rgba(0,0,0,.08);margin:12px 0}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{border:1px solid var(--bd);border-radius:10px;padding:8px 12px;font-size:14px;background:#fff;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.ok{background:var(--ok);color:#fff;border-color:var(--ok)}
.btn.warn{background:var(--danger);color:#fff;border-color:var(--danger)}
.seg{display:inline-flex;background:#eef2ff;border:1px solid var(--bd);border-radius:999px;padding:2px}
.seg button{border:0;background:transparent;padding:8px 12px;border-radius:999px;cursor:pointer;font-size:14px}
.seg button.active{background:#fff;outline:2px solid var(--accent)}
.chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--bd);cursor:pointer;background:var(--chip);font-size:13px}
.chip.selectedA{outline:2px solid #2563eb;background:#fff}
.chip.selectedB{outline:2px solid #ef4444;background:#fff}
.small{font-size:12px;color:var(--muted)}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;pointer-events:none;transition:.25s}
.toast.show{opacity:1}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h1>ğŸ“ ê²½ê¸° ê²°ê³¼ ì…ë ¥</h1>
        <div class="row">
          <a class="btn" href="admin.html">âš™ï¸ ê´€ë¦¬ì</a>
          <a class="btn primary" href="monthly-report.html">ğŸ“Š ì›”ê°„ ë¦¬í¬íŠ¸</a>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- ëª¨ë“œ í† ê¸€ -->
    <section class="card">
      <div class="row" style="gap:12px">
        <div class="seg" id="modeSeg">
          <button data-mode="single" class="active">ë‹¨ì‹</button>
          <button data-mode="double">ë³µì‹</button>
        </div>
        <button id="clearSel" class="btn">ì„ íƒ ì´ˆê¸°í™”</button>
        <div class="small" id="hint">ë‹¨ì‹: ì„ ìˆ˜ë¥¼ <b>ë‘ ëª…</b> ì„ íƒí•˜ë©´ ì•„ë˜ì— <b>ìŠ¹ì ì´ë¦„ ë²„íŠ¼</b>ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>
      </div>
    </section>

    <!-- ì„ ìˆ˜ ëª©ë¡ -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:700">ì„ ìˆ˜ ì„ íƒ</div>
        <div class="small">ë²„íŠ¼: ì´ë¦„(ë¶€ìˆ˜) Â· ìˆ¨ê¹€ ì„ ìˆ˜ëŠ” ìë™ ì œì™¸</div>
      </div>
      <div id="chips" class="chips" style="margin-top:8px">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
    </section>

    <!-- ìŠ¹ì ì…ë ¥ -->
    <section id="winnerCard" class="card" style="display:none">
      <div class="row center" style="justify-content:center;gap:8px;margin-bottom:8px">
        <span class="btn" style="pointer-events:none">AíŒ€: <b id="teamALabel">-</b></span>
        <span class="btn" style="pointer-events:none">BíŒ€: <b id="teamBLabel">-</b></span>
      </div>
      <div id="singleWinnerBox" class="row center" style="justify-content:center;gap:12px;display:none">
        <button id="winSingleA" class="btn ok"></button>
        <button id="winSingleB" class="btn warn"></button>
      </div>
      <div id="doubleWinnerBox" class="row center" style="justify-content:center;gap:12px;display:none">
        <button id="winA" class="btn ok">ìŠ¹ì: AíŒ€</button>
        <button id="winB" class="btn warn">ìŠ¹ì: BíŒ€</button>
      </div>
      <div class="small" style="text-align:center;margin-top:6px">ì €ì¥ í›„ ìë™ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.</div>
    </section>
  </main>

  <div id="toast" class="toast">Saved</div>

<script type="module">
/* ===== Firebase ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ===== Utils ===== */
const $ = (s,ctx=document)=>ctx.querySelector(s);
const toast = (msg='ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤')=>{
  const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1500);
};
const pad=(n)=>String(n).padStart(2,'0');
const toKST = (t = Date.now()) => new Date(new Date(t).toLocaleString('en-US', { timeZone:'Asia/Seoul' }));
const monthKeyFromTs = (ts)=>{ const d=toKST(ts); return `${d.getFullYear()}-${pad(d.getMonth()+1)}`; };

/* ===== ìƒíƒœ ===== */
let mode = 'single';         // 'single' | 'double'
let players = [];            // {id,name,level,hidden}
let sel = [];                // ì„ íƒëœ ì„ ìˆ˜ id ë°°ì—´ (ì„ íƒ ìˆœì„œ ìœ ì§€)

/* ===== ëª¨ë“œ í† ê¸€ ===== */
const modeSeg = $('#modeSeg'), hint = $('#hint');
modeSeg.addEventListener('click', e=>{
  const btn = e.target.closest('button[data-mode]'); if(!btn) return;
  modeSeg.querySelectorAll('button').forEach(b=>b.classList.toggle('active', b===btn));
  mode = btn.dataset.mode;
  sel = [];
  renderChips();
  renderWinnerBox();
  hint.innerHTML = (mode==='single')
    ? 'ë‹¨ì‹: ì„ ìˆ˜ë¥¼ <b>ë‘ ëª…</b> ì„ íƒí•˜ë©´ ì•„ë˜ì— <b>ìŠ¹ì ì´ë¦„ ë²„íŠ¼</b>ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.'
    : 'ë³µì‹: ì„ ìˆ˜ë¥¼ <b>ë„¤ ëª…</b> ì„ íƒí•˜ì„¸ìš”. ì• 2ëª…=AíŒ€, ë’¤ 2ëª…=BíŒ€. (íŒ€ ë°”ê¾¸ë ¤ë©´ ì„ íƒ í•´ì œ í›„ ë‹¤ì‹œ ì„ íƒ)';
});
$('#clearSel').onclick = ()=>{ sel=[]; renderChips(); renderWinnerBox(); };

/* ===== ì„ ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸° (ìˆ¨ê¹€ ì œì™¸) ===== */
onValue(ref(db,'players'), snap=>{
  const data = snap.val() || {};
  players = Object.entries(data)
    .map(([id,p])=>({ id, ...p }))
    .filter(p=>!p.hidden)
    .sort((a,b)=>(a.level-b.level) || a.name.localeCompare(b.name,'ko'));
  renderChips();
});

/* ===== ì„ ìˆ˜ ì¹© ë Œë” ===== */
function renderChips(){
  const box = $('#chips'); box.innerHTML='';
  if(!players.length){ box.textContent='ë“±ë¡ëœ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.'; return; }
  players.forEach(p=>{
    const btn = document.createElement('button');
    btn.className = 'chip';
    btn.textContent = `${p.name}(${p.level})`;
    if(sel.includes(p.id)){
      const idx = sel.indexOf(p.id);
      btn.classList.add(idx<2 ? 'selectedA' : 'selectedB'); // ì• 2ëª…=A, ë’¤ 2ëª…=B(ë³µì‹ ê¸°ì¤€)
    }
    btn.onclick = ()=>{
      const need = (mode==='single') ? 2 : 4;
      const i = sel.indexOf(p.id);
      if(i>=0){ sel.splice(i,1); }
      else{
        if(sel.length>=need){ toast(mode==='single'?'ë‹¨ì‹ì€ ë‘ ëª…ë§Œ ì„ íƒ':'ë³µì‹ì€ ë„¤ ëª…ë§Œ ì„ íƒ'); return; }
        sel.push(p.id);
      }
      renderChips(); renderWinnerBox();
    };
    box.appendChild(btn);
  });
}

/* ===== íŒ€/ìŠ¹ì UI ===== */
function computeTeams(){
  const need = (mode==='single') ? 2 : 4;
  if(sel.length!==need) return null;
  if(mode==='single'){
    const A = [sel[0]], B = [sel[1]];
    return {A,B};
  }else{
    const A = [sel[0], sel[1]], B = [sel[2], sel[3]];
    return {A,B};
  }
}

function renderWinnerBox(){
  const card = $('#winnerCard');
  const tA = $('#teamALabel'), tB=$('#teamBLabel');
  const singleBox = $('#singleWinnerBox'), doubleBox = $('#doubleWinnerBox');

  const teams = computeTeams();
  if(!teams){ card.style.display='none'; return; }

  const namesA = teams.A.map(id=>players.find(p=>p.id===id)?.name||id);
  const namesB = teams.B.map(id=>players.find(p=>p.id===id)?.name||id);
  tA.textContent = (mode==='double') ? namesA.join('/') : namesA[0];
  tB.textContent = (mode==='double') ? namesB.join('/') : namesB[0];

  if(mode==='single'){
    singleBox.style.display='';
    doubleBox.style.display='none';
    // ë‹¨ì‹: ìŠ¹ì ì´ë¦„ ë²„íŠ¼ 2ê°œ
    $('#winSingleA').textContent = `ìŠ¹ì: ${namesA[0]}`;
    $('#winSingleB').textContent = `ìŠ¹ì: ${namesB[0]}`;
  }else{
    singleBox.style.display='none';
    doubleBox.style.display='';
  }
  card.style.display='';
}

/* ===== ì €ì¥ ===== */
$('#winSingleA').onclick = ()=> saveMatch('A');
$('#winSingleB').onclick = ()=> saveMatch('B');
$('#winA').onclick       = ()=> saveMatch('A');
$('#winB').onclick       = ()=> saveMatch('B');

async function saveMatch(winnerSide){
  const teams = computeTeams();
  if(!teams){ toast(mode==='single'?'ë‘ ëª…ë¶€í„° ì„ íƒí•˜ì„¸ìš”':'ë„¤ ëª…ë¶€í„° ì„ íƒí•˜ì„¸ìš”'); return; }

  // ë©”íƒ€ êµ¬ì„±
  const getMeta = (ids)=> {
    const nms = ids.map(id=> players.find(p=>p.id===id)?.name || id);
    const lv  = ids.map(id=> players.find(p=>p.id===id)?.level ?? null);
    return { ids, names:nms, levels:lv };
  };
  const A = getMeta(teams.A);
  const B = getMeta(teams.B);

  const now = Date.now();
  const match = {
    ts: now,
    monthKey: monthKeyFromTs(now),   // KST ê¸°ì¤€
    mode,                            // 'single' | 'double'
    membersA: A.ids, membersB: B.ids,
    namesA: A.names,  namesB:  B.names,
    levelsA: A.levels, levelsB: B.levels,
    winnerSide,                      // 'A' | 'B'
    score: null,
    createdAt: now
  };

  try{
    await set(push(ref(db,'matches')), match);
    toast(`${mode==='single'?'ë‹¨ì‹':'ë³µì‹'} ì €ì¥ ì™„ë£Œ (${winnerSide==='A'?'AíŒ€':'BíŒ€'} ìŠ¹)`);
    sel=[]; renderChips(); renderWinnerBox();
  }catch(e){
    console.error(e);
    toast(e?.message || 'ì €ì¥ ì‹¤íŒ¨');
  }
}
</script>
</body>
</html>
