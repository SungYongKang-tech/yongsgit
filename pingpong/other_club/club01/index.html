<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>⭐ PingPong Club 경기결과 입력</title>
<style>
:root{
  --ink:#0f172a; --muted:#64748b; --card:#fff; --bg:#f5f7fb;
  --primary:#0d47a1; --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
  --shadow:0 8px 28px rgba(0,0,0,.08)
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
  color:var(--ink);background:var(--bg)}
header{position:sticky;top:0;z-index:20;background:#fff;
  border-bottom:1px solid #e5e7eb;box-shadow:var(--shadow,none)}
.wrap{max-width:960px;margin:0 auto;padding:14px 16px}
h1{margin:4px 0 6px;font-size:clamp(18px,4vw,22px);color:var(--primary)}
.btn{border:1px solid #d1d5db;border-radius:8px;padding:8px 14px;
  font-size:14px;background:#fff;cursor:pointer;transition:.15s}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.ok{background:var(--ok);color:#fff;border-color:var(--ok)}
.btn.warn{background:var(--danger);color:#fff;border-color:var(--danger)}
main{max-width:960px;margin:0 auto;padding:20px 16px}
.row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center}
.chip{border:1px solid #cbd5e1;border-radius:999px;padding:6px 10px;
  font-size:15px;cursor:pointer;transition:.2s;background:#fff;color:#111}
.chip.selected{outline:2px solid var(--accent);background:#e0e7ff}
#match-buttons{margin-top:12px;text-align:center}
#logs{margin-top:20px;background:var(--card);border-radius:12px;
  box-shadow:var(--shadow);padding:12px}
.log-item{border-bottom:1px solid #e5e7eb;padding:10px 6px}
.log-item:last-child{border-bottom:none}
.log-time{font-size:12px;color:#64748b;display:block;margin-bottom:3px}
.log-match{font-size:15px;word-break:keep-all}
.log-win{color:#2563eb;font-weight:600}
.toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);
  background:#111827;color:#fff;padding:8px 12px;border-radius:10px;
  opacity:0;transition:.25s}
.toast.show{opacity:1}
@media (max-width:640px){
  h1{font-size:18px}
  .btn{font-size:13px;padding:6px 10px}
  .chip{font-size:14px}
  .log-match{font-size:15px}
}
</style>
</head>
<body>
<header>
  <div class="wrap row" style="justify-content:space-between">
    <h1>🏓 PingPong Club 경기결과 입력</h1>
    <div class="row">
      <a href="admin.html" class="btn">⚙️ 관리자</a>
      <a href="monthly.html" class="btn primary">📊 월간 결과</a>
    </div>
  </div>
</header>

<main>
  <div class="row">
    <button id="singleBtn" class="btn primary">단식</button>
    <button id="doubleBtn" class="btn">복식</button>
  </div>

  <div id="chips" class="row" style="margin-top:10px"></div>

  <div id="match-buttons" style="display:none">
    <button id="winA" class="btn ok">A팀 승</button>
    <button id="winB" class="btn warn">B팀 승</button>
  </div>

  <div id="logs"></div>
</main>

<div id="toast" class="toast">저장되었습니다</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// ✅ Firebase 설정
const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const $ = s => document.querySelector(s);
const toast = (msg="저장되었습니다")=>{
  const t=$("#toast");t.textContent=msg;t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1500);
};

// ===== 상태 =====
let players=[], sel=[], mode='single';
const LEVEL_COLORS={
  1:'#ef4444',2:'#06b6d4',3:'#f59e0b',4:'#8b5cf6',
  5:'#84cc16',6:'#3b82f6',7:'#f97316',8:'#10b981',
  9:'#a855f7',10:'#eab308',11:'#22c55e',12:'#0ea5e9',
  13:'#d946ef',14:'#6366f1'
};

// ===== 모드 전환 =====
$("#singleBtn").onclick=()=>{
  mode='single';
  $("#singleBtn").classList.add('primary');
  $("#doubleBtn").classList.remove('primary');
  sel=[];renderChips();$("#match-buttons").style.display='none';
};
$("#doubleBtn").onclick=()=>{
  mode='double';
  $("#doubleBtn").classList.add('primary');
  $("#singleBtn").classList.remove('primary');
  sel=[];renderChips();$("#match-buttons").style.display='none';
};

// ===== 선수 목록 로드 =====
onValue(ref(db,'players'),snap=>{
  const data=snap.val()||{};
  players=Object.values(data)
    .filter(p=>!p.hidden)
    .map(p=>({name:p.name,level:p.level}))
    .sort((a,b)=>(a.level-b.level)||a.name.localeCompare(b.name,'ko'));
  renderChips();
});

// ===== 칩 렌더링 =====
function renderChips(){
  const box=$("#chips");
  box.innerHTML="";
  const need=(mode==='single'?2:4);
  players.forEach(p=>{
    const btn=document.createElement("button");
    btn.className="chip";
    btn.textContent=`${p.name}(${p.level})`;
    const c=LEVEL_COLORS[p.level]||'#94a3b8';
    btn.style.borderColor=c;btn.style.background=c+'22';

    if(sel.some(x=>x.name===p.name)){
      btn.classList.add('selected');
      btn.style.background='#fff';
      btn.style.outline=`2px solid ${c}`;
    }

    btn.onclick=()=>{
      const idx=sel.findIndex(x=>x.name===p.name);
      if(idx>=0) sel.splice(idx,1);
      else{
        if(sel.length>=need){toast("선택 인원 초과");return;}
        sel.push(p);
      }
      renderChips();
      $("#match-buttons").style.display = sel.length===need ? 'block':'none';
    };
    box.appendChild(btn);
  });
}

// ===== KST 기준 월키 =====
function getMonthKey(ts=Date.now()){
  const d=new Date(new Date(ts).toLocaleString('en-US',{timeZone:'Asia/Seoul'}));
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
}

// ===== 경기 저장 =====
$("#winA").onclick=()=>saveMatch('A');
$("#winB").onclick=()=>saveMatch('B');

function saveMatch(winnerSide){
  const need=(mode==='single'?2:4);
  if(sel.length<need){toast("선수 선택이 부족합니다");return;}
  const namesA=sel.slice(0,need/2).map(p=>p.name);
  const namesB=sel.slice(need/2).map(p=>p.name);
  const obj={
    mode,monthKey:getMonthKey(),
    namesA,namesB,winnerSide,createdAt:Date.now()
  };
  push(ref(db,'matches'),obj);
  toast("경기결과 저장 완료");
  sel=[];renderChips();$("#match-buttons").style.display='none';
}

// ===== 최근 경기 표시 =====
onValue(ref(db,'matches'),snap=>{
  const data=snap.val()||{};
  const all=Object.values(data);
  const now=new Date();
  const kstNow=new Date(now.toLocaleString('en-US',{timeZone:'Asia/Seoul'}));
  const curKey=`${kstNow.getFullYear()}-${String(kstNow.getMonth()+1).padStart(2,'0')}`;
  const prevDate=new Date(kstNow.getFullYear(),kstNow.getMonth()-1,1);
  const prevKey=`${prevDate.getFullYear()}-${String(prevDate.getMonth()+1).padStart(2,'0')}`;
  const arr=all.filter(m=>m.monthKey===curKey||m.monthKey===prevKey)
               .sort((a,b)=>b.createdAt-a.createdAt);
  renderLogs(arr);
});

function renderLogs(arr){
  const logs=$("#logs");logs.innerHTML="";
  if(!arr.length){logs.innerHTML='<div style="text-align:center;color:#999">최근 경기 없음</div>';return;}
  arr.forEach(m=>{
    const d=new Date(m.createdAt);
    const kst=new Date(d.toLocaleString('en-US',{timeZone:'Asia/Seoul'}));
    const timeStr=`${kst.getFullYear()}-${String(kst.getMonth()+1).padStart(2,'0')}-${String(kst.getDate()).padStart(2,'0')} ${String(kst.getHours()).padStart(2,'0')}:${String(kst.getMinutes()).padStart(2,'0')}`;
    const winA=m.winnerSide==='A';
    const aTeam=m.namesA.join('/');
    const bTeam=m.namesB.join('/');
    const html=`
      <div class="log-item">
        <span class="log-time">${timeStr} [${m.mode==='double'?'복식':'단식'}]</span>
        <span class="log-match">
          <span class="${winA?'log-win':''}">${aTeam}</span>
          vs
          <span class="${!winA?'log-win':''}">${bTeam}</span>
          (승)
        </span>
      </div>`;
    logs.insertAdjacentHTML('beforeend',html);
  });
}
</script>
</body>
</html>
