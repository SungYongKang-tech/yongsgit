<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>🏓 경기결과 입력</title>
<style>
:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb;
  --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
}
body{margin:0;font-family:system-ui,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--ink)}
.wrap{max-width:800px;margin:0 auto;padding:20px}
h1{text-align:center;color:var(--accent)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin-bottom:12px}
.btn{border:1px solid #ccc;border-radius:6px;padding:6px 10px;font-size:14px;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.ok{background:var(--ok);color:#fff;border-color:var(--ok)}
.btn.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
.chip{border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-size:14px;cursor:pointer;transition:.2s}
.chip.selected{outline:2px solid var(--accent);background:#fff}
#logs{margin-top:18px;background:#fff;border-radius:12px;padding:10px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.log-item{border-bottom:1px solid #e5e7eb;padding:6px 4px;font-size:14px}
.log-item:last-child{border-bottom:none}
.log-time{color:#64748b;font-size:12px;margin-right:4px}
.log-win{color:#2563eb;font-weight:600}
.toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:8px 12px;border-radius:10px;opacity:0;transition:.25s}
.toast.show{opacity:1}
</style>
</head>
<body>
<div class="wrap">
  <h1>🏓 경기결과 입력</h1>

  <div class="row">
    <button id="singleBtn" class="btn primary">단식</button>
    <button id="doubleBtn" class="btn">복식</button>
  </div>

  <div id="chips" class="row"></div>

  <div class="row" style="margin-top:10px">
    <button id="winA" class="btn ok">A팀 승</button>
    <button id="winB" class="btn danger">B팀 승</button>
  </div>

  <div id="logs"></div>
</div>

<div id="toast" class="toast">저장되었습니다</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// ✅ Firebase 설정
const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const $ = s=>document.querySelector(s);
const toast=(msg="저장되었습니다")=>{
  const t=$("#toast");t.textContent=msg;t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1500);
};

// ===== 상태 =====
let players=[], sel=[], mode='single';
const LEVEL_COLORS={
  1:'#ef4444',2:'#06b6d4',3:'#f59e0b',4:'#8b5cf6',
  5:'#84cc16',6:'#3b82f6',7:'#f97316',8:'#10b981',
  9:'#a855f7',10:'#eab308',11:'#22c55e',12:'#0ea5e9',
  13:'#d946ef',14:'#6366f1'
};

// ===== 모드 전환 =====
$("#singleBtn").onclick=()=>{
  mode='single';
  $("#singleBtn").classList.add('primary');
  $("#doubleBtn").classList.remove('primary');
  sel=[];renderChips();
};
$("#doubleBtn").onclick=()=>{
  mode='double';
  $("#doubleBtn").classList.add('primary');
  $("#singleBtn").classList.remove('primary');
  sel=[];renderChips();
};

// ===== 선수 로딩 =====
onValue(ref(db,'players'),snap=>{
  const data=snap.val()||{};
  players=Object.values(data)
    .filter(p=>!p.hidden)
    .map(p=>({name:p.name,level:p.level}))
    .sort((a,b)=>(a.level-b.level)||a.name.localeCompare(b.name,'ko'));
  renderChips();
});

// ===== 칩 렌더링 =====
function renderChips(){
  const box=$("#chips");
  box.innerHTML="";
  const need=(mode==='single'?2:4);

  players.forEach(p=>{
    const btn=document.createElement('button');
    btn.className='chip';
    btn.textContent=`${p.name}(${p.level})`;
    const c=LEVEL_COLORS[p.level]||'#94a3b8';
    btn.style.background=c+'22';
    btn.style.borderColor=c;
    btn.style.color='#111'; // 글씨 검정

    if(sel.some(x=>x.name===p.name)){
      btn.classList.add('selected');
      btn.style.outline=`2px solid ${c}`;
      btn.style.background='#fff';
    }

    btn.onclick=()=>{
      const idx=sel.findIndex(x=>x.name===p.name);
      if(idx>=0) sel.splice(idx,1);
      else{
        if(sel.length>=need){toast('선택 인원 초과');return;}
        sel.push(p);
      }
      renderChips();
    };
    box.appendChild(btn);
  });
}

// ===== KST 기준 월키 =====
function getMonthKey(ts=Date.now()){
  const d=new Date(new Date(ts).toLocaleString('en-US',{timeZone:'Asia/Seoul'}));
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
}

// ===== 저장 =====
$("#winA").onclick=()=>saveMatch('A');
$("#winB").onclick=()=>saveMatch('B');

function saveMatch(winnerSide){
  const need=(mode==='single'?2:4);
  if(sel.length<need){toast('선수 선택이 부족합니다');return;}

  const namesA=sel.slice(0,need/2).map(p=>p.name);
  const namesB=sel.slice(need/2).map(p=>p.name);

  const obj={
    mode,
    monthKey:getMonthKey(),
    namesA,
    namesB,
    winnerSide,
    createdAt:Date.now()
  };
  push(ref(db,'matches'),obj);
  toast('경기결과 저장 완료');
  sel=[];renderChips();
}

// ===== 최근 저장 목록 =====
onValue(ref(db,'matches'),snap=>{
  const data=snap.val()||{};
  const all=Object.values(data);

  // 이번달 + 지난달만 표시
  const now=new Date();
  const kstNow=new Date(now.toLocaleString('en-US',{timeZone:'Asia/Seoul'}));
  const curKey=`${kstNow.getFullYear()}-${String(kstNow.getMonth()+1).padStart(2,'0')}`;
  const prevDate=new Date(kstNow.getFullYear(),kstNow.getMonth()-1,1);
  const prevKey=`${prevDate.getFullYear()}-${String(prevDate.getMonth()+1).padStart(2,'0')}`;

  const arr=all.filter(m=>m.monthKey===curKey||m.monthKey===prevKey)
               .sort((a,b)=>b.createdAt-a.createdAt);

  renderLogs(arr);
});

function renderLogs(arr){
  const logs=$("#logs");
  logs.innerHTML='';
  if(!arr.length){logs.innerHTML='<div class="muted" style="text-align:center;color:#999">최근 경기 기록이 없습니다.</div>';return;}

  arr.forEach(m=>{
    const d=new Date(m.createdAt);
    const kst=new Date(d.toLocaleString('en-US',{timeZone:'Asia/Seoul'}));
    const timeStr=`${kst.getFullYear()}-${String(kst.getMonth()+1).padStart(2,'0')}-${String(kst.getDate()).padStart(2,'0')} ${String(kst.getHours()).padStart(2,'0')}:${String(kst.getMinutes()).padStart(2,'0')}`;

    const winA=m.winnerSide==='A';
    const namesA=m.namesA.join(', ');
    const namesB=m.namesB.join(', ');
    const html=`
      <div class="log-item">
        <span class="log-time">${timeStr}</span>
        <span class="${winA?'log-win':''}">${namesA}</span>
        vs
        <span class="${!winA?'log-win':''}">${namesB}</span>
        ${m.mode==='double'?'(복식)':'(단식)'}
      </div>`;
    logs.insertAdjacentHTML('beforeend',html);
  });
}
</script>
</body>
</html>
