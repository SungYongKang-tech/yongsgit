<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ğŸ“ ê²½ê¸° ê²°ê³¼ ì…ë ¥</title>
<style>
:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb;
  --primary:#0d47a1; --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
}
body{margin:0;font-family:system-ui,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--ink)}
.wrap{max-width:720px;margin:0 auto;padding:18px}
h1{text-align:center;color:var(--primary);margin-bottom:10px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin:10px 0}
.btn{border:1px solid #ccc;border-radius:8px;padding:8px 12px;font-size:15px;background:#fff;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.ok{background:var(--ok);color:#fff;border-color:var(--ok)}
.btn.warn{background:var(--danger);color:#fff;border-color:var(--danger)}
.player{border:1px solid #ccc;border-radius:8px;padding:8px 12px;margin:5px;background:#fff;cursor:pointer;transition:.2s}
.player.selectedA{background:#bfdbfe;border-color:#1d4ed8}
.player.selectedB{background:#fecaca;border-color:#b91c1c}
.player.hidden{opacity:0.4;pointer-events:none}
.toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);
background:#111827;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:.25s}
.toast.show{opacity:1}
small{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ“ ê²½ê¸° ê²°ê³¼ ì…ë ¥</h1>

  <div class="row">
    <button id="modeSingle" class="btn primary">ë‹¨ì‹</button>
    <button id="modeDouble" class="btn">ë³µì‹</button>
    <a href="monthly-report.html" class="btn">ğŸ“Š ë¦¬í¬íŠ¸</a>
    <a href="admin.html" class="btn">âš™ï¸ ê´€ë¦¬ì</a>
  </div>

  <div class="row"><small>â€» ì„ ìˆ˜ í´ë¦­ìœ¼ë¡œ íŒ€ ì„ íƒ â†’ ì•„ë˜ ìŠ¹ë¦¬íŒ€ ì„ íƒ</small></div>

  <div id="playersArea" class="row" style="justify-content:flex-start"></div>

  <div class="row">
    <button id="winA" class="btn ok">AíŒ€ ìŠ¹</button>
    <button id="winB" class="btn warn">BíŒ€ ìŠ¹</button>
  </div>
</div>

<div id="toast" class="toast">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const $=(s)=>document.querySelector(s);
const toast=(msg="ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤")=>{
  const t=$("#toast");t.textContent=msg;t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1500);
};

// ===== ìƒíƒœ =====
let mode="single";
let selectedA=[], selectedB=[];
let players=[];

// ===== ëª¨ë“œ ì„ íƒ =====
$("#modeSingle").onclick=()=>{mode="single";$("#modeSingle").classList.add("primary");$("#modeDouble").classList.remove("primary");resetSelection();};
$("#modeDouble").onclick=()=>{mode="double";$("#modeDouble").classList.add("primary");$("#modeSingle").classList.remove("primary");resetSelection();};

// ===== ì„ ìˆ˜ ëª©ë¡ ë¡œë“œ =====
onValue(ref(db,"players"),snap=>{
  const data=snap.val()||{};
  players=Object.entries(data)
    .filter(([id,p])=>!p.hidden)
    .map(([id,p])=>({id,name:p.name,level:p.level}));
  renderPlayers();
});

function renderPlayers(){
  const area=$("#playersArea");
  area.innerHTML="";
  players.forEach(p=>{
    const btn=document.createElement("button");
    btn.className="player";
    btn.textContent=`${p.name}(${p.level})`;
    btn.onclick=()=>selectPlayer(p);
    area.appendChild(btn);
  });
}

// ===== ì„ íƒ ë¡œì§ =====
function selectPlayer(p){
  const max = (mode==="single") ? 2 : 4;
  const area=$("#playersArea");
  const buttons=area.querySelectorAll(".player");

  const findBtn=(name)=>Array.from(buttons).find(b=>b.textContent.startsWith(name));

  // ì´ë¯¸ ì„ íƒëœ ì„ ìˆ˜ì¼ ê²½ìš° ì·¨ì†Œ
  if(selectedA.includes(p.name)){
    selectedA=selectedA.filter(n=>n!==p.name);
  }else if(selectedB.includes(p.name)){
    selectedB=selectedB.filter(n=>n!==p.name);
  }else{
    // ì„ íƒ
    const totalSel=selectedA.length+selectedB.length;
    if(totalSel>=max) return toast("ì„ íƒ ì¸ì› ì´ˆê³¼");
    if(totalSel<(max/2)) selectedA.push(p.name);
    else selectedB.push(p.name);
  }

  // ìƒ‰ìƒ ì—…ë°ì´íŠ¸
  buttons.forEach(btn=>{
    const nm=btn.textContent.split("(")[0];
    btn.classList.remove("selectedA","selectedB");
    if(selectedA.includes(nm)) btn.classList.add("selectedA");
    if(selectedB.includes(nm)) btn.classList.add("selectedB");
  });
}

// ===== ìŠ¹ë¦¬ ì €ì¥ =====
async function saveMatch(winnerSide){
  const total=selectedA.length+selectedB.length;
  if(mode==="single" && total<2) return toast("ë‹¨ì‹: 2ëª… ì„ íƒí•˜ì„¸ìš”");
  if(mode==="double" && total<4) return toast("ë³µì‹: 4ëª… ì„ íƒí•˜ì„¸ìš”");
  if(selectedA.length===0 || selectedB.length===0) return toast("íŒ€ êµ¬ì„±ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤");

  const monthKey=getMonthKey();
  const match={
    mode,
    monthKey,
    namesA:selectedA,
    namesB:selectedB,
    winnerSide,
    createdAt:Date.now()
  };
  await push(ref(db,"matches"),match);
  toast("ê²½ê¸° ì €ì¥ ì™„ë£Œ");
  resetSelection();
}

function resetSelection(){
  selectedA=[];selectedB=[];
  $("#playersArea").querySelectorAll(".player").forEach(b=>b.classList.remove("selectedA","selectedB"));
}

function getMonthKey(){
  const d=new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Seoul"}));
  const y=d.getFullYear(),m=d.getMonth()+1;
  return `${y}-${String(m).padStart(2,"0")}`;
}

$("#winA").onclick=()=>saveMatch("A");
$("#winB").onclick=()=>saveMatch("B");
</script>
</body>
</html>
