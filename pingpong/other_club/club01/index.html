<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>🏓 PingPong Club 결과입력</title>
<style>
:root{
  --ink:#0f172a; --muted:#64748b; --card:#fff; --bg:#f5f7fb;
  --primary:#0d47a1; --accent:#2563eb; --danger:#ef4444; --ok:#16a34a;
  --shadow:0 8px 28px rgba(0,0,0,.08)
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;color:var(--ink);background:var(--bg)}
header{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid #e5e7eb}
.wrap{max-width:980px;margin:0 auto;padding:14px 16px}
h1{margin:4px 0 6px;font-size:clamp(18px,4vw,24px);color:var(--primary)}
main{max-width:980px;margin:12px auto;padding:0 16px 30px}
.card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:14px;box-shadow:var(--shadow);margin:12px 0}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.row.center{justify-content:center}
.btn{border:1px solid #d1d5db;border-radius:10px;padding:10px 14px;font-size:15px;cursor:pointer;background:#fff}
.btn.ok{background:var(--ok);color:#fff;border-color:var(--ok)}
.btn.warn{background:var(--danger);color:#fff;border-color:var(--danger)}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.sm{padding:6px 10px;font-size:13px;border-radius:8px}
.chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;
  border:1px solid #d1d5db;cursor:pointer;background:#eef2ff;font-size:13px;white-space:nowrap}
.chip.selected{outline:2px solid var(--accent);background:#fff}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;
background:#111827;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;pointer-events:none;transition:.25s}
.toast.show{opacity:1}
small{color:var(--muted)}
ul#recentList{list-style:none;padding:0;margin:0}
ul#recentList li{
  background:#fff;border:1px solid #e5e7eb;border-radius:10px;
  padding:8px 10px;margin-bottom:6px;box-shadow:0 2px 5px rgba(0,0,0,.04);
  font-size:14px;line-height:1.5;position:relative;
}
ul#recentList li b.win{color:#2563eb}
ul#recentList li .time{display:block;color:#64748b;font-size:12px;margin-bottom:3px}
ul#recentList li button.del{
  position:absolute;right:10px;top:8px;border:none;background:none;
  color:#dc2626;font-size:16px;cursor:pointer;
}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row" style="gap:8px;align-items:center;justify-content:space-between">
      <h1>🏓 PingPong Club 결과입력</h1>
      <div class="row" style="gap:6px">
        <a href="monthly-report.html" class="btn primary">📊 월간리그</a>
        <a href="admin.html" class="btn">⚙️ 관리자</a>
      </div>
    </div>
  </div>
</header>

<main>
  <section>
    <div class="card">
      <div class="row" style="gap:12px">
        <div id="modeSeg" class="row" style="gap:4px">
          <button data-mode="single" class="btn primary sm">단식</button>
          <button data-mode="double" class="btn sm">복식</button>
        </div>
        <button id="clearSel" class="btn sm">선택 초기화</button>
      </div>

      <div id="chips" class="chips" style="margin-top:10px"></div>

      <div class="card" id="winnerBox" style="display:none;margin-top:12px">
        <div class="row center" style="gap:8px;margin-bottom:6px">
          <span class="btn sm" style="pointer-events:none">A팀: <b id="teamA"></b></span>
          <span class="btn sm" style="pointer-events:none">B팀: <b id="teamB"></b></span>
        </div>
        <div class="row center" style="gap:12px">
          <button id="winA" class="btn ok">A팀 승</button>
          <button id="winB" class="btn warn">B팀 승</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:6px">🕒 최근 저장</div>
      <ul id="recentList"></ul>
      <div id="recentEmpty" style="color:var(--muted);font-size:13px;text-align:center;margin-top:6px">
        아직 저장된 경기가 없습니다.
      </div>
    </div>
  </section>
</main>

<div id="toast" class="toast">Saved</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, push, onValue, query, orderByChild, limitToLast, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// ✅ Firebase 연결
const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const $=(s,ctx=document)=>ctx.querySelector(s);
const toast=(msg='저장되었습니다')=>{
  const t=$('#toast');t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),1500);
};

// ===== 상태 =====
let mode='single';
let sel=[];
let players=[];

// ===== 모드 전환 =====
$('#modeSeg').addEventListener('click',e=>{
  const btn=e.target.closest('button[data-mode]');
  if(!btn)return;
  $('#modeSeg button[data-mode="single"]').classList.toggle('primary',btn.dataset.mode==='single');
  $('#modeSeg button[data-mode="double"]').classList.toggle('primary',btn.dataset.mode==='double');
  mode=btn.dataset.mode;
  sel=[];renderChips();renderWinnerBox();
});

$('#clearSel').onclick=()=>{sel=[];renderChips();renderWinnerBox();};

// ===== 선수 로드 =====
onValue(ref(db,'players'),snap=>{
  const data=snap.val()||{};
  players=Object.entries(data)
    .filter(([id,p])=>!p.hidden)
    .map(([id,p])=>({name:p.name,level:p.level}))
    .sort((a,b)=>(a.level-b.level)||a.name.localeCompare(b.name,'ko'));
  renderChips();
});

function renderChips(){
  const box=$('#chips'); box.innerHTML='';
  const need=(mode==='single'?2:4);
  players.forEach(p=>{
    const btn=document.createElement('button');
    btn.className='chip';
    btn.textContent=`${p.name}(${p.level})`;
    if(sel.some(x=>x.name===p.name))btn.classList.add('selected');
    btn.onclick=()=>{
      const idx=sel.findIndex(x=>x.name===p.name);
      if(idx>=0)sel.splice(idx,1);
      else{
        if(sel.length>=need){toast('선택 인원 초과');return;}
        sel.push(p);
      }
      renderChips();renderWinnerBox();
    };
    box.appendChild(btn);
  });
}

function computeTeams(){
  const need=(mode==='single'?2:4);
  if(sel.length!==need)return null;
  const A=mode==='single'?[sel[0]]:[sel[0],sel[1]];
  const B=mode==='single'?[sel[1]]:[sel[2],sel[3]];
  return {A,B};
}

function renderWinnerBox(){
  const wb=$('#winnerBox');
  const t=computeTeams();
  if(t){
    $('#teamA').textContent=t.A.map(p=>p.name).join('/');
    $('#teamB').textContent=t.B.map(p=>p.name).join('/');
    wb.style.display='';
  }else wb.style.display='none';
}

// ===== 경기 저장 =====
async function saveWinner(side){
  const t=computeTeams();
  if(!t){toast(mode==='single'?'두 선수를 선택하세요':'네 선수를 선택하세요');return;}
  const d=new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Seoul'}));
  const monthKey=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  const match={
    ts:Date.now(),
    monthKey,
    mode,
    namesA:t.A.map(p=>p.name),
    namesB:t.B.map(p=>p.name),
    winnerSide:side,
    createdAt:Date.now()
  };
  await push(ref(db,'matches'),match);
  toast('경기 저장 완료');
  sel=[];renderChips();renderWinnerBox();
}

$('#winA').onclick=()=>saveWinner('A');
$('#winB').onclick=()=>saveWinner('B');

// ===== 2개월 유지 (이전 데이터 삭제)
function pruneOld(matches){
  const now=new Date();
  const curKey=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const prevKey=`${now.getFullYear()}-${String(now.getMonth()).padStart(2,'0')}`;
  Object.entries(matches).forEach(([key,m])=>{
    if(m.monthKey<prevKey){ remove(ref(db,'matches/'+key)); }
  });
}

// ===== 최근 경기 표시 (최신순 + 삭제)
onValue(query(ref(db,'matches'),orderByChild('ts'),limitToLast(100)),snap=>{
  const ul=$('#recentList'),empty=$('#recentEmpty');
  ul.innerHTML='';
  const all=snap.val()||{};
  pruneOld(all);
  const arr=Object.entries(all).map(([id,m])=>({...m,id}));
  if(!arr.length){empty.style.display='';return;} else empty.style.display='none';
  arr.sort((a,b)=>b.ts-a.ts); // 최신순
  arr.forEach(m=>{
    const li=document.createElement('li');
    const d=new Date(m.ts);
    const dateStr=d.toLocaleString('ko-KR',{year:'2-digit',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
    const A=m.namesA.join('/'),B=m.namesB.join('/');
    const winner=(m.winnerSide==='A'?m.namesA:m.namesB);
    const highlight=(name)=>winner.includes(name)?`<b class="win">${name}</b>`:name;
    const htmlPlayers=[...m.namesA,...m.namesB].map(highlight);
    li.innerHTML=`<span class="time">${dateStr}</span>${htmlPlayers.join(' vs ')} 
      <button class="del" title="삭제" onclick="delMatch('${m.id}')">🗑</button>`;
    ul.appendChild(li);
  });
});

// ===== 삭제 기능 (관리자 비밀번호 필요)
window.delMatch=async(id)=>{
  const pass=prompt("관리자 비밀번호를 입력하세요");
  if(pass!=="koen2025"){alert("비밀번호가 일치하지 않습니다.");return;}
  if(confirm("정말 삭제하시겠습니까?")){
    await remove(ref(db,'matches/'+id));
    toast("삭제 완료");
  }
};
</script>
</body>
</html>
