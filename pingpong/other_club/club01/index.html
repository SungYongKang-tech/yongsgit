<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ“ ê²½ê¸°ê²°ê³¼ ì…ë ¥</title>
<style>
@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

:root {
  --ink:#0f172a; --muted:#64748b; --card:#fff; --bg:#f5f7fb;
  --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
  --shadow:0 8px 28px rgba(0,0,0,.08);
}
body {
  margin:0;
  font-family:"Pretendard","Noto Sans KR",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  font-weight:600;
  background:var(--bg);
  color:var(--ink);
}
header {
  background:#fff;
  border-bottom:1px solid #e5e7eb;
  position:sticky; top:0; z-index:10;
}
.wrap {
  max-width:960px;
  margin:0 auto;
  padding:14px 16px;
}
h1 {
  margin:4px 0 6px;
  font-size:clamp(20px,4vw,24px);
  color:var(--accent);
  font-weight:700;
}
.btn {
  border:1px solid #ccc; border-radius:8px; padding:7px 12px;
  font-size:15px; cursor:pointer; background:#fff; transition:.2s; font-weight:600;
}
.btn.primary {background:var(--accent); color:#fff; border-color:var(--accent);}
.btn.ok {background:var(--ok); color:#fff; border-color:var(--ok);}
.btn.danger {background:var(--danger); color:#fff; border-color:var(--danger);}
.row {display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:center;}
.chip {
  border:1px solid #ccc; border-radius:999px; padding:7px 12px; font-size:15px;
  background:#fff; color:#111; cursor:pointer; font-weight:600;
}
.chip.selected {border:2px solid var(--accent); background:#e0e7ff;}
#teamDisplay {margin-top:14px; text-align:center; font-size:17px; font-weight:600;}
#matchButtons {margin-top:10px; text-align:center; display:none;}
#logs {
  margin-top:20px; background:#fff; border-radius:12px; box-shadow:var(--shadow);
  padding:12px;
}
.log-item {
  border-bottom:1px solid #e5e7eb; padding:10px 4px; position:relative;
}
.log-item:last-child {border-bottom:none;}
.log-time {
  font-size:14px; /* âœ… ì¼ì‹œ í¬ê¸° í™•ëŒ€ */
  color:#475569;
  display:block;
  margin-bottom:4px;
  font-weight:500;
}
.log-match {font-size:16px; font-weight:600;}
.log-win {color:#2563eb; font-weight:700;}
.delete-btn {
  position:absolute; right:8px; top:6px; font-size:16px; border:none;
  background:transparent; color:#9ca3af; cursor:pointer; transition:.2s;
}
.delete-btn:hover {color:#ef4444; transform:scale(1.1);}
.toast {
  position:fixed; bottom:18px; left:50%; transform:translateX(-50%);
  background:#111827; color:#fff; padding:9px 14px; border-radius:10px;
  opacity:0; transition:.25s;
  font-size:15px; font-weight:600;
}
.toast.show {opacity:1;}
@media (max-width:640px){
  .chip{font-size:14px;}
  .btn{font-size:14px; padding:6px 10px;}
  .log-match{font-size:15px;}
  .log-time{font-size:13px;}
}
</style>
</head>
<body>
<header>
  <div class="wrap row" style="justify-content:space-between;">
    <h1 id="pageTitle">ğŸ“ ê²½ê¸°ê²°ê³¼ ì…ë ¥</h1>
    <div class="row">
      <a href="admin.html" class="btn">âš™ ê´€ë¦¬ì</a>
      <a href="monthly-report.html" class="btn primary">ğŸ“Š ì›”ê°„ ê²°ê³¼</a>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="chips" class="row" style="margin-top:10px;"></div>
  <div id="teamDisplay"></div>

  <div id="matchButtons">
    <button id="winA" class="btn ok">AíŒ€ ìŠ¹</button>
    <button id="winB" class="btn danger">BíŒ€ ìŠ¹</button>
  </div>

  <div id="logs"></div>
</main>

<div id="toast" class="toast">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue, push, remove, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// âœ… Firebase ì„¤ì •
const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const $ = s => document.querySelector(s);
const toast = (msg="ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤")=>{
  const t=$("#toast"); t.textContent=msg; t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1500);
};

// ===== ì œëª© ìºì‹œ + ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ =====
const titleRef = ref(db, 'config/title');
const cachedTitle = localStorage.getItem('siteTitle');
if (cachedTitle) {
  document.title = `ğŸ“ ${cachedTitle} ê²½ê¸°ê²°ê³¼ì…ë ¥`;
  $('#pageTitle').textContent = `ğŸ“ ${cachedTitle} ê²½ê¸°ê²°ê³¼ì…ë ¥`;
}
onValue(titleRef, snap => {
  const val = snap.val() ?? 'PingPong Club';
  localStorage.setItem('siteTitle', val);
  document.title = `ğŸ“ ${val} ê²½ê¸°ê²°ê³¼ì…ë ¥`;
  $('#pageTitle').textContent = `ğŸ“ ${val} ê²½ê¸°ê²°ê³¼ì…ë ¥`;
});

// ===== ë°ì´í„° ì°¸ì¡° =====
const matchRef = ref(db,'matches');
const playerRef = ref(db,'players');
const deletePwRef = ref(db,'config/deletePassword');

let players=[], sel=[], deletePassword='7910';

// âœ… ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ ë¶ˆëŸ¬ì˜¤ê¸°
get(deletePwRef).then(s=>{
  if(s.exists()) deletePassword = s.val();
});

// âœ… ë¶€ìˆ˜ë³„ ìƒ‰ìƒ
const LEVEL_COLORS = {
  1:'#ef4444',2:'#06b6d4',3:'#f59e0b',4:'#8b5cf6',
  5:'#84cc16',6:'#3b82f6',7:'#f97316',8:'#10b981',
  9:'#a855f7',10:'#eab308',11:'#22c55e',12:'#0ea5e9',
  13:'#d946ef',14:'#6366f1'
};
const shuffledColors = Object.values(LEVEL_COLORS).sort(()=>Math.random()-0.5);

// âœ… ì„ ìˆ˜ ëª©ë¡ í‘œì‹œ
onValue(playerRef,snap=>{
  const data=snap.val()||{};
  players=Object.values(data)
    .filter(p=>!p.hidden)
    .map(p=>({name:p.name,level:p.level}))
    .sort((a,b)=>(a.level-b.level)||a.name.localeCompare(b.name,'ko'));
  renderChips();
});

// âœ… ì¹© ë Œë”ë§
function renderChips(){
  const box=$("#chips"); box.innerHTML="";
  players.forEach(p=>{
    const btn=document.createElement('button');
    btn.className='chip';
    const c=shuffledColors[p.level%shuffledColors.length];
    btn.style.borderColor=c; btn.style.background=c+'22';
    btn.textContent=`${p.name}(${p.level})`;
    if(sel.some(x=>x.name===p.name)){
      btn.classList.add('selected');
      btn.style.background='#fff';
      btn.style.outline=`2px solid ${c}`;
    }
    btn.onclick=()=>{
      const idx=sel.findIndex(x=>x.name===p.name);
      if(idx>=0) sel.splice(idx,1);
      else {
        if(sel.length>=4){toast("ìµœëŒ€ 4ëª…ê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤");return;}
        sel.push(p);
      }
      renderChips(); updateTeams();
    };
    box.appendChild(btn);
  });
}

// âœ… íŒ€ ì—…ë°ì´íŠ¸ (2ëª…=ë‹¨ì‹ / 4ëª…=ë³µì‹)
function updateTeams(){
  const disp=$("#teamDisplay");
  const btns=$("#matchButtons");
  if(sel.length>0){
    const half=Math.floor(sel.length/2);
    const a=sel.slice(0,half).map(p=>p.name).join('/');
    const b=sel.slice(half).map(p=>p.name).join('/');
    disp.innerHTML=`<b>AíŒ€:</b> ${a||'-'}ã€€|ã€€<b>BíŒ€:</b> ${b||'-'}`;
  } else disp.innerHTML='';
  btns.style.display = (sel.length===2 || sel.length===4) ? 'block' : 'none';
}

// âœ… ê²½ê¸° ì €ì¥
function getMonthKey(ts=Date.now()){
  const d=new Date(new Date(ts).toLocaleString('en-US',{timeZone:'Asia/Seoul'}));
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
}
$("#winA").onclick=()=>saveMatch('A');
$("#winB").onclick=()=>saveMatch('B');

function saveMatch(winner){
  if(!(sel.length===2 || sel.length===4)){toast("2ëª… ë˜ëŠ” 4ëª…ì„ ì„ íƒí•˜ì„¸ìš”");return;}
  const mode=(sel.length===2)?'single':'double';
  const a=sel.slice(0,sel.length/2).map(p=>p.name);
  const b=sel.slice(sel.length/2).map(p=>p.name);
  const obj={mode,monthKey:getMonthKey(),namesA:a,namesB:b,winnerSide:winner,createdAt:Date.now()};
  push(matchRef,obj);
  toast("ê²½ê¸°ê²°ê³¼ ì €ì¥ ì™„ë£Œ");
  sel=[];renderChips();updateTeams();
}

// âœ… ê²½ê¸° ë¡œê·¸ í‘œì‹œ
onValue(matchRef,snap=>{
  const data=snap.val()||{};
  const arr=Object.entries(data).map(([id,m])=>({...m,id}))
    .sort((a,b)=>b.createdAt-a.createdAt);
  renderLogs(arr);
});

function renderLogs(arr){
  const logs=$("#logs"); logs.innerHTML="";
  if(!arr.length){logs.innerHTML='<div style="text-align:center;color:#999">ìµœê·¼ ê²½ê¸° ì—†ìŒ</div>';return;}
  arr.forEach(m=>{
    const d=new Date(m.createdAt);
    const kst=new Date(d.toLocaleString('en-US',{timeZone:'Asia/Seoul'}));
    const time=`${kst.getFullYear()}-${String(kst.getMonth()+1).padStart(2,'0')}-${String(kst.getDate()).padStart(2,'0')} ${String(kst.getHours()).padStart(2,'0')}:${String(kst.getMinutes()).padStart(2,'0')}`;
    const winA=m.winnerSide==='A';
    const a=m.namesA.join('/');
    const b=m.namesB.join('/');
    logs.insertAdjacentHTML('beforeend',`
    <div class="log-item">
      <span class="log-time">${time} [${m.mode==='double'?'ë³µì‹':'ë‹¨ì‹'}]</span>
      <div class="log-match">
        <span class="${winA?'log-win':''}">${a}</span> vs 
        <span class="${!winA?'log-win':''}">${b}</span> (ìŠ¹)
      </div>
      <button class="delete-btn" onclick="deleteMatch('${m.id}')">ğŸ—‘ï¸</button>
    </div>`);
  });
}

// âœ… ê²½ê¸° ì‚­ì œ (ë¹„ë°€ë²ˆí˜¸ í™•ì¸)
window.deleteMatch = async (id) => {
  const input = prompt("ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
  if (input !== deletePassword) return toast("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤");
  if (!confirm("ì •ë§ ì´ ê²½ê¸°ê²°ê³¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  await remove(ref(db, 'matches/' + id));
  toast("ê²½ê¸°ê²°ê³¼ ì‚­ì œ ì™„ë£Œ");
};
</script>
</body>
</html>
