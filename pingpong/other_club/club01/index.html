<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>🏓 PingPong Club · 경기결과 입력</title>
<style>
:root{
  --ink:#0f172a; --muted:#64748b; --card:#fff; --bg:#f5f7fb;
  --primary:#0d47a1; --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
  --shadow:0 8px 28px rgba(0,0,0,.08)
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
color:var(--ink);background:var(--bg)}
header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e5e7eb}
.wrap{max-width:980px;margin:0 auto;padding:14px 16px}
h1{margin:4px 0;font-size:clamp(18px,4vw,24px);color:var(--primary)}
main{max-width:980px;margin:12px auto;padding:0 16px 30px}
.card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:14px;
box-shadow:var(--shadow);margin:12px 0}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{border:1px solid #d1d5db;border-radius:10px;padding:10px 14px;font-size:15px;
cursor:pointer;background:#fff}
.btn.ok{background:var(--ok);color:#fff;border-color:var(--ok)}
.btn.warn{background:var(--danger);color:#fff;border-color:var(--danger)}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.sm{padding:6px 10px;font-size:13px;border-radius:8px}
.chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;
border:1px solid var(--chip-bd,#d1d5db);cursor:pointer;background:var(--chip-bg,#eef2ff);
font-size:13px;white-space:nowrap}
.chip.selected{outline:2px solid var(--chip-ol,var(--accent));background:#fff}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111827;
color:#fff;padding:10px 14px;border-radius:12px;opacity:0;pointer-events:none;transition:.25s}
.toast.show{opacity:1}
ul.log{margin:8px 0 0 0;padding:0;list-style:none}
ul.log li{display:flex;align-items:center;gap:6px;padding:8px 0;border-bottom:1px solid #f1f5f9}
ul.log li.day-sep{border:0;padding:0;margin:10px 0}
ul.log li.day-sep hr{border:0;border-top:2px solid #cbd5e1;margin:8px 0}
.win{color:var(--accent);font-weight:700}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <h1>🏓 경기 결과 입력</h1>
      <a href="admin.html" class="btn">⚙️ 관리자</a>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <div class="row">
      <div class="seg" id="modeSeg">
        <button data-mode="single" class="btn primary sm active">단식</button>
        <button data-mode="double" class="btn sm">복식</button>
      </div>
      <button id="clearSel" class="btn sm">선택 초기화</button>
    </div>
    <div id="chips" class="chips" style="margin-top:10px"></div>

    <div class="card" id="winnerBox" style="display:none;margin-top:12px">
      <div class="row" style="justify-content:center">
        <span class="btn sm" style="pointer-events:none">A팀: <b id="teamA"></b></span>
        <span class="btn sm" style="pointer-events:none">B팀: <b id="teamB"></b></span>
      </div>
      <div class="row" style="justify-content:center;margin-top:8px">
        <button id="winA" class="btn ok">승자: A팀</button>
        <button id="winB" class="btn warn">승자: B팀</button>
      </div>
    </div>
  </section>

  <section class="card">
    <div style="font-weight:700;margin-bottom:6px">최근 경기</div>
    <ul id="recent" class="log"></ul>
    <div id="recentEmpty" style="color:var(--muted);font-size:13px">기록이 없습니다.</div>
  </section>
</main>

<div id="toast" class="toast">Saved</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getDatabase, ref, onValue, push, remove, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// === Firebase 연결 ===
const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// === 유틸 ===
const $ = (s,ctx=document)=>ctx.querySelector(s);
const toast=(m='저장되었습니다')=>{
  const t=$('#toast');t.textContent=m;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),1600);
};
const toKST=(t)=>new Date(new Date(t??Date.now()).toLocaleString('en-US',{timeZone:'Asia/Seoul'}));
const WEEK=['일','월','화','수','목','금','토'];
const fmtDate=(t)=>{
  const d=toKST(t);const yy=String(d.getFullYear()).slice(-2);
  const mm=String(d.getMonth()+1).padStart(2,'0');
  const dd=String(d.getDate()).padStart(2,'0');
  const hh=String(d.getHours()).padStart(2,'0');
  const mi=String(d.getMinutes()).padStart(2,'0');
  const wd=WEEK[d.getDay()];
  return `${yy}년 ${mm}월 ${dd}일(${wd}) ${hh}:${mi}`;
};

// === 전역 상태 ===
let players=[];
let hiddenPlayers=[];
let state={mode:'single',sel:[]};

// === 선수/숨김 목록 동기화 ===
onValue(ref(db,'players'),snap=>{
  const data=snap.val()||{};
  players=Object.entries(data)
    .filter(([_,v])=>!v.hidden)
    .map(([name,v])=>({name,level:v.level}));
  renderChips();
});
onValue(ref(db,'players'),snap=>{
  const data=snap.val()||{};
  hiddenPlayers=Object.entries(data)
    .filter(([_,v])=>v.hidden)
    .map(([name])=>name);
});

// === UI 렌더 ===
function levelStyle(level){
  const hues=[0,25,50,95,140,185,215,245,275,310,340];
  const L=Math.max(4,Math.min(14,Number(level)||14));
  const idx=L-4;const hue=hues[idx]||200;
  return {
    bg:`hsl(${hue} 85% 92%)`,
    bd:`hsl(${hue} 60% 46%)`,
    ol:`hsl(${hue} 65% 38%)`
  };
}
function renderChips(){
  const box=$('#chips');box.innerHTML='';
  const need=(state.mode==='single')?2:4;
  players.sort((a,b)=>(a.level-b.level)||a.name.localeCompare(b.name,'ko'));
  players.forEach(p=>{
    const btn=document.createElement('button');
    btn.className='chip';
    btn.textContent=`${p.name}(${p.level})`;
    const {bg,bd,ol}=levelStyle(p.level);
    btn.style.setProperty('--chip-bg',bg);
    btn.style.setProperty('--chip-bd',bd);
    btn.style.setProperty('--chip-ol',ol);
    if(state.sel.some(x=>x.name===p.name))btn.classList.add('selected');
    btn.onclick=()=>{
      const idx=state.sel.findIndex(x=>x.name===p.name);
      if(idx>=0)state.sel.splice(idx,1);
      else{
        if(state.sel.length>=need){
          toast(state.mode==='single'?'단식은 2명만':'복식은 4명만 선택');
          return;
        }
        state.sel.push(p);
      }
      renderChips();renderWinnerBox();
    };
    box.appendChild(btn);
  });
}
$('#clearSel').onclick=()=>{state.sel=[];renderChips();renderWinnerBox();};

// === 단식/복식 모드 토글 ===
const modeSeg=$('#modeSeg');
modeSeg.addEventListener('click',e=>{
  const btn=e.target.closest('button[data-mode]');
  if(!btn)return;
  modeSeg.querySelectorAll('button').forEach(b=>b.classList.remove('primary','active'));
  btn.classList.add('primary','active');
  state.mode=btn.dataset.mode;state.sel=[];
  renderChips();renderWinnerBox();
});

// === 팀 구성 ===
function computeTeams(){
  const need=(state.mode==='single')?2:4;
  if(state.sel.length!==need)return null;
  let A=[],B=[];
  if(state.mode==='single'){A=[state.sel[0]];B=[state.sel[1]];}
  else{A=[state.sel[0],state.sel[1]];B=[state.sel[2],state.sel[3]];}
  return {A,B};
}
function fmtTeam(arr,isDouble=false){
  return arr.map(p=>p.name).join(isDouble?'/':' + ');
}
function renderWinnerBox(){
  const wb=$('#winnerBox');const teams=computeTeams();
  if(teams){
    const isDouble=(state.mode==='double');
    $('#teamA').textContent=fmtTeam(teams.A,isDouble);
    $('#teamB').textContent=fmtTeam(teams.B,isDouble);
    wb.style.display='';
  }else wb.style.display='none';
}

// === 저장 ===
async function saveWinner(side){
  const teams=computeTeams();
  if(!teams){toast(state.mode==='single'?'두 명 선택':'네 명 선택');return;}
  const nowKST=toKST();
  const monthKey=`${nowKST.getFullYear()}-${String(nowKST.getMonth()+1).padStart(2,'0')}`;
  const match={
    ts:Date.now(),
    monthKey,
    type:state.mode,
    namesA:teams.A.map(p=>p.name),
    namesB:teams.B.map(p=>p.name),
    levelsA:teams.A.map(p=>p.level),
    levelsB:teams.B.map(p=>p.level),
    winnerSide:side,
    createdAt:Date.now()
  };
  await push(ref(db,'matches'),match);
  toast('저장되었습니다');
  state.sel=[];renderChips();renderWinnerBox();
}
$('#winA').onclick=()=>saveWinner('A');
$('#winB').onclick=()=>saveWinner('B');

// === 최근 경기 ===
function watchRecent(){
  const q=query(ref(db,'matches'),orderByChild('ts'),limitToLast(40));
  onValue(q,snap=>{
    const ul=$('#recent'),empty=$('#recentEmpty');
    const arr=[];snap.forEach(c=>arr.push({key:c.key,v:c.val()}));
    ul.innerHTML='';
    if(!arr.length){empty.style.display='';return;}
    empty.style.display='none';
    arr.sort((a,b)=>b.v.ts-a.v.ts);
    let prev=null;
    arr.forEach(({v})=>{
      const dKey=toKST(v.ts).toISOString().split('T')[0];
      if(prev && prev!==dKey){
        const sep=document.createElement('li');
        sep.className='day-sep';sep.innerHTML='<hr>';
        ul.appendChild(sep);
      }
      prev=dKey;
      const li=document.createElement('li');
      const A=v.namesA.join(v.type==='double'?'/':' + ');
      const B=v.namesB.join(v.type==='double'?'/':' + ');
      const winA=(v.winnerSide==='A');
      li.innerHTML=`
        <div style="flex:1">${fmtDate(v.ts)} · [${v.type==='double'?'복식':'단식'}]
        ${winA?`<span class='win'>${A}(승)</span>`:`${A}`} vs 
        ${!winA?`<span class='win'>${B}(승)</span>`:`${B}`}</div>`;
      ul.appendChild(li);
    });
  });
}

// === 시작 ===
signInAnonymously(auth).catch(console.error);
onAuthStateChanged(auth,()=>{renderChips();watchRecent();});
</script>
</body>
</html>
