<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>🏓 경기 결과 입력</title>
<style>
:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb;
  --primary:#0d47a1; --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
}
body{margin:0;font-family:system-ui,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--ink)}
.wrap{max-width:720px;margin:0 auto;padding:18px}
h1{text-align:center;color:var(--primary);margin-bottom:10px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin:10px 0}
.btn{border:1px solid #ccc;border-radius:8px;padding:8px 12px;font-size:15px;background:#fff;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.ok{background:var(--ok);color:#fff;border-color:var(--ok)}
.btn.warn{background:var(--danger);color:#fff;border-color:var(--danger)}
.player{border:1px solid #ccc;border-radius:8px;padding:8px 12px;margin:5px;background:#fff;cursor:pointer;transition:.2s}
.player.selectedA{background:#bfdbfe;border-color:#1d4ed8}
.player.selectedB{background:#fecaca;border-color:#b91c1c}
.player.hidden{opacity:0.4;pointer-events:none}
.toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);
background:#111827;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:.25s}
.toast.show{opacity:1}
small{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1>🏓 경기 결과 입력</h1>

  <div class="row">
    <button id="modeSingle" class="btn primary">단식</button>
    <button id="modeDouble" class="btn">복식</button>
    <a href="monthly-report.html" class="btn">📊 리포트</a>
    <a href="admin.html" class="btn">⚙️ 관리자</a>
  </div>

  <div class="row"><small>※ 선수 클릭으로 팀 선택 → 아래 승리팀 선택</small></div>

  <div id="playersArea" class="row" style="justify-content:flex-start"></div>

  <div class="row">
    <button id="winA" class="btn ok">A팀 승</button>
    <button id="winB" class="btn warn">B팀 승</button>
  </div>
</div>

<div id="toast" class="toast">저장되었습니다</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyArRznuWhfuiOA1vFtwlArMCLsAdTz6XHo",
  authDomain: "pingpongclub-4a5fd.firebaseapp.com",
  databaseURL: "https://pingpongclub-4a5fd-default-rtdb.firebaseio.com",
  projectId: "pingpongclub-4a5fd",
  storageBucket: "pingpongclub-4a5fd.firebasestorage.app",
  messagingSenderId: "802826774007",
  appId: "1:802826774007:web:ca4d05be778eeaf1723af2"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const $=(s)=>document.querySelector(s);
const toast=(msg="저장되었습니다")=>{
  const t=$("#toast");t.textContent=msg;t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1500);
};

// ===== 상태 =====
let mode="single";
let selectedA=[], selectedB=[];
let players=[];

// ===== 모드 선택 =====
$("#modeSingle").onclick=()=>{mode="single";$("#modeSingle").classList.add("primary");$("#modeDouble").classList.remove("primary");resetSelection();};
$("#modeDouble").onclick=()=>{mode="double";$("#modeDouble").classList.add("primary");$("#modeSingle").classList.remove("primary");resetSelection();};

// ===== 선수 목록 로드 =====
onValue(ref(db,"players"),snap=>{
  const data=snap.val()||{};
  players=Object.entries(data)
    .filter(([id,p])=>!p.hidden)
    .map(([id,p])=>({id,name:p.name,level:p.level}));
  renderPlayers();
});

function renderPlayers(){
  const area=$("#playersArea");
  area.innerHTML="";
  players.forEach(p=>{
    const btn=document.createElement("button");
    btn.className="player";
    btn.textContent=`${p.name}(${p.level})`;
    btn.onclick=()=>selectPlayer(p);
    area.appendChild(btn);
  });
}

// ===== 선택 로직 =====
function selectPlayer(p){
  const max = (mode==="single") ? 2 : 4;
  const area=$("#playersArea");
  const buttons=area.querySelectorAll(".player");

  const findBtn=(name)=>Array.from(buttons).find(b=>b.textContent.startsWith(name));

  // 이미 선택된 선수일 경우 취소
  if(selectedA.includes(p.name)){
    selectedA=selectedA.filter(n=>n!==p.name);
  }else if(selectedB.includes(p.name)){
    selectedB=selectedB.filter(n=>n!==p.name);
  }else{
    // 선택
    const totalSel=selectedA.length+selectedB.length;
    if(totalSel>=max) return toast("선택 인원 초과");
    if(totalSel<(max/2)) selectedA.push(p.name);
    else selectedB.push(p.name);
  }

  // 색상 업데이트
  buttons.forEach(btn=>{
    const nm=btn.textContent.split("(")[0];
    btn.classList.remove("selectedA","selectedB");
    if(selectedA.includes(nm)) btn.classList.add("selectedA");
    if(selectedB.includes(nm)) btn.classList.add("selectedB");
  });
}

// ===== 승리 저장 =====
async function saveMatch(winnerSide){
  const total=selectedA.length+selectedB.length;
  if(mode==="single" && total<2) return toast("단식: 2명 선택하세요");
  if(mode==="double" && total<4) return toast("복식: 4명 선택하세요");
  if(selectedA.length===0 || selectedB.length===0) return toast("팀 구성이 잘못되었습니다");

  const monthKey=getMonthKey();
  const match={
    mode,
    monthKey,
    namesA:selectedA,
    namesB:selectedB,
    winnerSide,
    createdAt:Date.now()
  };
  await push(ref(db,"matches"),match);
  toast("경기 저장 완료");
  resetSelection();
}

function resetSelection(){
  selectedA=[];selectedB=[];
  $("#playersArea").querySelectorAll(".player").forEach(b=>b.classList.remove("selectedA","selectedB"));
}

function getMonthKey(){
  const d=new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Seoul"}));
  const y=d.getFullYear(),m=d.getMonth()+1;
  return `${y}-${String(m).padStart(2,"0")}`;
}

$("#winA").onclick=()=>saveMatch("A");
$("#winB").onclick=()=>saveMatch("B");
</script>
</body>
</html>
