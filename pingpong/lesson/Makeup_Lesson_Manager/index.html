<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Makeup Lesson Manager</title>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Pretendard",sans-serif;
  margin:0;background:#f5f5f7;
}
header{
  background:#fff;padding:16px;font-size:1.3rem;font-weight:700;
  border-bottom:1px solid #ddd;
}
table{width:100%;border-collapse:collapse;background:#fff;margin-top:10px;}
th,td{border:1px solid #ccc;padding:10px;text-align:center;}
td.selectable{cursor:pointer;}
td.selected{background:#2563eb;color:white;}
.btn{
  width:100%;padding:12px;margin-top:12px;background:#2563eb;color:white;
  border:none;font-size:1rem;border-radius:8px;cursor:pointer;
}
.list{padding:16px;}
.group-box{
  background:#fff;padding:14px;margin-bottom:14px;border-radius:8px;
  border-left:5px solid #2563eb;
}
.group-title{
  font-weight:bold;margin-bottom:6px;
}

.schedule-box{padding:16px;}
input,select{
  width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:8px;
}

.schedule-table td{
  height:40px;cursor:pointer;
}

/* Popup */
.popup-bg{
  position:fixed;left:0;right:0;top:0;bottom:0;
  background:rgba(0,0,0,0.35);display:none;
}
.popup{
  background:#fff;
  position:absolute;
  left:0; right:0; bottom:0;
  margin:0;
  padding:20px;
  border-radius:20px 20px 0 0;
  animation:slideUp .25s ease-out;
}

@keyframes slideUp{
  from {transform:translateY(100%);}
  to {transform:translateY(0);}
}

.name-item{
  background:#fff;border:1px solid #ddd;padding:10px;border-radius:8px;
  margin-bottom:6px;cursor:pointer;
}
</style>
</head>

<body>

<header>레슨 시간표</header>

<div style="padding:12px;">
<table>
  <thead>
    <tr>
      <th>시간</th>
      <th>월</th>
      <th>화</th>
      <th>수</th>
      <th>목</th>
    </tr>
  </thead>
  <tbody id="lessonBody"></tbody>
</table>

<button class="btn" onclick="openMakeupPopup()">보강 대상자 생성</button>
</div>

<header>보강 대상자</header>
<div class="list" id="makeupList"></div>

<header>보강 스케쥴</header>
<div class="schedule-box">
  <button class="btn" style="background:#16a34a;" onclick="openSchedulePopup()">보강 스케쥴 생성</button>
  <div id="scheduleArea" style="margin-top:16px;"></div>
</div>

<!-- 보강 대상자 생성 팝업 -->
<div id="makeupPopup" class="popup-bg">
  <div class="popup">
    <h3>보강 날짜 & 사유 입력</h3>
    <input type="date" id="makeupDate">
    <input id="makeupReason" placeholder="사유 입력">
    <button class="btn" onclick="createMakeupTargets()">생성</button>
  </div>
</div>

<!-- 보강 스케줄 생성 팝업 -->
<div id="schedulePopup" class="popup-bg">
  <div class="popup">
    <h3>보강 스케쥴 설정</h3>
    <input type="date" id="scheduleDate">

    <label>시작 시간 (고정: 11:25)</label>
    <input value="11:25" disabled>

    <label>교시 수 (1교시 = 15분)</label>
    <input id="periodCount" type="number" placeholder="예: 4">

    <button class="btn" onclick="generateSchedule()">스케쥴 생성</button>
  </div>
</div>

<!-- 이름 선택 팝업 -->
<div id="assignPopup" class="popup-bg">
  <div class="popup">
    <h3>보강 대상자 선택</h3>
    <div id="candidateList"></div>
    
    <!-- 취소 버튼 추가 -->
    <button class="btn" style="background:#6b7280;margin-top:12px;" onclick="cancelAssign()">취소</button>
    <button class="btn" style="background:#ef4444;margin-top:12px;" onclick="deleteSlot()">삭제하기</button>


  </div>
</div>


<script>
// ----------------------------
// 1) 레슨 시간표
// ----------------------------
const timetable = {
  "11:25": {mon:"정승목", tue:"이세란", wed:"정승목", thu:"이세란"},
  "11:40": {mon:"이상준", tue:"박나령", wed:"이상준", thu:"박나령"},
  "11:55": {mon:"이낭주", tue:"김승일", wed:"이낭주", thu:"김승일"},
  "12:10": {mon:"조보미", tue:"송은아", wed:"조보미", thu:"송은아"},
  "12:25": {mon:"고은선", tue:"임춘근", wed:"고은선", thu:"임춘근"},
};

let selectedCells = [];
let makeupGroups = [];
let originalSlotValue = "";

let clickedSlot = null;

// 렌더
function renderLessonTable(){
  const body=document.getElementById("lessonBody");
  body.innerHTML="";

  Object.keys(timetable).forEach(time=>{
    const tr=document.createElement("tr");
    tr.innerHTML += `<td>${time}</td>`;

    ["mon","tue","wed","thu"].forEach(day=>{
      const name=timetable[time][day];
      const td=document.createElement("td");
      td.className="selectable";
      td.innerText=name;
      td.onclick=()=>toggle(time,day,name,td);
      tr.appendChild(td);
    });

    body.appendChild(tr);
  });
}

function toggle(time,day,name,td){
  const key=`${time}_${day}_${name}`;
  if(selectedCells.includes(key)){
    selectedCells = selectedCells.filter(x=>x!==key);
    td.classList.remove("selected");
  } else {
    selectedCells.push(key);
    td.classList.add("selected");
  }
}

// ----------------------------
// 2) 보강 대상자 생성
// ----------------------------
function openMakeupPopup(){
  if(selectedCells.length===0){
    alert("보강 대상자를 선택하세요.");
    return;
  }
  document.getElementById("makeupPopup").style.display="block";
}

function createMakeupTargets(){
  const date=document.getElementById("makeupDate").value;
  const reason=document.getElementById("makeupReason").value;
  if(!date || !reason){
    alert("날짜와 사유 입력");
    return;
  }

  const newGroup = {
    date,
    reason,
    names:[]
  };

  selectedCells.forEach(key=>{
    const [t,d,name] = key.split("_");
    newGroup.names.push(name);
  });

  makeupGroups.push(newGroup);

  selectedCells=[];
  document.getElementById("makeupPopup").style.display="none";

  renderMakeupList();
  renderLessonTable();
}

// 리스트 렌더
function renderMakeupList(){
  const box=document.getElementById("makeupList");
  box.innerHTML="";

  if(makeupGroups.length===0){
    box.innerHTML=`<div style="color:#666;">보강 대상자 없음</div>`;
    return;
  }

  makeupGroups.forEach(group=>{
    const div=document.createElement("div");
    div.className="group-box";
    div.innerHTML = `
      <div class="group-title">${group.date} / ${group.reason}</div>
      ${group.names.map(n=>`<div>- ${n}</div>`).join("")}
    `;
    box.appendChild(div);
  });
}

// ----------------------------
// 3) 스케쥴 생성
// ----------------------------
function openSchedulePopup(){
  document.getElementById("schedulePopup").style.display="block";
}

function generateSchedule(){
  const date=document.getElementById("scheduleDate").value;
  const period = parseInt(document.getElementById("periodCount").value);

  if(!date || !period){
    alert("값을 모두 입력");
    return;
  }

  document.getElementById("schedulePopup").style.display="none";

  const box=document.getElementById("scheduleArea");
  box.innerHTML=`<h3>${date} 보강 스케쥴</h3>`;

  let html=`<table class="schedule-table"><tr><th>시간</th><th>보강자</th></tr>`;

  let hh=11, mm=25;

  for(let i=0;i<period;i++){
    const time=`${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}`;
    html+=`
      <tr>
        <td>${time}</td>
        <td onclick="openAssignPopup(this)"></td>
      </tr>
    `;
    mm+=15;
    if(mm>=60){ mm=0; hh++; }
  }

  html+=`</table>
        <button class="btn" style="background:#dc2626;margin-top:20px;" onclick="completeSchedule()">보강 완료</button>`;

  box.innerHTML+=html;
}

// ----------------------------
// 4) 슬롯 클릭 → 팝업
// ----------------------------



// ----------------------------
// 5) 배정 / 수정 로직
// ----------------------------
function assign(groupIdx, nameIdx){
  const name = makeupGroups[groupIdx].names[nameIdx];

  // 기존 사람이 있다면 회수…
  const oldName = clickedSlot.innerText.trim();
  if(oldName){
    let placed = false;
    // 원래 그룹에 뒤로 넣기
    makeupGroups.forEach(g=>{
      if(!placed){
        g.names.push(oldName);
        placed=true;
      }
    });
  }

  // 새 이름 배정
  clickedSlot.innerText = name;

  // 이름 제거
  makeupGroups[groupIdx].names.splice(nameIdx,1);
  if(makeupGroups[groupIdx].names.length===0){
    makeupGroups.splice(groupIdx,1);
  }

  document.getElementById("assignPopup").style.display="none";
  renderMakeupList();
}

// ----------------------------
// 6) 보강 완료 버튼
// ----------------------------
function completeSchedule(){
  // 스케쥴 삭제
  document.getElementById("scheduleArea").innerHTML="";

  // 보강 대상자 리스트는 "남은 사람만 유지"
  renderMakeupList();

  alert("보강 완료되었습니다!");
}

renderLessonTable();
renderMakeupList();

function cancelAssign(){
  // 슬롯을 원래 상태로 되돌림
  clickedSlot.innerText = originalSlotValue;
  
  // 팝업 닫기
  document.getElementById("assignPopup").style.display="none";
}

function deleteSlot(){
  const oldName = clickedSlot.innerText.trim();

  if(oldName){
    // 이름을 다시 보강 대상자 그룹 가장 오래된 곳에 복구
    if(makeupGroups.length > 0){
      makeupGroups[0].names.push(oldName);
    }else{
      alert("보강 대상자 그룹이 없습니다. 먼저 그룹을 생성하세요.");
    }
  }

  // 슬롯 비우기
  clickedSlot.innerText = "";

  // 팝업 닫기
  document.getElementById("assignPopup").style.display="none";

  renderMakeupList();
}

function getAssignedNames(){
  const tds = document.querySelectorAll("#scheduleArea td");
  const arr = [];
  tds.forEach(td=>{
    if(td.cellIndex===1 && td.innerText.trim()){
      arr.push(td.innerText.trim());
    }
  });
  return arr;
}

function openAssignPopup(td){
  clickedSlot = td;
  originalSlotValue = td.innerText.trim();

  const assigned = getAssignedNames();  // 이미 배정된 사람들

  const list=document.getElementById("candidateList");
  list.innerHTML="";

  makeupGroups.forEach((group, gi)=>{
    const title=document.createElement("div");
    title.style="font-weight:bold;margin:8px 0 4px;";
    title.innerText=`(${group.date} / ${group.reason})`;
    list.appendChild(title);

    group.names.forEach((nm,ni)=>{
      const div=document.createElement("div");
      div.className="name-item";

      if(assigned.includes(nm)){
        div.style.opacity="0.4";
        div.style.pointerEvents="none";
        div.innerText = nm + " (배정됨)";
      }else{
        div.innerText = nm;
        div.onclick=()=>assign(gi, ni);
      }

      list.appendChild(div);
    });
  });

  document.getElementById("assignPopup").style.display="block";
}

</script>

</body>
</html>
