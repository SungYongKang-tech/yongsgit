<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Makeup Lesson Manager</title>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Pretendard",sans-serif;
  margin:0;background:#f5f5f7;
}
header{
  background:#fff;padding:16px;font-size:1.3rem;font-weight:700;
  border-bottom:1px solid #ddd;
}
table{width:100%;border-collapse:collapse;background:#fff;margin-top:10px;}
th,td{border:1px solid #ccc;padding:10px;text-align:center;}
td.selectable{cursor:pointer;}
td.selected{background:#2563eb;color:white;}

.btn{
  width:100%;padding:12px;margin-top:12px;background:#2563eb;color:white;
  border:none;font-size:1rem;border-radius:8px;cursor:pointer;
}

.list{padding:16px;}
.group-box{
  background:#fff;padding:14px;margin-bottom:14px;border-radius:10px;
  border-left:5px solid #2563eb;
  box-shadow:0 3px 8px rgba(0,0,0,0.05);
}
.group-title{
  display:flex;justify-content:space-between;align-items:center;
  font-weight:bold;margin-bottom:6px;
}

.schedule-box{padding:16px;}
input{
  width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:8px;
}

.schedule-table td{
  height:40px;cursor:pointer;
}

/* Popup */
.popup-bg{
  position:fixed;left:0;right:0;top:0;bottom:0;
  background:rgba(0,0,0,0.35);display:none;
}
.popup{
  background:#fff;
  position:absolute;
  left:0; right:0; bottom:0;
  padding:20px;
  border-radius:20px 20px 0 0;
  animation:slideUp .25s ease-out;
}

@keyframes slideUp{
  from {transform:translateY(100%);}
  to {transform:translateY(0);}
}

.name-item{
  background:#fff;border:1px solid #ddd;padding:10px;border-radius:8px;
  margin-bottom:6px;cursor:pointer;
}
</style>
</head>

<body>

<header>ë ˆìŠ¨ ì‹œê°„í‘œ</header>

<div style="padding:12px;">
<table>
  <thead>
    <tr>
      <th>ì‹œê°„</th>
      <th>ì›”</th>
      <th>í™”</th>
      <th>ìˆ˜</th>
      <th>ëª©</th>
    </tr>
  </thead>
  <tbody id="lessonBody"></tbody>
</table>

<button class="btn" onclick="openMakeupPopup()">ë³´ê°• ëŒ€ìƒì ìƒì„±</button>
</div>

<header>ë³´ê°• ëŒ€ìƒì</header>
<div class="list" id="makeupList"></div>

<header>ë³´ê°• ìŠ¤ì¼€ì¥´</header>
<div class="schedule-box">
  <button class="btn" style="background:#16a34a;" onclick="openSchedulePopup()">ë³´ê°• ìŠ¤ì¼€ì¥´ ìƒì„±</button>
  <div id="scheduleArea" style="margin-top:16px;"></div>
</div>

<!-- ë³´ê°• ëŒ€ìƒì ìƒì„± íŒì—… -->
<div id="makeupPopup" class="popup-bg">
  <div class="popup">
    <h3>ë ˆìŠ¨ ë¯¸ì‹¤ì‹œ ë‚ ì§œ & ì‚¬ìœ  ì…ë ¥</h3>
    <input type="date" id="makeupDate">
    <input id="makeupReason" placeholder="ì‚¬ìœ  ì…ë ¥">

    <button class="btn" onclick="createMakeupTargets()">ìƒì„±</button>
    <button class="btn" style="background:#6b7280;margin-top:12px;" onclick="closeMakeupPopup()">ì·¨ì†Œ</button>
  </div>
</div>

<!-- ìŠ¤ì¼€ì¤„ ìƒì„± íŒì—… -->
<div id="schedulePopup" class="popup-bg">
  <div class="popup">
    <h3>ë³´ê°• ìŠ¤ì¼€ì¥´ ì„¤ì •</h3>
    <input type="date" id="scheduleDate">

    <label>ì‹œì‘ ì‹œê°„</label>
    <input id="startTime" type="time" value="11:25">

    <label>êµì‹œ ìˆ˜ (15ë¶„ ë‹¨ìœ„)</label>
    <input id="periodCount" type="number" value="5" min="1">

    <button class="btn" onclick="generateSchedule()">ìŠ¤ì¼€ì¥´ ìƒì„±</button>
    <button class="btn" style="background:#6b7280;" onclick="closeSchedulePopup()">ì·¨ì†Œ</button>
  </div>
</div>

<!-- ì´ë¦„ ì„ íƒ íŒì—… -->
<div id="assignPopup" class="popup-bg">
  <div class="popup">
    <h3>ë³´ê°• ëŒ€ìƒì ì„ íƒ</h3>
    <div id="candidateList"></div>

    <button class="btn" style="background:#ef4444;margin-top:12px;" onclick="deleteSlot()">ì‚­ì œ</button>
    <button class="btn" style="background:#6b7280;margin-top:12px;" onclick="cancelAssign()">ì·¨ì†Œ</button>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>


<script>
/* ----------------------
    Firebase ì´ˆê¸°í™”
-----------------------*/
const firebaseConfig = {
  apiKey: "AIzaSyAV47F8u96UQ_2hf9q2KdtGlXqDXYbThyo",
  authDomain: "lessonswap-26e9b.firebaseapp.com",
  databaseURL: "https://lessonswap-26e9b-default-rtdb.firebaseio.com",
  projectId: "lessonswap-26e9b",
  storageBucket: "lessonswap-26e9b.appspot.com",  // â† ìˆ˜ì •!
  messagingSenderId: "1068278553187",
  appId: "1:1068278553187:web:410ff81cc7e96f293fb656"
};


let firebaseReady = { groups: false, schedule: false };

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ----------------------
   Firebase ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
-----------------------*/
function saveMakeupGroups() {
  db.ref("makeupGroups").set(makeupGroups);
}
function saveScheduleList() {
  db.ref("scheduleList").set(scheduleList);
}

// ì‹¤ì‹œê°„ ê°ì‹œ
db.ref("makeupGroups").on("value", snap => {
  makeupGroups = snap.val() || [];
  firebaseReady.groups = true;
  initIfReady();   // âœ” ì¤€ë¹„ëëŠ”ì§€ í™•ì¸
});

db.ref("scheduleList").on("value", snap => {
  scheduleList = snap.val() || [];
  firebaseReady.schedule = true;
  initIfReady();   // âœ” ì¤€ë¹„ëëŠ”ì§€ í™•ì¸
});


/* ----------------------
      ê¸°ë³¸ ë°ì´í„°
-----------------------*/
const timetable = {
  "11:25": {mon:"ì •ìŠ¹ëª©", tue:"ì´ì„¸ë€", wed:"ì •ìŠ¹ëª©", thu:"ì´ì„¸ë€"},
  "11:40": {mon:"ì´ìƒì¤€", tue:"ë°•ë‚˜ë ¹", wed:"ì´ìƒì¤€", thu:"ë°•ë‚˜ë ¹"},
  "11:55": {mon:"ì´ë‚­ì£¼", tue:"ê¹€ìŠ¹ì¼", wed:"ì´ë‚­ì£¼", thu:"ê¹€ìŠ¹ì¼"},
  "12:10": {mon:"ì¡°ë³´ë¯¸", tue:"ì†¡ì€ì•„", wed:"ì¡°ë³´ë¯¸", thu:"ì†¡ì€ì•„"},
  "12:25": {mon:"ê³ ì€ì„ ", tue:"ì„ì¶˜ê·¼", wed:"ê³ ì€ì„ ", thu:"ì„ì¶˜ê·¼"},
};

let selectedCells = [];
let makeupGroups = [];
let scheduleList = [];
let clickedSchedule = null;

/* ----------------------
   ë ˆìŠ¨ ì‹œê°„í‘œ ë Œë”ë§
-----------------------*/
function renderLessonTable(){
  const body=document.getElementById("lessonBody");
  body.innerHTML="";

  Object.keys(timetable).forEach(time=>{
    const tr=document.createElement("tr");
    tr.innerHTML += `<td>${time}</td>`;

    ["mon","tue","wed","thu"].forEach(day=>{
      const name=timetable[time][day];
      const td=document.createElement("td");
      td.className="selectable";
      td.innerText=name;
      td.onclick=()=>toggle(time,day,name,td);
      tr.appendChild(td);
    });

    body.appendChild(tr);
  });
}

function toggle(time,day,name,td){
  const key=`${time}_${day}_${name}`;
  if(selectedCells.includes(key)){
    selectedCells = selectedCells.filter(x=>x!==key);
    td.classList.remove("selected");
  } else {
    selectedCells.push(key);
    td.classList.add("selected");
  }
}

function initIfReady() {
  // ì‹œê°„í‘œëŠ” ë¬´ì¡°ê±´ ë¨¼ì € ë Œë”ë§
  renderLessonTable();

  // Firebase ë°ì´í„°ê°€ ì¤€ë¹„ë˜ë©´ ë‚˜ë¨¸ì§€ë¥¼ ë Œë”ë§
  if (firebaseReady.groups) renderMakeupList();
  if (firebaseReady.schedule) renderScheduleList();
}



/* ----------------------
    ë³´ê°• ëŒ€ìƒì ìƒì„±
-----------------------*/
function openMakeupPopup(){ document.getElementById("makeupPopup").style.display="block"; }
function closeMakeupPopup(){ document.getElementById("makeupPopup").style.display="none"; }

function createMakeupTargets(){
  const date=document.getElementById("makeupDate").value;
  const reason=document.getElementById("makeupReason").value;

  if(!date || !reason) return alert("ë‚ ì§œì™€ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

  const newGroup = { date, reason, names:[] };

 selectedCells.forEach(key=>{
  // keyëŠ” "11:25_mon_ì •ìŠ¹ëª©" í˜•íƒœ â†’ ë§ˆì§€ë§‰ í•­ëª©ì´ ì´ë¦„
  const name = key.substring(key.lastIndexOf("_") + 1);
  newGroup.names.push({ name, done:false });
});


  makeupGroups.push(newGroup);
  saveMakeupGroups();

  renderMakeupList();

  // â˜…â˜…â˜… ì„ íƒ ìƒíƒœ ì´ˆê¸°í™” â˜…â˜…â˜…
  selectedCells = [];
  document.querySelectorAll(".selected").forEach(td => {
    td.classList.remove("selected");
  });

  closeMakeupPopup();
}


/* ----------------------
    ë³´ê°• ëŒ€ìƒì ë¦¬ìŠ¤íŠ¸
-----------------------*/
function renderMakeupList() {
  const box = document.getElementById("makeupList");
  box.innerHTML = "";

  if (makeupGroups.length === 0) {
    box.innerHTML = "<div style='color:#666;'>ë³´ê°• ëŒ€ìƒì ì—†ìŒ</div>";
    return;
  }

  makeupGroups.forEach((group, idx) => {
    const div = document.createElement("div");
    div.className = "group-box";

    let html = `
      <div class="group-title">
        <span>${group.date} (${getKoreanDay(group.date)}) / ${group.reason}</span>
        <button onclick="deleteGroup(${idx})"
          style="background:#ef4444;padding:4px 8px;border:none;color:#fff;border-radius:6px;font-size:0.8rem;">
          ì‚­ì œ
        </button>
      </div>
    `;

    group.names.forEach((n, i) => {
      const state = n.done
        ? "<span style='color:green;font-weight:bold;'>(ë³´ê°•ì™„ë£Œ)</span>"
        : "<span style='color:#999'>(ë³´ê°•ì˜ˆì •)</span>";

      const btnLabel = n.done ? "ë³´ê°•ì™„ë£Œ ì·¨ì†Œ" : "ë¹ˆíƒ€ì„ ë³´ê°•ì™„ë£Œ";

      html += `
        <div style="margin-bottom:6px;">
          - <span style="font-weight:${n.done ? 'bold' : 'normal'}">${n.name}</span> 
            ${state}
          <button onclick="completeWithoutSchedule(${idx}, ${i})"
            style="margin-left:8px;padding:4px 6px;border-radius:6px;border:1px solid #ccc;">
            ${btnLabel}
          </button>

          <!-- ì´ë¦„ ë³€ê²½ ê¸°ëŠ¥(ë³´ê°•ëŒ€ìƒì êµì²´ ê¸°ëŠ¥) -->
          <button onclick="openChangeTargetPopup(${idx}, ${i})"
            style="margin-left:6px;padding:4px 6px;border-radius:6px;border:1px solid #2563eb;color:#2563eb;">
            ë³€ê²½
          </button>
        </div>
      `;
    });

    div.innerHTML = html;
    box.appendChild(div);
  });
}


function deleteGroup(idx){
  if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  makeupGroups.splice(idx,1);
  saveMakeupGroups();
}

function completeWithoutSchedule(groupIndex, nameIndex){
  const target = makeupGroups[groupIndex].names[nameIndex];
  target.done = !target.done;
  saveMakeupGroups();
}

/* ----------------------
    ìŠ¤ì¼€ì¤„ ìƒì„±
-----------------------*/
function openSchedulePopup(){ document.getElementById("schedulePopup").style.display="block"; }
function closeSchedulePopup(){ document.getElementById("schedulePopup").style.display="none"; }

function generateSchedule() {
  const date = document.getElementById("scheduleDate").value;
  const period = parseInt(document.getElementById("periodCount").value);
  const startTime = document.getElementById("startTime").value;

  if (!date || !period || !startTime) {
    return alert("ëª¨ë“  ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.");
  }

  // 1) ë‚ ì§œ + ì‹œê°„ìœ¼ë¡œ Date ê°ì²´ ìƒì„±
  let baseDate = new Date(`${date}T${startTime}:00`);

  if (isNaN(baseDate.getTime())) {
    alert("ì‹œê°„ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.");
    return;
  }

  let schedule = {
    date,
    slots: []
  };

  // 2) period íšŸìˆ˜ë§Œí¼ 15ë¶„ì”© ì¦ê°€
  for (let i = 0; i < period; i++) {

    let hh = baseDate.getHours();
    let mm = baseDate.getMinutes();

    let timeText = `${String(hh).padStart(2, "0")}:${String(mm).padStart(2, "0")}`;

    schedule.slots.push({
      time: timeText,
      name: "",
      done: false,
      groupDate: null
    });

    // ğŸ”¥ Date ê°ì²´ë¡œ 15ë¶„ ì¦ê°€
    baseDate.setMinutes(baseDate.getMinutes() + 15);
  }

  // Firebase ì €ì¥
  scheduleList.push(schedule);
  saveScheduleList();

  closeSchedulePopup();
}



/* ----------------------
    ìŠ¤ì¼€ì¤„ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
-----------------------*/
function renderScheduleList(){
  const box=document.getElementById("scheduleArea");
  box.innerHTML="";

  scheduleList.forEach((sc, idx)=>{
    const wrap=document.createElement("div");
    wrap.style="margin-bottom:20px;background:#fff;padding:14px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);";

    wrap.innerHTML = `
      <div style="display:flex;justify-content:space-between;">
        <h3>${sc.date} (${getKoreanDay(sc.date)})<br>ë³´ê°• ìŠ¤ì¼€ì¥´</h3>

        <div>
          <button onclick="toggleScheduleView(${idx})"
           style="background:#2563eb;color:#fff;padding:6px 10px;border:none;border-radius:6px;margin-right:6px;">
           ë³´ê¸°/ìˆ¨ê¸°ê¸°
          </button>

          <button onclick="removeSchedule(${idx})"
           style="background:#ef4444;color:#fff;padding:6px 10px;border:none;border-radius:6px;">
           ë‹«ê¸°
          </button>
        </div>
      </div>

      <div id="scheduleTable_${idx}"></div>
    `;

    box.appendChild(wrap);
    renderScheduleTable(idx);
  });
}

function toggleScheduleView(idx){
  const box=document.getElementById(`scheduleTable_${idx}`);
  box.style.display = box.style.display==="none" ? "block" : "none";
}

function removeSchedule(idx){
  if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  scheduleList.splice(idx,1);
  saveScheduleList();
}

/* ----------------------
    ìŠ¤ì¼€ì¤„ í…Œì´ë¸” ë Œë”ë§
-----------------------*/
function renderScheduleTable(idx){
  const sc=scheduleList[idx];
  const container=document.getElementById(`scheduleTable_${idx}`);

  let html = `
    <table class="schedule-table">
      <tr><th>ì‹œê°„</th><th>ë³´ê°•ì</th><th>ìƒíƒœ</th></tr>
  `;

  sc.slots.forEach((slot,sidx)=>{
    const btnLabel = slot.done ? "ë³´ê°•ì™„ë£Œ" : "ë³´ê°•ì˜ˆì •";
    const btnColor = slot.done ? "background:green;color:white;" : "background:#2563eb;color:white;";

    html += `
      <tr>
        <td>${slot.time}</td>
        <td onclick="openAssignPopupSchedule(${idx}, ${sidx})">${slot.name || ""}</td>

        <td>
          <button onclick="markDoneSchedule(${idx}, ${sidx})"
            style="padding:6px 10px;border-radius:6px;border:none;${btnColor}">
            ${btnLabel}
          </button>
        </td>
      </tr>
    `;
  });

  html += "</table>";
  container.innerHTML = html;
}

/* ----------------------
    ë³´ê°•ì™„ë£Œ ì²˜ë¦¬
-----------------------*/
function markDoneSchedule(sIdx, slotIdx){
  const slot=scheduleList[sIdx].slots[slotIdx];
  if(!slot.name) return alert("ë¨¼ì € ì´ë¦„ì„ ë°°ì •í•˜ì„¸ìš”.");

  slot.done = true;

  // ê·¸ë£¹ ë°ì´í„°ì—ë„ ë°˜ì˜
  makeupGroups.forEach(g=>{
    if(g.date === slot.groupDate){
      g.names.forEach(n=>{ if(n.name===slot.name) n.done=true; });
    }
  });

  saveMakeupGroups();
  saveScheduleList();
}

/* ----------------------
    ì´ë¦„ ì„ íƒ íŒì—…
-----------------------*/
function openAssignPopupSchedule(sIdx, slotIdx) {
  // í˜„ì¬ ì„ íƒí•œ ìŠ¬ë¡¯ ì •ë³´ë¥¼ ì €ì¥
  clickedSchedule = { sIdx, slotIdx };

  const list = document.getElementById("candidateList");
  list.innerHTML = "";

  // ëª¨ë“  ë³´ê°• ê·¸ë£¹ ì¶œë ¥
  makeupGroups.forEach(group => {
    // ê·¸ë£¹ ì œëª©
    const title = document.createElement("div");
    title.style = "font-weight:bold;margin:10px 0 4px;";
    title.innerText = `${group.date} (${getKoreanDay(group.date)}) / ${group.reason}`;
    list.appendChild(title);

    // ê·¸ë£¹ ë‚´ ì´ë¦„ ëª©ë¡ ì¶œë ¥
    group.names.forEach(n => {
      const div = document.createElement("div");
      div.className = "name-item";
      div.innerText = n.name;

      // done ì—¬ë¶€ ìƒê´€ì—†ì´ ì„ íƒ ê°€ëŠ¥
      div.onclick = () => {
        assignToSchedule(sIdx, slotIdx, n.name, group.date);
      };

      list.appendChild(div);
    });
  });

  // íŒì—… ì—´ê¸°
  document.getElementById("assignPopup").style.display = "block";
}

function assignToSchedule(sIdx, slotIdx, name, groupDate){
  const slot=scheduleList[sIdx].slots[slotIdx];

  slot.name=name;
  slot.done=false;
  slot.groupDate=groupDate;

  saveScheduleList();

  document.getElementById("assignPopup").style.display="none";
}

/* ----------------------
    íŒì—…ì—ì„œ ì‚­ì œ
-----------------------*/
function deleteSlot(){
  if(clickedSchedule){
    const slot=scheduleList[clickedSchedule.sIdx].slots[clickedSchedule.slotIdx];
    slot.name="";
    slot.done=false;
    slot.groupDate=null;

    saveScheduleList();
  }
  document.getElementById("assignPopup").style.display="none";
}

/* ----------------------
    ë‚ ì§œ â†’ ìš”ì¼
-----------------------*/
function getKoreanDay(dateStr){
  const days=["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
  return days[new Date(dateStr).getDay()];
}

function cancelAssign(){ document.getElementById("assignPopup").style.display="none"; }

window.onload = () => initIfReady();

/* ----------------------
    ë³´ê°• ëŒ€ìƒì ë³€ê²½ ê¸°ëŠ¥
-----------------------*/

// íŒì—… ì—´ê¸°
function openChangeTargetPopup(groupIndex, nameIndex) {
  const current = makeupGroups[groupIndex].names[nameIndex];

  const newName = prompt(
    `í˜„ì¬ ì´ë¦„: ${current.name}\nìƒˆë¡œìš´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.`,
    current.name
  );

  if (!newName) return;

  makeupGroups[groupIndex].names[nameIndex].name = newName;
  saveMakeupGroups();
  renderMakeupList();
}

</script>


</body>
</html>
