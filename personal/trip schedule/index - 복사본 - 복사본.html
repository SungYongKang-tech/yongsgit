<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>전기기사 문제은행</title>
  <meta name="description" content="전기기사 필기 문제은행 (학습/시험)" />
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --ink:#0f172a; --muted:#64748b;
      --accent:#2563eb; --border:#e5e7eb; --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(245,247,251,.8); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .wrap{ max-width:980px; margin:0 auto; padding:16px; }
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:10px 0;
    }
    h1{ font-size:20px; margin:0; letter-spacing:-.2px; }
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid var(--border); background:#fff;
      padding:6px 10px; border-radius:999px;
    }
    main{ padding:18px 0 36px; }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 820px){
      .grid{ grid-template-columns: 1.2fr .8fr; }
    }
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:16px;
    }
    .card h2{ margin:0 0 8px; font-size:16px; }
    .desc{ margin:0 0 12px; color:var(--muted); font-size:14px; line-height:1.5; }
    .btns{ display:flex; flex-wrap:wrap; gap:10px; }
    .btn{
      appearance:none; border:1px solid var(--border);
      background:#fff; color:var(--ink);
      padding:12px 14px; border-radius:14px;
      font-weight:700; font-size:14px;
      cursor:pointer; text-decoration:none; display:inline-flex; gap:10px; align-items:center;
      transition: transform .06s ease, border-color .2s ease, box-shadow .2s ease;
      user-select:none;
    }
    .btn:hover{ border-color:#cbd5e1; box-shadow:0 10px 24px rgba(0,0,0,.06); transform: translateY(-1px); }
    .btn.primary{
      background:var(--accent); border-color:transparent; color:#fff;
    }
    .btn.primary:hover{ box-shadow:0 14px 28px rgba(37,99,235,.25); }
    .btn .tag{
      font-size:12px; font-weight:800;
      padding:4px 8px; border-radius:999px;
      background:rgba(15,23,42,.06); color:var(--ink);
    }
    .btn.primary .tag{ background:rgba(255,255,255,.18); color:#fff; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label{ font-size:13px; color:var(--muted); }
    select{
      border:1px solid var(--border); border-radius:12px;
      padding:10px 12px; font-weight:700; background:#fff; color:var(--ink);
    }
    .small{
      font-size:12px; color:var(--muted); line-height:1.5; margin:10px 0 0;
    }
    .ok{
      display:inline-flex; gap:8px; align-items:center;
      font-size:12px; color:var(--muted);
      padding:6px 10px; border-radius:12px;
      border:1px dashed var(--border); background:#fff;
    }
    .warn{ color:#b45309; }
    footer{ color:var(--muted); font-size:12px; padding:0 0 24px; }
    code{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="top">
        <h1>전기기사 문제은행</h1>
        <div class="pill" id="dataStatus">데이터 확인 중…</div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="card">
        <h2>모드 선택</h2>
        <p class="desc">
          테스트용 데이터로 동작을 확인한 뒤, 100문제까지 확장할 계획입니다.
          먼저 아래에서 데이터 파일을 선택하고 시작하세요.
        </p>

        <div class="row" style="margin:0 0 12px;">
          <label for="dataset">데이터 파일</label>
          <select id="dataset">
            <option value="./data/EJK_2024_01_test.json" selected>2024 1회 (테스트)</option>
            <!-- 나중에 추가 예시:
            <option value="./data/EJK_2024_02.json">2024 2회</option>
            -->
          </select>
        </div>

        <div class="btns">
          <a class="btn primary" id="goStudy" href="./study.html">
            학습 모드 <span class="tag">1문제씩</span>
          </a>

          <a class="btn" id="goExam" href="./exam.html">
            시험 모드 <span class="tag">실전/보강</span>
          </a>

          <a class="btn" id="goResults" href="./results.html">
            결과/오답/통계 <span class="tag">최근 5회</span>
          </a>
        </div>

        <p class="small">
          시작 버튼을 누르면 선택한 데이터 경로가 <code>localStorage</code>에 저장됩니다.
          (다른 페이지에서 같은 데이터를 자동으로 사용)
        </p>
      </section>

      <aside class="card">
        <h2>테스트 체크</h2>
        <p class="desc">
          아래 항목이 모두 OK면, 이후 100문제로 늘려도 같은 방식으로 동작합니다.
        </p>

        <div class="row" style="margin-bottom:10px;">
          <span class="ok" id="checkFetch">JSON 로딩: 확인 중…</span>
          <span class="ok" id="checkImage">이미지 URL: 확인 중…</span>
          <span class="ok" id="checkEncoding">한글/특수문자: 확인 중…</span>
        </div>

        <p class="small warn" id="hintBox" style="margin-top:12px; display:none;"></p>

        <p class="small" style="margin-top:12px;">
          로컬에서 <code>file://</code>로 열면 데이터 로딩이 막힐 수 있습니다.<br />
          VSCode Live Server 또는 Netlify에서 확인하세요.
        </p>
      </aside>
    </div>
  </main>

  <footer class="wrap">
    <div>
      데이터 파일 위치: <code>/data/EJK_2024_01_test.json</code><br />
      권장: CSV(마스터) → JSON(앱용) 자동 변환 루틴
    </div>
  </footer>

  <script>
    // ✅ 앱 전체에서 공통으로 쓸 키 (study/exam/results에서도 동일하게 사용)
    const LS_KEY_DATASET = "EJK_SELECTED_DATASET_URL";

    const $ = (sel) => document.querySelector(sel);

    const datasetSel = $("#dataset");
    const dataStatus = $("#dataStatus");
    const checkFetch = $("#checkFetch");
    const checkImage = $("#checkImage");
    const checkEncoding = $("#checkEncoding");
    const hintBox = $("#hintBox");

    function setOk(el, text){
      el.textContent = "✅ " + text;
      el.style.borderStyle = "solid";
    }
    function setBad(el, text){
      el.textContent = "⚠️ " + text;
      el.style.borderStyle = "solid";
      el.style.borderColor = "#f59e0b";
    }

    function setHint(msg){
      hintBox.style.display = "block";
      hintBox.textContent = msg;
    }

    // 선택된 데이터셋을 localStorage에 저장해두고, 다른 페이지에서 그대로 사용
    function persistDataset(){
      const url = datasetSel.value;
      localStorage.setItem(LS_KEY_DATASET, url);

      // 링크에도 query로 달아두면(옵션) localStorage가 막혀도 추적 가능
      const qs = "?data=" + encodeURIComponent(url);
      $("#goStudy").href = "./study.html" + qs;
      $("#goExam").href = "./exam.html" + qs;
      $("#goResults").href = "./results.html" + qs;
    }

    async function probeDataset(){
      persistDataset();

      const url = datasetSel.value;
      dataStatus.textContent = "데이터 확인 중…";
      checkFetch.textContent = "JSON 로딩: 확인 중…";
      checkImage.textContent = "이미지 URL: 확인 중…";
      checkEncoding.textContent = "한글/특수문자: 확인 중…";
      hintBox.style.display = "none";

      try{
        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        if(!Array.isArray(data) || data.length === 0) throw new Error("배열 데이터가 아니거나 비어 있음");

        // 1) 로딩 OK
        setOk(checkFetch, "정상 (" + data.length + "문제)");
        dataStatus.textContent = "✅ 데이터 준비됨 (" + data.length + "문제)";

        // 2) 이미지 URL 체크 (있으면 OK, 없어도 OK지만 상태 표시)
        const hasImage = data.some(q => q && typeof q.image_url === "string" && q.image_url.startsWith("http"));
        if(hasImage) setOk(checkImage, "포함됨");
        else setBad(checkImage, "없음(문제에 그림이 없으면 정상)");

        // 3) 한글/특수문자 간단 체크 (문제/해설에서 한글이 최소 1개라도 있나)
        const sampleText = (data[0]?.question || "") + " " + (data[0]?.explain || "");
        const hasKorean = /[가-힣]/.test(sampleText);
        if(hasKorean) setOk(checkEncoding, "정상");
        else setBad(checkEncoding, "한글이 감지되지 않음(인코딩 확인)");

      }catch(err){
        dataStatus.textContent = "⚠️ 데이터 로딩 실패";
        setBad(checkFetch, "실패");
        setBad(checkImage, "확인 불가");
        setBad(checkEncoding, "확인 불가");

        setHint(
          "데이터를 불러오지 못했습니다. " +
          "로컬에서는 file://로 열면 fetch가 막힙니다. " +
          "VSCode Live Server로 열거나 Netlify에 배포 후 확인하세요. " +
          "또는 /data 폴더와 파일명이 정확한지 확인해 주세요. (" + err.message + ")"
        );
      }
    }

    // 초기: 이전에 저장한 데이터셋이 있으면 선택 복구
    (function init(){
      const saved = localStorage.getItem(LS_KEY_DATASET);
      if(saved){
        const opt = Array.from(datasetSel.options).find(o => o.value === saved);
        if(opt) datasetSel.value = saved;
      }
      datasetSel.addEventListener("change", probeDataset);

      // 버튼 누르기 전에도 저장 + 링크 반영
      ["goStudy","goExam","goResults"].forEach(id=>{
        const a = document.getElementById(id);
        a.addEventListener("click", () => persistDataset());
      });

      probeDataset();
    })();
  </script>
</body>
</html>
