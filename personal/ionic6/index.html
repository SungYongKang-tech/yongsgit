<body>
  <div class="container">
    <h2>전기차 충전 할인 계산기</h2>

    <!-- 🔹 로그인/로그아웃 버튼 -->
    <div style="text-align:center; margin-bottom:15px;">
      <button id="loginBtn" style="background:#4caf50;">로그인</button>
      <button id="logoutBtn" style="background:#888;">로그아웃</button>
      <div id="userStatus" style="margin-top:8px; font-size:14px; color:#333;"></div>
    </div>

    <input type="number" id="amount" placeholder="충전금액 입력 (₩)" />
    <div class="description">
      환경부카드 월 최대 30,000원까지 할인 적용됩니다.<br />
      아래 표에는 남은 할인 한도, 추가 충전량 등이 표시됩니다.
    </div>
    <table id="logTable"></table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBmVXt2ze1iJmmA_YI-sgH3tJmSvZomkOo",
      authDomain: "ionic6-3b7b2.firebaseapp.com",
      databaseURL: "https://ionic6-3b7b2-default-rtdb.firebaseio.com",
      projectId: "ionic6-3b7b2",
      storageBucket: "ionic6-3b7b2.appspot.com",
      messagingSenderId: "306251113324",
      appId: "1:306251113324:web:0559f88d362de423c18949"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const MAX_DISCOUNT = 30000;
    const DISCOUNT_RATE = 0.7;
    const PRICE_PER_KWH = 341;
    const BATTERY_CAPACITY = 77.4;

    const amountInput = document.getElementById("amount");
    const logsTable  = document.getElementById("logTable");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userStatus = document.getElementById("userStatus");

    let currentMonth = new Date().toISOString().substring(0, 7);
    let totalDiscountUsed = 0;

    // 🔹 로그인 버튼 클릭 → 익명 로그인
    loginBtn.addEventListener("click", () => {
      signInAnonymously(auth)
        .then(() => console.log("익명 로그인 성공"))
        .catch(err => alert("로그인 실패: " + err.message));
    });

    // 🔹 로그아웃 버튼 클릭
    logoutBtn.addEventListener("click", () => {
      signOut(auth)
        .then(() => console.log("로그아웃 성공"))
        .catch(err => alert("로그아웃 실패: " + err.message));
    });

    // 🔹 로그인 상태 변경 감지
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userStatus.textContent = `로그인됨 (UID: ${user.uid})`;
        startApp();
      } else {
        userStatus.textContent = "로그아웃됨";
        logsTable.innerHTML = "";
      }
    });

    function startApp() {
      const logRef = ref(db, `chargingLogs/${currentMonth}`);

      onValue(logRef, (snapshot) => {
        const data = snapshot.val();
        totalDiscountUsed = 0;
        if (data) {
          Object.values(data).forEach(log => {
            totalDiscountUsed += Number(log.discount || 0);
          });
        }
        renderLogs(data);
      });

      amountInput.onchange = () => {
        const amount = Number(amountInput.value);
        if (!amount || amount <= 0) return;

        const now = new Date();
        const isoDate = now.toISOString();
        const monthKey = isoDate.substring(0, 7);

        const remainingCap = Math.max(0, MAX_DISCOUNT - totalDiscountUsed);
        const discount     = Math.min(amount * DISCOUNT_RATE, remainingCap);
        const remaining    = Math.max(0, MAX_DISCOUNT - (totalDiscountUsed + discount));
        const moreCharge   = remaining / DISCOUNT_RATE;
        const moreKwh      = moreCharge / PRICE_PER_KWH;
        const batteryPct   = (moreKwh / BATTERY_CAPACITY) * 100;

        const data = {
          timestamp: isoDate,
          amount: Math.round(amount),
          discount: Math.round(discount),
          remaining: Math.round(remaining),
          moreCharge: Math.floor(moreCharge),
          moreKwh: parseFloat(moreKwh.toFixed(2)),
          batteryPercent: parseFloat(batteryPct.toFixed(1))
        };

        push(ref(db, `chargingLogs/${monthKey}`), data);
        amountInput.value = "";
      };
    }

    function renderLogs(data) {
      logsTable.innerHTML = `<tr>
        <th>날짜</th><th>금액</th><th>할인</th><th>남은할인한도</th>
        <th>추가충전가능금액</th><th>추가kWh</th><th>충전%</th><th>삭제</th>
      </tr>`;

      const entries = Object.entries(data || {})
        .sort((a, b) => new Date(b[1].timestamp) - new Date(a[1].timestamp));

      entries.forEach(([key, log]) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${log.timestamp.substring(5, 10)}</td>
          <td>${Number(log.amount).toLocaleString()}</td>
          <td>${Number(log.discount).toLocaleString()}</td>
          <td>${Number(log.remaining).toLocaleString()}</td>
          <td>${Number(log.moreCharge).toLocaleString()}</td>
          <td>${log.moreKwh}</td>
          <td>${log.batteryPercent}%</td>
          <td><button data-key="${key}" class="del">삭제</button></td>
        `;
        logsTable.appendChild(row);
      });

      logsTable.querySelectorAll('button.del').forEach(btn => {
        btn.onclick = () => remove(ref(db, `chargingLogs/${currentMonth}/${btn.dataset.key}`));
      });
    }
  </script>
</body>
