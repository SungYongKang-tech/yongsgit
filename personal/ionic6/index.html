<!DOCTYPE html>
<html lang="ko">
<body>
  <div class="container">
    <h2>ì „ê¸°ì°¨ ì¶©ì „ í• ì¸ ê³„ì‚°ê¸°</h2>

    <!-- ë¡œê·¸ì¸ -->
    <div class="auth-panel">
      <input type="email" id="email" placeholder="ê´€ë¦¬ì ì´ë©”ì¼"/>
      <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸"/>
      <button id="loginBtn" class="btn green">ë¡œê·¸ì¸</button>
      <button id="logoutBtn" class="btn gray">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <!-- ì¶©ì „ê¸ˆì•¡ ì…ë ¥ -->
    <input type="number" id="amount" placeholder="ì¶©ì „ê¸ˆì•¡ ì…ë ¥ (â‚©)" disabled />

    <div class="description">
      í™˜ê²½ë¶€ì¹´ë“œëŠ” ì›” ìµœëŒ€ <b>30,000ì›</b>ê¹Œì§€ í• ì¸ë©ë‹ˆë‹¤.<br/>
      ì•„ë˜ ì¹´ë“œì—ì„œ ì¶©ì „ ë‚´ì—­ì„ í™•ì¸í•˜ì„¸ìš”.
    </div>

    <!-- ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
    <div class="card-list"></div>
  </div>

  <!-- ================= CSS ================= -->
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: "Noto Sans KR", sans-serif;
      background: #eaf7ff;
      font-size: 20px;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #01579b;
      font-size: 2.1rem;
    }

    /* ë¡œê·¸ì¸ UI */
    .auth-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }

    .auth-panel input {
      padding: 16px;
      border-radius: 12px;
      border: 1px solid #b0bec5;
      font-size: 1.3rem;
    }

    .btn {
      padding: 16px;
      font-size: 1.35rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }

    .btn.green { background: #4caf50; color: white; }
    .btn.gray { background: #757575; color: white; }

    #loginBtn, #logoutBtn { display: none; }

    #amount {
      width: 100%;
      padding: 16px;
      border-radius: 12px;
      border: 1px solid #aaa;
      font-size: 1.3rem;
      margin-bottom: 20px;
    }

    .description {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.3rem;
      color: #37474f;
    }

    /* ================= ì¹´ë“œ UI ================= */
    .card {
      background: white;
      border-radius: 18px;
      padding: 24px;
      margin-bottom: 22px;
      box-shadow: 0 8px 28px rgba(0,0,0,0.12);
      font-size: 1.45rem;
    }

    .card-date {
      font-size: 1.6rem;
      font-weight: 700;
      color: #0277bd;
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 14px;
      font-size: 1.45rem;
    }

    .row label {
      font-weight: 700;
      color: #01579b;
    }

    /* ì‚­ì œ ë²„íŠ¼ */
    .card-delete {
      margin-top: 18px;
      text-align: center;
      background: #ef5350;
      color: white;
      padding: 16px;
      font-size: 1.5rem;
      border-radius: 12px;
    }
  </style>

  <!-- ================= JS ================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, get, child } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import {
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    /* Firebase ì„¤ì • */
    const firebaseConfig = {
      apiKey: "AIzaSyBmVXt2ze1iJmmA_YI-sgH3tJmSvZomkOo",
      authDomain: "ionic6-3b7b2.firebaseapp.com",
      databaseURL: "https://ionic6-3b7b2-default-rtdb.firebaseio.com",
      projectId: "ionic6-3b7b2",
      storageBucket: "ionic6-3b7b2.appspot.com",
      messagingSenderId: "306251113324",
      appId: "1:306251113324:web:0559f88d362de423c18949"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    /* ìƒìˆ˜ */
    const MAX_DISCOUNT = 30000;
    const RATE = 0.7;
    const PRICE_KWH = 341;
    const BATTERY = 77.4;

    /* ì—˜ë¦¬ë¨¼íŠ¸ */
    const amountInput = document.getElementById("amount");
    const loginBtn    = document.getElementById("loginBtn");
    const logoutBtn   = document.getElementById("logoutBtn");
    const emailInput  = document.getElementById("email");
    const pwInput     = document.getElementById("password");
    const cardList    = document.querySelector(".card-list");

    let currentMonth = new Date().toISOString().substring(0,7);
    let totalDiscount = 0;
    let isAdmin = false;

    /* -------- ë¡œê·¸ì¸ ---------- */
    loginBtn.onclick = () => {
      setPersistence(auth, browserLocalPersistence)
      .then(() => signInWithEmailAndPassword(auth, emailInput.value, pwInput.value))
      .catch(err => alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + err.message));
    };

    logoutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        loginBtn.style.display = "none";
        logoutBtn.style.display = "block";

        const snap = await get(child(ref(db), `admins/${user.uid}`));
        isAdmin = snap.exists() && snap.val() === true;

        amountInput.disabled = !isAdmin;

        startApp();
      } else {
        loginBtn.style.display = "block";
        logoutBtn.style.display = "none";
        amountInput.disabled = true;
        cardList.innerHTML = "";
      }
    });

    /* -------- DB ì½ê¸° -------- */
    function startApp() {
      const logRef = ref(db, `chargingLogs/${currentMonth}`);

      onValue(logRef, snap => {
        const data = snap.val();
        totalDiscount = 0;

        if (data) {
          Object.values(data).forEach(v => totalDiscount += v.discount);
        }
        renderCards(data);
      });

      amountInput.onchange = () => {
        if (!isAdmin) return;

        const amount = Number(amountInput.value);
        if (!amount) return;

        const timestamp = new Date().toISOString();
        const remainCap = Math.max(0, MAX_DISCOUNT - totalDiscount);
        const discount  = Math.min(amount * RATE, remainCap);
        const remaining = Math.max(0, MAX_DISCOUNT - (totalDiscount + discount));

        const moreCharge = remaining / RATE;
        const moreKwh    = moreCharge / PRICE_KWH;
        const pct        = (moreKwh / BATTERY) * 100;

        const log = {
          timestamp,
          amount: Math.round(amount),
          discount: Math.round(discount),
          remaining: Math.round(remaining),
          moreCharge: Math.round(moreCharge),
          moreKwh: Number(moreKwh.toFixed(2)),
          batteryPercent: Number(pct.toFixed(1))
        };

        push(ref(db, `chargingLogs/${currentMonth}`), log);
        amountInput.value = "";
      };
    }

    /* -------- ì¹´ë“œ ë Œë”ë§ -------- */
    function renderCards(data) {
      cardList.innerHTML = "";

      const entries = Object.entries(data || {})
        .sort((a,b) => new Date(b[1].timestamp) - new Date(a[1].timestamp));

      entries.forEach(([key, log]) => {
        const div = document.createElement("div");
        div.className = "card";

        div.innerHTML = `
          <div class="card-date">ğŸ“… ${log.timestamp.substring(5,10)}</div>

          <div class="row"><label>ğŸ’° ì¶©ì „ê¸ˆì•¡</label><span>${log.amount.toLocaleString()}ì›</span></div>
          <div class="row"><label>ğŸ’¸ í• ì¸ì ìš©</label><span>${log.discount.toLocaleString()}ì›</span></div>
          <div class="row"><label>ğŸ¦ ë‚¨ì€ í• ì¸</label><span>${log.remaining.toLocaleString()}ì›</span></div>

          <hr style="margin:18px 0; border:none; border-top:2px solid #ddd;">

          <div class="row"><label>âš¡ ì¶”ê°€ì¶©ì „ ê¸ˆì•¡</label><span>${log.moreCharge.toLocaleString()}ì›</span></div>
          <div class="row"><label>ğŸ”‹ ì¶”ê°€ kWh</label><span>${log.moreKwh} kWh</span></div>
          <div class="row"><label>ğŸ“ˆ ì¶©ì „ ê°€ëŠ¥%</label><span>${log.batteryPercent}%</span></div>

          ${
            isAdmin
            ? `<div class="card-delete" data-key="${key}">ì‚­ì œ</div>`
            : ""
          }
        `;

        cardList.appendChild(div);
      });

      document.querySelectorAll(".card-delete").forEach(btn => {
        btn.onclick = () => {
          remove(ref(db, `chargingLogs/${currentMonth}/${btn.dataset.key}`));
        };
      });
    }
  </script>
</body>
</html>
