<!DOCTYPE html>
<html lang="ko">
<body>
  <div class="container">
    <h2>전기차 충전 할인 계산기</h2>

    <!-- 로그인/로그아웃 영역 -->
    <div class="auth-panel">
      <input type="email" id="email" placeholder="관리자 이메일"/>
      <input type="password" id="password" placeholder="비밀번호"/>
      <button id="loginBtn" class="btn green">로그인</button>
      <button id="logoutBtn" class="btn gray">로그아웃</button>
    </div>

    <!-- 충전 금액 입력 -->
    <input type="number" id="amount" placeholder="충전금액 입력 (₩)" disabled />

    <div class="description">
      환경부카드 월 최대 <b>30,000원</b>까지 할인 적용됩니다.<br/>
      아래 카드에서 할인 적용 내역을 확인하세요.
    </div>

    <!-- 카드 목록 -->
    <div class="card-list"></div>
  </div>

  <!-- ================= CSS ================= -->
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: "Segoe UI", sans-serif;
      background: #e6f7ff;
      font-size: 20px;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #01579b;
      font-size: 2.1rem;
    }

    .auth-panel {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 18px;
    }

    .auth-panel input {
      padding: 16px;
      border-radius: 10px;
      border: 1px solid #b0bec5;
      font-size: 1.3rem;
    }

    .btn {
      padding: 14px 20px;
      border: none;
      font-size: 1.25rem;
      border-radius: 10px;
      cursor: pointer;
    }

    .btn.green { background: #4caf50; color: white; }
    .btn.gray { background: #757575; color: white; }

    #loginBtn, #logoutBtn { display: none; }

    #amount {
      width: 100%;
      padding: 16px;
      border-radius: 10px;
      border: 1px solid #aaa;
      font-size: 1.3rem;
      margin-bottom: 16px;
    }

    .description {
      text-align: center;
      margin-bottom: 16px;
      font-size: 1.25rem;
      color: #37474f;
    }

    /* ---- 카드 스타일 ---- */
    .card {
      background: white;
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,.08);
      margin-bottom: 20px;
      font-size: 1.35rem;
    }

    .card-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .card-row .label {
      font-weight: 700;
      color: #0277bd;
    }

    .card-delete {
      margin-top: 16px;
      padding: 14px;
      background: #ef5350;
      color: white;
      text-align: center;
      font-size: 1.35rem;
      border-radius: 10px;
    }
  </style>

  <!-- ================= JS ================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, get, child } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import {
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    /* Firebase 설정 */
    const firebaseConfig = {
      apiKey: "AIzaSyBmVXt2ze1iJmmA_YI-sgH3tJmSvZomkOo",
      authDomain: "ionic6-3b7b2.firebaseapp.com",
      databaseURL: "https://ionic6-3b7b2-default-rtdb.firebaseio.com",
      projectId: "ionic6-3b7b2",
      storageBucket: "ionic6-3b7b2.appspot.com",
      messagingSenderId: "306251113324",
      appId: "1:306251113324:web:0559f88d362de423c18949"
    };

    const app   = initializeApp(firebaseConfig);
    const db    = getDatabase(app);
    const auth  = getAuth(app);

    /* 상수 */
    const MAX_DISCOUNT = 30000;
    const RATE         = 0.7;
    const PRICE_KWH    = 341;
    const BATTERY      = 77.4;

    /* 요소 */
    const amountInput = document.getElementById("amount");
    const loginBtn    = document.getElementById("loginBtn");
    const logoutBtn   = document.getElementById("logoutBtn");
    const emailInput  = document.getElementById("email");
    const pwInput     = document.getElementById("password");
    const cardList    = document.querySelector(".card-list");

    let currentMonth  = new Date().toISOString().substring(0,7);
    let totalDiscount = 0;
    let isAdmin       = false;

    /* ------------------- 로그인 ------------------- */
    loginBtn.onclick = () => {
      setPersistence(auth, browserLocalPersistence)
      .then(() => signInWithEmailAndPassword(auth, emailInput.value, pwInput.value))
      .catch(err => alert("로그인 실패: " + err.message));
    };

    logoutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        loginBtn.style.display  = "none";
        logoutBtn.style.display = "block";

        const snap = await get(child(ref(db), `admins/${user.uid}`));
        isAdmin = snap.exists() && snap.val() === true;

        amountInput.disabled = !isAdmin;

        loadLogs();
      } else {
        loginBtn.style.display  = "block";
        logoutBtn.style.display = "none";
        amountInput.disabled    = true;
        cardList.innerHTML = "";
      }
    });

    /* ------------------- 데이터 로드 ------------------- */
    function loadLogs() {
      const logRef = ref(db, `chargingLogs/${currentMonth}`);

      onValue(logRef, snap => {
        const data = snap.val();
        totalDiscount = 0;

        if (data) {
          Object.values(data).forEach(l => totalDiscount += Number(l.discount));
        }
        renderCards(data);
      });
    }

    /* ------------------- 입력 처리 ------------------- */
    amountInput.onchange = () => {
      if (!isAdmin) return;

      const amount = Number(amountInput.value);
      if (!amount || amount <= 0) return;

      const now   = new Date().toISOString();
      const remainCap = Math.max(0, MAX_DISCOUNT - totalDiscount);
      const discount  = Math.min(amount * RATE, remainCap);
      const remain    = Math.max(0, MAX_DISCOUNT - (totalDiscount + discount));

      const moreCharge = remain / RATE;
      const moreKwh    = moreCharge / PRICE_KWH;
      const pct        = (moreKwh / BATTERY) * 100;

      const log = {
        timestamp: now,
        amount: Math.round(amount),
        discount: Math.round(discount),
        remaining: Math.round(remain),
        moreCharge: Math.round(moreCharge),
        moreKwh: Number(moreKwh.toFixed(2)),
        batteryPercent: Number(pct.toFixed(1))
      };

      push(ref(db, `chargingLogs/${currentMonth}`), log);
      amountInput.value = "";
    };

    /* ------------------- 카드 UI ------------------- */
    function renderCards(data) {
      cardList.innerHTML = "";

      const entries = Object.entries(data || {})
        .sort((a,b) => new Date(b[1].timestamp) - new Date(a[1].timestamp));

      entries.forEach(([key, log]) => {
        const div = document.createElement("div");
        div.className = "card";

        div.innerHTML = `
          <div class="card-row"><span class="label">날짜</span><span>${log.timestamp.substring(5,10)}</span></div>
          <div class="card-row"><span class="label">금액</span><span>${log.amount.toLocaleString()}원</span></div>
          <div class="card-row"><span class="label">할인</span><span>${log.discount.toLocaleString()}원</span></div>
          <div class="card-row"><span class="label">남은 할인</span><span>${log.remaining.toLocaleString()}원</span></div>
          <div class="card-row"><span class="label">추가 충전금액</span><span>${log.moreCharge.toLocaleString()}원</span></div>
          <div class="card-row"><span class="label">추가 kWh</span><span>${log.moreKwh} kWh</span></div>
          <div class="card-row"><span class="label">충전 가능 %</span><span>${log.batteryPercent}%</span></div>
          ${
            isAdmin
            ? `<div class="card-delete" data-key="${key}">삭제</div>`
            : ""
          }
        `;

        cardList.appendChild(div);
      });

      // 삭제 이벤트
      document.querySelectorAll(".card-delete").forEach(btn => {
        btn.onclick = () => {
          remove(ref(db, `chargingLogs/${currentMonth}/${btn.dataset.key}`));
        };
      });
    }
  </script>
</body>
</html>
