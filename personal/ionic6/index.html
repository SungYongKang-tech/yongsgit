<body>
  <div class="container">
    <h2>ì „ê¸°ì°¨ ì¶©ì „ í• ì¸ ê³„ì‚°ê¸°</h2>

    <!-- ğŸ”¹ ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
    <div style="text-align:center; margin-bottom:15px;">
      <button id="loginBtn" style="background:#4caf50;">ë¡œê·¸ì¸</button>
      <button id="logoutBtn" style="background:#888;">ë¡œê·¸ì•„ì›ƒ</button>
      <div id="userStatus" style="margin-top:8px; font-size:14px; color:#333;"></div>
    </div>

    <input type="number" id="amount" placeholder="ì¶©ì „ê¸ˆì•¡ ì…ë ¥ (â‚©)" />
    <div class="description">
      í™˜ê²½ë¶€ì¹´ë“œ ì›” ìµœëŒ€ 30,000ì›ê¹Œì§€ í• ì¸ ì ìš©ë©ë‹ˆë‹¤.<br />
      ì•„ë˜ í‘œì—ëŠ” ë‚¨ì€ í• ì¸ í•œë„, ì¶”ê°€ ì¶©ì „ëŸ‰ ë“±ì´ í‘œì‹œë©ë‹ˆë‹¤.
    </div>
    <table id="logTable"></table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBmVXt2ze1iJmmA_YI-sgH3tJmSvZomkOo",
      authDomain: "ionic6-3b7b2.firebaseapp.com",
      databaseURL: "https://ionic6-3b7b2-default-rtdb.firebaseio.com",
      projectId: "ionic6-3b7b2",
      storageBucket: "ionic6-3b7b2.appspot.com",
      messagingSenderId: "306251113324",
      appId: "1:306251113324:web:0559f88d362de423c18949"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const MAX_DISCOUNT = 30000;
    const DISCOUNT_RATE = 0.7;
    const PRICE_PER_KWH = 341;
    const BATTERY_CAPACITY = 77.4;

    const amountInput = document.getElementById("amount");
    const logsTable  = document.getElementById("logTable");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userStatus = document.getElementById("userStatus");

    let currentMonth = new Date().toISOString().substring(0, 7);
    let totalDiscountUsed = 0;

    // ğŸ”¹ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ â†’ ìµëª… ë¡œê·¸ì¸
    loginBtn.addEventListener("click", () => {
      signInAnonymously(auth)
        .then(() => console.log("ìµëª… ë¡œê·¸ì¸ ì„±ê³µ"))
        .catch(err => alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + err.message));
    });

    // ğŸ”¹ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­
    logoutBtn.addEventListener("click", () => {
      signOut(auth)
        .then(() => console.log("ë¡œê·¸ì•„ì›ƒ ì„±ê³µ"))
        .catch(err => alert("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: " + err.message));
    });

    // ğŸ”¹ ë¡œê·¸ì¸ ìƒíƒœ ë³€ê²½ ê°ì§€
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userStatus.textContent = `ë¡œê·¸ì¸ë¨ (UID: ${user.uid})`;
        startApp();
      } else {
        userStatus.textContent = "ë¡œê·¸ì•„ì›ƒë¨";
        logsTable.innerHTML = "";
      }
    });

    function startApp() {
      const logRef = ref(db, `chargingLogs/${currentMonth}`);

      onValue(logRef, (snapshot) => {
        const data = snapshot.val();
        totalDiscountUsed = 0;
        if (data) {
          Object.values(data).forEach(log => {
            totalDiscountUsed += Number(log.discount || 0);
          });
        }
        renderLogs(data);
      });

      amountInput.onchange = () => {
        const amount = Number(amountInput.value);
        if (!amount || amount <= 0) return;

        const now = new Date();
        const isoDate = now.toISOString();
        const monthKey = isoDate.substring(0, 7);

        const remainingCap = Math.max(0, MAX_DISCOUNT - totalDiscountUsed);
        const discount     = Math.min(amount * DISCOUNT_RATE, remainingCap);
        const remaining    = Math.max(0, MAX_DISCOUNT - (totalDiscountUsed + discount));
        const moreCharge   = remaining / DISCOUNT_RATE;
        const moreKwh      = moreCharge / PRICE_PER_KWH;
        const batteryPct   = (moreKwh / BATTERY_CAPACITY) * 100;

        const data = {
          timestamp: isoDate,
          amount: Math.round(amount),
          discount: Math.round(discount),
          remaining: Math.round(remaining),
          moreCharge: Math.floor(moreCharge),
          moreKwh: parseFloat(moreKwh.toFixed(2)),
          batteryPercent: parseFloat(batteryPct.toFixed(1))
        };

        push(ref(db, `chargingLogs/${monthKey}`), data);
        amountInput.value = "";
      };
    }

    function renderLogs(data) {
      logsTable.innerHTML = `<tr>
        <th>ë‚ ì§œ</th><th>ê¸ˆì•¡</th><th>í• ì¸</th><th>ë‚¨ì€í• ì¸í•œë„</th>
        <th>ì¶”ê°€ì¶©ì „ê°€ëŠ¥ê¸ˆì•¡</th><th>ì¶”ê°€kWh</th><th>ì¶©ì „%</th><th>ì‚­ì œ</th>
      </tr>`;

      const entries = Object.entries(data || {})
        .sort((a, b) => new Date(b[1].timestamp) - new Date(a[1].timestamp));

      entries.forEach(([key, log]) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${log.timestamp.substring(5, 10)}</td>
          <td>${Number(log.amount).toLocaleString()}</td>
          <td>${Number(log.discount).toLocaleString()}</td>
          <td>${Number(log.remaining).toLocaleString()}</td>
          <td>${Number(log.moreCharge).toLocaleString()}</td>
          <td>${log.moreKwh}</td>
          <td>${log.batteryPercent}%</td>
          <td><button data-key="${key}" class="del">ì‚­ì œ</button></td>
        `;
        logsTable.appendChild(row);
      });

      logsTable.querySelectorAll('button.del').forEach(btn => {
        btn.onclick = () => remove(ref(db, `chargingLogs/${currentMonth}/${btn.dataset.key}`));
      });
    }
  </script>
</body>
