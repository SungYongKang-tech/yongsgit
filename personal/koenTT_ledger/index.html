<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>koenTT_ledger</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  body{margin:0;background:#f5f7fb;font-family:"Pretendard","Noto Sans KR",sans-serif;}
  header{background:#fff;padding:16px;font-size:20px;font-weight:700;text-align:center;border-bottom:1px solid #eee;position:sticky;top:0;z-index:10;}
  .summary{display:flex;gap:10px;padding:10px;flex-wrap:wrap;}
  .sum-card{flex:1;min-width:120px;padding:14px;background:#fff;border-radius:10px;border:1px solid #e5e7eb;text-align:center;font-weight:700;font-size:14px;}
  .controls{padding:10px;display:flex;gap:8px;flex-wrap:wrap;}
  .controls input,.controls select{padding:10px;font-size:14px;border:1px solid #ccc;border-radius:8px;flex:1;}
  .controls button{padding:10px 14px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;}
  .btn-blue{background:#2563eb;color:#fff}.btn-green{background:#059669;color:#fff}.btn-gray{background:#6b7280;color:#fff}.btn-red{background:#dc2626;color:#fff}
  .wrap{padding:10px}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.05)}
  th,td{padding:10px 6px;text-align:center;border-bottom:1px solid #f1f5f9;font-size:14px}
  td input{width:95%;padding:6px;font-size:14px;text-align:center;border:1px solid #ddd;border-radius:6px}
  .del{background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 8px;font-size:12px}
  tfoot td{background:#f0f9ff}
</style>
</head>
<body>

<header>koenTT_ledger</header>

<!-- ìš”ì•½ -->
<div class="summary">
  <div class="sum-card">ì´ì…ê¸ˆ<br><span id="sumIn">0</span></div>
  <div class="sum-card">ì´ì¶œê¸ˆ<br><span id="sumOut">0</span></div>
  <div class="sum-card">í˜„ì¬ì”ì•¡<br><span id="sumBal">0</span></div>
</div>

<!-- ì»¨íŠ¸ë¡¤ -->
<div class="controls">
  <!-- ğŸ‘‡ ì˜¤íƒ€ ìˆ˜ì •: ì œëŒ€ë¡œ ë‹«í˜ -->
  <input type="text" id="search" placeholder="ê²€ìƒ‰: ë‚ ì§œ/ë‚´ì—­/ê¸ˆì•¡" oninput="render()">
  <select id="yearFilter" onchange="render()"><option value="">ì „ì²´ ì—°ë„</option></select>
  <select id="monthFilter" onchange="render()"><option value="">ì „ì²´ ì›”</option></select>
  <button class="btn-gray" onclick="sortByDate();render();">ì „ì²´ Sort</button>
  <button class="btn-blue" onclick="toggleHidden()">ìˆ¨ê¹€/í‘œì‹œ</button>
  <button class="btn-green" onclick="downloadExcel()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
  <button class="btn-red" onclick="deleteAll()">ì „ì²´ ì‚­ì œ</button>
</div>

<!-- ì—‘ì…€ ë¶™ì—¬ë„£ê¸° -->
<div class="controls" style="flex-direction:column">
  <textarea id="pasteArea" rows="3" placeholder="ì—‘ì…€ì—ì„œ ë³µì‚¬ â†’ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°"></textarea>
  <button class="btn-blue" onclick="pasteExcel()">ë¶™ì—¬ë„£ê¸° ì ìš©</button>
</div>

<!-- í‘œ -->
<div class="wrap">
  <table>
    <thead>
      <tr><th>ì¼ì</th><th>ë‚´ì—­</th><th>ì…ê¸ˆ</th><th>ì¶œê¸ˆ</th><th>ì”ì•¡</th><th></th></tr>
    </thead>
    <tbody id="ledger-body"></tbody>
    <tfoot>
      <tr>
        <td><input id="in-date" placeholder="ì˜ˆ: 24.12.25 / 2024-12-25"></td>
        <td><input id="in-desc" placeholder="ë‚´ì—­"></td>
        <td><input id="in-income" placeholder="ì…ê¸ˆ"></td>
        <td><input id="in-expense" placeholder="ì¶œê¸ˆ"></td>
        <td colspan="2"><button class="btn-blue" onclick="addRow()">ì¶”ê°€</button></td>
      </tr>
    </tfoot>
  </table>
</div>

<script>
/* ---------- ê³µí†µ ---------- */
let ledger = JSON.parse(localStorage.getItem("koenTT_ledger") || "[]");
let idCounter = Number(localStorage.getItem("koenTT_ledger_idCounter") || 0);
let hiddenMode = false;

const el = id => document.getElementById(id);
const safe = id => el(id) || { value:"", innerHTML:"" };
const num = v => Number(String(v??"0").replace(/,/g,"").trim())||0;
const comma = n => num(n).toLocaleString();

function save(){
  localStorage.setItem("koenTT_ledger", JSON.stringify(ledger));
  localStorage.setItem("koenTT_ledger_idCounter", String(idCounter));
}

/* ---------- ë‚ ì§œ ---------- */
function normalizeDate(s){
  if(!s) return "";
  s = String(s).trim().replace(/\.$/,""); // ë ì  ì œê±°
  let m;
  if(m = s.match(/^(\d{2})[.\-\/](\d{1,2})[.\-\/](\d{1,2})$/))
    return `20${m[1]}-${String(m[2]).padStart(2,'0')}-${String(m[3]).padStart(2,'0')}`;
  if(m = s.match(/^(\d{4})[.\-\/](\d{1,2})[.\-\/](\d{1,2})$/))
    return `${m[1]}-${String(m[2]).padStart(2,'0')}-${String(m[3]).padStart(2,'0')}`;
  if(m = s.match(/^(\d{4})(\d{2})(\d{2})$/))
    return `${m[1]}-${m[2]}-${m[3]}`;
  if(m = s.match(/^(\d{2})(\d{2})(\d{2})$/))
    return `20${m[1]}-${m[2]}-${m[3]}`;
  return s; // ìµœì†Œ ë³´ì¡´
}
function displayDate(d){
  if(!d) return "";
  const [y,m,dd]=d.split("-");
  return `${y.slice(2)}.${m}.${dd}`;
}

/* ---------- ì •ë ¬ & ì”ì•¡ ---------- */
function sortByDate(){
  ledger.sort((a,b)=>{
    if(a.date===b.date) return (a.id||0)-(b.id||0);
    return (a.date||"").localeCompare(b.date||"");
  });
}
function computeFullBalance(){
  let bal=0;
  ledger.forEach(r=>{
    bal += num(r.income) - num(r.expense);
    r.balanceFull = bal;
  });
}

/* ---------- ì¤‘ë³µ ---------- */
function isDuplicate(row){
  return ledger.some(r =>
    normalizeDate(r.date)===normalizeDate(row.date) &&
    (r.desc||"")===(row.desc||"") &&
    num(r.income)===num(row.income) &&
    num(r.expense)===num(row.expense)
  );
}

/* ---------- CRUD ---------- */
function addRow(){
  const row = {
    id: ++idCounter,
    date: normalizeDate(safe("in-date").value),
    desc: (safe("in-desc").value||"").trim(),
    income: num(safe("in-income").value),
    expense: num(safe("in-expense").value)
  };
  if(!row.desc){ alert("ë‚´ì—­ì„ ì…ë ¥í•˜ì„¸ìš”"); return; }
  if(!isDuplicate(row)) ledger.push(row);
  safe("in-date").value = safe("in-desc").value = safe("in-income").value = safe("in-expense").value = "";
  render();
}
function edit(i,field,value){
  if(field==="income"||field==="expense") ledger[i][field]=num(value);
  else if(field==="date") ledger[i].date=normalizeDate(value);
  else ledger[i][field]=value;
  render();
}
function removeRow(i){ ledger.splice(i,1); render(); }
function deleteAll(){
  if(!confirm("ì „ì²´ ëŒ€ì¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  ledger=[]; idCounter=0; save(); render();
}
function toggleHidden(){ hiddenMode=!hiddenMode; render(); }

/* ---------- ì—‘ì…€ ---------- */
function pasteExcel(){
  const text = (safe("pasteArea").value||"").trim();
  if(!text){ alert("ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤"); return; }
  text.split(/\r?\n/).forEach(line=>{
    const c=line.split(/\t/);
    if(c.length<2) return;
    const row={
      id: ++idCounter,
      date: normalizeDate(c[0]),
      desc: (c[1]||"").trim(),
      income: num(c[2]),
      expense: num(c[3])
    };
    if(!isDuplicate(row)) ledger.push(row);
  });
  safe("pasteArea").value="";
  render();
}
function downloadExcel(){
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.json_to_sheet(ledger.map(r=>({
    ì¼ì: displayDate(normalizeDate(r.date)),
    ë‚´ì—­: r.desc,
    ì…ê¸ˆ: num(r.income),
    ì¶œê¸ˆ: num(r.expense),
    ì”ì•¡: r.balanceFull??0
  })));
  XLSX.utils.book_append_sheet(wb,ws,"ledger");
  XLSX.writeFile(wb,"koenTT_ledger.xlsx");
}

/* ---------- í•„í„° ---------- */
function matchFilter(r){
  const searchEl = safe("search");
  const yearEl = safe("yearFilter");
  const monthEl = safe("monthFilter");

  const q = (searchEl.value||"").trim();
  const y = yearEl.value || "";
  const m = monthEl.value || "";

  const nd = normalizeDate(r.date); // YYYY-MM-DD
  const ndYYMM = `${nd.slice(2,4)}.${nd.slice(5,7)}`; // YY.MM
  const ndYY = nd.slice(2,4); // YY

  if(y && ndYY !== y) return false;
  if(m && `${ndYYMM}` !== m) return false;

  if(q){
    const hay = `${displayDate(nd)} ${r.desc||""} ${num(r.income)} ${num(r.expense)}`;
    if(!hay.includes(q)) return false;
  }
  return true;
}

/* ---------- ë Œë” ---------- */
function render(){
  // ê°€ë“œ: í‘œ ë³¸ì²´ê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨
  const body = el("ledger-body");
  if(!body) return;

  sortByDate();
  computeFullBalance();

  body.innerHTML="";
  let totalIn=0,totalOut=0;

  ledger.forEach((r,i)=>{
    if(!matchFilter(r)) return;
    const inc=num(r.income), exp=num(r.expense);
    totalIn+=inc; totalOut+=exp;

    body.insertAdjacentHTML("beforeend",`
      <tr>
        <td><input value="${displayDate(normalizeDate(r.date))}" onchange="edit(${i},'date',this.value)"></td>
        <td><input value="${r.desc||""}" onchange="edit(${i},'desc',this.value)"></td>
        <td><input value="${comma(inc)}" onchange="edit(${i},'income',this.value)"></td>
        <td><input value="${comma(exp)}" onchange="edit(${i},'expense',this.value)"></td>
        <td>${comma(r.balanceFull??0)}</td>
        <td><button class="del" onclick="removeRow(${i})">ì‚­ì œ</button></td>
      </tr>
    `);
  });

  safe("sumIn").innerText = comma(totalIn);
  safe("sumOut").innerText = comma(totalOut);
  safe("sumBal").innerText = comma(ledger.length ? ledger[ledger.length-1].balanceFull : 0);

  // í•„í„° ì˜µì…˜ ì¬ìƒì„±
  const years=[...new Set(ledger.map(r=>normalizeDate(r.date).slice(2,4))).values()].filter(Boolean);
  const months=[...new Set(ledger.map(r=>`${normalizeDate(r.date).slice(2,4)}.${normalizeDate(r.date).slice(5,7)}`)).values()].filter(Boolean);

  safe("yearFilter").innerHTML = `<option value="">ì „ì²´ ì—°ë„</option>` + years.map(y=>`<option value="${y}">${y}</option>`).join("");
  safe("monthFilter").innerHTML = `<option value="">ì „ì²´ ì›”</option>` + months.map(m=>`<option value="${m}">${m}</option>`).join("");

  save();
}

// ìµœì´ˆ ë Œë”
render();
</script>
</body>
</html>
