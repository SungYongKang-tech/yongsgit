<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KOEN TT Ledger - RealTime</title>

<!-- XLSX / html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- ✅ Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
:root{
  --ink:#0f172a; --muted:#64748b; --bg:#f5f7fb; --card:#fff;
  --accent:#2563eb; --ok:#16a34a; --danger:#ef4444; --gray:#6b7280;
  --border:#d0d7e2;
  --stickTop: 56px; /* JS에서 헤더높이로 갱신됨 */
}
*{ box-sizing:border-box; }
body{
  margin:0; background:var(--bg);
  font-family:"Pretendard","Noto Sans KR",system-ui,sans-serif; color:var(--ink);
  overflow-x:hidden;            /* 좌우 스크롤 방지 */
  overflow-y:auto;              /* ✅ 페이지(창) 스크롤 */
}
header{
  background:#fff; padding:16px; font-size:20px; font-weight:800; text-align:center;
  border-bottom:1px solid #e5e7eb; position:sticky; top:0; z-index:20;
}

/* SUMMARY */
.summary{
  display:flex; gap:10px; padding:12px; flex-wrap:wrap;
}
.card{
  flex:1; min-width:140px; background:#fff; padding:14px; text-align:center;
  border-radius:10px; border:1px solid #e5e7eb; box-shadow:0 2px 10px rgba(0,0,0,.03);
  font-size:14px; font-weight:700;
}

/* CONTROLS */
.controls{
  padding:10px;
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:8px;
}
.controls input,
.controls select,
.controls button{
  width:100%;
  font-size:14px;
  padding:10px;
  border-radius:8px;
}
@media (min-width: 600px){
  .controls{ grid-template-columns: repeat(7, 1fr); }
}
.blue{ background:#2563eb; color:#fff; }
.green{ background:#059669; color:#fff; }
.red{ background:#dc2626; color:#fff; }
.gray{ background:var(--gray); color:#fff; }

/* PASTE */
.paste{ padding:10px; display:flex; gap:8px; flex-direction:column; }
.paste textarea{
  width:100%; min-height:90px; border:1px solid #ccd2dd;
  border-radius:8px; padding:10px; resize:vertical;
}

/* TABLE */
.wrap{                     /* ✅ 창 스크롤이므로 overflow 제거 */
  border:1px solid var(--border);
  border-radius:10px;
  background:#fff;
  display:block;
}
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
}

/* ✅ 표 제목행을 화면 상단(헤더 바로 아래)에 고정 */
thead{
  position: sticky;
  top: var(--stickTop);
  z-index: 30;
  background:#f3f5fb;
}
thead th{
  background:#f3f5fb;
  padding:8px;
  font-size:13px;
  border-bottom:1px solid var(--border);
  text-align:center;
  white-space:nowrap;
}
/* 상단 둥근모서리 */
thead tr:first-child th:first-child{ border-top-left-radius:10px; }
thead tr:first-child th:last-child { border-top-right-radius:10px; }

tbody td, tfoot td{
  border-top:1px solid #eef2f7; border-right:1px solid var(--border);
  padding:0;
}
tbody tr:last-child td{ border-bottom:1px solid var(--border); }
tbody td:last-child, thead th:last-child, tfoot td:last-child{ border-right:none; }

.cell{
  width:100%; min-height:28px; padding:4px 6px;
  font-size:14px; outline:none; background:#fff; line-height:18px;
}
.cell:focus{ background:#eaf1ff; outline:2px solid #8db4ff; }

.dateCell{ text-align:center; white-space:nowrap; }
.descCell{ white-space:pre-wrap; word-break:break-word; }
.numCell{ text-align:right; white-space:nowrap; }

/* INPUT ROW */
tfoot td{ background:#f7fbff; }
.addInput{
  width:100%; border:none; padding:8px 6px; font-size:14px;
  background:#f7fbff;
}
.addInput:focus{ outline:2px solid #8db4ff; background:#eef6ff; }

/* MOBILE OPTIMIZE */
@media (max-width: 600px){
  thead th:nth-child(1){ width:18%; }
  thead th:nth-child(2){ width:55%; }
  thead th:nth-child(3){ width:10%; }
  thead th:nth-child(4){ width:10%; }
  thead th:nth-child(5){ width:7%; }
  .cell{ padding:4px 4px; font-size:13px; }
  .numCell{ font-size:12.5px; padding-right:3px; }
}

/* DELETE BUTTON */
.delBtnSmall{
  background:#f2f2f2; color:#555; border:1px solid #d0d0d0;
  padding:0; width:20px; height:20px; font-size:12px; line-height:20px;
  border-radius:4px; text-align:center; cursor:pointer;
}
</style>
</head>

<body>
<header>KOEN TT Ledger</header>

<!-- SUMMARY -->
<div class="summary">
  <div class="card">총입금<br><span id="sumIn">0</span></div>
  <div class="card">총출금<br><span id="sumOut">0</span></div>
  <div class="card">현재잔액<br><span id="sumBal">0</span></div>
</div>

<!-- CONTROLS -->
<div class="controls" id="controls">
  <input id="search" placeholder="검색 (내역/금액/날짜)" oninput="render()">
  <select id="yearFilter" onchange="render()"><option value="">전체 연도</option></select>
  <select id="monthFilter" onchange="render()"><option value="">전체 월</option></select>
  <button class="gray" onclick="sortByDate()">정렬(일자↑)</button>
  <button class="green" onclick="downloadExcel()">엑셀 다운로드</button>
  <button class="green" onclick="saveImage()">이미지 저장</button>
  <button class="red" onclick="deleteAll()">전체 삭제</button>
  <button class="blue" onclick="scrollToBottom()">맨 아래로</button>


  <!-- ✅ 추가: 원래 보기(초기화) -->
  <button class="gray" onclick="resetView()">원래보기</button>
</div>


<!-- PASTE -->
<div class="paste" id="pasteBox">
  <textarea id="pasteArea" placeholder="엑셀에서 복사 → 여기에 붙여넣기 (열: 일자, 내역, 입금, 출금)"></textarea>
  <button class="blue" onclick="pasteExcel()">붙여넣기 적용</button>
</div>

<!-- TABLE -->
<div class="wrap" id="wrap">
  <table id="ledgerTable">
    <thead>
      <tr>
        <th>일자</th>
        <th>내역</th>
        <th>입금</th>
        <th>출금</th>
        <th>잔액</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="ledger-body"></tbody>
    <tfoot>
      <tr>
        <td><input id="in-date" class="addInput" placeholder="(미입력 시 오늘)"></td>
        <td><input id="in-desc" class="addInput" placeholder="내역"></td>
        <td><input id="in-income" class="addInput" placeholder="0"></td>
        <td><input id="in-expense" class="addInput" placeholder="0"></td>
        <td colspan="2"><button class="blue" onclick="addRow()">추가</button></td>
      </tr>
    </tfoot>
  </table>
</div>

<script>
/* ======================
      ✅ Firebase 초기화
====================== */
firebase.initializeApp({
  apiKey: "AIzaSyBmVXt2ze1iJmmA_YI-sgH3tJmSvZomkOo",
  authDomain: "ionic6-3b7b2.firebaseapp.com",
  databaseURL: "https://ionic6-3b7b2-default-rtdb.firebaseio.com",
  projectId: "ionic6-3b7b2",
  storageBucket: "ionic6-3b7b2.appspot.com",
  messagingSenderId: "306251113324",
  appId: "1:306251113324:web:5c34044f4a7679b1c18949"
});
const db = firebase.database();

/* ======================
      ✅ GLOBAL
====================== */
let ledger = {};   // { key: {date,desc,income,expense,createdAt} }

/* ======================
      ✅ UTILS
====================== */
const el = id => document.getElementById(id);
const toNum = v => Number(String(v||0).replace(/[^\d.-]/g,""));
const comma = n => toNum(n).toLocaleString();

function normalizeDate(v){
  if(!v) return "";
  v = String(v).trim();
  if(/^\d{2}\.\d{2}\.\d{2}$/.test(v)){ // 24.12.25
    const [yy,mm,dd] = v.split(".");
    return `20${yy}-${mm}-${dd}`;
  }
  v = v.replace(/[^\d]/g,"");
  if(v.length===6) return `20${v.slice(0,2)}-${v.slice(2,4)}-${v.slice(4,6)}`;
  if(v.length===8) return `${v.slice(0,4)}-${v.slice(4,6)}-${v.slice(6,8)}`;
  if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  return "";
}
function displayDate(d){
  if(!d) return "";
  const [y,m,dd] = d.split("-");
  return `${y.slice(2)}.${m}.${dd}`;
}

/* ======================
      ✅ Sticky 상단 간격 동적 반영
====================== */
function updateStickyTop(){
  const h = document.querySelector("header")?.offsetHeight || 0;
  document.documentElement.style.setProperty('--stickTop', `${h}px`);
}
window.addEventListener('load', updateStickyTop);
window.addEventListener('resize', updateStickyTop);
window.addEventListener('orientationchange', updateStickyTop);

/* ======================
      ✅ Firebase 실시간
====================== */
db.ref("ledger").on("value", snap=>{
  ledger = snap.val() || {};
  render();
});

/* ======================
      ✅ DB helpers
====================== */
function saveToDB(key, row){ return db.ref("ledger/"+key).set(row); }
function deleteRow(key){
  if(!confirm("삭제할까요?")) return;
  db.ref("ledger/"+key).remove();
}
function deleteAll(){
  if(!confirm("전체 삭제?")) return;
  db.ref("ledger").remove();
}

/* ======================
      ✅ 추가/수정
====================== */
function addRow(){
  let date = el("in-date").value.trim();
  if(!date){
    const t = new Date();
    date = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;
  } else {
    date = normalizeDate(date);
  }
  const row = {
    date,
    desc: el("in-desc").value.trim(),
    income: toNum(el("in-income").value),
    expense: toNum(el("in-expense").value),
    createdAt: Date.now()          // 입력순 복원용
  };
  if(!row.desc){ alert("내역을 입력하세요."); return; }
  db.ref("ledger").push(row);

  el("in-date").value = "";
  el("in-desc").value = "";
  el("in-income").value = "";
  el("in-expense").value = "";
}
function saveCell(key, field, value){
  const patch = {};
  if(field==="date") patch.date = normalizeDate(value);
  else if(field==="income") patch.income = toNum(value);
  else if(field==="expense") patch.expense = toNum(value);
  else patch.desc = value;
  db.ref("ledger/"+key).update(patch);
}

/* ======================
      ✅ 정렬(화면상)
====================== */
// 정렬 모드: false = 입력순(createdAt), true = 날짜순 정렬
let sortMode = false;

// 잔액 표시를 원장(전체 데이터 기준)으로 유지
const useGlobalBalance = true;
function sortByDate(){ sortMode = true; render(true); }

/* ======================
      ✅ 렌더 + 합계
====================== */
function render(forceTop){
  // ----- 0) 전체 ledger로 "원장 기준(입력순)" 누적잔액 테이블 준비 -----
  const all = Object.entries(ledger);

  const master = all
    .slice()
    .sort((a,b)=>(a[1].createdAt||0)-(b[1].createdAt||0)); // 입력순

  // ✅ key별 전역 누적잔액 저장
  let gBal = 0;
  const globalBalByKey = {};
  master.forEach(([k,r])=>{
    gBal += toNum(r.income) - toNum(r.expense);
    globalBalByKey[k] = gBal;
  });

  // ----- 1) 화면 필터링/검색/정렬 -----
  let arr = all;

  const q = el("search").value.trim().toLowerCase();
  if(q){
    arr = arr.filter(([k,r])=>{
      return `${displayDate(r.date)} ${r.desc||""} ${r.income||0} ${r.expense||0}`
        .toLowerCase().includes(q);
    });
  }

  const y = el("yearFilter").value;
  const m = el("monthFilter").value;
  if(y) arr = arr.filter(([k,r])=> (r.date||"").startsWith(y));
  if(m) arr = arr.filter(([k,r])=> (r.date||"").startsWith(m));

  if (sortMode) {
    arr.sort((a,b)=> (a[1].date||"").localeCompare(b[1].date||""));
  } else {
    arr.sort((a,b)=> (a[1].createdAt||0)-(b[1].createdAt||0));
  }

  // ----- 2) 합계는 필터된 행 기준, 잔액은 원장 기준 -----
  let totalIn = 0, totalOut = 0;
  arr.forEach(([_,r])=>{
    totalIn  += toNum(r.income);
    totalOut += toNum(r.expense);
  });
  el("sumIn").textContent  = comma(totalIn);
  el("sumOut").textContent = comma(totalOut);

  // ✅ 현재잔액은 마지막 행의 “원장 기준” 잔액
  const lastKey = arr.length ? arr[arr.length-1][0] : null;
  el("sumBal").textContent = lastKey ? comma(globalBalByKey[lastKey]) : "0";

  // ----- 3) 행 출력 -----
  let rowsHTML = "";
  arr.forEach(([key,r])=>{
    const inc = toNum(r.income);
    const exp = toNum(r.expense);
    const showBal = globalBalByKey[key] || 0;   // ✅ 필터가 있어도 원장 기준 잔액

    rowsHTML += `
      <tr>
        <td><div class="cell dateCell" contenteditable="true"
          onblur="saveCell('${key}','date',this.innerText)">${displayDate(r.date)}</div></td>

        <td><div class="cell descCell" contenteditable="true"
          onblur="saveCell('${key}','desc',this.innerText)">${r.desc||""}</div></td>

        <td><div class="cell numCell" contenteditable="true"
          onblur="saveCell('${key}','income',this.innerText)">${comma(inc)}</div></td>

        <td><div class="cell numCell" contenteditable="true"
          onblur="saveCell('${key}','expense',this.innerText)">${comma(exp)}</div></td>

        <td><div class="cell numCell">${comma(showBal)}</div></td>

        <td style="text-align:center;">
          <button class="delBtnSmall" onclick="deleteRow('${key}')">X</button>
        </td>
      </tr>
    `;
  });
  el("ledger-body").innerHTML = rowsHTML;

  // ----- 4) 연/월 select 값 유지 -----
  const prevY = el("yearFilter").value;
  const prevM = el("monthFilter").value;

  const allVals = Object.values(ledger);
  const years  = [...new Set(allVals.map(r=>(r.date||"").slice(0,4)).filter(Boolean))].sort();
  const months = [...new Set(allVals.map(r=>(r.date||"").slice(0,7)).filter(Boolean))].sort();

  el("yearFilter").innerHTML =
    `<option value="">전체 연도</option>` +
    years.map(v=>`<option value="${v}">${v}</option>`).join("");

  el("monthFilter").innerHTML =
    `<option value="">전체 월</option>` +
    months.map(v=>`<option value="${v}">${v}</option>`).join("");

  // ✅ 선택값 복구
  if(prevY && years.includes(prevY)) el("yearFilter").value = prevY;
  if(prevM && months.includes(prevM)) el("monthFilter").value = prevM;

  if(forceTop){
    window.scrollTo({top:0, behavior:'instant'});
  }
}


/* ======================
      ✅ 엑셀 붙여넣기
====================== */
function pasteExcel(){
  const text = el("pasteArea").value.trim();
  if(!text) return alert("붙여넣을 내용이 없습니다.");
  const lines = text.split(/\r?\n/);
  const ref = db.ref("ledger");

  lines.forEach(line=>{
    const c = line.split(/\t/);
    if(c.length < 2) return;

    let date = normalizeDate(c[0] || "");
    let desc = String(c[1] || "").trim();
    let income = toNum(c[2] || 0);
    let expense = toNum(c[3] || 0);

    if(!desc) desc = "(내용 없음)";
    if(!date){
      const t = new Date();
      date = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;
    }
    ref.push({ date, desc, income, expense, createdAt: Date.now() });
  });

  el("pasteArea").value = "";
}

/* ======================
      ✅ 엑셀 다운로드
====================== */
function downloadExcel(){
  const arr = Object.entries(ledger).sort((a,b)=> (a[1].date||"").localeCompare(b[1].date||""));
  let bal = 0;
  const rows = arr.map(([k,r])=>{
    bal += toNum(r.income) - toNum(r.expense);
    return {
      일자: displayDate(r.date),
      내역: r.desc || "",
      입금: toNum(r.income),
      출금: toNum(r.expense),
      잔액: bal
    };
  });
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "ledger");
  XLSX.writeFile(wb, "ledger.xlsx");
}

/* ======================
      ✅ 이미지 저장
====================== */
function saveImage(){
  html2canvas(document.getElementById("ledgerTable"),{
    scale:2, backgroundColor:"#ffffff"
  }).then(c=>{
    const a=document.createElement("a");
    a.download="ledger.png";
    a.href=c.toDataURL();
    a.click();
  });
}

/* 초기 렌더 */
render();

function resetView(){
  sortMode = false;               // 정렬 해제
  el("search").value = "";        // 검색 초기화
  el("yearFilter").value = "";    // 연도 초기화
  el("monthFilter").value = "";   // 월 초기화
  render(true);
}
function scrollToBottom(){
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

</script>
</body>
</html>
