<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>koenTT_ledger</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  body{margin:0;background:#f5f7fb;font-family:"Pretendard","Noto Sans KR",sans-serif}
  header{background:#fff;padding:16px;font-size:20px;font-weight:700;text-align:center;border-bottom:1px solid #e5e7eb}

  .box{padding:12px;background:#fff;border-bottom:1px solid #e5e7eb;display:flex;flex-direction:column;gap:8px}
  input,textarea{width:100%;padding:12px;font-size:15px;border:1px solid #d1d5db;border-radius:8px}
  button{padding:12px;border:none;border-radius:8px;font-size:16px;font-weight:600}
  .btn-primary{background:#2563eb;color:#fff}
  .btn-green{background:#059669;color:#fff}

  .wrap{padding:12px}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,.06)}
  th,td{padding:10px 6px;text-align:center;font-size:14px;border-bottom:1px solid #f1f5f9}
  td input{width:90%;padding:6px;text-align:center;font-size:14px}

  .del{background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 8px;font-size:12px}

  .sum{display:flex;gap:8px;flex-wrap:wrap}
  .sum > div{flex:1;min-width:140px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;font-weight:700;text-align:center}
</style>
</head>

<body>
<header>koenTT_ledger</header>

<!-- ✅ 통계/초기잔액 -->
<div class="box">
  <div class="sum">
    <div>초기잔액 <input id="opening" type="text" value="0" oninput="render()"></div>
    <div>총입금 <span id="sumIn">0</span></div>
    <div>총출금 <span id="sumOut">0</span></div>
    <div>현재잔액 <span id="sumBal">0</span></div>
  </div>
</div>

<!-- ✅ 엑셀 붙여넣기 -->
<div class="box">
  <textarea id="pasteArea" rows="3" placeholder="엑셀에서 복사한 내용을 여기에 붙여넣기"></textarea>
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button class="btn-primary" onclick="pasteExcel()">붙여넣기 적용</button>
    <button class="btn-green" onclick="downloadExcel()">엑셀로 저장</button>
  </div>
</div>

<!-- ✅ 직접 입력 -->
<div class="box">
  <input type="text" id="descInput" placeholder="내역">
  <div style="display:flex;gap:8px">
    <input type="text" id="incomeInput" placeholder="입금">
    <input type="text" id="expenseInput" placeholder="출금">
  </div>
  <button class="btn-primary" onclick="addRow()">추가하기(오늘 날짜)</button>
</div>

<div class="wrap">
  <table>
    <thead>
      <tr><th>일자</th><th>내역</th><th>입금</th><th>출금</th><th>잔액</th><th></th></tr>
    </thead>
    <tbody id="ledger-body"></tbody>
  </table>
</div>

<script>
  let ledger = JSON.parse(localStorage.getItem("koenTT_ledger") || "[]");

  const el = id => document.getElementById(id);

  // ✅ 숫자 추출용 (콤마 제거 → 숫자)
  function toNum(v){
    return Number(String(v ?? 0).replace(/,/g,'').trim() || 0);
  }

  // ✅ 화면 표시용 (천단위 콤마)
  function comma(n){
    return toNum(n).toLocaleString();
  }

  function save(){
    localStorage.setItem("koenTT_ledger", JSON.stringify(ledger));
  }

  function today(){
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  // ✅ "14.07.25" → "2014-07-25"
  function normalizeDate(s){
    if(!s) return today();
    s = s.trim();
    const dot = /^(\d{2})\.(\d{2})\.(\d{2})$/;
    if(dot.test(s)){
      const [,yy,mm,dd] = s.match(dot);
      return `20${yy}-${mm}-${dd}`;
    }
    return s;
  }

  function addRow(){
    let desc = el("descInput").value.trim();
    if(!desc){ alert("내역을 입력하세요."); return; }

    let income = toNum(el("incomeInput").value);
    let expense = toNum(el("expenseInput").value);

    ledger.push({ date: today(), desc, income, expense });

    el("descInput").value="";
    el("incomeInput").value="";
    el("expenseInput").value="";
    render();
  }

  function edit(index, field, value){
    if(field === 'income' || field === 'expense'){
      ledger[index][field] = toNum(value);
    } 
    else if(field === 'date'){
      ledger[index].date = normalizeDate(value);
    }
    else {
      ledger[index][field] = value;
    }
    render();
  }

  function removeRow(i){
    ledger.splice(i,1);
    render();
  }

  function sortByDate(){
    ledger.sort((a,b)=> (a.date||'').localeCompare(b.date||''));
  }

  function render(){
    sortByDate();

    let opening = toNum(el("opening").value);
    let body = el("ledger-body");

    body.innerHTML = "";
    let balance = opening;
    let totalIn = 0, totalOut = 0;

    ledger.forEach((r,i)=>{
      const inc = toNum(r.income);
      const exp = toNum(r.expense);

      totalIn += inc;
      totalOut += exp;

      balance += inc - exp;
      r.balance = balance;

      body.insertAdjacentHTML("beforeend", `
        <tr>
          <td><input type="text" value="${normalizeDate(r.date)}" onchange="edit(${i},'date',this.value)"></td>
          <td><input type="text" value="${r.desc}" onchange="edit(${i},'desc',this.value)"></td>
          <td><input type="text" value="${comma(inc)}" onchange="edit(${i},'income',this.value)"></td>
          <td><input type="text" value="${comma(exp)}" onchange="edit(${i},'expense',this.value)"></td>
          <td>${comma(balance)}</td>
          <td><button class="del" onclick="removeRow(${i})">삭제</button></td>
        </tr>
      `);
    });

    el("sumIn").textContent = comma(totalIn);
    el("sumOut").textContent = comma(totalOut);
    el("sumBal").textContent = comma(balance);

    save();
  }

  // ✅ 엑셀 붙여넣기
  function pasteExcel(){
    const text = el("pasteArea").value.trim();
    if(!text){ alert("내용이 비어 있습니다."); return; }

    const rows = text.split(/\r?\n/);

    rows.forEach(line=>{
      const cols = line.split(/\t/);
      if(cols.length < 2) return;

      const d = normalizeDate(cols[0]);
      const desc = (cols[1] || "").trim();
      const inc = toNum(cols[2] || 0);
      const exp = toNum(cols[3] || 0);

      ledger.push({ date:d, desc, income:inc, expense:exp });
    });

    el("pasteArea").value = "";
    render();
  }

  // ✅ 엑셀 다운로드
  function downloadExcel(){
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(
      ledger.map(r=>({
        일자: r.date,
        내역: r.desc,
        입금: toNum(r.income),
        출금: toNum(r.expense),
        잔액: toNum(r.balance)
      }))
    );
    XLSX.utils.book_append_sheet(wb, ws, "ledger");
    XLSX.writeFile(wb, "koenTT_ledger.xlsx");
  }

  render();
</script>

</body>
</html>
