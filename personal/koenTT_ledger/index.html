<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>koenTT_ledger</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  body{margin:0;background:#f5f7fb;font-family:"Pretendard","Noto Sans KR",sans-serif;}
  header{background:white;padding:16px;font-size:20px;font-weight:700;text-align:center;border-bottom:1px solid #eee;position:sticky;top:0;z-index:10;}

  .summary{display:flex;gap:10px;padding:10px;flex-wrap:wrap;}
  .sum-card{flex:1;min-width:120px;padding:14px;background:white;border-radius:10px;border:1px solid #e5e7eb;text-align:center;font-weight:700;font-size:14px;}

  .controls{padding:10px;display:flex;gap:8px;flex-wrap:wrap;}
  .controls input,.controls select{padding:10px;font-size:14px;border:1px solid #ccc;border-radius:8px;flex:1;}
  .controls button{padding:10px 14px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;}
  .btn-blue{background:#2563eb;color:white;}
  .btn-green{background:#059669;color:white;}
  .btn-gray{background:#6b7280;color:white;}
  .btn-red{background:#dc2626;color:white;}

  .wrap{padding:10px;}
  table{width:100%;border-collapse:collapse;background:white;border-radius:12px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,0.05);}
  th,td{padding:10px 6px;text-align:center;border-bottom:1px solid #f1f5f9;font-size:14px;}
  td input{width:90%;padding:6px;font-size:14px;text-align:center;border:1px solid #ddd;border-radius:6px;}
  .del{background:#ef4444;color:white;border:none;border-radius:6px;padding:6px 8px;font-size:12px;}
  tfoot td{background:#f0f9ff;}
</style>
</head>

<body>

<header>koenTT_ledger</header>

<!-- ✅ 상단 요약 -->
<div class="summary">
  <div class="sum-card">총입금<br><span id="sumIn">0</span></div>
  <div class="sum-card">총출금<br><span id="sumOut">0</span></div>
  <div class="sum-card">현재잔액<br><span id="sumBal">0</span></div>
</div>

<!-- ✅ 기능 버튼 -->
<div class="controls">
  <input type="text" id="search" placeholder="검색: 날짜/내역/금액" oninput="render()"""

  <select id="yearFilter" onchange="render()">
    <option value="">전체 연도</option>
  </select>

  <select id="monthFilter" onchange="render()">
    <option value="">전체 월</option>
  </select>

  <button class="btn-gray" onclick="sortByDate();render();">전체 Sort</button>
  <button class="btn-blue" onclick="toggleHidden()">숨김/표시</button>
  <button class="btn-green" onclick="downloadExcel()">엑셀 다운로드</button>
  <button class="btn-red" onclick="deleteAll()">전체 삭제</button>
</div>

<!-- ✅ 엑셀 붙여넣기 -->
<div class="controls" style="flex-direction:column">
  <textarea id="pasteArea" rows="3" placeholder="엑셀에서 복사 → 여기에 붙여넣기"></textarea>
  <button class="btn-blue" onclick="pasteExcel()">붙여넣기 적용</button>
</div>

<!-- ✅ 테이블 -->
<div class="wrap">
  <table>
    <thead>
      <tr>
        <th>일자</th><th>내역</th><th>입금</th><th>출금</th><th>잔액</th><th></th>
      </tr>
    </thead>
    <tbody id="ledger-body"></tbody>

    <!-- ✅ 입력줄 -->
    <tfoot>
      <tr>
        <td><input id="in-date" placeholder="예: 24.12.25"></td>
        <td><input id="in-desc" placeholder="내역"></td>
        <td><input id="in-income" placeholder="입금"></td>
        <td><input id="in-expense" placeholder="출금"></td>
        <td colspan="2"><button class="btn-blue" onclick="addRow()">추가</button></td>
      </tr>
    </tfoot>
  </table>
</div>

<script>

let ledger = JSON.parse(localStorage.getItem("koenTT_ledger") || "[]");
let hiddenMode = false;

const el = id => document.getElementById(id);

/* ✅ 금액 파싱 */
const cleanMoney = v => Number(String(v ?? "0").replace(/,/g,"").trim() || 0);
const comma = n => cleanMoney(n).toLocaleString();

/* ✅ 저장 */
function save(){ localStorage.setItem("koenTT_ledger", JSON.stringify(ledger)); }

/* ✅ 날짜 정규화 → YY.MM.DD 통일 */
function normalizeDate(s){
  if(!s) return "";

  s = s.replace(/\./g,".").trim();
  s = s.replace(/\.$/, "");   // 끝에 점(.) 제거

  // 24.12.25
  const d1 = /^(\d{2})\.(\d{2})\.(\d{2})$/;
  // 2024.12.25
  const d2 = /^(\d{4})\.(\d{2})\.(\d{2})$/;
  // 24-12-25
  const d3 = /^(\d{2})-(\d{2})-(\d{2})$/;
  // 2024-12-25
  const d4 = /^(\d{4})-(\d{2})-(\d{2})$/;

  let yy, mm, dd;

  if(d1.test(s)){
    [,yy,mm,dd] = s.match(d1);
  } else if(d2.test(s)){
    const [,yyyy,MM,DD] = s.match(d2);
    yy = yyyy.slice(2);
    mm = MM; dd = DD;
  } else if(d3.test(s)){
    [,yy,mm,dd] = s.match(d3);
  } else if(d4.test(s)){
    const [,yyyy,MM,DD] = s.match(d4);
    yy = yyyy.slice(2);
    mm = MM; dd = DD;
  } else {
    return "";
  }

  return `${yy}.${mm}.${dd}`;
}

/* ✅ 날짜 기반 정렬 (YY.MM.DD → 정렬 가능) */
function sortByDate(){
  ledger.sort((a,b)=>
    normalizeDate(a.date).localeCompare(normalizeDate(b.date))
  );
}

/* ✅ 전체 누적 잔액 계산 */
function computeFullBalance(){
  let bal = 0;
  ledger.forEach(r=>{
    bal += cleanMoney(r.income) - cleanMoney(r.expense);
    r.balanceFull = bal;
  });
}

/* ✅ 중복 체크 (엑셀 붙여넣기 대비) */
function isDuplicate(row){
  return ledger.some(r =>
    normalizeDate(r.date) === normalizeDate(row.date) &&
    r.desc === row.desc &&
    cleanMoney(r.income) === cleanMoney(row.income) &&
    cleanMoney(r.expense) === cleanMoney(row.expense)
  );
}

/* ✅ 행 추가 */
function addRow(){
  const d = normalizeDate(el("in-date").value);
  const desc = el("in-desc").value.trim();
  const income = cleanMoney(el("in-income").value);
  const expense = cleanMoney(el("in-expense").value);

  if(!desc){ alert("내역을 입력하세요"); return; }

  const row = {date:d, desc, income, expense};
  if(!isDuplicate(row)) ledger.push(row);

  el("in-date").value = el("in-desc").value = el("in-income").value = el("in-expense").value = "";
  render();
}

/* ✅ 수정 */
function edit(i,field,value){
  if(field==="income" || field==="expense") ledger[i][field] = cleanMoney(value);
  else if(field==="date") ledger[i].date = normalizeDate(value);
  else ledger[i][field]=value;

  render();
}

/* ✅ 삭제 */
function removeRow(i){ ledger.splice(i,1); render(); }

/* ✅ 전체 삭제 */
function deleteAll(){
  if(!confirm("전체 대장을 삭제하시겠습니까?")) return;
  ledger = [];
  save();
  render();
}

/* ✅ 숨김/표시 */
function toggleHidden(){ hiddenMode=!hiddenMode; render(); }

/* ✅ 엑셀 붙여넣기 */
function pasteExcel(){
  const text = el("pasteArea").value.trim();
  if(!text){ alert("내용이 없습니다"); return; }

  const lines = text.split(/\r?\n/);

  lines.forEach(line=>{
    const c = line.split(/\t/);
    if(c.length < 2) return;

    const row = {
      date: normalizeDate(c[0]),
      desc: c[1].trim(),
      income: cleanMoney(c[2]),
      expense: cleanMoney(c[3])
    };

    if(!isDuplicate(row)) ledger.push(row);
  });

  el("pasteArea").value="";
  render();
}

/* ✅ 엑셀 다운로드 */
function downloadExcel(){
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(
    ledger.map(r=>({
      일자: normalizeDate(r.date),
      내역: r.desc,
      입금: cleanMoney(r.income),
      출금: cleanMoney(r.expense),
      잔액: cleanMoney(r.balanceFull)
    }))
  );
  XLSX.utils.book_append_sheet(wb,ws,"ledger");
  XLSX.writeFile(wb,"koenTT_ledger.xlsx");
}

/* ✅ 검색 + 필터 */
function matchFilter(r){
  const q = el("search").value.trim();
  const y = el("yearFilter").value;
  const m = el("monthFilter").value;

  const nd = normalizeDate(r.date);
  const ym = nd.slice(0,5); // YY.MM

  if(y && !nd.startsWith(y)) return false;
  if(m && !nd.startsWith(m)) return false;

  if(q){
    if(!(nd+" "+r.desc+" "+r.income+" "+r.expense).includes(q)) return false;
  }

  return true;
}

/* ✅ 렌더링 */
function render(){
  sortByDate();
  computeFullBalance();

  let body = el("ledger-body");
  body.innerHTML = "";

  let totalIn=0, totalOut=0;

  ledger.forEach((r,i)=>{
    if(!matchFilter(r)) return;

    const inc = cleanMoney(r.income);
    const exp = cleanMoney(r.expense);

    totalIn += inc;
    totalOut += exp;

    body.insertAdjacentHTML("beforeend",`
      <tr>
        <td><input value="${normalizeDate(r.date)}" onchange="edit(${i},'date',this.value)"></td>
        <td><input value="${r.desc}" onchange="edit(${i},'desc',this.value)"></td>
        <td><input value="${comma(inc)}" onchange="edit(${i},'income',this.value)"></td>
        <td><input value="${comma(exp)}" onchange="edit(${i},'expense',this.value)"></td>
        <td>${comma(r.balanceFull ?? 0)}</td>
        <td><button class="del" onclick="removeRow(${i})">삭제</button></td>
      </tr>
    `);
  });

  el("sumIn").textContent = comma(totalIn);
  el("sumOut").textContent = comma(totalOut);
  el("sumBal").textContent = comma(ledger.length ? ledger[ledger.length-1].balanceFull : 0);

  // ✅ 연도 필터 생성 (YY만 뽑기)
  const years = [...new Set(ledger.map(r => normalizeDate(r.date).slice(0,2)))];
  el("yearFilter").innerHTML =
    `<option value="">전체 연도</option>` +
    years.map(y=>`<option value="${y}">${y}</option>`).join("");

  // ✅ 월 필터 생성 (YY.MM)
  const months = [...new Set(ledger.map(r => normalizeDate(r.date).slice(0,5)))];
  el("monthFilter").innerHTML =
    `<option value="">전체 월</option>` +
    months.map(m=>`<option value="${m}">${m}</option>`).join("");

  save();
}

render();
</script>

</body>
</html>
