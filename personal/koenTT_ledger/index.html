<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Simple Ledger</title>

<!-- XLSX / html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  body{
    margin:0; background:#f5f7fb;
    font-family:"Pretendard","Noto Sans KR",sans-serif;
  }
  header{
    background:white; padding:16px; font-size:22px;
    font-weight:700; text-align:center;
    border-bottom:1px solid #ddd;
    position:sticky; top:0; z-index:10;
  }

  /* ✅ 요약 카드 */
  .summary{ display:flex; gap:10px; padding:12px; flex-wrap:wrap; }
  .card{
    flex:1; min-width:130px;
    background:white; padding:16px; text-align:center;
    border-radius:10px; border:1px solid #e5e7eb;
    font-size:14px; font-weight:700;
  }

  /* ✅ 입력 & 버튼 UI */
  .controls{
    padding:10px; display:flex; flex-wrap:wrap; gap:8px;
  }
  .controls input,.controls select{
    padding:10px; font-size:14px; border:1px solid #ccc; border-radius:6px;
  }
  .controls button{
    padding:10px 14px; border:none; border-radius:6px;
    font-size:14px; font-weight:600; cursor:pointer;
  }
  .blue{ background:#2563eb; color:white; }
  .green{ background:#059669; color:white; }
  .red{ background:#dc2626; color:white; }
  .gray{ background:#6b7280; color:white; }

  /* ✅ 테이블 */
  .wrap{ padding:10px; }
  table{
    width:100%; border-collapse:collapse; background:white;
    border-radius:10px; overflow:hidden;
    box-shadow:0 2px 10px rgba(0,0,0,.05);
  }
  th{
    background:#f0f0f8; padding:10px; font-size:13px;
    border-bottom:1px solid #e5e7eb;
  }
  td{
    padding:6px; border-bottom:1px solid #f1f5f9;
    vertical-align:top;
  }

  /* ✅ 입력칸 */
  .dateBox, .moneyBox{
    width:95%; text-align:center;
    padding:6px; font-size:13px;
    border:1px solid #ddd; border-radius:6px;
  }

  /* ✅ 내역 textarea : 자동 줄바꿈 + 자동 높이 */
  .descBox{
    width:98%;
    padding:3px 6px;
    font-size:13px;
    border:1px solid #ddd;
    border-radius:6px;
    resize:none;
    overflow:hidden;
    line-height:18px;
    height:18px;
    min-height:18px;
    box-sizing:border-box;
  }

  /* ✅ footer 입력줄 */
  tfoot td{ background:#eef6ff; }

  .delBtn{
    background:#ef4444; color:white;
    padding:6px 8px; border:none; border-radius:6px;
    font-size:12px;
  }

  /* ✅ ✅ 모바일 최적화 */
  @media(max-width: 600px){

    /* 날짜칸 최소 */
    #ledgerTable th:nth-child(1),
    #ledgerTable td:nth-child(1){
      width:15%;
      font-size:12px;
    }

    /* ✅ 내역칸 55% 가장 넓게 */
    #ledgerTable th:nth-child(2),
    #ledgerTable td:nth-child(2){
      width:55%;
    }

    /* 금액칸 좁게 */
    #ledgerTable th:nth-child(3),
    #ledgerTable td:nth-child(3),
    #ledgerTable th:nth-child(4),
    #ledgerTable td:nth-child(4),
    #ledgerTable th:nth-child(5),
    #ledgerTable td:nth-child(5){
      width:10%;
      font-size:12px;
    }

    /* ✅ textarea 모바일 최적화 */
    .descBox{
      width:100%;
      font-size:13px;
      padding:3px 4px;
      line-height:18px;
    }

    /* 숫자칸 작게 */
    .dateBox, .moneyBox{
      font-size:12px;
      padding:4px;
    }

    .delBtn, .del{
      font-size:11px;
      padding:4px 6px;
    }
  }

  html, body {
  overflow-x: hidden;   /* ✅ 가로 스크롤 완전 차단 */
}

/* ✅ 테이블이 화면을 절대 넘지 않도록 */
table {
  width: 100%;
  max-width: 100%;
  table-layout: fixed;   /* ✅ 칸폭 자동으로 강제 */
}

/* ✅ 모바일에서 열 폭 강제 조절 */
@media(max-width: 600px){

  #ledgerTable th:nth-child(1),
  #ledgerTable td:nth-child(1){
    width:15%;
  }

  #ledgerTable th:nth-child(2),
  #ledgerTable td:nth-child(2){
    width:55%;
    word-break:break-word;   /* ✅ 텍스트 줄바꿈 강제 */
  }

  #ledgerTable th:nth-child(3),
  #ledgerTable td:nth-child(3),
  #ledgerTable th:nth-child(4),
  #ledgerTable td:nth-child(4),
  #ledgerTable th:nth-child(5),
  #ledgerTable td:nth-child(5){
    width:10%;
  }

  #ledgerTable th:nth-child(6),
  #ledgerTable td:nth-child(6){
    width:10%;
  }
}

</style>
</head>

<body>

<header>Simple Ledger</header>

<!-- ✅ 요약 카드 -->
<div class="summary">
  <div class="card">총입금<br><span id="sumIn">0</span></div>
  <div class="card">총출금<br><span id="sumOut">0</span></div>
  <div class="card">현재잔액<br><span id="sumBal">0</span></div>
</div>

<!-- ✅ 검색/필터/버튼 -->
<div class="controls">
  <input id="search" placeholder="검색" oninput="render()">
  <select id="yearFilter" onchange="render()"><option value="">전체 연도</option></select>
  <select id="monthFilter" onchange="render()"><option value="">전체 월</option></select>

  <button class="gray" onclick="sortByDate(); render();">Sort</button>
  <button class="green" onclick="downloadExcel()">엑셀 다운로드</button>
  <button class="green" onclick="saveImage()">이미지 저장</button>
  <button class="red" onclick="deleteAll()">전체 삭제</button>
</div>

<!-- ✅ 엑셀 붙여넣기 -->
<div class="controls" style="flex-direction:column;">
  <textarea id="pasteArea" rows="3" placeholder="엑셀 복사 → 여기에 붙여넣기"></textarea>
  <button class="blue" onclick="pasteExcel()">붙여넣기 적용</button>
</div>

<!-- ✅ 테이블 -->
<div class="wrap">
  <table id="ledgerTable">
    <thead>
      <tr>
        <th>일자</th>
        <th>내역(줄바꿈)</th>
        <th>입금</th>
        <th>출금</th>
        <th>잔액</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="ledger-body"></tbody>

    <!-- ✅ 입력줄 -->
    <tfoot>
      <tr>
        <td><input id="in-date" class="dateBox" placeholder="24.12.25"></td>
        <td><textarea id="in-desc" class="descBox" placeholder="내역"></textarea></td>
        <td><input id="in-income" class="moneyBox" placeholder="입금"></td>
        <td><input id="in-expense" class="moneyBox" placeholder="출금"></td>
        <td colspan="2"><button class="blue" onclick="addRow()">추가</button></td>
      </tr>
    </tfoot>
  </table>
</div>

<script>
/* ------------------------------
        ✅ 기본 함수
------------------------------ */

let ledger = JSON.parse(localStorage.getItem("simpleLedger") || "[]");

const el = id => document.getElementById(id);
const toNum = v => Number(String(v||0).replace(/,/g,"").trim());
const comma = n => toNum(n).toLocaleString();

/* ✅ textarea 자동 높이조절 */
function autoResize(el){
  const min = parseFloat(getComputedStyle(el).lineHeight);
  el.style.height = min + "px";
  el.style.height = el.scrollHeight + "px";
}

/* ✅ 날짜 정규화 */
function normalizeDate(raw){
  if(!raw) return "";
  raw = raw.replace(/[^\d]/g,"");
  if(raw.length===6){
    return `20${raw.slice(0,2)}-${raw.slice(2,4)}-${raw.slice(4,6)}`;
  }
  if(raw.length===8){
    return `${raw.slice(0,4)}-${raw.slice(4,6)}-${raw.slice(6,8)}`;
  }
  return "";
}

/* ✅ 날짜 표시: YY.MM.DD */
function displayDate(date){
  if(!date) return "";
  const [y,m,d] = date.split("-");
  return `${y.slice(2)}.${m}.${d}`;
}

/* ✅ SORT */
function sortByDate(){
  ledger.sort((a,b)=>a.date.localeCompare(b.date));
}

/* ✅ 누적잔액 */
function computeBalance(){
  let bal = 0;
  ledger.forEach(r=>{
    bal += toNum(r.income) - toNum(r.expense);
    r.balance = bal;
  });
}

/* ✅ 중복 방지 */
function isDuplicate(r){
  return ledger.some(v =>
    v.date===r.date &&
    v.desc===r.desc &&
    toNum(v.income)===toNum(r.income) &&
    toNum(v.expense)===toNum(r.expense)
  );
}

/* ✅ 행 추가 */
function addRow(){
  const row = {
    date: normalizeDate(el("in-date").value),
    desc: el("in-desc").value.trim(),
    income: toNum(el("in-income").value),
    expense: toNum(el("in-expense").value)
  };
  if(!row.desc){
    alert("내역을 입력하세요.");
    return;
  }

  if(!isDuplicate(row)) ledger.push(row);

  el("in-date").value = "";
  el("in-desc").value = "";
  el("in-income").value = "";
  el("in-expense").value = "";

  render();
}

/* ✅ 수정 */
function edit(i, field, value){
  if(field==="date") ledger[i].date = normalizeDate(value);
  else if(field==="desc") ledger[i].desc = value;
  else ledger[i][field] = toNum(value);
  render();
}

/* ✅ 삭제 */
function removeRow(i){
  ledger.splice(i,1);
  render();
}

/* ✅ 전체 삭제 */
function deleteAll(){
  if(confirm("전체 삭제?")){
    ledger = [];
    save();
    render();
  }
}

/* ✅ 엑셀 붙여넣기 */
function pasteExcel(){
  const text = el("pasteArea").value.trim();
  if(!text){ alert("내용 없음"); return; }

  const lines = text.split(/\r?\n/);

  lines.forEach(line=>{
    const c = line.split(/\t/);
    if(c.length < 2) return;

    const row = {
      date: normalizeDate(c[0]),
      desc: c[1].trim(),
      income: toNum(c[2]),
      expense: toNum(c[3])
    };

    if(!isDuplicate(row)) ledger.push(row);
  });

  el("pasteArea").value = "";
  render();
}

/* ✅ 엑셀 다운로드 */
function downloadExcel(){
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(
    ledger.map(r=>({
      일자: displayDate(r.date),
      내역: r.desc,
      입금: r.income,
      출금: r.expense,
      잔액: r.balance
    }))
  );
  XLSX.utils.book_append_sheet(wb,ws,"ledger");
  XLSX.writeFile(wb,"ledger.xlsx");
}

/* ✅ 이미지 저장 */
function saveImage(){
  const table = document.getElementById("ledgerTable");
  html2canvas(table, {
    scale:2,
    scrollY: -window.scrollY,
    backgroundColor:"#ffffff"
  }).then(canvas=>{
    const link = document.createElement("a");
    link.download = "ledger.png";
    link.href = canvas.toDataURL();
    link.click();
  });
}

/* ✅ 검색/필터 */
function matchFilter(r){
  const q = el("search").value.trim().toLowerCase();
  const y = el("yearFilter").value;
  const m = el("monthFilter").value;

  if(y && !r.date.startsWith(y)) return false;
  if(m && !r.date.startsWith(m)) return false;

  if(q){
    const t = `${r.date} ${r.desc} ${r.income} ${r.expense}`.toLowerCase();
    if(!t.includes(q)) return false;
  }
  return true;
}

/* ✅ 렌더링 */
function render(){
  sortByDate();
  computeBalance();

  const body = el("ledger-body");
  body.innerHTML = "";

  let totalIn = 0, totalOut = 0;

  ledger.forEach((r,i)=>{
    if(!matchFilter(r)) return;

    const inc = toNum(r.income);
    const exp = toNum(r.expense);
    totalIn += inc;
    totalOut += exp;

    body.insertAdjacentHTML("beforeend", `
      <tr>
        <td><input class="dateBox" value="${displayDate(r.date)}"
              onchange="edit(${i},'date',this.value)"></td>

        <td>
          <textarea class="descBox"
            oninput="autoResize(this); edit(${i},'desc',this.value)">${r.desc}</textarea>
        </td>

        <td><input class="moneyBox" value="${comma(inc)}"
              onchange="edit(${i},'income',this.value)"></td>

        <td><input class="moneyBox" value="${comma(exp)}"
              onchange="edit(${i},'expense',this.value)"></td>

        <td>${comma(r.balance)}</td>
        <td><button class="delBtn" onclick="removeRow(${i})">삭제</button></td>
      </tr>
    `);
  });

  /* ✅ textarea 자동 높이 조절 */
  setTimeout(()=>{
    document.querySelectorAll(".descBox").forEach(t=>autoResize(t));
  }, 0);

  /* ✅ 합계 */
  el("sumIn").textContent  = comma(totalIn);
  el("sumOut").textContent = comma(totalOut);
  el("sumBal").textContent = comma(
    ledger.length ? ledger[ledger.length-1].balance : 0
  );

  /* ✅ 연/월 필터 */
  const years  = [...new Set(ledger.map(r=>r.date.slice(0,4)))];
  const months = [...new Set(ledger.map(r=>r.date.slice(0,7)))];

  el("yearFilter").innerHTML =
    `<option value="">전체 연도</option>` +
    years.map(y=>`<option value="${y}">${y}</option>`).join("");

  el("monthFilter").innerHTML =
    `<option value="">전체 월</option>` +
    months.map(m=>`<option value="${m}">${m}</option>`).join("");

  save();
}

/* ✅ 저장 */
function save(){
  localStorage.setItem("simpleLedger", JSON.stringify(ledger));
}

/* 첫 실행 */
render();
</script>

</body>
</html>
