<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KOEN 회계장부 · Simple</title>

<!-- XLSX / html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  :root{
    --ink:#111827; --muted:#6b7280; --bg:#f7f7fb; --card:#fff;
    --line:#e5e7eb; --accent:#2563eb; --danger:#ef4444; --ok:#059669;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);
       font-family:"Pretendard","Noto Sans KR",system-ui,sans-serif}

  header{
    position:sticky;top:0;z-index:10;background:#fff;
    border-bottom:1px solid var(--line);
    padding:12px 14px;font-weight:800;text-align:center
  }

  .toolbar{
    display:flex;flex-wrap:wrap;gap:8px;align-items:center;
    padding:10px 12px;
  }

  .toolbar input,.toolbar select{
    padding:10px 12px;border:1px solid var(--line);
    border-radius:8px;background:#fff;min-width:140px;font-size:14px
  }

  .btn{
    padding:10px 14px;border:1px solid var(--line);border-radius:8px;
    background:#fff;font-weight:700;cursor:pointer
  }
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn.ok{background:var(--ok);color:#fff;border-color:var(--ok)}
  .btn.danger{background:var(--danger);color:#fff;border-color:var(--danger)}

  .sum{
    display:flex;gap:8px;flex-wrap:wrap;padding:10px 12px
  }
  .sum .card{
    background:#fff;border:1px solid var(--line);border-radius:10px;
    min-width:160px;padding:10px 12px;font-weight:800
  }

  /* ✅ 테이블 스타일 */
  .grid{padding:10px 12px}
  table{
    width:100%;border-collapse:collapse;background:#fff;
    border:1px solid var(--line);
    table-layout:fixed; /* ✅ 칼럼 비율 고정 */
  }
  th,td{
    border-bottom:1px solid var(--line);
    padding:10px 6px;font-size:14px;text-align:center;
    vertical-align:middle;
  }
  thead th{background:#fafafa;font-weight:800}

  /* ✅ 새로운 칼럼 비율 (내역 넓게) */
  th:nth-child(1), td:nth-child(1){ width:13%; } /* 날짜 */
  th:nth-child(2), td:nth-child(2){ width:43%; } /* 내역 (가장 넓게) */
  th:nth-child(3), td:nth-child(3){ width:12%; } /* 입금 */
  th:nth-child(4), td:nth-child(4){ width:12%; } /* 출금 */
  th:nth-child(5), td:nth-child(5){ width:15%; } /* 잔액 */
  th:nth-child(6), td:nth-child(6){ width:5%; }  /* 버튼 */

  /* ✅ 셀 줄바꿈 가능 */
  td{
    white-space:normal;
    word-break:break-all;
    line-height:1.35;
  }

  /* ✅ 입력창 확장 */
  td input{
    width:100%;padding:6px 8px;border:1px solid var(--line);border-radius:6px;
    font-size:14px;text-align:center;
    white-space:normal;word-break:break-all;
  }

  .right{text-align:right}
  .muted{color:var(--muted);font-weight:600}
  .del{
    padding:6px 9px;border:none;border-radius:6px;background:var(--danger);
    color:#fff;cursor:pointer
  }

</style>
</head>
<body>

<header>KOEN 회계장부 · Simple</header>

<!-- ✅ 상단 합계 -->
<div class="sum">
  <div class="card">총입금<br><span id="sumIn" class="right">0</span></div>
  <div class="card">총출금<br><span id="sumOut" class="right">0</span></div>
  <div class="card">현재잔액<br><span id="sumBal" class="right">0</span></div>
</div>

<!-- ✅ 도구 -->
<div class="toolbar">
  <input id="search" placeholder="검색" oninput="render()" />
  <select id="yearFilter" onchange="render()"><option value="">연도 전체</option></select>
  <select id="monthFilter" onchange="render()"><option value="">월 전체</option></select>

  <button class="btn" onclick="downloadExcel(false)">엑셀(현재)</button>
  <button class="btn" onclick="downloadExcel(true)">엑셀(전체)</button>

  <button class="btn ok" onclick="saveImage()">이미지 저장</button>

  <button class="btn danger" onclick="deleteAll()">전체 삭제</button>
</div>

<!-- ✅ 붙여넣기 -->
<div class="toolbar" style="flex-direction:column;align-items:stretch">
  <textarea id="pasteArea" rows="3"
    style="padding:10px;border:1px solid var(--line);border-radius:8px"
    placeholder="엑셀 붙여넣기 (5열 사용)"></textarea>

  <button class="btn primary" onclick="pasteExcel()">붙여넣기 적용</button>
</div>

<!-- ✅ 테이블 -->
<div class="grid" id="captureArea">
  <table id="ledgerTable">
    <thead>
      <tr>
        <th>날짜</th>
        <th>내역</th>
        <th>입금</th>
        <th>출금</th>
        <th>잔액</th>
        <th></th>
      </tr>
    </thead>

    <tbody id="ledger-body"></tbody>

    <tfoot>
      <tr>
        <td><input id="in-date" placeholder="24.12.25" /></td>
        <td><input id="in-desc" placeholder="내역" /></td>
        <td><input id="in-income" placeholder="입금" /></td>
        <td><input id="in-expense" placeholder="출금" /></td>
        <td colspan="2"><button class="btn primary" onclick="addRow()">추가</button></td>
      </tr>
    </tfoot>
  </table>
</div>

<script>
/* --------------------------------
   ✅ 유틸
----------------------------------*/
const el = id => document.getElementById(id);
const toNum = v => Number(String(v||"0").replace(/[^\d.-]/g,""));
const comma = n => toNum(n).toLocaleString();

let ledger = JSON.parse(localStorage.getItem("KOEN_LEDGER_SIMPLE") || "[]");

function pad2(n){return n.toString().padStart(2,"0");}

/* ✅ 날짜 정규화 */
function normalizeDate(raw){
  if(!raw) return "";
  let s = String(raw).trim().replace(/[.,/]/g,"-");

  if(/^\d+$/.test(s)){
    if(s.length===6){ return `20${s.slice(0,2)}-${s.slice(2,4)}-${s.slice(4,6)}`; }
    if(s.length===8){ return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`; }
  }

  const p = s.split("-");
  if(p.length===3){
    let [y,m,d] = p;
    if(y.length===2) y = "20"+y;
    return `${y}-${pad2(m)}-${pad2(d)}`;
  }
  return "";
}

/* ✅ 화면용 */
function displayDate(iso){
  if(!iso) return "";
  const [y,m,d] = iso.split("-");
  return `${y.slice(2)}.${m}.${d}`;
}

/* ✅ 정렬 + 전체 잔액 계산 */
function sortByDate(){ ledger.sort((a,b)=>a.date.localeCompare(b.date)); }

function computeFullBalance(){
  sortByDate();
  let bal = 0;
  ledger.forEach(r=>{
    bal += toNum(r.income) - toNum(r.expense);
    r.balanceFull = bal;
  });
}

/* ✅ 행 추가 */
function addRow(){
  const d = normalizeDate(el("in-date").value);
  const desc = el("in-desc").value.trim();
  const income = toNum(el("in-income").value);
  const expense = toNum(el("in-expense").value);

  if(!d){ alert("날짜 확인해주세요"); return; }
  if(!desc){ alert("내역을 입력하세요"); return; }
  if(income===0 && expense===0){ alert("입금/출금 중 하나 입력"); return; }

  ledger.push({date:d, desc, income, expense});
  el("in-date").value=el("in-desc").value=el("in-income").value=el("in-expense").value="";

  render();
}

/* ✅ 수정 */
function edit(i, field, val){
  if(field==="date") ledger[i].date = normalizeDate(val);
  else if(field==="desc") ledger[i].desc = val;
  else ledger[i][field] = toNum(val);
  render();
}

/* ✅ 삭제 */
function removeRow(i){
  ledger.splice(i,1);
  render();
}

function deleteAll(){
  if(confirm("전체 삭제?")){
    ledger=[];
    save();
    render();
  }
}

/* ✅ 붙여넣기 */
function pasteExcel(){
  const text = el("pasteArea").value.trim();
  if(!text) return;

  const lines = text.split(/\r?\n/);

  for(const line of lines){
    const c = line.split("\t");
    if(c.length<2) continue;

    const row = {
      date: normalizeDate(c[0]),
      desc: c[1].trim(),
      income: toNum(c[2]||0),
      expense: toNum(c[3]||0)
    };
    if(row.date && row.desc) ledger.push(row);
  }

  el("pasteArea").value="";
  render();
}

/* ✅ 필터 */
function matchFilter(r){
  const q = el("search").value.trim().toLowerCase();
  const yf = el("yearFilter").value;
  const mf = el("monthFilter").value;

  if(yf && !r.date.startsWith(yf)) return false;
  if(mf && !r.date.startsWith(mf)) return false;

  if(q){
    const blob = `${displayDate(r.date)} ${r.desc} ${r.income} ${r.expense}`.toLowerCase();
    if(!blob.includes(q)) return false;
  }

  return true;
}

/* ✅ 렌더 */
function render(){
  computeFullBalance();

  let body = el("ledger-body");
  body.innerHTML = "";

  let vIn=0, vOut=0;

  ledger.forEach((r,i)=>{
    if(!matchFilter(r)) return;
    vIn += toNum(r.income);
    vOut += toNum(r.expense);

    body.insertAdjacentHTML("beforeend",`
      <tr>
        <td><input value="${displayDate(r.date)}" onchange="edit(${i},'date',this.value)" /></td>
        <td><input value="${r.desc}" style="text-align:left" onchange="edit(${i},'desc',this.value)" /></td>
        <td><input class="right" value="${comma(r.income)}" onchange="edit(${i},'income',this.value)" /></td>
        <td><input class="right" value="${comma(r.expense)}" onchange="edit(${i},'expense',this.value)" /></td>
        <td class="right">${comma(r.balanceFull)}</td>
        <td><button class="del" onclick="removeRow(${i})">X</button></td>
      </tr>
    `);
  });

  el("sumIn").textContent = comma(vIn);
  el("sumOut").textContent = comma(vOut);
  el("sumBal").textContent = comma(ledger.length ? ledger[ledger.length-1].balanceFull : 0);

  const years=[...new Set(ledger.map(r=>r.date.slice(0,4)))].sort();
  el("yearFilter").innerHTML = `<option value="">연도 전체</option>` + years.map(y=>`<option>${y}</option>`).join("");

  const months=[...new Set(ledger.map(r=>r.date.slice(0,7)))].sort();
  el("monthFilter").innerHTML = `<option value="">월 전체</option>` + months.map(m=>`<option>${m}</option>`).join("");

  save();
}

/* ✅ 저장 */
function save(){ localStorage.setItem("KOEN_LEDGER_SIMPLE", JSON.stringify(ledger)); }

/* ✅ 이미지 저장 (짤림 완전 해결) */
function saveImage(){
  const area=document.getElementById("captureArea");

  html2canvas(area,{
    scale:2,
    backgroundColor:"#ffffff",
    scrollY:-window.scrollY,          // ✅ 스크롤 무시
    windowWidth:document.body.scrollWidth,
    windowHeight:document.body.scrollHeight,  // ✅ 전체 높이 반영
  }).then(canvas=>{
    const a=document.createElement("a");
    a.href=canvas.toDataURL("image/png");
    a.download=`KOEN_ledger_${new Date().toISOString().slice(0,10)}.png`;
    a.click();
  });
}

render();
</script>
</body>
</html>
