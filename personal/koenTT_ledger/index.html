<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>koenTT_ledger · KOEN Blue</title>

<!-- XLSX & html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  :root{
    --koen:#005BAC;         /* KOEN Blue */
    --koen-ink:#0f172a;
    --koen-muted:#6b7280;
    --bg:#f5f7fb;
    --card:#ffffff;
    --line:#e5e7eb;
    --shadow:0 8px 28px rgba(0,0,0,.06);
    --ok:#059669; --warn:#f59e0b; --bad:#dc2626;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg);
    color:var(--koen-ink);
    font-family:"Pretendard","Noto Sans KR",system-ui,Segoe UI,Roboto,sans-serif;
    -webkit-font-smoothing:antialiased;
  }

  /* Header */
  header{
    position:sticky; top:0; z-index:20;
    background:linear-gradient(90deg,#0067cc, var(--koen));
    color:#fff; padding:16px 14px;
    border-bottom:1px solid rgba(255,255,255,.18);
    box-shadow:0 2px 16px rgba(0,0,0,.05);
  }
  .brand{
    max-width:1100px; margin:0 auto;
    display:flex; align-items:center; gap:12px;
  }
  .dot{
    width:10px; height:10px; border-radius:999px; background:#fff; opacity:.9;
  }
  .title{
    font-weight:800; letter-spacing:.2px; font-size:18px;
  }

  /* Summary cards */
  .summary{
    max-width:1100px; margin:10px auto 0;
    display:flex; gap:10px; padding:0 10px; flex-wrap:wrap;
  }
  .sum-card{
    flex:1; min-width:140px; background:var(--card);
    border:1px solid var(--line); border-radius:14px;
    padding:14px 12px; text-align:center; box-shadow:var(--shadow);
    font-weight:700;
  }
  .sum-card small{display:block; color:var(--koen-muted); font-weight:600; margin-bottom:6px}
  .sum-card .v{font-size:18px}

  /* Controls */
  .controls{
    max-width:1100px; margin:10px auto 0;
    display:flex; gap:8px; padding:0 10px 10px; flex-wrap:wrap;
  }
  .controls input,.controls select{
    padding:10px 12px; border:1px solid var(--line); border-radius:10px;
    font-size:14px; background:#fff; min-width:140px;
  }
  .controls button{
    padding:10px 14px; border:none; border-radius:10px; font-weight:700; cursor:pointer;
    box-shadow:var(--shadow);
  }
  .btn-blue{ background:var(--koen); color:#fff; }
  .btn-green{ background:var(--ok); color:#fff; }
  .btn-gray{ background:#334155; color:#fff; }
  .btn-red{ background:var(--bad); color:#fff; }

  /* Paste area block */
  .paste{
    max-width:1100px; margin:6px auto 12px; padding:0 10px;
  }
  .paste .box{
    background:var(--card); border:1px dashed var(--line); border-radius:12px;
    padding:10px; box-shadow:var(--shadow);
  }
  .paste textarea{
    width:100%; border:1px solid var(--line); border-radius:10px; padding:10px; font-size:14px;
    resize:vertical; min-height:80px;
  }

  /* Table */
  .wrap{max-width:1100px; margin:0 auto 26px; padding:0 10px;}
  table{
    width:100%; border-collapse:collapse; background:var(--card);
    border:1px solid var(--line); border-radius:14px; overflow:hidden; box-shadow:var(--shadow);
  }
  thead th{
    background:#eaf3ff; color:#0b3a7e; font-weight:800;
    padding:12px 8px; border-bottom:1px solid #dce8ff; font-size:13px;
  }
  tbody td, tfoot td{
    padding:8px 6px; border-bottom:1px solid #f1f5f9; text-align:center; font-size:14px;
  }
  td input{
    width:98%; padding:8px 6px; border:1px solid #d8dee9; border-radius:10px; text-align:center;
    background:#fff;
  }
  tbody tr:hover td{ background:#fbfdff }
  tfoot td{ background:#f2f7ff }

  .del{
    background:#fff; color:var(--bad); border:1px solid #fecaca;
    border-radius:10px; padding:6px 9px; font-size:12px; font-weight:800;
  }
  .del:hover{ background:#fff5f5 }

  /* Mobile tweaks */
  @media (max-width:560px){
    .sum-card .v{font-size:16px}
    thead th{font-size:12px}
    td input{font-size:13px}
  }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="dot"></div>
    <div class="title">koenTT_ledger · KOEN Blue</div>
  </div>
</header>

<!-- Summary -->
<div class="summary">
  <div class="sum-card"><small>총입금</small><div class="v" id="sumIn">0</div></div>
  <div class="sum-card"><small>총출금</small><div class="v" id="sumOut">0</div></div>
  <div class="sum-card"><small>현재잔액(전체 누적)</small><div class="v" id="sumBal">0</div></div>
</div>

<!-- Controls -->
<div class="controls">
  <input type="text" id="search" placeholder="검색: 날짜/내역/금액" oninput="render()">

  <select id="yearFilter" onchange="render()">
    <option value="">전체 연도</option>
  </select>

  <select id="monthFilter" onchange="render()">
    <option value="">전체 월</option>
  </select>

  <button class="btn-gray" onclick="sortByDate(); render();">전체 Sort</button>
  <button class="btn-blue" onclick="toggleHidden()">숨김/표시</button>
  <button class="btn-green" onclick="downloadExcel()">엑셀 다운로드</button>
  <button class="btn-green" onclick="saveImage()">이미지 저장</button>
  <button class="btn-red" onclick="deleteAll()">전체 삭제</button>
</div>

<!-- Paste -->
<div class="paste">
  <div class="box">
    <textarea id="pasteArea" placeholder="엑셀에서 5열(일자/내역/입금/출금/잔액) 또는 4열(일자/내역/입금/출금)을 복사해 붙여넣기"></textarea>
    <div style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end;">
      <button class="btn-blue" onclick="pasteExcel()">붙여넣기 적용</button>
      <button class="btn-gray" onclick="dedupe()">중복정리</button>
    </div>
  </div>
</div>

<!-- Table -->
<div class="wrap">
  <table id="ledgerTable">
    <thead>
      <tr>
        <th>일자</th>
        <th>내역</th>
        <th>입금</th>
        <th>출금</th>
        <th>잔액(전체 누적)</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="ledger-body"></tbody>
    <tfoot>
      <tr>
        <td><input id="in-date" placeholder="예: 24.12.25"></td>
        <td><input id="in-desc" placeholder="내역"></td>
        <td><input id="in-income" placeholder="입금"></td>
        <td><input id="in-expense" placeholder="출금"></td>
        <td colspan="2">
          <button class="btn-blue" onclick="addRow()">추가</button>
        </td>
      </tr>
    </tfoot>
  </table>
</div>

<script>
/* ------------------------------
   State & helpers
--------------------------------*/
let ledger = JSON.parse(localStorage.getItem("koenTT_ledger") || "[]");
let hiddenMode = false;

const el = id => document.getElementById(id);
const toNum = v => Number(String(v ?? "0").replace(/[^\d.-]/g,"").trim() || 0);
const comma = n => toNum(n).toLocaleString();

/* 날짜 정규화: 모든 입력 → YYYY-MM-DD */
function normalizeDate(raw){
  if(!raw) return "";
  // 숫자만
  let s = String(raw).replace(/[^\d]/g,"").trim();
  // YYMMDD
  if(s.length === 6){
    const yy = s.slice(0,2), mm = s.slice(2,4), dd = s.slice(4,6);
    return `20${yy}-${mm}-${dd}`;
  }
  // YYYYMMDD
  if(s.length === 8){
    const yyyy=s.slice(0,4), mm=s.slice(4,6), dd=s.slice(6,8);
    return `${yyyy}-${mm}-${dd}`;
  }
  return ""; // 잘못된 입력은 빈값
}
/* 표시용: YY.MM.DD */
function displayDate(iso){
  if(!iso) return "";
  const [y,m,d] = iso.split("-");
  return `${y.slice(2)}.${m}.${d}`;
}

/* 정렬 */
function sortByDate(){ ledger.sort((a,b)=>(a.date||"").localeCompare(b.date||"")); }

/* 전체 누적잔액 (필터와 무관) */
function computeFullBalance(){
  sortByDate();
  let bal=0;
  ledger.forEach(r=>{
    bal += toNum(r.income) - toNum(r.expense);
    r.balanceFull = bal;
  });
}

/* 중복 여부 (정규화된 값 비교) */
function isDuplicate(row){
  return ledger.some(r =>
    r.date===row.date &&
    r.desc.trim()===row.desc.trim() &&
    toNum(r.income)===toNum(row.income) &&
    toNum(r.expense)===toNum(row.expense)
  );
}

/* 수동 추가 */
function addRow(){
  const d = normalizeDate(el("in-date").value);
  const desc = el("in-desc").value.trim();
  const income = toNum(el("in-income").value);
  const expense = toNum(el("in-expense").value);

  if(!d){ alert("날짜를 입력하세요 (예: 24.12.25)"); return; }
  if(!desc){ alert("내역을 입력하세요"); return; }

  const row = {date:d, desc, income, expense};
  if(!isDuplicate(row)) ledger.push(row);

  el("in-date").value = el("in-desc").value = el("in-income").value = el("in-expense").value = "";
  render();
}

/* 편집 */
function edit(i,field,value){
  if(field==="date"){
    ledger[i].date = normalizeDate(value);
  }else if(field==="desc"){
    ledger[i].desc = value;
  }else{
    ledger[i][field] = toNum(value);
  }
  render();
}

/* 삭제 */
function removeRow(i){
  ledger.splice(i,1);
  render();
}

/* 전체 삭제 */
function deleteAll(){
  if(!confirm("정말 전체 장부를 삭제하시겠습니까?")) return;
  ledger=[];
  save(); render();
}

/* 숨김/표시 (시각적 토글만) */
function toggleHidden(){ hiddenMode=!hiddenMode; document.body.classList.toggle("hide"); }

/* 붙여넣기 */
function pasteExcel(){
  const text = el("pasteArea").value.trim();
  if(!text){ alert("붙여넣을 내용이 없습니다."); return; }

  const lines = text.split(/\r?\n/);

  for(const line of lines){
    if(!line.trim()) continue;
    const cols = line.split(/\t/);

    // 기대: [일자, 내역, 입금, 출금, (잔액)]
    const date = normalizeDate(cols[0] || "");
    const desc = (cols[1]||"").trim();
    const income = toNum(cols[2]);
    const expense = toNum(cols[3]);

    if(!date || !desc) continue;

    const row = {date, desc, income, expense};
    if(!isDuplicate(row)) ledger.push(row);
  }
  el("pasteArea").value="";
  render();
}

/* 중복 정리 (이미 들어간 데이터 청소) */
function dedupe(){
  const key = r => [r.date, r.desc.trim(), toNum(r.income), toNum(r.expense)].join("|");
  const map = new Map();
  ledger.forEach(r=>{ if(!map.has(key(r))) map.set(key(r), r); });
  ledger = [...map.values()];
  render();
}

/* 엑셀 다운로드 (전체 장부 기준) */
function downloadExcel(){
  computeFullBalance();
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(
    ledger.map(r=>({
      일자: displayDate(r.date),
      내역: r.desc,
      입금: toNum(r.income),
      출금: toNum(r.expense),
      잔액_전체누적: toNum(r.balanceFull)
    }))
  );
  XLSX.utils.book_append_sheet(wb,ws,"ledger");
  XLSX.writeFile(wb,"koenTT_ledger.xlsx");
}

/* 이미지 저장 (표만 고화질 캡쳐) */
function saveImage(){
  const table = document.getElementById("ledgerTable");
  html2canvas(table, {scale:2, backgroundColor:"#ffffff"}).then(canvas=>{
    const a = document.createElement("a");
    const stamp = new Date().toISOString().split("T")[0];
    a.download = `koenTT_ledger_${stamp}.png`;
    a.href = canvas.toDataURL("image/png");
    a.click();
  });
}

/* 필터 매치 */
function matchFilter(r){
  const q = el("search").value.trim().toLowerCase();
  const y = el("yearFilter").value;
  const m = el("monthFilter").value;
  if(y && !r.date.startsWith(y)) return false;
  if(m && !r.date.startsWith(m)) return false;
  if(q){
    const t = `${displayDate(r.date)} ${r.desc} ${r.income} ${r.expense}`.toLowerCase();
    if(!t.includes(q)) return false;
  }
  return true;
}

/* 렌더 */
function render(){
  // 선택값 보존
  const prevY = el("yearFilter").value;
  const prevM = el("monthFilter").value;

  // 전체 누적 계산(정렬 포함)
  computeFullBalance();

  // 표 렌더
  const body = el("ledger-body");
  body.innerHTML = "";
  let totalIn=0, totalOut=0;

  ledger.forEach((r,i)=>{
    if(!matchFilter(r)) return;

    const inc = toNum(r.income);
    const exp = toNum(r.expense);
    totalIn += inc; totalOut += exp;

    body.insertAdjacentHTML("beforeend", `
      <tr>
        <td><input value="${displayDate(r.date)}" onchange="edit(${i},'date',this.value)" /></td>
        <td><input value="${r.desc.replace(/"/g,'&quot;')}" onchange="edit(${i},'desc',this.value)" /></td>
        <td><input value="${comma(inc)}" onchange="edit(${i},'income',this.value)" /></td>
        <td><input value="${comma(exp)}" onchange="edit(${i},'expense',this.value)" /></td>
        <td>${comma(r.balanceFull)}</td>
        <td><button class="del" onclick="removeRow(${i})">삭제</button></td>
      </tr>
    `);
  });

  // 요약
  el("sumIn").textContent  = comma(totalIn);
  el("sumOut").textContent = comma(totalOut);
  el("sumBal").textContent = comma(ledger.length ? ledger[ledger.length-1].balanceFull : 0);

  // 필터 옵션(보존)
  const years = [...new Set(ledger.map(r=>r.date.slice(0,4)).filter(Boolean))].sort();
  const months = [...new Set(ledger.map(r=>r.date.slice(0,7)).filter(Boolean))].sort();

  el("yearFilter").innerHTML =
    `<option value="">전체 연도</option>` + years.map(y=>`<option value="${y}">${y}</option>`).join("");
  el("monthFilter").innerHTML =
    `<option value="">전체 월</option>` + months.map(m=>`<option value="${m}">${m}</option>`).join("");

  if(years.includes(prevY)) el("yearFilter").value = prevY;
  if(months.includes(prevM)) el("monthFilter").value = prevM;

  save();
}

/* 저장 */
function save(){ localStorage.setItem("koenTT_ledger", JSON.stringify(ledger)); }

/* 초기 렌더 */
render();
</script>
</body>
</html>
