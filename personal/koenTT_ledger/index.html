<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>koenTT_ledger (Stable Version)</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  body{margin:0;background:#f5f7fb;font-family:"Pretendard","Noto Sans KR",sans-serif;}
  header{background:white;padding:16px;font-size:20px;font-weight:700;text-align:center;border-bottom:1px solid #eee;position:sticky;top:0;z-index:10;}

  .summary{display:flex;gap:10px;padding:10px;flex-wrap:wrap;}
  .sum-card{flex:1;min-width:120px;padding:14px;background:white;border-radius:10px;border:1px solid #e5e7eb;text-align:center;font-weight:700;font-size:14px;}

  .controls{padding:10px;display:flex;gap:8px;flex-wrap:wrap;}
  .controls input,.controls select{padding:10px;font-size:14px;border:1px solid #ccc;border-radius:8px;flex:1;}
  .controls button{padding:10px 14px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;}
  .btn-blue{background:#2563eb;color:white;}
  .btn-green{background:#059669;color:white;}
  .btn-gray{background:#6b7280;color:white;}
  .btn-red{background:#dc2626;color:white;}

  .wrap{padding:10px;}
  table{
    width:100%;border-collapse:collapse;background:white;border-radius:12px;
    overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,0.05);
  }
  th,td{padding:10px 6px;text-align:center;border-bottom:1px solid #f1f5f9;font-size:14px;}
  td input{width:95%;padding:6px;font-size:14px;text-align:center;border:1px solid #ddd;border-radius:6px;}
  .del{background:#ef4444;color:white;border:none;border-radius:6px;padding:6px 8px;font-size:12px;}
  tfoot td{background:#f0f9ff;}
</style>
</head>

<body>

<header>koenTT_ledger</header>

<!-- âœ… ìƒë‹¨ ìš”ì•½ -->
<div class="summary">
  <div class="sum-card">ì´ì…ê¸ˆ<br><span id="sumIn">0</span></div>
  <div class="sum-card">ì´ì¶œê¸ˆ<br><span id="sumOut">0</span></div>
  <div class="sum-card">í˜„ì¬ì”ì•¡<br><span id="sumBal">0</span></div>
</div>

<!-- âœ… ê¸°ëŠ¥ ë²„íŠ¼ -->
<div class="controls">
  <input type="text" id="search" placeholder="ê²€ìƒ‰: ë‚ ì§œ/ë‚´ì—­/ê¸ˆì•¡" oninput="render()">

  <select id="yearFilter" onchange="render()">
    <option value="">ì „ì²´ ì—°ë„</option>
  </select>

  <select id="monthFilter" onchange="render()">
    <option value="">ì „ì²´ ì›”</option>
  </select>

  <button class="btn-gray" onclick="sortByDate(); render();">ì „ì²´ ì›” Sort</button>
  <button class="btn-blue" onclick="toggleHidden()">ìˆ¨ê¹€/í‘œì‹œ</button>
  <button class="btn-green" onclick="downloadExcel()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
  <button class="btn-red" onclick="deleteAll()">ì „ì²´ ì‚­ì œ</button>
  <button class="btn-red" onclick="fullReset()">ğŸ’¥ ì™„ì „ ì´ˆê¸°í™”</button>
</div>

<!-- âœ… ì—‘ì…€ ë¶™ì—¬ë„£ê¸° -->
<div class="controls" style="flex-direction:column">
  <textarea id="pasteArea" rows="3" placeholder="ì—‘ì…€ì—ì„œ ë³µì‚¬ â†’ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°"></textarea>
  <button class="btn-blue" onclick="pasteExcel()">ë¶™ì—¬ë„£ê¸° ì ìš©</button>
</div>

<!-- âœ… í…Œì´ë¸” -->
<div class="wrap">
  <table>
    <thead>
      <tr>
        <th>ì¼ì</th><th>ë‚´ì—­</th><th>ì…ê¸ˆ</th><th>ì¶œê¸ˆ</th><th>ì”ì•¡</th><th></th>
      </tr>
    </thead>
    <tbody id="ledger-body"></tbody>

    <!-- âœ… ì…ë ¥ì¤„ -->
    <tfoot>
      <tr>
        <td><input id="in-date" placeholder="ì˜ˆ: 24.12.25"></td>
        <td><input id="in-desc" placeholder="ë‚´ì—­"></td>
        <td><input id="in-income" placeholder="ì…ê¸ˆ"></td>
        <td><input id="in-expense" placeholder="ì¶œê¸ˆ"></td>
        <td colspan="2"><button class="btn-blue" onclick="addRow()">ì¶”ê°€</button></td>
      </tr>
    </tfoot>
  </table>
</div>

<script>

let ledger = JSON.parse(localStorage.getItem("koenTT_ledger") || "[]");
let hiddenMode = false;
let idCounter = Number(localStorage.getItem("koenTT_ledger_idCounter") || 0);

const el=id=>document.getElementById(id);
const toNum=v=>Number(String(v??0).replace(/,/g,'').trim()||0);
const comma=n=>toNum(n).toLocaleString();

/* âœ… ê¸ˆì•¡ ì •ë¦¬ */
function cleanMoney(v){
  return toNum(v);
}

/* âœ… displayDate â€” í•­ìƒ YY.MM.DD ë¡œ í‘œì‹œ */
function displayDate(d){
  if (!d) return "";
  const [y, m, day] = d.split("-");
  return `${y.slice(2)}.${m}.${day}`;
}

/* âœ… normalizeDate â€” ë‚ ì§œ ë "." ì œê±° + ëª¨ë“  ë‚ ì§œ í˜•ì‹ ì§€ì› */
function normalizeDate(s){
  if(!s) return today();

  s = String(s).trim();

  while(s.endsWith(".")) s = s.slice(0, -1);

  let full=/^(\d{4})[.\-\/](\d{1,2})[.\-\/](\d{1,2})$/;
  if(full.test(s)){
    let [,y,m,d]=s.match(full);
    return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
  }

  let short=/^(\d{2})[.\-\/](\d{1,2})[.\-\/](\d{1,2})$/;
  if(short.test(s)){
    let [,yy,m,d]=s.match(short);
    return `20${yy}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
  }

  let compact=/^(\d{4})(\d{2})(\d{2})$/;
  if(compact.test(s)){
    let [,y,m,d]=s.match(compact);
    return `${y}-${m}-${d}`;
  }

  let compact2=/^(\d{2})(\d{2})(\d{2})$/;
  if(compact2.test(s)){
    let [,yy,m,d]=s.match(compact2);
    return `20${yy}-${m}-${d}`;
  }

  return today();
}

function today(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

/* âœ… ì •ë ¬ (ë‚ ì§œ â†’ id ì•ˆì • ì •ë ¬) */
function sortByDate(){
  ledger.sort((a,b)=>{
    if(a.date === b.date) return a.id - b.id;
    return a.date.localeCompare(b.date);
  });
}

/* âœ… ì „ì²´ ëˆ„ì  ì”ì•¡ ê³„ì‚° */
function computeFullBalance(){
  let bal = 0;
  ledger.forEach(r=>{
    bal += cleanMoney(r.income) - cleanMoney(r.expense);
    r.balanceFull = bal;
  });
}

/* âœ… ì¤‘ë³µ ì²´í¬ */
function isDuplicate(row){
  return ledger.some(r =>
    r.date===row.date &&
    r.desc===row.desc &&
    cleanMoney(r.income)===cleanMoney(row.income) &&
    cleanMoney(r.expense)===cleanMoney(row.expense)
  );
}

/* âœ… ì…ë ¥ ì¶”ê°€ */
function addRow(){
  const d=normalizeDate(el("in-date").value);
  const desc=el("in-desc").value.trim();
  const income=cleanMoney(el("in-income").value);
  const expense=cleanMoney(el("in-expense").value);

  if(!desc){ alert("ë‚´ì—­ì„ ì…ë ¥í•˜ì„¸ìš”"); return; }

  const row={id:++idCounter, date:d, desc, income, expense};

  if(!isDuplicate(row)) ledger.push(row);

  save();
  render();

  el("in-date").value = el("in-desc").value = el("in-income").value = el("in-expense").value = "";
}

/* âœ… ìˆ˜ì • */
function edit(i,field,value){
  if(field==="income"||field==="expense") ledger[i][field]=cleanMoney(value);
  else if(field==="date") ledger[i].date = normalizeDate(value);
  else ledger[i][field]=value;
  save();
  render();
}

/* âœ… ì‚­ì œ */
function removeRow(i){ ledger.splice(i,1); save(); render(); }

/* âœ… ì „ì²´ ì‚­ì œ */
function deleteAll(){
  if(!confirm("ëŒ€ì¥ë§Œ ì‚­ì œë©ë‹ˆë‹¤. ì´ˆê¸°í™”ëŠ” ì•„ë‹˜. ê³„ì†í• ê¹Œìš”?")) return;
  ledger=[];
  save();
  render();
}

/* âœ… ì™„ì „ ì´ˆê¸°í™” (localStorage ì „ì²´ ì‚­ì œ) */
function fullReset(){
  if(!confirm("âš ï¸ ëª¨ë“  ì €ì¥ ë°ì´í„°ê°€ ì™„ì „íˆ ì‚­ì œë©ë‹ˆë‹¤.\nì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
  localStorage.removeItem("koenTT_ledger");
  localStorage.removeItem("koenTT_ledger_idCounter");
  ledger=[];
  idCounter=0;
  render();
}

/* âœ… ìˆ¨ê¹€/í‘œì‹œ */
function toggleHidden(){ hiddenMode=!hiddenMode; render(); }

/* âœ… ì—‘ì…€ ë¶™ì—¬ë„£ê¸° */
function pasteExcel(){
  const text=el("pasteArea").value.trim();
  if(!text){ alert("ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤"); return; }

  const lines=text.split(/\r?\n/);

  lines.forEach((line, idx)=>{
    const c=line.split(/\t/);
    if(c.length < 2) return;

    const date = normalizeDate(c[0]);
    const desc = c[1].trim();
    const income = cleanMoney(c[2]);
    const expense = cleanMoney(c[3]);

    const row={id:++idCounter, date, desc, income, expense};

    if(!isDuplicate(row)) ledger.push(row);
  });

  save();
  el("pasteArea").value="";
  render();
}

/* âœ… ì—‘ì…€ ë‹¤ìš´ë¡œë“œ */
function downloadExcel(){
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.json_to_sheet(
    ledger.map(r=>({
      ì¼ì:displayDate(r.date),
      ë‚´ì—­:r.desc,
      ì…ê¸ˆ:r.income,
      ì¶œê¸ˆ:r.expense,
      ì”ì•¡:r.balanceFull
    }))
  );
  XLSX.utils.book_append_sheet(wb,ws,"ledger");
  XLSX.writeFile(wb,"koenTT_ledger.xlsx");
}

/* âœ… ê²€ìƒ‰ + í•„í„° */
function matchFilter(r){
  const q=el("search").value.trim();
  const y=el("yearFilter").value;
  const m=el("monthFilter").value;

  if(y && !r.date.startsWith(y)) return false;
  if(m && !r.date.startsWith(m)) return false;

  if(q){
    const t=`${r.date} ${r.desc} ${r.income} ${r.expense}`;
    if(!t.includes(q)) return false;
  }

  return true;
}

/* âœ… ë Œë”ë§ */
function render(){
  sortByDate();
  computeFullBalance();

  let body=el("ledger-body");
  body.innerHTML="";

  let totalIn=0, totalOut=0;

  ledger.forEach((r,i)=>{
    if(!matchFilter(r)) return;

    const inc=cleanMoney(r.income);
    const exp=cleanMoney(r.expense);

    totalIn+=inc;
    totalOut+=exp;

    body.insertAdjacentHTML("beforeend",`
      <tr>
        <td><input value="${displayDate(r.date)}" onchange="edit(${i},'date',this.value)"></td>
        <td><input value="${r.desc}" onchange="edit(${i},'desc',this.value)"></td>
        <td><input value="${comma(inc)}" onchange="edit(${i},'income',this.value)"></td>
        <td><input value="${comma(exp)}" onchange="edit(${i},'expense',this.value)"></td>
        <td>${comma(r.balanceFull)}</td>
        <td><button class="del" onclick="removeRow(${i})">ì‚­ì œ</button></td>
      </tr>
    `);
  });

  el("sumIn").textContent = comma(totalIn);
  el("sumOut").textContent = comma(totalOut);
  el("sumBal").textContent = comma( ledger.length ? ledger[ledger.length-1].balanceFull : 0 );

  /* âœ… í•„í„° ìë™ ìƒì„± */
  const years=[...new Set(ledger.map(r=>r.date.slice(0,4)))].filter(y=>y);
  el("yearFilter").innerHTML=`<option value="">ì „ì²´ ì—°ë„</option>`+
    years.map(y=>`<option value="${y}">${y}</option>`).join("");

  const months=[...new Set(ledger.map(r=>r.date.slice(0,7)))].filter(m=>m);
  el("monthFilter").innerHTML=`<option value="">ì „ì²´ ì›”</option>`+
    months.map(m=>`<option value="${m}">${m}</option>`).join("");

  save();
}

/* âœ… ì €ì¥ */
function save(){
  localStorage.setItem("koenTT_ledger", JSON.stringify(ledger));
  localStorage.setItem("koenTT_ledger_idCounter", String(idCounter));
}

render();
</script>

</body>
</html>
