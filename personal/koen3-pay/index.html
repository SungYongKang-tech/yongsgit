<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>남동3기 회식비 정산</title>
  <style>
    :root { --primary:#2b6cb0; --muted:#f5f7fb; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; margin: 0; background: #fafafa; color:#222; }
    header { position: sticky; top:0; z-index:5; background:#fff; border-bottom:1px solid #e5e7eb; }
    .bar {
      max-width: 1100px; margin: 0 auto; padding: 10px 14px;
      display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .bar h1 { font-size: clamp(18px, 4.5vw, 22px); margin:0; }
    .bar .actions { display:flex; gap:6px; flex-wrap:wrap; }
    button, .btn {
      appearance:none; border:1px solid #cbd5e1; background:#fff; color:#111;
      padding: 8px 12px; border-radius:10px; cursor:pointer; font-weight:600;
    }
    button.primary, .btn.primary { background: var(--primary); color:#fff; border-color: var(--primary); }
    main { max-width: 1100px; margin: 0 auto; padding: 14px; }

    .card { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:14px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .grid { display:grid; gap:12px; }
    .grid-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    @media (max-width: 900px) { .grid-3{grid-template-columns:1fr;} }
    @media (max-width: 700px) { .grid-2{grid-template-columns:1fr;} }

    label { display:block; font-weight:600; margin: 6px 0 4px; }
    input[type="text"], input[type="number"], input[type="date"] {
      width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px; background:#fff;
    }

    .attendee-list { display:flex; flex-wrap:wrap; gap:8px; background:var(--muted); padding:10px; border-radius:10px; }
    .attendee-list .pill {
      display:inline-flex; align-items:center; gap:6px;
      background:#fff; border:1px solid #e5e7eb; padding:6px 10px; border-radius:20px;
    }
    .attendee-list .pill[data-excluded="1"] { opacity:.6; }
    .ex-toggle { border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:3px 6px; font-size:12px; cursor:pointer; }
    .ex-toggle.active { background:#fee2e2; }

    .round { border:1px dashed #d1d5db; border-radius:12px; padding:12px; background:#fcfcfe; }
    .preview-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .preview-row img { height:88px; border-radius:10px; border:1px solid #e5e7eb; }

    table { width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:auto; display:block; }
    th, td { border:1px solid #e5e7eb; padding:10px; text-align:center; white-space:nowrap; }
    thead th { background:#f8fafc; }

    /* 목록(2열, 좌: 정보 / 우: 썸네일) */
    .list-row {
      display:grid; grid-template-columns: 1fr 120px; gap:12px; align-items:center;
      padding:12px; border-bottom:1px solid #eee;
    }
    .list-row:hover { background:#fafcff; }
    .list-head { font-weight:800; color:#475569; grid-template-columns: 1fr 120px; }
    .info-date a { color:var(--primary); font-weight:800; text-decoration:none; }
    .info-title { font-weight:700; margin-top:4px; }
    .info-meta { color:#6b7280; font-size:14px; margin-top:2px; }

    .thumb {
      width:112px; height:78px; object-fit:cover; border-radius:10px; border:1px solid #e5e7eb; background:#f1f5f9; display:block; margin-left:auto;
    }
    .thumb.placeholder {
      display:flex; align-items:center; justify-content:center; font-size:12px; color:#94a3b8; border-style:dashed;
      width:112px; height:78px; border-radius:10px; border:1px dashed #e5e7eb; margin-left:auto;
    }
    @media (max-width:700px) {
      .list-row { grid-template-columns: 1fr; }
      .thumb, .thumb.placeholder { margin-left:0; width:100%; height:160px; }
    }

    .paid { color:#16a34a; font-weight:800; }
    .unpaid { color:#dc2626; font-weight:800; }
    .muted { color:#6b7280; }
    .hidden { display:none; }

    .capture-wrap { background:#fff; padding:12px; border-radius:14px; border:1px solid #e5e7eb; }

    /* 라이트박스 */
    .lightbox {
      position: fixed; inset: 0; z-index: 9999;
      background: rgba(0,0,0,.85);
      display: flex; align-items: center; justify-content: center;
      padding: 16px;
    }
    .lightbox.hidden { display: none; }
    .lightbox img {
      max-width: min(92vw, 1200px);
      max-height: 92vh;
      border-radius: 12px;
      box-shadow: 0 8px 40px rgba(0,0,0,.6);
      user-select: none;
    }
    .lightbox .close-btn {
      position: absolute; top: 10px; right: 10px;
      border: none; background: rgba(255,255,255,.15);
      color: #fff; font-size: 28px; line-height: 1;
      border-radius: 10px; padding: 6px 12px; cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <h1>남동3기 회식비 정산</h1>
      <div class="actions">
        <button class="btn" id="btnList">목록</button>
        <button class="btn" id="btnNew">새 회식</button>
        <button class="btn" id="btnExport">내보내기</button>
        <label class="btn" for="importFile" style="margin:0;">가져오기</label>
        <input id="importFile" type="file" accept="application/json" class="hidden">
      </div>
    </div>
  </header>

  <main>
    <!-- 목록 화면 -->
    <section id="view-list" class="grid">
      <div class="card">
        <div class="list-row list-head">
          <div>정보</div><div style="text-align:right;">사진</div>
        </div>
        <div id="listBody"></div>
        <p class="muted" id="emptyNote" style="display:none; padding:10px 2px;">아직 저장된 회식이 없습니다. “새 회식”을 눌러 입력한 후 저장하세요.</p>
      </div>
    </section>

    <!-- 작성/편집 화면 -->
    <section id="view-editor" class="grid hidden">
      <div class="card">
        <div class="grid grid-3">
          <div>
            <label>회식 날짜</label>
            <input type="date" id="meetingDate">
          </div>
          <div>
            <label>제목</label>
            <input type="text" id="meetingTitle" placeholder="예: 3월 회식">
          </div>
          <div>
            <label>장소</label>
            <input type="text" id="meetingPlace" placeholder="예: 진주 ○○식당">
          </div>
        </div>

        <div style="margin-top:10px;">
          <button class="btn" onclick="addRound()">차수 추가</button>
        </div>

        <div id="rounds" style="margin-top:12px;" class="grid"></div>

        <div style="margin-top:12px;">
          <label>회식 사진 업로드 (여러 장)</label>
          <input type="file" accept="image/*" id="groupPhoto" multiple>
          <div id="photoPreview" class="preview-row" style="margin-top:6px;"></div>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;">
          <button class="btn primary" id="btnSave">이 회식 저장</button>
          <button class="btn" id="btnPreview">정산표 미리보기</button>
        </div>

        <div id="editorPreview" class="card hidden" style="margin-top:12px;">
          <div class="section-title">정산표 미리보기</div>
          <div id="editorSummary"></div>
        </div>
      </div>
    </section>

    <!-- 상세 화면 -->
    <section id="view-detail" class="grid hidden">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
          <div>
            <div id="detailTitle" style="font-weight:900; font-size:18px;"></div>
            <div class="muted" id="detailMeta"></div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn" id="btnBackToList">목록으로</button>
            <button class="btn" id="btnDelete">삭제</button>
            <button class="btn" id="btnCapture">이미지로 저장</button>
            <button class="btn" id="btnEdit">수정하기</button>
          </div>
        </div>

        <div id="detailWrap" class="capture-wrap" style="margin-top:12px;">
          <div id="detailSummary"></div>

          <div style="margin-top:16px;">
            <div class="section-title">영수증</div>
            <div id="detailReceipts" class="preview-row"></div>
          </div>

          <div style="margin-top:16px;">
            <div class="section-title">사진</div>
            <div id="detailPhotos" class="preview-row"></div>
          </div>

          <div style="margin-top:16px;">
            <div class="section-title">입금 확인</div>
            <div id="detailPaid"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- 이미지 라이트박스 -->
  <div id="imgModal" class="lightbox hidden" aria-modal="true" role="dialog">
    <img id="imgModalImg" alt="확대 이미지" />
    <button type="button" class="close-btn" id="imgModalClose" aria-label="닫기">×</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    const LS_KEY = 'koen_meetings_v2';
    const defaultAttendees = ["성용","범준","기현","승호","재환","창현","계민","인찬","정선","현정","정록","영화","재화","원용","윤숙","인수"];
    let allAttendees = [...defaultAttendees];

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function loadDB() {
      try { const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : []; }
      catch { return []; }
    }
    function saveDB(list) { localStorage.setItem(LS_KEY, JSON.stringify(list)); }

    /* 편집 상태 */
    let isEditing = false, editingId = null;
    let editorPhotos = [], newPhotoFiles = [];
    let editorReceipts = {}, newReceiptFiles = {};

    /* 화면 전환 */
    const viewList = $('#view-list'), viewEditor = $('#view-editor'), viewDetail = $('#view-detail');
    function show(id){ [viewList,viewEditor,viewDetail].forEach(v=>v.classList.add('hidden')); id.classList.remove('hidden'); window.scrollTo({top:0,behavior:'smooth'}); }
    $('#btnList').onclick = ()=>{ renderList(); show(viewList); };
    $('#btnNew').onclick = ()=>{ resetEditor(); show(viewEditor); };
    $('#btnExport').onclick = ()=>{
      const blob = new Blob([JSON.stringify(loadDB(), null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='남동3기-회식정산-백업.json'; a.click(); URL.revokeObjectURL(a.href);
    };
    $('#importFile').onchange = async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      try { const data = JSON.parse(await f.text()); if(!Array.isArray(data)) throw new Error('형식 오류'); saveDB(data); renderList(); show(viewList); alert('가져오기가 완료되었습니다.'); }
      catch(err){ alert('가져오기 실패: '+err.message); }
      finally{ e.target.value=''; }
    };

    /* 목록 렌더링 (2열) */
    function renderList(){
      const list = loadDB().sort((a,b)=> (b.date||'').localeCompare(a.date||''));
      const body = $('#listBody'); body.innerHTML=''; $('#emptyNote').style.display = list.length ? 'none' : 'block';
      list.forEach(item=>{
        const unique = new Set(item.rounds.flatMap(r=>r.attendees||[]));
        const thumbSrc = (item.photos && item.photos[0]) ? item.photos[0] : null;
        const row = document.createElement('div'); row.className='list-row';
        row.innerHTML = `
          <div>
            <div class="info-date"><a href="#" data-id="${item.id}" class="link-date">${item.date||'-'}</a></div>
            <div class="info-title">${item.title||'-'}</div>
            <div class="info-meta">참석 ${unique.size.toLocaleString('ko-KR')}명 · 장소 ${item.place||'-'}</div>
          </div>
          <div>
            ${thumbSrc ? `<img src="${thumbSrc}" alt="회식 썸네일" class="thumb zoomable">`
                        : `<div class="thumb placeholder">사진없음</div>`}
          </div>`;
        body.appendChild(row);
      });
      $$('.link-date', body).forEach(a=> a.onclick = (e)=>{ e.preventDefault(); openDetail(a.dataset.id); });
    }

    /* 작성/편집 화면 */
    function resetEditor(){
      isEditing=false; editingId=null; editorPhotos=[]; newPhotoFiles=[]; editorReceipts={}; newReceiptFiles={};
      $('#meetingDate').value=''; $('#meetingTitle').value=''; $('#meetingPlace').value='';
      $('#rounds').innerHTML=''; $('#groupPhoto').value=''; $('#photoPreview').innerHTML='';
      $('#editorPreview').classList.add('hidden'); $('#editorSummary').innerHTML='';
      addRound();
    }

    function addRound(){
      const container = document.createElement('div');
      const idx = $$('.round').length; // 0-based
      container.className='round'; container.dataset.idx=String(idx);
      editorReceipts[idx]=editorReceipts[idx]||[]; newReceiptFiles[idx]=newReceiptFiles[idx]||[];

      container.innerHTML = `
        <div class="section-title">${idx+1}차</div>
        <div class="grid grid-3">
          <div>
            <label>금액(원)</label>
            <input type="number" class="amount" min="0" placeholder="예: 150000">
            <label style="margin-top:6px;">
              <input type="checkbox" class="corpCard"> 이 차수는 법인카드(개인 정산 없음)
            </label>
          </div>
          <div>
            <label>영수증 업로드</label>
            <input type="file" accept="image/*" class="receiptInput" multiple>
          </div>
          <div>
            <label class="muted">영수증 미리보기</label>
            <div class="receiptPreview preview-row"></div>
          </div>
        </div>
        <div style="margin-top:8px;">
          <div class="section-title">참석자 (필요 시 ‘제외’ 토글)</div>
          <div class="attendee-list"></div>
        </div>`;
      $('#rounds').appendChild(container);
      updateAttendeeListFor(container);

      // 영수증 업로드
      $('.receiptInput', container).addEventListener('change', (e)=>{
        const files = Array.from(e.target.files||[]); const rIdx = parseInt(container.dataset.idx,10);
        newReceiptFiles[rIdx].push(...files); renderReceiptPreview(container); e.target.value='';
      });
      renderReceiptPreview(container);

      // 법인카드 체크 시 금액 입력 비활성/비우기
      $('.corpCard', container).addEventListener('change', (e)=>{
        const amountEl = $('.amount', container);
        if (e.target.checked){ amountEl.value=''; amountEl.disabled=true; amountEl.placeholder='법인카드 - 금액입력 불필요'; }
        else { amountEl.disabled=false; amountEl.placeholder='예: 150000'; }
      });
    }

    function updateAttendeeListFor(roundEl){
      const div = $('.attendee-list', roundEl);
      // 기존 상태 보존
      const prevChecked = $$('input[data-role="attend"]:checked', div).map(el=>el.value);
      const prevExcluded = $$('label.pill[data-excluded="1"]', div).map(el=>el.dataset.name);
      div.innerHTML = allAttendees.map(n=>{
        const checked = prevChecked.includes(n) ? 'checked' : '';
        const excluded = prevExcluded.includes(n) ? ' data-excluded="1"' : '';
        const exText = prevExcluded.includes(n) ? '제외됨' : '제외';
        return `
          <label class="pill"${excluded} data-name="${n}">
            <input type="checkbox" data-role="attend" value="${n}" ${checked}> ${n}
            <button type="button" class="ex-toggle${prevExcluded.includes(n)?' active':''}" data-role="ex-toggle" data-name="${n}">${exText}</button>
          </label>`;
      }).join('');
    }

    function renderReceiptPreview(roundEl){
      const rIdx = parseInt(roundEl.dataset.idx,10);
      const box = roundEl.querySelector('.receiptPreview'); box.innerHTML='';
      // 기존
      (editorReceipts[rIdx]||[]).forEach((src,i)=>{
        const wrap = document.createElement('div'); wrap.className='preview-row';
        const img = document.createElement('img'); img.src=src; img.alt='영수증'; img.classList.add('zoomable');
        const btn = document.createElement('button'); btn.className='ex-toggle'; btn.textContent='삭제';
        btn.dataset.role='del-receipt-existing'; btn.dataset.idx=String(rIdx); btn.dataset.i=String(i);
        wrap.appendChild(img); wrap.appendChild(btn); box.appendChild(wrap);
      });
      // 신규
      (newReceiptFiles[rIdx]||[]).forEach((file,i)=>{
        const url = URL.createObjectURL(file);
        const wrap = document.createElement('div'); wrap.className='preview-row';
        const img = document.createElement('img'); img.src=url; img.alt='영수증(신규)'; img.classList.add('zoomable');
        const btn = document.createElement('button'); btn.className='ex-toggle'; btn.textContent='삭제';
        btn.dataset.role='del-receipt-new'; btn.dataset.idx=String(rIdx); btn.dataset.i=String(i);
        wrap.appendChild(img); wrap.appendChild(btn); box.appendChild(wrap);
        img.onload = ()=> URL.revokeObjectURL(url);
      });
    }

    // 사진 업로드
    $('#groupPhoto').addEventListener('change', (e)=>{
      const files = Array.from(e.target.files||[]); newPhotoFiles.push(...files); renderPhotoPreview(); e.target.value='';
    });
    function renderPhotoPreview(){
      const box = $('#photoPreview'); box.innerHTML='';
      // 기존
      editorPhotos.forEach((src,i)=>{
        const wrap = document.createElement('div'); wrap.className='preview-row';
        const img = document.createElement('img'); img.src=src; img.alt='사진'; img.classList.add('zoomable');
        const btn = document.createElement('button'); btn.className='ex-toggle'; btn.textContent='삭제'; btn.dataset.role='del-photo-existing'; btn.dataset.i=String(i);
        wrap.appendChild(img); wrap.appendChild(btn); box.appendChild(wrap);
      });
      // 신규
      newPhotoFiles.forEach((file,i)=>{
        const url = URL.createObjectURL(file);
        const wrap = document.createElement('div'); wrap.className='preview-row';
        const img = document.createElement('img'); img.src=url; img.alt='사진(신규)'; img.classList.add('zoomable');
        const btn = document.createElement('button'); btn.className='ex-toggle'; btn.textContent='삭제'; btn.dataset.role='del-photo-new'; btn.dataset.i=String(i);
        wrap.appendChild(img); wrap.appendChild(btn); box.appendChild(wrap);
        img.onload = ()=> URL.revokeObjectURL(url);
      });
    }

    // 에디터 미리보기
    $('#btnPreview').onclick = ()=>{
      const dummy = buildSummaryFromEditor(); if(!dummy) return;
      $('#editorSummary').innerHTML = dummy.html; $('#editorPreview').classList.remove('hidden');
    };

    function buildSummaryFromEditor(){
      const roundEls = $$('.round'); if(!roundEls.length){ alert('차수를 추가하세요.'); return null; }
      const roundTitles = roundEls.map((_,i)=>`${i+1}차`);
      const memberMap = {};
      for(let i=0;i<roundEls.length;i++){
        const el = roundEls[i];
        const corp = $('.corpCard', el).checked;
        const amountRaw = $('.amount', el).value.trim();
        const amount = amountRaw === '' ? null : parseInt(amountRaw,10);
        const checked = $$('input[data-role="attend"]:checked', el).map(v=>v.value);
        const excluded = $$('label.pill[data-excluded="1"]', el).map(l=>l.dataset.name).filter(n=>checked.includes(n));
        const included = checked.filter(n=>!excluded.includes(n));

        if (!corp && amount && included.length>0){
          const per = amount / included.length;
          included.forEach(n=>{
            if(!memberMap[n]) memberMap[n]={ total:0, rounds:[] };
            memberMap[n].rounds[i] = per; memberMap[n].total += per;
          });
        }
      }
      const rows = Object.entries(memberMap).sort((a,b)=>a[0].localeCompare(b[0],'ko'));
      let html = `<table><thead><tr><th>이름</th>${roundTitles.map(r=>`<th>${r}</th>`).join('')}<th>총액</th></tr></thead><tbody>`;
      rows.forEach(([name,data])=>{
        html += `<tr><td>${name}</td>`;
        for(let i=0;i<roundTitles.length;i++){
          const v = data.rounds[i] ? formatNumber(data.rounds[i])+'원' : '-';
          html += `<td>${v}</td>`;
        }
        html += `<td><strong>${formatNumber(data.total)}원</strong></td></tr>`;
      });
      html += `</tbody></table>`;
      return { html, count: rows.length };
    }

    // 파일 -> DataURL (압축)
    function fileToDataURLCompressed(file, maxW=1400, quality=0.85){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = ()=>{
          const img = new Image();
          img.onload = ()=>{
            const canvas = document.createElement('canvas');
            const s = Math.min(1, maxW/img.width);
            canvas.width = Math.max(1, Math.round(img.width*s));
            canvas.height = Math.max(1, Math.round(img.height*s));
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img,0,0,canvas.width,canvas.height);
            resolve(canvas.toDataURL('image/jpeg', quality));
          };
          img.onerror = reject; img.src = reader.result;
        };
        reader.onerror = reject; reader.readAsDataURL(file);
      });
    }

    async function collectEditorData(){
      const date = $('#meetingDate').value;
      const title = $('#meetingTitle').value.trim();
      const place = $('#meetingPlace').value.trim();
      if(!date || !title){ alert('날짜와 제목은 필수입니다.'); throw new Error('required'); }

      // photos (기존+신규)
      const photos = [...editorPhotos];
      const newPhotoData = await Promise.all(newPhotoFiles.map(f=>fileToDataURLCompressed(f)));
      photos.push(...newPhotoData);

      // rounds
      const roundEls = $$('.round'); if(!roundEls.length){ alert('차수를 추가하세요.'); throw new Error('no rounds'); }
      const rounds = [];
      for(let i=0;i<roundEls.length;i++){
        const el = roundEls[i];
        const corp = $('.corpCard', el).checked;
        const amountRaw = $('.amount', el).value.trim();
        const amount = amountRaw === '' ? null : parseInt(amountRaw,10);

        const attendees = $$('input[data-role="attend"]:checked', el).map(cb=>cb.value);
        if(!attendees.length){ alert(`${i+1}차 참석자를 선택하세요.`); throw new Error('no attendees'); }

        const exclusions = $$('label.pill[data-excluded="1"]', el).map(l=>l.dataset.name).filter(n=>attendees.includes(n));

        // 영수증
        const existing = editorReceipts[i] || [];
        const newFiles = newReceiptFiles[i] || [];
        const newData = await Promise.all(newFiles.map(f=>fileToDataURLCompressed(f)));
        const receiptImages = [...existing, ...newData];

        // 유효성: 법인카드가 아니고 금액이 입력되어 있을 때만 금액>0 체크
        if(!corp && amount !== null && amount <= 0){
          alert(`${i+1}차 금액을 확인하세요.`); throw new Error('bad amount');
        }

        rounds.push({ amount, attendees, exclusions, receiptImages, corp });
      }

      // paidStatus
      let paidStatus = {};
      if (!isEditing){
        const people = Array.from(new Set(rounds.flatMap(r=> r.attendees.filter(n=> !(r.exclusions||[]).includes(n)) )));
        paidStatus = Object.fromEntries(people.map(n=>[n,false]));
      }

      return { id: isEditing ? editingId : Date.now().toString(), date, title, place, rounds, photos, paidStatus };
    }

    $('#btnSave').onclick = async ()=>{
      try{
        const data = await collectEditorData();
        const db = loadDB();
        if(isEditing){
          const old = db.find(x=>x.id===editingId); if(!old) throw new Error('기존 데이터 없음');
          // paidStatus 병합: 포함 대상만 유지/신규 추가
          const newIncluded = Array.from(new Set(data.rounds.flatMap(r=> r.attendees.filter(n=> !(r.exclusions||[]).includes(n)) )));
          const merged = {}; newIncluded.forEach(n=> merged[n] = (old.paidStatus && n in old.paidStatus) ? old.paidStatus[n] : false);
          data.paidStatus = merged;
          const idx = db.findIndex(x=>x.id===editingId); db[idx]=data;
        }else{
          db.push(data);
        }
        saveDB(db);
        alert(isEditing ? '수정되었습니다.' : '저장되었습니다.');
        renderList(); show(viewList);
      }catch(e){}
    };

    /* 상세 보기 */
    function openDetail(id){
      const db = loadDB(); const item = db.find(x=>x.id===id);
      if(!item){ alert('데이터를 찾을 수 없습니다.'); return; }
      $('#detailTitle').textContent = item.title||'(제목 없음)';
      const uniqueCnt = new Set(item.rounds.flatMap(r=>r.attendees)).size;
      $('#detailMeta').textContent = `${item.date||'-'} · 참석 ${uniqueCnt.toLocaleString('ko-KR')}명 · 장소 ${item.place||'-'}`;

      $('#detailSummary').innerHTML = buildSummaryHTML(item);

      const recWrap = $('#detailReceipts'); recWrap.innerHTML='';
      item.rounds.forEach((r,idx)=> (r.receiptImages||[]).forEach(src=>{
        const img=document.createElement('img'); img.src=src; img.alt=`${idx+1}차 영수증`; img.classList.add('zoomable'); recWrap.appendChild(img);
      }));
      const pWrap = $('#detailPhotos'); pWrap.innerHTML='';
      (item.photos||[]).forEach(src=>{ const img=document.createElement('img'); img.src=src; img.alt='회식 사진'; img.classList.add('zoomable'); pWrap.appendChild(img); });

      renderPaidTable(item);

      $('#btnBackToList').onclick=()=>{ renderList(); show(viewList); };
      $('#btnDelete').onclick=()=>{ if(!confirm('이 회식 기록을 삭제할까요?')) return; saveDB(loadDB().filter(x=>x.id!==id)); renderList(); show(viewList); };
      $('#btnCapture').onclick=()=> captureElement($('#detailWrap'), `${item.date||'회식'}-${item.title||''}.png`);
      $('#btnEdit').onclick=()=> startEdit(id);

      show(viewDetail);
    }

    function startEdit(id){
      const db = loadDB(); const item = db.find(x=>x.id===id); if(!item){ alert('수정할 데이터를 찾지 못했습니다.'); return; }
      isEditing=true; editingId=id;

      // 누락된 참석자 이름을 마스터에 추가
      const allNames = Array.from(new Set(item.rounds.flatMap(r=>r.attendees)));
      allNames.forEach(n=>{ if(!allAttendees.includes(n)) allAttendees.push(n); });

      $('#meetingDate').value=item.date||''; $('#meetingTitle').value=item.title||''; $('#meetingPlace').value=item.place||'';
      editorPhotos=[...(item.photos||[])]; newPhotoFiles=[]; $('#rounds').innerHTML=''; editorReceipts={}; newReceiptFiles={};

      item.rounds.forEach((r,i)=>{
        addRound();
        const roundEl = $$('.round')[i];
        const amountEl = $('.amount', roundEl); const corpEl=$('.corpCard', roundEl);
        amountEl.value = (r.amount??'') === null ? '' : (r.amount??'');
        corpEl.checked = !!r.corp;
        if (corpEl.checked){ amountEl.value=''; amountEl.disabled=true; amountEl.placeholder='법인카드 - 금액입력 불필요'; }

        editorReceipts[i] = [...(r.receiptImages||[])]; newReceiptFiles[i]=[]; renderReceiptPreview(roundEl);

        // 참석자/제외자 표시
        const div = $('.attendee-list', roundEl);
        updateAttendeeListFor(roundEl);
        const labels = $$('label.pill', div);
        labels.forEach(lbl=>{
          const name = lbl.dataset.name;
          const cb = $('input[data-role="attend"]', lbl);
          cb.checked = r.attendees.includes(name);
          if ((r.exclusions||[]).includes(name)){
            lbl.setAttribute('data-excluded','1');
            const btn = $('[data-role="ex-toggle"]', lbl);
            if(btn){ btn.textContent='제외됨'; btn.classList.add('active'); }
          }
        });
      });

      renderPhotoPreview();
      show(viewEditor);
    }

    function buildSummaryHTML(item){
      const roundTitles = item.rounds.map((_,i)=>`${i+1}차`);
      const memberMap = {};
      item.rounds.forEach((r,idx)=>{
        const included = (r.attendees||[]).filter(n=> !(r.exclusions||[]).includes(n));
        if (!r.corp && r.amount && included.length>0){
          const per = r.amount / included.length;
          included.forEach(n=>{
            if(!memberMap[n]) memberMap[n]={ total:0, rounds:[] };
            memberMap[n].rounds[idx] = per; memberMap[n].total += per;
          });
        }
      });
      const entries = Object.entries(memberMap).sort((a,b)=>a[0].localeCompare(b[0],'ko'));
      let html = `<div class="section-title">정산 결과</div>`;
      html += `<table><thead><tr><th>이름</th>${roundTitles.map(r=>`<th>${r}</th>`).join('')}<th>총액</th></tr></thead><tbody>`;
      entries.forEach(([name,data])=>{
        html += `<tr><td>${name}</td>`;
        for(let i=0;i<roundTitles.length;i++){
          const v = data.rounds[i] ? formatNumber(data.rounds[i])+'원' : '-';
          html += `<td>${v}</td>`;
        }
        html += `<td><strong>${formatNumber(data.total)}원</strong></td></tr>`;
      });
      html += `</tbody></table>`;
      return html;
    }

    function renderPaidTable(item){
      const totals = {};
      item.rounds.forEach(r=>{
        const included = (r.attendees||[]).filter(n=> !(r.exclusions||[]).includes(n));
        if (!r.corp && r.amount && included.length>0){
          const per = r.amount / included.length;
          included.forEach(n=> totals[n] = (totals[n]||0) + per);
        }
      });
      const names = Object.keys(totals).sort((a,b)=>a.localeCompare(b,'ko'));
      const wrap = $('#detailPaid');
      let html = `<table><thead><tr><th>이름</th><th>총액</th><th>입금 상태</th></tr></thead><tbody>`;
      names.forEach(n=>{
        const paid = !!item.paidStatus?.[n];
        html += `<tr><td>${n}</td><td>${formatNumber(totals[n])}원</td>
          <td><button class="${paid?'paid':'unpaid'}" data-name="${n}" data-id="${item.id}">${paid?'확인됨':'미입금'}</button></td></tr>`;
      });
      html += `</tbody></table>`;
      wrap.innerHTML = html;

      $$('button[data-name]', wrap).forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.dataset.id, name = btn.dataset.name;
          const db = loadDB(); const it = db.find(x=>x.id===id); if(!it) return;
          it.paidStatus = it.paidStatus||{}; it.paidStatus[name] = !it.paidStatus[name];
          saveDB(db); renderPaidTable(it);
        };
      });
    }

    /* 유틸 */
    function formatNumber(num){ return Math.round(num).toLocaleString('ko-KR'); }
    async function captureElement(el, filename='정산표.png'){
      const canvas = await html2canvas(el,{ scale:2, useCORS:true, backgroundColor:'#fff',
        windowWidth: el.scrollWidth, windowHeight: el.scrollHeight, scrollX:0, scrollY:-window.scrollY });
      const link = document.createElement('a'); link.download=filename; link.href=canvas.toDataURL('image/png'); link.click();
    }

    /* 전역 위임: 라이트박스, 삭제, 제외 토글 */
    const imgModal = $('#imgModal'), imgModalImg = $('#imgModalImg'), imgModalClose = $('#imgModalClose');
    function openImgModal(src){ imgModalImg.src=src; imgModal.classList.remove('hidden'); document.body.style.overflow='hidden'; }
    function closeImgModal(){ imgModal.classList.add('hidden'); imgModalImg.src=''; document.body.style.overflow=''; }
    imgModalClose.addEventListener('click', closeImgModal);
    imgModal.addEventListener('click', e=>{ if(e.target===imgModal) closeImgModal(); });
    document.addEventListener('keydown', e=>{ if(e.key==='Escape' && !imgModal.classList.contains('hidden')) closeImgModal(); });

    document.addEventListener('click', (e)=>{
      const img = e.target.closest('img.zoomable'); if(img){ openImgModal(img.src); return; }
      const btn = e.target.closest('[data-role]'); if(!btn) return;

      // 제외 토글
      if (btn.dataset.role === 'ex-toggle'){
        const pill = btn.closest('label.pill'); if(!pill) return;
        const isEx = pill.getAttribute('data-excluded') === '1';
        pill.setAttribute('data-excluded', isEx ? '0' : '1');
        btn.textContent = isEx ? '제외' : '제외됨';
        btn.classList.toggle('active', !isEx);
        return;
      }

      // 사진/영수증 삭제
      if (btn.dataset.role === 'del-photo-existing'){ const i = +btn.dataset.i; editorPhotos.splice(i,1); renderPhotoPreview(); return; }
      if (btn.dataset.role === 'del-photo-new'){ const i = +btn.dataset.i; newPhotoFiles.splice(i,1); renderPhotoPreview(); return; }
      if (btn.dataset.role === 'del-receipt-existing'){ const rIdx=+btn.dataset.idx, i=+btn.dataset.i; (editorReceipts[rIdx]||[]).splice(i,1); const roundEl=$$('.round')[rIdx]; if(roundEl) renderReceiptPreview(roundEl); return; }
      if (btn.dataset.role === 'del-receipt-new'){ const rIdx=+btn.dataset.idx, i=+btn.dataset.i; (newReceiptFiles[rIdx]||[]).splice(i,1); const roundEl=$$('.round')[rIdx]; if(roundEl) renderReceiptPreview(roundEl); return; }
    });

    /* 초기화 */
    renderList(); show(viewList);
  </script>
</body>
</html>
