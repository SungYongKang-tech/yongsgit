<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë‚¨ë™3ê¸° ë™ê¸°ëª¨ì„</title>
  <style>
    :root { --primary:#2b6cb0; --muted:#f5f7fb; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; margin: 0; background: #fafafa; color:#222; }
    header { position: sticky; top:0; z-index:5; background:#fff; border-bottom:1px solid #e5e7eb; }
    .bar { max-width: 1100px; margin: 0 auto; padding: 16px 14px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .bar h1 { font-size: clamp(18px, 4.5vw, 22px); margin: 0; text-align: center; }
    .bar .actions { display:flex; gap:6px; flex-wrap:wrap; }

    button, .btn { appearance:none; border:1px solid #cbd5e1; background:#fff; color:#111; padding: 8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    button.primary, .btn.primary { background: var(--primary); color:#fff; border-color: var(--primary); }
    main { max-width: 1100px; margin: 0 auto; padding: 14px; }

    .card { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:14px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .grid { display:grid; gap:12px; }
    .grid-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    @media (max-width: 900px) { .grid-3{grid-template-columns:1fr;} }
    @media (max-width: 700px) { .grid-2{grid-template-columns:1fr;} }

    label { display:block; font-weight:600; margin: 6px 0 4px; }
    input[type="text"], input[type="number"], input[type="date"] { width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; }

    .attendee-list { display:flex; flex-wrap:wrap; gap:8px; background:#f5f7fb; padding:10px; border-radius:10px; }
    .attendee-list .pill { display:inline-flex; align-items:center; gap:6px; background:#fff; border:1px solid #e5e7eb; padding:6px 10px; border-radius:20px; }
    .attendee-list .pill[data-excluded="1"] { opacity:.6; }
    .ex-toggle { border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:3px 6px; font-size:12px; cursor:pointer; }
    .ex-toggle.active { background:#fee2e2; }

    .round { border:1px dashed #d1d5db; border-radius:12px; padding:12px; background:#fcfcfe; }
    .preview-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .preview-row img { height:88px; border-radius:10px; border:1px solid #e5e7eb; }

    table { width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:auto; display:block; }
    th, td { border:1px solid #e5e7eb; padding:10px; text-align:center; white-space:nowrap; }
    thead th { background:#f8fafc; }

    .list-row { display:grid; grid-template-columns: 1fr 120px; gap:12px; align-items:center; padding:12px; border-bottom:1px solid #eee; }
    .list-row:hover { background:#fafcff; }
    .list-head { font-weight:800; color:#475569; grid-template-columns: 1fr 120px; }
    .info-date a { color:var(--primary); font-weight:800; text-decoration:none; }
    .info-title { font-weight:700; margin-top:4px; }
    .info-meta { color:#6b7280; font-size:14px; margin-top:2px; }
    .thumb { width:112px; height:78px; object-fit:cover; border-radius:10px; border:1px solid #e5e7eb; background:#f1f5f9; display:block; margin-left:auto; }
    .thumb.placeholder { display:flex; align-items:center; justify-content:center; font-size:12px; color:#94a3b8; border-style:dashed; width:112px; height:78px; border-radius:10px; border:1px dashed #e5e7eb; margin-left:auto; }
    @media (max-width:700px) { .list-row { grid-template-columns: 1fr; } .thumb, .thumb.placeholder { margin-left:0; width:100%; height:160px; } }

    .paid { color:#16a34a; font-weight:800; }
    .unpaid { color:#dc2626; font-weight:800; }
    .muted { color:#6b7280; }
    .hidden { display:none; }

    .capture-wrap { background:#fff; padding:12px; border-radius:14px; border:1px solid #e5e7eb; }

    .lightbox { position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,.85); display: flex; align-items: center; justify-content: center; padding: 16px; }
    .lightbox.hidden { display: none; }
    .lightbox img { max-width: min(92vw, 1200px); max-height: 92vh; border-radius: 12px; box-shadow: 0 8px 40px rgba(0,0,0,.6); user-select: none; }
    .lightbox .close-btn { position: absolute; top: 10px; right: 10px; border: none; background: rgba(255,255,255,.15); color: #fff; font-size: 28px; line-height: 1; border-radius: 10px; padding: 6px 12px; cursor: pointer; }

    .saving { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,.45); z-index: 99999; color: #fff; font-weight: 700; }
    .saving.hidden { display: none; }
    .saving .box { background:#111; padding:16px 20px; border-radius:12px; }

    textarea { width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; font-family:inherit; }
    .note-block { margin-top:10px; padding:10px; background:#fffbe6; border:1px solid #facc15; border-radius:10px; }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <h1>ë‚¨ë™3ê¸° ë™ê¸°ëª¨ì„</h1>
      <div class="actions">
        <button class="btn" id="btnList">ëª©ë¡</button>
        <button class="btn" id="btnNew">ìƒˆ íšŒì‹</button>
        <button class="btn" id="btnAdminLogin">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
        <button class="btn" id="btnAdminLogout" style="display:none;">ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ</button>
        <button class="btn" id="btnAlbum">ì‚¬ì§„ì²©</button>

      </div>
    </div>
  </header>

  <main>
    <!-- ëª©ë¡ í™”ë©´ -->
    <section id="view-list" class="grid">
      <div class="card">
      
      
        <p class="muted" style="text-align:center; margin:8px 0;">
      ğŸ“… ë‚ ì§œë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸ ë‚´ìš©ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </p>
        
        
        
        <div class="list-row list-head"></div>
        <div id="listBody"></div>
        <p class="muted" id="emptyNote" style="display:none; padding:10px 2px;">
          ì•„ì§ ì €ì¥ëœ íšŒì‹ì´ ì—†ìŠµë‹ˆë‹¤. â€œìƒˆ íšŒì‹â€ì„ ëˆŒëŸ¬ ì…ë ¥í•œ í›„ ì €ì¥í•˜ì„¸ìš”.
        </p>
      </div>
    </section>

    <!-- ì‘ì„±/í¸ì§‘ í™”ë©´ -->
    <section id="view-editor" class="grid hidden">
      <div class="card">
        <div class="grid grid-3">
          <div>
            <label>íšŒì‹ ë‚ ì§œ</label>
            <input type="date" id="meetingDate">
          </div>
          <div>
            <label>ì œëª©</label>
            <input type="text" id="meetingTitle" placeholder="ì˜ˆ: 3ì›” íšŒì‹">
          </div>
          <div>
            <label>ì¥ì†Œ</label>
            <input type="text" id="meetingPlace" placeholder="ì˜ˆ: ì§„ì£¼ â—‹â—‹ì‹ë‹¹">
          </div>
        </div>

        <div style="margin-top:10px;">
          <button class="btn" onclick="addRound()">ì°¨ìˆ˜ ì¶”ê°€</button>
          <button class="btn" id="btnAddMember">ë‰´ë©¤ë²„ ì¶”ê°€</button>
        </div>

        <!-- âœ… ì˜ìˆ˜ì¦ ì¼ê´„ ì—…ë¡œë“œ -->
        <div style="margin-top:12px;">
          <label>ì˜ìˆ˜ì¦ ì¼ê´„ ì—…ë¡œë“œ (ì—¬ëŸ¬ ì¥)</label>
          <input type="file" accept="image/*" id="allReceiptsInput" multiple>
          <div id="allReceiptPreview" class="preview-row" style="margin-top:6px;"></div>
        </div>

        <div id="rounds" style="margin-top:12px;" class="grid"></div>

        <!-- ì‚¬ì§„(ëª¨ì„ ì „ì²´) -->
        <div style="margin-top:12px;">
          <label>íšŒì‹ ì‚¬ì§„ ì—…ë¡œë“œ (ì—¬ëŸ¬ ì¥)</label>
          <input type="file" accept="image/*" id="groupPhoto" multiple>
          <div id="photoPreview" class="preview-row" style="margin-top:6px;"></div>
        </div>

        <div style="margin-top:12px;">
          <label>ë¹„ê³ </label>
          <textarea id="settleNote" rows="3"></textarea>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;">
          <button class="btn primary" id="btnSave">ì´ íšŒì‹ ì €ì¥</button>
          <button class="btn" id="btnPreview">ì •ì‚°í‘œ ë¯¸ë¦¬ë³´ê¸°</button>
        </div>

        <div id="editorPreview" class="card hidden" style="margin-top:12px;">
          <div class="section-title">ì •ì‚°í‘œ ë¯¸ë¦¬ë³´ê¸°</div>
          <div id="editorSummary"></div>
        </div>
      </div>
    </section>

    <!-- ìƒì„¸ í™”ë©´ -->
    <section id="view-detail" class="grid hidden">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
          <div>
            <div id="detailTitle" style="font-weight:900; font-size:18px;"></div>
            <div class="muted" id="detailMeta"></div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn" id="btnBackToList">ëª©ë¡ìœ¼ë¡œ</button>
            <button class="btn" id="btnDelete">ì‚­ì œ</button>
            <button class="btn" id="btnCapture">ì´ë¯¸ì§€ë¡œ ì €ì¥</button>
            <button class="btn" id="btnEdit">ìˆ˜ì •í•˜ê¸°</button>
          </div>
        </div>

        <div id="detailWrap" class="capture-wrap" style="margin-top:12px;">
          <div id="detailSummary"></div>

          <div style="margin-top:16px;">
            <div class="section-title">ì˜ìˆ˜ì¦</div>
            <div id="detailReceipts" class="preview-row"></div>
          </div>

          <div style="margin-top:16px;">
            <div class="section-title">ì‚¬ì§„</div>
            <div id="detailPhotos" class="preview-row"></div>
          </div>

          <div style="margin-top:16px;">
            <div class="section-title">ì…ê¸ˆ í™•ì¸</div>
            <div id="detailPaid"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- ì €ì¥ ì˜¤ë²„ë ˆì´ -->
  <div id="savingOverlay" class="saving hidden">
    <div class="box">ì €ì¥ ì¤‘â€¦ <span id="savingText">ì¤€ë¹„</span></div>
  </div>

  <!-- ë¼ì´íŠ¸ë°•ìŠ¤ -->
  <div id="imgModal" class="lightbox hidden" aria-modal="true" role="dialog">
    <img id="imgModalImg" alt="í™•ëŒ€ ì´ë¯¸ì§€" />
    <button type="button" class="close-btn" id="imgModalClose" aria-label="ë‹«ê¸°">Ã—</button>
  </div>

  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Firebase (App/DB/Auth) -->
  <script type="module">
    /************ Imports ************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, signInAnonymously, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    /************ Cloudinary ************/
    const CLOUD_NAME = 'dqpcvlakz';
    const UPLOAD_PRESET = 'koen3pay';
    const CLD_DELIVERY_BASE = `https://res.cloudinary.com/${CLOUD_NAME}/image/upload`;

    /************ Firebase ************/
    const firebaseConfig = {
      apiKey: "AIzaSyBmVXt2ze1iJmmA_YI-sgH3tJmSvZomkOo",
      authDomain: "ionic6-3b7b2.firebaseapp.com",
      databaseURL: "https://ionic6-3b7b2-default-rtdb.firebaseio.com",
      projectId: "ionic6-3b7b2",
      storageBucket: "ionic6-3b7b2.appspot.com",
      messagingSenderId: "306251113324",
      appId: "1:306251113324:web:456c689fdb4757adc18949"
    };

    const app  = initializeApp(firebaseConfig);
    const db   = getDatabase(app);
    const auth = getAuth(app);

    // í—¤ë” ë¡œê·¸ì¸ ìƒíƒœ
    const whoEl = document.createElement('div');
    whoEl.className = 'muted'; whoEl.style.fontSize = '12px'; whoEl.style.marginLeft = 'auto';
    document.querySelector('.bar').appendChild(whoEl);

    let IS_ADMIN = false;
    function updateWho(u){
      if(!u){ whoEl.textContent = 'ë¡œê·¸ì¸ ì•ˆ ë¨ (ìµëª…)'; return; }
      whoEl.textContent = `${u.email || 'ìµëª…'} ${IS_ADMIN ? '(ê´€ë¦¬ì)' : ''} Â· uid:${u.uid.slice(0,8)}â€¦`;
    }

document.getElementById('btnAlbum').onclick = ()=> {
  location.href = 'album.html';
};


    // ë²„íŠ¼ í•¸ë“¤ëŸ¬
    const loginBtn  = document.getElementById('btnAdminLogin');
    const logoutBtn = document.getElementById('btnAdminLogout');

    loginBtn.onclick = async () => {
      const email = prompt('ê´€ë¦¬ì ì´ë©”ì¼');
      const pw    = prompt('ë¹„ë°€ë²ˆí˜¸');
      if (!email || !pw) return;
      try { await signInWithEmailAndPassword(auth, email, pw); alert('ê´€ë¦¬ì ë¡œê·¸ì¸ ì™„ë£Œ!'); }
      catch(e){ alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + (e.message || e)); }
    };

    logoutBtn.onclick = async () => {
      try { await signOut(auth); alert('ê´€ë¦¬ìì—ì„œ ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.'); }
      catch(e){ alert('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ' + (e.message || e)); }
    };

    let uiInited = false;
    onAuthStateChanged(auth, async (u) => {
      if (u) {
        try {
          const s = await get(ref(db, `admins/${u.uid}`));
          IS_ADMIN = s.exists() && s.val() === true;
        } catch { IS_ADMIN = false; }
      } else {
        IS_ADMIN = false;
        try { await signInAnonymously(auth); } catch {}
      }
      updateWho(u);
      loginBtn.style.display  = IS_ADMIN ? 'none' : '';
      logoutBtn.style.display = IS_ADMIN ? '' : 'none';

      if (!uiInited && u) { initUI(); uiInited = true; }
    });

    async function ensureAuth(){
      if (auth.currentUser) return auth.currentUser;
      const cred = await signInAnonymously(auth);
      return cred.user;
    }

    /************ ìœ í‹¸/ìƒìˆ˜ ************/
    const $  = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const defaultAttendees = ["ì„±ìš©","ë²”ì¤€","ê¸°í˜„","ìŠ¹í˜¸","ì¬í™˜","ì°½í˜„","ê³„ë¯¼","ì¸ì°¬","ì •ì„ ","í˜„ì •","ì •ë¡","ì˜í™”","ì¬í™”","ì›ìš©","ìœ¤ìˆ™","ì¸ìˆ˜"];
    const LS_KEY = 'nd3-attendees';
    function esc(s){ return String(s).replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }

    function loadAttendees(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return [...defaultAttendees];
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) return Array.from(new Set([...defaultAttendees, ...arr]));
        return [...defaultAttendees];
      }catch{ return [...defaultAttendees]; }
    }
    function saveAttendees(){
      try{
        const added = allAttendees.filter(n => !defaultAttendees.includes(n));
        localStorage.setItem(LS_KEY, JSON.stringify(added));
      }catch{}
    }
    let allAttendees = loadAttendees();

    let isEditing = false, editingId = null;
    let editorPhotos = [], newPhotoFiles = [];
    let editorReceipts = {}, newReceiptFiles = {};     // ë¼ìš´ë“œë³„
    let editorOverrides = {};                           // ë¼ìš´ë“œë³„ ê°œë³„ê¸ˆì•¡
    // âœ… í†µí•© ì˜ìˆ˜ì¦ (ì¼ê´„ ì—…ë¡œë“œìš©)
    let globalReceiptsExisting = []; // ê¸°ì¡´ ì €ì¥ë˜ì–´ ìˆë˜ í†µí•© ì˜ìˆ˜ì¦ URLë“¤
    let globalReceiptFiles = [];     // ìƒˆë¡œ ì¶”ê°€ë  íŒŒì¼ë“¤

    async function getAllMeetings() {
      const snap = await get(ref(db, 'meetings'));
      const obj = snap.exists() ? snap.val() : {};
      return Object.values(obj).sort((a,b)=> (b.date||'').localeCompare(a.date||''));
    }
    async function getMeetingById(id){ const snap = await get(ref(db, `meetings/${id}`)); return snap.exists() ? snap.val() : null; }
    async function saveMeetingToDB(meeting){ await set(ref(db, `meetings/${meeting.id}`), meeting); }
    async function deleteMeetingFromDB(id){ await remove(ref(db, `meetings/${id}`)); }
    async function updatePaidStatus(id, paidStatus){ await update(ref(db, `meetings/${id}`), { paidStatus }); }

    /************ ì´ë¯¸ì§€ ì²˜ë¦¬/ì—…ë¡œë“œ ************/
    const MAX_BYTES = 2 * 1024 * 1024;
    function showSaving(msg){ $('#savingText').textContent = msg || 'ì²˜ë¦¬ ì¤‘'; $('#savingOverlay').classList.remove('hidden'); }
    function setSaving(msg){ $('#savingText').textContent = msg; }
    function hideSaving(){ $('#savingOverlay').classList.add('hidden'); }

    function loadImage(src){ return new Promise((resolve,reject)=>{ const img = new Image(); img.onload=()=>resolve(img); img.onerror=reject; img.src=src; }); }
    async function drawToCanvas(src, maxW){
      async function bitmapToCanvas(bmp, maxW){
        const s = Math.min(1, maxW / bmp.width);
        const w = Math.max(1, Math.round(bmp.width * s));
        const h = Math.max(1, Math.round(bmp.height * s));
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(bmp, 0, 0, w, h);
        try { bmp.close && bmp.close(); } catch(_){}
        return canvas;
      }
      if (src instanceof File) {
        try { const bmp = await createImageBitmap(src); return await bitmapToCanvas(bmp, maxW); }
        catch(e){}
      }
      const url = (typeof src === 'string') ? src : URL.createObjectURL(src);
      const img = await loadImage(url);
      const s = Math.min(1, maxW / img.width);
      const w = Math.max(1, Math.round(img.width * s));
      const h = Math.max(1, Math.round(img.height * s));
      const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
      if (typeof src !== 'string') { try { URL.revokeObjectURL(url); } catch(_){} }
      return canvas;
    }
    function canvasToBlob(canvas, quality=0.82, type='image/jpeg'){ return new Promise((resolve)=> canvas.toBlob(b=>resolve(b), type, quality)); }
    async function compressWithLimit(fileOrDataURL, {maxW, qualityStart=0.82, minQuality=0.55, step=0.07}){
      try {
        const src = fileOrDataURL;
        let q = qualityStart, w = maxW, lastBlob = null;
        for (let attempt = 0; attempt < 6; attempt++){
          const canvas = await drawToCanvas(src, w);
          const blob   = await canvasToBlob(canvas, q);
          lastBlob = blob;
          if (blob.size <= MAX_BYTES) return blob;
          if (q > minQuality) q = Math.max(minQuality, q - step);
          else { w = Math.round(w * 0.85); if (w < 480) return blob; }
        }
        return lastBlob;
      } catch (e) {
        if (fileOrDataURL instanceof File) return fileOrDataURL;
        throw e;
      }
    }
    function randomId(){ return Math.random().toString(36).slice(2,10); }

    function xhrUpload(url, formData, onProgress){
      return new Promise((resolve, reject)=>{
        const xhr = new XMLHttpRequest();
        xhr.open('POST', url);
        xhr.onload = ()=> { try { resolve(JSON.parse(xhr.responseText)); } catch(e){ reject(e); } };
        xhr.onerror = ()=> reject(new Error('upload-error'));
        if (xhr.upload && onProgress){
          xhr.upload.onprogress = (e)=>{ if (e.lengthComputable) onProgress(Math.round((e.loaded/e.total)*100)); };
        }
        xhr.send(formData);
      });
    }
    async function uploadToCloudinary(blobOrFile, folder, onProgress){
      const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
      const publicId = `${Date.now()}_${randomId()}`;
      const fd = new FormData();
      fd.append('file', blobOrFile);
      fd.append('upload_preset', UPLOAD_PRESET);
      fd.append('folder', folder);
      fd.append('public_id', publicId);

      const res = await xhrUpload(url, fd, onProgress);
      const pid = res.public_id;
      const fmt = res.format || 'jpg';
      const full  = res.secure_url || `${CLD_DELIVERY_BASE}/${pid}.${fmt}`;
      const thumb = `${CLD_DELIVERY_BASE}/c_limit,w_320,f_auto,q_auto/${pid}.${fmt}`;
      return { full, thumb };
    }
    async function uploadPhotoSet(meetingId, file, index, total){
      setSaving(`ì‚¬ì§„ ${index}/${total} ì¤€ë¹„`);
      const blob = await compressWithLimit(file, { maxW: 1600, qualityStart: 0.82 });
      setSaving(`ì‚¬ì§„ ì—…ë¡œë“œ ${index}/${total} (ì „ì†¡ ì¤‘â€¦)`);
      return await uploadToCloudinary(blob, `meetings/${meetingId}/photos`, (p)=> setSaving(`ì‚¬ì§„ ì—…ë¡œë“œ ${index}/${total} (${p}%)`));
    }
    async function uploadReceipt(meetingId, file, index, total){
      setSaving(`ì˜ìˆ˜ì¦ ${index}/${total} ì¤€ë¹„`);
      const blob = await compressWithLimit(file, { maxW: 1200, qualityStart: 0.8 });
      setSaving(`ì˜ìˆ˜ì¦ ì—…ë¡œë“œ ${index}/${total} (ì „ì†¡ ì¤‘â€¦)`);
      const r = await uploadToCloudinary(blob, `meetings/${meetingId}/receipts`, (p)=> setSaving(`ì˜ìˆ˜ì¦ ì—…ë¡œë“œ ${index}/${total} (${p}%)`));
      return r.full; // ì˜ìˆ˜ì¦ì€ ì›ë³¸ URLë§Œ ì‚¬ìš©
    }

    /************ í™”ë©´ ì „í™˜ ************/
    const viewList = $('#view-list'), viewEditor = $('#view-editor'), viewDetail = $('#view-detail');
    function show(id){ [viewList,viewEditor,viewDetail].forEach(v=>v.classList.add('hidden')); id.classList.remove('hidden'); window.scrollTo({top:0, behavior:'smooth'}); }

    $('#btnList').onclick = ()=> { renderList(); show(viewList); /* ëª©ë¡ ë²„íŠ¼ì€ íˆìŠ¤í† ë¦¬ ê±´ë“œë¦¬ì§€ ì•ŠìŒ */ };
    $('#btnNew').onclick  = ()=> { resetEditor(); show(viewEditor); /* ì—ë””í„° íˆìŠ¤í† ë¦¬ëŠ” ì´ë²ˆ ìš”êµ¬ì‚¬í•­ ë²”ìœ„ ë°– */ };

    /************ ë¦¬ìŠ¤íŠ¸ ************/
    async function renderList(){
      const list = await getAllMeetings();
      const body = $('#listBody'); body.innerHTML=''; $('#emptyNote').style.display = list.length ? 'none' : 'block';
      list.forEach(item=>{
        const unique = new Set(item.rounds.flatMap(r=>r.attendees||[]));
        let thumbSrc = null;
        if (item.photos && item.photos[0]){
          const p = item.photos[0];
          thumbSrc = typeof p === 'string' ? p : (p.thumb || p.full);
        }
        const row = document.createElement('div'); row.className='list-row';
        row.innerHTML = `
          <div>
            <div class="info-date"><a href="#" data-id="${item.id}" class="link-date">${item.date||'-'}</a></div>
            <div class="info-title">${item.title||'-'}</div>
            <div class="info-meta">ì°¸ì„ ${unique.size.toLocaleString('ko-KR')}ëª… Â· ì¥ì†Œ ${item.place||'-'}</div>
          </div>
          <div>${thumbSrc ? `<img src="${thumbSrc}" alt="íšŒì‹ ì¸ë„¤ì¼" class="thumb zoomable" loading="lazy">` : `<div class="thumb placeholder">ì‚¬ì§„ì—†ìŒ</div>`}</div>
        `;
        body.appendChild(row);
      });
      $$('.link-date', body).forEach(a=> a.onclick = (e)=>{ e.preventDefault(); openDetail(a.dataset.id); });
    }

    /************ ì—ë””í„° ************/
    function resetEditor(){
      isEditing=false; editingId=null;
      editorPhotos=[]; newPhotoFiles=[];
      editorReceipts={}; newReceiptFiles={};
      editorOverrides = {};
      globalReceiptsExisting = []; globalReceiptFiles = [];

      $('#meetingDate').value=''; $('#meetingTitle').value=''; $('#meetingPlace').value='';
      $('#settleNote').value='';
      $('#rounds').innerHTML=''; $('#groupPhoto').value=''; $('#photoPreview').innerHTML='';
      $('#allReceiptsInput').value=''; $('#allReceiptPreview').innerHTML='';
      $('#editorPreview').classList.add('hidden'); $('#editorSummary').innerHTML='';
      addRound();
    }

    function addRound(){
      const container = document.createElement('div');
      const idx = $$('.round').length;
      container.className='round'; container.dataset.idx=String(idx);
      editorReceipts[idx]=editorReceipts[idx]||[]; newReceiptFiles[idx]=newReceiptFiles[idx]||[];

      container.innerHTML = `
        <div class="section-title">${idx+1}ì°¨</div>
        <div class="grid grid-3">
          <div>
            <label>ê¸ˆì•¡(ì›)</label>
            <input type="number" class="amount" min="0" placeholder="ì˜ˆ: 150000">
            <label style="margin-top:6px;">
              <input type="checkbox" class="corpCard"> ì´ ì°¨ìˆ˜ëŠ” ë²•ì¸ì¹´ë“œ(ê°œì¸ ì •ì‚° ì—†ìŒ)
            </label>

            <div style="margin-top:8px; display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
              <button type="button" class="btn" data-role="open-overrides">ê°œë³„ ê¸ˆì•¡ ì¡°ì •</button>
              <span class="muted" data-role="overrides-summary"></span>
            </div>
            <div class="card hidden" data-role="overrides-panel" style="margin-top:6px; padding:10px;">
              <div class="muted" data-role="overrides-info" style="margin-bottom:6px;"></div>
              <div data-role="overrides-list"></div>
              <div class="muted" data-role="overrides-foot" style="margin-top:6px;"></div>
              <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;">
                <button type="button" class="btn" data-role="overrides-apply">ì ìš©</button>
                <button type="button" class="btn" data-role="overrides-clear">ëª¨ë‘ ì§€ìš°ê¸°</button>
                <button type="button" class="btn" data-role="overrides-close">ë‹«ê¸°</button>
              </div>
            </div>
          </div>
          <div>
            <label>ì˜ìˆ˜ì¦ ì—…ë¡œë“œ(ì„ íƒ)</label>
            <input type="file" accept="image/*" class="receiptInput" multiple>
          </div>
          <div>
            <label class="muted">ì˜ìˆ˜ì¦ ë¯¸ë¦¬ë³´ê¸°</label>
            <div class="receiptPreview preview-row"></div>
          </div>
        </div>
        <div style="margin-top:8px;">
          <div class="section-title">ì°¸ì„ì (í•„ìš” ì‹œ â€˜ì œì™¸â€™ í† ê¸€)</div>
          <div class="attendee-list"></div>
        </div>`;

      $('#rounds').appendChild(container);
      updateAttendeeListFor(container);

      // ë¼ìš´ë“œë³„ ì˜ìˆ˜ì¦ í”„ë¦¬ë·°
      $('.receiptInput', container).addEventListener('change', (e)=>{
        const files = Array.from(e.target.files || []);
        const rIdx = parseInt(container.dataset.idx, 10);
        newReceiptFiles[rIdx].push(...files);
        renderReceiptPreview(container);
        e.target.value = '';
      });
      renderReceiptPreview(container);

      // ë²•ì¸ì¹´ë“œ í† ê¸€
      $('.corpCard', container).addEventListener('change', (e)=>{
        const amountEl = $('.amount', container);
        if (e.target.checked){ amountEl.value=''; amountEl.disabled=true; amountEl.placeholder='ë²•ì¸ì¹´ë“œ - ê¸ˆì•¡ì…ë ¥ ë¶ˆí•„ìš”'; }
        else { amountEl.disabled=false; amountEl.placeholder='ì˜ˆ: 150000'; }
      });

      // ê°œë³„ê¸ˆì•¡ íŒ¨ë„
      const panel = $('[data-role="overrides-panel"]', container);
      const summary = $('[data-role="overrides-summary"]', container);
      summary.textContent = buildOverridesSummary(container);

      $('[data-role="open-overrides"]', container).onclick = ()=>{ renderOverridesPanel(container); panel.classList.remove('hidden'); };
      $('[data-role="overrides-apply"]', container).onclick = ()=>{
        const rIdx = +container.dataset.idx;
        editorOverrides[rIdx] = editorOverrides[rIdx] || {};
        $$('input[data-role="ov-input"]', panel).forEach(inp=>{
          const name = inp.dataset.name; const v = inp.value.trim();
          if (v === '' || isNaN(+v) || +v <= 0) delete editorOverrides[rIdx][name];
          else editorOverrides[rIdx][name] = Math.round(+v);
        });
        summary.textContent = buildOverridesSummary(container);
        panel.classList.add('hidden');
      };
      $('[data-role="overrides-clear"]', container).onclick = ()=>{
        const rIdx = +container.dataset.idx;
        editorOverrides[rIdx] = {};
        renderOverridesPanel(container);
        summary.textContent = '';
      };
      $('[data-role="overrides-close"]', container).onclick = ()=> panel.classList.add('hidden');

      // ê¸ˆì•¡ ë³€ê²½ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì¦‰ì‹œ ê°±ì‹ 
      $('.amount', container).addEventListener('input', ()=>{
        if (!panel.classList.contains('hidden')) renderOverridesPanel(container);
      });
      summary.textContent = buildOverridesSummary(container);
    }

    function updateAttendeeListFor(roundEl){
      const div = $('.attendee-list', roundEl);
      const prevChecked  = $$('input[data-role="attend"]:checked', div).map(el => el.value);
      const prevExcluded = $$('label.pill[data-excluded="1"]', div).map(el => el.dataset.name);

      div.innerHTML = allAttendees.map(n => {
        const checked  = prevChecked.includes(n) ? 'checked' : '';
        const excluded = prevExcluded.includes(n) ? ' data-excluded="1"' : '';
        const exText   = prevExcluded.includes(n) ? 'ì œì™¸ë¨' : 'ì œì™¸';
        return `
          <label class="pill"${excluded} data-name="${n}">
            <input type="checkbox" data-role="attend" value="${n}" ${checked}> ${n}
            <button type="button" class="ex-toggle${prevExcluded.includes(n)?' active':''}" data-role="ex-toggle" data-name="${n}">${exText}</button>
          </label>`;
      }).join('');

      $$('input[data-role="attend"]', div).forEach(cb => {
        cb.addEventListener('change', () => {
          const panel = $('[data-role="overrides-panel"]', roundEl);
          if (panel && !panel.classList.contains('hidden')) renderOverridesPanel(roundEl);
          const sumEl = $('[data-role="overrides-summary"]', roundEl);
          if (sumEl) sumEl.textContent = buildOverridesSummary(roundEl);
        });
      });
    }

    function renderReceiptPreview(roundEl){
      const rIdx = parseInt(roundEl.dataset.idx,10);
      const box = roundEl.querySelector('.receiptPreview'); box.innerHTML='';

      (editorReceipts[rIdx]||[]).forEach((src,i)=>{
        const viewSrc = typeof src === 'string' ? src : (src.thumb || src.full || src);
        const wrap = document.createElement('div'); wrap.className='preview-row';
        const img = document.createElement('img'); img.src=viewSrc; img.alt='ì˜ìˆ˜ì¦'; img.classList.add('zoomable');
        const btn = document.createElement('button'); btn.className='ex-toggle'; btn.textContent='ì‚­ì œ';
        btn.dataset.role='del-receipt-existing'; btn.dataset.idx=String(rIdx); btn.dataset.i=String(i);
        wrap.appendChild(img); wrap.appendChild(btn); box.appendChild(wrap);
      });

      (newReceiptFiles[rIdx]||[]).forEach((file,i)=>{
        const url = URL.createObjectURL(file);
        const wrap = document.createElement('div'); wrap.className='preview-row';
        const img = document.createElement('img'); img.src=url; img.alt='ì˜ìˆ˜ì¦(ì‹ ê·œ)'; img.classList.add('zoomable');
        const btn = document.createElement('button'); btn.className='ex-toggle'; btn.textContent='ì‚­ì œ';
        btn.dataset.role='del-receipt-new'; btn.dataset.idx=String(rIdx); btn.dataset.i=String(i);
        wrap.appendChild(img); wrap.appendChild(btn); box.appendChild(wrap);
        img.onload = ()=> URL.revokeObjectURL(url);
      });
    }

    // âœ… í†µí•© ì˜ìˆ˜ì¦ í”„ë¦¬ë·°
    $('#allReceiptsInput').addEventListener('change', (e)=>{
      const files = Array.from(e.target.files || []);
      globalReceiptFiles.push(...files);
      renderGlobalReceiptPreview();
      e.target.value = '';
    });
    function renderGlobalReceiptPreview(){
      const box = $('#allReceiptPreview'); box.innerHTML='';
      globalReceiptsExisting.forEach((url, i)=>{
        const wrap = document.createElement('div'); wrap.className='preview-row';
        const img = document.createElement('img'); img.src=url; img.alt='ì˜ìˆ˜ì¦(ê¸°ì¡´)'; img.classList.add('zoomable');
        const btn = document.createElement('button'); btn.className='ex-toggle'; btn.textContent='ì‚­ì œ';
        btn.dataset.role='del-global-receipt-existing'; btn.dataset.i=String(i);
        wrap.appendChild(img); wrap.appendChild(btn); box.appendChild(wrap);
      });
      globalReceiptFiles.forEach((file, i)=>{
        const url = URL.createObjectURL(file);
        const wrap = document.createElement('div'); wrap.className='preview-row';
        const img = document.createElement('img'); img.src=url; img.alt='ì˜ìˆ˜ì¦(ì‹ ê·œÂ·í†µí•©)'; img.classList.add('zoomable');
        const btn = document.createElement('button'); btn.className='ex-toggle'; btn.textContent='ì‚­ì œ';
        btn.dataset.role='del-global-receipt-new'; btn.dataset.i=String(i);
        wrap.appendChild(img); wrap.appendChild(btn); box.appendChild(wrap);
        img.onload = ()=> URL.revokeObjectURL(url);
      });
    }

    // ì‚¬ì§„ ì—…ë¡œë“œ(ëª¨ì„ ì „ì²´)
    $('#groupPhoto').addEventListener('change', (e)=>{
      const files = Array.from(e.target.files || []);
      newPhotoFiles.push(...files);
      renderPhotoPreview();
      e.target.value = '';
    });
    function renderPhotoPreview(){
      const box = $('#photoPreview'); box.innerHTML='';
      editorPhotos.forEach((src,i)=>{
        const viewSrc = (typeof src === 'string') ? src : (src.thumb || src.full);
        const wrap = document.createElement('div'); wrap.className='preview-row';
        const img = document.createElement('img'); img.src=viewSrc; img.alt='ì‚¬ì§„'; img.classList.add('zoomable');
        const btn = document.createElement('button'); btn.className='ex-toggle'; btn.textContent='ì‚­ì œ'; btn.dataset.role='del-photo-existing'; btn.dataset.i=String(i);
        wrap.appendChild(img); wrap.appendChild(btn); box.appendChild(wrap);
      });
      newPhotoFiles
        .filter(f => f instanceof Blob)
        .forEach((file,i)=>{
          const url = URL.createObjectURL(file);
          const wrap = document.createElement('div'); wrap.className='preview-row';
          const img = document.createElement('img'); img.src=url; img.alt='ì‚¬ì§„(ì‹ ê·œ)'; img.classList.add('zoomable');
          const btn = document.createElement('button'); btn.className='ex-toggle'; btn.textContent='ì‚­ì œ';
          btn.dataset.role='del-photo-new'; btn.dataset.i=String(i);
          wrap.appendChild(img); wrap.appendChild(btn); box.appendChild(wrap);
          img.onload = ()=> URL.revokeObjectURL(url);
        });
    }

    // ë¯¸ë¦¬ë³´ê¸°
    $('#btnPreview').onclick = ()=>{
      const dummy = buildSummaryFromEditor(); if(!dummy) return;
      $('#editorSummary').innerHTML = dummy.html; $('#editorPreview').classList.remove('hidden');
    };

    function buildSummaryFromEditor(){
      const roundEls = $$('.round'); if(!roundEls.length){ alert('ì°¨ìˆ˜ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.'); return null; }
      const roundTitles = roundEls.map((_,i)=>`${i+1}ì°¨`);
      const memberMap = {};
      for(let i=0;i<roundEls.length;i++){
        const el = roundEls[i];
        const corp = $('.corpCard', el).checked;
        const amountRaw = $('.amount', el).value.trim();
        const amount = amountRaw === '' ? null : parseInt(amountRaw,10);
        const checked = $$('input[data-role="attend"]:checked', el).map(v=>v.value);
        const excluded = $$('label.pill[data-excluded="1"]', el).map(l=>l.dataset.name).filter(n=>checked.includes(n));
        const included = checked.filter(n=>!excluded.includes(n));
        if (!corp && amount && included.length>0){
          const { shares } = calcShares(amount, included, editorOverrides[i] || {});
          Object.entries(shares).forEach(([n, won])=>{
            if(!memberMap[n]) memberMap[n]={ total:0, rounds:[] };
            memberMap[n].rounds[i] = won;
            memberMap[n].total += won;
          });
        }
      }
      const rows = Object.entries(memberMap).sort((a,b)=>a[0].localeCompare(b[0],'ko'));
      let html = `<table><thead><tr><th>ì´ë¦„</th>${roundTitles.map(r=>`<th>${r}</th>`).join('')}<th>ì´ì•¡</th></tr></thead><tbody>`;
      rows.forEach(([name,data])=>{
        html += `<tr><td>${name}</td>`;
        for(let i=0;i<roundTitles.length;i++){
          const v = data.rounds[i] ? Math.round(data.rounds[i]).toLocaleString('ko-KR')+'ì›' : '-';
          html += `<td>${v}</td>`;
        }
        html += `<td><strong>${Math.round(data.total).toLocaleString('ko-KR')}ì›</strong></td></tr>`;
      });
      html += `</tbody></table>`;

      const note = $('#settleNote').value.trim();
      if (note) html += `<div class="note-block">${esc(note).replace(/\n/g,'<br>')}</div>`;
      return { html, count: rows.length };
    }

    // ì €ì¥
    $('#btnSave').onclick = async ()=>{
      try {
        if (!IS_ADMIN) { alert('ê´€ë¦¬ìë§Œ ì €ì¥í•  ìˆ˜ ìˆì–´ìš”. ìƒë‹¨ì˜ [ê´€ë¦¬ì ë¡œê·¸ì¸]ì„ ëˆŒëŸ¬ ë¡œê·¸ì¸í•˜ì„¸ìš”.'); throw new Error('not-admin'); }

        const btn = $('#btnSave'); btn.disabled = true; btn.textContent = 'ì €ì¥ ì¤‘â€¦';
        showSaving('ì¤€ë¹„ ì¤‘â€¦');
        await ensureAuth();

        const date  = $('#meetingDate').value;
        const title = $('#meetingTitle').value.trim();
        const place = $('#meetingPlace').value.trim();
        const note  = ($('#settleNote')?.value || '').trim();
        if(!date || !title){ alert('ë‚ ì§œì™€ ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); throw new Error('required'); }

        const meetingId = isEditing ? editingId : Date.now().toString();

        // ë¼ìš´ë“œ ìƒì„±
        const roundEls = $$('.round');
        if(!roundEls.length){ alert('ì°¨ìˆ˜ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.'); throw new Error('no rounds'); }

        const rounds = [];
        for(let i=0;i<roundEls.length;i++){
          const el = roundEls[i];
          const corp = $('.corpCard', el).checked;
          const amountRaw = $('.amount', el).value.trim();
          const amount = amountRaw === '' ? null : parseInt(amountRaw,10);
          const attendees = $$('input[data-role="attend"]:checked', el).map(cb=>cb.value);
          if(!attendees.length){ alert(`${i+1}ì°¨ ì°¸ì„ìë¥¼ ì„ íƒí•˜ì„¸ìš”.`); throw new Error('no attendees'); }
          const exclusions = $$('label.pill[data-excluded="1"]', el).map(l=>l.dataset.name).filter(n=>attendees.includes(n));
          rounds.push({
            amount, attendees, exclusions, corp,
            receiptImages: [],
            overrides: editorOverrides[i] || {}
          });
        }

        // ì‚¬ì§„ ì—…ë¡œë“œ
        const photos = [];
        editorPhotos.forEach(p=>{
          if (typeof p === 'string') photos.push(p);
          else photos.push({full: p.full, thumb: p.thumb || p.full});
        });
        for(let i=0;i<newPhotoFiles.length;i++){
          const result = await uploadPhotoSet(meetingId, newPhotoFiles[i], i+1, newPhotoFiles.length);
          photos.push(result);
        }

        // âœ… í†µí•© ì˜ìˆ˜ì¦ ì—…ë¡œë“œ
        const receiptsTop = [...globalReceiptsExisting]; // ê¸°ì¡´ í†µí•© ì˜ìˆ˜ì¦ ìœ ì§€
        const perRoundFilesCount = Object.values(newReceiptFiles).reduce((acc,arr)=> acc + (arr?.length||0), 0) || 0;
        const totalReceipts = (globalReceiptFiles.length || 0) + perRoundFilesCount;

        let uploaded = 0;
        // 1) í†µí•© ì—…ë¡œë“œ ìš°ì„ 
        for (let i=0;i<globalReceiptFiles.length;i++){
          const url = await uploadReceipt(meetingId, globalReceiptFiles[i], ++uploaded, totalReceipts);
          receiptsTop.push(url);
        }
        // 2) ë¼ìš´ë“œë³„ ê¸°ì¡´/ì‹ ê·œ (í˜¸í™˜ì„± ìœ ì§€)
        for(let r=0;r<rounds.length;r++){
          (editorReceipts[r]||[]).forEach(u=>{
            if (typeof u === 'string') rounds[r].receiptImages.push(u);
            else rounds[r].receiptImages.push(u.full || u.thumb);
          });
          const files = newReceiptFiles[r] || [];
          for (let i=0;i<files.length;i++){
            const url = await uploadReceipt(meetingId, files[i], ++uploaded, totalReceipts);
            rounds[r].receiptImages.push(url);
          }
        }

        // ì…ê¸ˆìƒíƒœ
        let paidStatus = {};
        if(!isEditing){
          const people = Array.from(new Set(rounds.flatMap(r=> r.attendees.filter(n=> !(r.exclusions||[]).includes(n)) )));
          paidStatus = Object.fromEntries(people.map(n=>[n,false]));
        }

        // ìµœì¢… ë°ì´í„°
        let data = { id: meetingId, date, title, place, note, rounds, photos, paidStatus };
        // âœ… í†µí•© ì˜ìˆ˜ì¦ í•„ë“œ ì¶”ê°€
        if (receiptsTop.length) data.receipts = receiptsTop;

        // ìˆ˜ì • ëª¨ë“œ: paidStatus ë³‘í•©
        if (isEditing) {
          const old = await getMeetingById(editingId);
          if (!old) throw new Error('ê¸°ì¡´ ë°ì´í„° ì—†ìŒ');
          const newIncluded = Array.from(new Set(
            data.rounds.flatMap(r=> r.attendees.filter(n=> !(r.exclusions||[]).includes(n)))
          ));
          const merged = {};
          newIncluded.forEach(n=>{ merged[n] = (old.paidStatus && n in old.paidStatus) ? old.paidStatus[n] : false; });
          data.paidStatus = merged;
        }

        await saveMeetingToDB(data);
        alert(isEditing ? 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        await renderList(); show(viewList);
        // ëª©ë¡ ìƒíƒœë¡œ ìŠ¤í…Œì´íŠ¸ ì •ë¦¬
        history.replaceState({ view: 'list' }, '', location.href);
        resetEditor();

      } catch (e) {
        console.error(e);
        alert(`ì €ì¥ ì‹¤íŒ¨: ${e.code || e.name || ''}\n${e.message || e}`);
      } finally {
        hideSaving();
        const btn = $('#btnSave'); btn.disabled = false; btn.textContent = 'ì´ íšŒì‹ ì €ì¥';
      }
    };

    /************ ìƒì„¸/ì…ê¸ˆ/ì‚­ì œ ************/
    async function openDetail(id){
      const item = await getMeetingById(id);
      if(!item){ alert('ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      $('#detailTitle').textContent = item.title||'(ì œëª© ì—†ìŒ)';
      const uniqueCnt = new Set(item.rounds.flatMap(r=>r.attendees)).size;
      $('#detailMeta').textContent = `${item.date||'-'} Â· ì°¸ì„ ${uniqueCnt.toLocaleString('ko-KR')}ëª… Â· ì¥ì†Œ ${item.place||'-'}`;

      $('#detailSummary').innerHTML = buildSummaryHTML(item);

      // âœ… ì˜ìˆ˜ì¦: í†µí•©ì´ ìˆìœ¼ë©´ ê·¸ê±¸ë¡œ, ì—†ìœ¼ë©´ ë¼ìš´ë“œë³„ í•©ì³ì„œ
      const recWrap = $('#detailReceipts'); recWrap.innerHTML='';
      const receiptList = (item.receipts && item.receipts.length)
        ? item.receipts
        : item.rounds.flatMap((r)=> (r.receiptImages||[]));
      receiptList.forEach((src, idx)=>{
        const viewSrc = (typeof src === 'string') ? src : (src.full || src.thumb || src);
        const img=document.createElement('img'); img.src=viewSrc; img.alt=`ì˜ìˆ˜ì¦ ${idx+1}`; img.classList.add('zoomable');
        recWrap.appendChild(img);
      });

      const pWrap = $('#detailPhotos'); pWrap.innerHTML='';
      (item.photos||[]).forEach((p, idx)=>{
        const viewSrc = (typeof p === 'string') ? p : (p.full || p.thumb);
        const img=document.createElement('img'); img.src=viewSrc; img.alt=`íšŒì‹ ì‚¬ì§„ ${idx+1}`; img.classList.add('zoomable');
        pWrap.appendChild(img);
      });

      renderPaidTable(item);

      // â€œëª©ë¡ìœ¼ë¡œâ€ ë²„íŠ¼ â†’ ë’¤ë¡œê°€ê¸°ì™€ ë™ì¼ UX
      $('#btnBackToList').onclick = ()=> { history.back(); };

      $('#btnDelete').onclick = async ()=>{
        if(!IS_ADMIN){ return alert('ê´€ë¦¬ìë§Œ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”.'); }
        if(!confirm('ì´ íšŒì‹ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?')) return;
        await deleteMeetingFromDB(id);
        await renderList(); show(viewList);
        history.replaceState({ view: 'list' }, '', location.href);
      };
      $('#btnCapture').onclick = ()=> captureElement(
        $('#detailSummary'),
        `ì •ì‚°ê²°ê³¼_${item.date||'íšŒì‹'}-${(item.title||'').replace(/[\\/:*?"<>|]/g,'')}.png`
      );
      $('#btnEdit').onclick = ()=> startEdit(id);

      show(viewDetail);

      // âœ… ë’¤ë¡œê°€ë©´ ëª©ë¡ìœ¼ë¡œ ë³µê·€í•˜ë„ë¡ detail ìƒíƒœ push
      history.pushState({ view: 'detail', id }, '', location.href);
    }

    function buildSummaryHTML(item){
      const roundTitles = item.rounds.map((_,i)=>`${i+1}ì°¨`);
      const memberMap = {};
      item.rounds.forEach((r, idx) => {
        const included = (r.attendees||[]).filter(n => !(r.exclusions||[]).includes(n));
        if (!r.corp && r.amount && included.length > 0) {
          const { shares } = calcShares(r.amount || 0, included, r.overrides || {});
          Object.entries(shares).forEach(([name, won]) => {
            if (!memberMap[name]) memberMap[name] = { total: 0, rounds: [] };
            memberMap[name].rounds[idx] = won;
            memberMap[name].total += won;
          });
        }
      });

      const entries = Object.entries(memberMap).sort((a,b)=>a[0].localeCompare(b[0],'ko'));
      let html = `<div class="section-title">ì •ì‚° ê²°ê³¼</div>`;
      html += `<table><thead><tr><th>ì´ë¦„</th>${roundTitles.map(r=>`<th>${r}</th>`).join('')}<th>ì´ì•¡</th></tr></thead><tbody>`;
      entries.forEach(([name,data])=>{
        html += `<tr><td>${name}</td>`;
        for (let i=0;i<roundTitles.length;i++){
          const v = data.rounds[i] ? Math.round(data.rounds[i]).toLocaleString('ko-KR')+'ì›' : '-';
          html += `<td>${v}</td>`;
        }
        html += `<td><strong>${Math.round(data.total).toLocaleString('ko-KR')}ì›</strong></td></tr>`;
      });
      html += `</tbody></table>`;
      if (item.note) html += `<div class="note-block">${esc(item.note).replace(/\n/g,'<br>')}</div>`;
      return html;
    }

    function renderPaidTable(item){
      const totals = {};
      item.rounds.forEach((r) => {
        const included = (r.attendees||[]).filter(n => !(r.exclusions||[]).includes(n));
        if (!r.corp && r.amount && included.length > 0) {
          const { shares } = calcShares(r.amount || 0, included, r.overrides || {});
          Object.entries(shares).forEach(([name, won]) => {
            totals[name] = (totals[name] || 0) + won;
          });
        }
      });

      const names = Object.keys(totals).sort((a,b)=>a.localeCompare(b,'ko'));
      const wrap = $('#detailPaid');
      let html = `<table><thead><tr><th>ì´ë¦„</th><th>ì´ì•¡</th><th>ì…ê¸ˆ ìƒíƒœ</th></tr></thead><tbody>`;
      names.forEach(n=>{
        const paid = !!item.paidStatus?.[n];
        html += `<tr>
          <td>${n}</td>
          <td>${Math.round(totals[n]).toLocaleString('ko-KR')}ì›</td>
          <td><button class="${paid?'paid':'unpaid'}" data-name="${n}" data-id="${item.id}">
            ${paid?'í™•ì¸ë¨':'ë¯¸ì…ê¸ˆ'}
          </button></td>
        </tr>`;
      });
      html += `</tbody></table>`;
      wrap.innerHTML = html;

      $$('button[data-name]', wrap).forEach(btn=>{
        btn.onclick = async ()=>{
          if(!IS_ADMIN){ return alert('ê´€ë¦¬ìë§Œ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”.'); }
          const id = btn.dataset.id, name = btn.dataset.name;
          const fresh = await getMeetingById(id);
          const next = { ...(fresh.paidStatus||{}) };
          next[name] = !next[name];
          await updatePaidStatus(id, next);
          renderPaidTable({ ...fresh, paidStatus: next });
        };
      });
    }

    function startEdit(id){
      getMeetingById(id).then(item=>{
        if(!item){ alert('ìˆ˜ì •í•  ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); return; }
        isEditing=true; editingId=id;

        editorOverrides = {};
        const allNames = Array.from(new Set(item.rounds.flatMap(r=>r.attendees)));
        allNames.forEach(n=>{ if(!allAttendees.includes(n)) allAttendees.push(n); });

        $('#meetingDate').value=item.date||'';
        $('#meetingTitle').value=item.title||'';
        $('#meetingPlace').value=item.place||'';
        $('#settleNote').value = item.note || '';
        editorPhotos=[...(item.photos||[])];
        newPhotoFiles=[];
        $('#rounds').innerHTML='';
        editorReceipts={}; newReceiptFiles={};

        // âœ… í†µí•© ì˜ìˆ˜ì¦ ë¡œë“œ
        globalReceiptsExisting = Array.isArray(item.receipts) ? [...item.receipts] : [];
        globalReceiptFiles = [];
        renderGlobalReceiptPreview();

        item.rounds.forEach((r,i)=>{
          addRound();
          const roundEl  = $$('.round')[i];
          const amountEl = $('.amount', roundEl);
          const corpEl   = $('.corpCard', roundEl);

          amountEl.value = (r.amount??'') === null ? '' : (r.amount??'');
          corpEl.checked = !!r.corp;
          if (corpEl.checked){
            amountEl.value=''; amountEl.disabled=true; amountEl.placeholder='ë²•ì¸ì¹´ë“œ - ê¸ˆì•¡ì…ë ¥ ë¶ˆí•„ìš”';
          }

          editorReceipts[i]   = [...(r.receiptImages||[])];
          newReceiptFiles[i]  = [];
          editorOverrides[i]  = { ...(r.overrides || {}) };
          renderReceiptPreview(roundEl);

          updateAttendeeListFor(roundEl);
          const labels = $$('label.pill', roundEl);
          labels.forEach(lbl=>{
            const name = lbl.dataset.name;
            const cb = $('input[data-role="attend"]', lbl);
            cb.checked = r.attendees.includes(name);
            if ((r.exclusions||[]).includes(name)){
              lbl.setAttribute('data-excluded','1');
              const btn = $('[data-role="ex-toggle"]', lbl);
              if(btn){ btn.textContent='ì œì™¸ë¨'; btn.classList.add('active'); }
            }
          });

          const sumEl = $('[data-role="overrides-summary"]', roundEl);
          if (sumEl) sumEl.textContent = buildOverridesSummary(roundEl);
        });

        renderPhotoPreview();
        show(viewEditor);
      });
    }

    /************ ìº¡ì²˜ ************/
    async function captureElement(el, filename='ì •ì‚°ê²°ê³¼.png'){
      const canvas = await html2canvas(el,{ scale:2, useCORS:true, backgroundColor:'#fff',
        windowWidth: el.scrollWidth, windowHeight: el.scrollHeight, scrollX:0, scrollY:-window.scrollY });
      const link = document.createElement('a'); link.download=filename; link.href=canvas.toDataURL('image/png'); link.click();
    }
    window.captureElement = captureElement;

    /************ ë¼ì´íŠ¸ë°•ìŠ¤(ì¢Œìš° ë„˜ê¹€/ìŠ¤ì™€ì´í”„ + íˆìŠ¤í† ë¦¬ ì—°ë™) ************/
    const imgModal = $('#imgModal'), imgModalImg = $('#imgModalImg'), imgModalClose = $('#imgModalClose');

    // í˜„ì¬ ê°¤ëŸ¬ë¦¬ ì»¨í…ìŠ¤íŠ¸
    let galleryNodes = []; // í˜„ì¬ ì»¨í…Œì´ë„ˆ ë‚´ì˜ ì´ë¯¸ì§€ ë…¸ë“œ ëª©ë¡
    let galleryIndex = 0;

    function openImgModalFrom(container, startNode){
      galleryNodes = Array.from(container.querySelectorAll('img.zoomable'));
      galleryIndex = Math.max(0, galleryNodes.indexOf(startNode));
      if (!galleryNodes.length) return;

      // âœ… ë¼ì´íŠ¸ë°•ìŠ¤ ì „ìš© íˆìŠ¤í† ë¦¬ ìŠ¤íƒ ì¶”ê°€
      history.pushState({ lightbox: true }, '', location.href);

      showGalleryImage();
      imgModal.classList.remove('hidden');
      document.body.style.overflow='hidden';
    }
    function showGalleryImage(){
      const node = galleryNodes[galleryIndex];
      if (!node) return;
      imgModalImg.src = node.src;
    }
    function closeImgModal(opts = { fromPop: false }){
      imgModal.classList.add('hidden');
      imgModalImg.src='';
      document.body.style.overflow='';

      // X ë²„íŠ¼ ë“±ìœ¼ë¡œ ë‹«ì•˜ì„ ë• íˆìŠ¤í† ë¦¬ í•œ ì¹¸ ë˜ëŒë ¤ì„œ ìŠ¤íƒ ì •ë¦¬
      if (!opts.fromPop && history.state && history.state.lightbox) {
        history.back();
      }
    }
    function nextImg(){ if (!galleryNodes.length) return; galleryIndex = (galleryIndex+1) % galleryNodes.length; showGalleryImage(); }
    function prevImg(){ if (!galleryNodes.length) return; galleryIndex = (galleryIndex-1+galleryNodes.length) % galleryNodes.length; showGalleryImage(); }

    imgModalClose.addEventListener('click', ()=> closeImgModal());
    imgModal.addEventListener('click', e=>{ if(e.target===imgModal) closeImgModal(); });
    document.addEventListener('keydown', e=>{
      if (imgModal.classList.contains('hidden')) return;
      if (e.key === 'Escape') closeImgModal();
      if (e.key === 'ArrowRight') nextImg();
      if (e.key === 'ArrowLeft') prevImg();
    });

    // í„°ì¹˜ ìŠ¤ì™€ì´í”„
    let touchStartX = 0, touchEndX = 0;
    imgModal.addEventListener('touchstart', (e)=>{ touchStartX = e.changedTouches[0].screenX; }, {passive:true});
    imgModal.addEventListener('touchend', (e)=>{
      touchEndX = e.changedTouches[0].screenX;
      const dx = touchEndX - touchStartX;
      if (Math.abs(dx) > 40) { if (dx < 0) nextImg(); else prevImg(); }
    }, {passive:true});

    // ì´ë¯¸ì§€ í´ë¦­ ì‹œ: ìê¸° ì„¹ì…˜(ì˜ìˆ˜ì¦ or ì‚¬ì§„) ì»¨í…Œì´ë„ˆ ë²”ìœ„ ì•ˆì—ì„œ ê°¤ëŸ¬ë¦¬ êµ¬ì„±
    document.addEventListener('click', (e)=>{
      const img = e.target.closest('img.zoomable');
      if (img) {
        const section = img.closest('#detailReceipts, #detailPhotos') || document;
        openImgModalFrom(section, img);
        return;
      }
      const btn = e.target.closest('[data-role]');
      if(!btn) return;

      // í† ê¸€/ì‚­ì œ í•¸ë“¤ëŸ¬ë“¤
      if (btn.dataset.role === 'ex-toggle'){
        const pill = btn.closest('label.pill'); if(!pill) return;
        const isEx = pill.getAttribute('data-excluded') === '1';
        pill.setAttribute('data-excluded', isEx ? '0' : '1');
        btn.textContent = isEx ? 'ì œì™¸' : 'ì œì™¸ë¨';
        btn.classList.toggle('active', !isEx);

        const roundEl = btn.closest('.round');
        const panel = $('[data-role="overrides-panel"]', roundEl);
        if (panel && !panel.classList.contains('hidden')) renderOverridesPanel(roundEl);
        const sumEl = $('[data-role="overrides-summary"]', roundEl);
        if (sumEl) sumEl.textContent = buildOverridesSummary(roundEl);
        return;
      }
      if (btn.dataset.role === 'del-photo-existing'){ const i = +btn.dataset.i; editorPhotos.splice(i,1); renderPhotoPreview(); return; }
      if (btn.dataset.role === 'del-photo-new'){ const i = +btn.dataset.i; newPhotoFiles.splice(i,1); renderPhotoPreview(); return; }
      if (btn.dataset.role === 'del-receipt-existing'){ const rIdx=+btn.dataset.idx, i=+btn.dataset.i; (editorReceipts[rIdx]||[]).splice(i,1); const roundEl=$$('.round')[rIdx]; if(roundEl) renderReceiptPreview(roundEl); return; }
      if (btn.dataset.role === 'del-receipt-new'){ const rIdx=+btn.dataset.idx, i=+btn.dataset.i; (newReceiptFiles[rIdx]||[]).splice(i,1); const roundEl=$$('.round')[rIdx]; if(roundEl) renderReceiptPreview(roundEl); return; }

      // âœ… í†µí•© ì˜ìˆ˜ì¦ ì‚­ì œ
      if (btn.dataset.role === 'del-global-receipt-existing'){ const i = +btn.dataset.i; globalReceiptsExisting.splice(i,1); renderGlobalReceiptPreview(); return; }
      if (btn.dataset.role === 'del-global-receipt-new'){ const i = +btn.dataset.i; globalReceiptFiles.splice(i,1); renderGlobalReceiptPreview(); return; }
    });

    /************ ë’¤ë¡œê°€ê¸°(popstate) í†µí•© ì²˜ë¦¬ ************/
    window.addEventListener('popstate', async () => {
      // 1) ë¼ì´íŠ¸ë°•ìŠ¤ê°€ ì—´ë ¤ ìˆìœ¼ë©´ â†’ ë‹«ê³  ë
      if (!imgModal.classList.contains('hidden')) {
        closeImgModal({ fromPop: true });
        return;
      }
      // 2) ìƒì„¸ í™”ë©´ì´ ë³´ì´ëŠ” ì¤‘ì´ë©´ â†’ ëª©ë¡ìœ¼ë¡œ ì „í™˜
      if (!viewDetail.classList.contains('hidden')) {
        await renderList();
        show(viewList);
        // ëª©ë¡ ìƒíƒœë¡œ ìŠ¤í…Œì´íŠ¸ ì •ë¦¬
        history.replaceState({ view: 'list' }, '', location.href);
        return;
      }
      // 3) ë‚˜ë¨¸ì§€(ëª©ë¡/ì—ë””í„°)ëŠ” ê¸°ë³¸ ë™ì‘ ê·¸ëŒ€ë¡œ
    });

    function initUI(){
      $('#btnCapture').onclick = ()=> captureElement($('#detailSummary'), 'ì •ì‚°ê²°ê³¼.png');
      renderList(); show(viewList);

      // âœ… í˜„ì¬ í˜ì´ì§€ë¥¼ 'ëª©ë¡' ìƒíƒœë¡œ ê³ ì •
      history.replaceState({ view: 'list' }, '', location.href);
    }

    /************ ë¶„ë°° ê³„ì‚°/íŒ¨ë„ ************/
    function calcShares(amount, included, overrides = {}) {
      const fixed = Object.entries(overrides)
        .filter(([n,v]) => included.includes(n) && Number.isFinite(+v) && +v > 0)
        .map(([n,v]) => [n, Math.round(+v)]);
      const sumFixed = fixed.reduce((a, [,v]) => a + v, 0);
      const rest = included.filter(n => !fixed.find(([k]) => k === n));
      const shares = {};
      fixed.forEach(([n,v]) => shares[n] = v);
      const remainTotal = Math.max(0, Math.round(amount) - sumFixed);
      const restCount = rest.length;
      if (restCount > 0) {
        const base = Math.floor(remainTotal / restCount);
        let rem = remainTotal % restCount;
        const sortedRest = [...rest].sort((a,b)=> a.localeCompare(b,'ko'));
        sortedRest.forEach((n,i) => { shares[n] = base + (i < rem ? 1 : 0); });
      }
      const warn = (sumFixed > Math.round(amount));
      return { shares, warn, sumFixed, remainTotal };
    }

    function renderOverridesPanel(roundEl){
      const rIdx = +roundEl.dataset.idx;
      const panel = $('[data-role="overrides-panel"]', roundEl);
      const listBox = $('[data-role="overrides-list"]', panel);
      const info = $('[data-role="overrides-info"]', panel);
      const foot = $('[data-role="overrides-foot"]', panel);

      const amount = +($('.amount', roundEl).value || 0);
      const checked = $$('input[data-role="attend"]:checked', roundEl).map(v=>v.value);
      const excluded = $$('label.pill[data-excluded="1"]', roundEl).map(l=>l.dataset.name).filter(n=>checked.includes(n));
      const included = checked.filter(n=>!excluded.includes(n));

      const ov = editorOverrides[rIdx] || {};
      listBox.innerHTML = included.map(n=>{
        const v = ov[n] ?? '';
        return `
          <div style="display:flex; align-items:center; gap:8px; margin:4px 0;">
            <div style="width:80px;">${n}</div>
            <input type="number" data-role="ov-input" data-name="${n}" value="${v}" placeholder="ê³ ì •ê¸ˆì•¡(ì›)" style="flex:1; padding:8px; border:1px solid #cbd5e1; border-radius:8px;">
          </div>`;
      }).join('') || '<div class="muted">ì°¸ì„ìë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.</div>';

      const { shares, warn, sumFixed, remainTotal } = calcShares(amount, included, ov);
      info.innerHTML = `ì´ì•¡ <b>${(amount||0).toLocaleString('ko-KR')}ì›</b> Â· ê³ ì •í•©ê³„ <b>${sumFixed.toLocaleString('ko-KR')}ì›</b> Â· ë‚¨ëŠ”ê¸ˆì•¡ <b>${remainTotal.toLocaleString('ko-KR')}ì›</b>` + (warn ? ' <span style="color:#dc2626;font-weight:700;">(ê³ ì •í•©ê³„ê°€ ì´ì•¡ì„ ì´ˆê³¼!)</span>' : '');
      const rows = Object.entries(shares).sort((a,b)=>a[0].localeCompare(b[0],'ko')).map(([n,v])=>`${n}: ${v.toLocaleString('ko-KR')}ì›`);
      foot.textContent = rows.join(' Â· ');
    }

    function buildOverridesSummary(roundEl){
      const rIdx = +roundEl.dataset.idx;
      const amount = +($('.amount', roundEl).value || 0);
      const checked = $$('input[data-role="attend"]:checked', roundEl).map(v=>v.value);
      const excluded = $$('label.pill[data-excluded="1"]', roundEl).map(l=>l.dataset.name).filter(n=>checked.includes(n));
      const included = checked.filter(n=>!excluded.includes(n));
      const ov = editorOverrides[rIdx] || {};
      const { shares, warn } = calcShares(amount, included, ov);
      const cnt = Object.keys(shares).length;
      if (!cnt) return '';
      return `ê°œë³„ ì¡°ì • ${Object.keys(ov).length}ëª… ì ìš©${warn ? ' (ì´ˆê³¼ ê²½ê³ )' : ''}`;
    }

    // ì „ì—­ ë…¸ì¶œ
    window.addRound = addRound;
  </script>
</body>
</html>
