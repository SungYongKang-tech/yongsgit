<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>남동3기 회식비 정산</title>
  <style>
    :root { --primary:#2b6cb0; --muted:#f5f7fb; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; margin: 0; background: #fafafa; color:#222; }
    header { position: sticky; top:0; z-index:5; background:#fff; border-bottom:1px solid #e5e7eb; }
    .bar {
      max-width: 1100px; margin: 0 auto; padding: 10px 14px;
      display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .bar h1 { font-size: clamp(18px, 4.5vw, 22px); margin:0; }
    .bar .actions { display:flex; gap:6px; flex-wrap:wrap; }
    button, .btn {
      appearance:none; border:1px solid #cbd5e1; background:#fff; color:#111;
      padding: 8px 12px; border-radius:10px; cursor:pointer; font-weight:600;
    }
    button.primary, .btn.primary { background: var(--primary); color:#fff; border-color: var(--primary); }
    button.ghost { background:transparent; border-color:transparent; color:var(--primary); }
    main { max-width: 1100px; margin: 0 auto; padding: 14px; }

    /* 카드/섹션 */
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:14px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .grid { display:grid; gap:12px; }
    .grid-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    @media (max-width: 900px) { .grid-3{grid-template-columns:1fr;} }
    @media (max-width: 700px) { .grid-2{grid-template-columns:1fr;} }

    label { display:block; font-weight:600; margin: 6px 0 4px; }
    input[type="text"], input[type="number"], input[type="date"] {
      width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px; background:#fff;
    }

    .attendee-list { display:flex; flex-wrap:wrap; gap:8px; background:var(--muted); padding:10px; border-radius:10px; }
    .attendee-list label { font-weight:500; background:#fff; border:1px solid #e5e7eb; padding:6px 10px; border-radius:20px; }
    .section-title { font-size:16px; font-weight:800; margin:6px 0 8px; }

    .round { border:1px dashed #d1d5db; border-radius:12px; padding:12px; background:#fcfcfe; }
    .preview-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .preview-row img { height:88px; border-radius:10px; border:1px solid #e5e7eb; }
    .mini-del {
      border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:3px 6px; font-size:12px; cursor:pointer;
    }

    table { width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:auto; display:block; }
    th, td { border:1px solid #e5e7eb; padding:10px; text-align:center; white-space:nowrap; }
    thead th { background:#f8fafc; }

    /* 목록(2열 레이아웃) */
    .list-row {
      display:grid; grid-template-columns: 1fr 120px; gap:12px; align-items:center;
      padding:12px; border-bottom:1px solid #eee;
    }
    .list-row:hover { background:#fafcff; }
    .list-head { font-weight:800; color:#475569; grid-template-columns: 1fr 120px; }
    .info-date a { color:var(--primary); font-weight:800; text-decoration:none; }
    .info-title { font-weight:700; margin-top:4px; }
    .info-meta { color:#6b7280; font-size:14px; margin-top:2px; }

    .thumb {
      width:112px; height:78px; object-fit:cover; border-radius:10px; border:1px solid #e5e7eb; background:#f1f5f9; display:block; margin-left:auto;
    }
    .thumb.placeholder {
      display:flex; align-items:center; justify-content:center; font-size:12px; color:#94a3b8; border-style:dashed;
    }
    @media (max-width:700px) {
      .list-row { grid-template-columns: 1fr; }
      .thumb { margin-left:0; width:100%; height:160px; }
    }

    .paid { color:#16a34a; font-weight:800; }
    .unpaid { color:#dc2626; font-weight:800; }
    .muted { color:#6b7280; }

    .hidden { display:none; }

    /* 캡처 영역 보정 */
    .capture-wrap { background:#fff; padding:12px; border-radius:14px; border:1px solid #e5e7eb; }

    /* === 이미지 라이트박스 === */
    .lightbox {
      position: fixed; inset: 0; z-index: 9999;
      background: rgba(0,0,0,.85);
      display: flex; align-items: center; justify-content: center;
      padding: 16px;
    }
    .lightbox.hidden { display: none; }
    .lightbox img {
      max-width: min(92vw, 1200px);
      max-height: 92vh;
      border-radius: 12px;
      box-shadow: 0 8px 40px rgba(0,0,0,.6);
      user-select: none;
    }
    .lightbox .close-btn {
      position: absolute; top: 10px; right: 10px;
      border: none; background: rgba(255,255,255,.15);
      color: #fff; font-size: 28px; line-height: 1;
      border-radius: 10px; padding: 6px 12px; cursor: pointer;
    }
    .lightbox .close-btn:hover { background: rgba(255,255,255,.25); }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <h1>남동3기 회식비 정산</h1>
      <div class="actions">
        <button class="btn" id="btnList">목록</button>
        <button class="btn" id="btnNew">새 회식</button>
        <button class="btn" id="btnExport">내보내기</button>
        <label class="btn" for="importFile" style="margin:0;">가져오기</label>
        <input id="importFile" type="file" accept="application/json" class="hidden">
      </div>
    </div>
  </header>

  <main>
    <!-- 목록 화면 -->
    <section id="view-list" class="grid">
      <div class="card">
        <div class="list-row list-head">
          <div>정보</div><div style="text-align:right;">사진</div>
        </div>
        <div id="listBody"></div>
        <p class="muted" id="emptyNote" style="display:none; padding:10px 2px;">아직 저장된 회식이 없습니다. “새 회식”을 눌러 입력한 후 저장하세요.</p>
      </div>
    </section>

    <!-- 작성/편집 화면 -->
    <section id="view-editor" class="grid hidden">
      <div class="card">
        <div class="grid grid-3">
          <div>
            <label>회식 날짜</label>
            <input type="date" id="meetingDate">
          </div>
          <div>
            <label>제목</label>
            <input type="text" id="meetingTitle" placeholder="예: 3월 회식">
          </div>
          <div>
            <label>장소</label>
            <input type="text" id="meetingPlace" placeholder="예: 진주 ○○식당">
          </div>
        </div>

        <div style="margin-top:8px;">
          <label>참석자 추가</label>
          <div class="grid grid-2">
            <input type="text" id="newAttendee" placeholder="이름 입력">
            <button class="btn" onclick="addAttendee()">이름 추가</button>
          </div>
        </div>

        <div style="margin-top:10px;">
          <button class="btn" onclick="addRound()">차수 추가</button>
        </div>

        <div id="rounds" style="margin-top:12px;" class="grid"></div>

        <div style="margin-top:12px;">
          <label>회식 사진 업로드 (여러 장)</label>
          <input type="file" accept="image/*" id="groupPhoto" multiple>
          <div id="photoPreview" class="preview-row" style="margin-top:6px;"></div>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;">
          <button class="btn primary" id="btnSave">이 회식 저장</button>
          <button class="btn" id="btnPreview">정산표 미리보기</button>
        </div>

        <div id="editorPreview" class="card hidden" style="margin-top:12px;">
          <div class="section-title">정산표 미리보기</div>
          <div id="editorSummary"></div>
        </div>
      </div>
    </section>

    <!-- 상세 화면 -->
    <section id="view-detail" class="grid hidden">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
          <div>
            <div id="detailTitle" style="font-weight:900; font-size:18px;"></div>
            <div class="muted" id="detailMeta"></div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn" id="btnBackToList">목록으로</button>
            <button class="btn" id="btnDelete">삭제</button>
            <button class="btn" id="btnCapture">이미지로 저장</button>
            <button class="btn" id="btnEdit">수정하기</button>
          </div>
        </div>

        <div id="detailWrap" class="capture-wrap" style="margin-top:12px;">
          <div id="detailSummary"></div>

          <div style="margin-top:16px;">
            <div class="section-title">영수증</div>
            <div id="detailReceipts" class="preview-row"></div>
          </div>

          <div style="margin-top:16px;">
            <div class="section-title">사진</div>
            <div id="detailPhotos" class="preview-row"></div>
          </div>

          <div style="margin-top:16px;">
            <div class="section-title">입금 확인</div>
            <div id="detailPaid"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- 이미지 라이트박스 -->
  <div id="imgModal" class="lightbox hidden" aria-modal="true" role="dialog">
    <img id="imgModalImg" alt="확대 이미지" />
    <button type="button" class="close-btn" id="imgModalClose" aria-label="닫기">×</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    /***************
     * 간단한 “DB”
     ***************/
    const LS_KEY = 'koen_meetings_v2';
    const defaultAttendees = ["성용","범준","기현","승호","재환","창현","계민","인찬","정선","현정","정록","영화","재화","원용","윤숙","인수"];
    let allAttendees = [...defaultAttendees];

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function loadDB() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch { return []; }
    }
    function saveDB(list) { localStorage.setItem(LS_KEY, JSON.stringify(list)); }

    /*****************
     * 편집 상태 관리
     *****************/
    let isEditing = false;
    let editingId = null;
    let editorPhotos = [];       // 기존 사진(DataURL)
    let newPhotoFiles = [];      // 새 업로드 파일들
    let editorReceipts = {};     // { roundIdx: [DataURL, ...] }
    let newReceiptFiles = {};    // { roundIdx: [File, ...] }

    /*****************
     * 네비 & 화면 전환
     *****************/
    const viewList   = $('#view-list');
    const viewEditor = $('#view-editor');
    const viewDetail = $('#view-detail');

    function show(id) {
      [viewList, viewEditor, viewDetail].forEach(v => v.classList.add('hidden'));
      id.classList.remove('hidden');
      window.scrollTo({top:0, behavior:'smooth'});
    }

    $('#btnList').onclick = ()=> { renderList(); show(viewList); };
    $('#btnNew').onclick  = ()=> { resetEditor(); show(viewEditor); };
    $('#btnExport').onclick = ()=> {
      const blob = new Blob([JSON.stringify(loadDB(), null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = '남동3기-회식정산-백업.json';
      a.click();
      URL.revokeObjectURL(a.href);
    };
    $('#importFile').onchange = async (e)=>{
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();
      try {
        const data = JSON.parse(text);
        if (!Array.isArray(data)) throw new Error('형식 오류');
        saveDB(data);
        renderList();
        show(viewList);
        alert('가져오기가 완료되었습니다.');
      } catch(err) {
        alert('가져오기 실패: ' + err.message);
      } finally {
        e.target.value = '';
      }
    };

    /*****************
     * 목록 랜더링 (2열, 우측 썸네일)
     *****************/
    function renderList() {
      const list = loadDB().sort((a,b)=> (b.date||'').localeCompare(a.date||''));
      const body = $('#listBody');
      body.innerHTML = '';
      $('#emptyNote').style.display = list.length ? 'none' : 'block';

      list.forEach(item=>{
        const unique = new Set(item.rounds.flatMap(r=>r.attendees || []));
        const thumbSrc = (item.photos && item.photos[0]) ? item.photos[0] : null;

        const row = document.createElement('div');
        row.className = 'list-row';
        row.innerHTML = `
          <div>
            <div class="info-date"><a href="#" data-id="${item.id}" class="link-date">${item.date || '-'}</a></div>
            <div class="info-title">${item.title || '-'}</div>
            <div class="info-meta">참석 ${unique.size.toLocaleString('ko-KR')}명 · 장소 ${item.place || '-'}</div>
          </div>
          <div>
            ${thumbSrc
              ? `<img src="${thumbSrc}" alt="회식 썸네일" class="thumb zoomable">`
              : `<div class="thumb placeholder">사진없음</div>`}
          </div>
        `;
        body.appendChild(row);
      });

      $$('.link-date', body).forEach(a=>{
        a.onclick = (e)=>{ e.preventDefault(); openDetail(a.dataset.id); };
      });
    }

    /*****************
     * 작성/편집 화면
     *****************/
    function resetEditor() {
      isEditing = false;
      editingId = null;
      editorPhotos = [];
      newPhotoFiles = [];
      editorReceipts = {};
      newReceiptFiles = {};

      $('#meetingDate').value = '';
      $('#meetingTitle').value = '';
      $('#meetingPlace').value = '';
      $('#rounds').innerHTML = '';
      $('#groupPhoto').value = '';
      renderPhotoPreview(); // 빈 상태 반영
      $('#editorPreview').classList.add('hidden');
      $('#editorSummary').innerHTML = '';

      addRound();
    }

    function addAttendee() {
      const name = $('#newAttendee').value.trim();
      if (name && !allAttendees.includes(name)) {
        allAttendees.push(name);
        updateAllAttendeeLists();
        $('#newAttendee').value = '';
      }
    }

    function updateAllAttendeeLists() {
      $$('.attendee-list').forEach(div=>{
        const prev = $$('input:checked', div).map(el=>el.value);
        div.innerHTML = allAttendees.map(n=>{
          const checked = prev.includes(n) ? 'checked' : '';
          return `<label><input type="checkbox" value="${n}" ${checked}> ${n}</label>`;
        }).join('');
      });
    }

    function addRound() {
      const container = document.
