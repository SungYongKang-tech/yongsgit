<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>남동3기 동기모임</title>
  <style>
    :root { --primary:#2b6cb0; --muted:#f5f7fb; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; margin: 0; background: #fafafa; color:#222; }
    header { position: sticky; top:0; z-index:5; background:#fff; border-bottom:1px solid #e5e7eb; }
   .bar {
  max-width: 1100px;
  margin: 0 auto;
  padding: 16px 14px;
  display: flex;
  flex-direction: column;   /* 타이틀 위, 버튼 아래 */
  align-items: center;      /* 가운데 정렬 */
  gap: 10px;
}
.bar h1 {
  font-size: clamp(18px, 4.5vw, 22px);
  margin: 0;
  text-align: center;       /* 타이틀 텍스트 가운데 */
}
.bar .actions { display:flex; gap:6px; flex-wrap:wrap; }

    button, .btn { appearance:none; border:1px solid #cbd5e1; background:#fff; color:#111; padding: 8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    button.primary, .btn.primary { background: var(--primary); color:#fff; border-color: var(--primary); }
    main { max-width: 1100px; margin: 0 auto; padding: 14px; }

    .card { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:14px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .grid { display:grid; gap:12px; }
    .grid-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    @media (max-width: 900px) { .grid-3{grid-template-columns:1fr;} }
    @media (max-width: 700px) { .grid-2{grid-template-columns:1fr;} }

    label { display:block; font-weight:600; margin: 6px 0 4px; }
    input[type="text"], input[type="number"], input[type="date"] { width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; }

    .attendee-list { display:flex; flex-wrap:wrap; gap:8px; background:#f5f7fb; padding:10px; border-radius:10px; }
    .attendee-list .pill { display:inline-flex; align-items:center; gap:6px; background:#fff; border:1px solid #e5e7eb; padding:6px 10px; border-radius:20px; }
    .attendee-list .pill[data-excluded="1"] { opacity:.6; }
    .ex-toggle { border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:3px 6px; font-size:12px; cursor:pointer; }
    .ex-toggle.active { background:#fee2e2; }

    .round { border:1px dashed #d1d5db; border-radius:12px; padding:12px; background:#fcfcfe; }
    .preview-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .preview-row img { height:88px; border-radius:10px; border:1px solid #e5e7eb; }

    table { width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:auto; display:block; }
    th, td { border:1px solid #e5e7eb; padding:10px; text-align:center; white-space:nowrap; }
    thead th { background:#f8fafc; }

    .list-row { display:grid; grid-template-columns: 1fr 120px; gap:12px; align-items:center; padding:12px; border-bottom:1px solid #eee; }
    .list-row:hover { background:#fafcff; }
    .list-head { font-weight:800; color:#475569; grid-template-columns: 1fr 120px; }
    .info-date a { color:var(--primary); font-weight:800; text-decoration:none; }
    .info-title { font-weight:700; margin-top:4px; }
    .info-meta { color:#6b7280; font-size:14px; margin-top:2px; }
    .thumb { width:112px; height:78px; object-fit:cover; border-radius:10px; border:1px solid #e5e7eb; background:#f1f5f9; display:block; margin-left:auto; }
    .thumb.placeholder { display:flex; align-items:center; justify-content:center; font-size:12px; color:#94a3b8; border-style:dashed; width:112px; height:78px; border-radius:10px; border:1px dashed #e5e7eb; margin-left:auto; }
    @media (max-width:700px) { .list-row { grid-template-columns: 1fr; } .thumb, .thumb.placeholder { margin-left:0; width:100%; height:160px; } }

    .paid { color:#16a34a; font-weight:800; }
    .unpaid { color:#dc2626; font-weight:800; }
    .muted { color:#6b7280; }
    .hidden { display:none; }

    .capture-wrap { background:#fff; padding:12px; border-radius:14px; border:1px solid #e5e7eb; }

    .lightbox { position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,.85); display: flex; align-items: center; justify-content: center; padding: 16px; }
    .lightbox.hidden { display: none; }
    .lightbox img { max-width: min(92vw, 1200px); max-height: 92vh; border-radius: 12px; box-shadow: 0 8px 40px rgba(0,0,0,.6); user-select: none; }
    .lightbox .close-btn { position: absolute; top: 10px; right: 10px; border: none; background: rgba(255,255,255,.15); color: #fff; font-size: 28px; line-height: 1; border-radius: 10px; padding: 6px 12px; cursor: pointer; }

    .saving { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,.45); z-index: 99999; color: #fff; font-weight: 700; }
    .saving.hidden { display: none; }
    .saving .box { background:#111; padding:16px 20px; border-radius:12px; }
  </style>
</head>
<body>
  <header>
    <div class="bar">
     <h1>남동3기 동기모임</h1>
      <div class="actions">
        <button class="btn" id="btnList">목록</button>
       <button class="btn" id="btnNew">새 회식</button>
      <button class="btn" id="btnAdminLogin">관리자 로그인</button>
      <button class="btn" id="btnAdminLogout" style="display:none;">관리자 로그아웃</button>
    </div>
  </div>
</header>

  <main>
    <!-- 목록 화면 -->
    <section id="view-list" class="grid">
      <div class="card">
        <div class="list-row list-head">
      <!--    <div>정보</div><div style="text-align:right;">사진</div>  -->
        </div>
        <div id="listBody"></div>
        <p class="muted" id="emptyNote" style="display:none; padding:10px 2px;">아직 저장된 회식이 없습니다. “새 회식”을 눌러 입력한 후 저장하세요.</p>
      </div>
    </section>

    <!-- 작성/편집 화면 -->
    <section id="view-editor" class="grid hidden">
      <div class="card">
        <div class="grid grid-3">
          <div>
            <label>회식 날짜</label>
            <input type="date" id="meetingDate">
          </div>
          <div>
            <label>제목</label>
            <input type="text" id="meetingTitle" placeholder="예: 3월 회식">
          </div>
          <div>
            <label>장소</label>
            <input type="text" id="meetingPlace" placeholder="예: 진주 ○○식당">
          </div>
        </div>

        <div style="margin-top:10px;">
          <button class="btn" onclick="addRound()">차수 추가</button>
          <button class="btn" id="btnAddMember">뉴멤버 추가</button>
        </div>

        <div id="rounds" style="margin-top:12px;" class="grid"></div>

        <div style="margin-top:12px;">
          <label>회식 사진 업로드 (여러 장)</label>
          <input type="file" accept="image/*" id="groupPhoto" multiple>
          <div id="photoPreview" class="preview-row" style="margin-top:6px;"></div>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;">
          <button class="btn primary" id="btnSave">이 회식 저장</button>
          <button class="btn" id="btnPreview">정산표 미리보기</button>
        </div>

        <div id="editorPreview" class="card hidden" style="margin-top:12px;">
          <div class="section-title">정산표 미리보기</div>
          <div id="editorSummary"></div>
        </div>
      </div>
    </section>

    <!-- 상세 화면 -->
    <section id="view-detail" class="grid hidden">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
          <div>
            <div id="detailTitle" style="font-weight:900; font-size:18px;"></div>
            <div class="muted" id="detailMeta"></div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn" id="btnBackToList">목록으로</button>
            <button class="btn" id="btnDelete">삭제</button>
            <button class="btn" id="btnCapture">이미지로 저장</button>
            <button class="btn" id="btnEdit">수정하기</button>
          </div>
        </div>

        <div id="detailWrap" class="capture-wrap" style="margin-top:12px;">
          <div id="detailSummary"></div>

          <div style="margin-top:16px;">
            <div class="section-title">영수증</div>
            <div id="detailReceipts" class="preview-row"></div>
          </div>

          <div style="margin-top:16px;">
            <div class="section-title">사진</div>
            <div id="detailPhotos" class="preview-row"></div>
          </div>

          <div style="margin-top:16px;">
            <div class="section-title">입금 확인</div>
            <div id="detailPaid"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- 저장 오버레이 -->
  <div id="savingOverlay" class="saving hidden">
    <div class="box">저장 중… <span id="savingText">준비</span></div>
  </div>

  <!-- 이미지 라이트박스 -->
  <div id="imgModal" class="lightbox hidden" aria-modal="true" role="dialog">
    <img id="imgModalImg" alt="확대 이미지" />
    <button type="button" class="close-btn" id="imgModalClose" aria-label="닫기">×</button>
  </div>

  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>








  <!-- Firebase (App/DB/Auth만 사용) -->
<script type="module">
  /*************
   * Imports
   *************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import { getAuth, signInAnonymously, signInWithEmailAndPassword, onAuthStateChanged, signOut,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  /*************
   * Cloudinary (변경X)
   *************/
  const CLOUD_NAME     = 'dqpcvlakz';
  const UPLOAD_PRESET  = 'koen3pay';
  const CLD_DELIVERY_BASE = `https://res.cloudinary.com/${CLOUD_NAME}/image/upload`;

  /*************
   * Firebase (변경X)
   *************/
  const firebaseConfig = {
    apiKey: "AIzaSyBmVXt2ze1iJmmA_YI-sgH3tJmSvZomkOo",
    authDomain: "ionic6-3b7b2.firebaseapp.com",
    databaseURL: "https://ionic6-3b7b2-default-rtdb.firebaseio.com",
    projectId: "ionic6-3b7b2",
    storageBucket: "ionic6-3b7b2.appspot.com",
    messagingSenderId: "306251113324",
    appId: "1:306251113324:web:456c689fdb4757adc18949"
  };

  const app  = initializeApp(firebaseConfig);
  const db   = getDatabase(app);
  const auth = getAuth(app);

  // 헤더에 로그인 상태 표시
  const whoEl = document.createElement('div');
  whoEl.className = 'muted';
  whoEl.style.fontSize = '12px';
  whoEl.style.marginLeft = 'auto';
  document.querySelector('.bar').appendChild(whoEl);

  let IS_ADMIN = false;

  function updateWho(u) {
    if (!u) {
      whoEl.textContent = '로그인 안 됨 (익명)';
      return;
    }
    whoEl.textContent = `${u.email || '익명'} ${IS_ADMIN ? '(관리자)' : ''} · uid:${u.uid.slice(0,8)}…`;
  }

  // 관리자 로그인 버튼
  document.getElementById('btnAdminLogin').onclick = async () => {
    const email = prompt('관리자 이메일');
    const pw    = prompt('비밀번호');
    if (!email || !pw) return;
    try {
      await signInWithEmailAndPassword(auth, email, pw);
      alert('관리자 로그인 완료!');
    } catch (e) {
      alert('로그인 실패: ' + (e.message || e));
    }
  };

  const loginBtn  = document.getElementById('btnAdminLogin');
const logoutBtn = document.getElementById('btnAdminLogout');

// 기존 로그인 핸들러는 그대로 두고…
logoutBtn.onclick = async () => {
  try {
    await signOut(auth);         // 현재 계정 로그아웃
    alert('관리자에서 로그아웃되었습니다.');
    // onAuthStateChanged의 else 블록에서 자동으로 익명 로그인 시도함
  } catch (e) {
    alert('로그아웃 실패: ' + (e.message || e));
  }
};

onAuthStateChanged(auth, async (u) => {
  if (u) {
    try {
      const s = await get(ref(db, `admins/${u.uid}`));
      IS_ADMIN = s.exists() && s.val() === true;
    } catch { IS_ADMIN = false; }
  } else {
    IS_ADMIN = false;
    try { await signInAnonymously(auth); } catch {}
  }

  updateWho(u);
  console.log('current uid:', u?.uid, 'isAdmin:', IS_ADMIN);

  // ⬇️ 버튼 표시/숨김 토글
  if (IS_ADMIN) {
    loginBtn.style.display = 'none';
    logoutBtn.style.display = '';
  } else {
    loginBtn.style.display = '';
    logoutBtn.style.display = 'none';
  }

  if (!uiInited && u) {
    initUI();
    uiInited = true;
  }
});


  // 로그인 상태 감지
  let uiInited = false;
  onAuthStateChanged(auth, async (u) => {
    // 현재 사용자가 관리자 목록에 있는지 확인
    if (u) {
      try {
        const s = await get(ref(db, `admins/${u.uid}`));
        IS_ADMIN = s.exists() && s.val() === true;
      } catch { IS_ADMIN = false; }
    } else {
      IS_ADMIN = false;
      // 비로그인(초기)인 경우에만 익명 로그인 시도
      try { await signInAnonymously(auth); } catch {}
    }
    updateWho(u);
    console.log('current uid:', u?.uid, 'isAdmin:', IS_ADMIN);

    if (!uiInited && u) {
      initUI();
      uiInited = true;
    }
  });

  async function ensureAuth() {
    if (auth.currentUser) return auth.currentUser;
    const cred = await signInAnonymously(auth);
    return cred.user;
  }

  /*************
   * 유틸/상수 (원래 코드 그대로)
   *************/
  const $  = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const defaultAttendees = ["성용","범준","기현","승호","재환","창현","계민","인찬","정선","현정","정록","영화","재화","원용","윤숙","인수"];
  const LS_KEY = 'nd3-attendees';
function loadAttendees(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return [...defaultAttendees];
    const arr = JSON.parse(raw);
    if (Array.isArray(arr)) {
      // 기본 멤버 + 저장된 멤버 합치고 중복 제거
      return Array.from(new Set([...defaultAttendees, ...arr]));
    }
    return [...defaultAttendees];
  }catch{ return [...defaultAttendees]; }
}
function saveAttendees(){
  try{
    // 기본 멤버를 빼고 추가된 멤버만 저장(용량 절약)
    const added = allAttendees.filter(n => !defaultAttendees.includes(n));
    localStorage.setItem(LS_KEY, JSON.stringify(added));
  }catch{}
}

let allAttendees = loadAttendees();


  let isEditing = false, editingId = null;
  let editorPhotos = [], newPhotoFiles = [];
  let editorReceipts = {}, newReceiptFiles = {}; // per round
// [개별 금액]
let editorOverrides = {};  // { [roundIdx]: { [name]: number } }

  async function getAllMeetings() {
    const snap = await get(ref(db, 'meetings'));
    const obj = snap.exists() ? snap.val() : {};
    return Object.values(obj).sort((a,b)=> (b.date||'').localeCompare(a.date||''));
  }
  async function getMeetingById(id) { const snap = await get(ref(db, `meetings/${id}`)); return snap.exists() ? snap.val() : null; }
  async function saveMeetingToDB(meeting) { await set(ref(db, `meetings/${meeting.id}`), meeting); }
  async function deleteMeetingFromDB(id) { await remove(ref(db, `meetings/${id}`)); }
  async function updatePaidStatus(id, paidStatus) { await update(ref(db, `meetings/${id}`), { paidStatus }); }

  /************* 이미지 처리/업로드 (원래 코드 그대로) *************/
  const MAX_BYTES = 2 * 1024 * 1024; // 2MB
  function showSaving(msg){ $('#savingText').textContent = msg || '처리 중'; $('#savingOverlay').classList.remove('hidden'); }
  function setSaving(msg){ $('#savingText').textContent = msg; }
  function hideSaving(){ $('#savingOverlay').classList.add('hidden'); }

  function loadImage(src){
    return new Promise((resolve,reject)=>{
      const img = new Image(); img.onload=()=>resolve(img); img.onerror=reject; img.src=src;
    });
  }
  async function drawToCanvas(src, maxW){
    async function bitmapToCanvas(bmp, maxW){
      const s = Math.min(1, maxW / bmp.width);
      const w = Math.max(1, Math.round(bmp.width * s));
      const h = Math.max(1, Math.round(bmp.height * s));
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(bmp, 0, 0, w, h);
      try { bmp.close && bmp.close(); } catch(_){}
      return canvas;
    }
    if (src instanceof File) {
      try {
        const bmp = await createImageBitmap(src);
        return await bitmapToCanvas(bmp, maxW);
      } catch (e) { /* 폴백 */ }
    }
    const url = (typeof src === 'string') ? src : URL.createObjectURL(src);
    const img = await loadImage(url);
    const s = Math.min(1, maxW / img.width);
    const w = Math.max(1, Math.round(img.width * s));
    const h = Math.max(1, Math.round(img.height * s));
    const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
    if (typeof src !== 'string') { try { URL.revokeObjectURL(url); } catch(_){} }
    return canvas;
  }
  function canvasToBlob(canvas, quality=0.82, type='image/jpeg'){
    return new Promise((resolve)=> canvas.toBlob(b=>resolve(b), type, quality));
  }
  async function compressWithLimit(fileOrDataURL, {maxW, qualityStart=0.82, minQuality=0.55, step=0.07}){
    try {
      const src = fileOrDataURL;
      let q = qualityStart, w = maxW, lastBlob = null;
      for (let attempt = 0; attempt < 6; attempt++){
        const canvas = await drawToCanvas(src, w);
        const blob   = await canvasToBlob(canvas, q);
        lastBlob = blob;
        if (blob.size <= MAX_BYTES) return blob;
        if (q > minQuality) q = Math.max(minQuality, q - step);
        else {
          w = Math.round(w * 0.85);
          if (w < 480) return blob;
        }
      }
      return lastBlob;
    } catch (e) {
      if (fileOrDataURL instanceof File) return fileOrDataURL; // 원본 업로드
      throw e;
    }
  }
  function randomId(){ return Math.random().toString(36).slice(2,10); }

  function xhrUpload(url, formData, onProgress){
    return new Promise((resolve, reject)=>{
      const xhr = new XMLHttpRequest();
      xhr.open('POST', url);
      xhr.onload = ()=> {
        try { resolve(JSON.parse(xhr.responseText)); } catch(e){ reject(e); }
      };
      xhr.onerror = ()=> reject(new Error('upload-error'));
      if (xhr.upload && onProgress){
        xhr.upload.onprogress = (e)=>{
          if (e.lengthComputable) onProgress(Math.round((e.loaded/e.total)*100));
        };
      }
      xhr.send(formData);
    });
  }
  async function uploadToCloudinary(blobOrFile, folder, onProgress){
    const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
    const publicId = `${Date.now()}_${randomId()}`;
    const fd = new FormData();
    fd.append('file', blobOrFile);
    fd.append('upload_preset', UPLOAD_PRESET);
    fd.append('folder', folder);
    fd.append('public_id', publicId);

    const res = await xhrUpload(url, fd, onProgress);
    const pid = res.public_id;
    const fmt = res.format || 'jpg';
    const full  = res.secure_url || `${CLD_DELIVERY_BASE}/${pid}.${fmt}`;
    const thumb = `${CLD_DELIVERY_BASE}/c_limit,w_320,f_auto,q_auto/${pid}.${fmt}`;
    return { full, thumb };
  }
  async function uploadPhotoSet(meetingId, file, index, total){
    setSaving(`사진 ${index}/${total} 준비`);
    const blob = await compressWithLimit(file, { maxW: 1600, qualityStart: 0.82 });
    setSaving(`사진 업로드 ${index}/${total} (전송 중…)`);
    return await uploadToCloudinary(
      blob,
      `meetings/${meetingId}/photos`,
      (p)=> setSaving(`사진 업로드 ${index}/${total} (${p}%)`)
    );
  }
  async function uploadReceipt(meetingId, roundIdx, file, index, total){
    setSaving(`영수증 ${index}/${total} 준비`);
    const blob = await compressWithLimit(file, { maxW: 1200, qualityStart: 0.8 });
    setSaving(`영수증 업로드 ${index}/${total} (전송 중…)`);
    const r = await uploadToCloudinary(
      blob,
      `meetings/${meetingId}/receipts`,
      (p)=> setSaving(`영수증 업로드 ${index}/${total} (${p}%)`)
    );
    return r.full;
  }

  /************* 화면 전환/목록/에디터 (원래 코드 유지) *************/
  const viewList = $('#view-list'), viewEditor = $('#view-editor'), viewDetail = $('#view-detail');
  function show(id){ [viewList,viewEditor,viewDetail].forEach(v=>v.classList.add('hidden')); id.classList.remove('hidden'); window.scrollTo({top:0, behavior:'smooth'}); }

  $('#btnList').onclick = ()=> { renderList(); show(viewList); };
  $('#btnNew').onclick  = ()=> { resetEditor(); show(viewEditor); };

  
  async function renderList(){
    const list = await getAllMeetings();
    const body = $('#listBody'); body.innerHTML=''; $('#emptyNote').style.display = list.length ? 'none' : 'block';
    list.forEach(item=>{
      const unique = new Set(item.rounds.flatMap(r=>r.attendees||[]));
      let thumbSrc = null;
      if (item.photos && item.photos[0]){
        const p = item.photos[0];
        thumbSrc = typeof p === 'string' ? p : (p.thumb || p.full);
      }
      const row = document.createElement('div'); row.className='list-row';
      row.innerHTML = `
        <div>
          <div class="info-date"><a href="#" data-id="${item.id}" class="link-date">${item.date||'-'}</a></div>
          <div class="info-title">${item.title||'-'}</div>
          <div class="info-meta">참석 ${unique.size.toLocaleString('ko-KR')}명 · 장소 ${item.place||'-'}</div>
        </div>
        <div>${thumbSrc ? `<img src="${thumbSrc}" alt="회식 썸네일" class="thumb zoomable" loading="lazy">` : `<div class="thumb placeholder">사진없음</div>`}</div>
      `;
      body.appendChild(row);
    });
    $$('.link-date', body).forEach(a=> a.onclick = (e)=>{ e.preventDefault(); openDetail(a.dataset.id); });
  }

  function resetEditor(){
    isEditing=false; editingId=null; editorPhotos=[]; newPhotoFiles=[]; editorReceipts={}; newReceiptFiles={}; editorOverrides = {};
    $('#meetingDate').value=''; $('#meetingTitle').value=''; $('#meetingPlace').value='';
    $('#rounds').innerHTML=''; $('#groupPhoto').value=''; $('#photoPreview').innerHTML='';
    $('#editorPreview').classList.add('hidden'); $('#editorSummary').innerHTML='';
    addRound();
  }

  function addRound(){
    const container = document.createElement('div');
    const idx = $$('.round').length;
    container.className='round'; container.dataset.idx=String(idx);
    editorReceipts[idx]=editorReceipts[idx]||[]; newReceiptFiles[idx]=newReceiptFiles[idx]||[];

    container.innerHTML = `
  <div class="section-title">${idx+1}차</div>
  <div class="grid grid-3">
    <div>
      <label>금액(원)</label>
      <input type="number" class="amount" min="0" placeholder="예: 150000">
      <label style="margin-top:6px;">
        <input type="checkbox" class="corpCard"> 이 차수는 법인카드(개인 정산 없음)
      </label>

      <!-- [개별 금액] -->
      <div style="margin-top:8px; display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
        <button type="button" class="btn" data-role="open-overrides">개별 금액 조정</button>
        <span class="muted" data-role="overrides-summary"></span>
      </div>
      <div class="card hidden" data-role="overrides-panel" style="margin-top:6px; padding:10px;">
        <div class="muted" data-role="overrides-info" style="margin-bottom:6px;"></div>
        <div data-role="overrides-list"></div>
        <div class="muted" data-role="overrides-foot" style="margin-top:6px;"></div>
        <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;">
          <button type="button" class="btn" data-role="overrides-apply">적용</button>
          <button type="button" class="btn" data-role="overrides-clear">모두 지우기</button>
          <button type="button" class="btn" data-role="overrides-close">닫기</button>
        </div>
      </div>
      <!-- // [개별 금액] -->
    </div>
    <div>
      <label>영수증 업로드</label>
      <input type="file" accept="image/*" class="receiptInput" multiple>
    </div>
    <div>
      <label class="muted">영수증 미리보기</label>
      <div class="receiptPreview preview-row"></div>
    </div>
  </div>
  <div style="margin-top:8px;">
    <div class="section-title">참석자 (필요 시 ‘제외’ 토글)</div>
    <div class="attendee-list"></div>
  </div>`;

    $('#rounds').appendChild(container);
    updateAttendeeListFor(container);

    $('.receiptInput', container).addEventListener('change', (e)=>{
      const files = Array.from(e.target.files || []);
      const rIdx = parseInt(container.dataset.idx, 10);
      newReceiptFiles[rIdx].push(...files);
      renderReceiptPreview(container);
      e.target.value = '';
    });

    renderReceiptPreview(container);

    $('.corpCard', container).addEventListener('change', (e)=>{
      const amountEl = $('.amount', container);
      if (e.target.checked){ amountEl.value=''; amountEl.disabled=true; amountEl.placeholder='법인카드 - 금액입력 불필요'; }
      else { amountEl.disabled=false; amountEl.placeholder='예: 150000'; }
    });

    // [개별 금액] 패널 열기/적용/초기화/닫기
const panel = $('[data-role="overrides-panel"]', container);
const summary = $('[data-role="overrides-summary"]', container);
summary.textContent = buildOverridesSummary(container);

$('[data-role="open-overrides"]', container).onclick = ()=>{
  renderOverridesPanel(container);
  panel.classList.remove('hidden');
};

$('[data-role="overrides-apply"]', container).onclick = ()=>{
  // 입력값 읽어 editorOverrides 저장
  const rIdx = +container.dataset.idx;
  editorOverrides[rIdx] = editorOverrides[rIdx] || {};
  $$('input[data-role="ov-input"]', panel).forEach(inp=>{
    const name = inp.dataset.name;
    const v = inp.value.trim();
    if (v === '' || isNaN(+v) || +v <= 0) delete editorOverrides[rIdx][name];
    else editorOverrides[rIdx][name] = Math.round(+v);
  });
  // 요약 업데이트
  summary.textContent = buildOverridesSummary(container);
  panel.classList.add('hidden');
};

$('[data-role="overrides-clear"]', container).onclick = ()=>{
  const rIdx = +container.dataset.idx;
  editorOverrides[rIdx] = {};
  renderOverridesPanel(container);
  summary.textContent = '';
};

$('[data-role="overrides-close"]', container).onclick = ()=> panel.classList.add('hidden');

// 금액/참석자 변경 시, 열려 있으면 즉시 갱신
$('.amount', container).addEventListener('input', ()=> {
  const panel = $('[data-role="overrides-panel"]', container);
  if (panel && !panel.classList.contains('hidden')) renderOverridesPanel(container);
});

// ✅ 요약 초기 표시 (함수 내부!)
summary.textContent = buildOverridesSummary(container);
}
function updateAttendeeListFor(roundEl){
  const div = $('.attendee-list', roundEl);

  // 이전 선택/제외 상태 유지
  const prevChecked  = $$('input[data-role="attend"]:checked', div).map(el => el.value);
  const prevExcluded = $$('label.pill[data-excluded="1"]', div).map(el => el.dataset.name);

  // 참석자 UI 다시 그리기
  div.innerHTML = allAttendees.map(n => {
    const checked  = prevChecked.includes(n) ? 'checked' : '';
    const excluded = prevExcluded.includes(n) ? ' data-excluded="1"' : '';
    const exText   = prevExcluded.includes(n) ? '제외됨' : '제외';
    return `
      <label class="pill"${excluded} data-name="${n}">
        <input type="checkbox" data-role="attend" value="${n}" ${checked}> ${n}
        <button type="button" class="ex-toggle${prevExcluded.includes(n)?' active':''}"
                data-role="ex-toggle" data-name="${n}">${exText}</button>
      </label>`;
  }).join('');

  // ✅ 체크박스 변경 시, 패널이 열려 있으면 즉시 다시 계산/표시 + 요약도 갱신
  $$('input[data-role="attend"]', div).forEach(cb => {
    cb.addEventListener('change', () => {
      const panel = $('[data-role="overrides-panel"]', roundEl);
      if (panel && !panel.classList.contains('hidden')) {
        renderOverridesPanel(roundEl);      // 패널 내용 다시 그림
      }
      const sumEl = $('[data-role="overrides-summary"]', roundEl);
      if (sumEl) {
        sumEl.textContent = buildOverridesSummary(roundEl); // 요약 문구 갱신
      }
    });
  });
}


  function renderReceiptPreview(roundEl){
    const rIdx = parseInt(roundEl.dataset.idx,10);
    const box = roundEl.querySelector('.receiptPreview'); box.innerHTML='';
    (editorReceipts[rIdx]||[]).forEach((src,i)=>{
      const viewSrc = typeof src === 'string' ? src : (src.thumb || src.full || src);
      const wrap = document.createElement('div'); wrap.className='preview-row';
      const img = document.createElement('img'); img.src=viewSrc; img.alt='영수증'; img.classList.add('zoomable');
      const btn = document.createElement('button'); btn.className='ex-toggle'; btn.textContent='삭제';
      btn.dataset.role='del-receipt-existing'; btn.dataset.idx=String(rIdx); btn.dataset.i=String(i);
      wrap.appendChild(img); wrap.appendChild(btn); box.appendChild(wrap);
    });
    (newReceiptFiles[rIdx]||[]).forEach((file,i)=>{
      const url = URL.createObjectURL(file);
      const wrap = document.createElement('div'); wrap.className='preview-row';
      const img = document.createElement('img'); img.src=url; img.alt='영수증(신규)'; img.classList.add('zoomable');
      const btn = document.createElement('button'); btn.className='ex-toggle'; btn.textContent='삭제';
      btn.dataset.role='del-receipt-new'; btn.dataset.idx=String(rIdx); btn.dataset.i=String(i);
      wrap.appendChild(img); wrap.appendChild(btn); box.appendChild(wrap);
      img.onload = ()=> URL.revokeObjectURL(url);
    });
  }

  $('#groupPhoto').addEventListener('change', (e)=>{
    const files = Array.from(e.target.files || []);
    newPhotoFiles.push(...files);
    renderPhotoPreview();
    e.target.value = '';
  });
  function renderPhotoPreview(){
    const box = $('#photoPreview'); box.innerHTML='';
    editorPhotos.forEach((src,i)=>{
      const viewSrc = (typeof src === 'string') ? src : (src.thumb || src.full);
      const wrap = document.createElement('div'); wrap.className='preview-row';
      const img = document.createElement('img'); img.src=viewSrc; img.alt='사진'; img.classList.add('zoomable');
      const btn = document.createElement('button'); btn.className='ex-toggle'; btn.textContent='삭제'; btn.dataset.role='del-photo-existing'; btn.dataset.i=String(i);
      wrap.appendChild(img); wrap.appendChild(btn); box.appendChild(wrap);
    });
   newPhotoFiles
  .filter(f => f instanceof Blob)   // ✅ Blob/File만 처리
  .forEach((file,i)=>{
    const url = URL.createObjectURL(file);
    const wrap = document.createElement('div'); wrap.className='preview-row';
    const img = document.createElement('img'); img.src=url; img.alt='사진(신규)'; img.classList.add('zoomable');
    const btn = document.createElement('button'); btn.className='ex-toggle'; btn.textContent='삭제';
    btn.dataset.role='del-photo-new'; btn.dataset.i=String(i);
    wrap.appendChild(img); wrap.appendChild(btn); box.appendChild(wrap);
    img.onload = ()=> URL.revokeObjectURL(url);
  });

  }

  $('#btnPreview').onclick = ()=>{
    const dummy = buildSummaryFromEditor(); if(!dummy) return;
    $('#editorSummary').innerHTML = dummy.html; $('#editorPreview').classList.remove('hidden');
  };

  function buildSummaryFromEditor(){
    const roundEls = $$('.round'); if(!roundEls.length){ alert('차수를 추가하세요.'); return null; }
    const roundTitles = roundEls.map((_,i)=>`${i+1}차`);
    const memberMap = {};
    for(let i=0;i<roundEls.length;i++){
      const el = roundEls[i];
      const corp = $('.corpCard', el).checked;
      const amountRaw = $('.amount', el).value.trim();
      const amount = amountRaw === '' ? null : parseInt(amountRaw,10);
      const checked = $$('input[data-role="attend"]:checked', el).map(v=>v.value);
      const excluded = $$('label.pill[data-excluded="1"]', el).map(l=>l.dataset.name).filter(n=>checked.includes(n));
      const included = checked.filter(n=>!excluded.includes(n));
      if (!corp && amount && included.length>0){
        const { shares } = calcShares(amount, included, editorOverrides[i] || {});
Object.entries(shares).forEach(([n, won])=>{
  if(!memberMap[n]) memberMap[n]={ total:0, rounds:[] };
  memberMap[n].rounds[i] = won;
  memberMap[n].total += won;
});
      }
    }
    const rows = Object.entries(memberMap).sort((a,b)=>a[0].localeCompare(b[0],'ko'));
    let html = `<table><thead><tr><th>이름</th>${roundTitles.map(r=>`<th>${r}</th>`).join('')}<th>총액</th></tr></thead><tbody>`;
    rows.forEach(([name,data])=>{
      html += `<tr><td>${name}</td>`;
      for(let i=0;i<roundTitles.length;i++){
        const v = data.rounds[i] ? Math.round(data.rounds[i]).toLocaleString('ko-KR')+'원' : '-';
        html += `<td>${v}</td>`;
      }
      html += `<td><strong>${Math.round(data.total).toLocaleString('ko-KR')}원</strong></td></tr>`;
    });
    html += `</tbody></table>`;
    return { html, count: rows.length };
  }

  /************* 저장 (관리자 체크 추가) *************/
  $('#btnSave').onclick = async ()=>{
    try {
      if (!IS_ADMIN) { alert('관리자만 저장할 수 있어요. 상단의 [관리자 로그인]을 눌러 로그인하세요.'); throw new Error('not-admin'); }

      const btn = $('#btnSave');
      btn.disabled = true; btn.textContent = '저장 중…';
      showSaving('준비 중…');

      await ensureAuth();

      const date  = $('#meetingDate').value;
      const title = $('#meetingTitle').value.trim();
      const place = $('#meetingPlace').value.trim();
      if(!date || !title){ alert('날짜와 제목은 필수입니다.'); throw new Error('required'); }

      const meetingId = isEditing ? editingId : Date.now().toString();

      const roundEls = $$('.round'); if(!roundEls.length){ alert('차수를 추가하세요.'); throw new Error('no rounds'); }
      const rounds = [];
      for(let i=0;i<roundEls.length;i++){
        const el = roundEls[i];
        const corp = $('.corpCard', el).checked;
        const amountRaw = $('.amount', el).value.trim();
        const amount = amountRaw === '' ? null : parseInt(amountRaw,10);
        const attendees = $$('input[data-role="attend"]:checked', el).map(cb=>cb.value);
        if(!attendees.length){ alert(`${i+1}차 참석자를 선택하세요.`); throw new Error('no attendees'); }
        const exclusions = $$('label.pill[data-excluded="1"]', el).map(l=>l.dataset.name).filter(n=>attendees.includes(n));
        rounds.push({
  amount, attendees, exclusions, corp,
  receiptImages: [],
  overrides: editorOverrides[i] || {}   // [개별 금액] 추가
});

      }

      const photos = [];
      editorPhotos.forEach(p=>{
        if (typeof p === 'string') photos.push(p);
        else photos.push({full: p.full, thumb: p.thumb || p.full});
      });
      for(let i=0;i<newPhotoFiles.length;i++){
        const result = await uploadPhotoSet(meetingId, newPhotoFiles[i], i+1, newPhotoFiles.length);
        photos.push(result);
      }

      const totalReceipts = Object.values(newReceiptFiles).reduce((acc,arr)=> acc + (arr?.length||0), 0) || 0;
      let uploaded = 0;
      for(let r=0;r<rounds.length;r++){
        (editorReceipts[r]||[]).forEach(u=>{
          if (typeof u === 'string') rounds[r].receiptImages.push(u);
          else rounds[r].receiptImages.push(u.full || u.thumb);
        });
        const files = newReceiptFiles[r] || [];
        for (let i=0;i<files.length;i++){
          const url = await uploadReceipt(meetingId, r, files[i], ++uploaded, totalReceipts);
          rounds[r].receiptImages.push(url);
        }
      }

      let paidStatus = {};
      if(!isEditing){
        const people = Array.from(new Set(rounds.flatMap(r=> r.attendees.filter(n=> !(r.exclusions||[]).includes(n)) )));
        paidStatus = Object.fromEntries(people.map(n=>[n,false]));
      }

      const data = { id: meetingId, date, title, place, rounds, photos, paidStatus };

      if (isEditing) {
        const old = await getMeetingById(editingId);
        if (!old) throw new Error('기존 데이터 없음');
        const newIncluded = Array.from(new Set(
          data.rounds.flatMap(r=> r.attendees.filter(n=> !(r.exclusions||[]).includes(n)))
        ));
        const merged = {};
        newIncluded.forEach(n=>{ merged[n] = (old.paidStatus && n in old.paidStatus) ? old.paidStatus[n] : false; });
        data.paidStatus = merged;
      }

      await saveMeetingToDB(data);
      alert(isEditing ? '수정되었습니다.' : '저장되었습니다.');
      await renderList(); show(viewList);
      resetEditor();

    } catch (e) {
      console.error(e);
      alert(`저장 실패: ${e.code || e.name || ''}\n${e.message || e}`);
    } finally {
      hideSaving();
      const btn = $('#btnSave'); btn.disabled = false; btn.textContent = '이 회식 저장';
    }
  };

  /************* 상세/입금/삭제 (관리자 체크는 서버규칙이 막아줌) *************/
  async function openDetail(id){
    const item = await getMeetingById(id);
    if(!item){ alert('데이터를 찾을 수 없습니다.'); return; }
    $('#detailTitle').textContent = item.title||'(제목 없음)';
    const uniqueCnt = new Set(item.rounds.flatMap(r=>r.attendees)).size;
    $('#detailMeta').textContent = `${item.date||'-'} · 참석 ${uniqueCnt.toLocaleString('ko-KR')}명 · 장소 ${item.place||'-'}`;

    $('#detailSummary').innerHTML = buildSummaryHTML(item);

    const recWrap = $('#detailReceipts'); recWrap.innerHTML='';
    item.rounds.forEach((r,idx)=> (r.receiptImages||[]).forEach(src=>{
      const viewSrc = (typeof src === 'string') ? src : (src.full || src.thumb || src);
      const img=document.createElement('img'); img.src=viewSrc; img.alt=`${idx+1}차 영수증`; img.classList.add('zoomable'); recWrap.appendChild(img);
    }));
    const pWrap = $('#detailPhotos'); pWrap.innerHTML='';
    (item.photos||[]).forEach(p=>{
      const viewSrc = (typeof p === 'string') ? p : (p.full || p.thumb);
      const img=document.createElement('img'); img.src=viewSrc; img.alt='회식 사진'; img.classList.add('zoomable'); pWrap.appendChild(img);
    });

    renderPaidTable(item);

    $('#btnBackToList').onclick = async ()=>{ await renderList(); show(viewList); };
    $('#btnDelete').onclick = async ()=>{
      if(!IS_ADMIN){ return alert('관리자만 삭제할 수 있어요.'); }
      if(!confirm('이 회식 기록을 삭제할까요?')) return;
      await deleteMeetingFromDB(id);
      await renderList(); show(viewList);
    };
    $('#btnCapture').onclick = ()=> captureElement(
      $('#detailSummary'),
      `정산결과_${item.date||'회식'}-${(item.title||'').replace(/[\\/:*?"<>|]/g,'')}.png`
    );
    $('#btnEdit').onclick = ()=> startEdit(id);

    show(viewDetail);
  }

function buildSummaryHTML(item){
  const roundTitles = item.rounds.map((_,i)=>`${i+1}차`);
  const memberMap = {};

  item.rounds.forEach((r, idx) => {
    const included = (r.attendees||[]).filter(n => !(r.exclusions||[]).includes(n));
    if (!r.corp && r.amount && included.length > 0) {
      const { shares } = calcShares(r.amount || 0, included, r.overrides || {});
      Object.entries(shares).forEach(([name, won]) => {
        if (!memberMap[name]) memberMap[name] = { total: 0, rounds: [] };
        memberMap[name].rounds[idx] = won;
        memberMap[name].total += won;
      });
    }
  });

  const entries = Object.entries(memberMap).sort((a,b)=>a[0].localeCompare(b[0],'ko'));
  let html = `<div class="section-title">정산 결과</div>`;
  html += `<table><thead><tr><th>이름</th>${roundTitles.map(r=>`<th>${r}</th>`).join('')}<th>총액</th></tr></thead><tbody>`;
  entries.forEach(([name,data])=>{
    html += `<tr><td>${name}</td>`;
    for (let i=0;i<roundTitles.length;i++){
      const v = data.rounds[i] ? Math.round(data.rounds[i]).toLocaleString('ko-KR')+'원' : '-';
      html += `<td>${v}</td>`;
    }
    html += `<td><strong>${Math.round(data.total).toLocaleString('ko-KR')}원</strong></td></tr>`;
  });
  html += `</tbody></table>`;
  return html;
}

function renderPaidTable(item){
  const totals = {};

  item.rounds.forEach((r) => {
    const included = (r.attendees||[]).filter(n => !(r.exclusions||[]).includes(n));
    if (!r.corp && r.amount && included.length > 0) {
      const { shares } = calcShares(r.amount || 0, included, r.overrides || {});
      Object.entries(shares).forEach(([name, won]) => {
        totals[name] = (totals[name] || 0) + won;
      });
    }
  });

  const names = Object.keys(totals).sort((a,b)=>a.localeCompare(b,'ko'));
  const wrap = $('#detailPaid');
  let html = `<table><thead><tr><th>이름</th><th>총액</th><th>입금 상태</th></tr></thead><tbody>`;
  names.forEach(n=>{
    const paid = !!item.paidStatus?.[n];
    html += `<tr>
      <td>${n}</td>
      <td>${Math.round(totals[n]).toLocaleString('ko-KR')}원</td>
      <td><button class="${paid?'paid':'unpaid'}" data-name="${n}" data-id="${item.id}">
        ${paid?'확인됨':'미입금'}
      </button></td>
    </tr>`;
  });
  html += `</tbody></table>`;
  wrap.innerHTML = html;

  $$('button[data-name]', wrap).forEach(btn=>{
    btn.onclick = async ()=>{
      if(!IS_ADMIN){ return alert('관리자만 변경할 수 있어요.'); }
      const id = btn.dataset.id, name = btn.dataset.name;
      const fresh = await getMeetingById(id);
      const next = { ...(fresh.paidStatus||{}) };
      next[name] = !next[name];
      await updatePaidStatus(id, next);
      renderPaidTable({ ...fresh, paidStatus: next });
    };
  });
}


 function startEdit(id){
  getMeetingById(id).then(item=>{
    if(!item){ alert('수정할 데이터를 찾지 못했습니다.'); return; }
    isEditing=true; editingId=id;

    const allNames = Array.from(new Set(item.rounds.flatMap(r=>r.attendees)));
    allNames.forEach(n=>{ if(!allAttendees.includes(n)) allAttendees.push(n); });

    $('#meetingDate').value=item.date||''; 
    $('#meetingTitle').value=item.title||''; 
    $('#meetingPlace').value=item.place||'';
    editorPhotos=[...(item.photos||[])]; 
    newPhotoFiles=[]; 
    $('#rounds').innerHTML=''; 
    editorReceipts={}; 
    newReceiptFiles={};

    item.rounds.forEach((r,i)=>{
      addRound();
      const roundEl  = $$('.round')[i];
      const amountEl = $('.amount', roundEl); 
      const corpEl   = $('.corpCard', roundEl);

      amountEl.value = (r.amount??'') === null ? '' : (r.amount??'');
      corpEl.checked = !!r.corp;
      if (corpEl.checked){
        amountEl.value='';
        amountEl.disabled=true;
        amountEl.placeholder='법인카드 - 금액입력 불필요';
      }

      // ✅ 영수증/오버라이드 세팅 (여기에 넣기)
      editorReceipts[i]   = [...(r.receiptImages||[])];
      newReceiptFiles[i]  = [];
      editorOverrides[i]  = { ...(r.overrides || {}) };  // ← 오버라이드 불러오기
      renderReceiptPreview(roundEl);                      // 미리보기 1번만 호출!

      // 참석자/제외 반영
      updateAttendeeListFor(roundEl);
      const labels = $$('label.pill', roundEl);
      labels.forEach(lbl=>{
        const name = lbl.dataset.name;
        const cb = $('input[data-role="attend"]', lbl);
        cb.checked = r.attendees.includes(name);
        if ((r.exclusions||[]).includes(name)){
          lbl.setAttribute('data-excluded','1');
          const btn = $('[data-role="ex-toggle"]', lbl);
          if(btn){ btn.textContent='제외됨'; btn.classList.add('active'); }
        }
      });

      // ✅ 개별금액 요약 표시(있으면)
      const sumEl = $('[data-role="overrides-summary"]', roundEl);
      if (sumEl) sumEl.textContent = buildOverridesSummary(roundEl);
    });

    renderPhotoPreview();
    show(viewEditor);
  });
}


  async function captureElement(el, filename='정산결과.png'){
    const canvas = await html2canvas(el,{ scale:2, useCORS:true, backgroundColor:'#fff',
      windowWidth: el.scrollWidth, windowHeight: el.scrollHeight, scrollX:0, scrollY:-window.scrollY });
    const link = document.createElement('a'); link.download=filename; link.href=canvas.toDataURL('image/png'); link.click();
  }
  window.captureElement = captureElement;

  const imgModal = $('#imgModal'), imgModalImg = $('#imgModalImg'), imgModalClose = $('#imgModalClose');
  function openImgModal(src){ imgModalImg.src=src; imgModal.classList.remove('hidden'); document.body.style.overflow='hidden'; }
  function closeImgModal(){ imgModal.classList.add('hidden'); imgModalImg.src=''; document.body.style.overflow=''; }
  imgModalClose.addEventListener('click', closeImgModal);
  imgModal.addEventListener('click', e=>{ if(e.target===imgModal) closeImgModal(); });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape' && !imgModal.classList.contains('hidden')) closeImgModal(); });

  document.addEventListener('click', (e)=>{
    const img = e.target.closest('img.zoomable'); if(img){ openImgModal(img.src); return; }
    const btn = e.target.closest('[data-role]'); if(!btn) return;
    if (btn.dataset.role === 'ex-toggle'){
  const pill = btn.closest('label.pill'); if(!pill) return;
  const isEx = pill.getAttribute('data-excluded') === '1';
  pill.setAttribute('data-excluded', isEx ? '0' : '1');
  btn.textContent = isEx ? '제외' : '제외됨';
  btn.classList.toggle('active', !isEx);

  // ⬇️ 패널/요약 즉시 갱신
  const roundEl = btn.closest('.round');
  const panel = $('[data-role="overrides-panel"]', roundEl);
  if (panel && !panel.classList.contains('hidden')) renderOverridesPanel(roundEl);
  const sumEl = $('[data-role="overrides-summary"]', roundEl);
  if (sumEl) sumEl.textContent = buildOverridesSummary(roundEl);

  return;
}
    if (btn.dataset.role === 'del-photo-existing'){ const i = +btn.dataset.i; editorPhotos.splice(i,1); renderPhotoPreview(); return; }
    if (btn.dataset.role === 'del-photo-new'){ const i = +btn.dataset.i; newPhotoFiles.splice(i,1); renderPhotoPreview(); return; }
    if (btn.dataset.role === 'del-receipt-existing'){ const rIdx=+btn.dataset.idx, i=+btn.dataset.i; (editorReceipts[rIdx]||[]).splice(i,1); const roundEl=$$('.round')[rIdx]; if(roundEl) renderReceiptPreview(roundEl); return; }
    if (btn.dataset.role === 'del-receipt-new'){ const rIdx=+btn.dataset.idx, i=+btn.dataset.i; (newReceiptFiles[rIdx]||[]).splice(i,1); const roundEl=$$('.round')[rIdx]; if(roundEl) renderReceiptPreview(roundEl); return; }
  });

  function initUI(){
    $('#btnCapture').onclick = ()=> captureElement($('#detailSummary'), '정산결과.png');
    renderList(); show(viewList);
  }
window.addRound = addRound;
  // html2canvas CDN (이미 상단 script 태그 있음)

  // [개별 금액] 총액 유지 분배 함수
function calcShares(amount, included, overrides = {}) {
  const fixed = Object.entries(overrides)
    .filter(([n,v]) => included.includes(n) && Number.isFinite(+v) && +v > 0)
    .map(([n,v]) => [n, Math.round(+v)]);

  const sumFixed = fixed.reduce((a, [,v]) => a + v, 0);
  const rest = included.filter(n => !fixed.find(([k]) => k === n));
  const shares = {};

  // 고정 금액 반영
  fixed.forEach(([n,v]) => shares[n] = v);

  // 남는 금액 계산 (음수가 되면 0으로 처리하고 경고 플래그 반환)
  const remainTotal = Math.max(0, Math.round(amount) - sumFixed);
  const restCount = rest.length;

  if (restCount > 0) {
    const base = Math.floor(remainTotal / restCount);
    let rem = remainTotal % restCount;
    // 이름 순으로 잔돈 1원씩 분배
    const sortedRest = [...rest].sort((a,b)=> a.localeCompare(b,'ko'));
    sortedRest.forEach((n,i) => {
      shares[n] = base + (i < rem ? 1 : 0);
    });
  }

  const warn = (sumFixed > Math.round(amount));
  return { shares, warn, sumFixed, remainTotal };
}

// [개별 금액] 패널 그리기
function renderOverridesPanel(roundEl){
  const rIdx = +roundEl.dataset.idx;
  const panel = $('[data-role="overrides-panel"]', roundEl);
  const listBox = $('[data-role="overrides-list"]', panel);
  const info = $('[data-role="overrides-info"]', panel);
  const foot = $('[data-role="overrides-foot"]', panel);

  const amount = +($('.amount', roundEl).value || 0);
  // 포함 참석자 계산
  const checked = $$('input[data-role="attend"]:checked', roundEl).map(v=>v.value);
  const excluded = $$('label.pill[data-excluded="1"]', roundEl).map(l=>l.dataset.name).filter(n=>checked.includes(n));
  const included = checked.filter(n=>!excluded.includes(n));

  const ov = editorOverrides[rIdx] || {};
  // 입력 목록
  listBox.innerHTML = included.map(n=>{
    const v = ov[n] ?? '';
    return `
      <div style="display:flex; align-items:center; gap:8px; margin:4px 0;">
        <div style="width:80px;">${n}</div>
        <input type="number" data-role="ov-input" data-name="${n}" value="${v}" placeholder="고정금액(원)" style="flex:1; padding:8px; border:1px solid #cbd5e1; border-radius:8px;">
      </div>`;
  }).join('') || '<div class="muted">참석자를 먼저 선택하세요.</div>';

  // 현재 분배 시뮬레이션
  const { shares, warn, sumFixed, remainTotal } = calcShares(amount, included, ov);
  info.innerHTML = `총액 <b>${(amount||0).toLocaleString('ko-KR')}원</b> · 고정합계 <b>${sumFixed.toLocaleString('ko-KR')}원</b> · 남는금액 <b>${remainTotal.toLocaleString('ko-KR')}원</b>` + (warn ? ' <span style="color:#dc2626;font-weight:700;">(고정합계가 총액을 초과!)</span>' : '');

  // 미리보기 요약
  const rows = Object.entries(shares).sort((a,b)=>a[0].localeCompare(b[0],'ko')).map(([n,v])=>`${n}: ${v.toLocaleString('ko-KR')}원`);
  foot.textContent = rows.join(' · ');
}

// [개별 금액] 차수 카드 요약 문구
function buildOverridesSummary(roundEl){
  const rIdx = +roundEl.dataset.idx;
  const amount = +($('.amount', roundEl).value || 0);
  const checked = $$('input[data-role="attend"]:checked', roundEl).map(v=>v.value);
  const excluded = $$('label.pill[data-excluded="1"]', roundEl).map(l=>l.dataset.name).filter(n=>checked.includes(n));
  const included = checked.filter(n=>!excluded.includes(n));
  const ov = editorOverrides[rIdx] || {};
  const { shares, warn } = calcShares(amount, included, ov);
  const cnt = Object.keys(shares).length;
  if (!cnt) return '';
  return `개별 조정 ${Object.keys(ov).length}명 적용${warn ? ' (초과 경고)' : ''}`;
}

// 뉴멤버 추가 버튼
$('#btnAddMember').onclick = () => {
  // 쉼표(,)나 띄어쓰기 기준으로 여러 명 한 번에 입력도 지원
  const input = prompt('추가할 이름(여러 명은 쉼표 또는 띄어쓰기로 구분):');
  if (!input) return;

  const cand = input
    .split(/[, ]+/)           // , 또는 공백으로 분리
    .map(s => s.trim())
    .filter(Boolean);

  if (!cand.length) return;

  // 이름 정리 & 중복 제거
  const clean = cand
    .map(n => n.replace(/[^\w가-힣·.\-]/g, '')) // 안전 문자만
    .filter(n => n.length > 0);

  // 새로 추가된 게 있는지 체크
  let added = 0;
  clean.forEach(n => {
    if (!allAttendees.includes(n)) {
      allAttendees.push(n);
      added++;
    }
  });

  if (!added) { alert('새로 추가된 이름이 없습니다.'); return; }

  // 정렬(한글 우선 보기 좋게)
  allAttendees.sort((a,b)=> a.localeCompare(b,'ko'));

  // 저장 & 모든 차수 참석자 UI 다시 그리기(체크/제외 상태는 유지됨)
  saveAttendees();
  $$('.round').forEach(r => updateAttendeeListFor(r));
$$('.round').forEach(r => {
  updateAttendeeListFor(r);
  // ⬇️ 열려 있는 패널은 바로 다시 그림, 요약도 업데이트
  const panel = $('[data-role="overrides-panel"]', r);
  if (panel && !panel.classList.contains('hidden')) renderOverridesPanel(r);
  const sumEl = $('[data-role="overrides-summary"]', r);
  if (sumEl) sumEl.textContent = buildOverridesSummary(r);
});
  alert(`뉴멤버 ${added}명 추가 완료!`);
};


</script>

</body>
</html>
