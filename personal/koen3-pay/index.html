<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>남동3기 회식비 정산 (Firebase Storage)</title>
  <style>
    :root { --primary:#2b6cb0; --muted:#f5f7fb; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; margin: 0; background: #fafafa; color:#222; }
    header { position: sticky; top:0; z-index:5; background:#fff; border-bottom:1px solid #e5e7eb; }
    .bar { max-width: 1100px; margin: 0 auto; padding: 10px 14px; display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .bar h1 { font-size: clamp(18px, 4.5vw, 22px); margin:0; }
    .bar .actions { display:flex; gap:6px; flex-wrap:wrap; }
    button, .btn { appearance:none; border:1px solid #cbd5e1; background:#fff; color:#111; padding: 8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    button.primary, .btn.primary { background: var(--primary); color:#fff; border-color: var(--primary); }
    main { max-width: 1100px; margin: 0 auto; padding: 14px; }

    .card { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:14px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .grid { display:grid; gap:12px; }
    .grid-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    @media (max-width: 900px) { .grid-3{grid-template-columns:1fr;} }
    @media (max-width: 700px) { .grid-2{grid-template-columns:1fr;} }

    label { display:block; font-weight:600; margin: 6px 0 4px; }
    input[type="text"], input[type="number"], input[type="date"] { width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; }

    .attendee-list { display:flex; flex-wrap:wrap; gap:8px; background:#f5f7fb; padding:10px; border-radius:10px; }
    .attendee-list .pill { display:inline-flex; align-items:center; gap:6px; background:#fff; border:1px solid #e5e7eb; padding:6px 10px; border-radius:20px; }
    .attendee-list .pill[data-excluded="1"] { opacity:.6; }
    .ex-toggle { border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:3px 6px; font-size:12px; cursor:pointer; }
    .ex-toggle.active { background:#fee2e2; }

    .round { border:1px dashed #d1d5db; border-radius:12px; padding:12px; background:#fcfcfe; }
    .preview-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .preview-row img { height:88px; border-radius:10px; border:1px solid #e5e7eb; }

    table { width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:auto; display:block; }
    th, td { border:1px solid #e5e7eb; padding:10px; text-align:center; white-space:nowrap; }
    thead th { background:#f8fafc; }

    /* 목록(2열, 좌: 정보 / 우: 썸네일) */
    .list-row { display:grid; grid-template-columns: 1fr 120px; gap:12px; align-items:center; padding:12px; border-bottom:1px solid #eee; }
    .list-row:hover { background:#fafcff; }
    .list-head { font-weight:800; color:#475569; grid-template-columns: 1fr 120px; }
    .info-date a { color:var(--primary); font-weight:800; text-decoration:none; }
    .info-title { font-weight:700; margin-top:4px; }
    .info-meta { color:#6b7280; font-size:14px; margin-top:2px; }
    .thumb { width:112px; height:78px; object-fit:cover; border-radius:10px; border:1px solid #e5e7eb; background:#f1f5f9; display:block; margin-left:auto; }
    .thumb.placeholder { display:flex; align-items:center; justify-content:center; font-size:12px; color:#94a3b8; border-style:dashed; width:112px; height:78px; border-radius:10px; border:1px dashed #e5e7eb; margin-left:auto; }
    @media (max-width:700px) { .list-row { grid-template-columns: 1fr; } .thumb, .thumb.placeholder { margin-left:0; width:100%; height:160px; } }

    .paid { color:#16a34a; font-weight:800; }
    .unpaid { color:#dc2626; font-weight:800; }
    .muted { color:#6b7280; }
    .hidden { display:none; }

    .capture-wrap { background:#fff; padding:12px; border-radius:14px; border:1px solid #e5e7eb; }

    /* 라이트박스 */
    .lightbox { position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,.85); display: flex; align-items: center; justify-content: center; padding: 16px; }
    .lightbox.hidden { display: none; }
    .lightbox img { max-width: min(92vw, 1200px); max-height: 92vh; border-radius: 12px; box-shadow: 0 8px 40px rgba(0,0,0,.6); user-select: none; }
    .lightbox .close-btn { position: absolute; top: 10px; right: 10px; border: none; background: rgba(255,255,255,.15); color: #fff; font-size: 28px; line-height: 1; border-radius: 10px; padding: 6px 12px; cursor: pointer; }

    /* 저장 오버레이 */
    .saving { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,.45); z-index: 99999; color: #fff; font-weight: 700; }
    .saving.hidden { display: none; }
    .saving .box { background:#111; padding:16px 20px; border-radius:12px; }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <h1>남동3기 회식비 정산</h1>
      <div class="actions">
        <button class="btn" id="btnList">목록</button>
        <button class="btn" id="btnNew">새 회식</button>
        <button class="btn" id="btnExport">내보내기</button>
        <label class="btn" for="importFile" style="margin:0;">가져오기</label>
        <input id="importFile" type="file" accept="application/json" class="hidden">
      </div>
    </div>
  </header>

  <main>
    <!-- 목록 화면 -->
    <section id="view-list" class="grid">
      <div class="card">
        <div class="list-row list-head">
          <div>정보</div><div style="text-align:right;">사진</div>
        </div>
        <div id="listBody"></div>
        <p class="muted" id="emptyNote" style="display:none; padding:10px 2px;">아직 저장된 회식이 없습니다. “새 회식”을 눌러 입력한 후 저장하세요.</p>
      </div>
    </section>

    <!-- 작성/편집 화면 -->
    <section id="view-editor" class="grid hidden">
      <div class="card">
        <div class="grid grid-3">
          <div>
            <label>회식 날짜</label>
            <input type="date" id="meetingDate">
          </div>
          <div>
            <label>제목</label>
            <input type="text" id="meetingTitle" placeholder="예: 3월 회식">
          </div>
          <div>
            <label>장소</label>
            <input type="text" id="meetingPlace" placeholder="예: 진주 ○○식당">
          </div>
        </div>

        <div style="margin-top:10px;">
          <button class="btn" onclick="addRound()">차수 추가</button>
        </div>

        <div id="rounds" style="margin-top:12px;" class="grid"></div>

        <div style="margin-top:12px;">
          <label>회식 사진 업로드 (여러 장)</label>
          <input type="file" accept="image/*" id="groupPhoto" multiple>
          <div id="photoPreview" class="preview-row" style="margin-top:6px;"></div>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;">
          <button class="btn primary" id="btnSave">이 회식 저장</button>
          <button class="btn" id="btnPreview">정산표 미리보기</button>
        </div>

        <div id="editorPreview" class="card hidden" style="margin-top:12px;">
          <div class="section-title">정산표 미리보기</div>
          <div id="editorSummary"></div>
        </div>
      </div>
    </section>

    <!-- 상세 화면 -->
    <section id="view-detail" class="grid hidden">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
          <div>
            <div id="detailTitle" style="font-weight:900; font-size:18px;"></div>
            <div class="muted" id="detailMeta"></div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn" id="btnBackToList">목록으로</button>
            <button class="btn" id="btnDelete">삭제</button>
            <button class="btn" id="btnCapture">이미지로 저장</button>
            <button class="btn" id="btnEdit">수정하기</button>
          </div>
        </div>

        <div id="detailWrap" class="capture-wrap" style="margin-top:12px;">
          <div id="detailSummary"></div>

          <div style="margin-top:16px;">
            <div class="section-title">영수증</div>
            <div id="detailReceipts" class="preview-row"></div>
          </div>

          <div style="margin-top:16px;">
            <div class="section-title">사진</div>
            <div id="detailPhotos" class="preview-row"></div>
          </div>

          <div style="margin-top:16px;">
            <div class="section-title">입금 확인</div>
            <div id="detailPaid"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- 저장 오버레이 -->
  <div id="savingOverlay" class="saving hidden">
    <div class="box">저장 중… <span id="savingText">준비</span></div>
  </div>

  <!-- 이미지 라이트박스 -->
  <div id="imgModal" class="lightbox hidden" aria-modal="true" role="dialog">
    <img id="imgModalImg" alt="확대 이미지" />
    <button type="button" class="close-btn" id="imgModalClose" aria-label="닫기">×</button>
  </div>

  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Firebase + App 코드 (모듈) -->
  <script type="module">
    /*************
     * Firebase
     *************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // 프로젝트 설정
 const firebaseConfig = {
  apiKey: "AIzaSyBmVXt2ze1iJmmA_YI-sgH3tJmSvZomkOo",
  authDomain: "ionic6-3b7b2.firebaseapp.com",
  databaseURL: "https://ionic6-3b7b2-default-rtdb.firebaseio.com",
  projectId: "ionic6-3b7b2",
  storageBucket: "ionic6-3b7b2.appspot.com",   // ← 이 값으로 교체
  messagingSenderId: "306251113324",
  appId: "1:306251113324:web:456c689fdb4757adc18949"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // 익명 로그인 보장 (전역)
    async function ensureAuth() {
      if (auth.currentUser) return auth.currentUser;
      try {
        const cred = await signInAnonymously(auth);
        return cred.user;
      } catch (err) {
        console.error('익명 로그인 실패:', err);
        throw err;
      }
    }

    // ======= 전역 유틸 =======
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const defaultAttendees = ["성용","범준","기현","승호","재환","창현","계민","인찬","정선","현정","정록","영화","재화","원용","윤숙","인수"];
    let allAttendees = [...defaultAttendees];

    let isEditing = false, editingId = null;
    let editorPhotos = [], newPhotoFiles = [];
    let editorReceipts = {}, newReceiptFiles = {}; // per round

    // DB helpers
    async function getAllMeetings() {
      const snap = await get(ref(db, 'meetings'));
      const obj = snap.exists() ? snap.val() : {};
      return Object.values(obj).sort((a,b)=> (b.date||'').localeCompare(a.date||''));
    }
    async function getMeetingById(id) {
      const snap = await get(ref(db, `meetings/${id}`));
      return snap.exists() ? snap.val() : null;
    }
    async function saveMeetingToDB(meeting) { await set(ref(db, `meetings/${meeting.id}`), meeting); }
    async function deleteMeetingFromDB(id) { await remove(ref(db, `meetings/${id}`)); }
    async function updatePaidStatus(id, paidStatus) { await update(ref(db, `meetings/${id}`), { paidStatus }); }

    // ======= 이미지 처리/업로드 =======
    const MAX_BYTES = 2 * 1024 * 1024; // 2MB
    function showSaving(msg){ $('#savingText').textContent = msg || '처리 중'; $('#savingOverlay').classList.remove('hidden'); }
    function setSaving(msg){ $('#savingText').textContent = msg; }
    function hideSaving(){ $('#savingOverlay').classList.add('hidden'); }

    function loadImage(src){
      return new Promise((resolve,reject)=>{
        const img = new Image(); img.onload=()=>resolve(img); img.onerror=reject; img.src=src;
      });
    }
    function fileToDataURL(file){
      return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
    }
   // ✅ HEIC/HEIF 대응 + createImageBitmap 우선
async function drawToCanvas(src, maxW){
  // 내부 공통 변환: ImageBitmap → Canvas
  async function bitmapToCanvas(bmp, maxW){
    const s = Math.min(1, maxW / bmp.width);
    const w = Math.max(1, Math.round(bmp.width * s));
    const h = Math.max(1, Math.round(bmp.height * s));
    const canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(bmp, 0, 0, w, h);
    try { bmp.close && bmp.close(); } catch(_){}
    return canvas;
  }

  // 1) File이면 createImageBitmap 시도 (HEIC 등 지원 브라우저에서 성공)
  if (src instanceof File) {
    try {
      const bmp = await createImageBitmap(src);
      return await bitmapToCanvas(bmp, maxW);
    } catch (e) {
      // 미지원/실패 → 아래 일반 <img> 로드로 폴백
    }
  }

  // 2) dataURL/URL → <img> 로드
  const url = (typeof src === 'string') ? src : URL.createObjectURL(src);
  const img = await loadImage(url);
  const s = Math.min(1, maxW / img.width);
  const w = Math.max(1, Math.round(img.width * s));
  const h = Math.max(1, Math.round(img.height * s));
  const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
  if (typeof src !== 'string') { try { URL.revokeObjectURL(url); } catch(_){} }
  return canvas;
}

    function canvasToBlob(canvas, quality=0.8, type='image/jpeg'){
      return new Promise((resolve)=> canvas.toBlob(b=>resolve(b), type, quality));
    }
    // ✅ 디코딩 실패 시 원본 업로드 폴백 + 2MB 맞출 때까지 단계적 축소
async function compressWithLimit(fileOrDataURL, {maxW, qualityStart=0.82, minQuality=0.55, step=0.07}){
  try {
    const src = fileOrDataURL; // File 또는 dataURL
    let q = qualityStart, w = maxW, lastBlob = null;

    for (let attempt = 0; attempt < 6; attempt++){
      const canvas = await drawToCanvas(src, w);        // ← 위에서 교체한 함수 사용
      const blob   = await canvasToBlob(canvas, q);     // JPEG
      lastBlob = blob;
      if (blob.size <= MAX_BYTES) return blob;

      // 더 줄이기: 품질 ↓ → 그래도 크면 가로폭 ↓
      if (q > minQuality) q = Math.max(minQuality, q - step);
      else {
        w = Math.round(w * 0.85);
        if (w < 480) return blob; // 최소 폭 이하이면 여기서 종료
      }
    }
    return lastBlob; // 마지막 시도 결과 반환
  } catch (e) {
    // ❗ 디코딩 자체가 안 되는 경우(HEIC 등) → 원본 그대로 업로드
    if (fileOrDataURL instanceof File) return fileOrDataURL;
    throw e; // dataURL인데 실패했다면 상위에서 처리
  }
}

    function randomId(){ return Math.random().toString(36).slice(2,10); }


    function extFromType(t){
  if(!t) return 'jpg';
  t = t.toLowerCase();
  if (t.includes('jpeg')) return 'jpg';
  if (t.includes('png'))  return 'png';
  if (t.includes('webp')) return 'webp';
  if (t.includes('heic')) return 'heic';
  if (t.includes('heif')) return 'heif';
  if (t.includes('avif')) return 'avif';
  return 'jpg';
}

   // ✅ 워치독(30초 무진행 시 재시도) + Blob 타입 반영 + 캐시 설정
async function uploadBlob(meetingId, blob, path, onProgress, maxRetries = 2){
  const tryOnce = () => new Promise((resolve, reject)=>{
    const storageRef = sRef(storage, path);

    // Blob/File 타입을 그대로 반영 (HEIC/AVIF 등도 OK)
    const meta = {
      contentType: (blob && blob.type) ? blob.type : 'image/jpeg',
      cacheControl: 'public, max-age=31536000'
    };

    const task = uploadBytesResumable(storageRef, blob, meta);

    let lastBytes = 0;
    let stalledMs = 0;
    const TICK = 1000;         // 1초마다 체크
    const STALL_LIMIT = 30000; // 30초 무진행 시 재시도

    const watchdog = setInterval(()=>{
      const snap = task.snapshot;
      if (!snap) return;
      if (snap.bytesTransferred > lastBytes) {
        lastBytes = snap.bytesTransferred;
        stalledMs = 0;
      } else {
        stalledMs += TICK;
        if (stalledMs >= STALL_LIMIT) {
          clearInterval(watchdog);
          try { task.cancel(); } catch(_){}
          reject(new Error('upload-stalled'));
        }
      }
    }, TICK);

    task.on('state_changed',
      (snap)=>{
        if (onProgress) {
          const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
          onProgress(pct);
        }
      },
      (err)=>{
        clearInterval(watchdog);
        reject(err);
      },
      async ()=>{
        clearInterval(watchdog);
        try {
          const url = await getDownloadURL(task.snapshot.ref);
          resolve(url);
        } catch (e) {
          reject(e);
        }
      }
    );
  });

  let attempt = 0, lastErr = null;
  while (attempt <= maxRetries){
    try {
      if (attempt > 0) setSaving(`재시도 중... (${attempt}/${maxRetries})`);
      return await tryOnce();
    } catch (e) {
      lastErr = e;
      // 권한 문제는 재시도해도 소용 없음 → 즉시 실패
      if (String(e.code||'').includes('unauthorized')) throw e;

      // 스톨/네트워크 이슈는 재시도
      attempt++;
      await new Promise(r => setTimeout(r, 800)); // 짧게 쉬고 재시도
    }
  }
  throw lastErr || new Error('upload-failed');
}


    async function uploadPhotoSet(meetingId, file, index, total){
  setSaving(`사진 ${index}/${total} 준비`);

  // 원본(표시용)과 썸네일 후보 생성
  const fullBlob  = await compressWithLimit(file, { maxW: 1400, qualityStart: 0.82 });
  const thumbBlob = await compressWithLimit(file, { maxW: 320,  qualityStart: 0.75 });

  const base = `meetings/${meetingId}`;
  const nameBase = `${Date.now()}_${randomId()}`;

  // 파일 확장자는 실제 blob.type에 맞춰서
  const fullExt  = extFromType(fullBlob && fullBlob.type);
  const fullPath = `${base}/photos/${nameBase}.${fullExt}`;

  setSaving(`사진 업로드 ${index}/${total} (원본)`);
  const fullUrl  = await uploadBlob(meetingId, fullBlob, fullPath, (p)=>setSaving(`사진 업로드 ${index}/${total} (원본 ${p}%)`));

  // 썸네일: 변환 실패/부적절하면 fullUrl로 폴백
  let thumbUrl = fullUrl;
  try {
    // thumbBlob가 존재하고, 사이즈도 충분히 작으며, fullBlob과 다른 객체일 때만 업로드
    if (thumbBlob && thumbBlob !== fullBlob) {
      const thumbExt  = extFromType(thumbBlob.type);
      const thumbPath = `${base}/thumbs/${nameBase}.${thumbExt}`;
      setSaving(`사진 업로드 ${index}/${total} (썸네일)`);
      thumbUrl = await uploadBlob(meetingId, thumbBlob, thumbPath, (p)=>setSaving(`사진 업로드 ${index}/${total} (썸네일 ${p}%)`));
    }
  } catch(_) {
    // 썸네일 업로드 실패 → 그대로 fullUrl 사용
    thumbUrl = fullUrl;
  }

  return { full: fullUrl, thumb: thumbUrl };
}


    async function uploadReceipt(meetingId, roundIdx, file, index, total){
  setSaving(`영수증 ${index}/${total} 준비`);
  const blob = await compressWithLimit(file, { maxW: 1200, qualityStart: 0.8 });

  const base = `meetings/${meetingId}`;
  const nameBase = `${Date.now()}_${randomId()}`;
  const ext = extFromType(blob && blob.type);
  const path = `${base}/receipts/${nameBase}.${ext}`;

  const url = await uploadBlob(
    meetingId,
    blob,
    path,
    (p)=> setSaving(`영수증 업로드 ${index}/${total} (${p}%)`)
  );
  return url;
}


    // ======= 화면 전환 =======
    const viewList = $('#view-list'), viewEditor = $('#view-editor'), viewDetail = $('#view-detail');
    function show(id){ [viewList,viewEditor,viewDetail].forEach(v=>v.classList.add('hidden')); id.classList.remove('hidden'); window.scrollTo({top:0, behavior:'smooth'}); }

    $('#btnList').onclick = ()=> { renderList(); show(viewList); };
    $('#btnNew').onclick  = ()=> { resetEditor(); show(viewEditor); };

    // 내보내기/가져오기
    $('#btnExport').onclick = async ()=>{
      const data = await getAllMeetings();
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = '남동3기-회식정산-백업.json';
      a.click(); URL.revokeObjectURL(a.href);
    };
    $('#importFile').onchange = async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      try{
        const list = JSON.parse(await f.text());
        if (!Array.isArray(list)) throw new Error('형식 오류');
        for (const m of list) { if (m && m.id) await saveMeetingToDB(m); }
        alert('가져오기가 완료되었습니다.'); await renderList(); show(viewList);
      }catch(err){ alert('가져오기 실패: '+err.message); }
      finally { e.target.value=''; }
    };

    // ======= 목록(2열) =======
    async function renderList(){
      const list = await getAllMeetings();
      const body = $('#listBody'); body.innerHTML=''; $('#emptyNote').style.display = list.length ? 'none' : 'block';
      list.forEach(item=>{
        const unique = new Set(item.rounds.flatMap(r=>r.attendees||[]));
        let thumbSrc = null;
        if (item.photos && item.photos[0]){
          const p = item.photos[0];
          thumbSrc = typeof p === 'string' ? p : (p.thumb || p.full);
        }
        const row = document.createElement('div'); row.className='list-row';
        row.innerHTML = `
          <div>
            <div class="info-date"><a href="#" data-id="${item.id}" class="link-date">${item.date||'-'}</a></div>
            <div class="info-title">${item.title||'-'}</div>
            <div class="info-meta">참석 ${unique.size.toLocaleString('ko-KR')}명 · 장소 ${item.place||'-'}</div>
          </div>
          <div>${thumbSrc ? `<img src="${thumbSrc}" alt="회식 썸네일" class="thumb zoomable" loading="lazy">` : `<div class="thumb placeholder">사진없음</div>`}</div>
        `;
        body.appendChild(row);
      });
      $$('.link-date', body).forEach(a=> a.onclick = (e)=>{ e.preventDefault(); openDetail(a.dataset.id); });
    }

    // ======= 작성/편집 =======
    function resetEditor(){
      isEditing=false; editingId=null; editorPhotos=[]; newPhotoFiles=[]; editorReceipts={}; newReceiptFiles={};
      $('#meetingDate').value=''; $('#meetingTitle').value=''; $('#meetingPlace').value='';
      $('#rounds').innerHTML=''; $('#groupPhoto').value=''; $('#photoPreview').innerHTML='';
      $('#editorPreview').classList.add('hidden'); $('#editorSummary').innerHTML='';
      addRound();
    }

    function addRound(){
      const container = document.createElement('div');
      const idx = $$('.round').length;
      container.className='round'; container.dataset.idx=String(idx);
      editorReceipts[idx]=editorReceipts[idx]||[]; newReceiptFiles[idx]=newReceiptFiles[idx]||[];

      container.innerHTML = `
        <div class="section-title">${idx+1}차</div>
        <div class="grid grid-3">
          <div>
            <label>금액(원)</label>
            <input type="number" class="amount" min="0" placeholder="예: 150000">
            <label style="margin-top:6px;">
              <input type="checkbox" class="corpCard"> 이 차수는 법인카드(개인 정산 없음)
            </label>
          </div>
          <div>
            <label>영수증 업로드</label>
            <input type="file" accept="image/*" class="receiptInput" multiple>
          </div>
          <div>
            <label class="muted">영수증 미리보기</label>
            <div class="receiptPreview preview-row"></div>
          </div>
        </div>
        <div style="margin-top:8px;">
          <div class="section-title">참석자 (필요 시 ‘제외’ 토글)</div>
          <div class="attendee-list"></div>
        </div>`;
      $('#rounds').appendChild(container);
      updateAttendeeListFor(container);

      $('.receiptInput', container).addEventListener('change', (e)=>{
  const files = Array.from(e.target.files || []);
  const rIdx = parseInt(container.dataset.idx, 10);
  newReceiptFiles[rIdx].push(...files);      // 용량과 관계없이 모두 추가
  renderReceiptPreview(container);
  e.target.value = '';
});

      renderReceiptPreview(container);

      $('.corpCard', container).addEventListener('change', (e)=>{
        const amountEl = $('.amount', container);
        if (e.target.checked){ amountEl.value=''; amountEl.disabled=true; amountEl.placeholder='법인카드 - 금액입력 불필요'; }
        else { amountEl.disabled=false; amountEl.placeholder='예: 150000'; }
      });
    }

    function updateAttendeeListFor(roundEl){
      const div = $('.attendee-list', roundEl);
      const prevChecked = $$('input[data-role="attend"]:checked', div).map(el=>el.value);
      const prevExcluded = $$('label.pill[data-excluded="1"]', div).map(el=>el.dataset.name);
      div.innerHTML = allAttendees.map(n=>{
        const checked = prevChecked.includes(n) ? 'checked' : '';
        const excluded = prevExcluded.includes(n) ? ' data-excluded="1"' : '';
        const exText = prevExcluded.includes(n) ? '제외됨' : '제외';
        return `
          <label class="pill"${excluded} data-name="${n}">
            <input type="checkbox" data-role="attend" value="${n}" ${checked}> ${n}
            <button type="button" class="ex-toggle${prevExcluded.includes(n)?' active':''}" data-role="ex-toggle" data-name="${n}">${exText}</button>
          </label>`;
      }).join('');
    }

    function renderReceiptPreview(roundEl){
      const rIdx = parseInt(roundEl.dataset.idx,10);
      const box = roundEl.querySelector('.receiptPreview'); box.innerHTML='';
      (editorReceipts[rIdx]||[]).forEach((src,i)=>{
        const viewSrc = typeof src === 'string' ? src : (src.thumb || src.full || src);
        const wrap = document.createElement('div'); wrap.className='preview-row';
        const img = document.createElement('img'); img.src=viewSrc; img.alt='영수증'; img.classList.add('zoomable');
        const btn = document.createElement('button'); btn.className='ex-toggle'; btn.textContent='삭제';
        btn.dataset.role='del-receipt-existing'; btn.dataset.idx=String(rIdx); btn.dataset.i=String(i);
        wrap.appendChild(img); wrap.appendChild(btn); box.appendChild(wrap);
      });
      (newReceiptFiles[rIdx]||[]).forEach((file,i)=>{
        const url = URL.createObjectURL(file);
        const wrap = document.createElement('div'); wrap.className='preview-row';
        const img = document.createElement('img'); img.src=url; img.alt='영수증(신규)'; img.classList.add('zoomable');
        const btn = document.createElement('button'); btn.className='ex-toggle'; btn.textContent='삭제';
        btn.dataset.role='del-receipt-new'; btn.dataset.idx=String(rIdx); btn.dataset.i=String(i);
        wrap.appendChild(img); wrap.appendChild(btn); box.appendChild(wrap);
        img.onload = ()=> URL.revokeObjectURL(url);
      });
    }

    $('#groupPhoto').addEventListener('change', (e)=>{
  const files = Array.from(e.target.files || []);
  newPhotoFiles.push(...files);   // 용량과 관계없이 모두 추가
  renderPhotoPreview();
  e.target.value = '';
});
    function renderPhotoPreview(){
      const box = $('#photoPreview'); box.innerHTML='';
      editorPhotos.forEach((src,i)=>{
        const viewSrc = (typeof src === 'string') ? src : (src.thumb || src.full);
        const wrap = document.createElement('div'); wrap.className='preview-row';
        const img = document.createElement('img'); img.src=viewSrc; img.alt='사진'; img.classList.add('zoomable');
        const btn = document.createElement('button'); btn.className='ex-toggle'; btn.textContent='삭제'; btn.dataset.role='del-photo-existing'; btn.dataset.i=String(i);
        wrap.appendChild(img); wrap.appendChild(btn); box.appendChild(wrap);
      });
      newPhotoFiles.forEach((file,i)=>{
        const url = URL.createObjectURL(file);
        const wrap = document.createElement('div'); wrap.className='preview-row';
        const img = document.createElement('img'); img.src=url; img.alt='사진(신규)'; img.classList.add('zoomable');
        const btn = document.createElement('button'); btn.className='ex-toggle'; btn.textContent='삭제'; btn.dataset.role='del-photo-new'; btn.dataset.i=String(i);
        wrap.appendChild(img); wrap.appendChild(btn); box.appendChild(wrap);
        img.onload = ()=> URL.revokeObjectURL(url);
      });
    }

    // 미리보기
    $('#btnPreview').onclick = ()=>{
      const dummy = buildSummaryFromEditor(); if(!dummy) return;
      $('#editorSummary').innerHTML = dummy.html; $('#editorPreview').classList.remove('hidden');
    };

    function buildSummaryFromEditor(){
      const roundEls = $$('.round'); if(!roundEls.length){ alert('차수를 추가하세요.'); return null; }
      const roundTitles = roundEls.map((_,i)=>`${i+1}차`);
      const memberMap = {};
      for(let i=0;i<roundEls.length;i++){
        const el = roundEls[i];
        const corp = $('.corpCard', el).checked;
        const amountRaw = $('.amount', el).value.trim();
        const amount = amountRaw === '' ? null : parseInt(amountRaw,10);
        const checked = $$('input[data-role="attend"]:checked', el).map(v=>v.value);
        const excluded = $$('label.pill[data-excluded="1"]', el).map(l=>l.dataset.name).filter(n=>checked.includes(n));
        const included = checked.filter(n=>!excluded.includes(n));
        if (!corp && amount && included.length>0){
          const per = amount / included.length;
          included.forEach(n=>{
            if(!memberMap[n]) memberMap[n]={ total:0, rounds:[] };
            memberMap[n].rounds[i] = per; memberMap[n].total += per;
          });
        }
      }
      const rows = Object.entries(memberMap).sort((a,b)=>a[0].localeCompare(b[0],'ko'));
      let html = `<table><thead><tr><th>이름</th>${roundTitles.map(r=>`<th>${r}</th>`).join('')}<th>총액</th></tr></thead><tbody>`;
      rows.forEach(([name,data])=>{
        html += `<tr><td>${name}</td>`;
        for(let i=0;i<roundTitles.length;i++){
          const v = data.rounds[i] ? formatNumber(data.rounds[i])+'원' : '-';
          html += `<td>${v}</td>`;
        }
        html += `<td><strong>${formatNumber(data.total)}원</strong></td></tr>`;
      });
      html += `</tbody></table>`;
      return { html, count: rows.length };
    }

    function formatNumber(num){ return Math.round(num).toLocaleString('ko-KR'); }

    // ======= 저장 버튼 (업로드 → DB) =======
    $('#btnSave').onclick = async ()=>{
      try {
        const btn = $('#btnSave');
        btn.disabled = true; btn.textContent = '저장 중…';
        showSaving('준비 중…');

        await ensureAuth();

        const date = $('#meetingDate').value;
        const title = $('#meetingTitle').value.trim();
        const place = $('#meetingPlace').value.trim();
        if(!date || !title){ alert('날짜와 제목은 필수입니다.'); throw new Error('required'); }

        const meetingId = isEditing ? editingId : Date.now().toString();

        // rounds 메타 수집
        const roundEls = $$('.round'); if(!roundEls.length){ alert('차수를 추가하세요.'); throw new Error('no rounds'); }
        const rounds = [];
        for(let i=0;i<roundEls.length;i++){
          const el = roundEls[i];
          const corp = $('.corpCard', el).checked;
          const amountRaw = $('.amount', el).value.trim();
          const amount = amountRaw === '' ? null : parseInt(amountRaw,10);
          const attendees = $$('input[data-role="attend"]:checked', el).map(cb=>cb.value);
          if(!attendees.length){ alert(`${i+1}차 참석자를 선택하세요.`); throw new Error('no attendees'); }
          const exclusions = $$('label.pill[data-excluded="1"]', el).map(l=>l.dataset.name).filter(n=>attendees.includes(n));
          rounds.push({ amount, attendees, exclusions, corp, receiptImages: [] }); // URL 나중에 채움
        }

        // 사진 업로드 (기존+신규)
        const photos = [];
        // 기존 보존(문자열 or {full,thumb})
        editorPhotos.forEach(p=>{
          if (typeof p === 'string') photos.push(p); else photos.push({full: p.full, thumb: p.thumb || p.full});
        });
        // 신규 업로드
        for(let i=0;i<newPhotoFiles.length;i++){
          const result = await uploadPhotoSet(meetingId, newPhotoFiles[i], i+1, newPhotoFiles.length);
          photos.push(result); // {full, thumb}
        }

        // 영수증 업로드
        const totalReceipts = Object.values(newReceiptFiles).reduce((acc,arr)=> acc + (arr?.length||0), 0) || 0;
        let uploaded = 0;
        for(let r=0;r<rounds.length;r++){
          // 기존 보존(문자열 URL 또는 dataURL)
          (editorReceipts[r]||[]).forEach(u=>{
            if (typeof u === 'string') rounds[r].receiptImages.push(u);
            else rounds[r].receiptImages.push(u.full || u.thumb); // 혹시 객체 형태가 들어온 경우
          });
          // 신규 업로드
          const files = newReceiptFiles[r] || [];
          for (let i=0;i<files.length;i++){
            const url = await uploadReceipt(meetingId, r, files[i], ++uploaded, totalReceipts);
            rounds[r].receiptImages.push(url);
          }
        }

        // paidStatus
        let paidStatus = {};
        if(!isEditing){
          const people = Array.from(new Set(rounds.flatMap(r=> r.attendees.filter(n=> !(r.exclusions||[]).includes(n)) )));
          paidStatus = Object.fromEntries(people.map(n=>[n,false]));
        }

        const data = { id: meetingId, date, title, place, rounds, photos, paidStatus };

        // 편집 시 paidStatus 병합
        if (isEditing) {
          const old = await getMeetingById(editingId);
          if (!old) throw new Error('기존 데이터 없음');
          const newIncluded = Array.from(new Set(
            data.rounds.flatMap(r=> r.attendees.filter(n=> !(r.exclusions||[]).includes(n)))
          ));
          const merged = {};
          newIncluded.forEach(n=>{
            merged[n] = (old.paidStatus && n in old.paidStatus) ? old.paidStatus[n] : false;
          });
          data.paidStatus = merged;
        }

        await saveMeetingToDB(data);
        alert(isEditing ? '수정되었습니다.' : '저장되었습니다.');
        await renderList(); show(viewList);

        // 에디터 초기화
        resetEditor();

      } catch (e) {
        console.error(e);
        alert(`저장 실패: ${e.code || e.name || ''}\n${e.message || e}`);
      } finally {
        hideSaving();
        const btn = $('#btnSave');
        btn.disabled = false; btn.textContent = '이 회식 저장';
      }
    };

    // ======= 상세 보기 / 수정 / 입금 토글 / 삭제 =======
    async function openDetail(id){
      const item = await getMeetingById(id);
      if(!item){ alert('데이터를 찾을 수 없습니다.'); return; }
      $('#detailTitle').textContent = item.title||'(제목 없음)';
      const uniqueCnt = new Set(item.rounds.flatMap(r=>r.attendees)).size;
      $('#detailMeta').textContent = `${item.date||'-'} · 참석 ${uniqueCnt.toLocaleString('ko-KR')}명 · 장소 ${item.place||'-'}`;

      $('#detailSummary').innerHTML = buildSummaryHTML(item);

      const recWrap = $('#detailReceipts'); recWrap.innerHTML='';
      item.rounds.forEach((r,idx)=> (r.receiptImages||[]).forEach(src=>{
        const viewSrc = (typeof src === 'string') ? src : (src.full || src.thumb || src);
        const img=document.createElement('img'); img.src=viewSrc; img.alt=`${idx+1}차 영수증`; img.classList.add('zoomable'); recWrap.appendChild(img);
      }));
      const pWrap = $('#detailPhotos'); pWrap.innerHTML='';
      (item.photos||[]).forEach(p=>{
        const viewSrc = (typeof p === 'string') ? p : (p.full || p.thumb);
        const img=document.createElement('img'); img.src=viewSrc; img.alt='회식 사진'; img.classList.add('zoomable'); pWrap.appendChild(img);
      });

      renderPaidTable(item);

      $('#btnBackToList').onclick = async ()=>{ await renderList(); show(viewList); };
      $('#btnDelete').onclick = async ()=>{
        if(!confirm('이 회식 기록을 삭제할까요?')) return;
        await deleteMeetingFromDB(id);
        await renderList(); show(viewList);
      };
      $('#btnCapture').onclick = ()=> captureElement(
        $('#detailSummary'),
        `정산결과_${item.date||'회식'}-${(item.title||'').replace(/[\\/:*?"<>|]/g,'')}.png`
      );
      $('#btnEdit').onclick = ()=> startEdit(id);

      show(viewDetail);
    }

    function buildSummaryHTML(item){
      const roundTitles = item.rounds.map((_,i)=>`${i+1}차`);
      const memberMap = {};
      item.rounds.forEach((r,idx)=>{
        const included = (r.attendees||[]).filter(n=> !(r.exclusions||[]).includes(n));
        if (!r.corp && r.amount && included.length>0){
          const per = r.amount / included.length;
          included.forEach(n=>{
            if(!memberMap[n]) memberMap[n]={ total:0, rounds:[] };
            memberMap[n].rounds[idx] = per; memberMap[n].total += per;
          });
        }
      });
      const entries = Object.entries(memberMap).sort((a,b)=>a[0].localeCompare(b[0],'ko'));
      let html = `<div class="section-title">정산 결과</div>`;
      html += `<table><thead><tr><th>이름</th>${roundTitles.map(r=>`<th>${r}</th>`).join('')}<th>총액</th></tr></thead><tbody>`;
      entries.forEach(([name,data])=>{
        html += `<tr><td>${name}</td>`;
        for(let i=0;i<roundTitles.length;i++){
          const v = data.rounds[i] ? formatNumber(data.rounds[i])+'원' : '-';
          html += `<td>${v}</td>`;
        }
        html += `<td><strong>${formatNumber(data.total)}원</strong></td></tr>`;
      });
      html += `</tbody></table>`;
      return html;
    }

    function renderPaidTable(item){
      const totals = {};
      item.rounds.forEach(r=>{
        const included = (r.attendees||[]).filter(n=> !(r.exclusions||[]).includes(n));
        if (!r.corp && r.amount && included.length>0){
          const per = r.amount / included.length;
          included.forEach(n=> totals[n] = (totals[n]||0) + per);
        }
      });
      const names = Object.keys(totals).sort((a,b)=>a.localeCompare(b,'ko'));
      const wrap = $('#detailPaid');
      let html = `<table><thead><tr><th>이름</th><th>총액</th><th>입금 상태</th></tr></thead><tbody>`;
      names.forEach(n=>{
        const paid = !!item.paidStatus?.[n];
        html += `<tr>
          <td>${n}</td>
          <td>${formatNumber(totals[n])}원</td>
          <td><button class="${paid?'paid':'unpaid'}" data-name="${n}" data-id="${item.id}">
            ${paid?'확인됨':'미입금'}
          </button></td>
        </tr>`;
      });
      html += `</tbody></table>`;
      wrap.innerHTML = html;

      $$('button[data-name]', wrap).forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.dataset.id, name = btn.dataset.name;
          const fresh = await getMeetingById(id);
          const next = { ...(fresh.paidStatus||{}) };
          next[name] = !next[name];
          await updatePaidStatus(id, next);
          renderPaidTable({ ...fresh, paidStatus: next });
        };
      });
    }

    function startEdit(id){
      getMeetingById(id).then(item=>{
        if(!item){ alert('수정할 데이터를 찾지 못했습니다.'); return; }
        isEditing=true; editingId=id;

        const allNames = Array.from(new Set(item.rounds.flatMap(r=>r.attendees)));
        allNames.forEach(n=>{ if(!allAttendees.includes(n)) allAttendees.push(n); });

        $('#meetingDate').value=item.date||''; $('#meetingTitle').value=item.title||''; $('#meetingPlace').value=item.place||'';
        editorPhotos=[...(item.photos||[])]; newPhotoFiles=[]; $('#rounds').innerHTML=''; editorReceipts={}; newReceiptFiles={};

        item.rounds.forEach((r,i)=>{
          addRound();
          const roundEl = $$('.round')[i];
          const amountEl = $('.amount', roundEl); const corpEl=$('.corpCard', roundEl);
          amountEl.value = (r.amount??'') === null ? '' : (r.amount??'');
          corpEl.checked = !!r.corp;
          if (corpEl.checked){ amountEl.value=''; amountEl.disabled=true; amountEl.placeholder='법인카드 - 금액입력 불필요'; }

          editorReceipts[i] = [...(r.receiptImages||[])]; newReceiptFiles[i]=[]; renderReceiptPreview(roundEl);

          updateAttendeeListFor(roundEl);
          const labels = $$('label.pill', roundEl);
          labels.forEach(lbl=>{
            const name = lbl.dataset.name;
            const cb = $('input[data-role="attend"]', lbl);
            cb.checked = r.attendees.includes(name);
            if ((r.exclusions||[]).includes(name)){
              lbl.setAttribute('data-excluded','1');
              const btn = $('[data-role="ex-toggle"]', lbl);
              if(btn){ btn.textContent='제외됨'; btn.classList.add('active'); }
            }
          });
        });

        renderPhotoPreview();
        show(viewEditor);
      });
    }

    // ======= 캡처 & 라이트박스 =======
    async function captureElement(el, filename='정산결과.png'){
      const canvas = await html2canvas(el,{ scale:2, useCORS:true, backgroundColor:'#fff',
        windowWidth: el.scrollWidth, windowHeight: el.scrollHeight, scrollX:0, scrollY:-window.scrollY });
      const link = document.createElement('a'); link.download=filename; link.href=canvas.toDataURL('image/png'); link.click();
    }
    window.captureElement = captureElement;

    const imgModal = $('#imgModal'), imgModalImg = $('#imgModalImg'), imgModalClose = $('#imgModalClose');
    function openImgModal(src){ imgModalImg.src=src; imgModal.classList.remove('hidden'); document.body.style.overflow='hidden'; }
    function closeImgModal(){ imgModal.classList.add('hidden'); imgModalImg.src=''; document.body.style.overflow=''; }
    imgModalClose.addEventListener('click', closeImgModal);
    imgModal.addEventListener('click', e=>{ if(e.target===imgModal) closeImgModal(); });
    document.addEventListener('keydown', e=>{ if(e.key==='Escape' && !imgModal.classList.contains('hidden')) closeImgModal(); });

    document.addEventListener('click', (e)=>{
      const img = e.target.closest('img.zoomable'); if(img){ openImgModal(img.src); return; }
      const btn = e.target.closest('[data-role]'); if(!btn) return;
      if (btn.dataset.role === 'ex-toggle'){
        const pill = btn.closest('label.pill'); if(!pill) return;
        const isEx = pill.getAttribute('data-excluded') === '1';
        pill.setAttribute('data-excluded', isEx ? '0' : '1');
        btn.textContent = isEx ? '제외' : '제외됨';
        btn.classList.toggle('active', !isEx);
        return;
      }
      if (btn.dataset.role === 'del-photo-existing'){ const i = +btn.dataset.i; editorPhotos.splice(i,1); renderPhotoPreview(); return; }
      if (btn.dataset.role === 'del-photo-new'){ const i = +btn.dataset.i; newPhotoFiles.splice(i,1); renderPhotoPreview(); return; }
      if (btn.dataset.role === 'del-receipt-existing'){ const rIdx=+btn.dataset.idx, i=+btn.dataset.i; (editorReceipts[rIdx]||[]).splice(i,1); const roundEl=$$('.round')[rIdx]; if(roundEl) renderReceiptPreview(roundEl); return; }
      if (btn.dataset.role === 'del-receipt-new'){ const rIdx=+btn.dataset.idx, i=+btn.dataset.i; (newReceiptFiles[rIdx]||[]).splice(i,1); const roundEl=$$('.round')[rIdx]; if(roundEl) renderReceiptPreview(roundEl); return; }
    });

    // ======= 초기화 =======
    function initUI(){
      $('#btnCapture').onclick = ()=> captureElement($('#detailSummary'), '정산결과.png');
      renderList(); show(viewList);
    }

    signInAnonymously(auth).catch((err)=>{
      console.error('Firebase 익명 로그인 실패:', err);
      alert(`로그인 실패: ${err.code}\n${err.message}`);
    });

    onAuthStateChanged(auth, (user)=>{
      if (user) { initUI(); }
    });

    // 전역 노출
    window.addRound = addRound;
  </script>
</body>
</html>
