<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>너야너 룰렛</title>
<style>
  :root{
    --accent:#2563eb;
    --bg:#f6f7fb;
    --ink:#111827;
    --muted:#6b7280;
    --card:#ffffff;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,"Noto Sans KR",sans-serif;
    min-height:100dvh; display:grid; grid-template-rows:auto 1fr auto;
  }
  header{
    padding:14px 16px; background:#fff; border-bottom:1px solid #e5e7eb;
    position:sticky; top:0; z-index:5;
  }
  h1{margin:0; font-size:20px; letter-spacing:.3px}
  main{display:grid; place-items:center; padding:18px}
  .panel{
    width:min(960px,95vw); background:var(--card); border:1px solid #e5e7eb;
    border-radius:16px; padding:10px; box-shadow:0 6px 24px rgba(0,0,0,.06);
  }
  .row{display:flex; gap:10px; flex-wrap:nowrap; align-items:center; margin:8px 0 10px}
  label{font-size:14px; color:var(--muted)}
  input,button{
    font-size:16px; padding:10px 12px; border-radius:12px; border:1px solid #d1d5db; background:#fff;
  }
  input[type=number]{width:110px}
  button{
    border:none; color:#fff; cursor:pointer; background:var(--accent);
    padding:10px 16px; font-weight:600; box-shadow:0 4px 14px rgba(37,99,235,.22);
  }
  button.secondary{ background:#6b7280; box-shadow:none }
  button.ghost{ background:#fff; color:#1f2937; border:1px solid #d1d5db; box-shadow:none }
  button:disabled{opacity:.55; cursor:not-allowed}
  .grid{ display:grid; grid-template-columns:1fr; gap:14px; margin-top:10px; }
  @media(min-width:880px){ .grid{ grid-template-columns:1.25fr .95fr; align-items:start; } }

  /* ===== 보드(캔버스+로터만) ===== */
  .canvas-wrap{
    background:conic-gradient(from 0deg, #fafafa, #ffffff);
    border-radius:18px; border:1px solid #e5e7eb; padding:14px;
  }
  .board{ position:relative; display:inline-block; width:100%; }
  canvas{ display:block; width:100%; height:auto; border-radius:10px; background:#fff; }

  /* 중앙 회전 로터: 보드(=캔버스) 정중앙을 축으로 */
  .arrow-rotor{
    position:absolute;
    top:50%; left:50%;
    transform:translate(-50%,-50%) rotate(0deg);
    width:0; height:0;           /* 회전 원점이 이 한 점 */
    pointer-events:none;
  }
  /* 화살표(몸통+촉) — 작은 원/링 없음 */
  .arrow-body{
    position:absolute;
    left:-5px;         /* 몸통 폭 10px 중앙정렬 */
    top:-70px;         /* 중심에서 위로 70px */
    width:10px; height:70px;
    background:var(--accent);
    border-radius:6px;
    filter:drop-shadow(0 4px 6px rgba(0,0,0,.25));
  }
  .arrow-head{
    position:absolute;
    left:-16px;        /* 밑변 32px 중앙정렬 */
    top:-98px;         /* 몸통(70) 위에 연결 (촉높이 28) */
    width:0; height:0;
    border-left:16px solid transparent;
    border-right:16px solid transparent;
    border-bottom:28px solid var(--accent); /* ↑ 방향 */
    filter:drop-shadow(0 6px 10px rgba(0,0,0,.25));
  }

  .tools{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px }
  .tools h3{ margin:0 0 8px 0; font-size:16px }
  .muted{ color:#6b7280; font-size:13px }
  .list{ display:grid; gap:6px; max-height:46vh; overflow:auto; padding-right:4px; }
  .list input{ width:100% }
  .badge{ display:inline-flex; align-items:center; gap:6px; border-radius:999px; background:#eef2ff; color:#1d4ed8; padding:6px 10px; font-size:13px; font-weight:600; }
  .center-row{ display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-top:10px }
  .result{ margin-top:8px; font-size:18px; text-align:center; min-height:28px; }
  footer{ padding:10px 14px; text-align:center; color:#9ca3af; font-size:12px }
</style>
</head>
<body>
  <header><h1>너야너 룰렛</h1></header>

  <main>
    <div class="panel">
      <div class="row">
        <label>인원 수</label>
        <input type="number" id="count" min="2" max="50" value="6" />
        <button id="build">참가자 생성</button>
        <button id="shuffle" class="ghost">순서<br>섞기</button>
       <!--<span class="muted">오른쪽에서 이름을 바꾸면 룰렛에 즉시 반영됩니다.</span> -->
      </div>

      <div class="grid">
        <!-- 왼쪽: 룰렛 -->
        <div class="canvas-wrap">
          <!-- 보드 안에는 '캔버스 + 로터'만 -->
          <div id="board" class="board">
            <canvas id="wheel" aria-label="룰렛"></canvas>
            <div id="rotor" class="arrow-rotor">
              <div class="arrow-body"></div>
              <div class="arrow-head"></div>
            </div>
          </div>

          <!-- 버튼/결과는 보드 바깥 ⇒ 중심 불일치 없음 -->
          <div class="center-row">
            <button id="spin" title="누르고 있으면 빠르게 회전, 떼면 감속 후 5~6초 뒤 정지">시작(돌리기)</button>
            <button id="reset" class="ghost">초기화</button>
          </div>
          <div id="result" class="result"></div>
        </div>

        <!-- 오른쪽: 참가자 이름 편집 -->
        <div class="tools">
          <h3>참가자 이름</h3>
          <div class="row">
            <span class="badge">Tip</span>
            <span class="muted">“참가자 생성” 후 이곳에서 이름을 바꾸면 바로 반영됩니다.</span>
          </div>
          <div id="nameList" class="list"></div>
          <div class="row" style="margin-top:10px">
            <button id="autofill" class="secondary">이름 자동 채우기(1번~n번)</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>© 너야너 • 중앙 화살표 회전 • 모바일 대응</footer>

<script>
(() => {
  // ===== 상태 =====
  let names = ["1번","2번","3번","4번","5번","6번"];
  let spinning = false;       // 감속 애니메이션 중
  let isHolding = false;      // 버튼 홀드 중(마우스/터치)
  let rafId = null;           // RAF id
  let currentDeg = 0;         // 현재 각도(↑=0°, 시계방향 +)

  // ===== 엘리먼트 =====
  const $board = document.getElementById('board');
  const $wheel = document.getElementById('wheel');
  const $rotor = document.getElementById('rotor');
  const $count = document.getElementById('count');
  const $build = document.getElementById('build');
  const $nameList = document.getElementById('nameList');
  const $spin = document.getElementById('spin');
  const $reset = document.getElementById('reset');
  const $autofill = document.getElementById('autofill');
  const $shuffle = document.getElementById('shuffle');
  const $result = document.getElementById('result');

  // ===== 캔버스 크기/스케일(보드 기준, 레티나 대응) =====
  function resizeCanvas() {
    const cssSize = Math.max(320, Math.min(820, Math.floor($board.clientWidth)));
    const dpr = Math.min(devicePixelRatio || 1, 2);
    $wheel.width = cssSize * dpr;
    $wheel.height = cssSize * dpr;
    $wheel.style.width = cssSize + "px";
    $wheel.style.height = cssSize + "px";
    drawWheel();
  }

  // ===== 섹터 색상 =====
  function sectorColor(i){
    const base = ["#fde047","#93c5fd","#fca5a5","#a7f3d0","#c4b5fd","#fcd34d","#bae6fd","#fecaca","#86efac","#ddd6fe"];
    return base[i % base.length];
  }

  // ===== 룰렛 그리기 =====
  function drawWheel(){
    const ctx = $wheel.getContext('2d');
    const W = $wheel.width, H = $wheel.height;
    const r = Math.min(W,H)/2 - 12 * (devicePixelRatio || 1);
    const cx = W/2, cy = H/2;
    ctx.clearRect(0,0,W,H);

    // 외곽 그림자 링
    ctx.save();
    ctx.beginPath(); ctx.arc(cx,cy,r+6,0,Math.PI*2);
    ctx.strokeStyle = "#11182722"; ctx.lineWidth = 12; ctx.stroke();
    ctx.restore();

    const n = names.length;
    if(n === 0) return;
    const step = (Math.PI*2)/n;

    // 섹터: 12시(-90°)에서 시작하여 시계방향
    for(let i=0;i<n;i++){
      ctx.beginPath();
      const a0 = -Math.PI/2 + i*step;
      const a1 = a0 + step;
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,a0,a1);
      ctx.closePath();
      ctx.fillStyle = sectorColor(i);
      ctx.fill();
      ctx.strokeStyle = "#ffffff";
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    // 라벨
    ctx.save();
    ctx.translate(cx,cy);
    ctx.fillStyle = "#111827";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.font = `${Math.floor(r*0.12)}px system-ui, -apple-system, Segoe UI, Roboto, Pretendard, sans-serif`;
    for(let i=0;i<n;i++){
      const aMid = -Math.PI/2 + (i+0.5)*step;
      const tx = Math.cos(aMid) * r*0.62;
      const ty = Math.sin(aMid) * r*0.62;
      const label = (names[i]||"").trim() || `${i+1}번`;
      const lines = splitLabel(label, Math.floor(r*0.21/8));
      if(lines.length === 1){
        ctx.fillText(lines[0], tx, ty);
      }else{
        const lh = r*0.12*0.95;
        lines.forEach((line,idx)=>{
          ctx.fillText(line, tx, ty + (idx-(lines.length-1)/2)*lh);
        });
      }
    }
    ctx.restore();
  }

  function splitLabel(s, max){
    if(s.length <= max) return [s];
    const words = s.split(/\s+/);
    if(words.length === 1) return [s.slice(0,max), s.slice(max, max*2)];
    const lines = []; let cur = "";
    for(const w of words){
      if((cur + " " + w).trim().length > max){
        if(cur) lines.push(cur); cur = w;
      } else {
        cur = (cur ? cur + " " : "") + w;
      }
    }
    if(cur) lines.push(cur);
    return lines.slice(0,2);
  }

  // ===== 이름 입력 UI =====
  function rebuildNameInputs(){
    $nameList.innerHTML = "";
    names.forEach((nm, idx) => {
      const row = document.createElement('div');
      row.className = 'row'; row.style.margin = "0";
      const lab = document.createElement('label');
      lab.textContent = `${idx+1}.`; lab.style.minWidth = "28px";
      const inp = document.createElement('input');
      inp.value = nm; inp.placeholder = `${idx+1}번`;
      inp.addEventListener('input', () => { names[idx] = inp.value; drawWheel(); });
      row.appendChild(lab); row.appendChild(inp); $nameList.appendChild(row);
    });
  }

  // ===== 참가자 수로 배열 재생성 =====
  function buildByCount(){
    const n = clamp(parseInt($count.value||"0",10), 2, 50);
    names = Array.from({length:n}, (_,i)=>`${i+1}번`);
    rebuildNameInputs(); drawWheel(); $result.textContent = "";
  }

  // ===== 셔플 =====
  function shuffleNames(){
    for(let i=names.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [names[i], names[j]] = [names[j], names[i]];
    }
    rebuildNameInputs(); drawWheel();
  }

  // ===== 로터 회전 헬퍼 (보드 중심 기준) =====
  function setRotorDeg(deg){
    $rotor.style.transform = `translate(-50%,-50%) rotate(${deg%360}deg)`;
  }

  // ===== 감속 애니메이션(5~6초) =====
  function startStoppingAnimation(){
    if(spinning || names.length < 2) return;
    spinning = true;
    $result.textContent = "누가 될까요…";

    const duration = (5 + Math.random()) * 1000;  // 5~6초
    const extraTurns = 5 + Math.random() * 2;     // 5~7바퀴
    const extraAngle = Math.random() * 360;       // 0~360°
    const target = currentDeg + extraTurns*360 + extraAngle;

    const start = performance.now();
    const stepFrame = (now) => {
      const t = clamp((now - start) / duration, 0, 1);
      const eased = easeOutCubic(t);
      const deg = lerp(currentDeg, target, eased);
      setRotorDeg(deg);
      if(t < 1){
        rafId = requestAnimationFrame(stepFrame);
      }else{
        spinning = false;
        currentDeg = (deg + 360) % 360;
        showWinner(currentDeg);
      }
    };
    rafId = requestAnimationFrame(stepFrame);
  }

  // ===== 당첨 계산(촉 기준, 12시=0°) =====
  function showWinner(deg){
    const n = names.length;
    const stepDeg = 360 / n;
    const idx = Math.floor((deg % 360) / stepDeg) % n;   // 0°~stepDeg → 0번 섹터
    const winner = (names[idx]||"").trim() || `${idx+1}번`;
    $result.innerHTML = `👉 <b>${winner}</b> 님이 당첨!`;
  }

  // ===== 도우미 =====
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const lerp = (a,b,t)=>a+(b-a)*t;
  const easeOutCubic = (t)=>1 - Math.pow(1 - t, 3);

  // ===== 이벤트 바인딩 =====
  window.addEventListener('resize', resizeCanvas);
  $build.addEventListener('click', buildByCount);
  $autofill.addEventListener('click', ()=>{ names = names.map((_,i)=>`${i+1}번`); rebuildNameInputs(); drawWheel(); });
  $shuffle.addEventListener('click', shuffleNames);

  // 버튼 ‘홀드→빠르게 회전 / 해제→감속’
  const startHoldSpin = () => {
    if (spinning) return;
    isHolding = true;
    cancelAnimationFrame(rafId);
    $result.textContent = "버튼을 놓으면 멈춥니다";

    let last = performance.now();
    const speed = 1440; // deg/s (초당 4바퀴) — 필요시 숫자만 바꾸면 됨
    const loop = (now) => {
      if (!isHolding) { startStoppingAnimation(); return; }
      const dt = (now - last) / 1000;
      last = now;
      currentDeg = (currentDeg + speed * dt) % 360;
      setRotorDeg(currentDeg);
      rafId = requestAnimationFrame(loop);
    };
    rafId = requestAnimationFrame(loop);
  };
  const endHoldSpin = () => { if (isHolding) isHolding = false; };

  $spin.addEventListener('mousedown', startHoldSpin);
  window.addEventListener('mouseup', endHoldSpin);
  $spin.addEventListener('touchstart', (e)=>{ e.preventDefault(); startHoldSpin(); }, {passive:false});
  window.addEventListener('touchend', endHoldSpin);

  $reset.addEventListener('click', ()=>{
    if(spinning || isHolding) return;
    currentDeg = 0;
    setRotorDeg(0);
    $result.textContent = "";
  });

  // ===== 초기 세팅 =====
  rebuildNameInputs();
  resizeCanvas();
  setRotorDeg(0);
})();
</script>
</body>
</html>
