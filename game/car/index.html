<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ÏûêÎèôÏ∞® ÌîºÌïòÍ∏∞ Í≤åÏûÑ</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #222;
      overflow: hidden;
      touch-action: none;
      height: 100%;
    }
    #game {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: #333;
      overflow: hidden;
    }
    #player {
      position: absolute;
      width: 60px;
      height: 90px;
      background-image: url('car1.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      z-index: 10;
    }
    .obstacle {
      position: absolute;
      background: lightgreen;
      border-radius: 8px;
      z-index: 2;
    }
    .gold-coin {
      position: absolute;
      background: gold;
      border-radius: 50%;
      box-shadow: 0 0 10px yellow;
      z-index: 3;
    }
    #overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 999;
      color: white;
      font-size: 2rem;
    }
    #score {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font-size: 1.2rem;
      z-index: 1000;
    }
    #lives {
      position: fixed;
      top: 10px;
      right: 10px;
      color: white;
      font-size: 1.4rem;
      z-index: 1000;
    }
    .btn {
      margin: 10px;
      padding: 10px 20px;
      font-size: 1.2rem;
      background: #555;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn:hover { background: #777; }
    .hidden { visibility: hidden; }
  </style>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getDatabase, ref, push, set, query, orderByChild, limitToLast, onValue
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
    authDomain: "number-baseball-aee52.firebaseapp.com",
    databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
    projectId: "number-baseball-aee52",
    storageBucket: "number-baseball-aee52.firebasestorage.app",
    messagingSenderId: "998537150772",
    appId: "1:998537150772:web:c937403c219103d491a561"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

    function saveScore(name, score) {
    const scoresRef = ref(db, 'carGameScores');
    const newScoreRef = push(scoresRef);
    set(newScoreRef, {
      name: name,
      score: score,
      timestamp: Date.now()
    });
  }

    function displayTopScores() {
    const scoresRef = query(ref(db, 'carGameScores'), orderByChild('score'), limitToLast(10));
    onValue(scoresRef, (snapshot) => {
      const list = [];
      snapshot.forEach(child => list.push(child.val()));
      list.sort((a, b) => b.score - a.score); // ÎÇ¥Î¶ºÏ∞®Ïàú Ï†ïÎ†¨
      const scoreHtml = list.map((item, i) =>
        `<div>${i + 1}ÏúÑ: ${item.name} - ${item.score}Ï†ê</div>`
      ).join('');
      document.getElementById('top-scores').innerHTML = scoreHtml;
    });
  }
window.saveScore = saveScore;
window.displayTopScores = displayTopScores;
  </script>

</head>
<body>
  <div id="game">
    <div id="player"></div>
    <div id="score">Ï†êÏàò: 0</div>
    <div id="lives">‚ù§Ô∏è x 3</div>
    <div id="overlay"></div>
    <audio id="bgm" src="car01.mp3"></audio>
    <audio id="coinSound" src="coin.mp3"></audio>



  </div>
  <div id="top-scores" style="
  position: absolute;
  bottom: 10px;
  left: 10px;
  color: white;
  font-size: 1rem;
  z-index: 1000;
"></div>
<div id="game-controls" style="
  position: absolute;
  bottom: 10px;
  left: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  z-index: 1000;
">
  <button id="pause-btn" class="btn">‚è∏Ô∏è ÏùºÏãúÏ†ïÏßÄ</button>
  <button id="end-btn" class="btn">üõë Ï¢ÖÎ£å</button>
</div>


<script>
const game = document.getElementById('game');
const player = document.getElementById('player');
const scoreDisplay = document.getElementById('score');
const livesDisplay = document.getElementById('lives');
const overlay = document.getElementById('overlay');
const coinSound = document.getElementById('coinSound');
coinSound.volume = 0.3;

let lives = 3;
let score = 0;
let gameRunning = true;
let isInvincible = false;
let obstacleSpeed = 2;
let obstacleInterval = 1500;
let playerX = window.innerWidth / 2 - 30;
let playerY = window.innerHeight - 120;
let moveVX = 0, moveVY = 0;
let goldCombo = 0;
let goldComboTimer = null;
let activeTouchId, startTouchX, startTouchY, isDragging = false;

const obstacles = [];

player.style.left = `${playerX}px`;
player.style.top = `${playerY}px`;

function updatePlayerPosition() {
  playerX += moveVX;
  playerY += moveVY;
  playerX = Math.max(0, Math.min(playerX, window.innerWidth - 60));
  playerY = Math.max(0, Math.min(playerY, window.innerHeight - 90));
  player.style.left = `${playerX}px`;
  player.style.top = `${playerY}px`;
  requestAnimationFrame(updatePlayerPosition);
}
requestAnimationFrame(updatePlayerPosition);

game.addEventListener("touchstart", (e) => {
  const touch = e.touches[0];
  activeTouchId = touch.identifier;
  startTouchX = touch.clientX;
  startTouchY = touch.clientY;
  isDragging = true;
});

game.addEventListener("touchmove", (e) => {
  if (!isDragging) return;
  for (const touch of e.touches) {
    if (touch.identifier === activeTouchId) {
      const dx = touch.clientX - startTouchX;
      const dy = touch.clientY - startTouchY;
      const len = Math.sqrt(dx * dx + dy * dy);
      const scale = Math.min(len / 40, 1);
      moveVX = dx / len * scale * 3;
      moveVY = dy / len * scale * 3;
    }
  }
}, { passive: false });

game.addEventListener("touchend", (e) => {
  for (const touch of e.changedTouches) {
    if (touch.identifier === activeTouchId) {
      isDragging = false;
      moveVX = 0;
      moveVY = 0;
    }
  }
});

function createObstacle() {
  const obs = document.createElement('div');
  obs.className = 'obstacle';
  const w = 40 + Math.random() * 60;
  const h = 40 + Math.random() * 60;
  obs.style.width = `${w}px`;
  obs.style.height = `${h}px`;
  obs.style.left = `${Math.random() * (window.innerWidth - w)}px`;
  obs.style.top = `-100px`;
  game.appendChild(obs);
  obstacles.push(obs);
  animateObstacle(obs);
}

function createGoldCoin() {
  let valid = false;
  let left, top;
  const size = 30;
  let attempts = 0;
  while (!valid && attempts < 30) {
    left = Math.random() * (window.innerWidth - size);
    top = -60;
    const coinBox = { left, right: left + size, top, bottom: top + size };
    valid = obstacles.every(obs => {
      const rect = obs.getBoundingClientRect();
      return (
        coinBox.right < rect.left ||
        coinBox.left > rect.right ||
        coinBox.bottom < rect.top ||
        coinBox.top > rect.bottom
      );
    });
    attempts++;
  }
  if (!valid) return;
  const coin = document.createElement('div');
  coin.className = 'gold-coin';
  coin.style.width = `${size}px`;
  coin.style.height = `${size}px`;
  coin.style.left = `${left}px`;
  coin.style.top = `${top}px`;
  game.appendChild(coin);
  animateGoldCoin(coin);
}

function animateObstacle(obs) {
  let y = parseFloat(obs.style.top);
  const interval = setInterval(() => {
    if (!gameRunning) return clearInterval(interval);
    y += obstacleSpeed;
    obs.style.top = `${y}px`;
    if (y > window.innerHeight) {
      obs.remove();
      const idx = obstacles.indexOf(obs);
      if (idx > -1) obstacles.splice(idx, 1);
      clearInterval(interval);
      if (Math.random() < 0.3) {
        
      }
    }
    checkCollision(obs);
  }, 20);
}

function animateGoldCoin(coin) {
  let y = parseFloat(coin.style.top);
  const interval = setInterval(() => {
    if (!gameRunning) return clearInterval(interval);
    y += obstacleSpeed;
    coin.style.top = `${y}px`;
    if (y > window.innerHeight) {
      coin.remove();
      clearInterval(interval);
    }
    const p = player.getBoundingClientRect();
    const c = coin.getBoundingClientRect();
    const collected = p.left < c.right && p.right > c.left && p.top < c.bottom && p.bottom > c.top;
    if (collected) {
  score += 5;
  scoreDisplay.textContent = `Ï†êÏàò: ${score}`;
  coin.remove();
  clearInterval(interval);
  coinSound.currentTime = 0;  // Îπ†Î•¥Í≤å Ïó∞ÏÜç Ïû¨ÏÉù ÎåÄÎπÑ
  coinSound.play();

  goldCombo++;
  if (goldComboTimer) clearTimeout(goldComboTimer);
  goldComboTimer = setTimeout(() => {
    goldCombo = 0;
  }, 5000);

  if (goldCombo === 20 && lives < 5) {
    lives++;
    livesDisplay.textContent = `‚ù§Ô∏è x ${lives}`;
    goldCombo = 0;
  }
}

  }, 20);
}

function checkCollision(obs) {
  if (!gameRunning || isInvincible) return;
  const p = player.getBoundingClientRect();
  const o = obs.getBoundingClientRect();
  const buffer = 20;
  const collide = p.left + buffer < o.right && p.right - buffer > o.left && p.top + buffer < o.bottom && p.bottom - buffer > o.top;
  if (collide) {
    handleHit();
    obs.remove();
  }
}

function handleHit() {
 
  lives--;
  livesDisplay.textContent = `‚ù§Ô∏è x ${lives}`;
  if (lives <= 0) {
    gameRunning = false;
    return showGameOver();
  }
  isInvincible = true;
  let blink = 0;
  const blinkInterval = setInterval(() => {
    player.classList.toggle("hidden");
    blink++;
    if (blink >= 6) {
      clearInterval(blinkInterval);
      player.classList.remove("hidden");
      isInvincible = false;
    }
  }, 200);
}

function showGameOver() {
  const nameInput = prompt("Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (10Ïûê Ïù¥ÎÇ¥):", "ÌîåÎ†àÏù¥Ïñ¥") || "ÌîåÎ†àÏù¥Ïñ¥";
  const trimmedName = nameInput.slice(0, 10);
  saveScore(trimmedName, score); // Ï†êÏàò Ï†ÄÏû•

  overlay.innerHTML = `
    <div style="margin-bottom: 20px;">üí• GAME OVER üí•</div>
    <div style="margin-bottom: 10px;">ÎãπÏã†Ïùò Ï†êÏàòÎäî <strong>${score}</strong>Ï†êÏûÖÎãàÎã§!</div>
    <button class="btn" onclick="location.reload()">üîÑ Ïû¨ÏãúÏûë</button>
    <button class="btn" onclick="overlay.innerHTML='Í≤åÏûÑ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.'">‚ùå Ï¢ÖÎ£å</button>`;
  overlay.style.display = 'flex';
  bgm.pause();
}


setInterval(() => {
  if (gameRunning) {
    score++;
    scoreDisplay.textContent = `Ï†êÏàò: ${score}`;
  }
}, 1000);

function spawnLoop() {
  if (!gameRunning) return;
  createObstacle();
  if (Math.random() < 0.4) createGoldCoin();
  setTimeout(spawnLoop, obstacleInterval);
}

setInterval(() => {
  if (gameRunning) {
    obstacleSpeed *= 1.05;
    if (obstacleInterval > 500) obstacleInterval *= 0.95;
  }
}, 10000);


const bgm = document.getElementById('bgm');
const bgmTracks = ['car01.mp3', 'car02.mp3', 'car03.mp3'];
let currentBgmIndex = 0;

// ÏàúÏ∞® Ïû¨ÏÉù Ìï®Ïàò
function playNextBgm() {
  bgm.src = bgmTracks[currentBgmIndex];
  bgm.play();
  currentBgmIndex = (currentBgmIndex + 1) % bgmTracks.length;
}

// Îã§Ïùå Í≥° Ïû¨ÏÉù Ìä∏Î¶¨Í±∞
bgm.addEventListener('ended', playNextBgm);


window.onload = () => {
  // Î∞∞Í≤ΩÏùåÏïÖ Ïû¨ÏÉù ÏãúÏûë
  playNextBgm();

  livesDisplay.textContent = `‚ù§Ô∏è x ${lives}`;
  spawnLoop();
  displayTopScores();

};

let paused = false;

document.getElementById('pause-btn').addEventListener('click', () => {
  paused = !paused;
  gameRunning = !paused;

  const btn = document.getElementById('pause-btn');
  btn.textContent = paused ? '‚ñ∂Ô∏è Í≥ÑÏÜçÌïòÍ∏∞' : '‚è∏Ô∏è ÏùºÏãúÏ†ïÏßÄ';

  if (paused) {
    bgm.pause();
  } else {
    bgm.play().catch(() => {});
    spawnLoop();

    // ‚úÖ Î™®Îì† Ïû•Ïï†Î¨ºÍ≥º ÏΩîÏù∏ Ï†úÍ±∞
    document.querySelectorAll('.obstacle, .gold-coin').forEach(el => el.remove());
    obstacles.length = 0;
  }
});





document.getElementById('end-btn').addEventListener('click', () => {
  gameRunning = false;
  showGameOver();
});


game.addEventListener('touchstart', () => {
  if (bgm.paused) {
    bgm.play().catch(() => {}); // ÏûêÎèô Ïû¨ÏÉù Ï∞®Îã® Î∞©ÏßÄ
  }
}, { once: true });


</script>
</body>
</html>
