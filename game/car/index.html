<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ÏûêÎèôÏ∞® ÌîºÌïòÍ∏∞ Í≤åÏûÑ</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #222;
      overflow: hidden;
      touch-action: none;
      height: 100%;
      -webkit-user-select: none; user-select: none;
    }
    #game {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: #333;
      overflow: hidden;
    }
    #player {
      position: absolute;
      width: 60px;
      height: 90px;
      background-image: url('car1.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      z-index: 10;
      transition: box-shadow 120ms ease;
    }

    .obstacle {
      position: absolute;
      border-radius: 8px;
      z-index: 2;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    }
    .ob-basic { background: #8bc34a; }
    .ob-zigzag { background: #ff7043; }
    .ob-drift  { background: #42a5f5; }
    .ob-swing  { background: linear-gradient(135deg,#9575cd,#ce93d8); }
    .ob-truck  { background: #bdbdbd; border-radius: 6px; }

    .gold-coin {
      position: absolute;
      background: gold;
      border-radius: 50%;
      box-shadow: 0 0 10px yellow;
      z-index: 3;
    }
    .heart, .shield {
      position: absolute;
      width: 32px;
      height: 32px;
      font-size: 24px;
      text-align: center;
      line-height: 32px;
      z-index: 4;
      user-select: none;
    }

    #overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 999;
      color: white;
    }

    #score { position: absolute; top: 10px; left: 10px; color: #fff; font-size: 1.2rem; z-index: 1000; }
    #lives { position: fixed; top: 10px; right: 10px; color: #fff; font-size: 1.4rem; z-index: 1000; }

    .btn {
      margin: 10px;
      padding: 10px 16px;
      font-size: 1.1rem;
      background: #555;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn:hover { background: #777; }
    .hidden { visibility: hidden; }

    #controls {
      position: absolute;
      bottom: 8px; left: 8px;
      display: flex; gap: 6px;
      z-index: 1000;
    }

    #top-scores {
      position: absolute;
      bottom: 8px; right: 8px;
      color: #fff;
      font-size: 0.95rem;
      background: rgba(0,0,0,0.5);
      padding: 6px 10px;
      border-radius: 8px;
      z-index: 999;
      max-width: 220px;
    }
  </style>
  <link rel="icon" href="car1.png" />
</head>
<body>
  <div id="game">
    <div id="player"></div>
    <div id="score">Ï†êÏàò: 0</div>
    <div id="lives">‚ù§Ô∏è x 3</div>
    <div id="overlay"></div>
    <audio id="coinSound" src="coin.mp3"></audio>
    <div id="controls"><button id="pause-btn" class="btn">‚è∏Ô∏è</button></div>
    <div id="top-scores"></div>
  </div>

  <div id="scoreboard" style="display:none; text-align:center; margin-top:30px;">
    <h2>üèÜ ÏÉÅÏúÑ 10ÏúÑ Ï†êÏàò</h2>
    <ol id="score-list"></ol>
  </div>

<script>
/* ===================== Î©îÏù∏ Í≤åÏûÑ Î°úÏßÅ (Firebase ÎØ∏ÏÇ¨Ïö©) ===================== */

const game = document.getElementById('game');
const playerEl = document.getElementById('player');
const scoreEl  = document.getElementById('score');
const livesEl  = document.getElementById('lives');
const overlay  = document.getElementById('overlay');
const coinSound = document.getElementById('coinSound');
coinSound.volume = 0.35;

// ========= Í≤åÏûÑ ÏÉÅÌÉú =========
let gameRunning = true;
let paused = false;
let lives = 3;
let score = 0;
let isInvincible = false;
let hasShield = false;
let shieldTimeout = null;

// ÌîåÎ†àÏù¥Ïñ¥ ÏúÑÏπò/ÏÜçÎèÑ
let playerX = window.innerWidth / 2 - 30;
let playerY = window.innerHeight - 120;
const PLAYER_W = 60, PLAYER_H = 90;
let moveVX = 0, moveVY = 0;

// Î£®ÌîÑ/ÌÉÄÏù¥Î®∏ ID
let lastTs = null;
let rafId = null;

// Ïä§Ìè∞ & ÎÇúÏù¥ÎèÑ ÌÉÄÏù¥Î®∏
let obstacleSpawnAcc = 0;
let coinSpawnAcc = 0;
let heartSpawnAcc = 0;
let shieldSpawnAcc = 0;
let scoreAcc = 0;
let difficultyAcc = 0;
let heartCooldownAcc = 30000;

// Ïä§Ìè∞ Ï£ºÍ∏∞/ÌôïÎ•†/ÏÜçÎèÑ Î∞∞Ïú®
let obstacleSpawnMs = 1100;
let coinSpawnMs = 900;
let heartSpawnMs = 12000;
const HEART_MIN_LIVES = 2;
const HEART_COOLDOWN_MS = 30000;
let shieldSpawnMs = 5000;
let speedMul = 1;

// Í≥®Îìú ÏΩ§Î≥¥
let goldCombo = 0;
let goldComboTimer = null;

// ÏóîÌã∞Ìã∞
const obstacles = [];
const items = [];

// Ï¥àÍ∏∞ Î∞∞Ïπò
function syncPlayer() {
  playerEl.style.left = playerX + 'px';
  playerEl.style.top  = playerY + 'px';
}
syncPlayer();

// ========= ÏûÖÎ†•(ÌÑ∞Ïπò ÎìúÎûòÍ∑∏) =========
let activeTouchId = null, startTouchX = 0, startTouchY = 0, isDragging = false;
const MAX_PLAYER_SPEED = 5.0;

function startBGMOnce() { tryPlayBGM(); }
['click','touchstart'].forEach(ev=>document.addEventListener(ev,startBGMOnce,{once:true,passive:true}));

function handleTouchStart(e){
  const t = e.touches[0]; if (!t) return;
  activeTouchId = t.identifier;
  startTouchX = t.clientX; startTouchY = t.clientY;
  isDragging = true;
}
function handleTouchMove(e){
  if (!isDragging) return;
  for (const t of e.touches) {
    if (t.identifier === activeTouchId) {
      const dx = t.clientX - startTouchX;
      const dy = t.clientY - startTouchY;
      const len = Math.hypot(dx, dy) || 1;
      const scale = Math.min(len / 40, 1);
      const rawSpeed = (2.0 * speedMul) * 1.2;
      const playerSpeed = Math.min(rawSpeed, MAX_PLAYER_SPEED);
      moveVX = (dx / len) * scale * playerSpeed;
      moveVY = (dy / len) * scale * playerSpeed;
      break;
    }
  }
}
function handleTouchEnd(e){
  for (const t of e.changedTouches) {
    if (t.identifier === activeTouchId) {
      isDragging = false;
      moveVX = 0; moveVY = 0;
      break;
    }
  }
}

game.addEventListener('touchstart', handleTouchStart, { passive:true });
game.addEventListener('touchmove',  handleTouchMove,  { passive:true });
game.addEventListener('touchend',   handleTouchEnd,   { passive:true });

// ========= ÎûúÎç§ =========
function rand(min, max){ return Math.random()*(max-min)+min; }

// ========= Ïû•Ïï†Î¨º ÏÉùÏÑ± =========
function spawnObstacle(){
  const typeRand = Math.random();
  let type = 'basic';
  if (typeRand < 0.15) type = 'truck';
  else if (typeRand < 0.40) type = 'zigzag';
  else if (typeRand < 0.65) type = 'drift';
  else if (typeRand < 0.85) type = 'swing';

  let w,h,vx=0,vy=rand(2.2,3.6)*speedMul, angle=0, omega=0;
  if (type==='truck'){ w=rand(90,130); h=rand(80,120); vy*=0.85; }
  else if (type==='zigzag'){ w=rand(40,70); h=rand(40,70); vx=rand(-1.8,1.8); }
  else if (type==='drift'){ w=rand(50,80); h=rand(50,80); vx=rand(-1.2,1.2); vy=rand(2.0,3.2)*speedMul; }
  else if (type==='swing'){ w=rand(50,80); h=rand(50,80); omega=rand(-120,120); }
  else { w=rand(40,70); h=rand(40,70); }

  const x = Math.max(0, Math.min(window.innerWidth - w, rand(0, window.innerWidth - w)));
  const y = -h - 4;

  const el = document.createElement('div');
  el.className = 'obstacle ob-' + (type==='basic'?'basic':type);
  el.style.width = w+'px';
  el.style.height= h+'px';
  el.style.left  = x+'px';
  el.style.top   = y+'px';
  game.appendChild(el);

  obstacles.push({ el, x, y, w, h, vx, vy, type, angle, omega });
}

// ========= ÏïÑÏù¥ÌÖú ÏÉùÏÑ± =========
function spawnCoin(){
  const size = 30;
  const x = rand(0, window.innerWidth - size);
  const y = -size - 4;
  const el = document.createElement('div');
  el.className = 'gold-coin';
  el.style.width = el.style.height = size + 'px';
  el.style.left = x + 'px';
  el.style.top  = y + 'px';
  game.appendChild(el);
  const vy = rand(2.0, 3.2)*speedMul;
  items.push({ el, x, y, w:size, h:size, vx:0, vy, kind:'coin' });
}

function spawnHeart(){
  const size = 30;
  const x = rand(0, window.innerWidth - size);
  const y = -size - 4;
  const el = document.createElement('div');
  el.className = 'heart';
  el.textContent = '‚ù§Ô∏è';
  el.style.left = x + 'px';
  el.style.top  = y + 'px';
  game.appendChild(el);
  const vy = rand(2.0, 3.0)*speedMul;
  items.push({ el, x, y, w:size, h:size, vx:0, vy, kind:'heart' });
}

function spawnShield(){
  const size = 32;
  const x = rand(0, window.innerWidth - size);
  const y = -size - 4;
  const el = document.createElement('div');
  el.className = 'shield';
  el.textContent = 'üõ°Ô∏è';
  el.style.left = x + 'px';
  el.style.top  = y + 'px';
  el.style.boxShadow = '0 0 12px lightblue';
  el.style.background = 'rgba(173,216,230, 0.08)';
  el.style.borderRadius = '50%';
  game.appendChild(el);
  const vy = rand(2.0, 3.0)*speedMul;
  items.push({ el, x, y, w:size, h:size, vx:0, vy, kind:'shield' });
}

// ========= Ï∂©Îèå/Ï≤òÎ¶¨ =========
function aabb(ax,ay,aw,ah, bx,by,bw,bh, buffer=0){
  return (ax+buffer < bx+bw && ax+aw-buffer > bx && ay+buffer < by+bh && ay+ah-buffer > by);
}

function onHit(){
  if (hasShield) { hasShield = false; updateShieldIndicator(); return; }
  lives--; livesEl.textContent = `‚ù§Ô∏è x ${lives}`;
  if (lives <= 0){
    gameRunning = false; paused = true; moveVX=0; moveVY=0;
    if (window.showGameOver) window.showGameOver(score); else showSimpleGameOver();
    return;
  }
  // ÏßßÏùÄ Î¨¥Ï†Å & Ï†êÎ©∏
  isInvincible = true;
  let blink = 0; const blinkId = setInterval(()=>{
    playerEl.classList.toggle('hidden'); blink++;
    if (blink>=6){ clearInterval(blinkId); playerEl.classList.remove('hidden'); isInvincible=false; }
  }, 200);
}

function showSimpleGameOver(){
  overlay.style.display = 'flex';
  overlay.innerHTML = '\
    <div style="display:flex;flex-direction:column;align-items:center;padding:24px;color:white;">\
      <div style="font-size:2rem;margin-bottom:12px;">üí• GAME OVER üí•</div>\
      <div style="margin:10px 0 18px;">Ï†êÏàò: <strong>'+score+'</strong></div>\
      <div>ÏÉàÎ°úÍ≥†Ïπ®(F5) ÎòêÎäî ÏïÑÎûò Î≤ÑÌäºÏúºÎ°ú Ïû¨ÏãúÏûëÌïòÏÑ∏Ïöî.</div>\
      <div style="margin-top:16px;">\
        <button class="btn" onclick="location.reload()">üîÑ Ïû¨ÏãúÏûë</button>\
      </div>\
    </div>';
}

function updateShieldIndicator(){
  playerEl.style.boxShadow = hasShield ? '0 0 20px 5px lightblue' : 'none';
}

// ========= Î©îÏù∏ Î£®ÌîÑ =========
function loop(ts){
  if (lastTs === null) lastTs = ts;
  const dtMs = ts - lastTs;
  lastTs = ts;

  if (!paused && gameRunning){
    const dt = Math.min(dtMs, 40);

    // ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Îèô
    playerX += moveVX; playerY += moveVY;
    playerX = Math.max(0, Math.min(playerX, window.innerWidth - PLAYER_W));
    playerY = Math.max(0, Math.min(playerY, window.innerHeight - PLAYER_H));
    syncPlayer();

    // ÌÉÄÏù¥Î®∏ ÎàÑÏ†Å
    obstacleSpawnAcc += dt;
    coinSpawnAcc += dt;
    heartSpawnAcc += dt;
    shieldSpawnAcc += dt;
    scoreAcc += dt;
    difficultyAcc += dt;
    heartCooldownAcc += dt;

    // Ïä§Ìè∞
    if (obstacleSpawnAcc >= obstacleSpawnMs){ obstacleSpawnAcc -= obstacleSpawnMs; spawnObstacle(); }
    if (coinSpawnAcc >= coinSpawnMs){
      coinSpawnAcc -= coinSpawnMs;
      if (Math.random() < 0.4) spawnCoin();
    }
    if (heartSpawnAcc >= heartSpawnMs){
      heartSpawnAcc -= heartSpawnMs;
      if (lives <= HEART_MIN_LIVES && heartCooldownAcc >= HEART_COOLDOWN_MS && Math.random() < 0.12) {
        spawnHeart();
        heartCooldownAcc = 0;
      }
    }
    if (shieldSpawnAcc >= shieldSpawnMs){
      shieldSpawnAcc -= shieldSpawnMs;
      if (Math.random() < 0.25) spawnShield();
    }

    // ÎÇúÏù¥ÎèÑ ÏÉÅÏäπ(10Ï¥àÎßàÎã§)
    if (difficultyAcc >= 10000){
      difficultyAcc -= 10000;
      speedMul = Math.min(2.2, speedMul * 1.06);
      obstacleSpawnMs = Math.max(520, obstacleSpawnMs * 0.95);
    }

    // Ï†êÏàò(Ï¥àÎãπ 1Ï†ê)
    if (scoreAcc >= 1000){
      const add = Math.floor(scoreAcc/1000);
      score += add; scoreAcc -= add*1000;
      scoreEl.textContent = `Ï†êÏàò: ${score}`;
    }

    // Ïû•Ïï†Î¨º ÏóÖÎç∞Ïù¥Ìä∏ & Ï∂©Îèå
    for (let i=obstacles.length-1; i>=0; i--){
      const o = obstacles[i];
      if (o.type==='zigzag'){
        if (o.x <= 0 || o.x + o.w >= window.innerWidth) o.vx *= -1;
      } else if (o.type==='swing'){
        o.angle += (o.omega * dt/1000);
        o.el.style.transform = `rotate(${o.angle}deg)`;
      }
      o.y += o.vy; o.x += o.vx;
      o.el.style.top = o.y + 'px';
      o.el.style.left= o.x + 'px';

      if (o.y > window.innerHeight + 40){ o.el.remove(); obstacles.splice(i,1); continue; }

      if (!isInvincible){
        if (aabb(playerX,playerY,PLAYER_W,PLAYER_H, o.x,o.y,o.w,o.h, 18)){
          o.el.remove(); obstacles.splice(i,1);
          onHit();
        }
      }
    }

    // ÏïÑÏù¥ÌÖú ÏóÖÎç∞Ïù¥Ìä∏ & ÌöçÎìù
    for (let i=items.length-1; i>=0; i--){
      const it = items[i];
      it.y += it.vy; it.x += it.vx;
      it.el.style.top = it.y + 'px';
      it.el.style.left= it.x + 'px';

      if (it.y > window.innerHeight + 40){ it.el.remove(); items.splice(i,1); continue; }

      if (aabb(playerX,playerY,PLAYER_W,PLAYER_H, it.x,it.y,it.w,it.h, 0)){
        if (it.kind==='coin'){
          score += 5; scoreEl.textContent = `Ï†êÏàò: ${score}`;
          coinSound.currentTime = 0; coinSound.play().catch(()=>{});
          goldCombo++;
          if (goldComboTimer) clearTimeout(goldComboTimer);
          goldComboTimer = setTimeout(()=>{ goldCombo = 0; }, 5000);
          if (goldCombo === 20 && lives < 5){ lives++; livesEl.textContent = `‚ù§Ô∏è x ${lives}`; goldCombo = 0; }
        } else if (it.kind==='heart'){
          if (lives < 5){ lives++; livesEl.textContent = `‚ù§Ô∏è x ${lives}`; }
        } else if (it.kind==='shield'){
          hasShield = true; updateShieldIndicator();
          if (shieldTimeout) clearTimeout(shieldTimeout);
          shieldTimeout = setTimeout(()=>{ hasShield=false; updateShieldIndicator(); shieldTimeout=null; }, 10000);
        }
        it.el.remove(); items.splice(i,1);
      }
    }
  }

  rafId = requestAnimationFrame(loop);
}
rafId = requestAnimationFrame(loop);

// ÏùºÏãúÏ†ïÏßÄ
const pauseBtn = document.getElementById('pause-btn');
pauseBtn.addEventListener('click', ()=>{
  paused = !paused; gameRunning = !paused;
  pauseBtn.textContent = paused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
  if (paused) bgm.pause(); else bgm.play().catch(()=>{});
});

// Ï∞Ω Î¶¨ÏÇ¨Ïù¥Ï¶à Ïãú ÌîåÎ†àÏù¥Ïñ¥ ÏúÑÏπò ÌÅ¥Îû®ÌîÑ
window.addEventListener('resize', ()=>{
  playerX = Math.max(0, Math.min(playerX, window.innerWidth - PLAYER_W));
  playerY = Math.max(0, Math.min(playerY, window.innerHeight - PLAYER_H));
  syncPlayer();
});

// ========= BGM =========
const bgmList = [ new Audio('car01.mp3'), new Audio('car02.mp3'), new Audio('car03.mp3') ];
let bgm = bgmList[Math.floor(Math.random()*bgmList.length)];
bgm.loop = true; bgm.volume = 0.6;
function tryPlayBGM(){ bgm.play().catch(()=>{}); }
window.bgm = bgm;

// Ï¥àÍ∏∞ UI
livesEl.textContent = `‚ù§Ô∏è x ${lives}`;
scoreEl.textContent = `Ï†êÏàò: ${score}`;

// ========= ÏôÑÏ†Ñ Ï¢ÖÎ£å =========
function terminateGame() {
  // ÏÉÅÌÉú Ï†ïÏßÄ
  gameRunning = false;
  paused = true;

  // Î£®ÌîÑ Ï§ëÏßÄ
  if (rafId !== null) {
    cancelAnimationFrame(rafId);
    rafId = null;
  }

  // ÏÉÅÏúÑ Ï†êÏàò Î≥¥Îìú ÌÉÄÏù¥Î®∏ Ï§ëÏßÄ(Î™®ÎìàÏóêÏÑú Îì±Î°ùÌïú Ï†ÑÏó≠ Í∞íÏùÑ ÏÇ¨Ïö©)
  if (window.floatingTopTimerId) {
    clearInterval(window.floatingTopTimerId);
    window.floatingTopTimerId = null;
  }

  // ÏûÖÎ†• Î¶¨Ïä§ÎÑà Ï†úÍ±∞
  game.removeEventListener('touchstart', handleTouchStart, { passive:true });
  game.removeEventListener('touchmove',  handleTouchMove,  { passive:true });
  game.removeEventListener('touchend',   handleTouchEnd,   { passive:true });

  // ÏÇ¨Ïö¥Îìú Ï†ïÏßÄ
  try { bgm.pause(); } catch(e){}
  try { coinSound.pause(); coinSound.currentTime = 0; } catch(e){}

  // UI Í≥†Ï†ï
  overlay.style.display = 'flex';
  overlay.innerHTML = `
    <div style="color:white;text-align:center;font-size:2rem;padding:24px">
      üëã Í≤åÏûÑÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.<br/>ÌéòÏù¥ÏßÄÎ•º Îã´Í±∞ÎÇò ÏÉàÎ°úÍ≥†Ïπ®(F5) Ìï¥Ï£ºÏÑ∏Ïöî.
    </div>
  `;

  // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
  const pauseBtn = document.getElementById('pause-btn');
  if (pauseBtn) { pauseBtn.disabled = true; pauseBtn.textContent = '‚èπ'; }
}

window.terminateGame = terminateGame; // Î≤ÑÌäºÏóêÏÑú Ìò∏Ï∂ú Í∞ÄÎä•ÌïòÍ≤å ÎÖ∏Ï∂ú
</script>

<!-- ===================== Firebase(ÏùµÎ™Ö Î°úÍ∑∏Ïù∏ + ÏàúÏúÑ) ===================== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { 
    getDatabase, ref, get, remove, set, push, query, orderByChild, limitToLast
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
    authDomain: "number-baseball-aee52.firebaseapp.com",
    databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
    projectId: "number-baseball-aee52",
    storageBucket: "number-baseball-aee52.firebasestorage.app",
    messagingSenderId: "998537150772",
    appId: "1:998537150772:web:c937403c219103d491a561"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  const auth = getAuth(app);

  async function ensureAnonAuth() {
    if (auth.currentUser) return auth.currentUser;
    return new Promise((resolve, reject) => {
      const unsub = onAuthStateChanged(auth, (u) => {
        if (u) { unsub(); resolve(u); }
      });
      signInAnonymously(auth).catch((e) => { console.error('ÏùµÎ™Ö Î°úÍ∑∏Ïù∏ Ïã§Ìå®:', e); reject(e); });
    });
  }

  // ===== Ï†êÏàò Ï†ÄÏû• =====
  async function saveScore(name, score) {
    await ensureAnonAuth();
    const scoresRef = ref(db, 'carGameScores');
    const newScoreRef = push(scoresRef);
    try {
      await set(newScoreRef, {
        name,
        score,
        timestamp: Date.now(),
        uid: auth.currentUser?.uid || null
      });
    } catch (e) {
      console.error('Îû≠ÌÇπ Ï†ÄÏû• Ïã§Ìå®:', e);
      alert('Îû≠ÌÇπ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + e.code);
    }
  }

  // ===== ÏÉÅÏúÑ Ï†êÏàò HTML ÏÉùÏÑ±(1Ìöå Ï°∞Ìöå) =====
  async function generateTopScoresHTML() {
    await ensureAnonAuth();
    const q = query(ref(db, 'carGameScores'), orderByChild('score'), limitToLast(10));
    const snapshot = await get(q);
    const list = [];
    snapshot.forEach(child => { const v = child.val(); if (typeof v.score === 'number') list.push(v); });
    list.sort((a,b)=>b.score-a.score);
    return list.map((item,i)=>`<div><strong>${i+1}ÏúÑ</strong>: ${item.name} - ${item.score}Ï†ê</div>`).join('');
  }

  // Ïö∞ÌïòÎã® ÏÉÅÏãú Î≥¥Îìú (3Ï¥àÎßàÎã§)
  async function refreshFloatingTop(){
    try {
      const html = await generateTopScoresHTML();
      const box = document.getElementById('top-scores');
      if (box) box.innerHTML = html || '';
    } catch(e) {
      // Î¨¥Ïãú
    }
  }

  // Í∏àÏöîÏùº 12Ïãú Ïù¥ÌõÑ Ï£ºÍ∞Ñ Îû≠ÌÇπ Ï¥àÍ∏∞Ìôî (ÏòµÏÖò)
  async function resetRankingIfFridayNoon() {
    const now = new Date();
    const isFriday = now.getDay() === 5;
    const hour = now.getHours();
    const today = now.toISOString().slice(0, 10);
    const resetKey = "carRankingReset_" + today;
    if (isFriday && hour >= 12 && !localStorage.getItem(resetKey)) {
      try {
        await ensureAnonAuth();
        await remove(ref(db, 'carGameScores'));
        localStorage.setItem(resetKey, 'done');
        await refreshFloatingTop();
      } catch(e) {}
    }
  }

  // Ï¥àÍ∏∞Ìôî: Î°úÍ∑∏Ïù∏ Î≥¥Ïû• ÌõÑ Ï£ºÍ∏∞ ÏûëÏóÖ ÏãúÏûë
  ensureAnonAuth().then(()=>{
    refreshFloatingTop();
    // Ï†ÑÏó≠Ïóê Ïù∏ÌÑ∞Î≤å IDÎ•º ÎÖ∏Ï∂úÌï¥ÏÑú terminateGame()Ïù¥ Ìï¥Ï†úÌï† Ïàò ÏûàÍ≤å Ìï®
    window.floatingTopTimerId = setInterval(refreshFloatingTop, 3000);
    resetRankingIfFridayNoon();
  }).catch(()=>{
    // Î°úÍ∑∏Ïù∏ Ïã§Ìå®ÏãúÏóêÎèÑ Í≤åÏûÑÏùÄ ÏßÑÌñâÎêòÍ≤å Ìï®
  });

  // Ï†ÑÏó≠ ÎÖ∏Ï∂ú
  window.saveScore = saveScore;
  window.generateTopScoresHTML = generateTopScoresHTML;
  window.db = db;

  // Í≤åÏûÑÏò§Î≤Ñ Ïò§Î≤ÑÎ†àÏù¥
  window.showGameOver = async function(score){
    try { await ensureAnonAuth(); } catch(e) {}
    const name = (prompt("Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (10Ïûê Ïù¥ÎÇ¥):", "") || "ÏùµÎ™Ö").trim().slice(0,10);
    try { await saveScore(name, score); } catch(e){}
    let scoreHtml = '';
    try { scoreHtml = await generateTopScoresHTML(); } catch(e) {}

    const overlay = document.getElementById('overlay');
    overlay.innerHTML = `
      <div style="display:flex;flex-direction:column;align-items:center;overflow-y:auto;padding:40px 20px 60px;box-sizing:border-box;z-index:999;color:white;">
        <div style="margin-bottom: 20px; font-size: 2rem; text-align:center;">üí• GAME OVER üí•</div>
        <h3 style="margin-top:10px; color:gold; text-align:center;">üèÜ ÏÉÅÏúÑ 10ÏúÑ Ï†êÏàò</h3>
        <div style="display:flex; justify-content:center; width:100%;">
          <div style="font-size:1rem; line-height:1.8; background:rgba(255,255,255,0.1); padding:15px 25px; border-radius:10px; max-height:300px; overflow-y:auto; width:90%; max-width:400px; text-align:center;">${scoreHtml}</div>
        </div>
        <div style="margin-top: 20px; text-align:center;">
          <button class="btn" onclick="location.reload()">üîÑ Ïû¨ÏãúÏûë</button>
          <button class="btn" onclick="terminateGame()">‚ùå Ï¢ÖÎ£å</button>
        </div>
      </div>`;
    overlay.style.display = 'flex';

    if (window.bgm){ try { window.bgm.pause(); window.bgm.currentTime = 0; } catch(e){} }
  }
</script>
</body>
</html>
