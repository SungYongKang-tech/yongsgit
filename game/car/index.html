<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>자동차 피하기 게임</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #222;
      overflow: hidden;
      touch-action: none;
      height: 100%;
    }
    #game {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: #333;
      overflow: hidden;
    }
    #player {
      position: absolute;
      width: 60px;
      height: 90px;
      background-image: url('car1.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      z-index: 10;
    }
    .obstacle {
      position: absolute;
      background: lightgreen;
      border-radius: 8px;
      z-index: 2;
    }
    .gold-coin {
      position: absolute;
      background: gold;
      border-radius: 50%;
      box-shadow: 0 0 10px yellow;
      z-index: 3;
    }
    #overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 999;
      color: white;
      font-size: 2rem;
    }
    #score {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font-size: 1.2rem;
      z-index: 1000;
    }
    #lives {
      position: fixed;
      top: 10px;
      right: 10px;
      color: white;
      font-size: 1.4rem;
      z-index: 1000;
    }
    .btn {
      margin: 10px;
      padding: 10px 20px;
      font-size: 1.2rem;
      background: #555;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn:hover { background: #777; }
    .hidden { visibility: hidden; }
  </style>

 
<link rel="icon" href="car1.png" />

</head>
<body>


  <div id="game">
    <div id="player"></div>
    <div id="score">점수: 0</div>
    <div id="lives">❤️ x 3</div>
    <div id="overlay"></div>
    <audio id="coinSound" src="coin.mp3"></audio>



  </div>
 <div id="top-scores" style="
  position: absolute;
  bottom: 10px;
  right: 10px;
  color: white;
  font-size: 1rem;
  background: rgba(0, 0, 0, 0.5);
  padding: 6px 12px;
  border-radius: 8px;
  z-index: 999;
  max-width: 200px;
"></div>

<div id="game-controls" style="
  position: absolute;
  bottom: 10px;
  left: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  z-index: 1000;
">
  <div id="game-controls" style="position: absolute; bottom: 5px; left: 5px; display: flex; gap: 3px; z-index: 999;">
  <button id="pause-btn" class="btn">⏸️</button>

</div>
</div>


<script>
const game = document.getElementById('game');
const player = document.getElementById('player');
const scoreDisplay = document.getElementById('score');
const livesDisplay = document.getElementById('lives');
const overlay = document.getElementById('overlay');
const coinSound = document.getElementById('coinSound');
coinSound.volume = 0.3;

let lives = 3;
let score = 0;
let gameRunning = true;
let isInvincible = false;
let obstacleSpeed = 2;
let obstacleInterval = 1500;
let playerX = window.innerWidth / 2 - 30;
let playerY = window.innerHeight - 120;
let moveVX = 0, moveVY = 0;
let goldCombo = 0;
let goldComboTimer = null;
let activeTouchId, startTouchX, startTouchY, isDragging = false;


const obstacles = [];

player.style.left = `${playerX}px`;
player.style.top = `${playerY}px`;

function updatePlayerPosition() {
  if (!gameRunning) return; // ✅ 게임 종료되면 멈춤
  playerX += moveVX;
  playerY += moveVY;
  playerX = Math.max(0, Math.min(playerX, window.innerWidth - 60));
  playerY = Math.max(0, Math.min(playerY, window.innerHeight - 90));
  player.style.left = `${playerX}px`;
  player.style.top = `${playerY}px`;
  requestAnimationFrame(updatePlayerPosition);
}

requestAnimationFrame(updatePlayerPosition);

game.addEventListener("touchstart", (e) => {
  const touch = e.touches[0];
  activeTouchId = touch.identifier;
  startTouchX = touch.clientX;
  startTouchY = touch.clientY;
  isDragging = true;
});

game.addEventListener("touchmove", (e) => {
  if (!isDragging) return;
  for (const touch of e.touches) {
    if (touch.identifier === activeTouchId) {
      const dx = touch.clientX - startTouchX;
      const dy = touch.clientY - startTouchY;
      const len = Math.sqrt(dx * dx + dy * dy);
      const scale = Math.min(len / 40, 1);
      moveVX = dx / len * scale * 3;
      moveVY = dy / len * scale * 3;
    }
  }
}, { passive: false });

game.addEventListener("touchend", (e) => {
  for (const touch of e.changedTouches) {
    if (touch.identifier === activeTouchId) {
      isDragging = false;
      moveVX = 0;
      moveVY = 0;
    }
  }
});

function createObstacle() {
  const obs = document.createElement('div');
  obs.className = 'obstacle';
  const w = 40 + Math.random() * 60;
  const h = 40 + Math.random() * 60;
  obs.style.width = `${w}px`;
  obs.style.height = `${h}px`;
  obs.style.left = `${Math.random() * (window.innerWidth - w)}px`;
  obs.style.top = `-100px`;
  game.appendChild(obs);
  obstacles.push(obs);
  animateObstacle(obs);
}

function createGoldCoin() {
  let valid = false;
  let left, top;
  const size = 30;
  let attempts = 0;
  while (!valid && attempts < 30) {
    left = Math.random() * (window.innerWidth - size);
    top = -60;
    const coinBox = { left, right: left + size, top, bottom: top + size };
    valid = obstacles.every(obs => {
      const rect = obs.getBoundingClientRect();
      return (
        coinBox.right < rect.left ||
        coinBox.left > rect.right ||
        coinBox.bottom < rect.top ||
        coinBox.top > rect.bottom
      );
    });
    attempts++;
  }
  if (!valid) return;
  const coin = document.createElement('div');
  coin.className = 'gold-coin';
  coin.style.width = `${size}px`;
  coin.style.height = `${size}px`;
  coin.style.left = `${left}px`;
  coin.style.top = `${top}px`;
  game.appendChild(coin);
  animateGoldCoin(coin);
}

function animateObstacle(obs) {
  let y = parseFloat(obs.style.top);
  const interval = setInterval(() => {
    if (!gameRunning) return clearInterval(interval);
    y += obstacleSpeed;
    obs.style.top = `${y}px`;
    if (y > window.innerHeight) {
      obs.remove();
      const idx = obstacles.indexOf(obs);
      if (idx > -1) obstacles.splice(idx, 1);
      clearInterval(interval);
      if (Math.random() < 0.3) {
        
      }
    }
    checkCollision(obs);
  }, 20);
}

function animateGoldCoin(coin) {
  let y = parseFloat(coin.style.top);
  const interval = setInterval(() => {
    if (!gameRunning) return clearInterval(interval);
    y += obstacleSpeed;
    coin.style.top = `${y}px`;
    if (y > window.innerHeight) {
      coin.remove();
      clearInterval(interval);
    }
    const p = player.getBoundingClientRect();
    const c = coin.getBoundingClientRect();
    const collected = p.left < c.right && p.right > c.left && p.top < c.bottom && p.bottom > c.top;
    if (collected) {
  score += 5;
  scoreDisplay.textContent = `점수: ${score}`;
  coin.remove();
  clearInterval(interval);
  coinSound.currentTime = 0;  // 빠르게 연속 재생 대비
  coinSound.play();

  goldCombo++;
  if (goldComboTimer) clearTimeout(goldComboTimer);
  goldComboTimer = setTimeout(() => {
    goldCombo = 0;
  }, 5000);

  if (goldCombo === 20 && lives < 5) {
    lives++;
    livesDisplay.textContent = `❤️ x ${lives}`;
    goldCombo = 0;
  }
}

  }, 20);
}

function checkCollision(obs) {
  if (!gameRunning || isInvincible) return;
  const p = player.getBoundingClientRect();
  const o = obs.getBoundingClientRect();
  const buffer = 20;
  const collide = p.left + buffer < o.right && p.right - buffer > o.left && p.top + buffer < o.bottom && p.bottom - buffer > o.top;
  if (collide) {
    handleHit();
    obs.remove();
  }
}

function handleHit() {
 
  lives--;
  livesDisplay.textContent = `❤️ x ${lives}`;
  if (lives <= 0) {
    gameRunning = false;
    showGameOver(score);  // 점수 전달!
  }
  isInvincible = true;
  let blink = 0;
  const blinkInterval = setInterval(() => {
    player.classList.toggle("hidden");
    blink++;
    if (blink >= 6) {
      clearInterval(blinkInterval);
      player.classList.remove("hidden");
      isInvincible = false;
    }
  }, 200);
}

async function showGameOver(score) {
  const name = prompt("이름을 입력하세요 (10자 이내):", "") || "";
  const trimmedName = name.slice(0, 10);
  await saveScore(trimmedName, score);
  const scoreHtml = await generateTopScoresHTML();

  const overlay = document.getElementById('overlay');
 overlay.innerHTML = `
<div style="
  display: flex;
  flex-direction: column;
  align-items: center;
  overflow-y: auto;
  padding: 40px 20px 60px;
  box-sizing: border-box;
  z-index: 999;
  color: white;
  font-size: 2rem;
">
  <div style="margin-bottom: 20px; font-size: 2rem; text-align: center;">💥 GAME OVER 💥</div>
  <h3 style="margin-top:10px; color:gold; text-align: center;">🏆 상위 10위 점수</h3>

  <div style="display: flex; justify-content: center; width: 100%;">
    <div style="
      font-size: 1rem;
      line-height: 1.8;
      background: rgba(255, 255, 255, 0.1);
      padding: 15px 25px;
      border-radius: 10px;
      max-height: 300px;
      overflow-y: auto;
      width: 90%;
      max-width: 400px;
      text-align: center;
    ">
      ${scoreHtml}
    </div>
  </div>

  <div style="margin-top: 20px; text-align: center;">
    <button class="btn" onclick="location.reload()">🔄 재시작</button>
    <button class="btn" onclick="overlay.innerHTML='게임 종료되었습니다.'">❌ 종료</button>
  </div>

`;
  overlay.style.display = 'flex';

  // 정지 처리
  bgm.pause();
  bgm.currentTime = 0;
  gameRunning = false;
  moveVX = 0;
  moveVY = 0;
}





setInterval(() => {
  if (gameRunning) {
    score++;
    scoreDisplay.textContent = `점수: ${score}`;
  }
}, 1000);

function spawnLoop() {
  if (!gameRunning) return;
  createObstacle();
  if (Math.random() < 0.4) createGoldCoin();
  setTimeout(spawnLoop, obstacleInterval);
}

setInterval(() => {
  if (gameRunning) {
    obstacleSpeed *= 1.05;
    if (obstacleInterval > 500) obstacleInterval *= 0.95;
  }
}, 10000);


  // 3. 사용자 클릭 후 BGM 재생 (브라우저 정책 대응)
 document.addEventListener('click', () => {
  if (bgm && bgm.paused) {
    bgm.play().catch(err => console.warn('Autoplay failed:', err));
  }
}, { once: true });


  livesDisplay.textContent = `❤️ x ${lives}`;
  spawnLoop();
 // displayTopScores();



let paused = false;

document.getElementById('pause-btn').addEventListener('click', () => {
  paused = !paused;
  gameRunning = !paused;

  const btn = document.getElementById('pause-btn');
  btn.textContent = paused ? '▶️' : '⏸️';

  if (paused) {
    bgm.pause();
  } else {
    bgm.play().catch(() => {});
    spawnLoop();
    requestAnimationFrame(updatePlayerPosition);  // ✅ 추가
    document.querySelectorAll('.obstacle, .gold-coin').forEach(el => el.remove());
    obstacles.length = 0;
  }
});



game.addEventListener('touchstart', () => {
  if (bgm && bgm.paused) {
    bgm.play().catch(err => console.warn('Autoplay failed:', err));
  }
}, { once: true });

function saveScore(name, score) {
  const scoresRef = ref(db, 'carGameScores');
  const newScoreRef = push(scoresRef);
  return set(newScoreRef, { name, score, timestamp: Date.now() });
}
// const endBtn = document.getElementById('end-btn'); // ✅ 이 줄이 빠졌음!




function saveScoreToFirebase(name, score) {
  const scoresRef = ref(db, "scores");
  return push(scoresRef, { name, score }); // return 추가!
}


function fetchTopScores() {
  const scoresRef = ref(db, "scores");

  get(scoresRef).then((snapshot) => {
    if (snapshot.exists()) {
      const data = snapshot.val();
      const scoreArray = Object.values(data);  // ✅ 배열 생성

      const topScores = scoreArray
        .sort((a, b) => b.score - a.score)
        .slice(0, 10); // 상위 10개만

      displayTopScores(topScores);  // ✅ 여기서만 호출해야 안전함
    }
  });
}


function displayTopScores(topScores) {
  const list = document.getElementById("score-list");
  list.innerHTML = "";

  topScores.forEach((entry, index) => {
    const li = document.createElement("li");
    li.textContent = `${index + 1}. ${entry.name} - ${entry.score}점`;
    list.appendChild(li);
  });

  document.getElementById("scoreboard").style.display = "block";
}

// 사용자 첫 입력 시만 BGM 실행 (PC + 모바일 대응)
['click', 'touchstart'].forEach(eventName => {
  window.addEventListener(eventName, () => {
    if (bgm.paused) {
      bgm.play().catch(() => {});
    }
  }, { once: true });
});
// 1. BGM 설정
const bgmList = [
  new Audio('car01.mp3'),
  new Audio('car02.mp3'),
  new Audio('car03.mp3')
];
let bgm = bgmList[Math.floor(Math.random() * bgmList.length)];
bgm.loop = true;
bgm.volume = 0.6;

// 2. 사용자 터치/클릭 시 최초 1회 재생 시도
function tryPlayBGM() {
  bgm.play().catch(err => {
    console.warn('🎵 BGM 재생 실패:', err);
  });
}
document.addEventListener('click', tryPlayBGM, { once: true });
document.addEventListener('touchstart', tryPlayBGM, { once: true });


</script>

<!-- 게임 종료 후 랭킹 보여주는 영역 -->
<div id="scoreboard" style="display: none; text-align: center; margin-top: 30px;">
  <h2>🏆 상위 10위 점수</h2>
  <ol id="score-list"></ol>
</div>

 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getDatabase, ref, push, set, query, orderByChild, limitToLast, onValue
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
    authDomain: "number-baseball-aee52.firebaseapp.com",
    databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
    projectId: "number-baseball-aee52",
    storageBucket: "number-baseball-aee52.firebasestorage.app",
    messagingSenderId: "998537150772",
    appId: "1:998537150772:web:c937403c219103d491a561"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  function saveScore(name, score) {
    const scoresRef = ref(db, 'carGameScores');
    const newScoreRef = push(scoresRef);
    return set(newScoreRef, { name, score, timestamp: Date.now() });
  }

  function generateTopScoresHTML() {
  return new Promise((resolve) => {
    const scoresRef = query(ref(db, 'carGameScores'), orderByChild('score'), limitToLast(10));
    onValue(scoresRef, (snapshot) => {
      const list = [];
      snapshot.forEach(child => {
        const val = child.val();
        if (typeof val.score === 'number') list.push(val);
      });

      list.sort((a, b) => b.score - a.score); // 점수 높은 순

      const html = list
        .map((item, i) => {
          const rank = i + 1; // 1위부터
          return `<div><strong>${rank}위</strong>: ${item.name} - ${item.score}점</div>`;
        })
        .join('');
      resolve(html);
    }, { onlyOnce: true });
  });
}


  

  // ✅ 전역 등록
  window.saveScore = saveScore;
  window.generateTopScoresHTML = generateTopScoresHTML;
  window.showGameOver = showGameOver;
  window.db = db;
  window.ref = ref;
  window.push = push;
  window.set = set;
</script>



</body>
</html>
