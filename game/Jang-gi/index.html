<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HTML 장기 게임 (반응형 · 비율 스케일)</title>
  <style>
    :root{
      --cell-size:56px;                 /* JS가 화면에 맞춰 갱신 */
      --board-width:calc(var(--cell-size)*8);
      --board-height:calc(var(--cell-size)*9);
      --border-color:#3a2a1a;
      --board-bg:#e4c59a;

      /* ✅ 말 크기 배율(칸 대비): 1.17 ≈ 기존보다 +30% */
      --piece-scale:1.3;
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
      display:flex;justify-content:center;align-items:center;flex-direction:column;
      background:#f0e6d2;margin:0;padding:16px;min-height:100dvh;
    }
    h1{margin:8px 0 12px;font-size:clamp(18px,4.5vw,28px);color:#333}

    #janggi-board-container{
      position:relative;
      width:calc(var(--board-width)+var(--cell-size));
      height:calc(var(--board-height)+var(--cell-size));
      max-width:100vw;
      max-height:calc(100dvh - 100px);
      background:var(--board-bg);
      border:2px solid var(--border-color);
      padding:calc(var(--cell-size)/2);
      overflow:hidden;
    }

    #janggi-board{
      position:relative;
      width:var(--board-width);
      height:var(--board-height);
      background-image:
        repeating-linear-gradient(to right, transparent, transparent calc(var(--cell-size) - 1px), var(--border-color) calc(var(--cell-size) - 1px), var(--border-color) var(--cell-size)),
        repeating-linear-gradient(to bottom, transparent, transparent calc(var(--cell-size) - 1px), var(--border-color) calc(var(--cell-size) - 1px), var(--border-color) var(--cell-size));
      background-size:var(--cell-size) var(--cell-size);
      border:1px solid var(--border-color);
    }

    #palace-overlay{position:absolute;inset:0;pointer-events:none;z-index:1}
    #pieces-layer{position:absolute;inset:0;pointer-events:none;z-index:2}

    /* ✅ 말: 위치는 % 비율, 크기는 칸 크기에 연동 */
    .piece{
      position:absolute;
      width:calc(var(--cell-size) * var(--piece-scale));
      height:calc(var(--cell-size) * var(--piece-scale));
      left:calc(var(--col) * 100% / 8);    /* 0..8 칸 → 8분할 */
      top:calc(var(--row) * 100% / 9);     /* 0..9 칸 → 9분할 */
      transform:translate(-50%, -50%);
      background-size:contain;background-repeat:no-repeat;background-position:center;
      border-radius:50%;
      cursor:pointer;
      pointer-events:auto;
      transition:transform .2s ease, box-shadow .2s ease;
    }
    .piece.selected{box-shadow:0 0 12px 4px rgba(255,0,0,.55)}
  </style>
</head>
<body>
  <h1>HTML 장기 게임 (반응형 비율 스케일)</h1>
  <div id="janggi-board-container">
    <div id="janggi-board">
      <svg id="palace-overlay" width="100%" height="100%"></svg>
      <div id="pieces-layer"></div>
    </div>
  </div>

  <script>
    const boardElement = document.getElementById('janggi-board');
    const overlay = document.getElementById('palace-overlay');
    const piecesLayer = document.getElementById('pieces-layer');

    const getCellSize = () =>
      parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell-size'));

    const initialSetup = {
      // 초
      '0,0':{team:'cho',piece:'cha'}, '0,1':{team:'cho',piece:'sang'},
      '0,2':{team:'cho',piece:'ma'},  '0,3':{team:'cho',piece:'sa'},
      '0,5':{team:'cho',piece:'sa'},  '0,6':{team:'cho',piece:'ma'},
      '0,7':{team:'cho',piece:'sang'},'0,8':{team:'cho',piece:'cha'},
      '1,4':{team:'cho',piece:'jang'},
      '2,1':{team:'cho',piece:'po'},  '2,7':{team:'cho',piece:'po'},
      '3,0':{team:'cho',piece:'jol'}, '3,2':{team:'cho',piece:'jol'},
      '3,4':{team:'cho',piece:'jol'}, '3,6':{team:'cho',piece:'jol'},
      '3,8':{team:'cho',piece:'jol'},
      // 한
      '9,0':{team:'han',piece:'cha'}, '9,1':{team:'han',piece:'sang'},
      '9,2':{team:'han',piece:'ma'},  '9,3':{team:'han',piece:'sa'},
      '9,5':{team:'han',piece:'sa'},  '9,6':{team:'han',piece:'ma'},
      '9,7':{team:'han',piece:'sang'},'9,8':{team:'han',piece:'cha'},
      '8,4':{team:'han',piece:'jang'},
      '7,1':{team:'han',piece:'po'},  '7,7':{team:'han',piece:'po'},
      '6,0':{team:'han',piece:'byung'},'6,2':{team:'han',piece:'byung'},
      '6,4':{team:'han',piece:'byung'},'6,6':{team:'han',piece:'byung'},
      '6,8':{team:'han',piece:'byung'}
    };

    function updateCellSize(){
      const titleH = (document.querySelector('h1')?.offsetHeight || 0);
      const pad = 16*2, extraH = titleH + 24;
      const maxCellByW = (window.innerWidth - pad) / 9;
      const maxCellByH = (window.innerHeight - pad - extraH) / 10;
      const cell = Math.floor(Math.max(32, Math.min(maxCellByW, maxCellByH)));
      document.documentElement.style.setProperty('--cell-size', cell + 'px');
    }

    function drawPalaceLines(){
      const CELL_SIZE = getCellSize();
      const W = 8 * CELL_SIZE, H = 9 * CELL_SIZE;
      overlay.setAttribute('viewBox', `0 0 ${W} ${H}`);
      while(overlay.firstChild) overlay.removeChild(overlay.firstChild);

      const strokeColor = getComputedStyle(document.documentElement)
                            .getPropertyValue('--border-color').trim() || '#3a2a1a';
      const mk = (x1,y1,x2,y2)=>{
        const ln = document.createElementNS('http://www.w3.org/2000/svg','line');
        ln.setAttribute('x1',x1); ln.setAttribute('y1',y1);
        ln.setAttribute('x2',x2); ln.setAttribute('y2',y2);
        ln.setAttribute('stroke',strokeColor);
        ln.setAttribute('stroke-width',1);
        ln.setAttribute('stroke-opacity',0.8);
        ln.setAttribute('shape-rendering','crispEdges');
        return ln;
      };
      overlay.appendChild(mk(3*CELL_SIZE,0*CELL_SIZE,5*CELL_SIZE,2*CELL_SIZE));
      overlay.appendChild(mk(5*CELL_SIZE,0*CELL_SIZE,3*CELL_SIZE,2*CELL_SIZE));
      overlay.appendChild(mk(3*CELL_SIZE,7*CELL_SIZE,5*CELL_SIZE,9*CELL_SIZE));
      overlay.appendChild(mk(5*CELL_SIZE,7*CELL_SIZE,3*CELL_SIZE,9*CELL_SIZE));
    }

    function placePieces(){
      piecesLayer.innerHTML='';
      for (const [pos,info] of Object.entries(initialSetup)){
        const [row,col] = pos.split(',').map(Number);
        const el = document.createElement('div');
        el.className='piece';

        const name = (info.team==='han' && info.piece==='byung') ? 'byung'
                   : (info.team==='cho' && info.piece==='jol')   ? 'jol'
                   : info.piece;
        el.style.backgroundImage = `url('${info.team}_${name}.svg')`;

        el.dataset.team = info.team;
        el.dataset.piece = info.piece;
        el.dataset.row = row;
        el.dataset.col = col;

        /* ✅ 위치를 CSS 커스텀 변수로 저장 → % 비율로 반영됨 */
        el.style.setProperty('--row', row);
        el.style.setProperty('--col', col);

        piecesLayer.appendChild(el);
      }
    }

    // === 선택 & 이동 (룰 체크 없이 데모 이동) ===
    let selected = null;
    boardElement.addEventListener('click', (e)=>{
      const t = e.target.closest('.piece');
      if (t){
        if (selected) selected.classList.remove('selected');
        if (selected === t){ selected = null; return; }
        selected = t; selected.classList.add('selected'); return;
      }
      if (!selected) return;

      const CELL_SIZE = getCellSize();
      const rect = boardElement.getBoundingClientRect();
      const x = e.clientX - rect.left, y = e.clientY - rect.top;

      const col = Math.round(x / CELL_SIZE);
      const row = Math.round(y / CELL_SIZE);
      if (col<0||col>8||row<0||row>9){ selected.classList.remove('selected'); selected=null; return; }

      // 충돌(상대만 제거)
      const target = piecesLayer.querySelector(`.piece[data-row='${row}'][data-col='${col}']`);
      if (target){
        if (target.dataset.team !== selected.dataset.team) target.remove();
        else { selected.classList.remove('selected'); selected=null; return; }
      }

      selected.dataset.row = row;
      selected.dataset.col = col;
      /* ✅ 위치 변수만 갱신하면 크기/위치는 자동 비율 반영 */
      selected.style.setProperty('--row', row);
      selected.style.setProperty('--col', col);

      selected.classList.remove('selected'); selected=null;
    });

    function renderAll(){ updateCellSize(); drawPalaceLines(); }

    // 초기 렌더
    updateCellSize();
    drawPalaceLines();
    placePieces();

    // 화면 회전/리사이즈 대응
    addEventListener('resize', renderAll);
    addEventListener('orientationchange', renderAll);
  </script>
</body>
</html>
