<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HTML 장기 게임 (궁 X 레이어 고정)</title>
  <style>
    :root {
      --cell-size: 56px;
      --board-width: calc(var(--cell-size) * 8);
      --board-height: calc(var(--cell-size) * 9);
      --border-color: #3a2a1a;
      --board-bg: #e4c59a;
    }

    body {
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      background-color: #f0e6d2;
      padding: 20px;
    }

    h1 { color: #333; }

    #janggi-board-container {
      position: relative;
      width: calc(var(--board-width) + var(--cell-size));
      height: calc(var(--board-height) + var(--cell-size));
      background-color: var(--board-bg);
      border: 2px solid var(--border-color);
      padding: calc(var(--cell-size) / 2);
      box-sizing: border-box;
    }

    /* 보드: 격자 배경만 담당(스택 컨텍스트 만들지 않도록 z-index 주지 않음) */
    #janggi-board {
      position: relative;
      width: var(--board-width);
      height: var(--board-height);
      background-image:
        /* 세로줄 */
        repeating-linear-gradient(
          to right,
          transparent,
          transparent calc(var(--cell-size) - 1px),
          var(--border-color) calc(var(--cell-size) - 1px),
          var(--border-color) var(--cell-size)
        ),
        /* 가로줄 */
        repeating-linear-gradient(
          to bottom,
          transparent,
          transparent calc(var(--cell-size) - 1px),
          var(--border-color) calc(var(--cell-size) - 1px),
          var(--border-color) var(--cell-size)
        );
      background-size: var(--cell-size) var(--cell-size);
      border: 1px solid var(--border-color);
      /* z-index 없음! */
    }

    /* 궁 X (SVG) 레이어: 격자 위, 말 아래 */
    #palace-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 1;
    }

    /* 말 레이어: 항상 궁 X 위 */
    #pieces-layer {
      position: absolute;
      inset: 0;
      z-index: 2;
      pointer-events: none; /* 클릭은 각 말에만 먹이도록 기본은 막음 */
    }

    /* 말 토큰 (SVG 이미지를 배경으로) */
    .piece {
      position: absolute;
      width: calc(var(--cell-size) * 0.9);
      height: calc(var(--cell-size) * 0.9);
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      transform: translate(-50%, -50%);
      box-sizing: border-box;
      pointer-events: auto; /* 말은 클릭 가능 */
    }
    .piece.selected { box-shadow: 0 0 15px 5px rgba(255, 0, 0, 0.7); }
  </style>
</head>
<body>

  <h1>HTML 장기 게임 (최종 수정판)</h1>
  <div id="janggi-board-container">
    <div id="janggi-board">
      <!-- 궁 대각선(X) SVG -->
      <svg id="palace-overlay" width="100%" height="100%"></svg>
      <!-- 말 전용 레이어 -->
      <div id="pieces-layer"></div>
    </div>
  </div>

  <script>
    const boardElement = document.getElementById('janggi-board');
    const overlay = document.getElementById('palace-overlay');
    const piecesLayer = document.getElementById('pieces-layer');

    // CSS 변수에서 CELL_SIZE 읽기
    const CELL_SIZE = parseFloat(getComputedStyle(document.documentElement)
                        .getPropertyValue('--cell-size'));

    // 초기 배치: row(0~9), col(0~8) — 교차점 기준
    const initialSetup = {
      // 초 (위)
      '0,0': { team: 'cho', piece: 'cha' }, '0,1': { team: 'cho', piece: 'sang' },
      '0,2': { team: 'cho', piece: 'ma' },  '0,3': { team: 'cho', piece: 'sa' },
      '0,5': { team: 'cho', piece: 'sa' },  '0,6': { team: 'cho', piece: 'ma' },
      '0,7': { team: 'cho', piece: 'sang' },'0,8': { team: 'cho', piece: 'cha' },
      '1,4': { team: 'cho', piece: 'jang' },
      '2,1': { team: 'cho', piece: 'po' },  '2,7': { team: 'cho', piece: 'po' },
      '3,0': { team: 'cho', piece: 'jol' }, '3,2': { team: 'cho', piece: 'jol' },
      '3,4': { team: 'cho', piece: 'jol' }, '3,6': { team: 'cho', piece: 'jol' },
      '3,8': { team: 'cho', piece: 'jol' },
      // 한 (아래)
      '9,0': { team: 'han', piece: 'cha' }, '9,1': { team: 'han', piece: 'sang' },
      '9,2': { team: 'han', piece: 'ma' },  '9,3': { team: 'han', piece: 'sa' },
      '9,5': { team: 'han', piece: 'sa' },  '9,6': { team: 'han', piece: 'ma' },
      '9,7': { team: 'han', piece: 'sang' },'9,8': { team: 'han', piece: 'cha' },
      '8,4': { team: 'han', piece: 'jang' },
      '7,1': { team: 'han', piece: 'po' },  '7,7': { team: 'han', piece: 'po' },
      '6,0': { team: 'han', piece: 'byung' }, '6,2': { team: 'han', piece: 'byung' },
      '6,4': { team: 'han', piece: 'byung' }, '6,6': { team: 'han', piece: 'byung' },
      '6,8': { team: 'han', piece: 'byung' }
    };

    /** 궁 X를 CELL_SIZE 기준으로 정확히 그리기 */
    function drawPalaceLines() {
      const W = 8 * CELL_SIZE; // cols 0..8 → 8칸 간격
      const H = 9 * CELL_SIZE; // rows 0..9 → 9칸 간격

      overlay.setAttribute('viewBox', `0 0 ${W} ${H}`);

      while (overlay.firstChild) overlay.removeChild(overlay.firstChild);

      const mkLine = (x1, y1, x2, y2) => {
        const ln = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        ln.setAttribute('x1', x1); ln.setAttribute('y1', y1);
        ln.setAttribute('x2', x2); ln.setAttribute('y2', y2);
        ln.setAttribute('stroke', getComputedStyle(document.documentElement)
                            .getPropertyValue('--border-color').trim() || '#3a2a1a');
        ln.setAttribute('stroke-width', 3);
        ln.setAttribute('stroke-linecap', 'square');
        ln.setAttribute('shape-rendering', 'crispEdges');
        return ln;
      };

      // 위 궁: (3,0)-(5,2)
      overlay.appendChild(mkLine(3*CELL_SIZE, 0*CELL_SIZE, 5*CELL_SIZE, 2*CELL_SIZE));
      overlay.appendChild(mkLine(5*CELL_SIZE, 0*CELL_SIZE, 3*CELL_SIZE, 2*CELL_SIZE));

      // 아래 궁: (3,7)-(5,9)
      overlay.appendChild(mkLine(3*CELL_SIZE, 7*CELL_SIZE, 5*CELL_SIZE, 9*CELL_SIZE));
      overlay.appendChild(mkLine(5*CELL_SIZE, 7*CELL_SIZE, 3*CELL_SIZE, 9*CELL_SIZE));
    }

    /** 말 배치 */
    function placePieces() {
      Object.entries(initialSetup).forEach(([pos, info]) => {
        const [row, col] = pos.split(',').map(Number);
        const el = document.createElement('div');
        el.className = 'piece';

        // 같은 폴더: han_*.svg / cho_*.svg
        const pieceName =
          info.team === 'han' && info.piece === 'byung' ? 'byung' :
          info.team === 'cho' && info.piece === 'jol'   ? 'jol'   : info.piece;

        el.style.backgroundImage = `url('${info.team}_${pieceName}.svg')`;
        el.dataset.team = info.team;
        el.dataset.piece = info.piece;
        el.dataset.row = row;
        el.dataset.col = col;

        // 교차점 중심에 배치
        el.style.left = `${col * CELL_SIZE}px`;
        el.style.top  = `${row * CELL_SIZE}px`;

        piecesLayer.appendChild(el);
      });
    }

    // === 선택 & 이동 (룰 체크 없이 데모 이동) ===
    let selected = null;

    // 클릭은 보드 전체에, 실제 타깃은 말에만 적용되도록
    boardElement.addEventListener('click', (e) => {
      const t = e.target.closest('.piece');
      if (t) {
        if (selected) selected.classList.remove('selected');
        if (selected === t) { selected = null; return; }
        selected = t;
        selected.classList.add('selected');
        return;
      }

      if (selected) {
        const rect = boardElement.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        const col = Math.round(x / CELL_SIZE);
        const row = Math.round(y / CELL_SIZE);

        if (col < 0 || col > 8 || row < 0 || row > 9) return;

        // 간단 충돌 처리(상대 말만 제거)
        const target = piecesLayer.querySelector(`.piece[data-row='${row}'][data-col='${col}']`);
        if (target) {
          if (target.dataset.team !== selected.dataset.team) target.remove();
          else { selected.classList.remove('selected'); selected = null; return; }
        }

        selected.style.left = `${col * CELL_SIZE}px`;
        selected.style.top  = `${row * CELL_SIZE}px`;
        selected.dataset.row = row;
        selected.dataset.col = col;

        selected.classList.remove('selected');
        selected = null;
      }
    });

    // 초기 렌더
    drawPalaceLines();
    placePieces();
  </script>
</body>
</html>
