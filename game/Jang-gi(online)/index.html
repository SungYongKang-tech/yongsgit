<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>장기 온라인 · 로비</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root { --card:#fff; --muted:#6b7280; }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      background:linear-gradient(135deg,#e0f7fa,#fce4ec);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
    }
    .panel{
      width:min(460px,92vw);
      background:#fff; border:1px solid #e5e7eb; border-radius:16px;
      box-shadow:0 8px 30px rgba(0,0,0,.10); padding:18px 16px;
      text-align:center;
    }
    h1{margin:4px 0 14px; font-size:clamp(20px,5.5vw,28px); color:#222}
    button{
      padding:12px 16px; font-size:15px; border-radius:12px; cursor:pointer;
      border:1px solid #94a3b8; background:#fff; transition:transform .12s ease, box-shadow .12s ease;
      width:150px;
      margin:8px;
    }
    button:hover{ transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.10) }
    .hint{margin-top:10px; color:#6b7280; font-size:13px; text-align:center}
    .me{margin-top:6px; text-align:center; font-size:12px; color:#94a3b8}
  </style>
</head>
<body>
  <div class="panel">
    <h1>장기 온라인 (2인)</h1>

    <div>
      <button id="btnCreate">방 생성하기</button>
      <button id="btnJoin">방 참여하기</button>
    </div>

    <div class="hint">
      방은 생성 후 <b>1분</b> 안에 참여해야 합니다.<br>
      1분이 지나면 자동으로 입장이 제한됩니다.
    </div>
    <div class="me" id="meLine">로그인 대기중…</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get, set, runTransaction, update, onDisconnect } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // --- Firebase 초기화 ---
    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.firebasestorage.app",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:dfe39687717f28b891a561"
    };
    const app  = initializeApp(firebaseConfig);
    const db   = getDatabase(app);
    const auth = getAuth(app);

    const meLine = document.getElementById('meLine');

    // 익명 로그인
    async function ensureAnon(){
      if (auth.currentUser) return auth.currentUser;
      return new Promise((resolve,reject)=>{
        const unsub = onAuthStateChanged(auth, u=>{ if(u){unsub(); resolve(u);} });
        signInAnonymously(auth).catch(reject);
      });
    }
    ensureAnon().then(u=>{ meLine.textContent = `UID: ${u.uid.slice(0,8)}…`; })
                .catch(()=>{ meLine.textContent = '로그인 실패'; });

    // --- 전용 경로 ---
    const NS = 'janggiRooms';
    const r = (room, p='') => ref(db, p ? `${NS}/${room}/${p}` : `${NS}/${room}`);

    const btnCreate = document.getElementById('btnCreate');
    const btnJoin   = document.getElementById('btnJoin');

    // 랜덤 방 코드 생성
    function randomRoomCode(){
      return 'room-' + Math.random().toString(36).substring(2,8);
    }

    // --- 방 생성 ---
    btnCreate.onclick = async ()=>{
      try{
        await ensureAnon();
        const room = randomRoomCode();
        const uid = auth.currentUser.uid;
        const now = Date.now();

        await set(r(room), {
          createdAt: now,
          status: 'waiting',
          playerCount: 1,
          players: { [uid]: { role: 0, joinedAt: now } } // 생성자는 항상 role=0
        });

        onDisconnect(r(room, `players/${uid}`)).remove();
        sessionStorage.setItem('currentRoom', room); // 참여자가 알 수 있도록 저장
        alert(`방이 생성되었습니다! 1분 안에 다른 사용자가 참여해야 합니다.`);
        location.href = `game.html?room=${encodeURIComponent(room)}`;
      }catch(e){
        console.error('방 생성 실패:', e);
        alert('방 생성 중 오류가 발생했습니다.');
      }
    };

    // --- 방 참여 ---
    btnJoin.onclick = async ()=>{
      try{
        await ensureAnon();
        const room = sessionStorage.getItem('currentRoom');
        if(!room){
          alert('현재 참여 가능한 방이 없습니다. 먼저 방을 생성해 주세요.');
          return;
        }

        const roomRef = r(room);
        const playersRef = r(room, 'players');
        const exist = await get(roomRef);
        if(!exist.exists()){
          alert('방이 존재하지 않습니다.');
          return;
        }

        // ★ 방 생성 후 1분 이내 체크
        const createdAt = exist.val().createdAt;
        if(Date.now() - createdAt > 60000){
          alert('방이 생성된 지 1분이 지나 입장할 수 없습니다.');
          return;
        }

        const uid = auth.currentUser.uid;
        let myRole = 1;
        const res = await runTransaction(playersRef, (players)=>{
          players = players || {};
          const ids = Object.keys(players);
          if (!players[uid] && ids.length >= 2) return; // 꽉 찼음
          if (players[uid]) return players; // 이미 입장

          const taken = Object.values(players).map(p=>p.role);
          myRole = taken.includes(0) ? 1 : 0;
          players[uid] = { role: myRole, joinedAt: Date.now() };
          return players;
        });

        if (!res.committed){
          alert('이미 2명이 입장했습니다.');
          return;
        }

        const cnt = Object.keys(res.snapshot.val()||{}).length;
        await update(roomRef, { playerCount: cnt, status: (cnt>=2 ? 'playing' : 'waiting') });

        onDisconnect(r(room, `players/${uid}`)).remove();
        location.href = `game.html?room=${encodeURIComponent(room)}`;
      }catch(e){
        console.error('방 참여 실패:', e);
        alert('방 참여 중 오류가 발생했습니다.');
      }
    };
  </script>
</body>
</html>
