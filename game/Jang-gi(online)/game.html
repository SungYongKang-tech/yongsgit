<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>장기 게임 (온라인 2인)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root {
      --cell-size:56px;
      --board-width:calc(var(--cell-size)*8);
      --board-height:calc(var(--cell-size)*9);
      --border-color:#3a2a1a;
      --board-bg:#e4c59a;
      --piece-scale:1.3;
      --dot-size:16px;
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
      display:flex;justify-content:center;align-items:center;flex-direction:column;
      background:#f0e6d2;margin:0;padding:16px;min-height:100dvh;
    }
    h1{margin:8px 0 6px;font-size:clamp(18px,4.5vw,28px);color:#333}
    .topline{font-size:14px;margin:4px 0 10px;color:#444;text-align:center}

    .bar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; margin:6px 0 8px; font-size:14px; color:#374151;}
    .msg { min-height:22px; font-weight:700; color:#b00020; text-align:center; }

    #janggi-board-container{
      position:relative;
      width:calc(var(--board-width)+var(--cell-size));
      height:calc(var(--board-height)+var(--cell-size));
      max-width:100vw;
      max-height:calc(100dvh - 190px);
      background:var(--board-bg);
      border:2px solid var(--border-color);
      padding:calc(var(--cell-size)/2);
      overflow:hidden;
    }
    #janggi-board{
      position:relative;
      width:var(--board-width);
      height:var(--board-height);
      background-image:
        repeating-linear-gradient(to right,
          transparent, transparent calc(var(--cell-size) - 1px),
          var(--border-color) calc(var(--cell-size) - 1px),
          var(--border-color) var(--cell-size)),
        repeating-linear-gradient(to bottom,
          transparent, transparent calc(var(--cell-size) - 1px),
          var(--border-color) calc(var(--cell-size) - 1px),
          var(--border-color) var(--cell-size));
      background-size:var(--cell-size) var(--cell-size);
      border:1px solid var(--border-color);
    }
    #palace-overlay{position:absolute;inset:0;pointer-events:none;z-index:1}
    #pieces-layer{position:absolute;inset:0;z-index:2}
    #moves-layer{position:absolute;inset:0;pointer-events:none;z-index:3}
    .move-dot{ pointer-events:auto; }
    .piece{
      position:absolute;
      width:calc(var(--cell-size) * var(--piece-scale));
      height:calc(var(--cell-size) * var(--piece-scale));
      left:calc(var(--col) * 100% / 8);
      top:calc(var(--row) * 100% / 9);
      transform:translate(-50%, -50%);
      background-size:contain;background-repeat:no-repeat;background-position:center;
      border-radius:50%;
      cursor:pointer;
      transition:box-shadow .15s ease, transform .15s ease;
    }
    .piece.selected{ box-shadow:0 0 12px 4px rgba(255,0,0,.55) }
    .move-dot{
      position:absolute; width:var(--dot-size); height:var(--dot-size);
      left:calc(var(--col) * 100% / 8); top:calc(var(--row) * 100% / 9);
      transform:translate(-50%, -50%); border-radius:50%;
      background:rgba(0,0,0,.15); border:2px solid rgba(0,0,0,.35); cursor:pointer;
    }
    .row{display:flex; gap:12px; align-items:center; justify-content:center; margin:4px 0 10px; font-size:14px;}
    label { user-select:none; }
    .banner{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; z-index:4; font-weight:900; letter-spacing:2px; text-shadow:0 2px 6px rgba(0,0,0,.25); font-size:clamp(28px, 8vw, 96px); opacity:0; transition:opacity .3s ease;}
    .banner.show{ opacity:.9; }
    .banner.cho{ color:#1e64ff; }
    .banner.han{ color:#e53935; }
    #result-overlay{position:absolute; inset:0; z-index:6; background:rgba(0,0,0,.66); display:none; align-items:center; justify-content:center;}
    #result-text{color:#fff; font-size:clamp(36px, 12vw, 120px); font-weight:900; text-shadow:0 4px 18px rgba(0,0,0,.65);}
  </style>
</head>
<body>
  <h1>장기 게임 (온라인)</h1>

  <div class="row" id="setupControls">
    <label>초 배치:
      <select id="choPattern">
        <option value="마상마상">마상마상</option>
        <option value="상마상마">상마상마</option>
        <option value="마상상마">마상상마</option>
        <option value="상마마상">상마마상</option>
      </select>
    </label>
    <label>한 배치:
      <select id="hanPattern">
        <option value="마상마상">마상마상</option>
        <option value="상마상마">상마상마</option>
        <option value="마상상마">마상상마</option>
        <option value="상마마상">상마마상</option>
      </select>
    </label>
    <button id="startBtn">시작</button>
    <button id="restartBtn">재시작</button>
    <button id="endBtn">게임 종료</button>
  </div>

  <div class="topline" id="roomInfo">방 정보 불러오는 중…</div>
  <div class="bar" id="setupInfo">초 배치 / 한 배치 불러오는 중…</div>
  <div class="row"><span class="msg" id="statusMsg"></span></div>

  <div id="janggi-board-container">
    <div id="janggi-board">
      <svg id="palace-overlay" width="100%" height="100%"></svg>
      <div id="pieces-layer"></div>
      <div id="moves-layer"></div>
      <div id="turn-banner" class="banner"></div>
      <div id="result-overlay"><div id="result-text"></div></div>
    </div>
  </div>

  <audio id="moveSnd" src="button-29.mp3" preload="auto"></audio>
  <audio id="capSnd"  src="button2.mp3"  preload="auto"></audio>

  <script type="module">
    /* ================= Firebase ================= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get, set, onValue, update, remove } 
      from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } 
      from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.firebasestorage.app",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:dfe39687717f28b891a561"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    const auth = getAuth(app);

    async function ensureAnon() {
      if (auth.currentUser) return auth.currentUser;
      return new Promise((resolve, reject) => {
        const unsub = onAuthStateChanged(auth, u => { if(u){unsub(); resolve(u);} });
        signInAnonymously(auth).catch(reject);
      });
    }
    await ensureAnon();

    /* URL 파라미터 / 방 진입 */
    const params = new URLSearchParams(location.search);
    const roomId = params.get('room');
    if (!roomId) { alert('room 파라미터가 없습니다.'); location.href='index.html'; }

    // ---- 경로 통일: /janggiRooms/rooms/{roomId} ----
    const NS = 'janggiRooms';
    const basePath     = `${NS}/rooms/${roomId}`;
    const roomRef      = ref(db, basePath);                           // 읽기 전용(쓰기 금지)
    const playersRef   = ref(db, `${basePath}/players`);
    const settingsRef  = ref(db, `${basePath}/settings`);
    const stateRef     = ref(db, `${basePath}/state`);
    const readyRef     = ref(db, `${basePath}/playersReady/${auth.currentUser.uid}`);
    const readyAllRef  = ref(db, `${basePath}/playersReady`);

    const roomInfo  = document.getElementById('roomInfo');
    const setupInfo = document.getElementById('setupInfo');
    const statusMsg = document.getElementById('statusMsg');
    const setMsg    = (t)=> statusMsg.textContent = t || '';

    let myRole = null;     // 0=초, 1=한
    let myTeam = null;     // 'cho' | 'han'
    let gameOver = false;

    // --- 내가 방의 플레이어인지 확인(규칙 만족 보장) ---
    try {
      const me = auth.currentUser.uid;
      const meSnap = await get(ref(db, `${basePath}/players/${me}`));
      if (!meSnap.exists()) {
        alert('이 방의 플레이어가 아닙니다. 로비에서 입장 후 다시 시도해주세요.');
        location.href = 'index.html';
      } else {
        myRole = meSnap.val().role;
        myTeam = (myRole === 0) ? 'cho' : 'han';
      }
    } catch (e) {
      console.error(e);
    }

    // UI 요소
    const startBtn     = document.getElementById('startBtn');
    const restartBtn   = document.getElementById('restartBtn');
    const endBtn       = document.getElementById('endBtn');
    const choPatternEl = document.getElementById('choPattern');
    const hanPatternEl = document.getElementById('hanPattern');

    // ====== 시작 준비 ======
    startBtn.onclick = async () => {
      try {
        // ✅ 부모가 아니라 child 경로(settingsRef)에 직접 쓰기
        await update(settingsRef, {
          choPattern: choPatternEl.value,
          hanPattern: hanPatternEl.value,
          firstTurn: 'cho',
          creatorRole: myRole
        });
        await set(readyRef, true); // playersReady/{uid}: true
        setMsg('시작 준비 완료. 상대방도 시작 버튼을 눌러야 합니다.');
      } catch (e) {
        console.error('start error', e);
        alert('시작 설정 저장에 실패했습니다.');
      }
    };

    // ====== 재시작 ======
    restartBtn.onclick = async () => {
      if (!confirm('정말 재시작 하시겠습니까?')) return;
      try {
        await update(settingsRef, {
          choPattern: choPatternEl.value,
          hanPattern: hanPatternEl.value,
          firstTurn: 'cho',
          creatorRole: myRole
        });
        await set(stateRef, {
          board: makeInitialSetup(choPatternEl.value, hanPatternEl.value),
          turn: 'cho',
          plyCount: 0,
          ended: false,
          winner: null
        });
        setMsg('게임이 재시작되었습니다.');
        document.getElementById('result-overlay').style.display = 'none';
      } catch (e) {
        console.error('restart error', e);
        alert('재시작에 실패했습니다.');
      }
    };

    // ====== 종료 ======
    endBtn.onclick = async () => {
      if (!confirm('게임을 종료하시겠습니까?')) return;
      try {
        await update(stateRef, {
          ended: true,
          winner: null,
          message: '게임이 강제로 종료되었습니다.'
        });
        setMsg('게임이 종료되었습니다.');
      } catch (e) {
        console.error('end error', e);
        alert('종료 처리에 실패했습니다.');
      }
    };

    // ====== 두 명 모두 준비되면 시작 ======
    onValue(readyAllRef, async (snap) => {
      const ready = snap.val() || {};
      const playersSnap = await get(playersRef);
      const players = playersSnap.val() || {};
      const playerCount = Object.keys(players).length;
      const readyCount = Object.keys(ready).filter(uid => ready[uid]).length;

      // (디버그 표시)
      console.log('[ready]', ready, 'players', players);

      if (playerCount === 2 && readyCount === 2) {
        const settingsSnap = await get(settingsRef);
        const settings = settingsSnap.val() || {
          choPattern:'마상마상', hanPattern:'마상마상', firstTurn:'cho'
        };
        try {
          await set(stateRef, {
            board: makeInitialSetup(settings.choPattern, settings.hanPattern),
            turn: settings.firstTurn || 'cho',
            plyCount: 0,
            ended: false,
            winner: null
          });
          await remove(readyAllRef);
          setMsg('게임이 시작되었습니다.');
        } catch (e) {
          console.error('start game error', e);
          alert('게임 시작에 실패했습니다.');
        }
      }
    });

    // --------- 필요 함수 (프로젝트에 이미 있다면 중복 정의 불필요) ---------
    function makeInitialSetup(choPattern, hanPattern){
      // TODO: 실제 초기 배치 생성 로직으로 교체
      return { /* 보드 상태 */ };
    }
  </script>
</body>
</html>
