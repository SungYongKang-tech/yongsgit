<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>다빈치 코드 - 게임화면</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    .player-area {
      margin-bottom: 30px;
    }
    .tile-row {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .tile {
      width: 50px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      border: 2px solid #555;
      border-radius: 6px;
      position: relative;
      cursor: pointer;
    }
    .white-tile { background-color: #fff; color: #000; }
    .black-tile { background-color: #000; color: #fff; }
    .hidden::after {
      content: "❓";
      position: absolute;
      font-size: 28px;
      color: red;
    }
    #winner {
      font-size: 24px;
      margin-top: 20px;
      color: green;
    }
    #turnInfo {
      font-size: 18px;
      color: #333;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1 id="mainTitle">다빈치 코드 게임</h1>
  <div id="turnInfo"></div>
  <div id="gameBoard"></div>
  <div id="winner"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase, ref, get, update, onValue, remove
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.firebasestorage.app",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:4f9332f868707efa91a561"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const url = new URL(location.href);
    const roomCode = url.searchParams.get("room");
    const playerName = url.searchParams.get("name")?.trim();

    const gameBoard = document.getElementById("gameBoard");
    const winnerDisplay = document.getElementById("winner");
    const turnInfo = document.getElementById("turnInfo");

    function nextTurn(players, currentTurn) {
      const names = Object.keys(players);
      const index = names.indexOf(currentTurn);
      return names[(index + 1) % names.length];
    }

    async function cleanupOldRoomsExcept(currentRoomCode) {
      const snapshot = await get(ref(db, "rooms"));
      if (!snapshot.exists()) return;

      const now = Date.now();
      const rooms = Object.entries(snapshot.val())
        .filter(([code, room]) => room.createdAt)
        .sort((a, b) => a[1].createdAt - b[1].createdAt);

      const MAX_ROOMS = 5;
      const excess = rooms.length - MAX_ROOMS;
      let skipped = 0;

      for (let i = 0; i < rooms.length && skipped < excess; i++) {
        const [code, room] = rooms[i];
        if (code === currentRoomCode) continue;
        if (now - room.createdAt < 2000) continue;
        await remove(ref(db, `rooms/${code}`));
        skipped++;
      }
    }

    async function renderGame() {
  gameBoard.innerHTML = "";
  winnerDisplay.textContent = "";

  const roomSnap = await get(ref(db, `rooms/${roomCode}`));
  const room = roomSnap.val();

  if (!room || !room.players) {
    turnInfo.textContent = "";
    gameBoard.innerHTML = "<h2>❗ 방이 존재하지 않거나 만료되었습니다.</h2>";
    return;
  }

  const players = room.players;
  const currentTurn = room.turn;

  turnInfo.textContent = currentTurn === playerName
    ? "🟢 내 차례입니다"
    : `⏳ ${currentTurn}님의 차례입니다`;

  let totalHiddenTiles = 0;
  let totalTiles = 0;

  const rendered = new Set();

for (const [name, data] of Object.entries(players)) {
  if (rendered.has(name)) continue; // 중복 방지
  rendered.add(name);

    const area = document.createElement("div");
    area.className = "player-area";

    const label = document.createElement("h2");
    label.textContent = isMine ? "내 타일" : `${name}의 타일`;
    area.appendChild(label);

    const row = document.createElement("div");
    row.className = "tile-row";

    (data.tiles || []).forEach((tile, i) => {
      totalTiles++;
      const div = document.createElement("div");
      div.className = `tile ${tile.color}-tile`;

      const isRevealed = tile.revealed;
      if (isMine || isRevealed) {
        div.textContent = tile.value;
      } else {
        totalHiddenTiles++;
        div.classList.add("hidden");

        if (currentTurn === playerName) {
          div.addEventListener("click", async () => {
            const guess = prompt(`${name}의 ${i + 1}번째 타일 숫자를 추리하세요`);
            if (guess === null) return;

            if (guess == tile.value) {
              alert("정답입니다!");
              tile.revealed = true;
              await update(ref(db, `rooms/${roomCode}/players/${name}/tiles/${i}`), tile);
              renderGame();
            } else {
              alert("틀렸습니다! 턴이 넘어갑니다");
              const next = nextTurn(players, currentTurn);
              await update(ref(db, `rooms/${roomCode}`), { turn: next });
            }
          });
        }
      }

      row.appendChild(div);
    });

    area.appendChild(row);
    gameBoard.appendChild(area);
  }

  if (totalTiles > 0 && totalHiddenTiles === 0) {
    winnerDisplay.textContent = `🎉 ${playerName}님이 승리하셨습니다!`;
  }
}


    document.getElementById("mainTitle").textContent =
      sessionStorage.getItem("roomTitle") || "다빈치 코드 게임";

    onValue(ref(db, `rooms/${roomCode}/turn`), () => renderGame());
    renderGame();
  </script>
</body>
</html>
