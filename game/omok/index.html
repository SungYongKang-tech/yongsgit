<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì˜¤ëª© ëŒ€ì „</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      background: #f5f5f5;
      margin: 0;

       color-scheme: light only; /* âœ… ì´ ì¤„ì„ ì¶”ê°€í•˜ì„¸ìš” */
    }
    #board {
      display: grid;
      grid-template-columns: repeat(15, 1fr);
      border: 2px solid #555;
      margin: 1rem auto;
      width: 95vmin;
      height: 95vmin;
      background-color: #d9a75f;
    }
    .cell {
      border: 1px solid #555;
      position: relative;
      background-color: transparent;
    }
    .stone {
      width: 70%;
      height: 70%;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .stone.black { background: black !important; }
    .stone.white { background: white; border: 1px solid #333; }
    .stone.blink {
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 100% { box-shadow: 0 0 5px 5px rgba(255, 0, 0, 0.6); }
      50% { box-shadow: 0 0 5px 5px rgba(255, 255, 255, 0); }
    }
    #players, #turn, #room-info {
      font-weight: bold;
      margin: 0.5rem;
    }
    button {
  width: 90%;
  max-width: 240px;
  padding: 14px;
  font-size: 18px;
  margin: 1rem auto;
  display: block;
  border: none;
  border-radius: 6px;
  background-color: #333;
  color: white;
}
button:hover {
  background-color: #555;
}
.last-move-me {
  outline: 2px solid rgba(0, 123, 255, 0.9); /* íŒŒë€ìƒ‰ */
  outline-offset: 0px;
  z-index: 10;
}

.last-move-opponent {
  outline: 2px solid rgba(255, 0, 0, 0.8); /* ë¹¨ê°„ìƒ‰ */
  outline-offset: 0px;
  z-index: 10;
}
/* âœ… 2. ëª¨ë‹¬ì°½ CSS (ê¸°ì¡´ style íƒœê·¸ ë‚´ë¶€ì— ì¶”ê°€) */
.modal {
  display: block; /* í˜ì´ì§€ ë¡œë“œì‹œ ìë™ í‘œì‹œ */
  position: fixed;
  z-index: 1000;
  padding-top: 120px;
  left: 0; top: 0;
  width: 100%; height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.5);
}

.modal-content {
  background-color: #fff;
  margin: auto;
  padding: 30px;
  border: 1px solid #888;
  width: 90%;
  max-width: 400px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 0 20px rgba(0,0,0,0.2);
}

.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}
.close:hover {
  color: black;
}
#control-area {
  margin-top: 10px;
}
#game-buttons {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 20px auto;
  width: 95vmin;
  max-width: 600px;
  gap: 8px;
}
}

#game-buttons button {
  flex: 0 0 auto;
  width: 44%;
  font-size: 16px;
  padding: 14px;
  border-radius: 8px;
  border: none;
  color: white;
}

#end-button {
  background-color: #d32f2f;
}

#end-button:hover {
  background-color: #a72828;
}

#confirm-move {
  background-color: #007bff;
  color: white;
}

#confirm-move:disabled {
  background-color: #999;
  cursor: not-allowed;
}

.stone.gray {
  background: gray;
  opacity: 0.5;
}


  </style>
</head>
<body>
  <h2 id="title">âš« ì˜¤ëª© ëŒ€ì „</h2>
  <div id="setup">
    <button onclick="createRoom()">ë°© ìƒì„±í•˜ê¸°</button>
    <button onclick="joinRoom()">ë°© ì°¸ì—¬í•˜ê¸°</button>
    <p id="room-info"></p>
  </div>
  <div id="game" style="display:none">
  <div id="turn"></div>
  <div id="board"></div>
  <div id="game-buttons">
    <button id="end-button" onclick="endGame()">ê²Œì„ ì¢…ë£Œ</button>
    <button id="confirm-move" disabled>ì°©ìˆ˜</button>
  </div>
</div>
  <audio id="place-sound" src="button-29.mp3" preload="auto"></audio>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    
    let pendingMove = null; // ì„ì‹œ ë‘” ëŒ ìœ„ì¹˜ ì €ì¥

    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.appspot.com",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:8cc90ab5a17c364b91a561"
    };

function randomRoomName() {
  const animals = ['í˜¸ë‘ì´', 'í­ê·„', 'ê³ ì–‘ì´', 'ì‚¬ì', 'ë¶€ì—‰ì´', 'ì¹˜íƒ€'];
  return animals[Math.floor(Math.random() * animals.length)] + Math.floor(Math.random() * 100) + 'ë°©';
}
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let roomCode = '', playerRole = '', playerName = '';

    function randomName() {
      const names = ['í˜¸ë‘ì´','í­ê·„','ê³ ì–‘ì´','ì‚¬ì','ë¶€ì—‰ì´','ì¹˜íƒ€'];
      return names[Math.floor(Math.random() * names.length)] + Math.floor(Math.random() * 100);
    }

  async function createRoom() {
  const latestRef = ref(db, 'latestRoom');
  const latestSnap = await get(latestRef);
  const now = Date.now();

  if (latestSnap.exists() && now - latestSnap.val().createdAt < 60000) {
    alert("3ë¶„ ë‚´ ìƒì„±ëœ ë°©ì´ ìˆì–´ìš”");
    return;
  }

  roomCode = randomRoomName();  // âœ… ëœë¤ ë°© ì œëª© í•¨ìˆ˜ë¡œ ëŒ€ì²´!
  playerName = randomName();

await set(ref(db, 'rooms/' + roomCode), {
  players: { A: { name: playerName } },
  turn: 'A',
  board: Array.from({ length: 15 }, () => Array(15).fill("")),
  winner: null,
  createdAt: now
});

// âœ… ìµœê·¼ 10ê°œë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ ì‚­ì œ
const roomsRef = ref(db, 'rooms');
const snapshot = await get(roomsRef);
if (snapshot.exists()) {
  const allRooms = snapshot.val();
  const roomsArray = Object.entries(allRooms)
    .map(([key, value]) => ({ key, createdAt: value.createdAt || 0 }))
    .sort((a, b) => b.createdAt - a.createdAt);

  const roomsToDelete = roomsArray.slice(10);
  for (const room of roomsToDelete) {
    await remove(ref(db, `rooms/${room.key}`));
  }
}


  await set(latestRef, {
    roomCode,
    createdAt: now
  });

  playerRole = 'A';
  startGame();
}



    async function joinRoom() {
  const latestSnap = await get(ref(db, 'latestRoom'));
  if (!latestSnap.exists()) {
    alert("ì°¸ì—¬ ê°€ëŠ¥í•œ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const { roomCode: code, createdAt } = latestSnap.val();
  const now = Date.now();
  if (now - createdAt > 60000) {
    alert("ì°¸ì—¬ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.");
    return;
  }

  const roomSnap = await get(ref(db, `rooms/${code}`));
  if (!roomSnap.exists()) {
    alert("ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  if (roomSnap.val().players.B) {
    alert("ì´ë¯¸ ë‘ ëª…ì´ ì°¸ì—¬ ì¤‘ì…ë‹ˆë‹¤.");
    return;
  }

  playerName = randomName();
  await set(ref(db, `rooms/${code}/players/B`), { name: playerName });
  roomCode = code;
  playerRole = 'B';
  startGame();
}


   async function startGame() {
  document.getElementById("setup").style.display = "none";
  document.getElementById("game").style.display = "block";
  document.getElementById("title").innerText = `âš« ì˜¤ëª© ëŒ€ì „ - ë°©ë²ˆí˜¸: ${roomCode}`;
  

  // âœ… ì´ì „ winner ê¸°ë¡ ì‚­ì œ (ìƒˆ ê²Œì„ ì‹œì‘ ì‹œ)
  // startGame() ë‚´ë¶€ì—ì„œ winner í•„ë“œ ì‚­ì œë¡œ ë³€ê²½
await remove(ref(db, `rooms/${roomCode}/winner`));  // <-- ì´ê±¸ë¡œ êµì²´


 
  renderBoard();
  listenBoard();
  listenWinner();
}

    function renderBoard() {
      const boardDiv = document.getElementById("board");
      boardDiv.innerHTML = "";
      for (let r = 0; r < 15; r++) {
        for (let c = 0; c < 15; c++) {
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.dataset.row = r;
          cell.dataset.col = c;
          cell.addEventListener("click", () => handleMove(r, c));
          boardDiv.appendChild(cell);
        }
      }
    }

function handleMove(r, c) {
  if (pendingMove) {
    const prevIdx = pendingMove.row * 15 + pendingMove.col;
    const prevCell = document.getElementById("board").children[prevIdx];
    prevCell.innerHTML = ""; // ì´ì „ ì„ì‹œ ì œê±°
  }

  pendingMove = { row: r, col: c };

  const idx = r * 15 + c;
  const cell = document.getElementById("board").children[idx];
  cell.innerHTML = "";

  const div = document.createElement("div");
  div.className = "stone gray"; // âœ… íšŒìƒ‰ ëŒ
  cell.appendChild(div);

  document.getElementById("confirm-move").disabled = false;
}


document.getElementById("confirm-move").addEventListener("click", async () => {
  if (!pendingMove) return;

  const { row, col } = pendingMove;
  const turn = (await get(ref(db, `rooms/${roomCode}/turn`))).val();
  if (turn !== playerRole) return alert("ìƒëŒ€ ì°¨ë¡€ì…ë‹ˆë‹¤");

  const boardSnap = await get(ref(db, `rooms/${roomCode}/board`));
  const board = boardSnap.val();

  if (board[row][col] !== "") return alert("ì´ë¯¸ ì°©ìˆ˜ëœ ìë¦¬ì…ë‹ˆë‹¤.");

  const stone = playerRole === 'A' ? 'â—' : 'â—‹';
  board[row][col] = stone;
  const winPos = checkWin(row, col, stone, board);

  await set(ref(db, `rooms/${roomCode}/board/${row}/${col}`), stone);

  // ğŸ”Š ëŒ ë†“ëŠ” ì†Œë¦¬
  document.getElementById("place-sound").play().catch(e => console.warn("ì‚¬ìš´ë“œ ì˜¤ë¥˜:", e));

  if (winPos) {
    await set(ref(db, `rooms/${roomCode}/winner`), { name: playerName, positions: winPos });
  } else {
    await set(ref(db, `rooms/${roomCode}/turn`), playerRole === 'A' ? 'B' : 'A');
  }

  await set(ref(db, `rooms/${roomCode}/lastMove`), { row, col, role: playerRole });

  pendingMove = null;
  document.getElementById("confirm-move").disabled = true;
});


  function checkWin(r, c, stone, board) {
  const directions = [[0,1],[1,0],[1,1],[1,-1]];
  for (const [dr, dc] of directions) {
    let count = 1, pos = [[r, c]];
    let blockedStart = false, blockedEnd = false;

    // ë°˜ëŒ€ ë°©í–¥
    for (let i = 1; i < 5; i++) {
      const nr = r - dr * i, nc = c - dc * i;
      if (nr < 0 || nr >= 15 || nc < 0 || nc >= 15) {
        blockedStart = true;
        break;
      }
      if (board[nr][nc] === stone) {
        count++;
        pos.unshift([nr, nc]);
      } else if (board[nr][nc] !== "") {
        blockedStart = true;
        break;
      } else break;
    }

    // ì •ë°©í–¥
    for (let i = 1; i < 5; i++) {
      const nr = r + dr * i, nc = c + dc * i;
      if (nr < 0 || nr >= 15 || nc < 0 || nc >= 15) {
        blockedEnd = true;
        break;
      }
      if (board[nr][nc] === stone) {
        count++;
        pos.push([nr, nc]);
      } else if (board[nr][nc] !== "") {
        blockedEnd = true;
        break;
      } else break;
    }

    if (count >= 5) return pos;

    // 4ê°œì§€ë§Œ ì–‘ìª½ì´ ëª¨ë‘ ì—´ë¦° ê²½ìš°ë§Œ ìŠ¹ë¦¬ ì¸ì •
    if (count === 4 && !blockedStart && !blockedEnd) return pos;
  }
  return null;
}

function listenBoard() {
  onValue(ref(db, `rooms/${roomCode}/board`), snap => {
    if (!snap.exists()) return;
    const data = snap.val();

    for (let r = 0; r < 15; r++) {
      for (let c = 0; c < 15; c++) {
        const idx = r * 15 + c;
        const cell = document.getElementById("board").children[idx];
        const value = data[r]?.[c] || "";

        const prevStone = cell.querySelector('.stone');
        const isNewStone = !prevStone && (value === "â—" || value === "â—‹");

        // ê¸°ì¡´ ëŒê³¼ ë™ì¼í•˜ë©´ ë‹¤ì‹œ ê·¸ë¦¬ì§€ ì•ŠìŒ
        if (
          prevStone &&
          ((value === "â—" && prevStone.classList.contains("black")) ||
           (value === "â—‹" && prevStone.classList.contains("white")))
        ) {
          cell.style.pointerEvents = "none";
          continue;
        }

        // ìƒˆë¡œ ê·¸ë¦¼
        cell.innerHTML = "";

        if (value === "â—" || value === "â—‹") {
          const div = document.createElement("div");
          div.classList.add("stone", value === "â—" ? "black" : "white");
          cell.appendChild(div);
          cell.style.pointerEvents = "none";
        } else {
          cell.style.pointerEvents = "auto";
        }

        // ìƒˆ ëŒì´ ìƒê²¼ê³ , ë‚´ ì°¨ë¡€ê°€ ì•„ë‹ˆë¼ë©´ â†’ ìƒëŒ€ê°€ ë‘” ê²ƒ â†’ ì‚¬ìš´ë“œ ì¬ìƒ
        if (isNewStone) {
          const opponentTurn = playerRole === 'A' ? 'B' : 'A';
          get(ref(db, `rooms/${roomCode}/turn`)).then(snap => {
            if (snap.exists() && snap.val() === playerRole) {
              // í„´ì´ ë‚´ê²Œ ë„˜ì–´ì™”ë‹¤ëŠ” ê±´ ìƒëŒ€ê°€ ë°©ê¸ˆ ë‘ 
              document.getElementById("place-sound").play().catch(() => {});
            }
          });
        }
      }
    }
  });

  // ë§ˆì§€ë§‰ ì°©ìˆ˜ ìœ„ì¹˜ ê°•ì¡°
  onValue(ref(db, `rooms/${roomCode}/lastMove`), snap => {
    const move = snap.val();
    if (!move) return;

    document.querySelectorAll(".last-move-me, .last-move-opponent").forEach(el => {
      el.classList.remove("last-move-me", "last-move-opponent");
    });

    const idx = move.row * 15 + move.col;
    const cell = document.getElementById("board").children[idx];
    const stoneDiv = cell.querySelector('.stone');
    if (stoneDiv) {
      const isMe = move.role === playerRole;
      stoneDiv.classList.add(isMe ? "last-move-me" : "last-move-opponent");
    }
  });

  // í„´ í‘œì‹œ
  onValue(ref(db, `rooms/${roomCode}/turn`), snap => {
    document.getElementById("turn").innerText = snap.val() === playerRole ? "ë‚´ ì°¨ë¡€" : "ìƒëŒ€ ì°¨ë¡€";
  });

  // âœ… ìƒëŒ€ë°© ì…ì¥ ì•Œë¦¼
  const otherPlayer = playerRole === 'A' ? 'B' : 'A';
  onValue(ref(db, `rooms/${roomCode}/players/${otherPlayer}`), snap => {
    if (snap.exists()) {
      alert(`ğŸ® ìƒëŒ€ë°©(${snap.val().name})ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤!`);
    }
  });
}



  function listenWinner() {
  onValue(ref(db, `rooms/${roomCode}/winner`), snap => {
    const data = snap.val();
    if (!data || !data.name || !Array.isArray(data.positions)) return;

    const isWinner = data.name === playerName;
    alert(isWinner ? "ğŸ‰ ë‹¹ì‹ ì´ ì´ê²¼ìŠµë‹ˆë‹¤!" : "ğŸ˜¢ ë‹¹ì‹ ì´ íŒ¨ë°°í•˜ì˜€ìŠµë‹ˆë‹¤.");

    data.positions.forEach(([r, c]) => {
      const idx = r * 15 + c;
      const cell = document.getElementById("board").children[idx];
      const stone = cell.querySelector('.stone');
      if (stone) stone.classList.add("blink");
    });

    setTimeout(() => {
      deleteRoom(roomCode);
      location.reload();
    }, 3000);
  });
}



    async function endGame() {
      await remove(ref(db, `rooms/${roomCode}`));
      await remove(ref(db, `latestRoom`));
      location.reload();
    }

    window.createRoom = createRoom;
    window.joinRoom = joinRoom;
    window.endGame = endGame;

    async function deleteRoom(roomCode) {
  await remove(ref(db, `rooms/${roomCode}`));
  await remove(ref(db, `latestRoom`));
}



  </script>

<!-- âœ… 3. ìë°”ìŠ¤í¬ë¦½íŠ¸ (ê¸°ì¡´ <script type="module"> ë°”ê¹¥ì— ìƒˆë¡œ ì¶”ê°€) -->
<script>
  function closeModal() {
    document.getElementById('howToModal').style.display = 'none';
  }

  window.onload = function () {
    document.getElementById('howToModal').style.display = 'block';
  }

  
</script>


  <!-- âœ… 1. ëª¨ë‹¬ì°½ HTML (</body> ìœ„ì— ì¶”ê°€) -->
<div id="howToModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2>ğŸ•¹ï¸ ì˜¤ëª© ëŒ€ì „ ê²Œì„ ë°©ë²•</h2>
    <ul style="text-align:left; font-size: 16px;">
      <li>1. "ë°© ìƒì„±í•˜ê¸°"ë¥¼ ëˆ„ë¥´ë©´ ëŒ€ê¸°ë°©ì´ ìƒì„±ë©ë‹ˆë‹¤.</li>
      <li>2. ë‹¤ë¥¸ ì‚¬ìš©ìê°€ 1ë¶„ ì´ë‚´ "ë°© ì°¸ì—¬í•˜ê¸°"ë¥¼ ëˆŒëŸ¬ì•¼ ê²Œì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.</li>
      <li>3. í‘(âš«)ê³¼ ë°±(âšª)ì´ ë²ˆê°ˆì•„ ê°€ë©° ë°”ë‘‘íŒ ìœ„ì— ëŒì„ ë‘¡ë‹ˆë‹¤.</li>
      <li>4. ê°€ë¡œ, ì„¸ë¡œ, ëŒ€ê°ì„ ìœ¼ë¡œ ê°™ì€ ìƒ‰ ëŒ 5ê°œë¥¼ ë¨¼ì € ì—°ê²°í•˜ë©´ ìŠ¹ë¦¬í•©ë‹ˆë‹¤.</li>
      <li>5. ë§ˆì§€ë§‰ ë‘” ëŒì€ í…Œë‘ë¦¬ ìƒ‰ìœ¼ë¡œ í‘œì‹œë˜ë©°, ìŠ¹ë¦¬í•œ ëŒì€ ë°˜ì§ì…ë‹ˆë‹¤.</li>
    </ul>
  </div>
</div>

</body>
</html>
