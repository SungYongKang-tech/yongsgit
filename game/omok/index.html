<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>오목 대전</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      background: #f5f5f5;
      padding: 10px;
    }
    #board {
      display: grid;
      grid-template-columns: repeat(15, 1fr);
      border: 2px solid #555;
      margin: 20px auto;
      width: 95vmin;
      height: 95vmin;
      box-shadow: 0 0 5px #aaa;
      background-color: #d9a75f;
    }
    .cell {
      border: 1px solid #555;
      position: relative;
      background-color: transparent;
    }
    .stone {
      width: 70%;
      height: 70%;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .stone.black {
      background-color: black;
    }
    .stone.white {
      background-color: white;
      border: 1px solid #333;
    }
    .stone.blink {
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 100% { box-shadow: 0 0 5px 5px rgba(255, 0, 0, 0.6); }
      50% { box-shadow: 0 0 5px 5px rgba(255, 255, 255, 0); }
    }
    #room-info, #players {
      font-weight: bold;
      margin: 5px;
    }
  </style>
</head>
<body>
  <h2 id="title">⚫ 오목 대전</h2>
  <div id="setup">
    <button onclick="createRoom()">방 생성하기</button>
    <button onclick="joinRoom()">방 참여하기</button>
    <p id="room-info"></p>
  </div>
  <div id="game" style="display:none">
    <div id="players">내 이름: <span id="myName"></span> / 상대: <span id="opponentName"></span></div>
    <div id="turn"></div>
    <div id="board"></div>
    <button onclick="endGame()">게임 종료</button>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.appspot.com",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:8cc90ab5a17c364b91a561"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let roomCode = '', playerRole = '', playerName = '';

    function randomName() {
      const names = ['호랑이','펭귄','고양이','사자','부엉이','치타'];
      return names[Math.floor(Math.random() * names.length)] + Math.floor(Math.random() * 100);
    }

    async function createRoom() {
      const latestRef = ref(db, 'latestRoom');
      const latestSnap = await get(latestRef);
      const now = Date.now();

      if (latestSnap.exists() && now - latestSnap.val().createdAt < 180000) {
        alert("3분 내 생성된 방이 있어요"); return;
      }
      const nowDate = new Date();
      const pad = n => n.toString().padStart(2, '0');
      roomCode = `${pad(nowDate.getMonth()+1)}${pad(nowDate.getDate())}${pad(nowDate.getHours())}${pad(nowDate.getMinutes())}`;
      playerName = randomName();

      await set(ref(db, 'rooms/' + roomCode), {
        players: { A: { name: playerName } },
        turn: 'A',
        board: Array.from({ length: 15 }, () => Array(15).fill("")),
        winner: "",
        createdAt: now
      });
      await set(latestRef, { roomCode, createdAt: now });
      playerRole = 'A';
      startGame();
    }

    async function joinRoom() {
      const latestSnap = await get(ref(db, 'latestRoom'));
      if (!latestSnap.exists()) return alert("참여 가능한 방이 없습니다.");
      const { roomCode: code, createdAt } = latestSnap.val();
      const now = Date.now();
      if (now - createdAt > 180000) return alert("참여 시간 초과");
      const roomRef = ref(db, `rooms/${code}`);
      const roomSnap = await get(roomRef);
      if (!roomSnap.exists()) return;
      if (roomSnap.val().players.B) return alert("이미 두 명 참여 중");
      playerName = randomName();
      await set(ref(db, `rooms/${code}/players/B`), { name: playerName });
      roomCode = code;
      playerRole = 'B';
      startGame();
    }

    function startGame() {
      document.getElementById("setup").style.display = "none";
      document.getElementById("game").style.display = "block";
      document.getElementById("title").innerText = `⚫ 오목 대전 - 방번호: ${roomCode}`;
      document.getElementById("myName").innerText = playerName;
      const opponentRef = ref(db, `rooms/${roomCode}/players/${playerRole === 'A' ? 'B' : 'A'}/name`);
      onValue(opponentRef, snap => {
        if (snap.exists()) document.getElementById("opponentName").innerText = snap.val();
      });
      renderBoard();
      listenBoard();
      listenWinner();
    }

    function renderBoard() {
      const boardDiv = document.getElementById("board");
      boardDiv.innerHTML = "";
      for (let r = 0; r < 15; r++) {
        for (let c = 0; c < 15; c++) {
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.dataset.row = r;
          cell.dataset.col = c;
          cell.addEventListener("click", () => handleMove(r, c));
          boardDiv.appendChild(cell);
        }
      }
    }

    async function handleMove(r, c) {
      const turn = (await get(ref(db, `rooms/${roomCode}/turn`))).val();
      if ((playerRole === 'A' && turn !== 'A') || (playerRole === 'B' && turn !== 'B')) return alert("상대 차례입니다");
      const cell = await get(ref(db, `rooms/${roomCode}/board/${r}/${c}`));
      if (cell.exists() && cell.val() !== "") return;
      const stone = playerRole === 'A' ? '●' : '○';
      const boardSnap = await get(ref(db, `rooms/${roomCode}/board`));
      const board = boardSnap.val();
      board[r][c] = stone;
      const winPos = checkWin(r, c, stone, board);
      await set(ref(db, `rooms/${roomCode}/board/${r}/${c}`), stone);
      if (winPos) {
        await set(ref(db, `rooms/${roomCode}/winner`), { name: playerName, positions: winPos });
        return;
      }
      await set(ref(db, `rooms/${roomCode}/turn`), playerRole === 'A' ? 'B' : 'A');
    }

    function checkWin(r, c, stone, board) {
      const directions = [[0,1],[1,0],[1,1],[1,-1]];
      for (const [dr,dc] of directions) {
        let count = 1;
        const positions = [[r,c]];
        for (let i=1;i<5;i++) {
          const nr=r-dr*i,nc=c-dc*i;
          if(nr<0||nr>=15||nc<0||nc>=15||board[nr][nc]!==stone) break;
          count++; positions.unshift([nr,nc]);
        }
        for (let i=1;i<5;i++) {
          const nr=r+dr*i,nc=c+dc*i;
          if(nr<0||nr>=15||nc<0||nc>=15||board[nr][nc]!==stone) break;
          count++; positions.push([nr,nc]);
        }
        if(count>=5) return positions;
      }
      return null;
    }

    function listenBoard() {
      onValue(ref(db, `rooms/${roomCode}/board`), snap => {
        if (!snap.exists()) return;
        const data = snap.val();
        for (let r = 0; r < 15; r++) {
          for (let c = 0; c < 15; c++) {
            const idx = r * 15 + c;
            const cell = document.getElementById("board").children[idx];
            const value = data[r]?.[c] || "";
            cell.innerHTML = "";
            if (value === "●" || value === "○") {
              const div = document.createElement("div");
              div.classList.add("stone", value === "●" ? "black" : "white");
              cell.appendChild(div);
              cell.style.pointerEvents = "none";
            } else cell.style.pointerEvents = "auto";
          }
        }
      });
      onValue(ref(db, `rooms/${roomCode}/turn`), snap => {
        document.getElementById("turn").innerText = snap.val() === playerRole ? "내 차례" : "상대 차례";
      });
    }

    function listenWinner() {
      onValue(ref(db, `rooms/${roomCode}/winner`), snap => {
        if (!snap.exists()) return;
        const winner = snap.val();
        alert(`${winner.name}님이 승리했습니다!`);
        winner.positions.forEach(([r, c]) => {
          const idx = r * 15 + c;
          const cell = document.getElementById("board").children[idx];
          const stone = cell.querySelector('.stone');
          if (stone) stone.classList.add("blink");
        });
      });
    }

    async function endGame() {
      if (confirm("게임 종료 및 방 삭제?")) {
        await remove(ref(db, `rooms/${roomCode}`));
        await remove(ref(db, `latestRoom`));
        location.reload();
      }
    }

    window.createRoom = createRoom;
    window.joinRoom = joinRoom;
    window.endGame = endGame;
  </script>
</body>
</html>
