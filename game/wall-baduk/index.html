<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Wall-baduk (벽바둑)</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      text-align: center;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
    }
    h1 { margin: 10px; }
    #controls { margin-bottom: 10px; }
    #turn { font-weight: bold; margin: 10px; }
    #board {
      display: grid;
      background: #fff;
      border: 2px solid #333;
    }
    .cell {
      box-sizing: border-box;
      border: 1px solid #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .point { width: 40px; height: 40px; background-color: white; position: relative; }
    .piece { width: 80%; height: 80%; border-radius: 50%; pointer-events: none; }
    .h-wall { width: 40px; height: 15px; background-color: white; cursor: pointer; }
    .v-wall { width: 15px; height: 40px; background-color: white; cursor: pointer; }
    .blank { width: 15px; height: 15px; background-color: navy; }
    .movable { outline: 3px dashed gray; }
  </style>
</head>
<body>
  <h1>Wall-baduk (벽바둑)</h1>
  <div id="controls">
    <label>난이도:
      <select id="levelSelect">
        <option value="7">초급 (7x7)</option>
        <option value="9">중급 (9x9)</option>
        <option value="11">고급 (11x11)</option>
      </select>
    </label>
    <label>인원:
      <select id="playerCountSelect">
        <option value="2">2명</option>
        <option value="3">3명</option>
        <option value="4">4명</option>
      </select>
    </label>
    <button onclick="startGame()">게임 시작</button>
  </div>
  <div id="turn" style="display:none;">현재 턴: <span id="turnColor"></span></div>
  <div id="board"></div>

  <script>
    const board = document.getElementById("board");
    const turnDisplay = document.getElementById("turn");
    const turnColorText = document.getElementById("turnColor");
    const playerColors = ['#e74c3c', '#3498db', '#2ecc71', '#8e44ad'];
    let playerCount = 2;
    let gridSize = 13;
    let boardMap = [];
    let currentPlayer = 0;
    let selectedPiece = null;
    let placingCount = 0;
    let maxPiecesPerPlayer = 1;

    function startGame() {
      const level = parseInt(document.getElementById("levelSelect").value);
      playerCount = parseInt(document.getElementById("playerCountSelect").value);
      gridSize = level * 2 - 1;

      board.innerHTML = "";
      board.style.gridTemplateColumns = repeat(${gridSize}, auto);
      board.style.gridTemplateRows = repeat(${gridSize}, auto);
      boardMap = Array.from(Array(gridSize), () => Array(gridSize).fill(null));

      turnDisplay.style.display = 'block';
      updateTurnDisplay();
      createBoard();
      setupInitialPieces();
    }

    function updateTurnDisplay() {
      turnColorText.textContent = Player ${currentPlayer + 1};
      turnColorText.style.color = playerColors[currentPlayer];
    }

    function createBoard() {
      for (let r = 0; r < gridSize; r++) {
        for (let c = 0; c < gridSize; c++) {
          const cell = document.createElement("div");
          cell.classList.add("cell");
          if (r % 2 === 0 && c % 2 === 0) {
            cell.classList.add("point");
            cell.addEventListener("click", () => handlePointClick(cell, r, c));
          } else if (r % 2 === 1 && c % 2 === 0) {
            cell.classList.add("h-wall");
          } else if (r % 2 === 0 && c % 2 === 1) {
            cell.classList.add("v-wall");
          } else {
            cell.classList.add("blank");
          }
          board.appendChild(cell);
          boardMap[r][c] = cell;
        }
      }
    }

    function setupInitialPieces() {
      const margin = 2;
      const mid = Math.floor(gridSize / 2);

      if (playerCount === 2) {
        placePiece(margin, margin, 0);
        placePiece(gridSize - 1 - margin, gridSize - 1 - margin, 1);
        placingCount = 0;
        maxPiecesPerPlayer = 2;
        alert("추가로 각 플레이어는 2개의 말을 배치해야 합니다.");
      } else if (playerCount === 3) {
        placingCount = 0;
        maxPiecesPerPlayer = 2;
        alert("3인용: 각 플레이어는 2개의 말을 순서대로 배치하세요.");
      } else if (playerCount === 4) {
        placingCount = 0;
        maxPiecesPerPlayer = 1;
        alert("4인용: 각자 말 1개씩 배치하세요.");
      }
    }

   function handlePointClick(cell, r, c) {
  const piece = cell.querySelector('.piece');

  // 말 배치 중인 경우
  if (!piece && placingCount < playerCount * maxPiecesPerPlayer) {
    const newPiece = document.createElement("div");
    const player = placingCount % playerCount;
    newPiece.classList.add("piece");
    newPiece.style.backgroundColor = playerColors[player];
    newPiece.dataset.player = player;
    cell.appendChild(newPiece);
    placingCount++;
    if (placingCount === playerCount * maxPiecesPerPlayer) {
      alert("모든 말이 배치되었습니다. 게임을 시작합니다.");
    }
    return;
  }

  // 이동 후 클릭 시
  if (selectedPiece && cell.classList.contains("movable")) {
    movePieceTo(cell, r, c);
    clearMovable();
    allowWallPlacing(r, c);
  }

  // ✅ 자기 자리 다시 클릭한 경우 - 이동하지 않아도 벽 설치 허용
  else if (
    selectedPiece &&
    selectedPiece.r === r &&
    selectedPiece.c === c
  ) {
    clearMovable();
    allowWallPlacing(r, c);
    selectedPiece = null; // 다시 선택하지 않도록 해제
  }

  // 말 선택
  else if (!selectedPiece && piece && parseInt(piece.dataset.player) === currentPlayer) {
    selectedPiece = { element: piece, r, c };
    showMovableSpots(r, c);
  }
}


    function placePiece(r, c, playerIdx) {
      const cell = boardMap[r][c];
      const piece = document.createElement("div");
      piece.classList.add("piece");
      piece.style.backgroundColor = playerColors[playerIdx];
      piece.dataset.player = playerIdx;
      cell.appendChild(piece);
    }

   function showMovableSpots(r, c) {
  const dirs = [
       [0, 2], [0, -2], [2, 0], [-2, 0],          // 직선 2칸
  
   ];
    dirs.forEach(([dr, dc]) => {
    const nr = r + dr, nc = c + dc;
    const midR = r + dr / 2, midC = c + dc / 2;
    if (nr >= 0 && nr < gridSize && nc >= 0 && nc < gridSize) {
      const dest = boardMap[nr][nc];
      const wall = boardMap[midR][midC];
      const midPoint = boardMap[midR][midC];

      const isWall = wall &&
        ['h-wall', 'v-wall'].some(cls => wall.classList.contains(cls)) &&
        wall.style.backgroundColor === 'yellow';

      const isMidPiece = midPoint && midPoint.querySelector('.piece');  // 중간에 말이 있는가?
      const isDestPiece = dest && dest.querySelector('.piece');

      if (
        dest.classList.contains("point") &&
        !isDestPiece &&
        !isWall &&
        !isMidPiece // 중간에 말이 없을 때만 이동 가능
      ) {
        dest.classList.add("movable");
      }
    }
  });
}

       
    function clearMovable() {
      document.querySelectorAll(".movable").forEach(el => el.classList.remove("movable"));
    }

    function movePieceTo(cell, r, c) {
      boardMap[selectedPiece.r][selectedPiece.c].removeChild(selectedPiece.element);
      cell.appendChild(selectedPiece.element);
      selectedPiece.r = r;
      selectedPiece.c = c;
    }

    function allowWallPlacing(r, c) {
      const walls = [
        [r - 1, c], [r + 1, c],
        [r, c - 1], [r, c + 1]
      ];
      let wallPlaced = false;

      walls.forEach(([wr, wc]) => {
        const wall = boardMap[wr]?.[wc];
        if (!wall || !['h-wall', 'v-wall'].some(cls => wall.classList.contains(cls))) return;
        wall.addEventListener('click', function handler() {
          if (!wallPlaced) {
            wall.style.backgroundColor = playerColors[currentPlayer];
            wall.removeEventListener('click', handler);
            selectedPiece = null;
            wallPlaced = true;
            nextTurn();
          }
        });
      });
    }

    function nextTurn() {
      currentPlayer = (currentPlayer + 1) % playerCount;
      updateTurnDisplay();
    }
    window.startGame = startGame;

  </script>
</body>
</html>