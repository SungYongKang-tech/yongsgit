<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ïà´Ïûê ÌçºÏ¶ê</title>

  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; margin: 0; padding: 16px; }
    #timer { font-size: 6vw; margin-top: 12px; }
    #board { display: grid; grid-template-columns: repeat(4,1fr); gap: 2vw; width: 92vw; max-width: 480px; margin: 20px auto; }
    .tile { background: #fff; border: 2px solid #999; font-size: 8vw; aspect-ratio: 1/1; display:flex; justify-content:center; align-items:center; cursor:pointer; transition: transform .2s, background-color .3s; }
    .tile:active { transform: scale(.95); }
    .empty { background:#ccc; cursor: default; }
    #status { font-size: 5vw; margin-top: 12px; color: #006400; }
    #rankingList { padding:0; margin-top:16px; font-size:16px; list-style:none; max-height:240px; overflow-y:auto; }
    #rankingList li { padding: 4px 0; }
    #buttons { margin:16px; }
    #buttons button { font-size: 5vw; padding: 8px 16px; margin: 0 8px; }

    html, body { overflow:auto; height:100%; }
    .modal { display:none; position:fixed; z-index:1000; inset:0; background:rgba(0,0,0,.5); overflow:auto; }
    .modal.show { display:block; }
    .modal-content { background:#fff; margin:15% auto; padding:20px; border-radius:10px; width:80%; max-width:400px; box-shadow:0 0 20px rgba(0,0,0,.3); }
    .close { color:#888; float:right; font-size:24px; font-weight:bold; cursor:pointer; }
    .close:hover { color:#000; }
  </style>

  <script type="module">
    /* ===================== Firebase (v9.22.2) ===================== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase, ref, set, get, child, remove, onValue
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    // ‚òÖ ÏùµÎ™Ö Î°úÍ∑∏Ïù∏ Ï∂îÍ∞Ä
    import {
      getAuth, onAuthStateChanged, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.appspot.com",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:905808137b15084d91a561"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // ‚òÖ ÏùµÎ™Ö Î°úÍ∑∏Ïù∏ Î≥¥Ïû•
    const auth = getAuth(app);
    async function ensureAnonAuth() {
      if (auth.currentUser) return auth.currentUser;
      return new Promise((resolve, reject) => {
        const unsub = onAuthStateChanged(auth, (u) => { if (u) { unsub(); resolve(u); } });
        signInAnonymously(auth).catch((e) => { console.error("ÏùµÎ™Ö Î°úÍ∑∏Ïù∏ Ïã§Ìå®:", e); reject(e); });
      });
    }

    // ÏÑúÎ≤Ñ ÏãúÍ∞Ñ Ïò§ÌîÑÏÖã (ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏãúÍ≥Ñ Î≥¥Ï†ï)
    let serverOffset = 0;
    onValue(ref(db, ".info/serverTimeOffset"), (snap) => { serverOffset = snap.val() || 0; });
    const nowMs = () => Date.now() + serverOffset;

    /* ===================== DOM Ï∞∏Ï°∞ ===================== */
    const board      = document.getElementById('board');
    const timerEl    = document.getElementById('timer');
    const statusEl   = document.getElementById('status');
    const pauseBtn   = document.getElementById('pauseBtn');
    const restartBtn = document.getElementById('restartBtn');

    const howToModal = document.getElementById('howToModal');
    const closeBtn   = document.getElementById('modalClose');

    /* ===================== Í≤åÏûÑ ÏÉÅÌÉú ===================== */
    let tiles, startTime, timerInterval, completed = false, paused = false;
    let timerStarted = false;

    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function render() {
      board.innerHTML = '';
      tiles.forEach((val, i) => {
        const tile = document.createElement('div');
        tile.className = 'tile';
        if (val === '') tile.classList.add('empty');
        tile.textContent = val;
        if (!paused) tile.onclick = () => moveTile(i);
        board.appendChild(tile);
      });
    }

    function moveTile(index) {
      if (completed || paused) return;

      if (!timerStarted) {
        startTimer();
        timerStarted = true;
      }

      const emptyIndex = tiles.indexOf('');
      const diff = Math.abs(index - emptyIndex);
      const sameRow = Math.floor(index / 4) === Math.floor(emptyIndex / 4);
      if ((diff === 1 && sameRow) || diff === 4) {
        [tiles[index], tiles[emptyIndex]] = [tiles[emptyIndex], tiles[index]];
        render();
        checkWin();
      }
    }

    function checkWin() {
      const solved = [...Array(15).keys()].map(i => i + 1).concat('');
      if (JSON.stringify(tiles) === JSON.stringify(solved)) {
        completed = true;
        clearInterval(timerInterval);
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        statusEl.textContent = `üéâ ÌçºÏ¶ê ÏôÑÎ£å! ÏãúÍ∞Ñ: ${formatTime(elapsed)}`;
        checkAndSaveRanking(elapsed);
      }
    }

    function startTimer() {
      startTime = Date.now();
      timerInterval = setInterval(() => {
        if (!paused) {
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          timerEl.textContent = `‚è±Ô∏è ${formatTime(elapsed)}`;
        }
      }, 1000);
    }

    // ‚òÖ Ïù¥Î¶ÑÏùÑ keyÎ°ú Ï†ÄÏû•(Í∏∞Ï°¥ Î∞©Ïãù Ïú†ÏßÄ)
   async function saveRanking(name, timeSec) {
  await ensureAnonAuth();
  const key = sanitizeKey(name);
  if (!key) throw new Error("Ïù¥Î¶ÑÏù¥ ÎπÑÏóàÏäµÎãàÎã§.");
  // Í∏∞Ï°¥: Í∞íÎßå Ïà´Ïûê ‚Üí Í∑úÏπôÏóê Îî∞Îùº ÎßâÌûàÎäî Í≤ΩÏö∞Í∞Ä ÏûàÏñ¥ Í∞ùÏ≤¥Î°ú Ï†ÄÏû•(Îçî ÏïàÏ†Ñ)
  const data = {
    time: timeSec,
    name: name.trim(),
    uid: getAuth().currentUser?.uid || null,
    createdAt: Date.now()
  };
  return set(ref(db, 'puzzleRankings/' + key), data);
}

    async function loadTopRankings() {
  await ensureAnonAuth();
  const snap = await get(child(ref(db), 'puzzleRankings'));
  const list = document.getElementById('rankingList');
  list.innerHTML = '';
  if (!snap.exists()) return;

  const raw = snap.val();
  const arr = Object.values(raw)       // {key:{name,time,...}} ‚Üí [{name,time,...}]
    .filter(v => v && typeof v.time === 'number')
    .sort((a,b) => a.time - b.time)
    .slice(0, 10);

  arr.forEach((entry, idx) => {
    const li = document.createElement('li');
    li.textContent = `${idx + 1}Îì± - ${entry.name} (${formatTime(entry.time)})`;
    list.appendChild(li);
  });
}


    async function checkAndSaveRanking(newTime) {
  await ensureAnonAuth();
  const snap = await get(child(ref(db), 'puzzleRankings'));
  const data = snap.val() || {};
  const sorted = Object.values(data)
    .filter(v => v && typeof v.time === 'number')
    .sort((a,b) => a.time - b.time);

  if (sorted.length < 10 || newTime < sorted[9].time) {
    const name = prompt("üéâ 10Îì± ÏïàÏóê Îì§ÏóàÏäµÎãàÎã§! Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:");
    if (name) {
      try {
        await saveRanking(name, newTime);
        await loadTopRankings();
      } catch (e) {
        alert(
          "Ï†ÄÏû• Ïã§Ìå®: " + (e?.message || e) +
          "\n\nÏù¥Î¶ÑÏóê Í∏àÏßÄÎ¨∏Ïûê(. # $ [ ] /)Í∞Ä ÏûàÏóàÎäîÏßÄ,\n" +
          "ÎòêÎäî DB Í∑úÏπô/Í∂åÌïú Î¨∏Ï†úÍ∞Ä ÏïÑÎãåÏßÄ ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî."
        );
        console.warn(e);
      }
    }
  } else {
    alert("Ï¢ãÏùÄ Í∏∞Î°ùÏù¥ÏßÄÎßå 10ÏúÑ ÏïàÏóêÎäî Îì§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.");
    loadTopRankings();
  }
}


    // ÌçºÏ¶êÏù¥ ÌíÄ Ïàò ÏûàÎäî ÏÉÅÌÉúÏù∏ÏßÄ Ï≤¥ÌÅ¨
    function isSolvable(array) {
      const size = 4;
      let inversions = 0;
      for (let i = 0; i < array.length; i++) {
        if (array[i] === '') continue;
        for (let j = i + 1; j < array.length; j++) {
          if (array[j] !== '' && array[i] > array[j]) inversions++;
        }
      }
      const emptyIndex = array.indexOf('');
      const emptyRowFromBottom = size - Math.floor(emptyIndex / size);
      if (size % 2 === 0) {
        return emptyRowFromBottom % 2 === 0 ? inversions % 2 === 1 : inversions % 2 === 0;
      } else {
        return inversions % 2 === 0;
      }
    }

    function restartGame() {
      let temp;
      do {
        temp = shuffle([...Array(15).keys()].map(i => i + 1).concat(''));
      } while (!isSolvable(temp));
      tiles = temp;
      completed = false;
      paused = false;
      timerStarted = false;
      clearInterval(timerInterval);
      render();
      timerEl.textContent = '‚è±Ô∏è 0:00';
      statusEl.textContent = "";
    }

    // ‚òÖ Í∏àÏöîÏùº 12Ïãú(KST Î°úÏª¨ Í∏∞Ï§Ä) Îû≠ÌÇπ Î¶¨ÏÖã
    async function resetRankingIfFridayNoon() {
      try {
        await ensureAnonAuth();
        const now = new Date();
        const isFriday = now.getDay() === 5;
        const hour = now.getHours();
        const today = now.toISOString().slice(0, 10);
        if (isFriday && hour >= 12) {
          const resetKey = "rankingReset_" + today;
          if (!localStorage.getItem(resetKey)) {
            await remove(ref(db, 'puzzleRankings'));
            console.log("‚úÖ Í∏àÏöîÏùº Ïò§ÌõÑ 12Ïãú Ïù¥ÌõÑ Îû≠ÌÇπ Î¶¨ÏÖã ÏôÑÎ£å");
            localStorage.setItem(resetKey, "done");
            await loadTopRankings();
          }
        }
      } catch (err) {
        console.error("Îû≠ÌÇπ Î¶¨ÏÖã Ïã§Ìå®:", err);
      }
    }

    /* ===================== Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî© ===================== */
    pauseBtn.onclick = () => {
      paused = !paused;
      pauseBtn.textContent = paused ? "‚ñ∂Ô∏è Ïû¨Í∞ú" : "‚è∏Ô∏è ÏùºÏãúÏ†ïÏßÄ";
    };

    restartBtn.onclick = () => {
      restartGame();
      pauseBtn.textContent = "‚è∏Ô∏è ÏùºÏãúÏ†ïÏßÄ";
    };

    // Î™®Îã¨ Ï†úÏñ¥
    function openHowTo()  { howToModal.classList.add('show'); }
    function closeModal() { howToModal.classList.remove('show'); }
    window.closeModal = closeModal; // inline onclickÏóêÏÑú Ìò∏Ï∂ú

    // Ï¥àÍ∏∞Ìôî
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        await ensureAnonAuth();             // ‚òÖ ÏãúÏûë Ïãú Î°úÍ∑∏Ïù∏ Î≥¥Ïû•
      } catch {}
      restartGame();
      await loadTopRankings();
      openHowTo();
      await resetRankingIfFridayNoon();
    });

    // Ï£ºÍ∏∞Ï†ÅÏúºÎ°ú Î¶¨ÏÖã Ï≤¥ÌÅ¨(ÏÑ†ÌÉù)
    setInterval(resetRankingIfFridayNoon, 60 * 1000);
  </script>
</head>

<body>
  <h2>Ïà´Ïûê ÌçºÏ¶ê (1~15 Ï†ïÎ†¨)</h2>
  <div id="timer">‚è±Ô∏è 0:00</div>
  <div id="buttons">
    <button id="pauseBtn">‚è∏Ô∏è ÏùºÏãúÏ†ïÏßÄ</button>
    <button id="restartBtn">üîÑ Ïû¨ÏãúÏûë</button>
  </div>

  <div id="board"></div>
  <p id="status"></p>

  <h3>üèÜ ÏÉÅÏúÑ 10ÏúÑ</h3>
  <ol id="rankingList"></ol>

  <!-- ÏïàÎÇ¥ Î™®Îã¨ (ÎßàÌÅ¨ÏóÖ Ï†ïÎ¶¨) -->
  <div id="howToModal" class="modal">
    <div class="modal-content">
      <span id="modalClose" class="close" onclick="closeModal()">&times;</span>
      <h2>üìå Ïà´Ïûê ÌçºÏ¶ê Í≤åÏûÑ Î∞©Î≤ï</h2>
      <ul style="text-align:left; font-size:16px;">
        <li>1. 1Î∂ÄÌÑ∞ 15ÍπåÏßÄ Ïà´ÏûêÎ•º ÏàúÏÑúÎåÄÎ°ú ÎßûÏ∂îÎäî Í≤åÏûÑÏûÖÎãàÎã§.</li>
        <li>2. Îπà Ïπ∏Í≥º Ïù∏Ï†ëÌïú Ïà´ÏûêÎßå Ïù¥ÎèôÌï† Ïàò ÏûàÏäµÎãàÎã§.</li>
        <li>3. ÏõÄÏßÅÏù¥Î©¥ ÏûêÎèôÏúºÎ°ú ÌÉÄÏù¥Î®∏Í∞Ä ÏãúÏûëÎê©ÎãàÎã§.</li>
        <li>4. ÏôÑÏÑ±ÌïòÎ©¥ Í±∏Î¶∞ ÏãúÍ∞ÑÏóê Îî∞Îùº Îû≠ÌÇπÏù¥ Ï†ÄÏû•Îê©ÎãàÎã§.</li>
        <li>5. ÏÉÅÏúÑ 10ÏúÑ ÏïàÏóê Îì§Î©¥ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥ Îû≠ÌÇπ Îì±Î°ù!</li>
        <li>6. Îß§Ï£º Í∏àÏöîÏùº ÎÇÆ 12Ïãú Îû≠ÌÇπ Î¶¨ÏÖãÎê©ÎãàÎã§!</li>
      </ul>
    </div>
  </div>
</body>
</html>
