<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ìˆ«ì í¼ì¦</title>

  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; margin: 0; padding: 16px; }
    #timer { font-size: 6vw; margin-top: 12px; }
    #board { display: grid; grid-template-columns: repeat(4,1fr); gap: 2vw; width: 92vw; max-width: 480px; margin: 20px auto; }
    .tile { background: #fff; border: 2px solid #999; font-size: 8vw; aspect-ratio: 1/1; display:flex; justify-content:center; align-items:center; cursor:pointer; transition: transform .2s, background-color .3s; }
    .tile:active { transform: scale(.95); }
    .empty { background:#ccc; cursor: default; }
    #status { font-size: 5vw; margin-top: 12px; color: #006400; }
    #rankingList { padding:0; margin-top:16px; font-size:16px; list-style:none; max-height:240px; overflow-y:auto; }
    #rankingList li { padding: 4px 0; }
    #buttons { margin:16px; }
    #buttons button { font-size: 5vw; padding: 8px 16px; margin: 0 8px; }

    html, body { overflow:auto; height:100%; }
    .modal { display:none; position:fixed; z-index:1000; inset:0; background:rgba(0,0,0,.5); overflow:auto; }
    .modal.show { display:block; }
    .modal-content { background:#fff; margin:15% auto; padding:20px; border-radius:10px; width:80%; max-width:400px; box-shadow:0 0 20px rgba(0,0,0,.3); }
    .close { color:#888; float:right; font-size:24px; font-weight:bold; cursor:pointer; }
    .close:hover { color:#000; }
  </style>

  <script type="module">
    /* ===================== Firebase (v9.22.2) ===================== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase, ref, set, get, child, remove, onValue
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    // â˜… ìµëª… ë¡œê·¸ì¸ ì¶”ê°€
    import {
      getAuth, onAuthStateChanged, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.appspot.com",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:905808137b15084d91a561"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // â˜… ìµëª… ë¡œê·¸ì¸ ë³´ì¥
    const auth = getAuth(app);
    async function ensureAnonAuth() {
      if (auth.currentUser) return auth.currentUser;
      return new Promise((resolve, reject) => {
        const unsub = onAuthStateChanged(auth, (u) => { if (u) { unsub(); resolve(u); } });
        signInAnonymously(auth).catch((e) => { console.error("ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨:", e); reject(e); });
      });
    }

    // ì„œë²„ ì‹œê°„ ì˜¤í”„ì…‹ (í´ë¼ì´ì–¸íŠ¸ ì‹œê³„ ë³´ì •)
    let serverOffset = 0;
    onValue(ref(db, ".info/serverTimeOffset"), (snap) => { serverOffset = snap.val() || 0; });
    const nowMs = () => Date.now() + serverOffset;

    /* ===================== DOM ì°¸ì¡° ===================== */
    const board      = document.getElementById('board');
    const timerEl    = document.getElementById('timer');
    const statusEl   = document.getElementById('status');
    const pauseBtn   = document.getElementById('pauseBtn');
    const restartBtn = document.getElementById('restartBtn');

    const howToModal = document.getElementById('howToModal');
    const closeBtn   = document.getElementById('modalClose');

    /* ===================== ê²Œì„ ìƒíƒœ ===================== */
    let tiles, startTime, timerInterval, completed = false, paused = false;
    let timerStarted = false;

    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function render() {
      board.innerHTML = '';
      tiles.forEach((val, i) => {
        const tile = document.createElement('div');
        tile.className = 'tile';
        if (val === '') tile.classList.add('empty');
        tile.textContent = val;
        if (!paused) tile.onclick = () => moveTile(i);
        board.appendChild(tile);
      });
    }

    function moveTile(index) {
      if (completed || paused) return;

      if (!timerStarted) {
        startTimer();
        timerStarted = true;
      }

      const emptyIndex = tiles.indexOf('');
      const diff = Math.abs(index - emptyIndex);
      const sameRow = Math.floor(index / 4) === Math.floor(emptyIndex / 4);
      if ((diff === 1 && sameRow) || diff === 4) {
        [tiles[index], tiles[emptyIndex]] = [tiles[emptyIndex], tiles[index]];
        render();
        checkWin();
      }
    }

    function checkWin() {
      const solved = [...Array(15).keys()].map(i => i + 1).concat('');
      if (JSON.stringify(tiles) === JSON.stringify(solved)) {
        completed = true;
        clearInterval(timerInterval);
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        statusEl.textContent = `ğŸ‰ í¼ì¦ ì™„ë£Œ! ì‹œê°„: ${formatTime(elapsed)}`;
        checkAndSaveRanking(elapsed);
      }
    }

    function startTimer() {
      startTime = Date.now();
      timerInterval = setInterval(() => {
        if (!paused) {
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          timerEl.textContent = `â±ï¸ ${formatTime(elapsed)}`;
        }
      }, 1000);
    }

    // â˜… ì´ë¦„ì„ keyë¡œ ì €ì¥(ê¸°ì¡´ ë°©ì‹ ìœ ì§€)
   async function saveRanking(name, timeSec) {
  await ensureAnonAuth();
  const key = sanitizeKey(name);
  if (!key) throw new Error("ì´ë¦„ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤.");
  // ê¸°ì¡´: ê°’ë§Œ ìˆ«ì â†’ ê·œì¹™ì— ë”°ë¼ ë§‰íˆëŠ” ê²½ìš°ê°€ ìˆì–´ ê°ì²´ë¡œ ì €ì¥(ë” ì•ˆì „)
  const data = {
    time: timeSec,
    name: name.trim(),
    uid: getAuth().currentUser?.uid || null,
    createdAt: Date.now()
  };
  return set(ref(db, 'puzzleRankings/' + key), data);
}

    async function loadTopRankings() {
  await ensureAnonAuth();
  const snap = await get(child(ref(db), 'puzzleRankings'));
  const list = document.getElementById('rankingList');
  list.innerHTML = '';
  if (!snap.exists()) return;

  const raw = snap.val();
  const arr = Object.values(raw)       // {key:{name,time,...}} â†’ [{name,time,...}]
    .filter(v => v && typeof v.time === 'number')
    .sort((a,b) => a.time - b.time)
    .slice(0, 10);

  arr.forEach((entry, idx) => {
    const li = document.createElement('li');
    li.textContent = `${idx + 1}ë“± - ${entry.name} (${formatTime(entry.time)})`;
    list.appendChild(li);
  });
}


    async function checkAndSaveRanking(newTime) {
  await ensureAnonAuth();
  const snap = await get(child(ref(db), 'puzzleRankings'));
  const data = snap.val() || {};
  const sorted = Object.values(data)
    .filter(v => v && typeof v.time === 'number')
    .sort((a,b) => a.time - b.time);

  if (sorted.length < 10 || newTime < sorted[9].time) {
    const name = prompt("ğŸ‰ 10ë“± ì•ˆì— ë“¤ì—ˆìŠµë‹ˆë‹¤! ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
    if (name) {
      try {
        await saveRanking(name, newTime);
        await loadTopRankings();
      } catch (e) {
        alert(
          "ì €ì¥ ì‹¤íŒ¨: " + (e?.message || e) +
          "\n\nì´ë¦„ì— ê¸ˆì§€ë¬¸ì(. # $ [ ] /)ê°€ ìˆì—ˆëŠ”ì§€,\n" +
          "ë˜ëŠ” DB ê·œì¹™/ê¶Œí•œ ë¬¸ì œê°€ ì•„ë‹Œì§€ í™•ì¸í•´ ì£¼ì„¸ìš”."
        );
        console.warn(e);
      }
    }
  } else {
    alert("ì¢‹ì€ ê¸°ë¡ì´ì§€ë§Œ 10ìœ„ ì•ˆì—ëŠ” ë“¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    loadTopRankings();
  }
}


    // í¼ì¦ì´ í’€ ìˆ˜ ìˆëŠ” ìƒíƒœì¸ì§€ ì²´í¬
    function isSolvable(array) {
      const size = 4;
      let inversions = 0;
      for (let i = 0; i < array.length; i++) {
        if (array[i] === '') continue;
        for (let j = i + 1; j < array.length; j++) {
          if (array[j] !== '' && array[i] > array[j]) inversions++;
        }
      }
      const emptyIndex = array.indexOf('');
      const emptyRowFromBottom = size - Math.floor(emptyIndex / size);
      if (size % 2 === 0) {
        return emptyRowFromBottom % 2 === 0 ? inversions % 2 === 1 : inversions % 2 === 0;
      } else {
        return inversions % 2 === 0;
      }
    }

    function restartGame() {
      let temp;
      do {
        temp = shuffle([...Array(15).keys()].map(i => i + 1).concat(''));
      } while (!isSolvable(temp));
      tiles = temp;
      completed = false;
      paused = false;
      timerStarted = false;
      clearInterval(timerInterval);
      render();
      timerEl.textContent = 'â±ï¸ 0:00';
      statusEl.textContent = "";
    }

    // â˜… ê¸ˆìš”ì¼ 12ì‹œ(KST ë¡œì»¬ ê¸°ì¤€) ë­í‚¹ ë¦¬ì…‹
    async function resetRankingIfFridayNoon() {
      try {
        await ensureAnonAuth();
        const now = new Date();
        const isFriday = now.getDay() === 5;
        const hour = now.getHours();
        const today = now.toISOString().slice(0, 10);
        if (isFriday && hour >= 12) {
          const resetKey = "rankingReset_" + today;
          if (!localStorage.getItem(resetKey)) {
            await remove(ref(db, 'puzzleRankings'));
            console.log("âœ… ê¸ˆìš”ì¼ ì˜¤í›„ 12ì‹œ ì´í›„ ë­í‚¹ ë¦¬ì…‹ ì™„ë£Œ");
            localStorage.setItem(resetKey, "done");
            await loadTopRankings();
          }
        }
      } catch (err) {
        console.error("ë­í‚¹ ë¦¬ì…‹ ì‹¤íŒ¨:", err);
      }
    }

    /* ===================== ì´ë²¤íŠ¸ ë°”ì¸ë”© ===================== */
    pauseBtn.onclick = () => {
      paused = !paused;
      pauseBtn.textContent = paused ? "â–¶ï¸ ì¬ê°œ" : "â¸ï¸ ì¼ì‹œì •ì§€";
    };

    restartBtn.onclick = () => {
      restartGame();
      pauseBtn.textContent = "â¸ï¸ ì¼ì‹œì •ì§€";
    };

    // ëª¨ë‹¬ ì œì–´
    function openHowTo()  { howToModal.classList.add('show'); }
    function closeModal() { howToModal.classList.remove('show'); }
    window.closeModal = closeModal; // inline onclickì—ì„œ í˜¸ì¶œ

    // ì´ˆê¸°í™”
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        await ensureAnonAuth();             // â˜… ì‹œì‘ ì‹œ ë¡œê·¸ì¸ ë³´ì¥
      } catch {}
      restartGame();
      await loadTopRankings();
      openHowTo();
      await resetRankingIfFridayNoon();
    });

    // ì£¼ê¸°ì ìœ¼ë¡œ ë¦¬ì…‹ ì²´í¬(ì„ íƒ)
    setInterval(resetRankingIfFridayNoon, 60 * 1000);
  </script>
</head>

<body>
  <h2>ìˆ«ì í¼ì¦ (1~15 ì •ë ¬)</h2>
  <div id="timer">â±ï¸ 0:00</div>
  <div id="buttons">
    <button id="pauseBtn">â¸ï¸ ì¼ì‹œì •ì§€</button>
    <button id="restartBtn">ğŸ”„ ì¬ì‹œì‘</button>
  </div>

  <div id="board"></div>
  <p id="status"></p>

  <h3>ğŸ† ìƒìœ„ 10ìœ„</h3>
  <ol id="rankingList"></ol>

  <!-- ì•ˆë‚´ ëª¨ë‹¬ (ë§ˆí¬ì—… ì •ë¦¬) -->
  <div id="howToModal" class="modal">
    <div class="modal-content">
      <span id="modalClose" class="close" onclick="closeModal()">&times;</span>
      <h2>ğŸ“Œ ìˆ«ì í¼ì¦ ê²Œì„ ë°©ë²•</h2>
      <ul style="text-align:left; font-size:16px;">
        <li>1. 1ë¶€í„° 15ê¹Œì§€ ìˆ«ìë¥¼ ìˆœì„œëŒ€ë¡œ ë§ì¶”ëŠ” ê²Œì„ì…ë‹ˆë‹¤.</li>
        <li>2. ë¹ˆ ì¹¸ê³¼ ì¸ì ‘í•œ ìˆ«ìë§Œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        <li>3. ì›€ì§ì´ë©´ ìë™ìœ¼ë¡œ íƒ€ì´ë¨¸ê°€ ì‹œì‘ë©ë‹ˆë‹¤.</li>
        <li>4. ì™„ì„±í•˜ë©´ ê±¸ë¦° ì‹œê°„ì— ë”°ë¼ ë­í‚¹ì´ ì €ì¥ë©ë‹ˆë‹¤.</li>
        <li>5. ìƒìœ„ 10ìœ„ ì•ˆì— ë“¤ë©´ ì´ë¦„ì„ ì…ë ¥í•´ ë­í‚¹ ë“±ë¡!</li>
        <li>6. ë§¤ì£¼ ê¸ˆìš”ì¼ ë‚® 12ì‹œ ë­í‚¹ ë¦¬ì…‹ë©ë‹ˆë‹¤!</li>
      </ul>
    </div>
  </div>
</body>
</html>
