<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>No Way Out - 게임</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      background: #f0f0f0;
      margin: 0;
    }
    h1 {
      font-size: 6vw;
      margin: 20px 0;
    }
    svg {
      width: 90vmin;
      height: 90vmin;
      margin: 0 auto;
      display: block;
    }
    .circle {
      cursor: pointer;
    }
    .selected {
      stroke: green;
      stroke-width: 4px;
    }
    #turnDisplay {
      font-size: 1.5rem;
      margin: 10px;
    }
    #winnerDisplay {
      font-size: 1.8rem;
      margin: 10px;
      color: #c62828;
    }
    button {
      margin-top: 12px;
      padding: 10px 18px;
      font-size: 1rem;
      background-color: #1976d2;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background-color: #1565c0;
    }
  </style>
</head>
<body>
  <h1>No Way Out</h1>
  <div id="turnDisplay">차례: ⚫</div>
  <div id="winnerDisplay"></div>
  <div id="boardContainer"></div>
  <button onclick="resetGame()">🔄 게임 초기화</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      set,
      get,
      child
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.appspot.com",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:905808137b15084e156c30"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const params = new URLSearchParams(window.location.search);
    const roomCode = params.get("room");

    if (!roomCode) {
      alert("방 코드가 없습니다.");
      window.location.href = "index.html";
    }

    const gameRef = ref(db, `games/no-way-out/${roomCode}`);

    let selected = null;
    const adjacency = {
      0: [1],
      1: [0, 2, 3],
      2: [1],
      3: [1, 5, 6, 4],
      4: [5, 6, 3],
      5: [3, 4, 6, 7],
      6: [4, 5, 3, 7],
      7: [5, 9, 4, 6],
      8: [9],
      9: [7, 8, 10],
      10: [9],
    };

    const boardSvg = `
    <svg viewBox="0 0 200 200">
      <circle cx="100" cy="100" r="70" fill="none" stroke="black" stroke-width="3" />
      <line x1="100" y1="10" x2="100" y2="190" stroke="black" stroke-width="3" />
      <line x1="10" y1="100" x2="190" y2="100" stroke="black" stroke-width="3" />

      <circle class="circle" cx="100" cy="30" r="8" data-index="1" fill="white" stroke="black" stroke-width="2"/>
      <circle class="circle" cx="60" cy="100" r="8" data-index="4" fill="white" stroke="black" stroke-width="2"/>
      <circle class="circle" cx="100" cy="100" r="8" data-index="5" fill="white" stroke="black" stroke-width="2"/>
      <circle class="circle" cx="140" cy="100" r="8" data-index="6" fill="white" stroke="black" stroke-width="2"/>
      <circle class="circle" cx="100" cy="170" r="8" data-index="9" fill="white" stroke="black" stroke-width="2"/>

      <circle class="circle" cx="30" cy="100" r="8" data-index="0" fill="white" stroke="black" stroke-width="2"/>
      <circle class="circle" cx="170" cy="100" r="8" data-index="7" fill="white" stroke="black" stroke-width="2"/>
      <circle class="circle" cx="100" cy="60" r="8" data-index="3" fill="white" stroke="black" stroke-width="2"/>
      <circle class="circle" cx="100" cy="140" r="8" data-index="8" fill="white" stroke="black" stroke-width="2"/>
      <circle class="circle" cx="100" cy="10" r="8" data-index="2" fill="white" stroke="black" stroke-width="2"/>
      <circle class="circle" cx="100" cy="190" r="8" data-index="10" fill="white" stroke="black" stroke-width="2"/>
    </svg>`;

    document.getElementById("boardContainer").innerHTML = boardSvg;

    function render(positions, turn, winner) {
      document.querySelectorAll('.circle').forEach(circle => {
        const index = circle.getAttribute('data-index');
        const piece = positions[index];
        circle.setAttribute('fill', piece === '⚫' ? 'black' : piece === '🔴' ? 'red' : 'white');
        circle.classList.remove('selected');
      });

      if (selected !== null) {
        const selCircle = document.querySelector(`.circle[data-index='${selected}']`);
        if (selCircle) selCircle.classList.add('selected');
      }

      document.getElementById("turnDisplay").textContent = `차례: ${turn}`;
      document.getElementById("winnerDisplay").textContent = winner ? `승자: ${winner}` : "";
    }

    onValue(gameRef, snapshot => {
      const data = snapshot.val();
      if (data) {
        render(data.positions, data.turn, data.winner);
      }
    });

    document.querySelectorAll('.circle').forEach(circle => {
      circle.addEventListener('click', () => {
        const index = parseInt(circle.getAttribute('data-index'));
        get(gameRef).then(snapshot => {
          const data = snapshot.val();
          if (!data || data.winner) return;

          const { positions, turn } = data;

          if (selected === null) {
            if (positions[index] === turn) {
              selected = index;
              render(positions, turn, null);
            }
          } else {
            if (positions[index] === "" && adjacency[selected].includes(index)) {
              positions[index] = turn;
              positions[selected] = "";
              const nextTurn = turn === "⚫" ? "🔴" : "⚫";
              set(gameRef, { positions, turn: nextTurn, winner: null });
              selected = null;
            } else {
              selected = null;
              render(positions, turn, null);
            }
          }
        });
      });
    });

    function resetGame() {
      set(gameRef, {
        positions: ["⚫", "⚫", "⚫", "", "", "", "", "", "🔴", "🔴", "🔴"],
        turn: "⚫",
        winner: ""
      });
      selected = null;
    }
  </script>
</body>
</html>
