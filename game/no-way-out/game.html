<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>No Way Out (Firebase)</title>
  <style>
    html, body {
  margin: 0;
  padding: 0;
  height: 100vh;            /* ë·°í¬íŠ¸ ë†’ì´ë§Œí¼ ê³ ì • */
  overflow: hidden;         /* ìŠ¤í¬ë¡¤ ë§‰ê¸° */
  touch-action: none;       /* ë‹¹ê²¨ì„œ ìƒˆë¡œê³ ì¹¨ ë°©ì§€ (ëª¨ë°”ì¼ ëŒ€ì‘) */
  font-family: sans-serif;
  background: #f0f0f0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: start;
}


    #turn {
      margin-bottom: 1rem;
      font-weight: bold;
      font-size: 1.4rem;
    }

    svg {
  width: 90vw;
  min-width: 480px;
  max-width: 700px;
  height: auto;
  background: white;
  touch-action: manipulation;
}

    line, circle {
      stroke: black;
      stroke-width: 12;
    }

    .point {
      fill: white;
      stroke: black;
      stroke-width: 8;
    }

    .black { fill: black; }
    .red   { fill: red; }

 .highlight {
  stroke: #4caf50 !important;
  stroke-width: 20;
  stroke-opacity: 0.8;
}


    .selected {
      stroke: gold;
      stroke-width: 14;
    }

    #resetBtn {
      margin: 0.5rem 0 1rem;
      padding: 0.6rem 1rem;
      font-size: 1rem;
      border: none;
      background: #2196f3;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }

    #resetBtn:hover {
      background: #1976d2;
    }

.rotated {
  transform: rotate(180deg);
}
.rotated .point {
  transform: rotate(180deg);
}


  </style>
</head>
<body>
  <div id="turn">ê²Œì„ ë¡œë”© ì¤‘...</div>
  <button id="resetBtn">ğŸ”„ ê²Œì„ ì´ˆê¸°í™”</button>

  <svg viewBox="0 0 1600 2240" id="board">
    <line x1="480" y1="160" x2="1120" y2="160" />
    <line x1="480" y1="1440" x2="1120" y2="1440" />
    <line x1="800" y1="160" x2="800" y2="1440" />
    <circle cx="800" cy="800" r="400" fill="none" />
    <line x1="800" y1="480" x2="800" y2="1120" />
    <line x1="440" y1="800" x2="1160" y2="800" />
  </svg>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.appspot.com",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:f8e3fcb77f6ddef091a561"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const gameRef = ref(db, 'games/no-way-out');

    const svg = document.getElementById("board");
    const turnInfo = document.getElementById("turn");
    const resetBtn = document.getElementById("resetBtn");

 const positions = [
  { x: 480, y: 160 },    // 0
  { x: 800, y: 160 },    // 1
  { x: 1120, y: 160 },   // 2
  { x: 800, y: 400 },    // 3 - ìœ„
  { x: 400, y: 800 },    // 4 - ì™¼ìª½ (ì› ìœ„)
  { x: 800, y: 800 },    // 5 - ì¤‘ì‹¬
  { x: 1200, y: 800 },   // 6 - ì˜¤ë¥¸ìª½ (ì› ìœ„)
  { x: 800, y: 1200 },   // 7 - ì•„ë˜
  { x: 480, y: 1440 },   // 8
  { x: 800, y: 1440 },   // 9
  { x: 1120, y: 1440 }   // 10
];




    const adjacency = {
      0: [1],
      1: [3],
      2: [1],
      3: [4, 5, 6],
      4: [3, 5, 7],
      5: [3, 4, 6, 7],
      6: [3, 5, 7],
      7: [4, 5, 6, 9],
      8: [9],
      9: [7],
      10: [9],
    };

    let selected = null;

    function draw(state, turn, winner) {
      svg.querySelectorAll(".piece").forEach(e => e.remove());
      positions.forEach((pos, idx) => {
        const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        c.setAttribute("cx", pos.x);
        c.setAttribute("cy", pos.y);
        c.setAttribute("r", 48);
        c.setAttribute("class", "point piece");
        c.dataset.idx = idx;

        if (state[idx] === "âš«") c.classList.add("black");
        else if (state[idx] === "ğŸ”´") c.classList.add("red");

        if (selected === idx) {
  c.classList.add("highlight");
} else if (
          selected !== null &&
          state[selected] === turn &&
          state[idx] === "" &&
          adjacency[selected]?.includes(idx)
        ) c.classList.add("highlight");

        c.addEventListener("click", () => handleClick(idx, state, turn, winner));
        svg.appendChild(c);
      });

  turnInfo.textContent = winner
  ? `ê²Œì„ ì¢…ë£Œ! ìŠ¹ì: ${winner === "âš«" ? "ê²€ì •ìƒ‰ ëŒ" : "ë¹¨ê°„ìƒ‰ ëŒ"}`
  : `í˜„ì¬ ì°¨ë¡€: ${turn === "âš«" ? "ê²€ì •ìƒ‰ ëŒ" : "ë¹¨ê°„ìƒ‰ ëŒ"}`;
    }

    function handleClick(idx, state, turn, winner) {
      if (winner) return;
      if (selected === null && state[idx] === turn) {
        selected = idx;
      } else if (
        selected !== null &&
        state[selected] === turn &&
        state[idx] === "" &&
        adjacency[selected]?.includes(idx)
      ) {
        const newState = [...state];
        newState[idx] = turn;
        newState[selected] = "";
        const nextTurn = turn === "âš«" ? "ğŸ”´" : "âš«";
        const blocked = !newState.some((val, i) =>
          val === nextTurn && adjacency[i]?.some(j => newState[j] === "")
        );
        update(gameRef, {
          positions: newState,
          turn: nextTurn,
          winner: blocked ? turn : ""
        });
        selected = null;
      } else {
        selected = null;
      }
      if (turn !== myColor) return;
    }

    onValue(gameRef, (snap) => {
      const data = snap.val();
      if (data) {
        draw(data.positions, data.turn, data.winner);
      } else {
        resetGame();
      }
    });
   
    resetGame();
    
    function resetGame() {
      set(gameRef, {
        positions: ["âš«", "âš«", "âš«", "", "", "", "", "", "ğŸ”´", "ğŸ”´", "ğŸ”´"],
        turn: "âš«",
        winner: ""
      });
      selected = null;
    }

    resetBtn.addEventListener("click", () => {
      if (confirm("ê²Œì„ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) resetGame();
    });

let myColor;

const storedColor = localStorage.getItem("noWayOutColor");

if (storedColor) {
  myColor = storedColor;
} else {
  // Firebaseì—ì„œ í˜„ì¬ í”Œë ˆì´ì–´ ìˆ˜ í™•ì¸
  onValue(gameRef, (snap) => {
    const data = snap.val();
    if (!data || !data.joinCount) {
      // ì²« ë²ˆì§¸ ì ‘ì†ì
      set(gameRef, {
        positions: ["âš«", "âš«", "âš«", "", "", "", "", "", "ğŸ”´", "ğŸ”´", "ğŸ”´"],
        turn: "âš«",
        winner: "",
        joinCount: 1
      });
      myColor = "âš«";
      localStorage.setItem("noWayOutColor", myColor);
    } else if (data.joinCount === 1) {
      update(gameRef, { joinCount: 2 });
      myColor = "ğŸ”´";
      localStorage.setItem("noWayOutColor", myColor);
    } else {
      alert("ë‘ ëª…ê¹Œì§€ë§Œ ì…ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    }
  }, { onlyOnce: true });
}

if (myColor === "ğŸ”´") {
  svg.classList.add("rotated");
}


  </script>
</body>
</html>