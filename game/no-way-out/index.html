<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>No Way Out (Firebase)</title>
  <style>
    body {
      margin: 0;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 10px;
      font-family: sans-serif;
    }
    #turn {
      font-weight: bold;
      margin-bottom: 10px;
    }
    svg {
      width: 90vmin;
      height: 90vmin;
      background: white;
      border: 2px solid #333;
    }
    line, circle {
      stroke: black;
      stroke-width: 2;
    }
    .piece {
      fill: white;
      cursor: pointer;
    }
    .black { fill: #333; }
    .white { fill: #e0d0f0; }
    .highlight { stroke: #00bcd4; stroke-width: 3; }
  </style>
</head>
<body>
  <div id="turn">로딩 중...</div>
  <svg viewBox="0 0 100 100" id="board">
    <!-- 보드선 -->
    <line x1="30" y1="10" x2="70" y2="10" />
    <line x1="30" y1="90" x2="70" y2="90" />
    <line x1="50" y1="10" x2="50" y2="90" />
    <circle cx="50" cy="50" r="25" fill="none" />
    <line x1="50" y1="25" x2="50" y2="75" />
    <line x1="25" y1="50" x2="75" y2="50" />
  </svg>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase, ref, set, onValue, update
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.firebasestorage.app",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:f8e3fcb77f6ddef091a561"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const gameRef = ref(db, 'games/simple');
    const turnEl = document.getElementById("turn");
    const boardEl = document.getElementById("board");

    const positions = [
      { x: 30, y: 10 }, { x: 50, y: 10 }, { x: 70, y: 10 },
      { x: 25, y: 50 }, { x: 35, y: 50 }, { x: 50, y: 50 },
      { x: 65, y: 50 }, { x: 75, y: 50 },
      { x: 30, y: 90 }, { x: 50, y: 90 }, { x: 70, y: 90 },
      { x: 50, y: 30 }, { x: 50, y: 70 }
    ];

    const adjacency = {
      0: [1], 1: [0,2,11], 2: [1],
      3: [4], 4: [3,5],
      5: [4,6,11,12],
      6: [5,7], 7: [6],
      8: [9], 9: [8,10,12], 10: [9],
      11: [1,5], 12: [5,9]
    };

    let selected = null;

    function drawBoard(state, turn, winner) {
      boardEl.querySelectorAll(".piece").forEach(el => el.remove());
      positions.forEach((p, i) => {
        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute("cx", p.x);
        circle.setAttribute("cy", p.y);
        circle.setAttribute("r", 3.5);
        circle.setAttribute("class", "piece");
        circle.dataset.idx = i;

        if (state[i] === "⬛") circle.classList.add("black");
        else if (state[i] === "⚪") circle.classList.add("white");

        // 하이라이트 표시
        if (selected === i) circle.classList.add("highlight");
        else if (
          selected !== null &&
          state[selected] === turn &&
          state[i] === "" &&
          adjacency[selected]?.includes(i)
        ) {
          circle.classList.add("highlight");
        }

        circle.addEventListener("click", () => handleClick(i, state, turn, winner));
        boardEl.appendChild(circle);
      });

      turnEl.textContent = winner
        ? `게임 종료! 승자: ${winner}`
        : `현재 턴: ${turn}`;
    }

    function handleClick(idx, state, turn, winner) {
      if (winner) return;

      if (selected === null && state[idx] === turn) {
        selected = idx;
      } else if (
        selected !== null &&
        state[selected] === turn &&
        state[idx] === "" &&
        adjacency[selected]?.includes(idx)
      ) {
        const newState = [...state];
        newState[idx] = turn;
        newState[selected] = "";
        const nextTurn = turn === "⬛" ? "⚪" : "⬛";

        const blocked = isBlocked(newState, nextTurn);
        const winner = blocked ? turn : "";

        update(gameRef, {
          positions: newState,
          turn: nextTurn,
          winner
        });
        selected = null;
      } else {
        selected = null;
      }
      drawBoard(state, turn, winner);
    }

    function isBlocked(state, player) {
      return !state.some((val, idx) =>
        val === player &&
        adjacency[idx]?.some(to => state[to] === "")
      );
    }

    // 초기화
    onValue(gameRef, (snapshot) => {
      const data = snapshot.val();
      if (data) {
        drawBoard(data.positions, data.turn, data.winner);
      } else {
        set(gameRef, {
          positions: ["⬛", "⬛", "⬛", "", "", "", "", "", "", "⚪", "⚪", "", "⚪"],
          turn: "⬛",
          winner: ""
        });
      }
    });
  </script>
</body>
</html>
