<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>No Way Out (Firebase)</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }

    #turn {
      margin-bottom: 1rem;
      font-weight: bold;
      font-size: 1.4rem;
    }

    svg {
      width: 100vmin;
      max-width: 100%;
      height: auto;
      background: white;
      touch-action: manipulation;
    }

    line, circle {
      stroke: black;
      stroke-width: 6;
    }

    .point {
      fill: white;
      stroke: black;
      stroke-width: 4;
    }

    .black { fill: black; }
    .red   { fill: red; }

    .highlight {
      stroke: #00bcd4;
      stroke-width: 6;
    }

    .selected {
      stroke: gold;
      stroke-width: 7;
    }

    #resetBtn {
      margin: 0.5rem 0 1rem;
      padding: 0.6rem 1rem;
      font-size: 1rem;
      border: none;
      background: #2196f3;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }

    #resetBtn:hover {
      background: #1976d2;
    }
  </style>
</head>
<body>
  <div id="turn">게임 로딩 중...</div>
  <button id="resetBtn">🔄 게임 초기화</button>

  <svg viewBox="0 0 400 560" id="board">
    <line x1="120" y1="40" x2="280" y2="40" />
    <line x1="120" y1="360" x2="280" y2="360" />
    <line x1="200" y1="40" x2="200" y2="360" />
    <circle cx="200" cy="200" r="100" fill="none" />
    <line x1="200" y1="120" x2="200" y2="280" />
    <line x1="120" y1="200" x2="280" y2="200" />
  </svg>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.firebasestorage.app",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:f8e3fcb77f6ddef091a561"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const gameRef = ref(db, 'games/no-way-out');

    const svg = document.getElementById("board");
    const turnInfo = document.getElementById("turn");
    const resetBtn = document.getElementById("resetBtn");

    const positions = [
      { x: 120, y: 40 }, { x: 200, y: 40 }, { x: 280, y: 40 },
      { x: 200, y: 120 }, { x: 120, y: 200 }, { x: 200, y: 200 },
      { x: 280, y: 200 }, { x: 200, y: 280 },
      { x: 120, y: 360 }, { x: 200, y: 360 }, { x: 280, y: 360 },
    ];

    const adjacency = {
      0: [1],
      1: [3],
      2: [1],
      3: [4, 5, 6],
      4: [3, 5, 7],
      5: [3, 4, 6, 7],
      6: [3, 5, 7],
      7: [4, 5, 6, 9],
      8: [9],
      9: [7, 10],
      10: [9],
    };

    let selected = null;

    function draw(state, turn, winner) {
      svg.querySelectorAll(".piece").forEach(e => e.remove());
      positions.forEach((pos, idx) => {
        const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        c.setAttribute("cx", pos.x);
        c.setAttribute("cy", pos.y);
        c.setAttribute("r", 12);
        c.setAttribute("class", "point piece");
        c.dataset.idx = idx;

        if (state[idx] === "⚫") c.classList.add("black");
        else if (state[idx] === "🔴") c.classList.add("red");

        if (selected === idx) {
          c.classList.add("highlight", "selected");
        } else if (
          selected !== null &&
          state[selected] === turn &&
          state[idx] === "" &&
          adjacency[selected]?.includes(idx)
        ) c.classList.add("highlight");

        c.addEventListener("click", () => handleClick(idx, state, turn, winner));
        svg.appendChild(c);
      });

      turnInfo.textContent = winner
        ? `게임 종료! 승자: ${winner === "⚫" ? "검정색 돌" : "빨간색 돌"}`
        : `현재 차례: ${turn === "⚫" ? "검정색 돌" : "빨간색 돌"}`;
    }

    function handleClick(idx, state, turn, winner) {
      if (winner) return;
      if (selected === null && state[idx] === turn) {
        selected = idx;
      } else if (
        selected !== null &&
        state[selected] === turn &&
        state[idx] === "" &&
        adjacency[selected]?.includes(idx)
      ) {
        const newState = [...state];
        newState[idx] = turn;
        newState[selected] = "";
        const nextTurn = turn === "⚫" ? "🔴" : "⚫";
        const blocked = !newState.some((val, i) =>
          val === nextTurn && adjacency[i]?.some(j => newState[j] === "")
        );
        update(gameRef, {
          positions: newState,
          turn: nextTurn,
          winner: blocked ? turn : ""
        });
        selected = null;
      } else {
        selected = null;
      }
    }

    onValue(gameRef, (snap) => {
      const data = snap.val();
      if (data) {
        draw(data.positions, data.turn, data.winner);
      } else {
        resetGame();
      }
    });

    function resetGame() {
      set(gameRef, {
        positions: ["⚫", "⚫", "⚫", "", "", "", "", "", "🔴", "🔴", "🔴"],
        turn: "⚫",
        winner: ""
      });
      selected = null;
    }

    resetBtn.addEventListener("click", () => {
      if (confirm("게임을 초기화할까요?")) resetGame();
    });
  </script>
</body>
</html>
