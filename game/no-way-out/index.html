<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>No Way Out (Firebase)</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 1rem;
    }
    #turn {
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    svg {
      width: 90vmin;
      height: 90vmin;
      background: white;
    }
    line, circle {
      stroke: black;
      stroke-width: 2;
    }
    .point {
      fill: white;
      stroke: black;
      stroke-width: 2;
    }
    .black { fill: #333; }
    .white { fill: #e0d0f0; }
    .highlight { stroke: #00bcd4; stroke-width: 3; }
  </style>
</head>
<body>
  <div id="turn">게임 로딩 중...</div>
  <svg viewBox="0 0 100 100" id="board">
    <!-- 보드선 -->
    <line x1="30" y1="10" x2="70" y2="10" />
    <line x1="30" y1="90" x2="70" y2="90" />
    <line x1="50" y1="10" x2="50" y2="90" />
    <circle cx="50" cy="50" r="25" fill="none" />
    <line x1="50" y1="30" x2="50" y2="70" />
    <line x1="30" y1="50" x2="70" y2="50" />
  </svg>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase, ref, onValue, set, update
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.firebasestorage.app",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:f8e3fcb77f6ddef091a561"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const gameRef = ref(db, 'games/no-way-out');

    const positions = [
      { x: 30, y: 10 }, // 0
      { x: 50, y: 10 }, // 1
      { x: 70, y: 10 }, // 2
      { x: 50, y: 30 }, // 3
      { x: 30, y: 50 }, // 4
      { x: 50, y: 50 }, // 5 (중앙)
      { x: 70, y: 50 }, // 6
      { x: 50, y: 70 }, // 7
      { x: 30, y: 90 }, // 8
      { x: 50, y: 90 }, // 9
      { x: 70, y: 90 }, // 10
    ];

    const adjacency = {
  0: [1],
  1: [0, 2, 3],
  2: [1],
  3: [1, 5, 6],     // B2 → 중앙(C2), 원 하단(D2)
  4: [5, 6],        // 좌(C1) ↔ 중앙(C2) ↔ 우(C3)
  5: [3, 4, 6, 7],  // 중심점
  6: [4, 5, 3],     // 우(C3) ↔ 중앙(C2) ↔ 상단(B2)
  7: [5, 9, 4],     // 하단(D2) ↔ 중앙(C2) ↔ 좌(C1)
  8: [9],
  9: [7, 8, 10],
  10: [9],
};


    const svg = document.getElementById("board");
    const turnInfo = document.getElementById("turn");

    let selected = null;

    function draw(state, turn, winner) {
      svg.querySelectorAll(".piece").forEach(e => e.remove());
      positions.forEach((pos, idx) => {
        const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        c.setAttribute("cx", pos.x);
        c.setAttribute("cy", pos.y);
        c.setAttribute("r", 3);
        c.setAttribute("class", "point piece");
        c.dataset.idx = idx;

        if (state[idx] === "⬛") c.classList.add("black");
        else if (state[idx] === "⚪") c.classList.add("white");

        if (selected === idx) c.classList.add("highlight");
        else if (
          selected !== null &&
          state[selected] === turn &&
          state[idx] === "" &&
          adjacency[selected]?.includes(idx)
        ) {
          c.classList.add("highlight");
        }

        c.addEventListener("click", () => handleClick(idx, state, turn, winner));
        svg.appendChild(c);
      });

      turnInfo.textContent = winner
        ? `게임 종료! 승자: ${winner}`
        : `현재 턴: ${turn}`;
    }

    function handleClick(idx, state, turn, winner) {
      if (winner) return;
      if (selected === null && state[idx] === turn) {
        selected = idx;
      } else if (
        selected !== null &&
        state[selected] === turn &&
        state[idx] === "" &&
        adjacency[selected]?.includes(idx)
      ) {
        const newState = [...state];
        newState[idx] = turn;
        newState[selected] = "";
        const nextTurn = turn === "⬛" ? "⚪" : "⬛";
        const blocked = !newState.some((val, i) =>
          val === nextTurn &&
          adjacency[i]?.some(j => newState[j] === "")
        );
        update(gameRef, {
          positions: newState,
          turn: nextTurn,
          winner: blocked ? turn : ""
        });
        selected = null;
      } else {
        selected = null;
      }
    }

    // Firebase 초기값 세팅
    onValue(gameRef, (snap) => {
      const data = snap.val();
      if (data) {
        draw(data.positions, data.turn, data.winner);
      } else {
        set(gameRef, {
          positions: ["⬛", "⬛", "⬛", "", "", "", "", "", "⚪", "⚪", "⚪"],
          turn: "⬛",
          winner: ""
        });
      }
    });
  </script>
</body>
</html>
