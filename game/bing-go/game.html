<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë¹™ê³  ê²Œì„</title>
  <link rel="icon" href="data:,">
  <style>
    body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 10px; background:#f7f7f7; }
    #bingo-board { display:grid; grid-template-columns:repeat(5,1fr); gap:4px; max-width:400px; margin:20px auto; }
    .cell { border:1px solid #ccc; padding:15px; background:#f2f2f2; font-size:20px; cursor:pointer; border-radius:6px; user-select:none; }
    .cell.marked { background:#4CAF50; color:#fff; font-weight:bold; }
    #nickname-area button { height:40px; font-size:16px; padding:5px 12px; }
    #nickname { height:48px; font-size:18px; padding:5px 12px; box-sizing:border-box; }
    .modal { position:fixed; z-index:9999; inset:0; background:rgba(0,0,0,.5); display:flex; justify-content:center; align-items:center; }
    .modal-content { background:#fff; padding:24px; border-radius:12px; width:90%; max-width:400px; box-shadow:0 0 10px rgba(0,0,0,.25); text-align:center; }
    .modal-content button { margin-top:20px; padding:10px 20px; font-size:16px; background:#4CAF50; color:#fff; border:0; border-radius:8px; cursor:pointer; }
    #score-board { max-width:420px; margin:10px auto; text-align:left; }
    #called-list { margin:8px auto; color:#333; }
    #exit-button { padding:10px 16px; border:0; border-radius:8px; background:#444; color:#fff; cursor:pointer; }
  </style>
</head>
<body>
  <h2 id="room-title">ë¹™ê³  ê²Œì„</h2>

  <div id="nickname-area">
    <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" />
    <button onclick="registerPlayer()">ì…ì¥</button>
  </div>

  <audio id="btn-sound" src="name.mp3" preload="auto"></audio>
  <audio id="win-sound" src="win.mp3" preload="auto"></audio>
  <audio id="bingo-sound" src="binggo.mp3" preload="auto"></audio>
  <audio id="number-sound" src="number.mp3" preload="auto"></audio>

  <div id="game-area" style="display:none;">
    <h3 id="turn-info">ì°¨ë¡€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h3>
    <div id="bingo-board"></div>
    <div id="called-list"></div>
    <h4 id="bingo-count">ë¹™ê³ : 0ì¤„</h4>
    <div id="score-board"></div>
    <button id="exit-button" onclick="leaveRoom()" style="margin-top: 20px;">ë°© ë‚˜ê°€ê¸°</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.appspot.com",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:1f7246a5fa2d02c291a561"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // --- Room code ---
    const urlParams = new URLSearchParams(location.search);
    const roomCode = urlParams.get('room');
    document.getElementById('room-title').innerText = `ë°© ì½”ë“œ: ${roomCode}`;
    if (!roomCode) { alert('room íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); location.href = 'index.html'; }

    // --- State ---
    let nickname = "";
    let myUid = null;
    let myRole = null;                 // 'A' | 'B'
    let turn = 'A';                    // ê·œì¹™: turnì€ ë¬¸ìì—´ 'A' | 'B'
    let calledNumbers = [];
    let board = [];
    let previousBingoCount = 0;

    // --- Auth ---
    async function ensureAnonAuth() {
      if (auth.currentUser) return auth.currentUser;
      return new Promise((resolve, reject) => {
        const unsub = onAuthStateChanged(auth, (u)=>{ if(u){unsub(); resolve(u);} });
        signInAnonymously(auth).catch(reject);
      });
    }

    const $ = (id) => document.getElementById(id);

    // --- ì…ì¥ ---
    window.registerPlayer = async function () {
      nickname = $('nickname').value.trim();
      if (!nickname) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      $('btn-sound').play().catch(()=>{});

      const user = await ensureAnonAuth();
      myUid = user.uid;

      const roomRef = ref(db, `rooms/${roomCode}`);
      const snap = await get(roomRef);
      if (!snap.exists()) { alert('ë°©ì´ ì—†ìŠµë‹ˆë‹¤.'); location.href='index.html'; return; }
      const data = snap.val() || {};
      const hostUid = data.hostUid || null;

      // 1) A/B ìŠ¬ë¡¯ ë°°ì • (ë£¨íŠ¸ updateë³´ë‹¤ ë¨¼ì € í•´ì•¼ ê¶Œí•œ ìƒê¹€)
      const aRef = ref(db, `rooms/${roomCode}/players/A`);
      const bRef = ref(db, `rooms/${roomCode}/players/B`);
      const aSnap = await get(aRef);
      const bSnap = await get(bRef);

      if (hostUid === myUid) {
        // ë°©ì¥ â†’ A
        if (!aSnap.exists()) await set(aRef, { name:nickname, uid:myUid }); // hostUidëŠ” rooms/$code ì— ì´ë¯¸ ìˆìŒ
        myRole = 'A';
      } else {
        // ë¹„ë°©ì¥ â†’ Bê°€ ë¹„ì–´ ìˆìœ¼ë©´ ìƒì„± (ê·œì¹™: BëŠ” !data.exists()ì¼ ë•Œë§Œ ì“°ê¸° í—ˆìš©)
        if (!bSnap.exists()) {
          await set(bRef, { name:nickname, uid:myUid });
          myRole = 'B';
        } else if (bSnap.val()?.uid === myUid) {
          myRole = 'B'; // ì¬ì…ì¥
        } else if (aSnap.exists() && aSnap.val()?.uid === myUid) {
          myRole = 'A'; // í˜¹ì‹œ Aê°€ ë‚´ uidì¸ ì¬ì…ì¥
        } else {
          alert('ì…ì¥ ê°€ëŠ¥í•œ ìë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. (A/B ëª¨ë‘ ì‚¬ìš©ì¤‘)');
          return;
        }
      }

      // 2) í•„ë“œ ë³´ì •(ì´ì œ ì°¸ê°€ì ê¶Œí•œ ìˆìŒ â†’ rooms/{code}ì— í•œí•´ì„œ ì—…ë°ì´íŠ¸)
      const patch = {};
      if (!Array.isArray(data.calledNumbers)) patch.calledNumbers = [];
      if (typeof data.turn !== 'string')       patch.turn = 'A';
      if (data.status !== 'lobby')             patch.status = 'lobby';
      if (Object.keys(patch).length) await update(roomRef, patch);

      // 3) ê°œì¸ ìƒíƒœ
      await set(ref(db, `rooms/${roomCode}/ready/${myUid}`), true);
      await set(ref(db, `rooms/${roomCode}/scores/${myUid}`), 0);

      onDisconnect(ref(db, `rooms/${roomCode}/ready/${myUid}`)).remove();
      onDisconnect(ref(db, `rooms/${roomCode}/scores/${myUid}`)).remove();

      $('nickname-area').style.display = 'none';
      $('game-area').style.display = 'block';
      generateBoard();
      setupRealtime();
    };

    // --- ë¹™ê³ íŒ ìƒì„± ---
    function generateBoard() {
      const boardEl = $('bingo-board');
      const nums = Array.from({length:75}, (_,i)=>i+1).sort(()=>Math.random()-0.5);
      board = nums.slice(0,25);
      boardEl.innerHTML = '';

      board.forEach(num => {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.innerText = num;
        cell.onclick = async () => {
          if (!myUid || !myRole) return;
          if (turn !== myRole) return;               // ë‚´ ì°¨ë¡€ê°€ ì•„ë‹ˆë©´ ë¬´ì‹œ

          const number = num;
          $('number-sound').play().catch(()=>{});

          // ì´ë¯¸ ë¶€ë¥¸ ìˆ«ìë©´ ë‚´ íŒë§Œ í‘œì‹œ ê°±ì‹ 
          if (calledNumbers.includes(number)) {
            cell.classList.add('marked');
            updateBingoCount();
            return;
          }

          const nextTurn = (myRole === 'A') ? 'B' : 'A';
          const newList = [...calledNumbers, number];

          // ê·œì¹™ì— ë§ëŠ” í•„ë“œë§Œ ì—…ë°ì´íŠ¸
          await update(ref(db, `rooms/${roomCode}`), {
            turn: nextTurn,
            lastMove: { number, by: myUid, at: Date.now() },
            calledNumbers: newList
          });
        };
        boardEl.appendChild(cell);
      });

      if (calledNumbers.length) {
        document.querySelectorAll('.cell').forEach(c=>{
          if (calledNumbers.includes(Number(c.innerText))) c.classList.add('marked');
        });
        updateBingoCount();
      }
    }

    // --- ë¹™ê³  ì¤„ìˆ˜ ê³„ì‚°/ì €ì¥ ---
    function updateBingoCount() {
      const cells = [...document.querySelectorAll('.cell')];
      const matrix = [];
      while (cells.length) matrix.push(cells.splice(0,5));

      let bingo = 0;
      for (let i=0;i<5;i++){
        if (matrix[i].every(c=>c.classList.contains('marked'))) bingo++;
        if (matrix.map(r=>r[i]).every(c=>c.classList.contains('marked'))) bingo++;
      }
      if (matrix.map((r,i)=>r[i]).every(c=>c.classList.contains('marked'))) bingo++;
      if (matrix.map((r,i)=>r[4-i]).every(c=>c.classList.contains('marked'))) bingo++;

      $('bingo-count').innerText = `ë¹™ê³ : ${bingo}ì¤„`;

      if (bingo > previousBingoCount) $('bingo-sound').play().catch(()=>{});
      previousBingoCount = bingo;

      if (myUid) set(ref(db, `rooms/${roomCode}/scores/${myUid}`), bingo);
      if (bingo >= 5) {
        const winnerRef = ref(db, `rooms/${roomCode}/winner`);
        get(winnerRef).then(s => { if (!s.exists()) set(winnerRef, myUid); });
      }
    }

    // --- ì‹¤ì‹œê°„ êµ¬ë… ---
    function setupRealtime() {
      const roomRef = ref(db, `rooms/${roomCode}`);
      onValue(roomRef, snapshot => {
        const data = snapshot.val() || {};
        const players = data.players || {};
        const resolveName = (who) => {
          if (who === 'A' || who === 'B') return players?.[who]?.name || '...';
          const r = (players.A?.uid === who) ? 'A' : (players.B?.uid === who) ? 'B' : null;
          return r ? players[r].name : '...';
        };

        turn = typeof data.turn === 'string' ? data.turn : 'A';
        calledNumbers = Array.isArray(data.calledNumbers) ? data.calledNumbers : [];

        if (data.winner) {
          if (data.winner === myUid) $('win-sound').play().catch(()=>{});
          $('turn-info').innerText = `ğŸ‰ ìš°ìŠ¹ì: ${resolveName(data.winner)} ë‹˜ ìŠ¹ë¦¬!`;
          document.querySelectorAll('.cell').forEach(cell => cell.style.pointerEvents='none');
          setTimeout(() => {
            alert("ê²Œì„ì´ ì¢…ë£Œë˜ì–´ ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            remove(ref(db, `rooms/${roomCode}`)).then(()=>{ location.href="index.html"; });
          }, 5000);
        } else {
          $('turn-info').innerText = `í˜„ì¬ ì°¨ë¡€: ${resolveName(turn)}`;
        }

        $('called-list').innerText = calledNumbers.length
          ? `ë¶€ë¥¸ ìˆ«ì: ${calledNumbers.join(", ")}`
          : 'ë¶€ë¥¸ ìˆ«ì ì—†ìŒ';

        document.querySelectorAll('.cell').forEach(cell=>{
          const n = Number(cell.innerText);
          if (calledNumbers.includes(n)) cell.classList.add('marked');
        });
        updateBingoCount();

        // ì ìˆ˜íŒ
        const sb = $('score-board');
        sb.innerHTML = '';
        if (data.scores) {
          const entries = Object.entries(data.scores)
            .map(([uid, sc]) => ({ name: resolveName(uid), sc: Number(sc)||0 }))
            .sort((a,b)=>b.sc-a.sc);
          sb.innerHTML = '<h4>ì ìˆ˜íŒ</h4>' + entries.map(e=>`<div>${e.name}: ${e.sc}ì¤„</div>`).join('');
        }

if (!data.winner && data.scores) {
  for (const uid in data.scores) {
    if (Number(data.scores[uid]) >= 5) {
      // ê·œì¹™ í†µê³¼ìš©: ê°ì²´ë¡œ ì €ì¥
      set(ref(db, `rooms/${roomCode}/winner`), {
        uid,
        name: resolveName(uid),
        positions: Array.isArray(data.calledNumbers) ? data.calledNumbers : []
      });
      break;
    }
  }
}
);
    }

    // --- ë‚˜ê°€ê¸° ---
    window.leaveRoom = async function () {
      if (!myUid || !roomCode) return;

      // ready/scoresë§Œ ì •ë¦¬ (players/BëŠ” ê·œì¹™ìƒ ì‚­ì œê¶Œí•œ ì œí•œ)
      await remove(ref(db, `rooms/${roomCode}/ready/${myUid}`));
      await remove(ref(db, `rooms/${roomCode}/scores/${myUid}`));

      // ë°©ì¥ì´ê³  ìƒëŒ€ê°€ ì—†ìœ¼ë©´ ë°© ì‚­ì œ
      const roomRef = ref(db, `rooms/${roomCode}`);
      const snap = await get(roomRef);
      const data = snap.val() || {};
      const players = data.players || {};
      const others = [players.A?.uid, players.B?.uid].filter(u => !!u && u !== myUid);

      if (data.hostUid === myUid && others.length === 0) {
        await remove(roomRef);
      }

      alert("ë°©ì—ì„œ ë‚˜ê°‘ë‹ˆë‹¤.");
      location.href = "index.html";
    };

    window.addEventListener('DOMContentLoaded', () => { document.getElementById('modal').style.display = 'flex'; });
    window.closeModal = function () { document.getElementById('modal').style.display = 'none'; };
  </script>

  <div id="modal" class="modal">
    <div class="modal-content">
      <h2>ë¹™ê³  ê²Œì„ ì„¤ëª…</h2>
      <p>
        âœ… ë‹‰ë„¤ì„ ì…ë ¥ â†’ ì…ì¥<br>
        âœ… ìì‹ ì˜ ì°¨ë¡€(ìƒë‹¨ í‘œì‹œ)ì— ìˆ«ì í´ë¦­<br>
        âœ… ê°€ë¡œ/ì„¸ë¡œ/ëŒ€ê°ì„  5ì¤„ì´ë©´ ìŠ¹ë¦¬, ì¢…ë£Œ
      </p>
      <button onclick="closeModal()">ê²Œì„ ì‹œì‘</button>
    </div>
  </div>
</body>
</html>
