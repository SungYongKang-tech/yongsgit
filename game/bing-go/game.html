<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>빙고 게임</title>
  <link rel="icon" href="data:,">
  <style>
    body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 10px; background:#f7f7f7; }
    #bingo-board { display:grid; grid-template-columns:repeat(5,1fr); gap:4px; max-width:400px; margin:20px auto; }
    .cell { border:1px solid #ccc; padding:15px; background:#f2f2f2; font-size:20px; cursor:pointer; border-radius:6px; user-select:none; }
    .cell.marked { background:#4CAF50; color:#fff; font-weight:bold; }
    #nickname-area button { height:40px; font-size:16px; padding:5px 12px; }
    #nickname { height:48px; font-size:18px; padding:5px 12px; box-sizing:border-box; }
    .modal { position:fixed; z-index:9999; inset:0; background:rgba(0,0,0,.5); display:flex; justify-content:center; align-items:center; }
    .modal-content { background:#fff; padding:24px; border-radius:12px; width:90%; max-width:400px; box-shadow:0 0 10px rgba(0,0,0,.25); text-align:center; }
    .modal-content button { margin-top:20px; padding:10px 20px; font-size:16px; background:#4CAF50; color:#fff; border:0; border-radius:8px; cursor:pointer; }
    #score-board { max-width:420px; margin:10px auto; text-align:left; }
    #called-list { margin:8px auto; color:#333; }
    #exit-button { padding:10px 16px; border:0; border-radius:8px; background:#444; color:#fff; cursor:pointer; }
  </style>
</head>
<body>
  <h2 id="room-title">빙고 게임</h2>

  <div id="nickname-area">
    <input type="text" id="nickname" placeholder="닉네임 입력" />
    <button onclick="registerPlayer()">입장</button>
  </div>

  <audio id="btn-sound" src="name.mp3" preload="auto"></audio>
  <audio id="win-sound" src="win.mp3" preload="auto"></audio>
  <audio id="bingo-sound" src="binggo.mp3" preload="auto"></audio>
  <audio id="number-sound" src="number.mp3" preload="auto"></audio>

  <div id="game-area" style="display:none;">
    <h3 id="turn-info">차례 정보를 불러오는 중...</h3>
    <div id="bingo-board"></div>
    <div id="called-list"></div>
    <h4 id="bingo-count">빙고: 0줄</h4>
    <div id="score-board"></div>
    <button id="exit-button" onclick="leaveRoom()" style="margin-top: 20px;">방 나가기</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.appspot.com",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:1f7246a5fa2d02c291a561"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // --- Room code ---
    const urlParams = new URLSearchParams(location.search);
    const roomCode = urlParams.get('room');
    document.getElementById('room-title').innerText = `방 코드: ${roomCode}`;
    if (!roomCode) { alert('room 파라미터가 없습니다.'); location.href = 'index.html'; }

    // --- State ---
    let nickname = "";
    let myUid = null;
    let myRole = null;                 // 'A' | 'B'
    let turn = 'A';                    // 규칙: turn은 문자열 'A' | 'B'
    let calledNumbers = [];
    let board = [];
    let previousBingoCount = 0;

    // --- Auth ---
    async function ensureAnonAuth() {
      if (auth.currentUser) return auth.currentUser;
      return new Promise((resolve, reject) => {
        const unsub = onAuthStateChanged(auth, (u)=>{ if(u){unsub(); resolve(u);} });
        signInAnonymously(auth).catch(reject);
      });
    }

    const $ = (id) => document.getElementById(id);

    // --- 입장 ---
    window.registerPlayer = async function () {
      nickname = $('nickname').value.trim();
      if (!nickname) return alert("닉네임을 입력해주세요.");
      $('btn-sound').play().catch(()=>{});

      const user = await ensureAnonAuth();
      myUid = user.uid;

      const roomRef = ref(db, `rooms/${roomCode}`);
      const snap = await get(roomRef);
      if (!snap.exists()) { alert('방이 없습니다.'); location.href='index.html'; return; }
      const data = snap.val() || {};
      const hostUid = data.hostUid || null;

      // 1) A/B 슬롯 배정 (루트 update보다 먼저 해야 권한 생김)
      const aRef = ref(db, `rooms/${roomCode}/players/A`);
      const bRef = ref(db, `rooms/${roomCode}/players/B`);
      const aSnap = await get(aRef);
      const bSnap = await get(bRef);

      if (hostUid === myUid) {
        // 방장 → A
        if (!aSnap.exists()) await set(aRef, { name:nickname, uid:myUid }); // hostUid는 rooms/$code 에 이미 있음
        myRole = 'A';
      } else {
        // 비방장 → B가 비어 있으면 생성 (규칙: B는 !data.exists()일 때만 쓰기 허용)
        if (!bSnap.exists()) {
          await set(bRef, { name:nickname, uid:myUid });
          myRole = 'B';
        } else if (bSnap.val()?.uid === myUid) {
          myRole = 'B'; // 재입장
        } else if (aSnap.exists() && aSnap.val()?.uid === myUid) {
          myRole = 'A'; // 혹시 A가 내 uid인 재입장
        } else {
          alert('입장 가능한 자리가 없습니다. (A/B 모두 사용중)');
          return;
        }
      }

      // 2) 필드 보정(이제 참가자 권한 있음 → rooms/{code}에 한해서 업데이트)
      const patch = {};
      if (!Array.isArray(data.calledNumbers)) patch.calledNumbers = [];
      if (typeof data.turn !== 'string')       patch.turn = 'A';
      if (data.status !== 'lobby')             patch.status = 'lobby';
      if (Object.keys(patch).length) await update(roomRef, patch);

      // 3) 개인 상태
      await set(ref(db, `rooms/${roomCode}/ready/${myUid}`), true);
      await set(ref(db, `rooms/${roomCode}/scores/${myUid}`), 0);

      onDisconnect(ref(db, `rooms/${roomCode}/ready/${myUid}`)).remove();
      onDisconnect(ref(db, `rooms/${roomCode}/scores/${myUid}`)).remove();

      $('nickname-area').style.display = 'none';
      $('game-area').style.display = 'block';
      generateBoard();
      setupRealtime();
    };

    // --- 빙고판 생성 ---
    function generateBoard() {
      const boardEl = $('bingo-board');
      const nums = Array.from({length:75}, (_,i)=>i+1).sort(()=>Math.random()-0.5);
      board = nums.slice(0,25);
      boardEl.innerHTML = '';

      board.forEach(num => {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.innerText = num;
        cell.onclick = async () => {
          if (!myUid || !myRole) return;
          if (turn !== myRole) return;               // 내 차례가 아니면 무시

          const number = num;
          $('number-sound').play().catch(()=>{});

          // 이미 부른 숫자면 내 판만 표시 갱신
          if (calledNumbers.includes(number)) {
            cell.classList.add('marked');
            updateBingoCount();
            return;
          }

          const nextTurn = (myRole === 'A') ? 'B' : 'A';
          const newList = [...calledNumbers, number];

          // 규칙에 맞는 필드만 업데이트
          await update(ref(db, `rooms/${roomCode}`), {
            turn: nextTurn,
            lastMove: { number, by: myUid, at: Date.now() },
            calledNumbers: newList
          });
        };
        boardEl.appendChild(cell);
      });

      if (calledNumbers.length) {
        document.querySelectorAll('.cell').forEach(c=>{
          if (calledNumbers.includes(Number(c.innerText))) c.classList.add('marked');
        });
        updateBingoCount();
      }
    }

    // --- 빙고 줄수 계산/저장 ---
    function updateBingoCount() {
      const cells = [...document.querySelectorAll('.cell')];
      const matrix = [];
      while (cells.length) matrix.push(cells.splice(0,5));

      let bingo = 0;
      for (let i=0;i<5;i++){
        if (matrix[i].every(c=>c.classList.contains('marked'))) bingo++;
        if (matrix.map(r=>r[i]).every(c=>c.classList.contains('marked'))) bingo++;
      }
      if (matrix.map((r,i)=>r[i]).every(c=>c.classList.contains('marked'))) bingo++;
      if (matrix.map((r,i)=>r[4-i]).every(c=>c.classList.contains('marked'))) bingo++;

      $('bingo-count').innerText = `빙고: ${bingo}줄`;

      if (bingo > previousBingoCount) $('bingo-sound').play().catch(()=>{});
      previousBingoCount = bingo;

      if (myUid) set(ref(db, `rooms/${roomCode}/scores/${myUid}`), bingo);
      if (bingo >= 5) {
        const winnerRef = ref(db, `rooms/${roomCode}/winner`);
        get(winnerRef).then(s => { if (!s.exists()) set(winnerRef, myUid); });
      }
    }

    // --- 실시간 구독 ---
    function setupRealtime() {
      const roomRef = ref(db, `rooms/${roomCode}`);
      onValue(roomRef, snapshot => {
        const data = snapshot.val() || {};
        const players = data.players || {};
        const resolveName = (who) => {
          if (who === 'A' || who === 'B') return players?.[who]?.name || '...';
          const r = (players.A?.uid === who) ? 'A' : (players.B?.uid === who) ? 'B' : null;
          return r ? players[r].name : '...';
        };

        turn = typeof data.turn === 'string' ? data.turn : 'A';
        calledNumbers = Array.isArray(data.calledNumbers) ? data.calledNumbers : [];

        if (data.winner) {
          if (data.winner === myUid) $('win-sound').play().catch(()=>{});
          $('turn-info').innerText = `🎉 우승자: ${resolveName(data.winner)} 님 승리!`;
          document.querySelectorAll('.cell').forEach(cell => cell.style.pointerEvents='none');
          setTimeout(() => {
            alert("게임이 종료되어 방이 삭제되었습니다.");
            remove(ref(db, `rooms/${roomCode}`)).then(()=>{ location.href="index.html"; });
          }, 5000);
        } else {
          $('turn-info').innerText = `현재 차례: ${resolveName(turn)}`;
        }

        $('called-list').innerText = calledNumbers.length
          ? `부른 숫자: ${calledNumbers.join(", ")}`
          : '부른 숫자 없음';

        document.querySelectorAll('.cell').forEach(cell=>{
          const n = Number(cell.innerText);
          if (calledNumbers.includes(n)) cell.classList.add('marked');
        });
        updateBingoCount();

        // 점수판
        const sb = $('score-board');
        sb.innerHTML = '';
        if (data.scores) {
          const entries = Object.entries(data.scores)
            .map(([uid, sc]) => ({ name: resolveName(uid), sc: Number(sc)||0 }))
            .sort((a,b)=>b.sc-a.sc);
          sb.innerHTML = '<h4>점수판</h4>' + entries.map(e=>`<div>${e.name}: ${e.sc}줄</div>`).join('');
        }

if (!data.winner && data.scores) {
  for (const uid in data.scores) {
    if (Number(data.scores[uid]) >= 5) {
      // 규칙 통과용: 객체로 저장
      set(ref(db, `rooms/${roomCode}/winner`), {
        uid,
        name: resolveName(uid),
        positions: Array.isArray(data.calledNumbers) ? data.calledNumbers : []
      });
      break;
    }
  }
}
);
    }

    // --- 나가기 ---
    window.leaveRoom = async function () {
      if (!myUid || !roomCode) return;

      // ready/scores만 정리 (players/B는 규칙상 삭제권한 제한)
      await remove(ref(db, `rooms/${roomCode}/ready/${myUid}`));
      await remove(ref(db, `rooms/${roomCode}/scores/${myUid}`));

      // 방장이고 상대가 없으면 방 삭제
      const roomRef = ref(db, `rooms/${roomCode}`);
      const snap = await get(roomRef);
      const data = snap.val() || {};
      const players = data.players || {};
      const others = [players.A?.uid, players.B?.uid].filter(u => !!u && u !== myUid);

      if (data.hostUid === myUid && others.length === 0) {
        await remove(roomRef);
      }

      alert("방에서 나갑니다.");
      location.href = "index.html";
    };

    window.addEventListener('DOMContentLoaded', () => { document.getElementById('modal').style.display = 'flex'; });
    window.closeModal = function () { document.getElementById('modal').style.display = 'none'; };
  </script>

  <div id="modal" class="modal">
    <div class="modal-content">
      <h2>빙고 게임 설명</h2>
      <p>
        ✅ 닉네임 입력 → 입장<br>
        ✅ 자신의 차례(상단 표시)에 숫자 클릭<br>
        ✅ 가로/세로/대각선 5줄이면 승리, 종료
      </p>
      <button onclick="closeModal()">게임 시작</button>
    </div>
  </div>
</body>
</html>
