<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>빙고 게임</title>
  <link rel="icon" href="data:,">
  <style>
    body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 10px; background:#f7f7f7; }
    #bingo-board {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 4px;
      max-width: 400px;
      margin: 20px auto;
    }
    .cell {
      border: 1px solid #ccc;
      padding: 15px;
      background-color: #f2f2f2;
      font-size: 20px;
      cursor: pointer;
      border-radius: 6px;
      user-select: none;
    }
    .cell.marked { background-color: #4CAF50; color: white; font-weight: bold; }

    #nickname-area button { height: 40px; font-size: 16px; padding: 5px 12px; }
    #nickname { height: 48px; font-size: 18px; padding: 5px 12px; box-sizing: border-box; }
    #nickname-area input { margin-right: 8px; }

    .modal {
      position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
    }
    .modal-content {
      background-color: white; padding: 24px; border-radius: 12px; width: 90%; max-width: 400px;
      box-shadow: 0 0 10px rgba(0,0,0,0.25); text-align: center;
    }
    .modal-content h2 { margin-top: 0; }
    .modal-content button {
      margin-top: 20px; padding: 10px 20px; font-size: 16px;
      background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer;
    }

    #score-board { max-width: 420px; margin: 10px auto; text-align: left; }
    #called-list { margin: 8px auto; color:#333; }
    #exit-button { padding:10px 16px; border:0; border-radius:8px; background:#444; color:#fff; cursor:pointer; }
  </style>
</head>
<body>
  <h2 id="room-title">빙고 게임</h2>

  <div id="nickname-area">
    <input type="text" id="nickname" placeholder="닉네임 입력" />
    <button onclick="registerPlayer()">입장</button>
  </div>

  <audio id="btn-sound" src="name.mp3" preload="auto"></audio>
  <audio id="win-sound" src="win.mp3" preload="auto"></audio>
  <audio id="bingo-sound" src="binggo.mp3" preload="auto"></audio>
  <audio id="number-sound" src="number.mp3" preload="auto"></audio>

  <div id="game-area" style="display:none;">
    <h3 id="turn-info">차례 정보를 불러오는 중...</h3>
    <div id="bingo-board"></div>
    <div id="called-list"></div>
    <h4 id="bingo-count">빙고: 0줄</h4>
    <div id="score-board"></div>
    <button id="exit-button" onclick="leaveRoom()" style="margin-top: 20px;">방 나가기</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase, ref, set, get, update, onValue, remove, onDisconnect
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import {
      getAuth, onAuthStateChanged, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.appspot.com",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:1f7246a5fa2d02c291a561"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // --- Room code ---
    const urlParams = new URLSearchParams(location.search);
    const roomCode = urlParams.get('room');
    document.getElementById('room-title').innerText = `방 코드: ${roomCode}`;
    if (!roomCode) {
      alert('room 파라미터가 없습니다.');
      location.href = 'index.html';
    }

    // --- State ---
    let nickname = "";
    let myUid = null;
    let myRole = null; // 'A' | 'B'
    let turn = 'A';
    let calledNumbers = [];
    let board = [];
    let previousBingoCount = 0;

    // --- Auth ---
    async function ensureAnonAuth() {
      if (auth.currentUser) return auth.currentUser;
      return new Promise((resolve, reject) => {
        const unsub = onAuthStateChanged(auth, (u) => { if (u) { unsub(); resolve(u); }});
        signInAnonymously(auth).catch(reject);
      });
    }

    // --- UI helpers ---
    const $ = (id) => document.getElementById(id);

    // --- 입장 ---
    window.registerPlayer = async function () {
      nickname = $('nickname').value.trim();
      if (!nickname) return alert("닉네임을 입력해주세요.");
      $('btn-sound').play().catch(()=>{});

      const user = await ensureAnonAuth();
      myUid = user.uid;

      // 방 정보 조회
      const roomRef = ref(db, `rooms/${roomCode}`);
      const snap = await get(roomRef);
      if (!snap.exists()) {
        alert('방이 없습니다.');
        location.href = 'index.html';
        return;
      }
      const data = snap.val() || {};
      const hostUid = data.hostUid || null;

      // --- A/B 슬롯 배정 ---
      const aRef = ref(db, `rooms/${roomCode}/players/A`);
      const bRef = ref(db, `rooms/${roomCode}/players/B`);
      const aSnap = await get(aRef);
      const bSnap = await get(bRef);

      // 방장이면 A, 아니면 B가 비어있을 때 B
      if (hostUid === myUid) {
        // A가 없으면 내가 A로
        if (!aSnap.exists()) await set(aRef, { name: nickname, uid: myUid });
        myRole = 'A';
      } else {
        if (!bSnap.exists()) {
          await set(bRef, { name: nickname, uid: myUid }); // 규칙상 B는 비어있을 때 누구나 1회 작성 가능
          myRole = 'B';
        } else {
          // 이미 B가 있으면 내가 B 자격인지 확인(같은 uid로 재입장)
          if (bSnap.val()?.uid === myUid) {
            myRole = 'B';
          } else if (aSnap.exists() && aSnap.val()?.uid === myUid) {
            myRole = 'A';
          } else {
            alert('입장 가능한 자리가 없습니다.');
            return;
          }
        }
      }

      // 초기 필드 보정(객체 경로로만 업데이트: 루트 업데이트 금지)
      const patch = {};
      if (!Array.isArray(data.calledNumbers)) patch.calledNumbers = [];
      if (typeof data.turn !== 'string') patch.turn = 'A';
      if (data.status !== 'lobby') patch.status = 'lobby';
      if (Object.keys(patch).length) await update(roomRef, patch);

      // 준비/점수(개인 키에만 기록 — 규칙 허용)
      await set(ref(db, `rooms/${roomCode}/ready/${myUid}`), true);
      await set(ref(db, `rooms/${roomCode}/scores/${myUid}`), 0);

      // 접속 종료 시 정리(개인 영역만)
      onDisconnect(ref(db, `rooms/${roomCode}/ready/${myUid}`)).remove();
      onDisconnect(ref(db, `rooms/${roomCode}/scores/${myUid}`)).remove();

      $('nickname-area').style.display = 'none';
      $('game-area').style.display = 'block';
      generateBoard();
      setupRealtime();
    };

    // --- 빙고판 생성 ---
    function generateBoard() {
      const boardEl = $('bingo-board');
      const nums = Array.from({length: 75}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
      board = nums.slice(0, 25);
      boardEl.innerHTML = '';

      board.forEach(num => {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.innerText = num;
        cell.onclick = async () => {
          if (!myUid || !myRole) return;

          // 내 차례인지 확인
          if (turn !== myRole) return;

          const number = num;
          $('number-sound').play().catch(()=>{});

          // 이미 불렀던 숫자면 내 판만 표시 갱신
          if (calledNumbers.includes(number)) {
            cell.classList.add('marked');
            updateBingoCount();
            return;
          }

          // 다음 턴 계산(A↔B)
          const nextTurn = (myRole === 'A') ? 'B' : 'A';
          const newList = [...calledNumbers, number];

          // 방 상태 갱신(부모 경로지만 A/B만 허용되므로 규칙 충족)
          await update(ref(db, `rooms/${roomCode}`), {
            turn: nextTurn,
            lastMove: { number, by: myUid, at: Date.now() },
            calledNumbers: newList
          });
        };
        boardEl.appendChild(cell);
      });

      // 이미 부른 숫자 초기 마킹
      if (calledNumbers.length) {
        const cells = document.querySelectorAll('.cell');
        cells.forEach(c => {
          if (calledNumbers.includes(Number(c.innerText))) c.classList.add('marked');
        });
        updateBingoCount();
      }
    }

    // --- 빙고 줄수 계산/저장 ---
    function updateBingoCount() {
      const cells = [...document.querySelectorAll('.cell')];
      const matrix = [];
      while (cells.length) matrix.push(cells.splice(0, 5));

      let bingo = 0;
      for (let i = 0; i < 5; i++) {
        if (matrix[i].every(c => c.classList.contains('marked'))) bingo++;
        if (matrix.map(r => r[i]).every(c => c.classList.contains('marked'))) bingo++;
      }
      if (matrix.map((r, i) => r[i]).every(c => c.classList.contains('marked'))) bingo++;
      if (matrix.map((r, i) => r[4 - i]).every(c => c.classList.contains('marked'))) bingo++;

      $('bingo-count').innerText = `빙고: ${bingo}줄`;

      if (bingo > previousBingoCount) $('bingo-sound').play().catch(()=>{});
      previousBingoCount = bingo;

      // 점수 저장 및 우승 조건 검사
      if (myUid) set(ref(db, `rooms/${roomCode}/scores/${myUid}`), bingo);
      if (bingo >= 5) {
        const winnerRef = ref(db, `rooms/${roomCode}/winner`);
        get(winnerRef).then(s => {
          if (!s.exists()) set(winnerRef, myUid);
        });
      }
    }

    // --- 실시간 구독 ---
    function setupRealtime() {
      const roomRef = ref(db, `rooms/${roomCode}`);
      onValue(roomRef, snapshot => {
        const data = snapshot.val() || {};
        const players = data.players || {};
        const resolveName = (roleOrUid) => {
          if (roleOrUid === 'A' || roleOrUid === 'B') return players?.[roleOrUid]?.name || '...';
          // uid 점수판 표시용
          const matchRole = (players.A?.uid === roleOrUid) ? 'A'
                            : (players.B?.uid === roleOrUid) ? 'B' : null;
          return matchRole ? players[matchRole].name : '...';
        };

        turn = typeof data.turn === 'string' ? data.turn : 'A';
        calledNumbers = Array.isArray(data.calledNumbers) ? data.calledNumbers : [];

        // 우승 처리
        if (data.winner) {
          if (data.winner === myUid) $('win-sound').play().catch(()=>{});
          $('turn-info').innerText = `🎉 우승자: ${resolveName(data.winner)} 님이 빙고 5줄로 승리!`;
          document.querySelectorAll('.cell').forEach(cell => cell.style.pointerEvents = 'none');
          setTimeout(() => {
            alert("게임이 종료되어 방이 삭제되었습니다.");
            remove(ref(db, `rooms/${roomCode}`)).then(() => {
              window.location.href = "index.html";
            });
          }, 5000);
        } else {
          $('turn-info').innerText = `현재 차례: ${resolveName(turn)}`;
        }

        // 호출 숫자 리스트 UI
        $('called-list').innerText = calledNumbers.length
          ? `부른 숫자: ${calledNumbers.join(", ")}`
          : '부른 숫자 없음';

        // 내 보드에 마킹 반영
        document.querySelectorAll('.cell').forEach(cell => {
          const n = Number(cell.innerText);
          if (calledNumbers.includes(n)) cell.classList.add('marked');
        });
        updateBingoCount();

        // 점수판
        const sb = $('score-board');
        sb.innerHTML = '';
        if (data.scores) {
          const entries = Object.entries(data.scores)
            .map(([uid, sc]) => ({ name: resolveName(uid), sc: Number(sc)||0 }))
            .sort((a,b)=>b.sc-a.sc);
          sb.innerHTML = '<h4>점수판</h4>' +
            entries.map(e => `<div>${e.name}: ${e.sc}줄</div>`).join('');
        }

        // 다른 참가자도 5줄이 되면 우승 확정
        if (!data.winner && data.scores) {
          for (const uid in data.scores) {
            if (Number(data.scores[uid]) >= 5) {
              set(ref(db, `rooms/${roomCode}/winner`), uid);
              break;
            }
          }
        }
      });
    }

    // --- 나가기 ---
    window.leaveRoom = async function () {
      if (!myUid || !roomCode) return;

      // ready/scores만 정리 (players A/B는 규칙상 아무나 지우지 않도록 유지)
      await remove(ref(db, `rooms/${roomCode}/ready/${myUid}`));
      await remove(ref(db, `rooms/${roomCode}/scores/${myUid}`));

      // 방장이고 상대가 없다면 방 삭제
      const roomRef = ref(db, `rooms/${roomCode}`);
      const snap = await get(roomRef);
      const data = snap.val() || {};
      const players = data.players || {};
      const others =
        [players.A?.uid, players.B?.uid].filter(u => !!u && u !== myUid);

      if (data.hostUid === myUid && others.length === 0) {
        await remove(roomRef);
      }

      alert("방에서 나갑니다.");
      window.location.href = "index.html";
    };

    // --- 모달 ---
    window.addEventListener('DOMContentLoaded', () => {
      $('modal').style.display = 'flex';
    });
    window.closeModal = function () { $('modal').style.display = 'none'; };
  </script>

  <!-- 게임 설명 모달 -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2>빙고 게임 설명</h2>
      <p>
        ✅ 1. 닉네임을 입력 후 입장하세요.<br>
        ✅ 2. 각자 5x5 빙고판이 랜덤 생성됩니다.<br>
        ✅ 3. 자신의 차례(상단 표시)에 숫자를 클릭하면 모두가 그 숫자를 마킹합니다.<br>
        ✅ 4. 가로/세로/대각선으로 5줄이 되면 승리합니다.<br>
        ✅ 5. 승리하면 자동으로 방이 종료됩니다.
      </p>
      <button onclick="closeModal()">게임 시작</button>
    </div>
  </div>
</body>
</html>
