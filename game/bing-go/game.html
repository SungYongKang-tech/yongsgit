<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë¹™ê³  ê²Œì„</title>
  <link rel="icon" href="data:,">
  <style>
    body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 10px; background:#f7f7f7; }
    #bingo-board {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 4px;
      max-width: 400px;
      margin: 20px auto;
    }
    .cell {
      border: 1px solid #ccc;
      padding: 15px;
      background-color: #f2f2f2;
      font-size: 20px;
      cursor: pointer;
      border-radius: 6px;
      user-select: none;
    }
    .cell.marked { background-color: #4CAF50; color: white; font-weight: bold; }

    #nickname-area button { height: 40px; font-size: 16px; padding: 5px 12px; }
    #nickname { height: 48px; font-size: 18px; padding: 5px 12px; box-sizing: border-box; }
    #nickname-area input { margin-right: 8px; }

    .modal {
      position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
    }
    .modal-content {
      background-color: white; padding: 24px; border-radius: 12px; width: 90%; max-width: 400px;
      box-shadow: 0 0 10px rgba(0,0,0,0.25); text-align: center;
    }
    .modal-content h2 { margin-top: 0; }
    .modal-content button {
      margin-top: 20px; padding: 10px 20px; font-size: 16px;
      background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer;
    }

    #score-board { max-width: 420px; margin: 10px auto; text-align: left; }
    #called-list { margin: 8px auto; color:#333; }
    #exit-button { padding:10px 16px; border:0; border-radius:8px; background:#444; color:#fff; cursor:pointer; }
  </style>
</head>
<body>
  <h2 id="room-title">ë¹™ê³  ê²Œì„</h2>

  <div id="nickname-area">
    <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" />
    <button onclick="registerPlayer()">ì…ì¥</button>
  </div>

  <audio id="btn-sound" src="name.mp3" preload="auto"></audio>
  <audio id="win-sound" src="win.mp3" preload="auto"></audio>
  <audio id="bingo-sound" src="binggo.mp3" preload="auto"></audio>
  <audio id="number-sound" src="number.mp3" preload="auto"></audio>

  <div id="game-area" style="display:none;">
    <h3 id="turn-info">ì°¨ë¡€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h3>
    <div id="bingo-board"></div>
    <div id="called-list"></div>
    <h4 id="bingo-count">ë¹™ê³ : 0ì¤„</h4>
    <div id="score-board"></div>
    <button id="exit-button" onclick="leaveRoom()" style="margin-top: 20px;">ë°© ë‚˜ê°€ê¸°</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase, ref, set, get, update, onValue, remove, onDisconnect
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import {
      getAuth, onAuthStateChanged, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.appspot.com",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:1f7246a5fa2d02c291a561"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // --- Room code ---
    const urlParams = new URLSearchParams(location.search);
    const roomCode = urlParams.get('room');
    document.getElementById('room-title').innerText = `ë°© ì½”ë“œ: ${roomCode}`;
    if (!roomCode) {
      alert('room íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      location.href = 'index.html';
    }

    // --- State ---
    let nickname = "";
    let myUid = null;
    let myRole = null; // 'A' | 'B'
    let turn = 'A';
    let calledNumbers = [];
    let board = [];
    let previousBingoCount = 0;

    // --- Auth ---
    async function ensureAnonAuth() {
      if (auth.currentUser) return auth.currentUser;
      return new Promise((resolve, reject) => {
        const unsub = onAuthStateChanged(auth, (u) => { if (u) { unsub(); resolve(u); }});
        signInAnonymously(auth).catch(reject);
      });
    }

    // --- UI helpers ---
    const $ = (id) => document.getElementById(id);

    // --- ì…ì¥ ---
    window.registerPlayer = async function () {
      nickname = $('nickname').value.trim();
      if (!nickname) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      $('btn-sound').play().catch(()=>{});

      const user = await ensureAnonAuth();
      myUid = user.uid;

      // ë°© ì •ë³´ ì¡°íšŒ
      const roomRef = ref(db, `rooms/${roomCode}`);
      const snap = await get(roomRef);
      if (!snap.exists()) {
        alert('ë°©ì´ ì—†ìŠµë‹ˆë‹¤.');
        location.href = 'index.html';
        return;
      }
      const data = snap.val() || {};
      const hostUid = data.hostUid || null;

      // --- A/B ìŠ¬ë¡¯ ë°°ì • ---
      const aRef = ref(db, `rooms/${roomCode}/players/A`);
      const bRef = ref(db, `rooms/${roomCode}/players/B`);
      const aSnap = await get(aRef);
      const bSnap = await get(bRef);

      // ë°©ì¥ì´ë©´ A, ì•„ë‹ˆë©´ Bê°€ ë¹„ì–´ìˆì„ ë•Œ B
      if (hostUid === myUid) {
        // Aê°€ ì—†ìœ¼ë©´ ë‚´ê°€ Aë¡œ
        if (!aSnap.exists()) await set(aRef, { name: nickname, uid: myUid });
        myRole = 'A';
      } else {
        if (!bSnap.exists()) {
          await set(bRef, { name: nickname, uid: myUid }); // ê·œì¹™ìƒ BëŠ” ë¹„ì–´ìˆì„ ë•Œ ëˆ„êµ¬ë‚˜ 1íšŒ ì‘ì„± ê°€ëŠ¥
          myRole = 'B';
        } else {
          // ì´ë¯¸ Bê°€ ìˆìœ¼ë©´ ë‚´ê°€ B ìê²©ì¸ì§€ í™•ì¸(ê°™ì€ uidë¡œ ì¬ì…ì¥)
          if (bSnap.val()?.uid === myUid) {
            myRole = 'B';
          } else if (aSnap.exists() && aSnap.val()?.uid === myUid) {
            myRole = 'A';
          } else {
            alert('ì…ì¥ ê°€ëŠ¥í•œ ìë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
        }
      }

      // ì´ˆê¸° í•„ë“œ ë³´ì •(ê°ì²´ ê²½ë¡œë¡œë§Œ ì—…ë°ì´íŠ¸: ë£¨íŠ¸ ì—…ë°ì´íŠ¸ ê¸ˆì§€)
      const patch = {};
      if (!Array.isArray(data.calledNumbers)) patch.calledNumbers = [];
      if (typeof data.turn !== 'string') patch.turn = 'A';
      if (data.status !== 'lobby') patch.status = 'lobby';
      if (Object.keys(patch).length) await update(roomRef, patch);

      // ì¤€ë¹„/ì ìˆ˜(ê°œì¸ í‚¤ì—ë§Œ ê¸°ë¡ â€” ê·œì¹™ í—ˆìš©)
      await set(ref(db, `rooms/${roomCode}/ready/${myUid}`), true);
      await set(ref(db, `rooms/${roomCode}/scores/${myUid}`), 0);

      // ì ‘ì† ì¢…ë£Œ ì‹œ ì •ë¦¬(ê°œì¸ ì˜ì—­ë§Œ)
      onDisconnect(ref(db, `rooms/${roomCode}/ready/${myUid}`)).remove();
      onDisconnect(ref(db, `rooms/${roomCode}/scores/${myUid}`)).remove();

      $('nickname-area').style.display = 'none';
      $('game-area').style.display = 'block';
      generateBoard();
      setupRealtime();
    };

    // --- ë¹™ê³ íŒ ìƒì„± ---
    function generateBoard() {
      const boardEl = $('bingo-board');
      const nums = Array.from({length: 75}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
      board = nums.slice(0, 25);
      boardEl.innerHTML = '';

      board.forEach(num => {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.innerText = num;
        cell.onclick = async () => {
          if (!myUid || !myRole) return;

          // ë‚´ ì°¨ë¡€ì¸ì§€ í™•ì¸
          if (turn !== myRole) return;

          const number = num;
          $('number-sound').play().catch(()=>{});

          // ì´ë¯¸ ë¶ˆë €ë˜ ìˆ«ìë©´ ë‚´ íŒë§Œ í‘œì‹œ ê°±ì‹ 
          if (calledNumbers.includes(number)) {
            cell.classList.add('marked');
            updateBingoCount();
            return;
          }

          // ë‹¤ìŒ í„´ ê³„ì‚°(Aâ†”B)
          const nextTurn = (myRole === 'A') ? 'B' : 'A';
          const newList = [...calledNumbers, number];

          // ë°© ìƒíƒœ ê°±ì‹ (ë¶€ëª¨ ê²½ë¡œì§€ë§Œ A/Bë§Œ í—ˆìš©ë˜ë¯€ë¡œ ê·œì¹™ ì¶©ì¡±)
          await update(ref(db, `rooms/${roomCode}`), {
            turn: nextTurn,
            lastMove: { number, by: myUid, at: Date.now() },
            calledNumbers: newList
          });
        };
        boardEl.appendChild(cell);
      });

      // ì´ë¯¸ ë¶€ë¥¸ ìˆ«ì ì´ˆê¸° ë§ˆí‚¹
      if (calledNumbers.length) {
        const cells = document.querySelectorAll('.cell');
        cells.forEach(c => {
          if (calledNumbers.includes(Number(c.innerText))) c.classList.add('marked');
        });
        updateBingoCount();
      }
    }

    // --- ë¹™ê³  ì¤„ìˆ˜ ê³„ì‚°/ì €ì¥ ---
    function updateBingoCount() {
      const cells = [...document.querySelectorAll('.cell')];
      const matrix = [];
      while (cells.length) matrix.push(cells.splice(0, 5));

      let bingo = 0;
      for (let i = 0; i < 5; i++) {
        if (matrix[i].every(c => c.classList.contains('marked'))) bingo++;
        if (matrix.map(r => r[i]).every(c => c.classList.contains('marked'))) bingo++;
      }
      if (matrix.map((r, i) => r[i]).every(c => c.classList.contains('marked'))) bingo++;
      if (matrix.map((r, i) => r[4 - i]).every(c => c.classList.contains('marked'))) bingo++;

      $('bingo-count').innerText = `ë¹™ê³ : ${bingo}ì¤„`;

      if (bingo > previousBingoCount) $('bingo-sound').play().catch(()=>{});
      previousBingoCount = bingo;

      // ì ìˆ˜ ì €ì¥ ë° ìš°ìŠ¹ ì¡°ê±´ ê²€ì‚¬
      if (myUid) set(ref(db, `rooms/${roomCode}/scores/${myUid}`), bingo);
      if (bingo >= 5) {
        const winnerRef = ref(db, `rooms/${roomCode}/winner`);
        get(winnerRef).then(s => {
          if (!s.exists()) set(winnerRef, myUid);
        });
      }
    }

    // --- ì‹¤ì‹œê°„ êµ¬ë… ---
    function setupRealtime() {
      const roomRef = ref(db, `rooms/${roomCode}`);
      onValue(roomRef, snapshot => {
        const data = snapshot.val() || {};
        const players = data.players || {};
        const resolveName = (roleOrUid) => {
          if (roleOrUid === 'A' || roleOrUid === 'B') return players?.[roleOrUid]?.name || '...';
          // uid ì ìˆ˜íŒ í‘œì‹œìš©
          const matchRole = (players.A?.uid === roleOrUid) ? 'A'
                            : (players.B?.uid === roleOrUid) ? 'B' : null;
          return matchRole ? players[matchRole].name : '...';
        };

        turn = typeof data.turn === 'string' ? data.turn : 'A';
        calledNumbers = Array.isArray(data.calledNumbers) ? data.calledNumbers : [];

        // ìš°ìŠ¹ ì²˜ë¦¬
        if (data.winner) {
          if (data.winner === myUid) $('win-sound').play().catch(()=>{});
          $('turn-info').innerText = `ğŸ‰ ìš°ìŠ¹ì: ${resolveName(data.winner)} ë‹˜ì´ ë¹™ê³  5ì¤„ë¡œ ìŠ¹ë¦¬!`;
          document.querySelectorAll('.cell').forEach(cell => cell.style.pointerEvents = 'none');
          setTimeout(() => {
            alert("ê²Œì„ì´ ì¢…ë£Œë˜ì–´ ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            remove(ref(db, `rooms/${roomCode}`)).then(() => {
              window.location.href = "index.html";
            });
          }, 5000);
        } else {
          $('turn-info').innerText = `í˜„ì¬ ì°¨ë¡€: ${resolveName(turn)}`;
        }

        // í˜¸ì¶œ ìˆ«ì ë¦¬ìŠ¤íŠ¸ UI
        $('called-list').innerText = calledNumbers.length
          ? `ë¶€ë¥¸ ìˆ«ì: ${calledNumbers.join(", ")}`
          : 'ë¶€ë¥¸ ìˆ«ì ì—†ìŒ';

        // ë‚´ ë³´ë“œì— ë§ˆí‚¹ ë°˜ì˜
        document.querySelectorAll('.cell').forEach(cell => {
          const n = Number(cell.innerText);
          if (calledNumbers.includes(n)) cell.classList.add('marked');
        });
        updateBingoCount();

        // ì ìˆ˜íŒ
        const sb = $('score-board');
        sb.innerHTML = '';
        if (data.scores) {
          const entries = Object.entries(data.scores)
            .map(([uid, sc]) => ({ name: resolveName(uid), sc: Number(sc)||0 }))
            .sort((a,b)=>b.sc-a.sc);
          sb.innerHTML = '<h4>ì ìˆ˜íŒ</h4>' +
            entries.map(e => `<div>${e.name}: ${e.sc}ì¤„</div>`).join('');
        }

        // ë‹¤ë¥¸ ì°¸ê°€ìë„ 5ì¤„ì´ ë˜ë©´ ìš°ìŠ¹ í™•ì •
        if (!data.winner && data.scores) {
          for (const uid in data.scores) {
            if (Number(data.scores[uid]) >= 5) {
              set(ref(db, `rooms/${roomCode}/winner`), uid);
              break;
            }
          }
        }
      });
    }

    // --- ë‚˜ê°€ê¸° ---
    window.leaveRoom = async function () {
      if (!myUid || !roomCode) return;

      // ready/scoresë§Œ ì •ë¦¬ (players A/BëŠ” ê·œì¹™ìƒ ì•„ë¬´ë‚˜ ì§€ìš°ì§€ ì•Šë„ë¡ ìœ ì§€)
      await remove(ref(db, `rooms/${roomCode}/ready/${myUid}`));
      await remove(ref(db, `rooms/${roomCode}/scores/${myUid}`));

      // ë°©ì¥ì´ê³  ìƒëŒ€ê°€ ì—†ë‹¤ë©´ ë°© ì‚­ì œ
      const roomRef = ref(db, `rooms/${roomCode}`);
      const snap = await get(roomRef);
      const data = snap.val() || {};
      const players = data.players || {};
      const others =
        [players.A?.uid, players.B?.uid].filter(u => !!u && u !== myUid);

      if (data.hostUid === myUid && others.length === 0) {
        await remove(roomRef);
      }

      alert("ë°©ì—ì„œ ë‚˜ê°‘ë‹ˆë‹¤.");
      window.location.href = "index.html";
    };

    // --- ëª¨ë‹¬ ---
    window.addEventListener('DOMContentLoaded', () => {
      $('modal').style.display = 'flex';
    });
    window.closeModal = function () { $('modal').style.display = 'none'; };
  </script>

  <!-- ê²Œì„ ì„¤ëª… ëª¨ë‹¬ -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2>ë¹™ê³  ê²Œì„ ì„¤ëª…</h2>
      <p>
        âœ… 1. ë‹‰ë„¤ì„ì„ ì…ë ¥ í›„ ì…ì¥í•˜ì„¸ìš”.<br>
        âœ… 2. ê°ì 5x5 ë¹™ê³ íŒì´ ëœë¤ ìƒì„±ë©ë‹ˆë‹¤.<br>
        âœ… 3. ìì‹ ì˜ ì°¨ë¡€(ìƒë‹¨ í‘œì‹œ)ì— ìˆ«ìë¥¼ í´ë¦­í•˜ë©´ ëª¨ë‘ê°€ ê·¸ ìˆ«ìë¥¼ ë§ˆí‚¹í•©ë‹ˆë‹¤.<br>
        âœ… 4. ê°€ë¡œ/ì„¸ë¡œ/ëŒ€ê°ì„ ìœ¼ë¡œ 5ì¤„ì´ ë˜ë©´ ìŠ¹ë¦¬í•©ë‹ˆë‹¤.<br>
        âœ… 5. ìŠ¹ë¦¬í•˜ë©´ ìë™ìœ¼ë¡œ ë°©ì´ ì¢…ë£Œë©ë‹ˆë‹¤.
      </p>
      <button onclick="closeModal()">ê²Œì„ ì‹œì‘</button>
    </div>
  </div>
</body>
</html>
