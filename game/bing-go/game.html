<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë¹™ê³  ê²Œì„</title>
  <link rel="icon" href="data:,">
  <style>
    body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 10px; background:#f7f7f7; }
    #bingo-board {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 4px;
      max-width: 400px;
      margin: 20px auto;
    }
    .cell {
      border: 1px solid #ccc;
      padding: 15px;
      background-color: #f2f2f2;
      font-size: 20px;
      cursor: pointer;
      border-radius: 6px;
      user-select: none;
    }
    .cell.marked { background-color: #4CAF50; color: white; font-weight: bold; }

    #nickname-area button { height: 40px; font-size: 16px; padding: 5px 12px; }
    #nickname { height: 48px; font-size: 18px; padding: 5px 12px; box-sizing: border-box; }
    #nickname-area input { margin-right: 8px; }

    .modal {
      position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
    }
    .modal-content {
      background-color: white; padding: 24px; border-radius: 12px; width: 90%; max-width: 400px;
      box-shadow: 0 0 10px rgba(0,0,0,0.25); text-align: center;
    }
    .modal-content h2 { margin-top: 0; }
    .modal-content button {
      margin-top: 20px; padding: 10px 20px; font-size: 16px;
      background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer;
    }

    #score-board { max-width: 420px; margin: 10px auto; text-align: left; }
    #called-list { margin: 8px auto; color:#333; }
    #exit-button { padding:10px 16px; border:0; border-radius:8px; background:#444; color:#fff; cursor:pointer; }
  </style>
</head>
<body>
  <h2 id="room-title">ë¹™ê³  ê²Œì„</h2>

  <div id="nickname-area">
    <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" />
    <button onclick="registerPlayer()">ì…ì¥</button>
  </div>

  <audio id="btn-sound" src="name.mp3" preload="auto"></audio>
  <audio id="win-sound" src="win.mp3" preload="auto"></audio>
  <audio id="bingo-sound" src="binggo.mp3" preload="auto"></audio>
  <audio id="number-sound" src="number.mp3" preload="auto"></audio>

  <div id="game-area" style="display:none;">
    <h3 id="turn-info">ì°¨ë¡€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h3>
    <div id="bingo-board"></div>
    <div id="called-list"></div>
    <h4 id="bingo-count">ë¹™ê³ : 0ì¤„</h4>
    <div id="score-board"></div>
    <button id="exit-button" onclick="leaveRoom()" style="margin-top: 20px;">ë°© ë‚˜ê°€ê¸°</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase, ref, set, get, update, onValue, child, remove, onDisconnect
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import {
      getAuth, onAuthStateChanged, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.appspot.com",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:1f7246a5fa2d02c291a561"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // --- Room code ---
    const urlParams = new URLSearchParams(location.search);
    const roomCode = urlParams.get('room');
    document.getElementById('room-title').innerText = `ë°© ì½”ë“œ: ${roomCode}`;
    if (!roomCode) {
      alert('room íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      location.href = 'index.html';
    }

    // --- State ---
    let nickname = "";
    let myUid = null;
    let myTurn = -1;
    let currentTurn = 0;
    let calledNumbers = []; // ê³µìœ ë˜ëŠ” í˜¸ì¶œ ë²ˆí˜¸
    let board = [];
    let previousBingoCount = 0;

    // --- Auth ---
    async function ensureAnonAuth() {
      if (auth.currentUser) return auth.currentUser;
      return new Promise((resolve, reject) => {
        const unsub = onAuthStateChanged(auth, (u) => { if (u) { unsub(); resolve(u); }});
        signInAnonymously(auth).catch(reject);
      });
    }

    // --- UI helpers ---
    const $ = (id) => document.getElementById(id);

    // --- ì…ì¥ ---
    window.registerPlayer = async function () {
      nickname = $('nickname').value.trim();
      if (!nickname) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      $('btn-sound').play().catch(()=>{});

      const user = await ensureAnonAuth();
      myUid = user.uid;

      // ë°© ê¸°ë³¸ êµ¬ì¡° ë³´ì • (ëˆ„ë½ ì‹œ)
      const baseUpdates = {};
      const roomSnap = await get(ref(db, `rooms/${roomCode}`));
      const rv = roomSnap.val() || {};
      if (!('players' in rv)) baseUpdates[`rooms/${roomCode}/players`] = {};
      if (!('playersOrder' in rv)) baseUpdates[`rooms/${roomCode}/playersOrder`] = [];
      if (!('ready' in rv)) baseUpdates[`rooms/${roomCode}/ready`] = {};
      if (!('scores' in rv)) baseUpdates[`rooms/${roomCode}/scores`] = {};
      if (!('calledNumbers' in rv)) baseUpdates[`rooms/${roomCode}/calledNumbers`] = [];
      if (!('currentTurn' in rv)) baseUpdates[`rooms/${roomCode}/currentTurn`] = 0;
      if (Object.keys(baseUpdates).length) await update(ref(db), baseUpdates);

      // ë‚´ ì •ë³´ ê¸°ë¡ (uid í‚¤)
      await set(ref(db, `rooms/${roomCode}/players/${myUid}`), {
        name: nickname, joinedAt: Date.now()
      });

      // playersOrderì— ë‚´ uidê°€ ì—†ìœ¼ë©´ ì¶”ê°€
      const orderRef = ref(db, `rooms/${roomCode}/playersOrder`);
      const orderSnap = await get(orderRef);
      const order = orderSnap.val() || [];
      if (!order.includes(myUid)) {
        order.push(myUid);
        await set(orderRef, order);
      }
      // ë‚´ í„´ ì¸ë±ìŠ¤ ê³„ì‚°
      myTurn = (order || []).indexOf(myUid);

      // ready/scores ì„¸íŒ…
      await set(ref(db, `rooms/${roomCode}/ready/${myUid}`), true);
      await set(ref(db, `rooms/${roomCode}/scores/${myUid}`), 0);

      // ì ‘ì† ì¢…ë£Œ ì‹œ ì •ë¦¬(ì„ íƒ)
      onDisconnect(ref(db, `rooms/${roomCode}/players/${myUid}`)).remove();
      onDisconnect(ref(db, `rooms/${roomCode}/ready/${myUid}`)).remove();
      onDisconnect(ref(db, `rooms/${roomCode}/scores/${myUid}`)).remove();

      $('nickname-area').style.display = 'none';
      $('game-area').style.display = 'block';
      generateBoard();
      setupRealtime();
    };

    // --- ë¹™ê³ íŒ ìƒì„± ---
    function generateBoard() {
      const boardEl = $('bingo-board');
      const nums = Array.from({length: 75}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
      board = nums.slice(0, 25);
      boardEl.innerHTML = '';

      board.forEach(num => {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.innerText = num;
        cell.onclick = async () => {
          if (myUid == null) return;
          if (myTurn !== currentTurn) return; // ë‚´ ì°¨ë¡€ê°€ ì•„ë‹ˆë©´ ë¬´ì‹œ

          const number = num;
          $('number-sound').play().catch(()=>{});

          // ì´ë¯¸ ë¶ˆë €ë˜ ìˆ«ìë©´ ë‚´ íŒë§Œ í‘œì‹œ ê°±ì‹ 
          if (calledNumbers.includes(number)) {
            cell.classList.add('marked');
            updateBingoCount();
            return;
          }

          // í„´ ì§„í–‰
          const orderSnap = await get(ref(db, `rooms/${roomCode}/playersOrder`));
          const order = orderSnap.val() || [];
          const nextTurn = order.length ? (currentTurn + 1) % order.length : 0;

          const newList = calledNumbers.includes(number)
            ? calledNumbers
            : [...calledNumbers, number];

          await update(ref(db, `rooms/${roomCode}`), {
            currentTurn: nextTurn,
            lastNumber: number,
            calledNumbers: newList,
            lastCaller: myUid
          });
        };
        boardEl.appendChild(cell);
      });

      // ì´ë¯¸ ë¶€ë¥¸ ìˆ«ìê°€ ìˆìœ¼ë©´ ì´ˆê¸° ë§ˆí‚¹
      if (calledNumbers.length) {
        const cells = document.querySelectorAll('.cell');
        cells.forEach(c => {
          if (calledNumbers.includes(Number(c.innerText))) c.classList.add('marked');
        });
        updateBingoCount();
      }
    }

    // --- ë¹™ê³  ì¤„ìˆ˜ ê³„ì‚°/ì €ì¥ ---
    function updateBingoCount() {
      const cells = [...document.querySelectorAll('.cell')];
      const matrix = [];
      while (cells.length) matrix.push(cells.splice(0, 5));

      let bingo = 0;
      for (let i = 0; i < 5; i++) {
        if (matrix[i].every(c => c.classList.contains('marked'))) bingo++;
        if (matrix.map(r => r[i]).every(c => c.classList.contains('marked'))) bingo++;
      }
      if (matrix.map((r, i) => r[i]).every(c => c.classList.contains('marked'))) bingo++;
      if (matrix.map((r, i) => r[4 - i]).every(c => c.classList.contains('marked'))) bingo++;

      $('bingo-count').innerText = `ë¹™ê³ : ${bingo}ì¤„`;

      // ìƒˆ ì¤„ì´ ìƒê²¼ì„ ë•Œë§Œ ì†Œë¦¬
      if (bingo > previousBingoCount) $('bingo-sound').play().catch(()=>{});
      previousBingoCount = bingo;

      // ì ìˆ˜ ì €ì¥ ë° ìš°ìŠ¹ ì¡°ê±´ ê²€ì‚¬
      if (myUid) set(ref(db, `rooms/${roomCode}/scores/${myUid}`), bingo);
      if (bingo >= 5) {
        const winnerRef = ref(db, `rooms/${roomCode}/winner`);
        get(winnerRef).then(s => {
          if (!s.exists()) set(winnerRef, myUid);
        });
      }
    }

    // --- ì‹¤ì‹œê°„ êµ¬ë… ---
    function setupRealtime() {
      const roomRef = ref(db, `rooms/${roomCode}`);
      onValue(roomRef, snapshot => {
        const data = snapshot.val() || {};
        const playersMap = data.players || {};
        const resolveName = (uid) => playersMap?.[uid]?.name || '...';

        currentTurn = data.currentTurn || 0;
        calledNumbers = Array.isArray(data.calledNumbers) ? data.calledNumbers : [];

        // í˜„ì¬ ë‚´ í„´ ì¸ë±ìŠ¤ ì¬ê³„ì‚°(ì°¸ê°€ì ë³€í™” ëŒ€ì‘)
        const order = data.playersOrder || [];
        myTurn = order.indexOf(myUid);

        // ìš°ìŠ¹ ì²˜ë¦¬
        if (data.winner) {
          if (data.winner === myUid) $('win-sound').play().catch(()=>{});
          $('turn-info').innerText = `ğŸ‰ ìš°ìŠ¹ì: ${resolveName(data.winner)} ë‹˜ì´ ë¹™ê³  5ì¤„ë¡œ ìŠ¹ë¦¬!`;

          // í´ë¦­ ë§‰ê¸°
          document.querySelectorAll('.cell').forEach(cell => cell.style.pointerEvents = 'none');

          // ì ì‹œ í›„ ë°© ì‚­ì œ â†’ ë¡œë¹„ë¡œ ì´ë™
          setTimeout(() => {
            alert("ê²Œì„ì´ ì¢…ë£Œë˜ì–´ ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            remove(ref(db, `rooms/${roomCode}`)).then(() => {
              window.location.href = "index.html";
            });
          }, 5000);
        } else {
          // ì •ìƒ ì§„í–‰: í˜„ì¬ ì°¨ë¡€ í‘œì‹œ
          const uidTurn = order[currentTurn];
          $('turn-info').innerText = `í˜„ì¬ ì°¨ë¡€: ${resolveName(uidTurn)}`;
        }

        // í˜¸ì¶œ ìˆ«ì ë¦¬ìŠ¤íŠ¸ UI
        $('called-list').innerText = calledNumbers.length
          ? `ë¶€ë¥¸ ìˆ«ì: ${calledNumbers.join(", ")}`
          : 'ë¶€ë¥¸ ìˆ«ì ì—†ìŒ';

        // ë‚´ ë³´ë“œì— ë§ˆí‚¹ ë°˜ì˜
        document.querySelectorAll('.cell').forEach(cell => {
          const n = Number(cell.innerText);
          if (calledNumbers.includes(n)) cell.classList.add('marked');
        });
        updateBingoCount();

        // ì ìˆ˜íŒ
        const sb = $('score-board');
        sb.innerHTML = '';
        if (data.scores) {
          const entries = Object.entries(data.scores)
            .map(([uid, sc]) => ({ name: resolveName(uid), sc: Number(sc)||0 }))
            .sort((a,b)=>b.sc-a.sc);
          sb.innerHTML = '<h4>ì ìˆ˜íŒ</h4>' +
            entries.map(e => `<div>${e.name}: ${e.sc}ì¤„</div>`).join('');
        }

        // ë‹¤ë¥¸ ì°¸ê°€ìë„ 5ì¤„ì´ ë˜ë©´ ìš°ìŠ¹ í™•ì •
        if (!data.winner && data.scores) {
          for (const uid in data.scores) {
            if (Number(data.scores[uid]) >= 5) {
              set(ref(db, `rooms/${roomCode}/winner`), uid);
              break;
            }
          }
        }
      });
    }

    // --- ë‚˜ê°€ê¸° ---
    window.leaveRoom = function () {
      if (!myUid || !roomCode) return;

      const playerRef = ref(db, `rooms/${roomCode}/players/${myUid}`);
      const orderRef  = ref(db, `rooms/${roomCode}/playersOrder`);

      remove(playerRef).then(async () => {
        const snap = await get(orderRef);
        const order = snap.val() || [];
        const newOrder = order.filter(uid => uid !== myUid);
        await set(orderRef, newOrder);
        await remove(ref(db, `rooms/${roomCode}/ready/${myUid}`));
        await remove(ref(db, `rooms/${roomCode}/scores/${myUid}`));

        // ë°©ì— ì•„ë¬´ë„ ì—†ìœ¼ë©´ ë°© ì‚­ì œ
        const pSnap = await get(ref(db, `rooms/${roomCode}/players`));
        if (!pSnap.exists() || Object.keys(pSnap.val()).length === 0) {
          await remove(ref(db, `rooms/${roomCode}`));
        }

        alert("ë°©ì—ì„œ ë‚˜ê°‘ë‹ˆë‹¤.");
        window.location.href = "index.html";
      });
    };

    // --- ëª¨ë‹¬ ---
    window.addEventListener('DOMContentLoaded', () => {
      $('modal').style.display = 'flex';
    });
    window.closeModal = function () { $('modal').style.display = 'none'; };
  </script>

  <!-- ê²Œì„ ì„¤ëª… ëª¨ë‹¬ -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2>ë¹™ê³  ê²Œì„ ì„¤ëª…</h2>
      <p>
        âœ… 1. ë‹‰ë„¤ì„ì„ ì…ë ¥ í›„ ì…ì¥í•˜ì„¸ìš”.<br>
        âœ… 2. ê°ì 5x5 ë¹™ê³ íŒì´ ëœë¤ ìƒì„±ë©ë‹ˆë‹¤.<br>
        âœ… 3. ìì‹ ì˜ ì°¨ë¡€ì— ìˆ«ìë¥¼ í´ë¦­í•˜ë©´ ëª¨ë‘ê°€ ê·¸ ìˆ«ìë¥¼ ë§ˆí‚¹í•©ë‹ˆë‹¤.<br>
        âœ… 4. ê°€ë¡œ/ì„¸ë¡œ/ëŒ€ê°ì„ ìœ¼ë¡œ 5ì¤„ì´ ë˜ë©´ ìŠ¹ë¦¬í•©ë‹ˆë‹¤.<br>
        âœ… 5. ìŠ¹ë¦¬í•˜ë©´ ìë™ìœ¼ë¡œ ë°©ì´ ì¢…ë£Œë©ë‹ˆë‹¤.
      </p>
      <button onclick="closeModal()">ê²Œì„ ì‹œì‘</button>
    </div>
  </div>
</body>
</html>
