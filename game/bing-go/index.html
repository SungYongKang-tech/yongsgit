<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë¹™ê³  ê²Œì„ - ë°© ì…ì¥</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f9f9f9;
      padding: 20px;
      text-align: center;
      color-scheme: light only; /* ë‹¤í¬ëª¨ë“œ ê°•ì œ ë°©ì§€ (ì„ íƒ) */
    }
    h1 { color: #333; }
    button, input {
      padding: 12px;
      margin: 10px;
      font-size: 16px;
      width: 80%;
      max-width: 300px;
    }
    input {
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background-color: #45a049; }

    /* ëª¨ë‹¬ íŒì—… ìŠ¤íƒ€ì¼ */
    .modal {
      display: block; /* í˜ì´ì§€ ë¡œë“œ ì‹œ ë³´ì—¬ì¤Œ */
      position: fixed;
      z-index: 9999;
      left: 0; top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 15% auto;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <h1>ë¹™ê³  ê²Œì„ - ë°© ì…ì¥</h1>

  <button id="createBtn" onclick="createRoom()">ğŸ”§ ë°© ìƒì„±</button><br/>
  <button id="autoBtn" onclick="autoJoin()">â± ìë™ ì…ì¥ (1ë¶„ ì´ë‚´)</button><br/>

  <!-- ìˆ«ì 4ìë¦¬ë§Œ ë°›ë„ë¡ ë³´ì¡° ì˜µì…˜ ì¶”ê°€ -->
  <input type="text" id="roomCodeInput" inputmode="numeric" pattern="[0-9]*" placeholder="4ìë¦¬ ë°© ì½”ë“œ ì…ë ¥" />
  <button id="manualBtn" onclick="manualJoin()">ğŸ”‘ ìˆ˜ë™ ì…ì¥</button>

  <script type="module">
    // --- Firebase ì—°ë™ ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getDatabase, ref, set, get, query, orderByChild, startAt, limitToLast 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    // â˜… ì¶”ê°€: ìµëª… ë¡œê·¸ì¸ìš© Auth ëª¨ë“ˆ
    import { 
      getAuth, onAuthStateChanged, signInAnonymously 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.appspot.com",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:1f7246a5fa2d02c291a561"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // ì…ë ¥ë€: ìˆ«ìë§Œ & 4ìë¦¬ ì œí•œ
    const codeInput = document.getElementById('roomCodeInput');
    codeInput.addEventListener('input', () => {
      codeInput.value = codeInput.value.replace(/\D/g, '').slice(0, 4);
    });

    // ë²„íŠ¼ë“¤ (ë¡œê·¸ì¸ ì „ í´ë¦­ ë°©ì§€í•˜ê³  ì‹¶ìœ¼ë©´ ì ê¹ ë¹„í™œì„±í™”)
    const buttons = [document.getElementById('createBtn'), document.getElementById('autoBtn'), document.getElementById('manualBtn')];
    // buttons.forEach(b => b.disabled = true); // í•„ìš”ì‹œ ì£¼ì„ í•´ì œ

    // â˜… ì¶”ê°€: ìµëª… ë¡œê·¸ì¸ ë³´ì¥ í•¨ìˆ˜
    async function ensureAnonAuth() {
      const user = auth.currentUser;
      if (user) return user;

      return new Promise((resolve, reject) => {
        const unsub = onAuthStateChanged(auth, (u) => {
          if (u) {
            unsub();
            resolve(u);
          }
        });
        signInAnonymously(auth).catch((e) => {
          console.error('ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨:', e);
          reject(e);
        });
      });
    }

    // ì´ˆê¸° ë¡œê·¸ì¸ ì‹œë„ (UIì— "ë¡œê·¸ì¸ í™•ì¸ì¤‘" ê°™ì€ ë¬¸êµ¬ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ)
    ensureAnonAuth()
      .then(() => {
        // buttons.forEach(b => b.disabled = false); // í•„ìš”ì‹œ ì£¼ì„ í•´ì œ
      })
      .catch(() => {
        alert('ë¡œê·¸ì¸ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      });

    // --- ë°© ìƒì„± ---
    window.createRoom = async function () {
      const user = await ensureAnonAuth();
      const code = Math.floor(1000 + Math.random() * 9000).toString();
      const createdAt = Date.now();

      // â˜… hostUid ë¥¼ ê¸°ë¡ (ëˆ„ê°€ ë§Œë“  ë°©ì¸ì§€ ì¶”ì  ê°€ëŠ¥)
      await set(ref(db, `rooms/${code}`), {
        createdAt,
        hostUid: user.uid,
        status: 'lobby'
      });

      alert(`ë°©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ì½”ë“œ: ${code}`);
      window.location.href = `game.html?room=${code}`;
    };

    // --- ìë™ ì…ì¥ (ìµœê·¼ 1ë¶„ ë‚´ ìƒì„±ëœ ìµœì‹  ë°© 1ê°œ ì¡°íšŒ) ---
    window.autoJoin = async function () {
      await ensureAnonAuth();

      const now = Date.now();
      const recentQ = query(
        ref(db, 'rooms'),
        orderByChild('createdAt'),
        startAt(now - 60_000),
        limitToLast(1) // ìµœì‹  1ê°œë§Œ
      );

      try {
        const snap = await get(recentQ);
        if (!snap.exists()) {
          alert("1ë¶„ ì´ë‚´ ìƒì„±ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        // limitToLast(1)ì´ë¯€ë¡œ ë‹¨ í•˜ë‚˜ë§Œ ìˆœíšŒ
        let targetCode = null;
        snap.forEach(child => { targetCode = child.key; });
        if (!targetCode) {
          alert("ì…ì¥ ê°€ëŠ¥í•œ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        window.location.href = `game.html?room=${targetCode}`;
      } catch (error) {
        console.error("ìë™ ì…ì¥ ì˜¤ë¥˜:", error);
        alert("ìë™ ì…ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    };

    // --- ìˆ˜ë™ ì…ì¥ ---
    window.manualJoin = async function () {
      await ensureAnonAuth();

      const code = codeInput.value;
      if (!code || code.length !== 4) {
        alert("4ìë¦¬ ìˆ«ì ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      try {
        const roomSnap = await get(ref(db, `rooms/${code}`));
        if (!roomSnap.exists()) {
          alert("í•´ë‹¹ ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
        }
        window.location.href = `game.html?room=${code}`;
      } catch (error) {
        console.error("ìˆ˜ë™ ì…ì¥ ì˜¤ë¥˜:", error);
        alert("ìˆ˜ë™ ì…ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    };

    // ëª¨ë‹¬ ë‹«ê¸°
    window.closeModal = function () {
      document.getElementById('modal').style.display = 'none';
    };
  </script>

  <!-- ê²Œì„ ì„¤ëª… ëª¨ë‹¬ -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2>ê²Œì„ ì„¤ëª…</h2>
      <p>
        1) ã€Œë°© ìƒì„±ã€ìœ¼ë¡œ 4ìë¦¬ ìˆ«ì ë°©ì„ ë§Œë“­ë‹ˆë‹¤.<br/>
        2) ì¹œêµ¬ëŠ” ã€Œìˆ˜ë™ ì…ì¥ã€ ë˜ëŠ” ã€Œìë™ ì…ì¥ã€ìœ¼ë¡œ ê°™ì€ ë°©ì— ë“¤ì–´ì˜µë‹ˆë‹¤.<br/>
        3) ìƒì„± í›„ 1ë¶„ ë‚´ì¸ ë°©ì€ ã€Œìë™ ì…ì¥ã€ìœ¼ë¡œ ë°”ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.<br/>
        4) ê²Œì„ì€ <code>game.html</code>ì—ì„œ ì‹œì‘ë©ë‹ˆë‹¤.
      </p>
      <button onclick="closeModal()">ì‹œì‘í•˜ê¸°</button>
    </div>
  </div>
</body>
</html>
