<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>빙고 게임 - 방 입장</title>
  <style>
    :root{
      --bg1:#eef6ff;
      --bg2:#fff4f7;
      --card:#ffffff;
      --primary:#4CAF50;
      --primary-press:#45a049;
      --text:#2c3e50;
      --muted:#748599;
      --shadow:0 12px 30px rgba(0,0,0,0.12);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Segoe UI', system-ui, -apple-system, sans-serif;
      background: radial-gradient(1200px 800px at 0% 0%, var(--bg1), transparent),
                  radial-gradient(1200px 800px at 100% 100%, var(--bg2), transparent),
                  linear-gradient(180deg,#f7fbff,#fff);
      min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      padding:24px;
      color:var(--text);
    }
    .card{
      width:100%;
      max-width:480px;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:28px 22px;
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    h1{
      font-size:clamp(22px,5.2vw,28px);
      margin:0 0 8px 0;
      letter-spacing:-0.3px;
    }
    p.subtitle{
      margin:0 0 18px 0;
      color:var(--muted);
      font-size:14px;
    }
    .btn{
      width:100%;
      padding:14px 16px;
      border:none; cursor:pointer;
      font-size:16px; font-weight:600;
      border-radius:12px;
      transition:transform .06s ease, box-shadow .2s ease, background .2s;
      box-shadow:0 8px 18px rgba(76,175,80,.18);
      background:var(--primary); color:#fff;
    }
    .btn:active{ transform:translateY(1px); background:var(--primary-press) }
    .btn.secondary{
      background:#2563eb; box-shadow:0 8px 18px rgba(37,99,235,.18);
    }
    .btn.secondary:active{ background:#1e54c8 }
    .grid{
      display:grid; gap:12px; margin:16px 0;
      grid-template-columns:1fr;
    }
    .row{ display:flex; gap:10px }
    input{
      width:100%; padding:14px 12px; font-size:16px;
      border:1px solid #e5e7eb; border-radius:12px; outline:none;
      background:#f9fafb;
    }
    input:focus{ border-color:#60a5fa; background:#fff; box-shadow:0 0 0 3px rgba(96,165,250,.2) }
    .hint{ color:var(--muted); font-size:12px; margin-top:4px }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px; background:#f1f5f9;
      color:#334155; font-weight:600; font-size:13px; margin:0 auto 10px;
    }
    /* Modal */
    .modal{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.45); z-index:50;
      animation:fade .18s ease both;
    }
    @keyframes fade{ from{opacity:0} to{opacity:1} }
    .modal-content{
      width:min(92vw,460px); background:#fff; border-radius:16px; padding:22px;
      box-shadow:var(--shadow);
    }
    .modal-content h2{ margin:0 0 10px; font-size:20px }
    .modal-content p{ margin:10px 0; color:#475569; font-size:14px; line-height:1.6 }
    .modal-content .btn{ margin-top:8px }
    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:22px; transform:translateX(-50%);
      background:#111827; color:#fff; padding:10px 14px; border-radius:999px;
      font-size:14px; opacity:0; pointer-events:none; transition:opacity .2s, transform .2s;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px) }
  </style>
</head>
<body>
  <div class="card">
    <h1>빙고 게임</h1>
    <p class="subtitle">친구와 같은 방에 들어가서 차례대로 숫자를 불러 빙고를 완성해 보세요!</p>

    <div class="grid">
      <button class="btn" id="createBtn">🔧 방 생성</button>
      <button class="btn secondary" id="autoBtn">⏱ 자동 입장 (최근 1분)</button>
      <div>
        <div class="row">
          <input type="number" inputmode="numeric" pattern="[0-9]*" id="roomCodeInput" placeholder="4자리 방 코드 입력" />
          <button class="btn" id="joinBtn" style="flex:0 0 38%;">🔑 입장</button>
        </div>
        <div class="hint">방 코드는 4자리 숫자입니다.</div>
      </div>
      <div class="pill">ⓘ 새로 만든 방은 1분 동안 자동 입장이 가능합니다</div>
    </div>
  </div>

  <div id="toast" class="toast">복사되었습니다</div>

  <!-- 안내 모달 -->
  <div id="modal" class="modal" style="display:block;">
    <div class="modal-content">
      <h2>게임 방법</h2>
      <p>1) <b>방 생성</b>으로 4자리 방을 만들고, 코드를 친구에게 공유하세요.<br>
         2) 친구는 <b>수동 입장</b> 또는 <b>자동 입장</b>으로 같은 방에 들어옵니다.<br>
         3) 게임은 <b>game.html</b>에서 시작되며, <b>차례</b>에 숫자를 눌러 모두가 마킹합니다.<br>
         4) <b>5줄</b> 완성 시 승리! 🎉</p>
      <button class="btn" id="modalClose">시작하기</button>
    </div>
  </div>

  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase, ref, set, get, update, remove,
      query, orderByChild, startAt, runTransaction
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.appspot.com",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:1f7246a5fa2d02c291a561"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const $ = s => document.querySelector(s);
    const toast = (msg) => {
      const el = $("#toast");
      el.textContent = msg;
      el.classList.add("show");
      setTimeout(() => el.classList.remove("show"), 1600);
    };

    $("#modalClose").onclick = () => { $("#modal").style.display = "none"; };

    // 방 생성
    $("#createBtn").onclick = async () => {
      try {
        const code = String(Math.floor(1000 + Math.random() * 9000));
        const createdAt = Date.now();
        await set(ref(db, `rooms/${code}`), {
          createdAt,
          status: "waiting",
          calledNumbers: [],
          currentTurn: 0,
          playersOrder: [],
          players: {},
          scores: {}
        });
        // 코드를 자동 복사(가능한 환경에서)
        try {
          await navigator.clipboard.writeText(code);
          toast(`방 생성! 코드 ${code} (클립보드 복사됨)`);
        } catch { toast(`방 생성! 코드 ${code}`); }
        // 이동
        window.location.href = `game.html?room=${code}`;
      } catch (e) {
        alert("방 생성 중 오류가 발생했습니다.");
        console.error(e);
      }
    };

    // 최근 1분 이내 방 자동 입장
    $("#autoBtn").onclick = async () => {
      try {
        const threshold = Date.now() - 60_000;
        const q = query(ref(db, "rooms"), orderByChild("createdAt"), startAt(threshold));
        const snap = await get(q);
        if (!snap.exists()) { alert("1분 이내 생성된 방이 없습니다."); return; }

        // 가장 최근 방으로 입장
        let latest = null;
        snap.forEach(child => {
          const val = child.val();
          if (!latest || (val.createdAt > latest.createdAt)) {
            latest = { code: child.key, createdAt: val.createdAt };
          }
        });
        if (!latest) { alert("입장 가능한 방이 없습니다."); return; }
        window.location.href = `game.html?room=${latest.code}`;
      } catch (e) {
        console.error(e);
        alert("자동 입장 중 오류가 발생했습니다.");
      }
    };

    // 수동 입장
    $("#joinBtn").onclick = async () => {
      const code = $("#roomCodeInput").value.trim();
      if (!/^\d{4}$/.test(code)) {
        alert("4자리 숫자 코드를 입력하세요.");
        return;
      }
      try {
        const snap = await get(ref(db, `rooms/${code}`));
        if (!snap.exists()) { alert("해당 방이 존재하지 않습니다."); return; }
        window.location.href = `game.html?room=${code}`;
      } catch (e) {
        console.error(e);
        alert("입장 중 오류가 발생했습니다.");
      }
    };

    // 오래된 방 정리(옵션): 12시간 이상 된 방 제거
    (async function cleanupOldRooms(){
      try{
        const cutoff = Date.now() - 12*60*60*1000;
        const q = query(ref(db, "rooms"), orderByChild("createdAt"), startAt(0));
        const snap = await get(q);
        if (snap.exists()){
          const promises = [];
          snap.forEach(child=>{
            const v = child.val();
            if (v?.createdAt && v.createdAt < cutoff){
              promises.push(remove(ref(db, `rooms/${child.key}`)));
            }
          });
          if (promises.length) Promise.allSettled(promises);
        }
      }catch(e){ /* 무시 */ }
    })();
  </script>
</body>
</html>
