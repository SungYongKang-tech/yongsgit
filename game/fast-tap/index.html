<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FastTap - ìˆ«ì ê²Œì„</title>
  <style>
    /* ìŠ¤íƒ€ì¼ ìƒëµ (ê¸°ì¡´ ê·¸ëŒ€ë¡œ ìœ ì§€) */
  </style>
</head>
<body>
  <h1>FastTap</h1>
  <div id="timer">0:00</div>

  <div class="controls">
    <button class="control" onclick="startGame()">ì‹œì‘</button>
    <button class="control" onclick="resetGame()">ì´ˆê¸°í™”</button>
  </div>

  <div id="grid"></div>

  <div id="ranking">
    <h2>ğŸ† ìƒìœ„ 10ìœ„</h2>
    <ol id="rankingList"></ol>
  </div>

  <audio id="winSound" src="win.mp3" preload="auto"></audio>
  <audio id="clickSound" src="bbok.mp3" preload="auto"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      query,
      orderByChild,
      limitToFirst,
      get,
      remove,
      set
    } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.appspot.com",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:f34819be7b701e4b91a561"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const rankRef = ref(db, "fasttap/leaderboard");
    const resetRef = ref(db, "fasttap/resetTimestamp");

    const winSound = document.getElementById("winSound");
    const clickSound = document.getElementById("clickSound");
    const timerEl = document.getElementById("timer");
    const grid = document.getElementById("grid");
    const rankingList = document.getElementById("rankingList");

    let timerInterval, startTime, current = 1, finished = false;

    function format(ms) {
      return `${(ms / 1000).toFixed(2)}ì´ˆ`;
    }

    function resetGame() {
      clearInterval(timerInterval);
      timerEl.textContent = "0:00";
      grid.innerHTML = "";
      current = 1;
      finished = false;
    }

    function startGame() {
      resetGame();
      current = 1;
      finished = false;
      startTime = Date.now();

      const nums = [...Array(25)].map((_, i) => i + 1).sort(() => Math.random() - 0.5);
      nums.forEach(n => {
        const btn = document.createElement("button");
        btn.textContent = n;
        btn.className = "num-btn";
        btn.onclick = () => handleClick(n, btn);
        grid.appendChild(btn);
      });

      timerInterval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        timerEl.textContent = format(elapsed);
      }, 100);
    }

    function handleClick(num, btn) {
      if (finished || num !== current) return;

      clickSound.currentTime = 0;
      clickSound.play().catch(() => {});

      btn.disabled = true;
      btn.style.backgroundColor = "#ccc";
      current++;

      if (current > 25) {
        finished = true;
        clearInterval(timerInterval);
        winSound.play();
        setTimeout(() => checkRanking(Date.now() - startTime), 100);
      }
    }

    function checkRanking(timeTaken) {
      getTopRanks().then(ranks => {
        const isTop10 = ranks.length < 10 || timeTaken < ranks[ranks.length - 1].time;
        if (isTop10) {
          const name = prompt("ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! 10ìœ„ ì•ˆì— ë“¤ì—ˆìŠµë‹ˆë‹¤!\nì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
          if (name && name.trim() !== "") {
            push(rankRef, { name: name.trim(), time: timeTaken }).then(() => getTopRanks());
          }
        } else {
          alert("ğŸ™‚ ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤! ë‹¤ìŒ ê¸°íšŒì— ë„ì „í•˜ì„¸ìš”!");
        }
      });
    }

    function getTopRanks() {
      return new Promise(resolve => {
        const q = query(rankRef, orderByChild("time"), limitToFirst(10));
        get(q).then(snapshot => {
          const result = [];
          snapshot.forEach(child => {
            const val = child.val();
            if (val && val.name && val.time != null) {
              result.push({ name: val.name, time: val.time });
            }
          });
          resolve(result);
          showRanking(result);
        });
      });
    }

    function showRanking(ranks) {
      rankingList.innerHTML = "";
      ranks.forEach((entry, index) => {
        const li = document.createElement("li");
        li.textContent = `${index + 1}ìœ„. ${format(entry.time)} - ${entry.name}`;
        rankingList.appendChild(li);
      });
    }

    function getThisFridayNoon() {
      const now = new Date();
      const day = now.getDay();
      const diff = (5 - day + 7) % 7;
      const friday = new Date(now);
      friday.setDate(now.getDate() + diff);
      friday.setHours(12, 0, 0, 0);
      return friday.getTime();
    }

    function checkAndResetWeeklyRanking() {
      get(resetRef).then(snapshot => {
        const lastReset = snapshot.exists() ? snapshot.val() : 0;
        const now = Date.now();
        const fridayNoon = getThisFridayNoon();

        if (now >= fridayNoon && lastReset < fridayNoon) {
          remove(rankRef).then(() => {
            set(resetRef, now).then(() => {
              getTopRanks();
            });
          });
        }
      });
    }

    window.startGame = startGame;
    window.resetGame = resetGame;

    getTopRanks();
    checkAndResetWeeklyRanking();
  </script>
</body>
</html>
