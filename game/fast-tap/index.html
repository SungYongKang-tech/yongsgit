<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FastTap - 숫자 게임 (개선)</title>
  <style>
    :root{ --bg1:#e0f7fa;--bg2:#fce4ec;--accent:#1e88e5;--accent2:#42a5f5;--text:#2c3e50; --card:#ffffff;--muted:#78909c;--shadow:rgba(0,0,0,.18); }
    *{box-sizing:border-box}
    body{ font-family:'Segoe UI',system-ui,-apple-system,Roboto,Arial; margin:0; padding:20px; min-height:100vh; background:linear-gradient(145deg,var(--bg1),var(--bg2)); display:flex; flex-direction:column; align-items:center; gap:16px; color:var(--text); touch-action:manipulation; }
    h1{font-size:8.5vw; max-width:680px; width:100%; text-align:center; margin:6px 0 0; text-shadow:2px 2px 5px #b2bec3}
    #container{max-width:680px; width:100%; display:flex; flex-direction:column; gap:12px}
    #status{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; background:var(--card); padding:12px; border-radius:14px; box-shadow:0 6px 16px var(--shadow); }
    #timer{font-size:10vw; line-height:1; color:var(--accent)}
    #nextTarget{font-size:5.2vw; text-align:right}
    #progress{grid-column:1/-1; width:100%; height:10px; background:#e3f2fd; border-radius:999px; overflow:hidden}
    #progressInner{height:100%; width:0%; background:linear-gradient(90deg,var(--accent2),var(--accent)); transition:width .15s ease}
    .controls{display:flex; justify-content:center; gap:12px}
    .control{font-size:4.5vw; padding:12px 20px; width:30vw; max-width:140px; background:linear-gradient(135deg,var(--accent2),var(--accent)); color:#fff; border:none; border-radius:12px; font-weight:700; box-shadow:0 4px 8px rgba(0,0,0,.25); cursor:pointer; transition:transform .08s ease, box-shadow .15s}
    .control:active{transform:scale(.98)}
    .muted{background:linear-gradient(135deg,#90a4ae,#607d8b)}
    #grid{display:grid; grid-template-columns:repeat(5,1fr); gap:10px; margin:0 auto 8px; width:100%}
    .num-btn{font-size:6vw; padding:14px 0; border:2px solid #cfd8dc; border-radius:12px; cursor:pointer; background:linear-gradient(145deg,#fff,#f1f1f1); box-shadow:2px 2px 8px rgba(0,0,0,.15); transition:transform .05s ease, background .15s ease, box-shadow .15s}
    .num-btn:active{transform:scale(.97)}
    .num-btn.clicked{background:#90a4ae!important; color:#fff!important; font-weight:700; transform:scale(.96); box-shadow:inset 0 0 6px rgba(0,0,0,.25)}
    .num-btn.wrong{animation:wiggle .25s}
    @keyframes wiggle{ 0%,100%{transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)} }
    #grid.shake{animation:gridshake .25s}
    @keyframes gridshake{ 0%,100%{transform:translateX(0)} 20%{transform:translateX(-6px)} 60%{transform:translateX(6px)} }
    #ranking{background:var(--card); border-radius:14px; padding:16px; box-shadow:0 6px 16px var(--shadow)}
    #ranking h2{margin:0 0 10px; font-size:6vw}
    #ranking ol{list-style:none; padding:0; margin:0; font-size:5vw; color:#37474f}
    #ranking li{display:flex; justify-content:space-between; padding:6px 8px; border-bottom:1px dashed #eceff1}
    #ranking li:last-child{border-bottom:none}
    .modal{position:fixed; z-index:9999; inset:0; background:rgba(0,0,0,.45); display:none; justify-content:center; align-items:center; padding:20px}
    .modal.show{display:flex}
    .modal-content{background:#fff; padding:24px; border-radius:14px; width:100%; max-width:420px; box-shadow:0 10px 26px rgba(0,0,0,.25)}
    .modal-content h2{margin:0 0 8px}
    .modal-content p{margin:0 0 8px}
    .modal-content input{width:100%; padding:12px; font-size:16px; border:1px solid #cfd8dc; border-radius:10px; margin-top:8px}
    .modal-actions{display:flex; gap:10px; margin-top:14px}
    .btn{flex:1; padding:12px; border:none; border-radius:10px; font-weight:700; cursor:pointer}
    .btn.primary{background:var(--accent); color:#fff}
    .btn.secondary{background:#eceff1}
    #countdown{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.2)}
    #countdown.show{display:grid}
    #countdown .bubble{font-size:20vw; color:#fff; text-shadow:0 8px 24px rgba(0,0,0,.4); animation:pop .7s ease forwards}
    @keyframes pop{0%{transform:scale(.6); opacity:0} 50%{transform:scale(1.1); opacity:1} 100%{transform:scale(1); opacity:1}}
    .confetti{position:fixed; top:-10px; width:8px; height:14px; opacity:.9; pointer-events:none; animation:fall linear forwards}
    @keyframes fall{ to { transform: translateY(110vh) rotate(720deg); opacity:1 } }
    @media (prefers-reduced-motion: reduce){ .num-btn,.control,#grid{transition:none} .confetti{display:none} }
  </style>
</head>
<body>
  <h1>FastTap</h1>
  <div id="container">
    <section id="status">
      <div id="timer">0.00초</div>
      <div id="nextTarget">다음: 1</div>
      <div id="progress"><div id="progressInner"></div></div>
    </section>

    <div class="controls">
      <button id="startBtn" class="control">시작</button>
      <button id="resetBtn" class="control">초기화</button>
      <button id="muteBtn" class="control muted" title="사운드 켜기/끄기">🔈/🔇</button>
    </div>

    <div id="grid"></div>

    <section id="ranking">
      <h2>🏆 상위 10위</h2>
      <ol id="rankingList"></ol>
    </section>
  </div>

  <!-- 안내 모달 -->
  <div id="guideModal" class="modal">
    <div class="modal-content">
      <h2>FastTap 게임 설명</h2>
      <p style="line-height:1.6">
        ✅ 1부터 25까지 숫자가 무작위로 배치됩니다.<br>
        ✅ 숫자 1부터 순서대로 빠르게 클릭하세요.<br>
        ✅ 가장 빠르게 25까지 누른 사람이 승자입니다.<br>
        ✅ 10위 안에 들면 이름을 등록할 수 있습니다.<br>
        ✅ 순위는 매주 금요일 낮 12시에 초기화됩니다.
      </p>
      <div class="modal-actions">
        <button id="closeGuide" class="btn primary">게임 시작</button>
      </div>
    </div>
  </div>

  <!-- 결과 모달 -->
  <div id="resultModal" class="modal">
    <div class="modal-content">
      <h2>🎉 축하합니다!</h2>
      <p>상위 10위 안에 들었습니다. 이름을 입력해 순위에 등록하세요.</p>
      <input id="nameInput" maxlength="12" placeholder="이름 (최대 12자)" />
      <div class="modal-actions">
        <button id="saveRank" class="btn primary">등록</button>
        <button id="skipRank" class="btn secondary">건너뛰기</button>
      </div>
    </div>
  </div>

  <!-- 카운트다운 -->
  <div id="countdown"><div class="bubble" id="countdownText">3</div></div>

  <audio id="winSound" src="win.mp3" preload="auto"></audio>
  <audio id="clickSound" src="bbok.mp3" preload="auto"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import {
      getDatabase, ref, push, query, orderByChild, limitToFirst, get, remove, set, onValue
    } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";
    // ★ 익명 로그인 모듈 추가
    import {
      getAuth, onAuthStateChanged, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";

    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyCoHcYm0_fdpCcJbyh6PO60fjOZZKoR8xg",
      authDomain: "number-baseball-aee52.firebaseapp.com",
      databaseURL: "https://number-baseball-aee52-default-rtdb.firebaseio.com",
      projectId: "number-baseball-aee52",
      storageBucket: "number-baseball-aee52.appspot.com",
      messagingSenderId: "998537150772",
      appId: "1:998537150772:web:f34819be7b701e4b91a561"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const rankRef = ref(db, "fasttap/leaderboard");
    const resetRef = ref(db, "fasttap/resetTimestamp");

    // ★ Auth 인스턴스 + 익명 로그인 보장
    const auth = getAuth(app);
    async function ensureAnonAuth(){
      if (auth.currentUser) return auth.currentUser;
      return new Promise((resolve, reject)=>{
        const unsub = onAuthStateChanged(auth, (u)=>{ if(u){ unsub(); resolve(u); }});
        signInAnonymously(auth).catch((e)=>{ console.error("익명 로그인 실패:", e); reject(e); });
      });
    }

    // 서버 시간 오프셋 (클라이언트 시계 보정)
    let serverOffset = 0;
    onValue(ref(db, ".info/serverTimeOffset"), (snap)=>{ serverOffset = snap.val() || 0; });
    const nowMs = ()=> Date.now() + serverOffset;

    // ===== DOM =====
    const winSound = document.getElementById("winSound");
    const clickSound = document.getElementById("clickSound");
    const timerEl = document.getElementById("timer");
    const grid = document.getElementById("grid");
    const rankingList = document.getElementById("rankingList");
    const progressInner = document.getElementById("progressInner");
    const nextTargetEl = document.getElementById("nextTarget");
    const guideModal = document.getElementById("guideModal");
    const closeGuide = document.getElementById("closeGuide");
    const resultModal = document.getElementById("resultModal");
    const nameInput = document.getElementById("nameInput");
    const saveRankBtn = document.getElementById("saveRank");
    const skipRankBtn = document.getElementById("skipRank");
    const startBtn = document.getElementById("startBtn");
    const resetBtn = document.getElementById("resetBtn");
    const muteBtn = document.getElementById("muteBtn");
    const countdownWrap = document.getElementById("countdown");
    const countdownText = document.getElementById("countdownText");

    // ===== State =====
    let timerInterval, startTime, current = 1, finished = false, state = 'idle';
    let audioMuted = false, audioUnlocked = false, ranksCache = [];
    const TOTAL = 25;

    // 첫 터치/클릭 시 오디오 언락
    const unlockAudio = ()=>{
      if (audioUnlocked) return;
      [clickSound, winSound].forEach(a=>{ try{ a.play().then(()=>{a.pause(); a.currentTime=0;}).catch(()=>{});}catch{}});
      audioUnlocked = true;
    };
    window.addEventListener('pointerdown', unlockAudio, { once:true });

    function format(ms){ return `${(ms/1000).toFixed(2)}초`; }

    // 금요일 12:00(Asia/Seoul 로컬) 타임스탬프 계산
    function getThisFridayNoonTS(baseMs){
      const d = new Date(baseMs ?? nowMs());
      const day = d.getDay(); // 0=일
      const diff = (5 - day + 7) % 7; // 5=금
      const friday = new Date(d);
      friday.setDate(d.getDate() + diff);
      friday.setHours(12,0,0,0);
      return friday.getTime();
    }

    // ★ 주간 리셋: 인증 보장 후 삭제/기록
    async function checkAndResetWeeklyRanking(){
      try{
        await ensureAnonAuth();
        const snap = await get(resetRef);
        const lastReset = snap.exists()? snap.val(): 0;
        const ts = nowMs();
        const fridayNoon = getThisFridayNoonTS(ts);
        if (ts >= fridayNoon && lastReset < fridayNoon){
          await remove(rankRef);
          await set(resetRef, ts);
        }
      }catch(e){ /* 네트웍/권한 문제는 무시 */ }
    }

    // 1분마다 리셋 체크
    setInterval(checkAndResetWeeklyRanking, 60*1000);

    // 리더보드 실시간 반영 (읽기 전 인증 보장은 선택이지만 일관성을 위해 보장)
    async function watchLeaderboard(){
      try{ await ensureAnonAuth(); }catch{}
      const qy = query(rankRef, orderByChild('time'), limitToFirst(10));
      onValue(qy, (snap)=>{
        const arr=[]; snap.forEach(child=>{ const v=child.val(); if(v && v.name && v.time!=null){ arr.push({name:v.name, time:v.time}); }});
        ranksCache = arr; showRanking(arr);
      });
    }

    function showRanking(ranks){
      rankingList.innerHTML = '';
      ranks.forEach((e,i)=>{
        const li=document.createElement('li');
        const left=document.createElement('span'); left.textContent=`${i+1}위`;
        const right=document.createElement('span'); right.textContent=`${format(e.time)} - ${e.name}`;
        li.append(left,right); rankingList.appendChild(li);
      });
    }

    function shuffleNumbers(){
      const a=[...Array(TOTAL)].map((_,i)=>i+1);
      for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]]; }
      return a;
    }

    function buildGrid(){
      grid.innerHTML='';
      const nums=shuffleNumbers();
      nums.forEach(n=>{
        const btn=document.createElement('button');
        btn.textContent=n; btn.className='num-btn'; btn.setAttribute('data-n', String(n));
        btn.addEventListener('click', ()=> handleClick(n, btn));
        grid.appendChild(btn);
      });
    }

    function updateUI(){
      nextTargetEl.textContent = `다음: ${current}`;
      const ratio = (Math.max(0, current-1)/TOTAL)*100;
      progressInner.style.width = `${ratio}%`;
    }

    function startTimer(){
      startTime = nowMs();
      timerInterval = setInterval(()=>{ timerEl.textContent = format(nowMs() - startTime); }, 50);
    }
    function stopTimer(){ clearInterval(timerInterval); }

    function wrongFeedback(btn){
      btn.classList.add('wrong'); grid.classList.add('shake');
      if (navigator.vibrate) navigator.vibrate(40);
      setTimeout(()=>{ btn.classList.remove('wrong'); grid.classList.remove('shake'); }, 220);
    }

    function handleClick(num, btn){
      if (state !== 'playing' || finished) return;
      if (num !== current){ wrongFeedback(btn); return; }
      if (!audioMuted){ try{ clickSound.currentTime=0; clickSound.play(); }catch{} }
      btn.disabled=true; btn.classList.add('clicked');
      current++; updateUI();
      if (current > TOTAL){
        finished = true; state='finished';
        stopTimer();
        if (!audioMuted){ try{ winSound.currentTime=0; winSound.play(); }catch{} }
        confetti();
        const timeTaken = nowMs() - startTime;
        checkRanking(timeTaken);
      }
    }

    function resetGame(){
      stopTimer();
      timerEl.textContent = '0.00초';
      current = 1; finished = false; state='idle';
      updateUI(); grid.innerHTML='';
    }

    function countdown(cb){
      let cnt=3; const countdownWrap = document.getElementById('countdown'); const countdownText = document.getElementById('countdownText');
      countdownWrap.classList.add('show');
      const step=()=>{
        countdownText.textContent = cnt>0? String(cnt): 'GO!';
        countdownText.style.animation='none'; void countdownText.offsetWidth; countdownText.style.animation=null;
        if (cnt===0){ setTimeout(()=>{ countdownWrap.classList.remove('show'); cb(); }, 600); }
        else { cnt--; setTimeout(step, 800); }
      }; step();
    }

    function startGame(){
      if (state==='countdown' || state==='playing') return;
      resetGame(); buildGrid(); state='countdown';
      countdown(()=>{ state='playing'; startTimer(); });
    }

    // ★ 랭킹 저장: 인증 보장 후 push
    async function saveRank(name, timeTaken){
      await ensureAnonAuth();
      await push(rankRef, { name, time: timeTaken, ts: nowMs(), uid: auth.currentUser?.uid || null });
    }

    // 랭킹 체크 및 등록 (Top10)
    function checkRanking(timeTaken){
      const isTop10 = ranksCache.length < 10 || timeTaken < ranksCache[ranksCache.length-1].time;
      if (isTop10){
        nameInput.value = (localStorage.getItem('fasttapName')||'').slice(0,12);
        resultModal.classList.add('show');
        const save=async ()=>{
          const raw = nameInput.value.trim();
          if (!raw){ resultModal.classList.remove('show'); return; }
          const safe = raw.replace(/[<>]/g,'');
          try{
            await saveRank(safe, timeTaken);                   // ★ 여기서 익명 로그인 사용
            localStorage.setItem('fasttapName', safe);
          }catch(e){ alert('등록 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.'); console.warn(e); }
          finally{ resultModal.classList.remove('show'); }
        };
        const skip=()=> resultModal.classList.remove('show');
        saveRankBtn.onclick = save; skipRankBtn.onclick = skip;
      } else {
        alert('🙂 수고하셨습니다! 다음 기회에 도전하세요!');
      }
    }

    function confetti(){
      const colors=['#ff7675','#fdcb6e','#55efc4','#74b9ff','#a29bfe'];
      const n=80;
      for(let i=0;i<n;i++){
        const el=document.createElement('div'); el.className='confetti';
        const left = Math.random()*100; const dur = 2.2 + Math.random()*1.6; const delay = Math.random()*0.15;
        el.style.left = left+'vw'; el.style.background = colors[(Math.random()*colors.length)|0];
        el.style.animationDuration = dur+'s'; el.style.animationDelay = delay+'s';
        document.body.appendChild(el);
        el.addEventListener('animationend', ()=> el.remove());
      }
    }

    // 이벤트 바인딩
    document.getElementById('startBtn').addEventListener('click', ()=>{ unlockAudio(); startGame(); });
    document.getElementById('resetBtn').addEventListener('click', resetGame);
    document.getElementById('muteBtn').addEventListener('click', (e)=>{
      audioMuted = !audioMuted; e.currentTarget.classList.toggle('muted', audioMuted);
      e.currentTarget.textContent = audioMuted? '🔇 음소거' : '🔈 소리';
    });
    document.getElementById('closeGuide').addEventListener('click', ()=> document.getElementById('guideModal').classList.remove('show'));

    // 초기 로드
    async function init(){
      await ensureAnonAuth();                  // ★ 시작 시 로그인 보장
      updateUI();
      watchLeaderboard();
      checkAndResetWeeklyRanking();
      guideModal.classList.add('show');
    }
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
