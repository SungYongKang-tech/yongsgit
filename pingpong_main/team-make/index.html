<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ“ KOEN ê²½ê¸° êµ¬ì„± (team-make)</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --bd:#e6e8ef;
      --txt:#0f172a; --mut:#64748b; --r:16px;
      --accent:#2563eb; --ok:#16a34a; --danger:#ef4444; --warn:#f59e0b;
      --shadow:0 10px 28px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--txt)}
    .wrap{max-width:1100px;margin:0 auto;padding:12px}
    h2{margin:6px 0 12px;font-size:16px;font-weight:950;text-align:center}

    .card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--shadow);padding:12px;margin-bottom:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}
    .row.between{justify-content:space-between}
    .input, select{
      padding:10px 12px;border:1px solid var(--bd);border-radius:12px;background:#fff;font-size:14px
    }
    .btn{
      padding:10px 14px;border:1px solid rgba(37,99,235,.25);
      background:linear-gradient(180deg,#2b74ff,#2563eb);
      color:#fff;border-radius:12px;cursor:pointer;font-weight:950;
    }
    .btn.secondary{background:#fff;color:#0f172a;border:1px solid var(--bd)}
    .btn.ok{background:linear-gradient(180deg,#22c55e,#16a34a);border:1px solid rgba(22,163,74,.25)}
    .btn.danger{background:linear-gradient(180deg,#ff5a5a,#ef4444);border:1px solid rgba(239,68,68,.25)}
    .btn.warn{background:linear-gradient(180deg,#fbbf24,#f59e0b);border:1px solid rgba(245,158,11,.25)}

    .mut{color:var(--mut);font-weight:750;font-size:12px;margin-top:8px;text-align:center}
    .err{color:#b91c1c;font-weight:950;text-align:center}
    .oktxt{color:#166534;font-weight:950;text-align:center}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){ .grid2{grid-template-columns:1fr} }

    .box{border:1px solid var(--bd);border-radius:14px;background:#fff;padding:12px}
    .box h3{margin:0 0 10px;font-size:14px;font-weight:1000}

    .pill{padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:#f8fafc;font-weight:900}

    .playerWrap{display:flex;flex-wrap:wrap;gap:6px;justify-content:center}
    .player{
      display:inline-flex;align-items:center;gap:6px;
      padding:8px 10px;border:1px solid var(--bd);border-radius:999px;background:#fff;
      font-weight:900; cursor:pointer;
    }
    .player small{color:var(--mut);font-weight:800}
    .player.on{background:#eef2ff;border-color:#c7d2fe}

    .teams{display:flex;flex-direction:column;gap:10px}
    .team{border:1px solid var(--bd);border-radius:14px;padding:10px;background:#f8fafc}
    .team .tline{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
    .team .name{font-weight:950}
    .team .meta{color:var(--mut);font-weight:800;font-size:12px}
    .team ul{margin:8px 0 0;padding-left:18px}
    .team li{margin:3px 0;font-weight:900}

    .divider{height:1px;background:var(--bd);margin:10px 0}
    .hidden{display:none !important}

    .radioRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .radioCard{
      border:1px solid var(--bd); border-radius:14px; padding:10px 12px; background:#fff; cursor:pointer;
      display:flex; gap:10px; align-items:center; min-width:260px; justify-content:space-between;
    }
    .radioCard.on{outline:2px solid rgba(37,99,235,.35); background:#eef2ff}
    .radioCard b{font-size:14px}
    .radioCard span{color:var(--mut);font-weight:800;font-size:12px}

    /* groups UI */
    .groupsGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media (max-width:900px){ .groupsGrid{grid-template-columns:1fr} }
    .gbox{border:1px solid var(--bd);border-radius:14px;background:#f8fafc;padding:10px}
    .gtitle{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px}
    .gtitle b{font-weight:1000}
    .glist{display:flex;flex-wrap:wrap;gap:6px}
    .gtag{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--bd);border-radius:999px;background:#fff;padding:6px 10px;font-weight:900}
    .gtag button{padding:4px 8px;border-radius:10px}
  </style>
</head>

<body>
  <div class="wrap">
    <h2>ğŸ“ KOEN ê²½ê¸° êµ¬ì„± (team-make)</h2>

    <div class="card">
      <div class="row">
        <span class="pill">ë¶€ìˆ˜: 1ë¶€ ~ 14ë¶€</span>
        <span class="pill">ì €ì¥ ìœ„ì¹˜: teamLive/current</span>
        <button class="btn secondary" id="reloadBtn">ì„ ìˆ˜ ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div class="mut" id="status">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <!-- 0) ë‹¨ì²´ì „/ê°œì¸ì „ ì„ íƒ -->
    <div class="card">
      <div style="text-align:center;font-weight:1000;margin-bottom:10px">1ï¸âƒ£ ê²½ê¸° í˜•íƒœë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</div>
      <div class="radioRow" id="modePicker">
        <div class="radioCard on" data-mode="team">
          <div>
            <b>ë‹¨ì²´ì „</b><br>
            <span>team-make: íŒ€ êµ¬ì„±ë§Œ / ë‹¨ì‹Â·ë³µì‹(ëª‡ë‹¨/ëª‡ë³µ)ì€ team-liveì—ì„œ ì„¤ì •</span>
          </div>
          <input type="radio" name="mode" checked />
        </div>
        <div class="radioCard" data-mode="single">
          <div>
            <b>ê°œì¸ì „</b><br>
            <span>ê°œì¸ì „(ë¦¬ê·¸/ì¡°+í† ë„ˆ/í† ë„ˆ) + ì¡° í¸ì„±ì€ ì—¬ê¸°(team-make)ì—ì„œ</span>
          </div>
          <input type="radio" name="mode" />
        </div>
      </div>
      <div class="mut">ì„ íƒì— ë”°ë¼ ì•„ë˜ í™”ë©´ì´ ìë™ìœ¼ë¡œ ë°”ë€ë‹ˆë‹¤.</div>
    </div>

    <!-- ì„ ìˆ˜ ì¶”ê°€ -->
    <div class="card">
      <div class="row between" style="max-width:900px;margin:0 auto">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <input class="input" id="newName" placeholder="ì´ë¦„" style="width:140px" />
          <input class="input" id="newGrade" type="number" min="1" max="14" placeholder="ë¶€ìˆ˜(1~14)" style="width:120px" />
          <button class="btn" id="addBtn">ì„ ìˆ˜ ì¶”ê°€</button>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <button class="btn secondary" id="clearAddedBtn">ì¶”ê°€ ì„ ìˆ˜ ì „ì²´ ì‚­ì œ</button>
          <button class="btn secondary" id="clearSelectBtn">ì°¸ì„ì ì„ íƒ í•´ì œ</button>
        </div>
      </div>
      <div class="mut">ì°¸ì„ì ì„ íƒì´ ì—†ìœ¼ë©´ â€œì „ì²´ ëª…ë‹¨â€ì´ ì°¸ê°€ìë¡œ ì €ì¥ë©ë‹ˆë‹¤.</div>
    </div>

    <!-- ì°¸ì„ì ëª©ë¡ -->
    <div class="card">
      <div style="font-size:14px;font-weight:1000;text-align:center;margin-bottom:10px">ì°¸ì„ì ëª©ë¡(í´ë¦­í•´ì„œ ì„ íƒ)</div>
      <div class="playerWrap" id="playerList"></div>
      <div class="mut" id="selInfo">ì„ íƒ 0ëª…</div>
    </div>

    <!-- ë‹¨ì²´ì „: íŒ€ êµ¬ì„± -->
    <div class="card" id="teamSection">
      <div style="text-align:center;font-weight:1000;margin-bottom:10px">2ï¸âƒ£ ë‹¨ì²´ì „ íŒ€ êµ¬ì„±</div>
      <div class="row">
        <label style="font-weight:950">
          íŒ€ ìˆ˜(2~8)
          <select id="teamCount" class="input">
            <option>2</option><option>3</option><option selected>4</option><option>5</option>
            <option>6</option><option>7</option><option>8</option>
          </select>
        </label>
        <button class="btn ok" id="autoBtn">íŒ€ ìë™ ë°°ì •</button>
        <button class="btn warn" id="manualBtn">íŒ€ ìˆ˜ë™ ì¡°ì • ì•ˆë‚´</button>
        <button class="btn secondary" id="resetTeamsBtn">íŒ€ ì´ˆê¸°í™”</button>
      </div>
      <div class="mut">â€» ë‹¨ì‹/ë³µì‹(ëª‡ë‹¨/ëª‡ë³µ) ìˆ«ì ê²°ì •ì€ team-liveì—ì„œ í•©ë‹ˆë‹¤.</div>
    </div>

    <!-- ê°œì¸ì „: í˜•ì‹ + ì¡°í¸ì„± -->
    <div class="card hidden" id="singleSection">
      <div style="text-align:center;font-weight:1000;margin-bottom:10px">2ï¸âƒ£ ê°œì¸ì „ ì„¤ì •</div>

      <div class="row">
        <label style="font-weight:950">
          ê°œì¸ì „ ë°©ì‹
          <select id="singleFormat" class="input">
            <option value="roundrobin" selected>ê°œì¸ í’€ë¦¬ê·¸</option>
            <option value="group_knockout">ì¡°ë³„ë¦¬ê·¸ + í† ë„ˆë¨¼íŠ¸</option>
            <option value="knockout">ë°”ë¡œ í† ë„ˆë¨¼íŠ¸</option>
          </select>
        </label>
      </div>

      <div class="row" id="groupOpts" style="margin-top:10px">
        <label style="font-weight:950">ì¡° ê°œìˆ˜
          <select id="groupCount" class="input">
            <option value="2">2ì¡°</option>
            <option value="3">3ì¡°</option>
            <option value="4" selected>4ì¡°</option>
            <option value="5">5ì¡°</option>
            <option value="6">6ì¡°</option>
            <option value="7">7ì¡°</option>
            <option value="8">8ì¡°</option>
          </select>
        </label>
        <label style="font-weight:950">ì¡°ë‹¹ ì§„ì¶œ
          <select id="advancePerGroup" class="input">
            <option value="1">1ëª…</option>
            <option value="2" selected>2ëª…</option>
            <option value="3">3ëª…</option>
          </select>
        </label>
        <button class="btn ok" id="autoGroupBtn">ì¡° ìë™ í¸ì„±</button>
        <button class="btn secondary" id="clearGroupsBtn">ì¡° ì´ˆê¸°í™”</button>
      </div>

      <div class="mut" id="singleHint">
        â€œì¡°ë³„ë¦¬ê·¸ + í† ë„ˆë¨¼íŠ¸â€ ì„ íƒ ì‹œ, ì¡° í¸ì„±ì„ ì—¬ê¸°ì—ì„œ í•©ë‹ˆë‹¤. (ìë™ í¸ì„± í›„ ì´ë™/ì‚­ì œë¡œ ì¡°ì •)
      </div>

      <div class="divider"></div>

      <div class="box" id="groupsEditorWrap" style="box-shadow:none;border-radius:14px;background:#fff;border:1px solid var(--bd)">
        <div style="font-weight:1000;margin-bottom:8px;text-align:center">ê°œì¸ì „ ì¡° í¸ì„±(ì¡°ë³„+í† ë„ˆì—ì„œ ì‚¬ìš©)</div>
        <div class="mut" id="groupsHint2">ì•„ì§ ì¡°ê°€ ì—†ìŠµë‹ˆë‹¤. â€œì¡° ìë™ í¸ì„±â€ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
        <div class="groupsGrid" id="groupsGrid"></div>
        <div class="mut">â€» ì¡° í¸ì„± ê²°ê³¼ëŠ” teamLive/currentì˜ <b>groups</b>ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</div>
      </div>
    </div>

    <div class="grid2">
      <!-- ë‹¨ì²´ì „: íŒ€ êµ¬ì„± ê²°ê³¼ -->
      <div class="box" id="teamsBoxWrap">
        <h3>í˜„ì¬ íŒ€ êµ¬ì„±(ë‹¨ì²´ì „)</h3>
        <div class="teams" id="teamsBox"><div class="mut">ë‹¨ì²´ì „ ì„ íƒ í›„ íŒ€ì„ êµ¬ì„±í•´ì£¼ì„¸ìš”.</div></div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn ok" id="saveBtn">Firebase ì €ì¥</button>
          <button class="btn secondary" id="openLiveBtn">team-live ì—´ê¸°</button>
        </div>
        <div class="mut">ì €ì¥ í›„ team-liveì—ì„œ ë‹¨ì‹/ë³µì‹(ëª‡ë‹¨/ëª‡ë³µ) ì„¤ì • â†’ ëŒ€ì§„ ìƒì„± â†’ ê²½ê¸° ì§„í–‰</div>
      </div>

      <!-- ê°œì¸ì „: ì €ì¥ ë¯¸ë¦¬ë³´ê¸° -->
      <div class="box" id="singlePreviewWrap">
        <h3>ê°œì¸ì „ ì €ì¥ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°</h3>
        <div class="mut" id="singlePreview">
          ê°œì¸ì „ì„ ì„ íƒí•˜ë©´ ì°¸ê°€ì/í˜•ì‹/ì¡°(ì¡°ë³„+í† ë„ˆì¸ ê²½ìš°) ì •ë³´ê°€ ì €ì¥ë©ë‹ˆë‹¤.
        </div>

        <div class="divider"></div>
        <div class="row">
          <button class="btn ok" id="saveBtn2">Firebase ì €ì¥</button>
          <button class="btn secondary" id="openLiveBtn2">team-live ì—´ê¸°</button>
        </div>
        <div class="mut">ì €ì¥ í›„ team-liveì—ì„œ â€œë¦¬ê·¸/ì¡°+í† ë„ˆ/í† ë„ˆâ€ê°€ ìë™ ì ìš©ë©ë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db, auth } from "../firebase.js";
    import { ref, set } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
    import { signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    const $ = (id)=>document.getElementById(id);
    const PATH = { current: "teamLive/current" };

    // ====== State
    let mode = "team"; // team | single
    let allPlayers = []; // {name, grade, isNew}
    let selected = new Set(); // player index
    let teams = []; // {id, players:[{name,grade}], sum}

    // ê°œì¸ì „ ì¡° í¸ì„±: { "A":[pid...], "B":[pid...], ... }
    let groups = {}; // groupKey -> [participantId]
    let participantCache = []; // current participants computed from selection

    // ====== Utils
    const esc = (s)=>String(s??"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");

    function setStatus(msg, cls="mut"){
      const el = $("status");
      el.className = cls;
      el.textContent = msg;
    }

    function clampGrade(n){
      const x = Number(n);
      if(!Number.isFinite(x)) return null;
      return Math.max(1, Math.min(14, Math.floor(x)));
    }

    function teamSum(list){ return (list||[]).reduce((s,p)=>s + (p.grade|0), 0); }

    function shuffle(arr){
      const a = [...arr];
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function poolPlayers(){
      const idxs = selected.size ? [...selected] : allPlayers.map((_,i)=>i);
      return idxs.map(i=>allPlayers[i]);
    }

    function makePid(name, grade){
      // ì´ë¦„ ì¤‘ë³µ ëŒ€ë¹„: ì´ë¦„+ë¶€ìˆ˜+ëœë¤ì§§ì€ê°’ (í•œ ë²ˆ ì €ì¥ë˜ë©´ currentì—ì„œ ìœ ì§€)
      return `P_${String(name).trim()}_${grade}_${Math.random().toString(16).slice(2,8)}_${Date.now().toString(16)}`;
    }

    function computeParticipants(){
      // ë§¤ë²ˆ í˜„ì¬ ì°¸ê°€ì ëª©ë¡ì„ â€œê³ ì • idâ€ í¬í•¨ í˜•íƒœë¡œ ë§Œë“¤ì–´ë‘”ë‹¤
      const pool = poolPlayers();
      participantCache = pool.map(p=>({
        id: makePid(p.name, p.grade),
        name: p.name,
        grade: p.grade
      }));
      return participantCache;
    }

    function saveAddedToLS(){
      const added = allPlayers.filter(p=>p.isNew).map(p=>({name:p.name, grade:p.grade}));
      localStorage.setItem("pp_addedPlayers", JSON.stringify(added));
    }

    function loadAddedFromLS(){
      try{
        const arr = JSON.parse(localStorage.getItem("pp_addedPlayers") || "[]");
        if(Array.isArray(arr)){
          arr.forEach(p=>{
            if(p?.name && p?.grade){
              const g = clampGrade(p.grade);
              if(g) allPlayers.push({name:String(p.name), grade:g, isNew:true});
            }
          });
        }
      }catch(e){}
    }

    async function loadMembers(){
      setStatus("ì„ ìˆ˜ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
      allPlayers = [];
      selected.clear();
      teams = [];
      groups = {};
      participantCache = [];

      try{
        const res = await fetch("https://sensational-tulumba-65e97e.netlify.app/pingpong/club/data/members.json", { cache:"no-store" });
        const json = await res.json();
        const base = Object.values(json || {}).map(p=>({
          name: String(p.name ?? ""),
          grade: clampGrade(p.level ?? p.grade ?? 1),
          isNew:false
        })).filter(p=>p.name && p.grade);
        allPlayers.push(...base);
      }catch(e){
        console.error(e);
      }

      loadAddedFromLS();

      setStatus(`ë¡œë“œ ì™„ë£Œ: ${allPlayers.length}ëª…`, "oktxt");
      renderPlayers();
      renderTeams();
      renderGroupsEditor();
      renderSinglePreview();
    }

    function renderPlayers(){
      const box = $("playerList");
      box.innerHTML = "";

      if(!allPlayers.length){
        box.innerHTML = `<div class="mut">ì„ ìˆ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        $("selInfo").textContent = "ì„ íƒ 0ëª…";
        return;
      }

      allPlayers.forEach((p, idx)=>{
        const el = document.createElement("div");
        el.className = "player" + (selected.has(idx) ? " on" : "");
        el.innerHTML = `
          <span>${esc(p.name)}</span>
          <small>${esc(p.grade)}ë¶€${p.isNew ? " Â· ì‹ ê·œ" : ""}</small>
        `;
        el.addEventListener("click", ()=>{
          if(selected.has(idx)) selected.delete(idx);
          else selected.add(idx);

          // ì°¸ê°€ìê°€ ë°”ë€Œë©´ ì¡°í¸ì„±ì€ ë¬´íš¨ ì²˜ë¦¬(í˜¼ì„  ë°©ì§€)
          if(mode==="single"){
            groups = {};
            renderGroupsEditor();
          }

          renderPlayers();
          renderSinglePreview();
        });
        box.appendChild(el);
      });

      $("selInfo").textContent = `ì„ íƒ ${selected.size}ëª…`;
    }

    // ====== team-mode: auto build
    function buildAutoTeams(teamCount){
      const pool = poolPlayers();
      if(pool.length < 2){ alert("ì„ ìˆ˜ê°€ 2ëª… ì´ìƒ ìˆì–´ì•¼ í•©ë‹ˆë‹¤."); return; }

      const tc = Number(teamCount);
      if(!(tc>=2 && tc<=8)){ alert("íŒ€ ìˆ˜ëŠ” 2~8"); return; }

      const sorted = shuffle(pool).sort((a,b)=> (b.grade - a.grade));
      const out = Array.from({length:tc}, (_,i)=>({ id:`T${i+1}`, players:[], sum:0 }));

      const total = sorted.length;
      const base = Math.floor(total / tc);
      const extra = total % tc;
      const maxPer = out.map((_,i)=> i<extra ? base+1 : base);

      sorted.forEach(p=>{
        const cand = out
          .map((t,i)=>({t,i}))
          .filter(x=> x.t.players.length < maxPer[x.i])
          .sort((x,y)=>{
            const ax = x.t.players.length ? x.t.sum/x.t.players.length : 0;
            const ay = y.t.players.length ? y.t.sum/y.t.players.length : 0;
            return ax - ay;
          })[0];
        cand.t.players.push({ name:p.name, grade:p.grade });
        cand.t.sum += p.grade;
      });

      const avg = (t)=> t.players.length ? (t.sum / t.players.length) : 0;
      for(let loop=0; loop<30; loop++){
        const avgs = out.map(avg);
        const hi = avgs.indexOf(Math.max(...avgs));
        const lo = avgs.indexOf(Math.min(...avgs));
        const high = out[hi], low = out[lo];
        const diffBefore = Math.abs(avg(high) - avg(low));
        if(diffBefore < 0.35) break;

        let best = null, bestImprove = 0;
        for(const hp of high.players){
          for(const lp of low.players){
            const newHigh = (high.sum - hp.grade + lp.grade) / high.players.length;
            const newLow  = (low.sum  - lp.grade + hp.grade) / low.players.length;
            const diffAfter = Math.abs(newHigh - newLow);
            const imp = diffBefore - diffAfter;
            if(imp > bestImprove){ bestImprove = imp; best = {hp, lp}; }
          }
        }
        if(best && bestImprove > 0){
          const hiIdx = high.players.indexOf(best.hp);
          const loIdx = low.players.indexOf(best.lp);
          high.players[hiIdx] = best.lp;
          low.players[loIdx]  = best.hp;
          high.sum = teamSum(high.players);
          low.sum  = teamSum(low.players);
        } else break;
      }

      teams = out;
      renderTeams();
    }

    function renderTeams(){
      const box = $("teamsBox");
      if(mode !== "team"){
        box.innerHTML = `<div class="mut">ê°œì¸ì „ ëª¨ë“œì—ì„œëŠ” íŒ€ êµ¬ì„±ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }
      if(!teams.length){
        box.innerHTML = `<div class="mut">íŒ€ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      box.innerHTML = teams.map((t, ti)=>{
        const avg = t.players.length ? (t.sum / t.players.length).toFixed(2) : "-";
        const list = t.players.slice().sort((a,b)=>a.grade-b.grade).map((p, pi)=>`
          <li>
            ${esc(p.name)}(${esc(p.grade)}ë¶€)
            <span style="display:inline-flex;gap:6px;margin-left:8px;vertical-align:middle">
              <button class="btn secondary" style="padding:6px 10px;border-radius:10px" data-move="${ti},${pi}">ì´ë™</button>
              <button class="btn danger" style="padding:6px 10px;border-radius:10px" data-del="${ti},${pi}">ì‚­ì œ</button>
            </span>
          </li>
        `).join("");

        return `
          <div class="team">
            <div class="tline">
              <div class="name">${esc(t.id)} íŒ€</div>
              <div class="meta">ë¶€ìˆ˜í•© ${esc(t.sum)} / í‰ê·  ${esc(avg)}</div>
            </div>
            <ul>${list || `<li class="mut" style="list-style:none">íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤.</li>`}</ul>
          </div>
        `;
      }).join("");

      box.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const [ti,pi] = btn.getAttribute("data-del").split(",").map(Number);
          teams[ti].players.splice(pi, 1);
          teams[ti].sum = teamSum(teams[ti].players);
          renderTeams();
        });
      });

      box.querySelectorAll("button[data-move]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const [ti,pi] = btn.getAttribute("data-move").split(",").map(Number);
          const to = prompt(`ì´ë™í•  íŒ€ ë²ˆí˜¸(1~${teams.length}) ì…ë ¥`);
          if(to===null) return;
          const toIdx = Number(to) - 1;
          if(!(toIdx>=0 && toIdx<teams.length)) { alert("ì˜ëª»ëœ íŒ€"); return; }
          if(toIdx === ti) { alert("ê°™ì€ íŒ€"); return; }
          const p = teams[ti].players[pi];
          teams[ti].players.splice(pi,1);
          teams[toIdx].players.push(p);
          teams[ti].sum = teamSum(teams[ti].players);
          teams[toIdx].sum = teamSum(teams[toIdx].players);
          renderTeams();
        });
      });
    }

    // ====== ê°œì¸ì „: ì¡° ìë™í¸ì„±/í¸ì§‘
    function groupKeys(n){
      // A,B,C... (ìµœëŒ€ 8)
      const letters = "ABCDEFGH".split("");
      return letters.slice(0, n);
    }

    function autoMakeGroups(){
      const fmt = $("singleFormat").value;
      if(fmt!=="group_knockout"){
        alert("ì¡° í¸ì„±ì€ â€˜ì¡°ë³„ë¦¬ê·¸ + í† ë„ˆë¨¼íŠ¸â€™ì—ì„œë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.");
        return;
      }
      const participants = computeParticipants();
      if(participants.length < 2){
        alert("ì°¸ê°€ìê°€ 2ëª… ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
        return;
      }

      const gCount = Number($("groupCount").value);
      const keys = groupKeys(gCount);

      // ë¶€ìˆ˜ ë†’ì€ ìˆœ + ì•½ê°„ ëœë¤ ì„ì€ ë’¤, ì§€ê·¸ì¬ê·¸ë¡œ ë¶„ë°°(ë°¸ëŸ°ìŠ¤)
      const mixed = shuffle(participants).sort((a,b)=>b.grade-a.grade);
      const buckets = Object.fromEntries(keys.map(k=>[k, []]));

      let dir = 1;
      let idx = 0;
      for(const p of mixed){
        const k = keys[idx];
        buckets[k].push(p.id);

        // ì§€ê·¸ì¬ê·¸
        if(dir===1){
          if(idx === keys.length-1){ dir=-1; }
          else idx++;
        }else{
          if(idx === 0){ dir=1; }
          else idx--;
        }
      }

      groups = buckets;
      renderGroupsEditor();
      renderSinglePreview();
      setStatus("ì¡° ìë™ í¸ì„± ì™„ë£Œ", "oktxt");
    }

    function participantsMap(){
      const pool = poolPlayers();
      // í˜„ì¬ ì¡° í‘œì‹œ/ì´ë™ì„ ìœ„í•´, â€œì„ì‹œ pidâ€ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€í•´ì•¼ í•˜ëŠ”ë°,
      // ì¡°ëŠ” ì €ì¥ ì§ì „ì— payloadì— í¬í•¨ë˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” participantCacheê°€ ê¸°ì¤€ì´ ë˜ë„ë¡ í•©ë‹ˆë‹¤.
      // (ì¡° í¸ì„± ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ computeParticipants()ê°€ ìƒì„±í•˜ê³  participantCacheê°€ ì±„ì›Œì§)
      const map = new Map();
      for(const p of participantCache){
        map.set(p.id, p);
      }
      // í˜¹ì‹œ ì¡°ê°€ ë¹„ì—ˆê³  ì•„ì§ computeParticipants() ì•ˆ í–ˆìœ¼ë©´:
      if(map.size===0){
        const ps = pool.map(p=>({id: makePid(p.name,p.grade), name:p.name, grade:p.grade}));
        ps.forEach(p=>map.set(p.id,p));
      }
      return map;
    }

    function renderGroupsEditor(){
      const wrap = $("groupsGrid");
      const hint = $("groupsHint2");

      wrap.innerHTML = "";

      const fmt = $("singleFormat").value;
      const show = (mode==="single" && fmt==="group_knockout");
      $("groupsEditorWrap").classList.toggle("hidden", !show);

      if(!show) return;

      const keys = Object.keys(groups || {});
      if(!keys.length){
        hint.classList.remove("hidden");
        hint.textContent = "ì•„ì§ ì¡°ê°€ ì—†ìŠµë‹ˆë‹¤. â€œì¡° ìë™ í¸ì„±â€ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
        return;
      }
      hint.classList.add("hidden");

      const pmap = participantsMap();

      wrap.innerHTML = keys.map(k=>{
        const ids = groups[k] || [];
        const tags = ids.map((pid, i)=>{
          const p = pmap.get(pid);
          const label = p ? `${p.name}(${p.grade}ë¶€)` : pid;
          return `
            <span class="gtag">
              ${esc(label)}
              <button class="btn secondary" style="padding:4px 8px" data-gmove="${k},${pid}">ì´ë™</button>
              <button class="btn danger" style="padding:4px 8px" data-gdel="${k},${pid}">ì‚­ì œ</button>
            </span>
          `;
        }).join("");

        return `
          <div class="gbox">
            <div class="gtitle">
              <b>${esc(k)}ì¡°</b>
              <span class="mut" style="margin:0">ì¸ì› ${ids.length}</span>
            </div>
            <div class="glist">${tags || `<span class="mut">ë¹„ì–´ìˆìŒ</span>`}</div>
          </div>
        `;
      }).join("");

      // bind delete
      wrap.querySelectorAll("[data-gdel]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const [g, pid] = btn.getAttribute("data-gdel").split(",");
          groups[g] = (groups[g]||[]).filter(x=>x!==pid);
          renderGroupsEditor();
          renderSinglePreview();
        });
      });

      // bind move
      wrap.querySelectorAll("[data-gmove]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const [g, pid] = btn.getAttribute("data-gmove").split(",");
          const keysNow = Object.keys(groups);
          const to = prompt(`ì´ë™í•  ì¡°ë¥¼ ì…ë ¥í•˜ì„¸ìš” (${keysNow.join(",")})`);
          if(to===null) return;
          const toKey = to.trim().toUpperCase();
          if(!groups[toKey]){ alert("ì—†ëŠ” ì¡°ì…ë‹ˆë‹¤."); return; }
          if(toKey === g){ alert("ê°™ì€ ì¡°ì…ë‹ˆë‹¤."); return; }
          groups[g] = (groups[g]||[]).filter(x=>x!==pid);
          groups[toKey].push(pid);
          renderGroupsEditor();
          renderSinglePreview();
        });
      });
    }

    function clearGroups(){
      if(!confirm("ì¡° í¸ì„±ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
      groups = {};
      renderGroupsEditor();
      renderSinglePreview();
      setStatus("ì¡° ì´ˆê¸°í™” ì™„ë£Œ", "oktxt");
    }

    // ====== single-mode preview
    function renderSinglePreview(){
      const box = $("singlePreview");
      if(mode !== "single"){
        box.innerHTML = `ê°œì¸ì „ì„ ì„ íƒí•˜ë©´ ì°¸ê°€ì/í˜•ì‹ ì •ë³´ê°€ ì €ì¥ë©ë‹ˆë‹¤(íŒ€ êµ¬ì„±ì€ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤).`;
        return;
      }

      const pool = poolPlayers();
      const participants = pool.map(p=>({name:p.name, grade:p.grade}));

      const fmt = $("singleFormat").value;
      const fmtLabel = fmt==="roundrobin" ? "ê°œì¸ í’€ë¦¬ê·¸"
                    : fmt==="group_knockout" ? "ì¡°ë³„ë¦¬ê·¸ + í† ë„ˆë¨¼íŠ¸"
                    : "ë°”ë¡œ í† ë„ˆë¨¼íŠ¸";

      let extra = "";
      if(fmt==="group_knockout"){
        const gc = $("groupCount").value;
        const apg = $("advancePerGroup").value;
        const gKeys = Object.keys(groups||{});
        extra = ` / ${gc}ì¡° / ì¡°ë‹¹ ${apg}ëª… ì§„ì¶œ / ì¡°í¸ì„± ${gKeys.length? "ìˆìŒ":"ì—†ìŒ"}`;
      }

      box.innerHTML = `
        <div style="font-weight:1000;margin-bottom:6px">í˜•ì‹: ${esc(fmtLabel)}${esc(extra)}</div>
        <div class="mut" style="text-align:left;margin:0">ì°¸ê°€ì: ${participants.length}ëª…</div>
        <div class="mut" style="text-align:left;margin:6px 0 0">
          ${participants.slice(0,20).map(p=>`${esc(p.name)}(${esc(p.grade)}ë¶€)`).join(", ")}
          ${participants.length>20 ? ` ... (+${participants.length-20}ëª…)` : ``}
        </div>
      `;
    }

    // ====== mode UI
    function applyModeUI(){
      const isTeam = (mode==="team");
      $("teamSection").classList.toggle("hidden", !isTeam);
      $("teamsBoxWrap").classList.toggle("hidden", !isTeam);

      $("singleSection").classList.toggle("hidden", isTeam);
      $("singlePreviewWrap").classList.toggle("hidden", isTeam);

      renderTeams();
      renderGroupsEditor();
      renderSinglePreview();
    }

    function setMode(next){
      mode = next;
      applyModeUI();
    }

    // ====== single options show/hide
    function applySingleOpts(){
      const fmt = $("singleFormat").value;
      const showGroup = (fmt==="group_knockout");
      $("groupOpts").classList.toggle("hidden", !showGroup);

      $("singleHint").textContent =
        fmt==="roundrobin" ? "ê°œì¸ í’€ë¦¬ê·¸ë¡œ ì €ì¥ë©ë‹ˆë‹¤(ì¡°/í† ë„ˆ ì„¤ì • ì—†ìŒ)."
      : fmt==="group_knockout" ? "ì¡°ë³„ë¦¬ê·¸ í›„ í† ë„ˆë¨¼íŠ¸ë¡œ ì €ì¥ë©ë‹ˆë‹¤(ì¡° ê°œìˆ˜/ì§„ì¶œ ìˆ˜/ì¡° í¸ì„± ì €ì¥)."
      : "ë°”ë¡œ í† ë„ˆë¨¼íŠ¸ë¡œ ì €ì¥ë©ë‹ˆë‹¤(ì¡° ì„¤ì • ì—†ìŒ).";

      // í˜•ì‹ ë³€ê²½ ì‹œ ì¡°ëŠ” ì´ˆê¸°í™”
      if(fmt!=="group_knockout"){
        groups = {};
      }

      renderGroupsEditor();
      renderSinglePreview();
    }

    // ====== Save to Firebase
    async function saveToFirebase(){
      const pool = poolPlayers();
      if(pool.length < 2){
        alert("ì°¸ê°€ìê°€ 2ëª… ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
        return;
      }

      // ì°¸ê°€ì: ì €ì¥ìš©ìœ¼ë¡œ â€œì•ˆì •ì ì¸ idâ€ë¥¼ ë§Œë“¤ì–´ ì €ì¥
      // - ì¡°ë³„+í† ë„ˆë¥¼ ì“°ë ¤ë©´, groupsê°€ participant idë¥¼ ì°¸ì¡°í•´ì•¼ í•˜ë¯€ë¡œ
      // - ì¡° ìë™í¸ì„±ì„ ëˆ„ë¥´ë©´ participantCacheê°€ ì±„ì›Œì§€ê³  ê·¸ idë¥¼ groupsê°€ ì‚¬ìš©
      // - ì¡°ë¥¼ ì•ˆ ëˆ„ë¥´ê³  ì €ì¥í•  ìˆ˜ë„ ìˆìœ¼ë‹ˆ, ì €ì¥ ì§ì „ì— participantCacheë¥¼ ìƒˆë¡œ ë§Œë“¤ê³ 
      //   groupsê°€ ìˆë‹¤ë©´ â€œì´ë¦„ê¸°ë°˜ ë§¤ì¹­â€ì´ ì•„ë‹ˆë¼, ì—¬ê¸°ì„œëŠ” â€œê·¸ëŒ€ë¡œ ì €ì¥(ë‹¨, ë¹ˆ ì¡°ë©´ ê²½ê³ )â€
      const participants = computeParticipants(); // participantCache ê°±ì‹ 

      if(mode==="team"){
        if(!teams.length){
          alert("ë‹¨ì²´ì „ì€ íŒ€ì„ ë¨¼ì € êµ¬ì„±í•´ì•¼ í•©ë‹ˆë‹¤.");
          return;
        }
        const empty = teams.filter(t=>!(t.players||[]).length).length;
        if(empty){
          if(!confirm(`ë¹ˆ íŒ€ì´ ${empty}ê°œ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ì €ì¥í• ê¹Œìš”?`)) return;
        }
      }else{
        const fmt = $("singleFormat").value;
        if(fmt==="group_knockout"){
          const keys = Object.keys(groups||{});
          if(!keys.length){
            if(!confirm("ì¡°ë³„+í† ë„ˆì¸ë° ì¡° í¸ì„±ì´ ì—†ìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ì €ì¥í• ê¹Œìš”? (team-liveì—ì„œ ì¡° ì§„í–‰ì´ ì•ˆë©ë‹ˆë‹¤)")) return;
          }else{
            // participant idê°€ ì €ì¥ ì§ì „ì— ë°”ë€Œë©´ ì•ˆ ë˜ë¯€ë¡œ,
            // ì¡°ê°€ ìˆì„ ë• participantCacheë¥¼ â€œì¡° í¸ì„± ìƒì„± ë‹¹ì‹œâ€ì˜ idë¡œ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.
            // => í•´ê²°: ì¡° í¸ì„± ë²„íŠ¼(ìë™ í¸ì„±) ëˆ„ë¥´ë©´ participantCacheê°€ ìƒì„±ë˜ê³  groupsê°€ ê·¸ idë¥¼ ì°¸ì¡°.
            // ì €ì¥ ì§ì „ì— computeParticipants()ë¡œ idë¥¼ ìƒˆë¡œ ë§Œë“¤ë©´ groupsê°€ ê¹¨ì§ˆ ìˆ˜ ìˆì–´ìš”.
            // ê·¸ë˜ì„œ: ì¡°ê°€ ì¡´ì¬í•˜ë©´ participantCacheë¥¼ ì¬ìƒì„±í•˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ì“°ëŠ” ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬
            // (participantCacheê°€ ë¹„ì–´ìˆìœ¼ë©´ ê²½ê³  í›„ ìë™ í¸ì„± ìœ ë„)
            if(participantCache.length===0){
              alert("ì¡°ê°€ ìˆëŠ”ë° ì°¸ê°€ìIDê°€ ì—†ìŠµë‹ˆë‹¤. â€˜ì¡° ìë™ í¸ì„±â€™ì„ ë¨¼ì € ëˆŒëŸ¬ì£¼ì„¸ìš”.");
              return;
            }
          }
        }
      }

      setStatus("Firebase ì—°ê²° ì¤‘...");
      try{
        await signInAnonymously(auth);
      }catch(e){
        console.error(e);
        setStatus("ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)", "err");
        return;
      }

      const config = { mode };

      if(mode==="team"){
        // ë‹¨ì²´ì „ì€ íŒ€ êµ¬ì„±ë§Œ ì €ì¥
      }else{
        const fmt = $("singleFormat").value;
        config.single = { format: fmt };
        if(fmt==="group_knockout"){
          config.single.groupCount = Number($("groupCount").value);
          config.single.advancePerGroup = Number($("advancePerGroup").value);
        }
      }

      const payload = {
        updatedAt: Date.now(),
        config,
        participants: (mode==="single" && participantCache.length) ? participantCache : participants
      };

      if(mode==="team"){
        payload.teams = teams.map(t=>({
          id: t.id,
          players: (t.players||[]).map(p=>({ name:p.name, grade:p.grade })),
          sum: teamSum(t.players||[])
        }));
      }else{
        // âœ… ê°œì¸ì „ ì¡° í¸ì„± ì €ì¥
        if(config?.single?.format === "group_knockout" && Object.keys(groups||{}).length){
          payload.groups = groups; // {A:[pid...], B:[pid...]}
        }else{
          payload.groups = null;
        }
      }

      try{
        await set(ref(db, PATH.current), payload);
        setStatus("ì €ì¥ ì™„ë£Œ: teamLive/current", "oktxt");
        alert("âœ… ì €ì¥ ì™„ë£Œ! ì´ì œ team-liveë¡œ ì´ë™í•´ì„œ ëŒ€ì§„ ìƒì„± â†’ ê²½ê¸° ì§„í–‰ì„ í•˜ì‹œë©´ ë©ë‹ˆë‹¤.");
      }catch(e){
        console.error(e);
        setStatus("ì €ì¥ ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)", "err");
        alert("âŒ ì €ì¥ ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
      }
    }

    // ====== Player add/remove
    function addPlayer(){
      const name = $("newName").value.trim();
      const g = clampGrade($("newGrade").value);
      if(!name || !g){
        alert("ì´ë¦„ê³¼ ë¶€ìˆ˜(1~14)ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      allPlayers.push({ name, grade:g, isNew:true });
      saveAddedToLS();
      $("newName").value = "";
      $("newGrade").value = "";
      renderPlayers();
      renderSinglePreview();
      setStatus(`ì„ ìˆ˜ ì¶”ê°€ë¨: ${name}(${g}ë¶€)`, "oktxt");
    }

    function clearAdded(){
      if(!confirm("ì¶”ê°€í•œ ì„ ìˆ˜(ë¡œì»¬ ì €ì¥) ì „ì²´ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
      allPlayers = allPlayers.filter(p=>!p.isNew);
      localStorage.removeItem("pp_addedPlayers");
      selected.clear();
      groups = {};
      participantCache = [];
      renderPlayers();
      renderGroupsEditor();
      renderSinglePreview();
      setStatus("ì¶”ê°€ ì„ ìˆ˜ ì‚­ì œ ì™„ë£Œ", "oktxt");
    }

    // ====== Bind UI
    $("reloadBtn").addEventListener("click", loadMembers);
    $("addBtn").addEventListener("click", addPlayer);
    $("clearAddedBtn").addEventListener("click", clearAdded);

    $("clearSelectBtn").addEventListener("click", ()=>{
      selected.clear();
      groups = {};
      participantCache = [];
      renderPlayers();
      renderGroupsEditor();
      renderSinglePreview();
      $("selInfo").textContent = "ì„ íƒ 0ëª…";
    });

    $("autoBtn").addEventListener("click", ()=>{
      buildAutoTeams(Number($("teamCount").value));
    });

    $("manualBtn").addEventListener("click", ()=>{
      alert("ìˆ˜ë™ ë°°ì •ì€ í˜„ì¬ â€˜ì´ë™/ì‚­ì œâ€™ë¡œ ì¡°ì •í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.\nì›í•˜ì‹œë©´ â€˜ì°¸ì„ìâ†’íŒ€ ë²„íŠ¼â€™ ë°©ì‹(í´ë¦­ìœ¼ë¡œ ë°°ì •)ë„ ë§Œë“¤ì–´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.");
      if(!teams.length) buildAutoTeams(Number($("teamCount").value));
    });

    $("resetTeamsBtn").addEventListener("click", ()=>{
      if(!confirm("íŒ€ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
      teams = [];
      renderTeams();
      setStatus("íŒ€ ì´ˆê¸°í™” ì™„ë£Œ", "oktxt");
    });

    // ê°œì¸ì „ ì¡° ë²„íŠ¼
    $("autoGroupBtn").addEventListener("click", autoMakeGroups);
    $("clearGroupsBtn").addEventListener("click", clearGroups);

    // mode picker
    $("modePicker").querySelectorAll(".radioCard").forEach(card=>{
      card.addEventListener("click", ()=>{
        $("modePicker").querySelectorAll(".radioCard").forEach(c=>c.classList.remove("on"));
        card.classList.add("on");
        const next = card.getAttribute("data-mode");
        setMode(next);
      });
    });

    // single format options
    $("singleFormat").addEventListener("change", applySingleOpts);
    $("groupCount").addEventListener("change", ()=>{
      // ì¡° ê°œìˆ˜ê°€ ë°”ë€Œë©´ ì¡° ì´ˆê¸°í™”
      groups = {};
      participantCache = [];
      renderGroupsEditor();
      renderSinglePreview();
    });
    $("advancePerGroup").addEventListener("change", renderSinglePreview);

    // save buttons
    $("saveBtn").addEventListener("click", saveToFirebase);
    $("saveBtn2").addEventListener("click", saveToFirebase);

    // open live
    const goLive = ()=>{ window.location.href = "../team-live/index.html"; };
    $("openLiveBtn").addEventListener("click", goLive);
    $("openLiveBtn2").addEventListener("click", goLive);

    // init
    setMode("team");
    applySingleOpts();
    loadMembers();
  </script>
</body>
</html>