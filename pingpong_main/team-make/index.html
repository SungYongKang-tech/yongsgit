<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ“ KOEN ë‹¨ì²´ì „ íŒ€ êµ¬ì„± (team-make)</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --bd:#e6e8ef;
      --txt:#0f172a; --mut:#64748b; --r:16px;
      --accent:#2563eb; --ok:#16a34a; --danger:#ef4444; --warn:#f59e0b;
      --shadow:0 10px 28px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--txt)}
    .wrap{max-width:1100px;margin:0 auto;padding:12px}
    h2{margin:6px 0 12px;font-size:16px;font-weight:950;text-align:center}

    .card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--shadow);padding:12px;margin-bottom:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}
    .input, select{
      padding:10px 12px;border:1px solid var(--bd);border-radius:12px;background:#fff;font-size:14px
    }
    .btn{
      padding:10px 14px;border:1px solid rgba(37,99,235,.25);
      background:linear-gradient(180deg,#2b74ff,#2563eb);
      color:#fff;border-radius:12px;cursor:pointer;font-weight:950;
    }
    .btn.secondary{background:#fff;color:#0f172a;border:1px solid var(--bd)}
    .btn.ok{background:linear-gradient(180deg,#22c55e,#16a34a);border:1px solid rgba(22,163,74,.25)}
    .btn.danger{background:linear-gradient(180deg,#ff5a5a,#ef4444);border:1px solid rgba(239,68,68,.25)}
    .btn.warn{background:linear-gradient(180deg,#fbbf24,#f59e0b);border:1px solid rgba(245,158,11,.25)}

    .mut{color:var(--mut);font-weight:750;font-size:12px;margin-top:8px;text-align:center}
    .err{color:#b91c1c;font-weight:950;text-align:center}
    .oktxt{color:#166534;font-weight:950;text-align:center}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){ .grid2{grid-template-columns:1fr} }

    .box{border:1px solid var(--bd);border-radius:14px;background:#fff;padding:12px}
    .box h3{margin:0 0 10px;font-size:14px;font-weight:1000}

    .pill{padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:#f8fafc;font-weight:900}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border:1px solid var(--bd);
      border-radius:999px;background:#f8fafc;margin:4px 6px 0 0;font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .chip.sel{outline:2px solid rgba(37,99,235,.35); background:#eef2ff}

    .playerWrap{display:flex;flex-wrap:wrap;gap:6px;justify-content:center}
    .player{
      display:inline-flex;align-items:center;gap:6px;
      padding:8px 10px;border:1px solid var(--bd);border-radius:999px;background:#fff;
      font-weight:900; cursor:pointer;
    }
    .player small{color:var(--mut);font-weight:800}
    .player.on{background:#eef2ff;border-color:#c7d2fe}

    .teams{display:flex;flex-direction:column;gap:10px}
    .team{border:1px solid var(--bd);border-radius:14px;padding:10px;background:#f8fafc}
    .team .tline{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
    .team .name{font-weight:950}
    .team .meta{color:var(--mut);font-weight:800;font-size:12px}
    .team ul{margin:8px 0 0;padding-left:18px}
    .team li{margin:3px 0;font-weight:900}

    .swap-pending{ outline: 2px dashed #ff6f00; border-radius: 10px; }

    .groupBox{
      display:flex;flex-wrap:wrap;gap:10px;align-items:flex-start;
    }
    .gcard{
      border:1px solid var(--bd);border-radius:14px;background:#fff;padding:10px;min-width:220px;flex:1;
    }
    .gtitle{font-weight:1000;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
    .glist{min-height:44px}
    .glist .chip{background:#f1f5f9}
    .gdrop{border:2px dashed #cbd5e1;border-radius:12px;padding:10px;background:#f8fafc}
    .gdrop.on{border-color:#93c5fd;background:#eff6ff}

    .divider{height:1px;background:var(--bd);margin:10px 0}
  </style>
</head>

<body>
  <div class="wrap">
    <h2>ğŸ“ KOEN ë‹¨ì²´ì „ íŒ€ êµ¬ì„± (team-make)</h2>

    <div class="card">
      <div class="row">
        <span class="pill">ë¶€ìˆ˜: 1ë¶€ ~ 14ë¶€</span>
        <span class="pill">ì €ì¥ ìœ„ì¹˜: teamLive/current</span>
        <button class="btn secondary" id="reloadBtn">ì„ ìˆ˜ ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div class="mut" id="status">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <!-- ì„ ìˆ˜ ì¶”ê°€ -->
    <div class="card">
      <div class="row" style="justify-content:space-between;max-width:900px;margin:0 auto">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <input class="input" id="newName" placeholder="ì´ë¦„" style="width:140px" />
          <input class="input" id="newGrade" type="number" min="1" max="14" placeholder="ë¶€ìˆ˜(1~14)" style="width:120px" />
          <button class="btn" id="addBtn">ì„ ìˆ˜ ì¶”ê°€</button>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <button class="btn secondary" id="clearAddedBtn">ì¶”ê°€ ì„ ìˆ˜ ì „ì²´ ì‚­ì œ</button>
          <button class="btn secondary" id="clearSelectBtn">ì°¸ì„ì ì„ íƒ í•´ì œ</button>
        </div>
      </div>
      <div class="mut">ì°¸ì„ì ì„ íƒì´ ì—†ìœ¼ë©´ â€œì „ì²´ ëª…ë‹¨â€ìœ¼ë¡œ íŒ€ì´ êµ¬ì„±ë©ë‹ˆë‹¤.</div>
    </div>

    <!-- ì°¸ì„ì ëª©ë¡ -->
    <div class="card">
      <div style="font-size:14px;font-weight:1000;text-align:center;margin-bottom:10px">ì°¸ì„ì ëª©ë¡(í´ë¦­í•´ì„œ ì„ íƒ)</div>
      <div class="playerWrap" id="playerList"></div>
      <div class="mut" id="selInfo">ì„ íƒ 0ëª…</div>
    </div>

    <!-- íŒ€ ìƒì„± -->
    <div class="card">
      <div class="row">
        <label style="font-weight:950">
          íŒ€ ìˆ˜(2~8)
          <select id="teamCount" class="input">
            <option>2</option><option>3</option><option selected>4</option><option>5</option>
            <option>6</option><option>7</option><option>8</option>
          </select>
        </label>
        <button class="btn ok" id="autoBtn">íŒ€ ìë™ ë°°ì •</button>
        <button class="btn warn" id="manualBtn">íŒ€ ìˆ˜ë™ ë°°ì • ì‹œì‘</button>
        <button class="btn secondary" id="resetTeamsBtn">íŒ€ ì´ˆê¸°í™”</button>
      </div>
      <div class="mut">ìë™/ìˆ˜ë™ìœ¼ë¡œ íŒ€ì„ ë§Œë“  ë’¤, (ì„ íƒ) ì¡° í¸ì„±ì„ í•˜ê³  Firebaseì— ì €ì¥í•˜ì„¸ìš”.</div>
    </div>

    <div class="grid2">
      <!-- íŒ€ êµ¬ì„± -->
      <div class="box">
        <h3>í˜„ì¬ íŒ€ êµ¬ì„±</h3>
        <div class="teams" id="teamsBox"><div class="mut">íŒ€ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</div></div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn ok" id="saveBtn">Firebase ì €ì¥</button>
          <button class="btn secondary" id="openLiveBtn">team-live ì—´ê¸°</button>
        </div>
        <div class="mut">ì €ì¥ í›„ team-liveì—ì„œ â€œëŒ€ì§„ ìƒì„±â€ì„ ì§„í–‰í•˜ì‹œë©´ ë©ë‹ˆë‹¤.</div>
      </div>

      <!-- ì¡° í¸ì„± -->
      <div class="box">
        <h3>ì¡° í¸ì„±(ì„ íƒ)</h3>
        <div class="row" style="justify-content:space-between">
          <label style="font-weight:950">
            ì¡° ê°œìˆ˜
            <select id="groupCount" class="input">
              <option value="0" selected>ì‚¬ìš© ì•ˆ í•¨</option>
              <option value="2">2ì¡°</option>
              <option value="3">3ì¡°</option>
              <option value="4">4ì¡°</option>
              <option value="5">5ì¡°</option>
              <option value="6">6ì¡°</option>
              <option value="7">7ì¡°</option>
              <option value="8">8ì¡°</option>
            </select>
          </label>
          <button class="btn secondary" id="clearGroupsBtn">ì¡° ì´ˆê¸°í™”</button>
        </div>

        <div class="mut">íŒ€(ì¹©)ì„ í´ë¦­í•´ì„œ â€œì„ íƒâ€í•œ ë’¤, ì›í•˜ëŠ” ì¡° ë°•ìŠ¤ì— ë„£ì–´ì£¼ì„¸ìš”.</div>
        <div class="groupBox" id="groupsBox" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db, auth } from "../firebase.js";
    import { ref, set } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
    import { signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    const $ = (id)=>document.getElementById(id);

    const PATH = {
      current: "teamLive/current"
    };

    // ====== State
    let allPlayers = []; // {name, grade, isNew}
    let selected = new Set(); // player index
    let teams = []; // {id, players:[{name,grade}], sum}
    let groups = {}; // {A:[teamId], B:[teamId]...}
    let selectedTeamId = null; // ì¡° í¸ì„±ìš© "ì„ íƒëœ íŒ€"

    // ====== Utils
    const esc = (s)=>String(s??"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");

    function setStatus(msg, cls="mut"){
      const el = $("status");
      el.className = cls;
      el.textContent = msg;
    }

    function clampGrade(n){
      const x = Number(n);
      if(!Number.isFinite(x)) return null;
      return Math.max(1, Math.min(14, Math.floor(x)));
    }

    function saveAddedToLS(){
      const added = allPlayers.filter(p=>p.isNew).map(p=>({name:p.name, grade:p.grade}));
      localStorage.setItem("pp_addedPlayers", JSON.stringify(added));
    }

    function loadAddedFromLS(){
      try{
        const arr = JSON.parse(localStorage.getItem("pp_addedPlayers") || "[]");
        if(Array.isArray(arr)){
          arr.forEach(p=>{
            if(p?.name && p?.grade){
              const g = clampGrade(p.grade);
              if(g) allPlayers.push({name:String(p.name), grade:g, isNew:true});
            }
          });
        }
      }catch(e){}
    }

    async function loadMembers(){
      setStatus("ì„ ìˆ˜ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
      allPlayers = [];
      selected.clear();
      teams = [];
      groups = {};
      selectedTeamId = null;

      // 1) members.json (ê¸°ì¡´ ê²½ë¡œ ìœ ì§€)
      try{
        const res = await fetch("https://sensational-tulumba-65e97e.netlify.app/pingpong/club/data/members.json", { cache:"no-store" });
        const json = await res.json();
        const base = Object.values(json || {}).map(p=>({
          name: String(p.name ?? ""),
          grade: clampGrade(p.level ?? p.grade ?? 1),
          isNew:false
        })).filter(p=>p.name && p.grade);
        allPlayers.push(...base);
      }catch(e){
        console.error(e);
        // members.json ì‹¤íŒ¨í•´ë„ ì¶”ê°€ì„ ìˆ˜ë§Œìœ¼ë¡œë¼ë„ ë™ì‘í•˜ê²Œ
      }

      // 2) localStorage ì¶”ê°€ ì„ ìˆ˜
      loadAddedFromLS();

      setStatus(`ë¡œë“œ ì™„ë£Œ: ${allPlayers.length}ëª…`, "oktxt");
      renderPlayers();
      renderTeams();
      renderGroupsUI();
    }

    function renderPlayers(){
      const box = $("playerList");
      box.innerHTML = "";

      if(!allPlayers.length){
        box.innerHTML = `<div class="mut">ì„ ìˆ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        $("selInfo").textContent = "ì„ íƒ 0ëª…";
        return;
      }

      allPlayers.forEach((p, idx)=>{
        const el = document.createElement("div");
        el.className = "player" + (selected.has(idx) ? " on" : "");
        el.innerHTML = `
          <span>${esc(p.name)}</span>
          <small>${esc(p.grade)}ë¶€${p.isNew ? " Â· ì‹ ê·œ" : ""}</small>
        `;
        el.addEventListener("click", ()=>{
          if(selected.has(idx)) selected.delete(idx);
          else selected.add(idx);
          renderPlayers();
        });
        box.appendChild(el);
      });

      $("selInfo").textContent = `ì„ íƒ ${selected.size}ëª…`;
    }

    function teamSum(list){ return (list||[]).reduce((s,p)=>s + (p.grade|0), 0); }

    function shuffle(arr){
      const a = [...arr];
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function poolPlayers(){
      const idxs = selected.size ? [...selected] : allPlayers.map((_,i)=>i);
      return idxs.map(i=>allPlayers[i]);
    }

    // ====== Team builders
    function buildAutoTeams(teamCount){
      const pool = poolPlayers();
      if(pool.length < 2){ alert("ì„ ìˆ˜ê°€ 2ëª… ì´ìƒ ìˆì–´ì•¼ í•©ë‹ˆë‹¤."); return; }

      const tc = Number(teamCount);
      if(!(tc>=2 && tc<=8)){ alert("íŒ€ ìˆ˜ëŠ” 2~8"); return; }

      const sorted = shuffle(pool).sort((a,b)=> (b.grade - a.grade)); // ê°•ì ë¨¼ì €
      const out = Array.from({length:tc}, (_,i)=>({ id:`T${i+1}`, players:[], sum:0 }));

      // ì¸ì› ê· ë“± ëª©í‘œ
      const total = sorted.length;
      const base = Math.floor(total / tc);
      const extra = total % tc;
      const maxPer = out.map((_,i)=> i<extra ? base+1 : base);

      // í‰ê·  ë‚®ì€ íŒ€ì— ë°°ì¹˜
      sorted.forEach(p=>{
        const cand = out
          .map((t,i)=>({t,i}))
          .filter(x=> x.t.players.length < maxPer[x.i])
          .sort((x,y)=>{
            const ax = x.t.players.length ? x.t.sum/x.t.players.length : 0;
            const ay = y.t.players.length ? y.t.sum/y.t.players.length : 0;
            return ax - ay;
          })[0];
        cand.t.players.push({ name:p.name, grade:p.grade });
        cand.t.sum += p.grade;
      });

      // ì•½ê°„ì˜ ìŠ¤ì™‘ìœ¼ë¡œ í‰ê·  ë§ì¶”ê¸°
      const avg = (t)=> t.players.length ? (t.sum / t.players.length) : 0;
      for(let loop=0; loop<30; loop++){
        const avgs = out.map(avg);
        const hi = avgs.indexOf(Math.max(...avgs));
        const lo = avgs.indexOf(Math.min(...avgs));
        const high = out[hi], low = out[lo];
        const diffBefore = Math.abs(avg(high) - avg(low));
        if(diffBefore < 0.35) break;

        let best = null;
        let bestImprove = 0;
        for(const hp of high.players){
          for(const lp of low.players){
            const newHigh = (high.sum - hp.grade + lp.grade) / high.players.length;
            const newLow  = (low.sum  - lp.grade + hp.grade) / low.players.length;
            const diffAfter = Math.abs(newHigh - newLow);
            const imp = diffBefore - diffAfter;
            if(imp > bestImprove){
              bestImprove = imp;
              best = {hp, lp};
            }
          }
        }
        if(best && bestImprove > 0){
          const hiIdx = high.players.indexOf(best.hp);
          const loIdx = low.players.indexOf(best.lp);
          high.players[hiIdx] = best.lp;
          low.players[loIdx]  = best.hp;
          high.sum = teamSum(high.players);
          low.sum  = teamSum(low.players);
        }else{
          break;
        }
      }

      teams = out;
      // ì¡° í¸ì„±ì€ ìë™íŒ€ì´ ë°”ë€Œë©´ ì´ˆê¸°í™”(í˜¼ì„  ë°©ì§€)
      groups = {};
      selectedTeamId = null;
      renderTeams();
      renderGroupsUI();
    }

    // ====== Manual mode (ê°„ë‹¨ ë²„ì „: íŒ€ì— í´ë¦­ìœ¼ë¡œ ë„£ê¸° + íŒ€ì› ì´ë™/ì‚­ì œ)
    let manualMode = false;
    let manualPick = null; // {playerIdx}

    function startManual(teamCount){
      const poolIdxs = selected.size ? [...selected] : allPlayers.map((_,i)=>i);
      if(poolIdxs.length < 2){ alert("ì„ ìˆ˜ê°€ 2ëª… ì´ìƒ ìˆì–´ì•¼ í•©ë‹ˆë‹¤."); return; }

      const tc = Number(teamCount);
      if(!(tc>=2 && tc<=8)){ alert("íŒ€ ìˆ˜ëŠ” 2~8"); return; }

      teams = Array.from({length:tc}, (_,i)=>({ id:`T${i+1}`, players:[], sum:0 }));
      groups = {};
      selectedTeamId = null;
      manualMode = true;
      manualPick = null;

      // ì°¸ì„ì ëª©ë¡ì„ "ë¯¸ë°°ì •" ì¤‘ì‹¬ìœ¼ë¡œ ì¬êµ¬ì„±
      // (ë°°ì •ì€ playerIdx ê¸°ë°˜ìœ¼ë¡œ í•˜ë ¤ë©´ _src ì €ì¥ì´ í•„ìš”í•˜ì§€ë§Œ, ì—¬ê¸°ì„  ê°„ë‹¨íˆ ì´ë¦„/ë¶€ìˆ˜ë¡œ ë„£ê³  ë¯¸ë°°ì •ì€ í´ë¦­ìœ¼ë¡œ ì²˜ë¦¬)
      // => UI: ì°¸ì„ì í´ë¦­ -> ì•„ë˜ "ì„ íƒëœ ì‚¬ëŒ" í‘œì‹œ -> íŒ€ ì¹´ë“œì˜ "ì¶”ê°€" ë²„íŠ¼ìœ¼ë¡œ ë„£ê¸°
      renderTeams();
      renderGroupsUI();
      renderPlayersManual(poolIdxs);
      setStatus("ìˆ˜ë™ ë°°ì • ëª¨ë“œ: ì°¸ì„ì í´ë¦­ â†’ íŒ€ì— ì¶”ê°€", "oktxt");
    }

    function stopManual(){
      manualMode = false;
      manualPick = null;
      setStatus(`ë¡œë“œ ì™„ë£Œ: ${allPlayers.length}ëª…`, "oktxt");
      renderPlayers();
    }

    function renderPlayersManual(poolIdxs){
      const box = $("playerList");
      box.innerHTML = "";

      const assignedNames = new Set();
      teams.forEach(t=> t.players.forEach(p=>assignedNames.add(`${p.name}__${p.grade}`)));

      poolIdxs.forEach(idx=>{
        const p = allPlayers[idx];
        const key = `${p.name}__${p.grade}`;
        const isAssigned = assignedNames.has(key);

        const el = document.createElement("div");
        el.className = "player" + ((manualPick?.playerIdx===idx) ? " on" : "");
        el.style.opacity = isAssigned ? "0.35" : "1";
        el.style.pointerEvents = isAssigned ? "none" : "auto";
        el.innerHTML = `<span>${esc(p.name)}</span><small>${esc(p.grade)}ë¶€${p.isNew?" Â· ì‹ ê·œ":""}</small>`;
        el.addEventListener("click", ()=>{
          manualPick = { playerIdx: idx };
          renderPlayersManual(poolIdxs);
          $("selInfo").textContent = `ì„ íƒ: ${p.name}(${p.grade}ë¶€)`;
        });
        box.appendChild(el);
      });

      if(!manualPick) $("selInfo").textContent = "ì„ íƒ 0ëª…";
    }

    function addPickToTeam(teamIdx){
      if(!manualMode || !manualPick) return;
      const p = allPlayers[manualPick.playerIdx];
      teams[teamIdx].players.push({ name:p.name, grade:p.grade });
      teams[teamIdx].sum = teamSum(teams[teamIdx].players);
      manualPick = null;

      // ë‹¤ì‹œ ë Œë” (pool ì¬êµ¬ì„±ì´ í•„ìš”í•´ì„œ selected ê¸°ë°˜ìœ¼ë¡œ ì¬í˜¸ì¶œ)
      const poolIdxs = selected.size ? [...selected] : allPlayers.map((_,i)=>i);
      renderTeams();
      renderPlayersManual(poolIdxs);
    }

    function removeFromTeam(teamIdx, playerIdx){
      teams[teamIdx].players.splice(playerIdx, 1);
      teams[teamIdx].sum = teamSum(teams[teamIdx].players);
      renderTeams();

      if(manualMode){
        const poolIdxs = selected.size ? [...selected] : allPlayers.map((_,i)=>i);
        renderPlayersManual(poolIdxs);
      }
    }

    function moveMember(teamIdx, playerIdx){
      const to = prompt(`ì´ë™í•  íŒ€ ë²ˆí˜¸(1~${teams.length}) ì…ë ¥`);
      if(to===null) return;
      const toIdx = Number(to) - 1;
      if(!(toIdx>=0 && toIdx<teams.length)) { alert("ì˜ëª»ëœ íŒ€"); return; }
      if(toIdx === teamIdx) { alert("ê°™ì€ íŒ€"); return; }

      const p = teams[teamIdx].players[playerIdx];
      teams[teamIdx].players.splice(playerIdx,1);
      teams[toIdx].players.push(p);

      teams[teamIdx].sum = teamSum(teams[teamIdx].players);
      teams[toIdx].sum = teamSum(teams[toIdx].players);

      renderTeams();
      if(manualMode){
        const poolIdxs = selected.size ? [...selected] : allPlayers.map((_,i)=>i);
        renderPlayersManual(poolIdxs);
      }
    }

    // ====== Render teams
    function renderTeams(){
      const box = $("teamsBox");
      if(!teams.length){
        box.innerHTML = `<div class="mut">íŒ€ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      box.innerHTML = teams.map((t, ti)=>{
        const avg = t.players.length ? (t.sum / t.players.length).toFixed(2) : "-";
        const list = t.players
          .slice()
          .sort((a,b)=>a.grade-b.grade)
          .map((p, pi)=>`
            <li>
              ${esc(p.name)}(${esc(p.grade)}ë¶€)
              <span style="display:inline-flex;gap:6px;margin-left:8px;vertical-align:middle">
                <button class="btn secondary" style="padding:6px 10px;border-radius:10px" data-move="${ti},${pi}">ì´ë™</button>
                <button class="btn danger" style="padding:6px 10px;border-radius:10px" data-del="${ti},${pi}">ì‚­ì œ</button>
              </span>
            </li>
          `).join("");

        return `
          <div class="team">
            <div class="tline">
              <div class="name">
                <span class="chip ${selectedTeamId===t.id ? "sel":""}" data-teamchip="${esc(t.id)}">
                  ${esc(t.id)} íŒ€
                </span>
              </div>
              <div class="meta">ë¶€ìˆ˜í•© ${esc(t.sum)} / í‰ê·  ${esc(avg)}</div>
            </div>

            ${manualMode ? `
              <div class="row" style="justify-content:flex-start;margin-top:8px">
                <button class="btn ok" style="padding:8px 12px;border-radius:12px" data-addpick="${ti}">
                  ì„ íƒëœ ì°¸ì„ì â†’ ${esc(t.id)}íŒ€ì— ì¶”ê°€
                </button>
              </div>
            ` : ``}

            <ul>${list || `<li class="mut" style="list-style:none">íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤.</li>`}</ul>
          </div>
        `;
      }).join("");

      // íŒ€ì¹© ì„ íƒ (ì¡° í¸ì„±ìš©)
      box.querySelectorAll("[data-teamchip]").forEach(el=>{
        el.addEventListener("click", ()=>{
          selectedTeamId = el.getAttribute("data-teamchip");
          renderTeams();
        });
      });

      // ì´ë™/ì‚­ì œ
      box.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const [ti,pi] = btn.getAttribute("data-del").split(",").map(Number);
          removeFromTeam(ti,pi);
        });
      });
      box.querySelectorAll("button[data-move]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const [ti,pi] = btn.getAttribute("data-move").split(",").map(Number);
          moveMember(ti,pi);
        });
      });

      // ìˆ˜ë™ëª¨ë“œ: ì„ íƒ ì¸ì› íŒ€ì— ë„£ê¸°
      box.querySelectorAll("button[data-addpick]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const ti = Number(btn.getAttribute("data-addpick"));
          addPickToTeam(ti);
        });
      });
    }

    // ====== Groups UI
    const GROUP_NAMES = ["A","B","C","D","E","F","G","H"];

    function ensureGroups(count){
      groups = {};
      for(let i=0;i<count;i++){
        groups[GROUP_NAMES[i]] = [];
      }
    }

    function renderGroupsUI(){
      const n = Number($("groupCount").value);
      const box = $("groupsBox");
      box.innerHTML = "";

      if(!teams.length){
        box.innerHTML = `<div class="mut">íŒ€ ìƒì„± í›„ ì¡° í¸ì„±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>`;
        return;
      }
      if(n === 0){
        box.innerHTML = `<div class="mut">ì¡° í¸ì„± ì‚¬ìš© ì•ˆ í•¨(ë¦¬ê·¸ì „/í† ë„ˆë¨¼íŠ¸ë¡œ ì§„í–‰ ê°€ëŠ¥)</div>`;
        return;
      }

      // groups êµ¬ì¡° ë§ì¶”ê¸°
      const wantKeys = GROUP_NAMES.slice(0,n);
      const newGroups = {};
      wantKeys.forEach(k=>{
        newGroups[k] = Array.isArray(groups?.[k]) ? [...groups[k]] : [];
      });
      groups = newGroups;

      box.innerHTML = wantKeys.map(g=>{
        const ids = groups[g] || [];
        return `
          <div class="gcard">
            <div class="gtitle">
              <span>${esc(g)}ì¡°</span>
              <button class="btn secondary" style="padding:6px 10px;border-radius:10px" data-gclear="${esc(g)}">ë¹„ìš°ê¸°</button>
            </div>
            <div class="gdrop" data-gdrop="${esc(g)}">
              <div class="mut" style="text-align:left;margin:0 0 8px 0">
                íŒ€ì„ ì„ íƒí•˜ê³ (ì™¼ìª½ íŒ€ì¹©) â†’ ì´ ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ë©´ ${esc(g)}ì¡°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤.
              </div>
              <div class="glist" id="glist_${esc(g)}">
                ${ids.length ? ids.map(id=>`
                  <span class="chip" data-gremove="${esc(g)},${esc(id)}">${esc(id)}</span>
                `).join("") : `<span class="mut">ë¹„ì–´ìˆìŒ</span>`}
              </div>
            </div>
          </div>
        `;
      }).join("");

      // drop click: add selectedTeamId
      box.querySelectorAll("[data-gdrop]").forEach(el=>{
        el.addEventListener("click", ()=>{
          const g = el.getAttribute("data-gdrop");
          if(!selectedTeamId){
            alert("ë¨¼ì € ì™¼ìª½ì—ì„œ íŒ€ì¹©(T1, T2...)ì„ í´ë¦­í•´ ì„ íƒí•˜ì„¸ìš”.");
            return;
          }
          // ì¤‘ë³µ ë°©ì§€ + ë‹¤ë¥¸ ì¡°ì— ìˆìœ¼ë©´ ì œê±°
          for(const k of Object.keys(groups)){
            groups[k] = (groups[k] || []).filter(id=>id !== selectedTeamId);
          }
          groups[g] = groups[g] || [];
          if(!groups[g].includes(selectedTeamId)){
            groups[g].push(selectedTeamId);
          }
          renderGroupsUI();
        });
      });

      // remove chip
      box.querySelectorAll("[data-gremove]").forEach(el=>{
        el.addEventListener("click", ()=>{
          const [g,id] = el.getAttribute("data-gremove").split(",");
          groups[g] = (groups[g]||[]).filter(x=>x !== id);
          renderGroupsUI();
        });
      });

      // clear group
      box.querySelectorAll("[data-gclear]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const g = btn.getAttribute("data-gclear");
          groups[g] = [];
          renderGroupsUI();
        });
      });
    }

    function sanitizeGroups(){
      // ì¡° í¸ì„± OFFë©´ ë¹ˆ ê°ì²´
      const n = Number($("groupCount").value);
      if(!n) return {};

      const wantKeys = GROUP_NAMES.slice(0,n);
      const out = {};
      wantKeys.forEach(k=>{
        out[k] = (groups?.[k] || []).filter(Boolean);
      });
      return out;
    }

    // ====== Save to Firebase (teamLive/current)
    async function saveToFirebase(){
      if(!teams.length){
        alert("íŒ€ì´ ì—†ìŠµë‹ˆë‹¤. íŒ€ì„ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”.");
        return;
      }
      // íŒ€ë§ˆë‹¤ ìµœì†Œ 1ëª… ê¶Œì¥(ê°•ì œëŠ” ì•ˆ í•¨)
      const empty = teams.filter(t=>!(t.players||[]).length).length;
      if(empty){
        if(!confirm(`ë¹ˆ íŒ€ì´ ${empty}ê°œ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ì €ì¥í• ê¹Œìš”?`)) return;
      }

      // ìµëª… ë¡œê·¸ì¸
      setStatus("Firebase ì—°ê²° ì¤‘...");
      try{
        await signInAnonymously(auth);
      }catch(e){
        console.error(e);
        setStatus("ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)", "err");
        return;
      }

      // payload: team-liveê°€ ì½ê¸° ì‰¬ìš´ í˜•íƒœ
      const payload = {
        updatedAt: Date.now(),
        teams: teams.map(t=>({
          id: t.id,
          players: (t.players||[]).map(p=>({ name:p.name, grade:p.grade })),
          sum: teamSum(t.players||[])
        })),
        groups: sanitizeGroups()
      };

      try{
        await set(ref(db, PATH.current), payload);
        setStatus("ì €ì¥ ì™„ë£Œ: teamLive/current", "oktxt");
        alert("âœ… ì €ì¥ ì™„ë£Œ! ì´ì œ team-liveì—ì„œ ëŒ€ì§„ ìƒì„±/ê²½ê¸° ì§„í–‰ì„ í•˜ì‹œë©´ ë©ë‹ˆë‹¤.");
      }catch(e){
        console.error(e);
        setStatus("ì €ì¥ ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)", "err");
        alert("âŒ ì €ì¥ ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
      }
    }

    // ====== Player add/remove
    function addPlayer(){
      const name = $("newName").value.trim();
      const g = clampGrade($("newGrade").value);
      if(!name || !g){
        alert("ì´ë¦„ê³¼ ë¶€ìˆ˜(1~14)ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      allPlayers.push({ name, grade:g, isNew:true });
      saveAddedToLS();
      $("newName").value = "";
      $("newGrade").value = "";
      renderPlayers();
      setStatus(`ì„ ìˆ˜ ì¶”ê°€ë¨: ${name}(${g}ë¶€)`, "oktxt");
    }

    function clearAdded(){
      if(!confirm("ì¶”ê°€í•œ ì„ ìˆ˜(ë¡œì»¬ ì €ì¥) ì „ì²´ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
      allPlayers = allPlayers.filter(p=>!p.isNew);
      localStorage.removeItem("pp_addedPlayers");
      selected.clear();
      renderPlayers();
      setStatus("ì¶”ê°€ ì„ ìˆ˜ ì‚­ì œ ì™„ë£Œ", "oktxt");
    }

    // ====== Bind UI
    $("reloadBtn").addEventListener("click", loadMembers);
    $("addBtn").addEventListener("click", addPlayer);
    $("clearAddedBtn").addEventListener("click", clearAdded);
    $("clearSelectBtn").addEventListener("click", ()=>{
      selected.clear();
      renderPlayers();
      $("selInfo").textContent = "ì„ íƒ 0ëª…";
    });

    $("autoBtn").addEventListener("click", ()=>{
      stopManual(); // ìë™ë°°ì • ì‹œì‘ ì‹œ ìˆ˜ë™ëª¨ë“œ í•´ì œ
      buildAutoTeams(Number($("teamCount").value));
    });

    $("manualBtn").addEventListener("click", ()=>{
      startManual(Number($("teamCount").value));
    });

    $("resetTeamsBtn").addEventListener("click", ()=>{
      if(!confirm("íŒ€/ì¡° í¸ì„±ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
      teams = [];
      groups = {};
      selectedTeamId = null;
      stopManual();
      renderTeams();
      renderGroupsUI();
      setStatus("íŒ€ ì´ˆê¸°í™” ì™„ë£Œ", "oktxt");
    });

    $("groupCount").addEventListener("change", ()=>{
      renderGroupsUI();
    });
    $("clearGroupsBtn").addEventListener("click", ()=>{
      if(!confirm("ì¡° í¸ì„±ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
      groups = {};
      selectedTeamId = null;
      renderGroupsUI();
    });

    $("saveBtn").addEventListener("click", saveToFirebase);

    $("openLiveBtn").addEventListener("click", ()=>{
      // team-make -> team-live
      window.location.href = "../team-live/index.html";
    });

    // ====== Init
    loadMembers();
  </script>
</body>
</html>