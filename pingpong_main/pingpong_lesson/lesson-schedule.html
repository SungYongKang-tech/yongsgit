<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë ˆìŠ¨ ì£¼ê°„ ì‹œê°„í‘œ</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --bd:#e6e8ef;
      --txt:#0f172a; --mut:#64748b; --r:16px;
      --blue:#2563eb; --red:#b91c1c;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--txt)}
    .wrap{max-width:980px;margin:0 auto;padding:12px}
    h2{margin:6px 0 10px;font-size:16px;font-weight:900}

    .topbar{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center; justify-content:flex-start;
      margin:6px 0 10px;
    }
    .btn{
      appearance:none; border:1px solid rgba(15,23,42,.14);
      background:#fff; color:var(--txt);
      padding:9px 10px; border-radius:12px;
      font-weight:900; font-size:13px;
      box-shadow: 0 8px 18px rgba(15,23,42,.06);
      cursor:pointer;
    }
    .btn.on{background:var(--blue); color:#fff; border-color:rgba(37,99,235,.35)}
    .btn.danger{border-color:rgba(185,28,28,.25)}
    .btn.danger.on{background:var(--red); color:#fff; border-color:rgba(185,28,28,.35)}
    .hint{font-size:12px;color:var(--mut);font-weight:800}

    .tableWrap{
      background:var(--card);
      border:1px solid var(--bd);
      border-radius:var(--r);
      overflow:auto; /* ëª¨ë°”ì¼ ê°€ë¡œìŠ¤í¬ë¡¤ */
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      table-layout:auto;   /* ìë™ ë„ˆë¹„ */
    }
    th,td{
      padding:12px 6px;
      border-bottom:1px solid var(--bd);
      border-right:1px solid var(--bd);
      text-align:center;
      font-size:13px;
      vertical-align:top;
      white-space:nowrap;
    }
    th{
      position:sticky; top:0;
      background:#f2f4f8;
      font-weight:900;
      z-index:2;
    }
    th:first-child{
      left:0; z-index:3;
      position:sticky;
      background:#eef2ff;
    }
    td:first-child{
      position:sticky; left:0; z-index:1;
      background:#ffffff;
      font-weight:900;
      color:#0f172a;
    }
    tr:last-child td{border-bottom:none}
    td:last-child, th:last-child{border-right:none}

    .cell{
      font-weight:850;
      line-height:1.35;
      white-space:normal;
      cursor:default;
      user-select:none;
    }
    .admin .cell{ cursor:pointer; }
    .empty{color:rgba(100,116,139,.7); font-weight:700}
    .mut{color:var(--mut);font-weight:700;font-size:12px;margin-top:8px}
    .err{color:var(--red);font-weight:800}

    /* âœ… ìˆ˜ì • í‘œì‹œ(íŒŒë€ ê¸€ì”¨ + ì‘ì€ ğŸ”µ) */
    .modifiedText{ color:var(--blue); font-weight:950; }
    .modIcon{
      display:inline-block;
      margin-left:4px;
      font-size:10px;
      line-height:1;
      vertical-align:middle;
    }
    .absent{ color:var(--red); font-weight:950; }

    /* âœ… swap ì„ íƒ ê°•ì¡° */
    .swapPick{
      outline:2px solid rgba(37,99,235,.45);
      outline-offset:-2px;
      background:rgba(37,99,235,.06);
    }

    /* âœ… ê°„ë‹¨ ëª¨ë‹¬ */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(15,23,42,.45);
      display:none;
      align-items:center; justify-content:center;
      padding:14px;
      z-index:999;
    }
    .modalBack.show{display:flex}
    .modal{
      width:min(520px, 100%);
      background:#fff;
      border-radius:16px;
      border:1px solid rgba(15,23,42,.12);
      box-shadow:0 20px 60px rgba(0,0,0,.18);
      padding:12px;
    }
    .modal h3{
      margin:4px 0 10px;
      font-size:15px;
      font-weight:950;
    }
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    select{
      flex:1;
      padding:11px 10px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.14);
      font-weight:850;
      min-width:220px;
      background:#fff;
    }
    .modal .btn{box-shadow:none}
    .mini{font-size:12px;color:var(--mut);font-weight:850;margin-top:8px}
  </style>
</head>

<body>
  <div class="wrap" id="wrap">
    <h2>ğŸ¾ ë ˆìŠ¨ ì£¼ê°„ ì‹œê°„í‘œ</h2>

    <div class="topbar">
      <button class="btn" id="btnAdmin">ê´€ë¦¬ì ëª¨ë“œ</button>
      <button class="btn danger" id="btnSwap" disabled>êµì²´(SWAP) ëª¨ë“œ</button>
      <button class="btn" id="btnReset" disabled>ì´ë²ˆì£¼ ì´ˆê¸°í™”(ì›ë˜ ë ˆìŠ¨)</button>
      <span class="hint" id="hint">ë³´ê¸° ëª¨ë“œ</span>
    </div>

    <div class="tableWrap">
      <table aria-label="ë ˆìŠ¨ ì£¼ê°„ ì‹œê°„í‘œ">
        <thead>
          <tr id="headRow">
            <th>ì‹œê°„</th>
            <th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="empty">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="mut" id="status"></div>
  </div>

  <!-- âœ… í¸ì§‘ ëª¨ë‹¬ -->
  <div class="modalBack" id="modalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalTitle">í¸ì§‘</h3>
      <div class="row" style="margin-bottom:10px;">
        <select id="studentSelect"></select>
      </div>
      <div class="row">
        <button class="btn on" id="btnAssign">ë°°ì •</button>
        <button class="btn danger on" id="btnAbsent">ë¶ˆì°¸</button>
        <button class="btn" id="btnClear">ë¹„ìš°ê¸°(ê¸°ë³¸ìœ¼ë¡œ)</button>
        <button class="btn" id="btnCancel">ë‹«ê¸°</button>
      </div>
      <div class="mini">
        â€¢ â€œë¹„ìš°ê¸°(ê¸°ë³¸ìœ¼ë¡œ)â€ëŠ” ì´ë²ˆì£¼ ìˆ˜ì •ë¶„ë§Œ ì§€ì›ë‹ˆë‹¤(ì›ë˜ ë ˆìŠ¨í‘œë¡œ ë³µê·€).<br/>
        â€¢ â€œêµì²´(SWAP) ëª¨ë“œâ€ì—ì„œëŠ” ì…€ 2ê°œë¥¼ ì°¨ë¡€ë¡œ ëˆ„ë¥´ë©´ ìë™ìœ¼ë¡œ ìë¦¬ êµì²´ë©ë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <script type="module">
    import { db, auth } from "../firebase.js";
    import { ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    /* =========================
      ê²½ë¡œ(ê¸°ë³¸í‘œëŠ” ê¸°ì¡´ lesson/schedule ì‚¬ìš©)
      - ê¸°ë³¸ ë ˆìŠ¨í‘œ: lesson/schedule (slots êµ¬ì¡°)
      - ì´ë²ˆì£¼ ìˆ˜ì •ë¶„: lesson/overrides/<weekKey>/...
      - ìˆ˜ê°•ì ëª©ë¡: lesson/students
    ========================= */
    const PATH = {
      students: "lesson/students",
      schedule: "lesson/schedule",
      overridesRoot: "lesson/overrides",
    };

    const DAYS_ALL = ["mon","tue","wed","thu","fri"];
    const dayLabel = { mon:"ì›”", tue:"í™”", wed:"ìˆ˜", thu:"ëª©", fri:"ê¸ˆ" };

    const $ = (id)=>document.getElementById(id);

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ISO week (ì›”ìš”ì¼ ì‹œì‘) â†’ "2026-W08"
    function getWeekKey(date = new Date()){
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
    }
    const weekKey = getWeekKey();

    let authed = false;

    let students = {};          // { uid: {name} }
    let scheduleObj = null;     // lesson/schedule ì›ë³¸
    let templateAssign = {};    // scheduleObj â†’ {time:{mon:uid,...}} ë¡œ ë³€í™˜
    let overridesWeek = {};     // lesson/overrides/<weekKey>/...

    let adminMode = false;
    let swapMode = false;
    let swapPick = null; // {time, day}

    const wrap = $("wrap");
    const tbody = $("tbody");
    const headRow = $("headRow");
    const status = $("status");

    const btnAdmin = $("btnAdmin");
    const btnSwap  = $("btnSwap");
    const btnReset = $("btnReset");
    const hint = $("hint");

    // modal
    const modalBack = $("modalBack");
    const modalTitle = $("modalTitle");
    const studentSelect = $("studentSelect");
    const btnAssign = $("btnAssign");
    const btnAbsent = $("btnAbsent");
    const btnClear  = $("btnClear");
    const btnCancel = $("btnCancel");

    let editingCell = null; // {time, day}

    function studentName(uid){
      return (students?.[uid]?.name || "").trim();
    }

    function normalizeTimes(scheduleObj){
      const slots = scheduleObj?.slots || {};
      const all = []
        .concat(slots.morning || [])
        .concat(slots.lunch || [])
        .concat(slots.evening || []);
      return all.filter(t => (t?.time || "").trim());
    }

    // âœ… ê¸°ì¡´ lesson/schedule êµ¬ì¡°ë¥¼ templateAssign í˜•íƒœë¡œ ë³€í™˜
    function buildTemplateAssignFromSchedule(scheduleObj){
      const items = normalizeTimes(scheduleObj);
      const out = {}; // { "07:00~08:00": {mon:"uid",...} }
      for(const t of items){
        const time = (t.time || "").trim();
        if(!time) continue;
        if(!out[time]) out[time] = { mon:"", tue:"", wed:"", thu:"", fri:"" };

        const a = t.assign || {};
        out[time].mon = a.mon || "";
        out[time].tue = a.tue || "";
        out[time].wed = a.wed || "";
        out[time].thu = a.thu || "";
        out[time].fri = a.fri || "";
      }
      return out;
    }

    function getBaseVal(time, day){
      return (templateAssign?.[time]?.[day] ?? "");
    }

    function getOverrideVal(time, day){
      return (overridesWeek?.[time] && Object.prototype.hasOwnProperty.call(overridesWeek[time], day))
        ? overridesWeek[time][day]
        : undefined;
    }

    function getFinalVal(time, day){
      const o = getOverrideVal(time, day);
      if(o !== undefined) return o; // "__absent__" í¬í•¨
      return getBaseVal(time, day);
    }

    function isModified(time, day){
      const o = getOverrideVal(time, day);
      if(o === undefined) return false;
      const base = getBaseVal(time, day);
      return o !== base;
    }

    function buildViewDays(times){
      // âœ… ê¸ˆìš”ì¼ ì—´ ì „ì²´ê°€ ì „ë¶€ "-"ì´ë©´ ê¸ˆìš”ì¼ ì—´ ìˆ¨ê¹€
      const hasFriAny = times.some(time=>{
        const v = getFinalVal(time, "fri");
        // ë¶ˆì°¸("__absent__")ë„ ê°’ì´ ìˆëŠ” ê²ƒìœ¼ë¡œ ì²˜ë¦¬(ê¸ˆìš”ì¼ ì—´ ìœ ì§€)
        return v !== "" && v !== null && v !== undefined;
      });
      return hasFriAny ? DAYS_ALL.slice() : ["mon","tue","wed","thu"];
    }

    function setHeader(viewDays){
      headRow.innerHTML = `
        <th>ì‹œê°„</th>
        ${viewDays.map(d => `<th>${dayLabel[d]}</th>`).join("")}
      `;
    }

    function renderMessage(msg, colCount, cls="mut"){
      tbody.innerHTML = `<tr><td colspan="${colCount}" class="${cls}">${msg}</td></tr>`;
    }

    function render(){
      if(!authed){
        setHeader(DAYS_ALL);
        renderMessage("ë¡œê·¸ì¸ ì¤‘...", 1 + DAYS_ALL.length, "empty");
        status.textContent = "Firebase ìµëª… ë¡œê·¸ì¸ ì¤‘";
        return;
      }

      const times = Object.keys(templateAssign || {}).sort((a,b)=>a.localeCompare(b));
      const viewDays = buildViewDays(times);
      const colCount = 1 + viewDays.length;

      setHeader(viewDays);

      if(times.length === 0){
        renderMessage("ê¸°ë³¸ ë ˆìŠ¨í‘œ(lesson/schedule)ë¥¼ ëª» ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.", colCount, "mut");
        status.textContent = `week ${weekKey} Â· schedule/template ì—†ìŒ`;
        return;
      }

      wrap.classList.toggle("admin", adminMode);

      tbody.innerHTML = times.map(time=>{
        const tds = viewDays.map(day=>{
          const finalVal = getFinalVal(time, day);
          const modified = isModified(time, day);

          let inner = "";
          let cls = "cell";
          let modIcon = modified ? `<span class="modIcon">ğŸ”µ</span>` : "";

          if(finalVal === "__absent__"){
            cls += " absent";
            inner = `ë¶ˆì°¸${modIcon}`;
          }else{
            const nm = studentName(finalVal);
            if(nm){
              cls += modified ? " modifiedText" : "";
              inner = `${esc(nm)}${modIcon}`;
            }else{
              inner = `<span class="empty">-</span>${modIcon}`;
            }
          }

          const pickCls = (swapPick && swapPick.time===time && swapPick.day===day) ? " swapPick" : "";
          return `<td class="${cls}${pickCls}" data-time="${esc(time)}" data-day="${day}">${inner}</td>`;
        }).join("");

        return `
          <tr>
            <td><b>${esc(time)}</b></td>
            ${tds}
          </tr>
        `;
      }).join("");

      if(adminMode) bindCellClicks();

      const studentCnt = Object.keys(students||{}).length;
      status.textContent = `week ${weekKey} Â· ì‹œê°„ ${times.length}ê°œ Â· ìˆ˜ê°•ì ${studentCnt}ëª…${viewDays.includes("fri") ? "" : " Â· ê¸ˆìš”ì¼ ì—†ìŒ(ì—´ ìˆ¨ê¹€)"}`;

      btnSwap.disabled = !adminMode;
      btnReset.disabled = !adminMode;
      btnAdmin.classList.toggle("on", adminMode);
      btnSwap.classList.toggle("on", swapMode);
      hint.textContent = !adminMode ? "ë³´ê¸° ëª¨ë“œ" : (swapMode ? "êµì²´(SWAP) ëª¨ë“œ: ì…€ 2ê°œë¥¼ ìˆœì„œëŒ€ë¡œ ëˆ„ë¥´ì„¸ìš”" : "í¸ì§‘ ëª¨ë“œ: ì…€ì„ ëˆŒëŸ¬ ë°°ì •/ë¶ˆì°¸/ë¹„ìš°ê¸°");
    }

    function bindCellClicks(){
      document.querySelectorAll("td.cell").forEach(td=>{
        td.onclick = async ()=>{
          const time = td.dataset.time;
          const day = td.dataset.day;

          if(swapMode){
            await handleSwapClick(time, day);
            return;
          }
          openEditModal(time, day);
        };
      });
    }

    async function handleSwapClick(time, day){
      if(!swapPick){
        swapPick = { time, day };
        render();
        return;
      }

      if(swapPick.time === time && swapPick.day === day){
        swapPick = null;
        render();
        return;
      }

      const a = { ...swapPick };
      const b = { time, day };

      const va = getFinalVal(a.time, a.day);
      const vb = getFinalVal(b.time, b.day);

      const updates = {};
      updates[`${PATH.overridesRoot}/${weekKey}/${a.time}/${a.day}`] = vb;
      updates[`${PATH.overridesRoot}/${weekKey}/${b.time}/${b.day}`] = va;

      try{
        await update(ref(db), updates);
      }catch(e){
        console.error(e);
        alert("êµì²´ ì €ì¥ ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)");
      }finally{
        swapPick = null;
        render();
      }
    }

    function openEditModal(time, day){
      editingCell = { time, day };
      modalTitle.textContent = `í¸ì§‘: ${time} Â· ${dayLabel[day]}`;

      const list = Object.entries(students || {})
        .map(([uid, obj]) => ({ uid, name: (obj?.name || "").trim() }))
        .filter(x => x.name)
        .sort((a,b)=>a.name.localeCompare(b.name, "ko"));

      const currentFinal = getFinalVal(time, day);

      studentSelect.innerHTML = `
        <option value="">(ì„ íƒ ì•ˆ í•¨)</option>
        ${list.map(x=>`<option value="${esc(x.uid)}">${esc(x.name)}</option>`).join("")}
      `;

      if(currentFinal && currentFinal !== "__absent__"){
        studentSelect.value = currentFinal;
      }else{
        studentSelect.value = "";
      }

      modalBack.classList.add("show");
      modalBack.setAttribute("aria-hidden", "false");
    }

    function closeModal(){
      modalBack.classList.remove("show");
      modalBack.setAttribute("aria-hidden", "true");
      editingCell = null;
    }

    async function setOverride(time, day, value){
      const p = `${PATH.overridesRoot}/${weekKey}/${time}/${day}`;
      const updates = {};
      updates[p] = value;
      await update(ref(db), updates);
    }

    async function clearOverride(time, day){
      const p = `${PATH.overridesRoot}/${weekKey}/${time}/${day}`;
      await remove(ref(db, p));
    }

    async function resetWeek(){
      if(!confirm("ì´ë²ˆì£¼ ìˆ˜ì •ë‚´ìš©ì„ ì „ë¶€ ì´ˆê¸°í™”í•˜ê³ (ì‚­ì œ) ì›ë˜ ë ˆìŠ¨í‘œë¡œ ëŒì•„ê°ˆê¹Œìš”?")) return;
      try{
        await remove(ref(db, `${PATH.overridesRoot}/${weekKey}`));
      }catch(e){
        console.error(e);
        alert("ì´ˆê¸°í™” ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)");
      }
    }

    // ====== ë²„íŠ¼/ëª¨ë‹¬ ì´ë²¤íŠ¸ ======
    btnAdmin.onclick = ()=>{
      adminMode = !adminMode;
      if(!adminMode){
        swapMode = false;
        swapPick = null;
      }
      render();
    };

    btnSwap.onclick = ()=>{
      if(!adminMode) return;
      swapMode = !swapMode;
      swapPick = null;
      render();
    };

    btnReset.onclick = async ()=>{
      if(!adminMode) return;
      await resetWeek();
    };

    btnCancel.onclick = ()=> closeModal();

    modalBack.addEventListener("click", (e)=>{
      if(e.target === modalBack) closeModal();
    });

    btnAssign.onclick = async ()=>{
      if(!editingCell) return;
      const { time, day } = editingCell;
      const uid = (studentSelect.value || "").trim();

      try{
        if(!uid){
          // ì„ íƒ ì•ˆ í•¨ = ì´ë²ˆì£¼ override ì‚­ì œ(ê¸°ë³¸ ë ˆìŠ¨ìœ¼ë¡œ)
          await clearOverride(time, day);
        }else{
          await setOverride(time, day, uid);
        }
        closeModal();
      }catch(e){
        console.error(e);
        alert("ì €ì¥ ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)");
      }
    };

    btnAbsent.onclick = async ()=>{
      if(!editingCell) return;
      const { time, day } = editingCell;
      try{
        await setOverride(time, day, "__absent__");
        closeModal();
      }catch(e){
        console.error(e);
        alert("ë¶ˆì°¸ ì €ì¥ ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)");
      }
    };

    btnClear.onclick = async ()=>{
      if(!editingCell) return;
      const { time, day } = editingCell;
      try{
        await clearOverride(time, day);
        closeModal();
      }catch(e){
        console.error(e);
        alert("ë¹„ìš°ê¸° ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)");
      }
    };

    // ====== Firebase ë°”ì¸ë”© ======
    (async function init(){
      try{
        status.textContent = "Firebase ì—°ê²° ì¤‘...";
        await signInAnonymously(auth);
        authed = true;

        // ìˆ˜ê°•ì ëª©ë¡
        onValue(ref(db, PATH.students), (snap)=>{
          students = snap.exists() ? (snap.val() || {}) : {};
          render();
        });

        // âœ… ê¸°ë³¸ ë ˆìŠ¨í‘œ: ê¸°ì¡´ lesson/schedule ì½ì–´ì„œ ë³€í™˜
        onValue(ref(db, PATH.schedule), (snap)=>{
          scheduleObj = snap.exists() ? (snap.val() || null) : null;
          templateAssign = scheduleObj ? buildTemplateAssignFromSchedule(scheduleObj) : {};
          render();
        }, (err)=>{
          console.error(err);
          templateAssign = {};
          render();
        });

        // ì´ë²ˆì£¼ ìˆ˜ì •ë¶„
        onValue(ref(db, `${PATH.overridesRoot}/${weekKey}`), (snap)=>{
          overridesWeek = snap.exists() ? (snap.val() || {}) : {};
          render();
        });

        render();
      }catch(e){
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="6" class="err">ì—°ê²° ì˜¤ë¥˜: ${esc(e?.message||e)}</td></tr>`;
        status.textContent = "Firebase ì—°ê²° ì˜¤ë¥˜(ì½˜ì†” í™•ì¸)";
      }
    })();
  </script>
</body>
</html>