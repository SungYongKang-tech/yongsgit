<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë ˆìŠ¨ ì£¼ê°„ ì‹œê°„í‘œ</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --bd:#e6e8ef;
      --txt:#0f172a; --mut:#64748b; --r:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--txt)}
    .wrap{max-width:980px;margin:0 auto;padding:12px}
    h2{margin:6px 0 10px;font-size:16px;font-weight:900}

    .tableWrap{
      background:var(--card);
      border:1px solid var(--bd);
      border-radius:var(--r);
      overflow:auto; /* ëª¨ë°”ì¼ ê°€ë¡œìŠ¤í¬ë¡¤ */
    }
    table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  table-layout:auto;   /* ìë™ ë„ˆë¹„ */
}
    th,td{
      padding:12px 6px;
      border-bottom:1px solid var(--bd);
      border-right:1px solid var(--bd);
      text-align:center;
      font-size:13px;
      vertical-align:top;
      white-space:nowrap;
    }
    th{
      position:sticky; top:0;
      background:#f2f4f8;
      font-weight:900;
      z-index:2;
    }
    th:first-child{
      left:0; z-index:3;
      position:sticky;
      background:#eef2ff;
    }
    td:first-child{
      position:sticky; left:0; z-index:1;
      background:#ffffff;
      font-weight:900;
      color:#0f172a;
    }
    tr:last-child td{border-bottom:none}
    td:last-child, th:last-child{border-right:none}

    .cell{
      font-weight:850;
      line-height:1.35;
      white-space:normal;
    }
    .empty{color:rgba(100,116,139,.7); font-weight:700}
    .mut{color:var(--mut);font-weight:700;font-size:12px;margin-top:8px}
    .err{color:#b91c1c;font-weight:800}


  </style>
</head>

<body>
  <div class="wrap">
    <h2>ğŸ¾ ë ˆìŠ¨ ì£¼ê°„ ì‹œê°„í‘œ</h2>

    <div class="tableWrap">
      <table aria-label="ë ˆìŠ¨ ì£¼ê°„ ì‹œê°„í‘œ">
        <thead>
          <tr>
            <th>ì‹œê°„</th>
<th>ì›”</th>
<th>í™”</th>
<th>ìˆ˜</th>
<th>ëª©</th>
<th>ê¸ˆ</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="empty">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="mut" id="status"></div>
  </div>

  <script type="module">
    import { db, auth } from "../firebase.js";
    import { ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const PATH = {
      coaches: "lesson/coaches",
      schedule: "lesson/schedule",
    };

    const DAYS = ["mon","tue","wed","thu","fri"];
    const dayLabel = { mon:"ì›”", tue:"í™”", wed:"ìˆ˜", thu:"ëª©", fri:"ê¸ˆ" };

    const $ = (id)=>document.getElementById(id);

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    let coaches = {};
    let schedule = null;
    let authed = false;

    function coachName(id){
      if(!id) return "";
      return (coaches?.[id]?.name || "").trim();
    }

    function normalizeTimes(scheduleObj){
      const slots = scheduleObj?.slots || {};
      const all = []
        .concat(slots.morning || [])
        .concat(slots.lunch || [])
        .concat(slots.evening || []);
      return all.filter(t => (t?.time || "").trim());
    }

    function render(){
      const tbody = $("tbody");
      const status = $("status");
      if(!tbody) return;

      if(!authed){
        tbody.innerHTML = `<tr><td colspan="6" class="empty">ë¡œê·¸ì¸ ì¤‘...</td></tr>`;
        if(status) status.textContent = "Firebase ìµëª… ë¡œê·¸ì¸ ì¤‘";
        return;
      }

      if(!schedule){
        tbody.innerHTML = `<tr><td colspan="6" class="mut">ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        if(status) status.textContent = "lesson/schedule ë°ì´í„° ì—†ìŒ";
        return;
      }

      const items = normalizeTimes(schedule);
      if(items.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" class="mut">ë“±ë¡ëœ íƒ€ì„ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        if(status) status.textContent = "íƒ€ì„ì„ ì¶”ê°€í•˜ê³  ì €ì¥í•´ ì£¼ì„¸ìš”.";
        return;
      }

      // âœ… ê°™ì€ time ì€ í•œ í–‰ìœ¼ë¡œ í•©ì¹˜ê¸°
      const rows = {}; // { "07:00~08:00": {mon:"id",...} }
      for(const t of items){
        const time = (t.time || "").trim();
        if(!time) continue;

        if(!rows[time]) rows[time] = { mon:"", tue:"", wed:"", thu:"", fri:"" };

        DAYS.forEach(d=>{
          const cid = t.assign?.[d] || "";
          if(cid) rows[time][d] = cid; // ë’¤ ê°’ìœ¼ë¡œ ë®ì–´ì“°ê¸°
        });
      }

      const times = Object.keys(rows).sort((a,b)=>a.localeCompare(b));

      tbody.innerHTML = times.map(time=>{
        const tds = DAYS.map(d=>{
          const cid = rows[time][d] || "";
          const nm = coachName(cid);
          return `<td class="cell">${nm ? esc(nm) : `<span class="empty">-</span>`}</td>`;
        }).join("");

        return `
          <tr>
            <td><b>${esc(time)}</b></td>
            ${tds}
          </tr>
        `;
      }).join("");

      if(status){
        const coachCnt = Object.keys(coaches||{}).length;
        status.textContent = `ì‹œê°„ ${times.length}ê°œ Â· ë ˆìŠ¨ì ${coachCnt}ëª…`;
      }
    }

    // ---- Auth + bind
    (async function init(){
      try{
        $("status").textContent = "Firebase ì—°ê²° ì¤‘...";
        await signInAnonymously(auth);
        authed = true;

        onValue(ref(db, PATH.coaches), (snap)=>{
          coaches = snap.exists() ? (snap.val() || {}) : {};
          render();
        }, (err)=>{
          console.error(err);
          $("status").textContent = "coaches ì½ê¸° ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)";
        });

        onValue(ref(db, PATH.schedule), (snap)=>{
          schedule = snap.exists() ? (snap.val() || null) : null;
          render();
        }, (err)=>{
          console.error(err);
          $("tbody").innerHTML = `<tr><td colspan="6" class="err">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${esc(err?.message||err)}</td></tr>`;
          $("status").textContent = "schedule ì½ê¸° ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)";
        });

        render();
      }catch(e){
        console.error(e);
        $("tbody").innerHTML = `<tr><td colspan="6" class="err">ì—°ê²° ì˜¤ë¥˜: ${esc(e?.message||e)}</td></tr>`;
        $("status").textContent = "Firebase ì—°ê²° ì˜¤ë¥˜(ì½˜ì†” í™•ì¸)";
      }
    })();
  </script>
</body>
</html>