<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë ˆìŠ¨ ì£¼ê°„ ì‹œê°„í‘œ</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --bd:#e6e8ef;
      --txt:#0f172a; --mut:#64748b; --r:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--txt)}
    .wrap{max-width:980px;margin:0 auto;padding:12px}
    h2{margin:6px 0 10px;font-size:16px;font-weight:900}

    .tableWrap{
      background:var(--card);
      border:1px solid var(--bd);
      border-radius:var(--r);
      overflow:auto; /* ëª¨ë°”ì¼ ê°€ë¡œìŠ¤í¬ë¡¤ */
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:740px; /* ëª¨ë°”ì¼ ê°€ë¡œìŠ¤í¬ë¡¤ ëŒ€ë¹„ */
    }
    th,td{
      padding:12px 10px;
      border-bottom:1px solid var(--bd);
      border-right:1px solid var(--bd);
      text-align:left;
      font-size:14px;
      vertical-align:top;
      white-space:nowrap;
    }
    th{
      position:sticky; top:0;
      background:#f2f4f8;
      font-weight:900;
      z-index:2;
    }
    th:first-child{
      left:0; z-index:3;
      position:sticky;
      background:#eef2ff;
    }
    td:first-child{
      position:sticky; left:0; z-index:1;
      background:#ffffff;
      font-weight:900;
      color:#0f172a;
    }
    tr:last-child td{border-bottom:none}
    td:last-child, th:last-child{border-right:none}

    .cell{
      font-weight:850;
      line-height:1.35;
      white-space:normal;
    }
    .empty{color:rgba(100,116,139,.7); font-weight:700}
    .mut{color:var(--mut);font-weight:700;font-size:12px;margin-top:8px}
    .err{color:#b91c1c;font-weight:800}
  </style>
</head>

<body>
  <div class="wrap">
    <h2>ğŸ¾ ë ˆìŠ¨ ì£¼ê°„ ì‹œê°„í‘œ</h2>

    <div class="tableWrap">
      <table aria-label="ë ˆìŠ¨ ì£¼ê°„ ì‹œê°„í‘œ">
        <thead>
          <tr>
            <th style="width:110px;">ì‹œê°„</th>
            <th style="width:160px;">ì›”</th>
            <th style="width:160px;">í™”</th>
            <th style="width:160px;">ìˆ˜</th>
            <th style="width:160px;">ëª©</th>
            <th style="width:160px;">ê¸ˆ</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="empty">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="mut" id="status"></div>
  </div>

  <script type="module">
    // âœ… firebase.js ìœ„ì¹˜ì— ë§ê²Œ ê²½ë¡œ ìˆ˜ì •
    // í˜„ì¬ í´ë”ê°€ tennis/lesson/ ì´ê³  firebase.jsê°€ tennis/firebase.js ë¼ë©´ ../firebase.js ê°€ ë§ìŠµë‹ˆë‹¤.
    import { db, auth } from "../firebase.js";
    import { ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // âœ… ê´€ë¦¬ìëª¨ë“œê°€ ì €ì¥í•˜ëŠ” ê²½ë¡œì™€ ë™ì¼í•˜ê²Œ!
    const SCHEDULE_PATH = "lessonSchedule";

    // ì›”~ê¸ˆë§Œ
    const DAYS = ["ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ"];
    const dayOrder = Object.fromEntries(DAYS.map((d,i)=>[d,i]));

    const $ = (id)=>document.getElementById(id);

    const esc = (s)=>String(s??"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");

    // "19:00" -> 1140 ë¶„ (ì •ë ¬ìš©)
    function toMin(t){
      const m = /^(\d{1,2}):(\d{2})$/.exec(t||"");
      if(!m) return 99999;
      return Number(m[1])*60 + Number(m[2]);
    }

    function slotLabel(s){
      // start~endê°€ ìˆìœ¼ë©´ "19:00~20:00" í‘œì‹œ, ì—†ìœ¼ë©´ "19:00"
      if(s.start && s.end) return `${s.start}~${s.end}`;
      return s.start || "";
    }

    await signInAnonymously(auth);

    onValue(
      ref(db, SCHEDULE_PATH),
      (snap)=>{
        const tbody = $("tbody");
        const status = $("status");

        if(!snap.exists()){
          tbody.innerHTML = `<tr><td colspan="6" class="empty">ë“±ë¡ëœ ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
          status.textContent = "â€» ê´€ë¦¬ìëª¨ë“œì— ë“±ë¡ëœ ì‹œê°„í‘œë§Œ í‘œì‹œë©ë‹ˆë‹¤.";
          return;
        }

        const raw = snap.val();

        // âœ… pushë¡œ ì €ì¥í•œ ê²½ìš°: {id:{...}, id2:{...}}
        const list = Array.isArray(raw)
          ? raw.filter(Boolean).map((v,i)=>({id:String(i), ...(v||{})}))
          : Object.entries(raw).map(([id,v])=>({id, ...(v||{})}));

        // âœ… í•„ìš”í•œ í•„ë“œë§Œ: day, start, end(ì„ íƒ), name
        // ì›”~ê¸ˆë§Œ í•„í„°
        const filtered = list
          .filter(x => DAYS.includes(x.day))
          .filter(x => x.start && x.name); // startì™€ name ì—†ìœ¼ë©´ í‘œì— ëª» ë„£ìŒ

        // âœ… ì‹œê°„ ìŠ¬ë¡¯(í–‰) ë§Œë“¤ê¸°: start ê¸°ì¤€ìœ¼ë¡œ ê³ ìœ ê°’ ìƒì„±
        // ê°™ì€ startë¼ë„ endê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë‹ˆ label( start~end )ë¡œ í–‰ì„ ë§Œë“¦
        const slotsMap = new Map(); // key=label, value={label, startMin}
        for(const s of filtered){
          const label = slotLabel(s);
          if(!label) continue;
          if(!slotsMap.has(label)){
            slotsMap.set(label, { label, startMin: toMin(s.start) });
          }
        }
        const slots = Array.from(slotsMap.values()).sort((a,b)=>a.startMin-b.startMin);

        // âœ… ê·¸ë¦¬ë“œ ë°ì´í„°: grid[label][day] = [names...]
        const grid = {};
        for(const slot of slots) grid[slot.label] = Object.fromEntries(DAYS.map(d=>[d, []]));

        for(const s of filtered){
          const label = slotLabel(s);
          if(!grid[label]) continue;
          grid[label][s.day].push(String(s.name));
        }

        // âœ… ë Œë”
        tbody.innerHTML = slots.map(slot=>{
          const label = slot.label;
          const tds = DAYS.map(d=>{
            const names = grid[label][d] || [];
            if(names.length===0) return `<td class="empty">-</td>`;
            // ì—¬ëŸ¬ ëª…ì´ë©´ ì¤„ë°”ê¿ˆ
            return `<td class="cell">${names.map(esc).join("<br>")}</td>`;
          }).join("");

          return `
            <tr>
              <td>${esc(label)}</td>
              ${tds}
            </tr>
          `;
        }).join("") || `<tr><td colspan="6" class="empty">í‘œì‹œí•  ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;

        status.textContent = `ì´ ${filtered.length}ê±´ Â· ì‹œê°„ ìŠ¬ë¡¯ ${slots.length}ê°œ`;
      },
      (err)=>{
        console.error(err);
        $("tbody").innerHTML = `<tr><td colspan="6" class="err">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${esc(err?.message||err)}</td></tr>`;
        $("status").textContent = "ê²½ë¡œ/ê¶Œí•œ/íŒŒì¼ê²½ë¡œ(import) ë¬¸ì œì¼ ê°€ëŠ¥ì„±ì´ í½ë‹ˆë‹¤. ì½˜ì†”(F12)ì„ í™•ì¸í•˜ì„¸ìš”.";
      }
    );
  </script>
</body>
</html>