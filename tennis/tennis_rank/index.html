<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ¾ í…Œë‹ˆìŠ¤ ê²½ê¸°ê²°ê³¼ ì…ë ¥</title>

<style>
@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

:root{
  --ink:#0f172a; --muted:#64748b; --card:#fff; --bg:#f5f7fb;
  --accent:#2563eb; --ok:#16a34a; --danger:#ef4444;
  --shadow:0 8px 28px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
body{margin:0;font-family:Pretendard,"Noto Sans KR",sans-serif;font-weight:700;background:var(--bg);color:var(--ink)}
header{background:#fff;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:10}
.header-inner{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:12px 0}
h1{margin:2px 0 8px;font-size:clamp(20px,4vw,24px);color:var(--accent);font-weight:900}
.row{display:flex;flex-wrap:wrap;gap:6px;align-items:center;justify-content:center}
.btn{border:1px solid #cbd5e1;border-radius:10px;padding:7px 12px;font-size:14px;cursor:pointer;background:#fff;transition:.2s;font-weight:900}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.ok{background:var(--ok);color:#fff;border-color:var(--ok)}
.btn.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
.wrap{max-width:980px;margin:0 auto;padding:14px 16px}

.chip{
  border:1px solid #cbd5e1;border-radius:12px;
  padding:3px 5px;font-size:14px;background:#fff;color:#111;cursor:pointer;font-weight:900;
}
.chip.selected{border:2px solid var(--accent)!important;background:#ffe600!important}

#teamDisplay{margin-top:18px;margin-bottom:12px;text-align:center;font-size:18px;font-weight:900;line-height:1.6}
#matchButtons{display:none;text-align:center;margin:10px 0 18px}
#matchButtons .btn{margin:0 8px;padding:9px 16px;font-size:16px}

#logs{margin-top:18px;background:#fff;border-radius:14px;box-shadow:var(--shadow);padding:12px}
.log-item{border-bottom:1px solid #e5e7eb;padding:10px 4px;position:relative}
.log-item:last-child{border-bottom:none}
.log-time{font-size:14px;color:#334155;display:block;margin-bottom:4px;font-weight:900}
.log-match{font-size:16px;font-weight:900}
.log-win{color:#2563eb;font-weight:950}
.delete-btn{position:absolute;right:8px;top:6px;font-size:16px;border:none;background:transparent;color:#9ca3af;cursor:pointer}
.delete-btn:hover{color:#ef4444;transform:scale(1.06)}

.toast{
  position:fixed;bottom:18px;left:50%;transform:translateX(-50%);
  background:#111827;color:#fff;padding:9px 14px;border-radius:10px;
  opacity:0;transition:.25s;font-size:15px;font-weight:900;
}
.toast.show{opacity:1}

/* ë„ì›€ë§ ëª¨ë‹¬ */
.modal{display:none;position:fixed;z-index:100;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.4);justify-content:center;align-items:center}
.modal-content{
  background:#fff;border-radius:14px;padding:18px;
  max-width:360px;width:82%;
  box-shadow:0 8px 28px rgba(0,0,0,0.2);
  max-height:80vh;overflow:auto;
}
.modal-content h2{margin:0 0 10px;text-align:center;font-size:18px;color:#1e3a8a;font-weight:950}
.modal-content ul{list-style:none;padding:0;margin:0;font-size:15px;line-height:1.6;color:#111827;font-weight:750}
.modal-content li::before{content:"â€¢ ";color:#2563eb;font-weight:950}
</style>
</head>

<body>
<header>
  <div class="header-inner">
    <h1 id="pageTitle">ğŸ¾ í…Œë‹ˆìŠ¤ ê²½ê¸°ê²°ê³¼ ì…ë ¥</h1>
    <div class="row">
      <a href="monthly-report.html" class="btn primary">í†µí•© ì „ì </a>
      <button id="todayBtn" class="btn primary">ì˜¤ëŠ˜ì˜ ì „ì </button>
      <button id="helpBtn" class="btn">â„¹ ì‚¬ìš©ë²•</button>
      <button id="homeBtn" class="btn">ğŸ“± ë°”ë¡œê°€ê¸° ì¶”ê°€</button>
    </div>
  </div>

  <!-- ì˜¤ëŠ˜ì˜ ì „ì  íŒì—… -->
  <div id="todayResults"
    style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
           width:90%;max-width:420px;background:#fff;border-radius:16px;
           box-shadow:0 8px 28px rgba(0,0,0,0.2);padding:20px 20px 24px;z-index:200;">
    <button id="closeToday"
      style="position:absolute;top:10px;right:12px;background:transparent;border:none;
             font-size:22px;color:#9ca3af;cursor:pointer;">âœ–</button>
    <h3 style="text-align:center;color:#2563eb;margin:0 0 12px;font-weight:950;">ğŸ“Š ì˜¤ëŠ˜ì˜ ì „ì </h3>
    <div id="todayList" style="font-size:16px;line-height:1.8;font-weight:900;text-align:center;color:#111;"></div>
  </div>
</header>

<main class="wrap">
  <div id="chips" class="row" style="margin-top:10px;"></div>
  <div id="teamDisplay"></div>

  <div id="matchButtons">
    <button id="winA" class="btn ok">AíŒ€ ìŠ¹</button>
    <button id="winB" class="btn danger">BíŒ€ ìŠ¹</button>
  </div>

  <div id="logs"></div>
</main>

<div id="toast" class="toast">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</div>

<div id="helpModal" class="modal">
  <div class="modal-content">
    <h2>ğŸ“˜ ì‚¬ìš©ë²•</h2>
    <ul>
      <li>ì„ ìˆ˜ 2ëª…(ë‹¨ì‹) ë˜ëŠ” 4ëª…(ë³µì‹)ì„ ì„ íƒí•©ë‹ˆë‹¤.</li>
      <li>A/BíŒ€ ìë™ ë°°ì • í›„ ìŠ¹ë¦¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì €ì¥í•©ë‹ˆë‹¤.</li>
      <li>ìµœê·¼ ê²½ê¸°ê²°ê³¼ëŠ” ì•„ë˜ì—ì„œ í™•ì¸/ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
    <button id="closeModal" class="btn ok" style="margin-top:10px;width:100%;">ë‹«ê¸°</button>
  </div>
</div>

<script type="module">
  import { db, auth } from "../firebase.js";
  import { ref, onValue, get, push, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
  import { signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  const $ = (s)=>document.querySelector(s);
  const toast = (msg="ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤")=>{
    const t=$("#toast"); t.textContent=msg; t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"),1500);
  };

  // âœ… ìµëª… ë¡œê·¸ì¸ (members/matches ì½ê¸° ì•ˆì •í™”)
  await signInAnonymously(auth);

  // âœ… ê²½ë¡œ: ê´€ë¦¬ì ì½”ë“œì™€ ë™ì¼
  const PATH = {
    title: "config/title",
    deletePass: "config/deletePassword",
    members: "members",
    matches: "matches"
  };

  // âœ… ë“±ê¸‰ í‘œì‹œ/ì •ë ¬ìš© (Aê°€ ìƒìœ„)
  const GRADE_ORDER = { A:1, B:2, C:3, D:4 };
  const GRADE_COLOR = { A:"#ef4444", B:"#f59e0b", C:"#06b6d4", D:"#22c55e" };

  // ì œëª©
  const titleRef = ref(db, PATH.title);
  const cachedTitle = localStorage.getItem("siteTitle");
  if(cachedTitle){
    document.title = `ğŸ¾ ${cachedTitle} í…Œë‹ˆìŠ¤ ê²½ê¸°ê²°ê³¼ ì…ë ¥`;
    $("#pageTitle").textContent = `ğŸ¾ ${cachedTitle} í…Œë‹ˆìŠ¤ ê²½ê¸°ê²°ê³¼ ì…ë ¥`;
  }
  onValue(titleRef, snap=>{
    const val = snap.val() ?? "Tennis Club";
    localStorage.setItem("siteTitle", val);
    document.title = `ğŸ¾ ${val} í…Œë‹ˆìŠ¤ ê²½ê¸°ê²°ê³¼ ì…ë ¥`;
    $("#pageTitle").textContent = `ğŸ¾ ${val} í…Œë‹ˆìŠ¤ ê²½ê¸°ê²°ê³¼ ì…ë ¥`;
  });

  const memberRef = ref(db, PATH.members);
  const matchRef  = ref(db, PATH.matches);
  const deletePwRef = ref(db, PATH.deletePass);

  let members = [];            // [{name, grade, weight}]
  let memberSet = new Set();   // name set
  let sel = [];
  let deletePassword = null;   // âœ… ê´€ë¦¬ìì—ì„œ ì„¤ì •í•œ ì‚­ì œë¹„ë²ˆ (ì—†ìœ¼ë©´ null)

  // âœ… ì‚­ì œ ë¹„ë°€ë²ˆí˜¸: í•­ìƒ ìµœì‹ ê°’ ë°˜ì˜ (get 1íšŒ -> onValue)
  onValue(deletePwRef, (s)=>{
    deletePassword = s.exists() ? String(s.val()) : null;
  });

  // âœ… ì„ ìˆ˜(í…Œë‹ˆìŠ¤) ëª©ë¡: membersì—ì„œ ë¡œë“œ
  onValue(memberRef, snap=>{
    const data = snap.exists()? snap.val() : {};
    members = Object.values(data)
      .map(v=>({ name: v?.name, grade: (v?.grade||"D").toUpperCase(), weight: v?.weight ?? 0 }))
      .filter(v=>v.name)
      .sort((a,b)=>{
        const ga = GRADE_ORDER[a.grade] ?? 99;
        const gb = GRADE_ORDER[b.grade] ?? 99;
        return ga-gb || a.name.localeCompare(b.name,"ko");
      });

    memberSet = new Set(members.map(m=>m.name));

    // ì‚­ì œëœ ì„ ìˆ˜ ì„ íƒ ì œê±°
    sel = sel.filter(x=>memberSet.has(x.name));

    renderChips();
    updateTeams();
  }, err=>{
    console.error(err);
    toast("ì„ ìˆ˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨");
  });

  function renderChips(){
    const box = $("#chips");
    box.innerHTML = "";

    if(!members.length){
      box.innerHTML = `<div style="color:#64748b;font-weight:900;">ë“±ë¡ëœ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. (ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ members ë“±ë¡ í•„ìš”)</div>`;
      return;
    }

    members.forEach(m=>{
      const btn = document.createElement("button");
      btn.className = "chip";

      const c = GRADE_COLOR[m.grade] ?? "#94a3b8";
      btn.style.borderColor = c;
      btn.style.background = c + "22";
      btn.textContent = `${m.name}(${m.grade})`;

      if(sel.some(x=>x.name===m.name)){
        btn.classList.add("selected");
      }

      btn.onclick = ()=>{
        const idx = sel.findIndex(x=>x.name===m.name);
        if(idx>=0) sel.splice(idx,1);
        else{
          if(sel.length>=4) return toast("ìµœëŒ€ 4ëª…ê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤");
          sel.push(m);
        }
        renderChips();
        updateTeams();
      };

      box.appendChild(btn);
    });
  }

  function updateTeams(){
    const disp = $("#teamDisplay");
    const btns = $("#matchButtons");

    if(sel.length){
      const half = Math.floor(sel.length/2);
      const a = sel.slice(0,half).map(x=>x.name).join("/");
      const b = sel.slice(half).map(x=>x.name).join("/");
      disp.innerHTML = `<b>AíŒ€:</b> ${a||"-"}ã€€|ã€€<b>BíŒ€:</b> ${b||"-"}`;
    }else{
      disp.innerHTML = "";
    }

    btns.style.display = (sel.length===2 || sel.length===4) ? "block" : "none";
  }

  function getMonthKey(ts=Date.now()){
    const d = new Date(new Date(ts).toLocaleString("en-US",{timeZone:"Asia/Seoul"}));
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
  }

  $("#winA").onclick = ()=>saveMatch("A");
  $("#winB").onclick = ()=>saveMatch("B");

  function saveMatch(winnerSide){
    if(!(sel.length===2 || sel.length===4)) return toast("2ëª… ë˜ëŠ” 4ëª…ì„ ì„ íƒí•˜ì„¸ìš”");

    // âœ… ë“±ë¡ëœ ì„ ìˆ˜ë§Œ ì €ì¥
    const invalid = sel.map(x=>x.name).filter(n=>!memberSet.has(n));
    if(invalid.length) return toast(`ë“±ë¡ë˜ì§€ ì•Šì€ ì„ ìˆ˜: ${invalid.join(", ")}`);

    const mode = (sel.length===2) ? "single" : "double";
    const a = sel.slice(0,sel.length/2).map(x=>x.name);
    const b = sel.slice(sel.length/2).map(x=>x.name);

    push(matchRef,{
      mode,
      monthKey: getMonthKey(),
      namesA: a,
      namesB: b,
      winnerSide,
      createdAt: Date.now()
    });

    toast("ê²½ê¸°ê²°ê³¼ ì €ì¥ ì™„ë£Œ");
    sel = [];
    renderChips();
    updateTeams();
  }

  // âœ… ìµœê·¼ ë¡œê·¸
  onValue(matchRef, snap=>{
    const data = snap.val() || {};
    const arr = Object.entries(data)
      .map(([id,m])=>({ ...m, id }))
      .sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
    renderLogs(arr);
  });

  function renderLogs(arr){
    const logs = $("#logs");
    logs.innerHTML = "";

    if(!arr.length){
      logs.innerHTML = `<div style="text-align:center;color:#94a3b8;font-weight:900;">ìµœê·¼ ê²½ê¸° ì—†ìŒ</div>`;
      return;
    }

    arr.forEach(m=>{
      const d = new Date(m.createdAt);
      const kst = new Date(d.toLocaleString("en-US",{timeZone:"Asia/Seoul"}));
      const time =
        `${kst.getFullYear()}-${String(kst.getMonth()+1).padStart(2,"0")}-${String(kst.getDate()).padStart(2,"0")} `+
        `${String(kst.getHours()).padStart(2,"0")}:${String(kst.getMinutes()).padStart(2,"0")}`;

      const winA = m.winnerSide === "A";
      const a = (m.namesA||[]).join("/");
      const b = (m.namesB||[]).join("/");

      const aHtml = winA ? `<span class="log-win">${a} <span style="color:#ef4444;font-weight:950;">(ìŠ¹)</span></span>` : `<span>${a}</span>`;
      const bHtml = !winA ? `<span class="log-win">${b} <span style="color:#ef4444;font-weight:950;">(ìŠ¹)</span></span>` : `<span>${b}</span>`;

      logs.insertAdjacentHTML("beforeend",`
        <div class="log-item">
          <span class="log-time">${time} [${m.mode==="double"?"ë³µì‹":"ë‹¨ì‹"}]</span>
          <div class="log-match">${aHtml} vs ${bHtml}</div>
          <button class="delete-btn" onclick="deleteMatch('${m.id}')">ğŸ—‘ï¸</button>
        </div>
      `);
    });
  }

  // âœ… ì‚­ì œ ë¹„ë²ˆì€ ê´€ë¦¬ì í˜ì´ì§€(config/deletePassword) ê°’ìœ¼ë¡œë§Œ ì‚­ì œ
  window.deleteMatch = async (id)=>{
    if(!deletePassword){
      return toast("ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤(ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì„¤ì •).");
    }
    const input = prompt("ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    if(input === null) return;

    if(String(input).trim() !== String(deletePassword)){
      return toast("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤");
    }
    if(!confirm("ì •ë§ ì´ ê²½ê¸°ê²°ê³¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    await remove(ref(db, `${PATH.matches}/${id}`));
    toast("ê²½ê¸°ê²°ê³¼ ì‚­ì œ ì™„ë£Œ");
  };

  // ë„ì›€ë§
  const modal = document.getElementById("helpModal");
  document.getElementById("helpBtn").addEventListener("click", ()=> modal.style.display="flex");
  document.getElementById("closeModal").addEventListener("click", ()=> modal.style.display="none");
  window.addEventListener("click", (e)=>{ if(e.target===modal) modal.style.display="none"; });

  // âœ… ì˜¤ëŠ˜ì˜ ì „ì 
  let todayVisible=false;

  async function buildTodayHtml(){
    const snap = await get(matchRef);
    if(!snap.exists()) return null;

    const data = Object.values(snap.val());
    const today = new Date().toLocaleDateString("ko-KR",{timeZone:"Asia/Seoul"});

    const todayMatches = data.filter(m=>{
      const d = new Date(m.createdAt);
      const kst = new Date(d.toLocaleString("en-US",{timeZone:"Asia/Seoul"}));
      return kst.toLocaleDateString("ko-KR") === today;
    });

    if(!todayMatches.length) return "ì˜¤ëŠ˜ ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤";

    const stats = {};
    todayMatches.forEach(m=>{
      const winners = m.winnerSide==="A" ? (m.namesA||[]) : (m.namesB||[]);
      const losers  = m.winnerSide==="A" ? (m.namesB||[]) : (m.namesA||[]);
      winners.forEach(n=>{ if(!stats[n]) stats[n]={win:0,lose:0}; stats[n].win++; });
      losers.forEach(n=>{ if(!stats[n]) stats[n]={win:0,lose:0}; stats[n].lose++; });
    });

    const sorted = Object.entries(stats)
      .map(([name,{win,lose}])=>{
        const mem = members.find(x=>x.name===name);
        const grade = mem?.grade ?? "D";
        const score = win*2 - lose; // ìŠ¹ì 
        return { name, grade, win, lose, score };
      })
      .sort((a,b)=>{
        return b.score-a.score ||
               (GRADE_ORDER[a.grade]??99) - (GRADE_ORDER[b.grade]??99) ||
               a.name.localeCompare(b.name,"ko");
      });

    const maxWin = Math.max(...sorted.map(x=>x.win));
    let html="";
    sorted.forEach((p,i)=>{
      const isTop = p.win===maxWin;
      const color = p.win>p.lose ? "#1e40af" : "#111";
      const text = `${p.name}(${p.grade}) ${p.win}ìŠ¹${p.lose}íŒ¨`;
      html += `<span style="color:${color};display:inline-block;width:48%;text-align:center;margin:6px 0;">
                ${isTop?`<b>${text}</b>`:text}
              </span>`;
      if((i+1)%2===0) html += "<br>";
    });
    return html;
  }

  document.getElementById("todayBtn").addEventListener("click", async ()=>{
    const box=document.getElementById("todayResults");
    const list=document.getElementById("todayList");

    if(todayVisible){ box.style.display="none"; todayVisible=false; return; }

    const html = await buildTodayHtml();
    if(html===null) return toast("ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤");
    if(html==="ì˜¤ëŠ˜ ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤") return toast(html);

    list.innerHTML = html;
    box.style.display="block";
    todayVisible=true;
  });

  document.getElementById("closeToday").addEventListener("click", ()=>{
    document.getElementById("todayResults").style.display="none";
    todayVisible=false;
  });

  // âœ… ë°”ë¡œê°€ê¸° ì¶”ê°€
  function showHomeInstallGuide(){
    const url = location.href.split("#")[0];
    navigator.clipboard.writeText(url).then(()=>{
      alert("âœ… ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nëª¨ë°”ì¼ ë¸Œë¼ìš°ì €ì—ì„œ â€˜í™ˆ í™”ë©´ì— ì¶”ê°€â€™ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.\n\n" + url);
    }).catch(()=>{
      alert("â— ìë™ ë³µì‚¬ê°€ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nì•„ë˜ ì£¼ì†Œë¥¼ ì§ì ‘ ë³µì‚¬í•˜ì„¸ìš”:\n" + url);
    });
  }
  document.getElementById("homeBtn").addEventListener("click", showHomeInstallGuide);
</script>
</body>
</html>