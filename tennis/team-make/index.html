<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ¾ í…Œë‹ˆìŠ¤ ë³µì‹ ìë™ ë°°ì •</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --bd:#e6e8ef;
      --txt:#0f172a; --mut:#64748b; --r:16px;
      --accent:#2563eb; --danger:#ef4444;
      --shadow:0 10px 28px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--txt)}
    .wrap{max-width:980px;margin:0 auto;padding:12px}
    h2{margin:6px 0 12px;font-size:16px;font-weight:900;text-align:center}

    .card{
      background:var(--card);
      border:1px solid var(--bd);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:12px;
      margin-bottom:12px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}
    .input{
      padding:10px 12px;border:1px solid var(--bd);
      border-radius:12px;background:#fff;font-size:14px
    }
    .btn{
      padding:10px 14px;border:1px solid rgba(37,99,235,.25);
      background:linear-gradient(180deg,#2b74ff,#2563eb);
      color:#fff;border-radius:12px;cursor:pointer;font-weight:900;
    }
    .btn.secondary{background:#fff;color:#0f172a;border:1px solid var(--bd)}
    .btn.danger{background:linear-gradient(180deg,#ff5a5a,#ef4444);border:1px solid rgba(239,68,68,.25)}

    .mut{color:var(--mut);font-weight:700;font-size:12px;margin-top:8px;text-align:center}
    .err{color:#b91c1c;font-weight:900;text-align:center}
    .ok{color:#166534;font-weight:900;text-align:center}

    .player-list{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
    .player{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid var(--bd);border-radius:999px;
      background:#fff;cursor:pointer;font-weight:850;
      user-select:none;
    }
    .player small{color:var(--mut);font-weight:800}
    .player.selected{border:2px solid var(--accent);background:#e3f2ff}
    .player.new-player{
      background:#fff59d;border:2px solid #e2e8f0;font-weight:900;
      animation:flash 1.2s ease-in-out infinite alternate;
    }
    @keyframes flash{from{filter:brightness(1.02)}to{filter:brightness(.92)}}

    .courts{display:flex;flex-direction:column;gap:10px}
    .court{
      background:#fff;border:1px solid var(--bd);border-radius:14px;padding:12px;
    }
    .court h3{margin:0 0 8px;font-size:14px;font-weight:1000}
    .grid{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center}
    .teamBox{
      border:1px solid var(--bd);border-radius:12px;padding:10px;background:#f8fafc;
      font-weight:850;line-height:1.55;
    }
    .vs{font-weight:1000;color:#ef4444;text-align:center}
    .meta{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:8px;color:var(--mut);font-weight:800;font-size:12px}
    @media (max-width:600px){
      .grid{grid-template-columns:1fr}
      .vs{order:2}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h2>ğŸ¾ í…Œë‹ˆìŠ¤ ë³µì‹ ìë™ ë°°ì •</h2>

    <!-- í˜„ì¥ ì¶”ê°€(ë¡œì»¬) -->
    <div class="card">
      <div class="row">
        <input class="input" id="newName" placeholder="ì´ë¦„(í˜„ì¥ ì¶”ê°€)" />
        <select class="input" id="newGrade" style="min-width:90px">
          <option value="A">A</option>
          <option value="B" selected>B</option>
          <option value="C">C</option>
          <option value="D">D</option>
        </select>
        <button class="btn" id="addBtn">ì„ ìˆ˜ ì¶”ê°€</button>
        <button class="btn secondary" id="removeAddedBtn">ì¶”ê°€ ì„ ìˆ˜ ì‚­ì œ</button>
      </div>
      <div class="mut">â€» ê¸°ë³¸ ì„ ìˆ˜ëŠ” Firebase <b>members</b>ì—ì„œ ë¶ˆëŸ¬ì˜¤ê³ , â€œí˜„ì¥ ì¶”ê°€â€ëŠ” ì´ ê¸°ê¸°(localStorage)ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</div>
    </div>

    <!-- ì°¸ì„ì ëª©ë¡ -->
    <div class="card">
      <div style="font-size:14px;font-weight:1000;text-align:center;margin-bottom:10px">ì°¸ì„ì ëª©ë¡</div>
      <div class="player-list" id="playerList">
        <span class="mut">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
      </div>
      <div class="mut" id="status"></div>
    </div>

    <!-- ìë™ ë°°ì • -->
    <div class="card">
      <div class="row">
        <button class="btn" id="autoBtn">ë³µì‹ ìë™ ë°°ì •</button>
        <button class="btn danger" id="resetBtn">ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
      <div class="mut">ì„ íƒëœ ì‚¬ëŒë§Œ ë°°ì •í•©ë‹ˆë‹¤. ì„ íƒì´ ì—†ìœ¼ë©´ ì „ì²´ ì¸ì›ì—ì„œ ë°°ì •í•©ë‹ˆë‹¤. (ë³µì‹: ì½”íŠ¸ë‹¹ 4ëª…)</div>
    </div>

    <!-- ê²°ê³¼ -->
    <div class="card">
      <div style="font-size:14px;font-weight:1000;text-align:center;margin-bottom:10px">ë°°ì • ê²°ê³¼</div>
      <div class="courts" id="courts">
        <div class="mut">ì•„ì§ ë°°ì • ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db, auth } from "../firebase.js";
    import { ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const $ = (id)=>document.getElementById(id);

    // âœ… ê´€ë¦¬ì ì½”ë“œì™€ ë™ì¼
    const PATH = { members: "members" };
    const GRADE_WEIGHT = { A:4, B:3, C:2, D:1 };

    // ë¡œì»¬ ì €ì¥(í˜„ì¥ ì¶”ê°€)
    const LS_KEY = "tennis_addedPlayers";

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function setStatus(msg, cls="mut"){
      const el = $("status");
      if(!el) return;
      el.className = cls;
      el.textContent = msg;
    }

    function loadLocalAdded(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
      catch{ return []; }
    }
    function saveLocalAdded(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }

    let authed = false;
    let allPlayers = [];   // {name, grade, weight, new}
    let selectedIdx = [];  // index ì„ íƒ

    function weightOf(p){
      // DBì— weightê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ gradeë¡œ ì¶”ì •
      const w = Number(p?.weight);
      if(!isNaN(w) && w>0) return w;
      const g = String(p?.grade ?? "").trim().toUpperCase();
      return GRADE_WEIGHT[g] ?? 1;
    }

    function rebuildPlayers(memberCache){
      // memberCacheëŠ” ë³´í†µ { pushKey: {name, grade, weight}, ... }
      const baseArr = Object.values(memberCache || {})
        .filter(v => v && v.name)
        .map(v => ({
          name: String(v.name).trim(),
          grade: String(v.grade ?? "").trim().toUpperCase() || "D",
          weight: weightOf(v),
          new: false
        }));

      allPlayers = baseArr;

      // ë¡œì»¬ ì‹ ê·œ ì„ ìˆ˜ ë³‘í•©
      const added = loadLocalAdded();
      added.forEach(p=>{
        const name = String(p?.name ?? "").trim();
        if(!name) return;
        const grade = String(p?.grade ?? "D").trim().toUpperCase();
        allPlayers.push({
          name,
          grade,
          weight: GRADE_WEIGHT[grade] ?? 1,
          new: true
        });
      });

      selectedIdx = [];
      renderPlayers();
    }

    function renderPlayers(){
      const box = $("playerList");
      if(!box) return;
      box.innerHTML = "";

      if(allPlayers.length === 0){
        box.innerHTML = `<span class="mut">ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</span>`;
        return;
      }

      allPlayers.forEach((p,i)=>{
        const el = document.createElement("span");
        el.className = "player";
        if(p.new) el.classList.add("new-player");
        if(selectedIdx.includes(i)) el.classList.add("selected");
        el.innerHTML = `${esc(p.name)} <small>(${esc(p.grade)})</small>`;
        el.onclick = ()=>{
          if(selectedIdx.includes(i)) selectedIdx = selectedIdx.filter(v=>v!==i);
          else selectedIdx.push(i);
          renderPlayers();
        };
        box.appendChild(el);
      });

      setStatus(`ì„ ìˆ˜ ${allPlayers.length}ëª… Â· ì„ íƒ ${selectedIdx.length}ëª…`, "mut");
    }

    function shuffle(arr){
      const a = [...arr];
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    function runAutoAssign(){
      const pool = (selectedIdx.length ? selectedIdx.map(i=>allPlayers[i]) : allPlayers)
        .filter(p=>p?.name);

      if(pool.length < 4){
        alert("ë³µì‹ì€ ìµœì†Œ 4ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        return;
      }

      const maxCourts = Math.floor(pool.length / 4);
      const input = prompt(`ëª‡ ì½”íŠ¸ë¡œ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê°€ëŠ¥: 1 ~ ${maxCourts} (ì½”íŠ¸ë‹¹ 4ëª…)\nì˜ˆ) 2`);
      if(input === null) return;

      const courtCount = parseInt(input,10);
      if(isNaN(courtCount) || courtCount<1 || courtCount>maxCourts){
        alert(`ì½”íŠ¸ ìˆ˜ëŠ” 1 ~ ${maxCourts} ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
        return;
      }

      const need = courtCount * 4;

      // âœ… ë³µì‹ ë°¸ëŸ°ìŠ¤: (ê°•+ì•½) í˜ì–´ â†’ (ê°•íŒ€ vs ì•½íŒ€) ë§¤ì¹­
      // 1) ë½‘ì„ ì¸ì›: ìƒìœ„ weight ìš°ì„  + ë™ë¥ ì´ë©´ ëœë¤ì„±
      const picked = shuffle(pool)
        .sort((a,b)=> (b.weight - a.weight))
        .slice(0, need);

      // 2) strong+weak 2ì¸ íŒ€ ìƒì„±
      const sorted = [...picked].sort((a,b)=>b.weight-a.weight);
      const teams2 = [];
      let tmp = [...sorted];
      while(tmp.length >= 2){
        const top = tmp.shift();
        const bottom = tmp.pop();
        teams2.push({
          members:[top,bottom],
          sum: (top.weight||0) + (bottom.weight||0)
        });
      }

      // 3) ê°•íŒ€ vs ì•½íŒ€ìœ¼ë¡œ ì½”íŠ¸ êµ¬ì„±
      teams2.sort((a,b)=>b.sum-a.sum);
      const courts = [];
      while(teams2.length >= 2){
        const strong = teams2.shift();
        const weak = teams2.pop();
        courts.push({
          A: strong,
          B: weak,
          diff: Math.abs(strong.sum - weak.sum)
        });
      }

      renderCourts(courts, pool.length - need);
    }

    function renderCourts(courts, waitingCount){
      const wrap = $("courts");
      if(!wrap) return;
      wrap.innerHTML = "";

      if(!courts.length){
        wrap.innerHTML = `<div class="mut">ë°°ì • ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      courts.forEach((c, idx)=>{
        const div = document.createElement("div");
        div.className = "court";

        const teamA = c.A.members
          .map(m=>`${esc(m.name)}(${esc(m.grade)})`).join(" Â· ");
        const teamB = c.B.members
          .map(m=>`${esc(m.name)}(${esc(m.grade)})`).join(" Â· ");

        div.innerHTML = `
          <h3>ì½”íŠ¸ ${idx+1}</h3>
          <div class="grid">
            <div class="teamBox">
              <div style="font-weight:1000;margin-bottom:4px">íŒ€ A</div>
              ${teamA}
            </div>
            <div class="vs">VS</div>
            <div class="teamBox">
              <div style="font-weight:1000;margin-bottom:4px">íŒ€ B</div>
              ${teamB}
            </div>
          </div>
          <div class="meta">
            <span>Aí•©(ê°€ì¤‘ì¹˜) ${c.A.sum}</span>
            <span>Bí•©(ê°€ì¤‘ì¹˜) ${c.B.sum}</span>
            <span>ì°¨ì´ ${c.diff}</span>
          </div>
        `;
        wrap.appendChild(div);
      });

      if(waitingCount > 0){
        const note = document.createElement("div");
        note.className = "mut";
        note.textContent = `ëŒ€ê¸° ì¸ì›: ${waitingCount}ëª… (ì½”íŠ¸ë‹¹ 4ëª… ê¸°ì¤€ìœ¼ë¡œ ì¼ë¶€ë§Œ ë°°ì •í–ˆìŠµë‹ˆë‹¤)`;
        wrap.appendChild(note);
      }
    }

    // ----- í˜„ì¥ ì¶”ê°€(ë¡œì»¬)
    function addLocalPlayer(){
      const name = $("newName").value.trim();
      const grade = $("newGrade").value;

      if(!name){
        alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      const p = { name, grade }; // ë¡œì»¬ì€ gradeë§Œ ì €ì¥(ê³„ì‚°ì€ ë§¤í•‘)
      const stored = loadLocalAdded();
      stored.push(p);
      saveLocalAdded(stored);

      $("newName").value = "";
      $("newGrade").value = "B";

      allPlayers.push({ name, grade, weight: GRADE_WEIGHT[grade] ?? 1, new:true });
      renderPlayers();
    }

    function removeLocalPlayers(){
      if(!confirm("ì¶”ê°€í•œ ì„ ìˆ˜ë“¤ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      localStorage.removeItem(LS_KEY);
      allPlayers = allPlayers.filter(p=>!p.new);
      selectedIdx = [];
      renderPlayers();
    }

    function resetAll(){
      selectedIdx = [];
      $("courts").innerHTML = `<div class="mut">ì•„ì§ ë°°ì • ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      renderPlayers();
    }

    $("addBtn").addEventListener("click", addLocalPlayer);
    $("removeAddedBtn").addEventListener("click", removeLocalPlayers);
    $("autoBtn").addEventListener("click", runAutoAssign);
    $("resetBtn").addEventListener("click", resetAll);

    // ----- init (ë ˆìŠ¨ ì‹œê°„í‘œ ë°©ì‹: ìµëª… ë¡œê·¸ì¸ + onValue ë°”ì¸ë”©)
    (async function init(){
      try{
        setStatus("Firebase ì—°ê²° ì¤‘...");
        await signInAnonymously(auth);
        authed = true;
        setStatus("Firebase ì—°ê²°ë¨. ì„ ìˆ˜ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");

        onValue(ref(db, PATH.members), (snap)=>{
          const cache = snap.exists() ? (snap.val() || {}) : {};
          // ğŸ” ë””ë²„ê·¸ ë¡œê·¸(ë¬¸ì œ ìƒê¸°ë©´ ì½˜ì†”ë¡œ ë°”ë¡œ í™•ì¸ ê°€ëŠ¥)
          console.log("âœ… PATH.members =", PATH.members);
          console.log("âœ… members exists =", snap.exists());
          console.log("âœ… members raw =", cache);

          rebuildPlayers(cache);
          setStatus(`Firebase ì„ ìˆ˜ ${Object.keys(cache||{}).length}ëª… ë¶ˆëŸ¬ì˜´ Â· ì „ì²´ ${allPlayers.length}ëª…`, "mut");
        }, (err)=>{
          console.error(err);
          $("playerList").innerHTML = `<span class="err">ì„ ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${esc(err?.message||err)}</span>`;
          setStatus("members ì½ê¸° ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)", "err");
        });

      }catch(e){
        console.error(e);
        $("playerList").innerHTML = `<span class="err">ì—°ê²° ì˜¤ë¥˜: ${esc(e?.message||e)}</span>`;
        setStatus("Firebase ì—°ê²° ì˜¤ë¥˜(ì½˜ì†” í™•ì¸)", "err");
      }
    })();
  </script>
</body>
</html>