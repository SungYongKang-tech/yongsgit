<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ¾ í…Œë‹ˆìŠ¤ íŒ€ êµ¬ì„±</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --bd:#e6e8ef;
      --txt:#0f172a; --mut:#64748b; --r:16px;
      --accent:#2563eb; --danger:#ef4444; --ok:#16a34a;
      --shadow:0 10px 28px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--txt)}
    .wrap{max-width:1100px;margin:0 auto;padding:12px}
    h2{margin:6px 0 12px;font-size:16px;font-weight:950;text-align:center}

    .card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--shadow);padding:12px;margin-bottom:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}
    .input, select{
      padding:10px 12px;border:1px solid var(--bd);border-radius:12px;background:#fff;font-size:14px
    }
    .btn{
      padding:10px 14px;border:1px solid rgba(37,99,235,.25);
      background:linear-gradient(180deg,#2b74ff,#2563eb);
      color:#fff;border-radius:12px;cursor:pointer;font-weight:950;
    }
    .btn.secondary{background:#fff;color:#0f172a;border:1px solid var(--bd)}
    .btn.danger{background:linear-gradient(180deg,#ff5a5a,#ef4444);border:1px solid rgba(239,68,68,.25)}
    .btn.ok{background:linear-gradient(180deg,#22c55e,#16a34a);border:1px solid rgba(22,163,74,.25)}

    .mut{color:var(--mut);font-weight:750;font-size:12px;margin-top:8px;text-align:center}
    .err{color:#b91c1c;font-weight:950;text-align:center}
    .oktxt{color:#166534;font-weight:950;text-align:center}

    .player-list{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
    .player{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid var(--bd);border-radius:999px;
      background:#fff;cursor:pointer;font-weight:900;user-select:none;
    }
    .player small{color:var(--mut);font-weight:850}
    .player.selected{border:2px solid var(--accent);background:#e3f2ff}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){ .grid2{grid-template-columns:1fr} }

    .box{
      border:1px solid var(--bd);border-radius:14px;background:#fff;padding:12px;
    }
    .box h3{margin:0 0 10px;font-size:14px;font-weight:1000}

    .teams{display:flex;flex-direction:column;gap:10px}
    .team{
      border:1px solid var(--bd);border-radius:14px;padding:10px;background:#f8fafc;
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;
    }
    .team .names{font-weight:950;line-height:1.5}
    .team .meta{color:var(--mut);font-weight:800;font-size:12px}

    .groups{display:flex;flex-direction:column;gap:10px}
    .group{
      border:1px solid var(--bd);border-radius:14px;padding:10px;background:#fff;
    }
    .group h4{margin:0 0 8px;font-size:13px;font-weight:1000}
    .chip{display:inline-flex;align-items:center;padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:#f8fafc;margin:4px 6px 0 0;font-weight:900}
  </style>
</head>

<body>
  <div class="wrap">
    <h2>ğŸ¾ í…Œë‹ˆìŠ¤ íŒ€ êµ¬ì„± (ë³µì‹ 2ì¸ 1íŒ€)</h2>

    <!-- ì°¸ê°€ì ì„ íƒ -->
    <div class="card">
      <div style="font-size:14px;font-weight:1000;text-align:center;margin-bottom:10px">ì°¸ì„ì ì„ íƒ</div>
      <div class="player-list" id="playerList"><span class="mut">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span></div>
      <div class="mut" id="status"></div>
    </div>

    <!-- íŒ€/ì¡° ì„¤ì • -->
    <div class="card">
      <div class="row">
        <button class="btn" id="makeTeamsBtn">âœ… íŒ€ ìë™ êµ¬ì„±(2ì¸ 1íŒ€)</button>
        <button class="btn secondary" id="clearBtn">ì„ íƒ/ê²°ê³¼ ì´ˆê¸°í™”</button>
      </div>

      <div class="row" style="margin-top:10px">
        <label style="font-weight:900">
          ì§„í–‰ ë°©ì‹
          <select id="mode" class="input">
            <option value="league">ë¦¬ê·¸ì „(íŒ€ ì „ì²´ í’€ë¦¬ê·¸)</option>
            <option value="groups">ì¡°ë³„ ë¦¬ê·¸ì „(ì¡° í¸ì„±)</option>
          </select>
        </label>

        <label style="font-weight:900">
          ì¡° ê°œìˆ˜(ì¡°ë³„ì¼ ë•Œ)
          <select id="groupCount" class="input">
            <option value="2">2ì¡°</option>
            <option value="3">3ì¡°</option>
            <option value="4">4ì¡°</option>
            <option value="5">5ì¡°</option>
            <option value="6">6ì¡°</option>
          </select>
        </label>

        <button class="btn ok" id="makeGroupsBtn">ì¡° í¸ì„±</button>
      </div>

      <div class="mut">
        â€¢ íŒ€ êµ¬ì„±ì€ ì„ íƒ ì¸ì› ê¸°ì¤€(ì„ íƒ ì—†ìœ¼ë©´ ì „ì²´).<br/>
        â€¢ ì¸ì›ì´ í™€ìˆ˜ë©´ ë§ˆì§€ë§‰ 1ëª…ì€ ëŒ€ê¸° ì²˜ë¦¬í•©ë‹ˆë‹¤.
      </div>
    </div>

    <!-- ê²°ê³¼ -->
    <div class="grid2">
      <div class="box">
        <h3>íŒ€ êµ¬ì„± ê²°ê³¼</h3>
        <div class="teams" id="teams"><div class="mut">ì•„ì§ íŒ€ì´ ì—†ìŠµë‹ˆë‹¤.</div></div>
      </div>

      <div class="box">
        <h3>ì¡° í¸ì„± ê²°ê³¼(ì¡°ë³„ ë¦¬ê·¸ì „)</h3>
        <div class="groups" id="groups"><div class="mut">ì¡°ë³„ ë¦¬ê·¸ì „ì„ ì„ íƒí•˜ê³  â€œì¡° í¸ì„±â€ì„ ëˆ„ë¥´ì„¸ìš”.</div></div>
      </div>
    </div>

    <!-- ì €ì¥ + ì´ë™ -->
    <div class="card" style="margin-top:12px">
      <div class="row">
        <button class="btn ok" id="saveAndGoBtn">ğŸ’¾ ì €ì¥ í›„ ê²½ê¸° ì§„í–‰(team-live)ë¡œ ì´ë™</button>
      </div>
      <div class="mut">ê²½ê¸° ì§„í–‰ ë¡œì§ì€ <b>team-live/index.html</b>ì—ì„œ í•˜ë„ë¡ ì—°ê²°í•©ë‹ˆë‹¤.</div>
    </div>
  </div>

  <script type="module">
    import { db, auth } from "../firebase.js";
    import { ref, onValue, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const $ = (id)=>document.getElementById(id);

    const PATH = {
      members: "members",
      current: "teamLive/current"   // âœ… team-liveê°€ ì½ì„ â€œí˜„ì¬ ê²½ê¸°â€ ë°ì´í„°
    };

    const GRADE_WEIGHT = { A:4, B:3, C:2, D:1 };

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function weightOf(p){
      const w = Number(p?.weight);
      if(!isNaN(w) && w>0) return w;
      const g = String(p?.grade ?? "").trim().toUpperCase();
      return GRADE_WEIGHT[g] ?? 1;
    }

    let authed = false;
    let allPlayers = [];   // {name, grade, weight}
    let selectedIdx = [];

    // ê²°ê³¼ ë°ì´í„°(ì €ì¥ìš©)
    let teams = [];   // [{id, players:[{name,grade,weight}]}]  2ì¸ 1íŒ€
    let groups = {};  // { A:[teamId,...], B:[...], ... }
    let waiting = []; // ë‚¨ëŠ” 1ëª…

    function setStatus(msg, cls="mut"){
      const el = $("status");
      if(!el) return;
      el.className = cls;
      el.textContent = msg;
    }

    function renderPlayers(){
      const box = $("playerList");
      box.innerHTML = "";

      if(allPlayers.length === 0){
        box.innerHTML = `<span class="mut">ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</span>`;
        return;
      }

      allPlayers.forEach((p,i)=>{
        const el = document.createElement("span");
        el.className = "player";
        if(selectedIdx.includes(i)) el.classList.add("selected");
        el.innerHTML = `${esc(p.name)} <small>(${esc(p.grade)})</small>`;
        el.onclick = ()=>{
          if(selectedIdx.includes(i)) selectedIdx = selectedIdx.filter(v=>v!==i);
          else selectedIdx.push(i);
          renderPlayers();
          setStatus(`ì„ ìˆ˜ ${allPlayers.length}ëª… Â· ì„ íƒ ${selectedIdx.length}ëª…`, "mut");
        };
        box.appendChild(el);
      });

      setStatus(`ì„ ìˆ˜ ${allPlayers.length}ëª… Â· ì„ íƒ ${selectedIdx.length}ëª…`, "mut");
    }

    function shuffle(arr){
      const a = [...arr];
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    // âœ… 2ì¸ 1íŒ€ ìë™ êµ¬ì„± (ê°•+ì•½ í˜ì–´ë§)
    function makeTeams(){
      const pool = (selectedIdx.length ? selectedIdx.map(i=>allPlayers[i]) : allPlayers).filter(Boolean);
      if(pool.length < 2){
        alert("ìµœì†Œ 2ëª… ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤.");
        return;
      }

      teams = [];
      groups = {};
      waiting = [];

      // ëœë¤ì„± + ì‹¤ë ¥ ë°˜ì˜
      const picked = shuffle(pool).sort((a,b)=>b.weight-a.weight);

      // í™€ìˆ˜ë©´ 1ëª… ëŒ€ê¸°
      if(picked.length % 2 === 1){
        waiting = [ picked.pop() ];
      }

      // strong + weak í˜ì–´
      const tmp = [...picked];
      const made = [];
      while(tmp.length >= 2){
        const strong = tmp.shift();
        const weak = tmp.pop();
        made.push([strong, weak]);
      }

      teams = made.map((pair, idx)=>({
        id: `T${idx+1}`,
        players: pair,
        sum: pair.reduce((s,p)=>s+p.weight,0)
      }));

      renderTeams();
      renderGroups(); // ì¡° ê²°ê³¼ ì´ˆê¸°í™” í‘œì‹œ
    }

    function renderTeams(){
      const box = $("teams");
      if(!teams.length){
        box.innerHTML = `<div class="mut">ì•„ì§ íŒ€ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      box.innerHTML = teams.map(t=>{
        const names = t.players.map(p=>`${esc(p.name)}(${esc(p.grade)})`).join(" Â· ");
        return `
          <div class="team">
            <div class="names">${esc(t.id)}: ${names}</div>
            <div class="meta">ê°€ì¤‘ì¹˜í•© ${t.sum}</div>
          </div>
        `;
      }).join("");

      if(waiting.length){
        const w = waiting[0];
        box.innerHTML += `
          <div class="team" style="background:#fff">
            <div class="names">ëŒ€ê¸°: ${esc(w.name)}(${esc(w.grade)})</div>
            <div class="meta">ì¸ì› í™€ìˆ˜ë¡œ 1ëª… ëŒ€ê¸°</div>
          </div>
        `;
      }
    }

    function makeGroups(){
  const mode = $("mode").value;
  if(mode !== "groups"){
    alert("ì§„í–‰ ë°©ì‹ì„ â€˜ì¡°ë³„ ë¦¬ê·¸ì „â€™ìœ¼ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }
  if(!teams.length){
    alert("ë¨¼ì € íŒ€ì„ êµ¬ì„±í•´ì£¼ì„¸ìš”.");
    return;
  }

  const gCount = parseInt($("groupCount").value, 10);
  if(isNaN(gCount) || gCount < 2) return;

  const labels = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".slice(0, gCount).split("");
  const n = teams.length;

  groups = {};
  labels.forEach(l => groups[l] = []);

  const shuffled = shuffle([...teams]); // íŒ€ ëœë¤

  // âœ… ì¼€ì´ìŠ¤ 1) íŒ€ì´ ì¡°ë³´ë‹¤ ì ìœ¼ë©´: 0íŒ€ ì¡°ëŠ” ì–´ì©” ìˆ˜ ì—†ìŒ (ê·¸ëŒ€ë¡œ ìˆœì„œëŒ€ë¡œ ë„£ê¸°)
  if(n < gCount){
    for(let i=0;i<n;i++){
      groups[labels[i]].push(shuffled[i].id);
    }
    renderGroups();
    return;
  }

  // âœ… ì¼€ì´ìŠ¤ 2) íŒ€ì´ ì¡° ì´ìƒì´ë©´: íŒ€ ìˆ˜ë¥¼ ìµœëŒ€í•œ ê· ë“±(ì°¨ì´ 1)ìœ¼ë¡œ ë¶„ë°°
  // -> ì´ ê²½ìš°ì—” "1íŒ€ ì¡° + 3íŒ€ ì¡°" ê°™ì€ ê·¹ë‹¨ ë¶ˆê· í˜•ì´ ì•ˆ ìƒê¹€
  const base = Math.floor(n / gCount);
  const rem  = n % gCount; // remê°œ ì¡°ëŠ” base+1

  const cap = labels.map((_,i)=> base + (i < rem ? 1 : 0)); // ì •ì›

  let gi = 0;
  for(const t of shuffled){
    while(gi < gCount && groups[labels[gi]].length >= cap[gi]) gi++;
    if(gi >= gCount) break;
    groups[labels[gi]].push(t.id);
  }

  renderGroups();
}

    function groupSum(teamIds){
      const map = new Map(teams.map(t=>[t.id,t]));
      return teamIds.reduce((s,id)=>s+(map.get(id)?.sum||0),0);
    }

    function renderGroups(){
      const box = $("groups");
      const mode = $("mode").value;

      if(mode !== "groups"){
        box.innerHTML = `<div class="mut">ì§„í–‰ ë°©ì‹ì´ â€˜ë¦¬ê·¸ì „â€™ì´ë©´ ì¡° í¸ì„±ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>`;
        return;
      }
      if(!teams.length){
        box.innerHTML = `<div class="mut">ë¨¼ì € íŒ€ì„ êµ¬ì„±í•´ì£¼ì„¸ìš”.</div>`;
        return;
      }
      if(!Object.keys(groups).length){
        box.innerHTML = `<div class="mut">â€œì¡° í¸ì„±â€ì„ ëˆ„ë¥´ë©´ ì¡°ê°€ ìƒì„±ë©ë‹ˆë‹¤.</div>`;
        return;
      }

      const teamText = (teamId)=>{
        const t = teams.find(x=>x.id===teamId);
        if(!t) return teamId;
        const n = t.players.map(p=>`${p.name}(${p.grade})`).join("Â·");
        return `${t.id}:${n}`;
      };

      box.innerHTML = Object.entries(groups).map(([g, ids])=>{
        const sum = groupSum(ids);
        return `
          <div class="group">
            <h4>${g}ì¡° <span style="color:var(--mut);font-weight:800">(íŒ€ ${ids.length} Â· í•© ${sum})</span></h4>
            <div>
              ${ids.map(id=>`<span class="chip">${esc(teamText(id))}</span>`).join("")}
            </div>
          </div>
        `;
      }).join("");
    }

    // âœ… ì €ì¥ + ì´ë™ (team-liveê°€ ì´ ê°’ì„ ì½ê²Œ ë¨)
    async function saveAndGo(){
      if(!teams.length){
        alert("ë¨¼ì € íŒ€ì„ êµ¬ì„±í•´ì£¼ì„¸ìš”.");
        return;
      }

      const mode = $("mode").value; // league | groups
      const payload = {
        updatedAt: Date.now(),
        serverUpdatedAt: serverTimestamp(),
        mode,
        teams: teams.map(t=>({
          id: t.id,
          sum: t.sum,
          players: t.players.map(p=>({ name:p.name, grade:p.grade, weight:p.weight }))
        })),
        waiting: waiting.map(p=>({ name:p.name, grade:p.grade, weight:p.weight })),
        groups: (mode==="groups") ? groups : {},
      };

      await set(ref(db, PATH.current), payload);

      // âœ… team-liveë¡œ ì´ë™
      // ê°™ì€ í´ë” êµ¬ì¡°ë¼ë©´ ì•„ë˜ ê²½ë¡œë§Œ ë§ì¶”ë©´ ë©ë‹ˆë‹¤.
      window.location.href = "../team-live/";
    }

    function clearAll(){
      selectedIdx = [];
      teams = [];
      groups = {};
      waiting = [];
      renderPlayers();
      renderTeams();
      renderGroups();
    }

    $("makeTeamsBtn").addEventListener("click", makeTeams);
    $("makeGroupsBtn").addEventListener("click", makeGroups);
    $("saveAndGoBtn").addEventListener("click", saveAndGo);
    $("clearBtn").addEventListener("click", clearAll);

    // --- init (ë ˆìŠ¨ ì‹œê°„í‘œ ë°©ì‹)
    (async function init(){
      try{
        setStatus("Firebase ì—°ê²° ì¤‘...");
        await signInAnonymously(auth);
        authed = true;

        onValue(ref(db, PATH.members), (snap)=>{
          const raw = snap.exists() ? (snap.val() || {}) : {};
          console.log("âœ… members raw =", raw);

          allPlayers = Object.values(raw)
            .filter(v=>v && v.name)
            .map(v=>({
              name: String(v.name).trim(),
              grade: String(v.grade ?? "D").trim().toUpperCase(),
              weight: weightOf(v)
            }));

          renderPlayers();
          setStatus(`Firebase ë©¤ë²„ ${Object.keys(raw).length}ëª… ë¶ˆëŸ¬ì˜´`, "mut");
        }, (err)=>{
          console.error(err);
          $("playerList").innerHTML = `<span class="err">ì„ ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${esc(err?.message||err)}</span>`;
          setStatus("members ì½ê¸° ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)", "err");
        });

      }catch(e){
        console.error(e);
        $("playerList").innerHTML = `<span class="err">ì—°ê²° ì˜¤ë¥˜: ${esc(e?.message||e)}</span>`;
        setStatus("Firebase ì—°ê²° ì˜¤ë¥˜(ì½˜ì†” í™•ì¸)", "err");
      }
    })();
  </script>
</body>
</html>