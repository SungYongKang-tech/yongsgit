<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í…Œë‹ˆìŠ¤ ë³µì‹ ìë™ íŒ€ ë°°ì •ê¸°</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; padding: 20px; background:#f0f2f5; }
    h2 { text-align:center; color:#1a237e; margin: 8px 0 16px; }
    .section { margin-bottom: 18px; }
    .section h3 { text-align:center; color:#333; margin: 10px 0; }
    .player-list { display:flex; flex-wrap:wrap; justify-content:center; gap:6px; }
    .player { margin: 2px; padding: 6px 10px; font-size: 15px; border-radius: 10px; border: 1px solid #cbd5e1; cursor: pointer; background: #fff; }
    .player.selected { background:#bbdefb; border: 2px solid #1e88e5; }

    /* ìƒˆë¡œ ì¶”ê°€ëœ ì„ ìˆ˜ ê°•ì¡° */
    .player.new-player {
      background: #fff59d !important;
      border: 2px solid #d1d5db;
      font-weight: 800;
      animation: highlightFlash 1.2s ease-in-out infinite alternate;
      color: #111827;
    }
    .player.new-player.selected {
      background: #fbc02d !important;
      border-color: #1e88e5;
      color: #111827 !important;
    }
    @keyframes highlightFlash { from { filter: brightness(1.02); } to { filter: brightness(0.92); } }

    button {
      padding: 10px 14px; font-size: 15px;
      background:#1976d2; color:#fff; border:none; border-radius: 10px; cursor:pointer;
    }
    button.secondary { background:#64748b; }
    button.danger { background:#e53935; }
    button.green { background:#43a047; }

    .input-wrap { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom: 12px; }
    .player-input-pair { display:flex; gap:8px; align-items:center; }
    .player-input-pair input { padding: 8px 10px; font-size: 14px; border-radius: 10px; border:1px solid #cbd5e1; }
    #newName { width: 120px; }
    #newLevel { width: 70px; }

    .action-buttons { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin: 14px 0; }

    .courts { display:flex; flex-direction:column; gap:12px; max-width: 860px; margin: 0 auto; }
    .court-card {
      background:#fff; border:1px solid #e5e7eb; border-radius: 14px;
      padding: 12px 14px; box-shadow: 0 8px 24px rgba(0,0,0,.06);
    }
    .court-title { font-weight: 900; color:#0f172a; margin-bottom: 8px; }
    .teams-row { display:grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items:center; }
    .team-box { border:1px solid #e5e7eb; border-radius:12px; padding:10px; background:#f8fafc; }
    .vs { font-weight: 900; color:#ef4444; text-align:center; }
    .meta { margin-top: 8px; color:#475569; font-size: 13px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }

    @media (max-width: 600px){
      .teams-row { grid-template-columns: 1fr; }
      .vs { order: 2; }
    }
  </style>
</head>
<body>

  <h2>ğŸ¾ í…Œë‹ˆìŠ¤ ë³µì‹ ìë™ íŒ€ ë°°ì •ê¸°</h2>

  <!-- âœ… ì„ ìˆ˜ ì¶”ê°€ (íƒêµ¬ì™€ ë™ì¼ ìœ ì§€) -->
  <div class="input-wrap">
    <div class="player-input-pair">
      <input type="text" id="newName" placeholder="ì´ë¦„" />
      <input type="number" id="newLevel" placeholder="ë ˆë²¨" min="1" max="20" />
    </div>
    <div class="button-group">
      <button onclick="addPlayer()">ì„ ìˆ˜ ì¶”ê°€</button>
      <button class="secondary" onclick="removeAddedPlayers()">ì¶”ê°€ ì„ ìˆ˜ ì‚­ì œ</button>
    </div>
  </div>

  <div class="section">
    <h3>ì°¸ì„ì ëª©ë¡</h3>
    <div class="player-list" id="playerList"></div>
  </div>

  <div class="action-buttons">
    <button onclick="openAutoAssignModal()">ë³µì‹ ìë™ ë°°ì •</button>
    <button class="danger" onclick="resetAll()">ì „ì²´ ì´ˆê¸°í™”</button>
  </div>

  <div class="section">
    <h3>ë°°ì • ê²°ê³¼ (ì½”íŠ¸ë³„ ë³µì‹)</h3>
    <div class="courts" id="courts"></div>
  </div>

<script>
  // =========================
  // ë°ì´í„°/ìƒíƒœ
  // =========================
  let allPlayers = [];     // ì „ì²´ ì„ ìˆ˜(ê´€ë¦¬ì ë“±ë¡ + ë¡œì»¬ ì¶”ê°€)
  let selected = [];       // ì°¸ì„ì ì„ íƒ(ì¸ë±ìŠ¤)
  let latestCourts = [];   // ê²°ê³¼ ì €ì¥

  // =========================
  // ì„ ìˆ˜ ë¡œë”© (ê´€ë¦¬ì ì…ë ¥ ì„ ìˆ˜ ì „ì²´ ë¡œë”©)
  // - íƒêµ¬ì™€ ë™ì¼í•˜ê²Œ members.jsonì—ì„œ ë¶ˆëŸ¬ì˜´
  // =========================
  async function loadPlayers() {
    try {
      const res = await fetch("https://sensational-tulumba-65e97e.netlify.app/pingpong/club/data/members.json");
      const json = await res.json();
      const basePlayers = Object.values(json);

      allPlayers = basePlayers.map(p => ({
        name: p.name,
        level: Number(p.level) || 1,
        new: false
      }));

      // ë¡œì»¬ ì €ì¥ëœ ì‹ ê·œ ì„ ìˆ˜ ë³‘í•©
      const saved = JSON.parse(localStorage.getItem("tennis_addedPlayers") || "[]");
      saved.forEach(p => allPlayers.push({ ...p, new: true }));

      renderPlayers();
    } catch (err) {
      console.error("âŒ ì„ ìˆ˜ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:", err);
      alert("ì„ ìˆ˜ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨: members.json ê²½ë¡œ/í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
    }
  }

  loadPlayers();

  // =========================
  // UI ë Œë”
  // =========================
  function renderPlayers() {
    const playerList = document.getElementById("playerList");
    playerList.innerHTML = "";

    allPlayers.forEach((p, i) => {
      const el = document.createElement("span");
      el.className = "player";
      el.innerHTML = `
        ${p.name}(${p.level})
        ${p.new ? `<button onclick="removeSingleAddedPlayer(${i})"
          style="margin-left:6px;font-size:12px;padding:2px 6px;background:#f44336;color:#fff;border:none;border-radius:8px;cursor:pointer;">âœ–</button>` : ""}
      `;

      el.onclick = (e) => {
        if (e.target.tagName === "BUTTON") return;
        toggleSelect(i, el);
      };

      if (p.new) el.classList.add("new-player");
      if (selected.includes(i)) el.classList.add("selected");

      playerList.appendChild(el);
    });
  }

  function toggleSelect(i, el) {
    if (selected.includes(i)) {
      selected = selected.filter(v => v !== i);
      el.classList.remove("selected");
    } else {
      selected.push(i);
      el.classList.add("selected");
    }
  }

  // =========================
  // ì„ ìˆ˜ ì¶”ê°€/ì‚­ì œ (íƒêµ¬ì™€ ë™ì¼ ìœ ì§€, í‚¤ë§Œ tennis_ë¡œ ë¶„ë¦¬)
  // =========================
  function addPlayer() {
    const nameInput = document.getElementById("newName");
    const levelInput = document.getElementById("newLevel");

    const name = nameInput.value.trim();
    const level = parseInt(levelInput.value, 10);

    if (!name || isNaN(level) || level < 1 || level > 20) {
      alert("ì´ë¦„ê³¼ ë ˆë²¨ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ë ˆë²¨ 1~20)");
      return;
    }

    const newPlayer = { name, level, new: true };
    allPlayers.push(newPlayer);

    const stored = JSON.parse(localStorage.getItem("tennis_addedPlayers") || "[]");
    stored.push(newPlayer);
    localStorage.setItem("tennis_addedPlayers", JSON.stringify(stored));

    nameInput.value = "";
    levelInput.value = "";
    renderPlayers();
  }

  function removeSingleAddedPlayer(index) {
    const player = allPlayers[index];
    if (!player.new) return;

    if (!confirm(`${player.name} ì„ ìˆ˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    allPlayers.splice(index, 1);

    const stored = JSON.parse(localStorage.getItem("tennis_addedPlayers") || "[]");
    const updated = stored.filter(p => !(p.name === player.name && p.level === player.level));
    localStorage.setItem("tennis_addedPlayers", JSON.stringify(updated));

    // ì„ íƒ ì¸ë±ìŠ¤ ì¬ì •ë ¬(ê°„ë‹¨ ì²˜ë¦¬: ì„ íƒ ì´ˆê¸°í™”)
    selected = [];
    renderPlayers();
  }

  function removeAddedPlayers() {
    if (!confirm("ì¶”ê°€í•œ ì„ ìˆ˜ë“¤ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    allPlayers = allPlayers.filter(p => !p.new);
    localStorage.removeItem("tennis_addedPlayers");
    selected = [];
    renderPlayers();
  }

  function resetAll() {
    selected = [];
    latestCourts = [];
    document.getElementById("courts").innerHTML = "";
    renderPlayers();
  }

  // =========================
  // ìœ í‹¸
  // =========================
  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  // =========================
  // í…Œë‹ˆìŠ¤ ë³µì‹ ìë™ ë°°ì •
  // - ì½”íŠ¸ ìˆ˜ë¥¼ ì…ë ¥ë°›ê³ 
  // - ê° ì½”íŠ¸ëŠ” (2ì¸ 1íŒ€) vs (2ì¸ 1íŒ€)
  // - ê¸°ë³¸ ëª©í‘œ: "ì½”íŠ¸ë³„ 4ëª…" ê¸°ì¤€ìœ¼ë¡œ ë ˆë²¨ ê· í˜•
  // =========================
  function openAutoAssignModal() {
    const poolIdx = selected.length ? [...selected] : allPlayers.map((_, i) => i);

    if (poolIdx.length < 4) {
      alert("ë³µì‹ì€ ìµœì†Œ 4ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤. (ì°¸ì„ì ì„ íƒì´ ì—†ìœ¼ë©´ ì „ì²´ ëª…ë‹¨ì„ ì‚¬ìš©í•©ë‹ˆë‹¤)");
      return;
    }

    const maxCourts = Math.floor(poolIdx.length / 4);
    const input = prompt(`ëª‡ ì½”íŠ¸ë¡œ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê°€ëŠ¥: 1 ~ ${maxCourts} (ì½”íŠ¸ë‹¹ 4ëª…)\nì˜ˆ) 2`);
    if (input === null) return;

    const courts = parseInt(input, 10);
    if (isNaN(courts) || courts < 1 || courts > maxCourts) {
      alert(`ì½”íŠ¸ ìˆ˜ëŠ” 1 ~ ${maxCourts} ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
      return;
    }

    runDoublesAssignment(courts, poolIdx);
  }

  function runDoublesAssignment(courtCount, poolIdx) {
    // ì‚¬ìš©í•  ì„ ìˆ˜ë§Œ ì¶”ë¦¼
    const pool = poolIdx.map(i => allPlayers[i]);

    // ì½”íŠ¸ ìˆ˜ * 4ëª…ë§Œ ì‚¬ìš© (ë‚¨ëŠ” ì¸ì›ì€ ëŒ€ê¸°)
    const needed = courtCount * 4;

    // ë ˆë²¨ ë†’ì€ ìˆœìœ¼ë¡œ ì„ë˜, ê³¼ë„í•œ í¸í–¥ ì¤„ì´ê¸° ìœ„í•´ "ì •ë ¬ í›„ ë¸”ë¡ ì…”í”Œ"
    const sorted = [...pool].sort((a, b) => b.level - a.level);
    const picked = sorted.slice(0, needed);

    // íŒ€ì„ ë§Œë“¤ê¸° ìœ„í•œ ì „ëµ:
    // 1) ë ˆë²¨ ë‚´ë¦¼ì°¨ìˆœ
    // 2) strongestì™€ weakestë¥¼ ë¬¶ì–´ì„œ 2ì¸ íŒ€ ë§Œë“¤ê¸°(ë°¸ëŸ°ìŠ¤)
    // 3) ê·¸ë ‡ê²Œ ë§Œë“¤ì–´ì§„ 2ì¸íŒ€ 2ê°œë¥¼ í•œ ì½”íŠ¸ë¡œ ë§¤ì¹­
    const strong = [...picked];
    const teams2 = [];

    while (strong.length >= 2) {
      const top = strong.shift();
      const bottom = strong.pop();
      teams2.push({
        members: [top, bottom].filter(Boolean),
        sum: (top?.level || 0) + (bottom?.level || 0)
      });
    }

    // 2ì¸íŒ€ë“¤ì„ ì„ì–´ì„œ ì½”íŠ¸ì— ë°°ì •í•˜ë˜, sum ê· í˜•ì´ ë˜ë„ë¡ í˜ì–´ë§
    teams2.sort((a, b) => b.sum - a.sum);
    const courts = [];
    while (teams2.length >= 2) {
      const t1 = teams2.shift();      // ê°•í•œ íŒ€
      const t2 = teams2.pop();        // ì•½í•œ íŒ€
      courts.push({
        teamA: t1,
        teamB: t2,
        diff: Math.abs(t1.sum - t2.sum)
      });
    }

    // ê²°ê³¼ ì €ì¥/ë Œë”
    latestCourts = courts;
    renderCourts(courts);

    // ë‚¨ëŠ” ì¸ì› ì•ˆë‚´
    const waiting = pool.length - needed;
    if (waiting > 0) {
      alert(`ë°°ì • ì™„ë£Œ!\nëŒ€ê¸° ì¸ì›: ${waiting}ëª… (ì½”íŠ¸ë‹¹ 4ëª… ê¸°ì¤€ìœ¼ë¡œ ì¼ë¶€ë§Œ ë°°ì •í–ˆìŠµë‹ˆë‹¤)`);
    }
  }

  function renderCourts(courts) {
    const wrap = document.getElementById("courts");
    wrap.innerHTML = "";

    if (!courts.length) {
      wrap.innerHTML = "<div style='text-align:center;color:#64748b;'>ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
      return;
    }

    courts.forEach((c, i) => {
      const card = document.createElement("div");
      card.className = "court-card";
      const teamAText = c.teamA.members.map(m => `${m.name}(${m.level})`).join(" Â· ");
      const teamBText = c.teamB.members.map(m => `${m.name}(${m.level})`).join(" Â· ");
      card.innerHTML = `
        <div class="court-title">ì½”íŠ¸ ${i + 1}</div>
        <div class="teams-row">
          <div class="team-box">
            <div style="font-weight:900;margin-bottom:4px;">íŒ€ A</div>
            <div>${teamAText}</div>
          </div>
          <div class="vs">VS</div>
          <div class="team-box">
            <div style="font-weight:900;margin-bottom:4px;">íŒ€ B</div>
            <div>${teamBText}</div>
          </div>
        </div>
        <div class="meta">
          <div>íŒ€A í•©: <b>${c.teamA.sum}</b></div>
          <div>íŒ€B í•©: <b>${c.teamB.sum}</b></div>
          <div>ì°¨ì´: <b>${c.diff}</b></div>
        </div>
      `;
      wrap.appendChild(card);
    });
  }
</script>

</body>
</html>