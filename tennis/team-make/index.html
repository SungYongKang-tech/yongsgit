<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¾ í…Œë‹ˆìŠ¤ ë³µì‹ ìë™ ë°°ì •ê¸°</title>

<style>
body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:#f1f5f9;margin:0;padding:20px}
h2{text-align:center;margin:10px 0 20px;color:#0f172a}

.section{margin-bottom:20px}
.section h3{text-align:center;margin-bottom:10px;color:#334155}

.player-list{display:flex;flex-wrap:wrap;justify-content:center;gap:6px}
.player{
  padding:6px 10px;
  border:1px solid #cbd5e1;
  border-radius:10px;
  background:#fff;
  cursor:pointer;
  font-size:14px
}
.player.selected{background:#bbdefb;border:2px solid #1e88e5}
.player.new-player{background:#fff59d;font-weight:bold}

.input-wrap{
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:15px
}
input{padding:6px 8px;border-radius:8px;border:1px solid #cbd5e1}

button{
  padding:8px 14px;
  border:none;
  border-radius:8px;
  background:#1976d2;
  color:#fff;
  cursor:pointer
}
button.secondary{background:#64748b}
button.danger{background:#e53935}

.action-buttons{
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
  margin:15px 0
}

.courts{
  max-width:800px;
  margin:0 auto;
  display:flex;
  flex-direction:column;
  gap:12px
}

.court-card{
  background:#fff;
  border-radius:12px;
  padding:14px;
  box-shadow:0 6px 18px rgba(0,0,0,.08)
}

.court-title{font-weight:900;margin-bottom:8px}
.team-box{
  background:#f8fafc;
  padding:8px;
  border-radius:8px;
  border:1px solid #e2e8f0
}
.vs{text-align:center;font-weight:900;color:#ef4444;margin:6px 0}

.meta{
  margin-top:6px;
  font-size:13px;
  color:#475569;
  display:flex;
  justify-content:space-between
}
</style>
</head>
<body>

<h2>ğŸ¾ í…Œë‹ˆìŠ¤ ë³µì‹ ìë™ ë°°ì •ê¸°</h2>

<div class="input-wrap">
  <input type="text" id="newName" placeholder="ì´ë¦„">
  <input type="number" id="newLevel" placeholder="ë ˆë²¨" min="1" max="20">
  <button onclick="addPlayer()">ì„ ìˆ˜ ì¶”ê°€</button>
  <button class="secondary" onclick="removeAddedPlayers()">ì¶”ê°€ ì„ ìˆ˜ ì‚­ì œ</button>
</div>

<div class="section">
  <h3>ì°¸ì„ì ëª©ë¡</h3>
  <div class="player-list" id="playerList"></div>
</div>

<div class="action-buttons">
  <button onclick="openAutoAssign()">ë³µì‹ ìë™ ë°°ì •</button>
  <button class="danger" onclick="resetAll()">ì „ì²´ ì´ˆê¸°í™”</button>
</div>

<div class="section">
  <h3>ë°°ì • ê²°ê³¼</h3>
  <div class="courts" id="courts"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>

// ğŸ”¹ Firebase ì„¤ì • (ê¸°ì¡´ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
const firebaseConfig = {
  apiKey: "AIzaSyA-tp3iJ8-n0yrrd8lwE1IgOdsmDqyh69k",
  authDomain: "koen-teamleague.firebaseapp.com",
  databaseURL: "https://koen-teamleague-default-rtdb.firebaseio.com",
  projectId: "koen-teamleague"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

firebase.auth().signInAnonymously();

// =====================
// ìƒíƒœ
// =====================
let allPlayers = [];
let selected = [];

// =====================
// Firebaseì—ì„œ í…Œë‹ˆìŠ¤ ë©¤ë²„ ë¡œë”©
// =====================
function loadPlayersFromFirebase(){
  const membersRef = db.ref("tennis/members"); // âš ï¸ ê²½ë¡œ í™•ì¸

  membersRef.on("value", snap=>{
    const data = snap.val() || {};
    const arr = Array.isArray(data) ? data : Object.values(data);

    allPlayers = arr.map(p=>({
      name:p.name,
      level:Number(p.level)||1,
      new:false
    }));

    // ë¡œì»¬ ì¶”ê°€ ë³‘í•©
    const saved = JSON.parse(localStorage.getItem("tennis_addedPlayers")||"[]");
    saved.forEach(p=>allPlayers.push({...p,new:true}));

    selected=[];
    renderPlayers();
  });
}

loadPlayersFromFirebase();

// =====================
// UI ë Œë”
// =====================
function renderPlayers(){
  const list=document.getElementById("playerList");
  list.innerHTML="";
  allPlayers.forEach((p,i)=>{
    const el=document.createElement("div");
    el.className="player";
    if(selected.includes(i)) el.classList.add("selected");
    if(p.new) el.classList.add("new-player");
    el.textContent=`${p.name} (${p.level})`;
    el.onclick=()=>toggleSelect(i);
    list.appendChild(el);
  });
}

function toggleSelect(i){
  if(selected.includes(i)){
    selected=selected.filter(v=>v!==i);
  }else{
    selected.push(i);
  }
  renderPlayers();
}

// =====================
// ë³µì‹ ìë™ ë°°ì •
// =====================
function openAutoAssign(){
  const poolIdx = selected.length?selected:allPlayers.map((_,i)=>i);
  if(poolIdx.length<4){
    alert("ìµœì†Œ 4ëª… í•„ìš”í•©ë‹ˆë‹¤.");
    return;
  }

  const maxCourt=Math.floor(poolIdx.length/4);
  const input=prompt(`ëª‡ ì½”íŠ¸ë¡œ ì§„í–‰? (1~${maxCourt})`);
  if(!input) return;
  const courtCount=parseInt(input);
  if(isNaN(courtCount)||courtCount<1||courtCount>maxCourt){
    alert("ì½”íŠ¸ ìˆ˜ ì˜¤ë¥˜");
    return;
  }

  runAssignment(courtCount,poolIdx);
}

function runAssignment(courtCount,poolIdx){
  const players=poolIdx.map(i=>allPlayers[i]);
  const needed=courtCount*4;

  const sorted=[...players].sort((a,b)=>b.level-a.level);
  const picked=sorted.slice(0,needed);

  const teams=[];
  let temp=[...picked];
  while(temp.length>=2){
    const top=temp.shift();
    const bottom=temp.pop();
    teams.push({members:[top,bottom],sum:top.level+bottom.level});
  }

  const courts=[];
  teams.sort((a,b)=>b.sum-a.sum);
  while(teams.length>=2){
    const strong=teams.shift();
    const weak=teams.pop();
    courts.push({
      A:strong,
      B:weak,
      diff:Math.abs(strong.sum-weak.sum)
    });
  }

  renderCourts(courts);
}

function renderCourts(courts){
  const wrap=document.getElementById("courts");
  wrap.innerHTML="";

  courts.forEach((c,i)=>{
    const div=document.createElement("div");
    div.className="court-card";
    div.innerHTML=`
      <div class="court-title">ì½”íŠ¸ ${i+1}</div>
      <div class="team-box">
        íŒ€ A: ${c.A.members.map(m=>m.name).join(" & ")}
      </div>
      <div class="vs">VS</div>
      <div class="team-box">
        íŒ€ B: ${c.B.members.map(m=>m.name).join(" & ")}
      </div>
      <div class="meta">
        <span>Aí•©: ${c.A.sum}</span>
        <span>Bí•©: ${c.B.sum}</span>
        <span>ì°¨ì´: ${c.diff}</span>
      </div>
    `;
    wrap.appendChild(div);
  });
}

// =====================
function addPlayer(){
  const name=document.getElementById("newName").value.trim();
  const level=parseInt(document.getElementById("newLevel").value);
  if(!name||isNaN(level)){alert("ì…ë ¥ ì˜¤ë¥˜");return;}

  const newPlayer={name,level,new:true};
  allPlayers.push(newPlayer);

  const stored=JSON.parse(localStorage.getItem("tennis_addedPlayers")||"[]");
  stored.push(newPlayer);
  localStorage.setItem("tennis_addedPlayers",JSON.stringify(stored));

  renderPlayers();
}

function removeAddedPlayers(){
  allPlayers=allPlayers.filter(p=>!p.new);
  localStorage.removeItem("tennis_addedPlayers");
  renderPlayers();
}

function resetAll(){
  selected=[];
  document.getElementById("courts").innerHTML="";
  renderPlayers();
}

</script>
</body>
</html>