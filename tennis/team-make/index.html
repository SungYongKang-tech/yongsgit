<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ¾ í…Œë‹ˆìŠ¤ ë³µì‹ ì„ ìˆ˜ êµ¬ì„±</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --bd:#e6e8ef;
      --txt:#0f172a; --mut:#64748b; --r:16px;
      --accent:#2563eb; --danger:#ef4444;
      --shadow:0 10px 28px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--txt)}
    .wrap{max-width:980px;margin:0 auto;padding:12px}
    h2{margin:6px 0 10px;font-size:16px;font-weight:900}

    .card{
      background:var(--card);
      border:1px solid var(--bd);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:12px;
      margin-bottom:12px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}
    .input{padding:10px 12px;border:1px solid var(--bd);border-radius:12px;background:#fff;font-size:14px}
    .btn{
      padding:10px 14px;border:1px solid rgba(37,99,235,.25);
      background:linear-gradient(180deg,#2b74ff,#2563eb);
      color:#fff;border-radius:12px;cursor:pointer;font-weight:900;
    }
    .btn.secondary{
      background:#fff;color:#0f172a;border:1px solid var(--bd);
    }
    .btn.danger{
      background:linear-gradient(180deg,#ff5a5a,#ef4444);
      border:1px solid rgba(239,68,68,.25);
    }

    .mut{color:var(--mut);font-weight:700;font-size:12px;margin-top:8px;text-align:center}
    .err{color:#b91c1c;font-weight:900}
    .ok{color:#166534;font-weight:900}

    .player-list{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
    .player{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid var(--bd);border-radius:999px;
      background:#fff;cursor:pointer;font-weight:850;
      user-select:none;
    }
    .player small{color:var(--mut);font-weight:800}
    .player.selected{border:2px solid var(--accent);background:#e3f2ff}
    .player.new-player{
      background:#fff59d;border:2px solid #e2e8f0;font-weight:900;
      animation:flash 1.2s ease-in-out infinite alternate;
    }
    @keyframes flash{from{filter:brightness(1.02)}to{filter:brightness(.92)}}

    .courts{display:flex;flex-direction:column;gap:10px}
    .court{
      background:#fff;border:1px solid var(--bd);border-radius:14px;padding:12px;
    }
    .court h3{margin:0 0 8px;font-size:14px;font-weight:1000}
    .grid{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center}
    .teamBox{
      border:1px solid var(--bd);border-radius:12px;padding:10px;background:#f8fafc;
      font-weight:850;line-height:1.5;
    }
    .vs{font-weight:1000;color:#ef4444;text-align:center}
    .meta{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:8px;color:var(--mut);font-weight:800;font-size:12px}
    @media (max-width:600px){
      .grid{grid-template-columns:1fr}
      .vs{order:2}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h2>ğŸ¾ í…Œë‹ˆìŠ¤ ë³µì‹ ì„ ìˆ˜ êµ¬ì„±</h2>

    <!-- ì„ ìˆ˜ ì¶”ê°€(í˜„ì¥ ì¶”ê°€: localStorage) -->
    <div class="card">
      <div class="row">
        <input class="input" id="newName" placeholder="ì´ë¦„" />
        <input class="input" id="newLevel" type="number" placeholder="ë ˆë²¨" min="1" max="20" style="width:90px" />
        <button class="btn" id="addBtn">ì„ ìˆ˜ ì¶”ê°€</button>
        <button class="btn secondary" id="removeAddedBtn">ì¶”ê°€ ì„ ìˆ˜ ì‚­ì œ</button>
      </div>
      <div class="mut">â€» ê¸°ë³¸ ì„ ìˆ˜ëŠ” Firebaseì—ì„œ ë¶ˆëŸ¬ì˜¤ê³ , í˜„ì¥ ì¶”ê°€ ì„ ìˆ˜ëŠ” ì´ ê¸°ê¸°(localStorage)ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</div>
    </div>

    <!-- ì°¸ì„ì ëª©ë¡ -->
    <div class="card">
      <h2 style="font-size:14px;margin:0 0 10px;text-align:center">ì°¸ì„ì ëª©ë¡</h2>
      <div class="player-list" id="playerList">
        <span class="mut">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
      </div>
      <div class="mut" id="status"></div>
    </div>

    <!-- ìë™ ë°°ì • -->
    <div class="card">
      <div class="row">
        <button class="btn" id="autoBtn">ë³µì‹ ìë™ ë°°ì •</button>
        <button class="btn danger" id="resetBtn">ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
      <div class="mut">ì„ íƒëœ ì‚¬ëŒë§Œ ë°°ì •í•©ë‹ˆë‹¤. ì„ íƒì´ ì—†ìœ¼ë©´ ì „ì²´ ì¸ì›ì—ì„œ ë°°ì •í•©ë‹ˆë‹¤. (ë³µì‹: ì½”íŠ¸ë‹¹ 4ëª…)</div>
    </div>

    <!-- ê²°ê³¼ -->
    <div class="card">
      <h2 style="font-size:14px;margin:0 0 10px;text-align:center">ë°°ì • ê²°ê³¼</h2>
      <div class="courts" id="courts">
        <div class="mut">ì•„ì§ ë°°ì • ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db, auth } from "../firebase.js";
    import { ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // âœ… ë ˆìŠ¨ ì‹œê°„í‘œ ì½”ë“œ ë°©ì‹ ê·¸ëŒ€ë¡œ: PATHë§Œ í…Œë‹ˆìŠ¤ ì„ ìˆ˜ ê²½ë¡œë¡œ ë§ì¶”ë©´ ë©ë‹ˆë‹¤.
    // âš ï¸ ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì €ì¥í•˜ëŠ” ê²½ë¡œì™€ 100% ë™ì¼í•´ì•¼ í•©ë‹ˆë‹¤.
    const PATH = {
      players: "tennis/members"   // <-- ì—¬ê¸°ë§Œ ì‹¤ì œ ê²½ë¡œë¡œ ë°”ê¾¸ë©´ ê¸°ì¡´ ì„ ìˆ˜ë“¤ì´ ê·¸ëŒ€ë¡œ ëœ¹ë‹ˆë‹¤
    };

    const LS_KEY = "tennis_addedPlayers";

    const $ = (id)=>document.getElementById(id);

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    let authed = false;
    let allPlayers = [];      // {name, level, new:false/true}
    let selectedIdx = [];     // ì¸ë±ìŠ¤ ì„ íƒ

    function setStatus(msg, cls="mut"){
      const el = $("status");
      if(!el) return;
      el.className = cls;
      el.textContent = msg;
    }

    function loadLocalAdded(){
      try{
        return JSON.parse(localStorage.getItem(LS_KEY) || "[]");
      }catch{
        return [];
      }
    }

    function saveLocalAdded(arr){
      localStorage.setItem(LS_KEY, JSON.stringify(arr));
    }

    function rebuildPlayers(firebasePlayers){
      // firebasePlayers: [{name, level}, ...]
      allPlayers = firebasePlayers.map(p=>({
        name: String(p.name||"").trim(),
        level: Number(p.level)||1,
        new: false
      })).filter(p=>p.name);

      // local ì‹ ê·œ ì„ ìˆ˜ ë³‘í•©
      const added = loadLocalAdded();
      added.forEach(p=>{
        if(!p?.name) return;
        allPlayers.push({ name:String(p.name).trim(), level:Number(p.level)||1, new:true });
      });

      // ì„ íƒ ì´ˆê¸°í™”(ì¸ë±ìŠ¤ ê¼¬ì„ ë°©ì§€)
      selectedIdx = [];
      renderPlayers();
    }

    function renderPlayers(){
      const box = $("playerList");
      if(!box) return;
      box.innerHTML = "";

      if(allPlayers.length === 0){
        box.innerHTML = `<span class="mut">ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</span>`;
        return;
      }

      allPlayers.forEach((p,i)=>{
        const el = document.createElement("span");
        el.className = "player";
        if(p.new) el.classList.add("new-player");
        if(selectedIdx.includes(i)) el.classList.add("selected");
        el.innerHTML = `${esc(p.name)} <small>(${esc(p.level)}ë ˆë²¨)</small>`;
        el.onclick = ()=>{
          if(selectedIdx.includes(i)) selectedIdx = selectedIdx.filter(v=>v!==i);
          else selectedIdx.push(i);
          renderPlayers();
        };
        box.appendChild(el);
      });

      setStatus(`ì„ ìˆ˜ ${allPlayers.length}ëª… Â· ì„ íƒ ${selectedIdx.length}ëª…`, "mut");
    }

    // ---- ìë™ ë°°ì •(ë³µì‹ ì½”íŠ¸ ìƒì„±)
    function shuffle(arr){
      const a = [...arr];
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    function runAutoAssign(){
      const pool = (selectedIdx.length ? selectedIdx.map(i=>allPlayers[i]) : allPlayers)
        .filter(p=>p?.name);

      if(pool.length < 4){
        alert("ë³µì‹ì€ ìµœì†Œ 4ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        return;
      }

      const maxCourts = Math.floor(pool.length / 4);
      const input = prompt(`ëª‡ ì½”íŠ¸ë¡œ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê°€ëŠ¥: 1 ~ ${maxCourts} (ì½”íŠ¸ë‹¹ 4ëª…)\nì˜ˆ) 2`);
      if(input === null) return;
      const courtCount = parseInt(input,10);
      if(isNaN(courtCount) || courtCount<1 || courtCount>maxCourts){
        alert(`ì½”íŠ¸ ìˆ˜ëŠ” 1 ~ ${maxCourts} ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
        return;
      }

      const need = courtCount*4;

      // ë ˆë²¨ í° ìˆ«ì = ê°•í•¨ ê°€ì •
      // ê°•/ì•½ í˜ì–´(ìƒìœ„+í•˜ìœ„ ë¬¶ê¸°)ë¡œ 2ì¸ íŒ€ ë§Œë“¤ê³ ,
      // ê°•í•œ íŒ€ vs ì•½í•œ íŒ€ìœ¼ë¡œ ì½”íŠ¸ ë§¤ì¹­
      const picked = [...pool].sort((a,b)=>b.level-a.level).slice(0,need);

      // í˜¹ì‹œ ê°™ì€ ë ˆë²¨ì´ ë§ì„ ë•Œ ëœë¤ì„± ì£¼ê¸°
      const grouped = shuffle(picked);

      // ë‹¤ì‹œ ë ˆë²¨ ê¸°ì¤€ ì •ë ¬ í›„ strong+weak í˜ì–´
      const sorted = grouped.sort((a,b)=>b.level-a.level);

      const teams2 = [];
      let tmp = [...sorted];
      while(tmp.length>=2){
        const top = tmp.shift();
        const bottom = tmp.pop();
        const sum = (top?.level||0) + (bottom?.level||0);
        teams2.push({ members:[top,bottom], sum });
      }

      teams2.sort((a,b)=>b.sum-a.sum);

      const courts = [];
      while(teams2.length>=2){
        const strong = teams2.shift();
        const weak = teams2.pop();
        courts.push({
          A: strong,
          B: weak,
          diff: Math.abs(strong.sum - weak.sum)
        });
      }

      renderCourts(courts, pool.length - need);
    }

    function renderCourts(courts, waitingCount){
      const wrap = $("courts");
      if(!wrap) return;
      wrap.innerHTML = "";

      if(!courts.length){
        wrap.innerHTML = `<div class="mut">ë°°ì • ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      courts.forEach((c, idx)=>{
        const div = document.createElement("div");
        div.className = "court";
        const teamA = c.A.members.map(m=>`${esc(m.name)}(${esc(m.level)})`).join(" Â· ");
        const teamB = c.B.members.map(m=>`${esc(m.name)}(${esc(m.level)})`).join(" Â· ");
        div.innerHTML = `
          <h3>ì½”íŠ¸ ${idx+1}</h3>
          <div class="grid">
            <div class="teamBox">
              <div style="font-weight:1000;margin-bottom:4px">íŒ€ A</div>
              ${teamA}
            </div>
            <div class="vs">VS</div>
            <div class="teamBox">
              <div style="font-weight:1000;margin-bottom:4px">íŒ€ B</div>
              ${teamB}
            </div>
          </div>
          <div class="meta">
            <span>Aí•© ${c.A.sum}</span>
            <span>Bí•© ${c.B.sum}</span>
            <span>ì°¨ì´ ${c.diff}</span>
          </div>
        `;
        wrap.appendChild(div);
      });

      if(waitingCount > 0){
        const note = document.createElement("div");
        note.className = "mut";
        note.textContent = `ëŒ€ê¸° ì¸ì›: ${waitingCount}ëª… (ì½”íŠ¸ë‹¹ 4ëª… ê¸°ì¤€ìœ¼ë¡œ ì¼ë¶€ë§Œ ë°°ì •í–ˆìŠµë‹ˆë‹¤)`;
        wrap.appendChild(note);
      }
    }

    // ---- ë²„íŠ¼ í•¸ë“¤ëŸ¬
    function addLocalPlayer(){
      const name = $("newName").value.trim();
      const level = parseInt($("newLevel").value, 10);

      if(!name || isNaN(level) || level<1 || level>20){
        alert("ì´ë¦„ê³¼ ë ˆë²¨ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ë ˆë²¨ 1~20)");
        return;
      }

      const p = { name, level, new:true };
      const stored = loadLocalAdded();
      stored.push(p);
      saveLocalAdded(stored);

      $("newName").value = "";
      $("newLevel").value = "";

      // í˜„ì¬ allPlayersì— ì¦‰ì‹œ ë°˜ì˜
      allPlayers.push({ name, level, new:true });
      renderPlayers();
    }

    function removeLocalPlayers(){
      if(!confirm("ì¶”ê°€í•œ ì„ ìˆ˜ë“¤ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      localStorage.removeItem(LS_KEY);
      // new:trueë§Œ ì œê±°
      allPlayers = allPlayers.filter(p=>!p.new);
      selectedIdx = [];
      renderPlayers();
    }

    function resetAll(){
      selectedIdx = [];
      $("courts").innerHTML = `<div class="mut">ì•„ì§ ë°°ì • ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      renderPlayers();
    }

    $("addBtn").addEventListener("click", addLocalPlayer);
    $("removeAddedBtn").addEventListener("click", removeLocalPlayers);
    $("autoBtn").addEventListener("click", runAutoAssign);
    $("resetBtn").addEventListener("click", resetAll);

    // ---- Auth + Firebase bind (ë ˆìŠ¨ ì‹œê°„í‘œ ì½”ë“œ ë°©ì‹ ê·¸ëŒ€ë¡œ)
    (async function init(){
      try{
        setStatus("Firebase ì—°ê²° ì¤‘...");
        await signInAnonymously(auth);
        authed = true;
        setStatus("Firebase ì—°ê²°ë¨. ì„ ìˆ˜ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");

        onValue(ref(db, PATH.players), (snap)=>{
          const raw = snap.exists() ? (snap.val() || {}) : null;

          // rawê°€ ë°°ì—´ì´ë“  ê°ì²´ë“  ì²˜ë¦¬
          const arr = raw
            ? (Array.isArray(raw) ? raw.filter(Boolean) : Object.values(raw))
            : [];

          // arr ìš”ì†Œê°€ {name, level} í˜•íƒœë¼ê³  ê°€ì •
          rebuildPlayers(arr);

          setStatus(`Firebase ì„ ìˆ˜ ${arr.length}ëª… ë¶ˆëŸ¬ì˜´ Â· ì „ì²´ ${allPlayers.length}ëª…`, "mut");
        }, (err)=>{
          console.error(err);
          $("playerList").innerHTML = `<span class="err">ì„ ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${esc(err?.message||err)}</span>`;
          setStatus("players ì½ê¸° ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)", "err");
        });

      }catch(e){
        console.error(e);
        $("playerList").innerHTML = `<span class="err">ì—°ê²° ì˜¤ë¥˜: ${esc(e?.message||e)}</span>`;
        setStatus("Firebase ì—°ê²° ì˜¤ë¥˜(ì½˜ì†” í™•ì¸)", "err");
      }
    })();
  </script>
</body>
</html>